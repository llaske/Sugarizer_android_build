define(["webL10n","sugar-web/graphics/icon","sugar-web/graphics/xocolor","sugar-web/graphics/radiobuttonsgroup","sugar-web/datastore","sugar-web/presence","settings","server","humane","util","tutorial","stats","autosync","history","activities"],(function(e,t,n,i,r,o,a,s,c,u,l,p,d,f,g){l10n=e,l10n.start(),iconLib=t,xoPalette=n,radioButtonsGroup=i,datastore=r,presence=o,preferences=a,myserver=s,humane=c,tutorial=l,stats=p,autosync=d,historic=f,activities=g,util=u;var v=2,m=!1,loadpreference=function(){var e,t=(e=RegExp("[?&]"+"rst"+"=([^&]*)").exec(window.location.search))&&decodeURIComponent(e[1].replace(/\+/g," "));preferences.load((function(e){m=null!=e,util.getClientType()==constant.appType&&(util.platform.electron||util.platform.android)&&(1==t?(util.cleanDatastore(!0),m=!1):2==t&&preferences.isConnected()&&(util.cleanDatastore(null),m=!1)),function(e){if(preferences.isUserConnected()){var t=preferences.getNetworkId();myserver.getUser(t,(function(t,n){preferences.merge(n),util.updateFavicon(),e(!0)}),(function(){var t=preferences.getToken();t&&t.expired||(preferences.setToken({...t,expired:!0}),console.log("WARNING: Can't read network user settings, force token expiration")),e(!0)}))}else e(!0)}((function(t){var n;t&&(n=function(){if(!preferences.isUserConnected()||window.sugarizerOS)for(var t=activities.get(),n=0;n<t.length;n++)for(var i=0;i<e.activities.length;i++)e.activities[i].id==t[n].id&&(t[n].favorite=e.activities[i].favorite);app=m?new Sugar.Desktop:new Sugar.FirstScreen,document.onmousemove=function(e){mouse.position={x:e.pageX,y:e.pageY}},util.handleVolumeButtons(),app.renderInto(document.getElementById("canvas"))},preferences.isInitialized()?activities.load().then((function(e){n()})).catch((function(e){console.log("Error loading init activities"),util.cleanDatastore(null,(function(){util.restartApp()}))})):n())}))}))};window.addEventListener("localized",(function(){app?((app.getToolbar?app.getToolbar():app).localize(),app.render()):0==--v&&loadpreference()}),!1),util.platform.ios&&"http"!=document.location.protocol.substr(0,4)&&document.addEventListener("deviceready",(function(){var release=function(){e.release()},e=new Media("audio/silence.mp3",release,release,release);e.play()})),requirejs(["domReady!"],(function(e){0==--v&&loadpreference()}))}));