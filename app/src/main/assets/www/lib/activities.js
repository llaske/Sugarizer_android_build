define(["sugar-web/datastore","util"],(function(t,n){var e={},i=[],r={directory:"icons",icon:"application-x-generic.svg"},updateList=function(t){if(0==i.length)return i=t,!0;for(var n=!1,e=0,r=0;r<t.length;r++){for(var o=!1,a=0;!o&&a<i.length;a++)t[r].id==i[a].id&&(o=!0,e++,i[a].version!=t[r].version&&(i[a].name=t[r].name,i[a].version=t[r].version,i[a].directory=t[r].directory,i[a].icon=t[r].icon,n=!0));o||(i.push(t[r]),n=!0)}if(e!=i.length){n=!0;var c=[];for(r=0;r<i.length;r++)for(o=!1,a=0;!o&&a<t.length;a++)i[r].id!=t[a].id&&"native"!=i[r].type||(o=!0,c.push(i[r]));i=c}return n},updateSugarizerOS=function(t){window.sugarizerOS?(sugarizerOS.isAppCacheReady((function(t){t.ready||humane.create({timeout:5e3,baseCls:"humane-libnotify"}).log(l10n.get("Loading"))})),sugarizerOS.initActivitiesPreferences((function(){t()}))):t()};return e.load=function(){return n.getClientType()==constant.webAppType?new Promise((function(t,n){myserver.getActivities((function(n,r){updateList(r.data),e.loadEntries(),updateSugarizerOS((function(){t(i)}))}),(function(r){axios.get(constant.staticInitActivitiesURL).then((function(n){updateList(n.data),e.loadEntries(),updateSugarizerOS((function(){t(i)}))})).catch((function(t){n(t)}))}))})):new Promise((function(t,n){axios.get(constant.staticInitActivitiesURL).then((function(n){updateList(n.data),e.loadEntries(),updateSugarizerOS((function(){t(i)}))})).catch((function(t){n(t)}))}))},e.get=function(){return i},e.getByName=function(t){if(void 0===t||null==t||0==t.length)return i;for(var n=i,e=[],r=0;r<n.length;r++)-1!=n[r].name.toLowerCase().indexOf(t)&&e.push(n[r]);return e},e.getById=function(t){for(var n=0;n<i.length;n++)if(i[n].id==t)return i[n];return r},e.getFavorites=function(){for(var t=[],n=0;n<i.length;n++)i[n].favorite&&t.push(i[n]);return t},e.getFavoritesName=function(){for(var t=this.getFavorites(),n=[],e=0;e<t.length;e++)n.push(t[e].id);return n},e.set=function(t){i=[];for(var n=0;n<t.length;n++)(t[n].isNative||t[n].type&&"native"==t[n].type)&&!window.sugarizerOS||i.push(t[n])},e.isGeneric=function(t){return t==r},e.genericActivity=function(){return r},e.switchFavoriteActivity=function(t){for(var n=0;n<i.length;n++)if(t.id==i[n].id)return i[n].favorite=!i[n].favorite,i[n].favorite;return!1},e.loadEntries=function(){for(var n=i?i.length:0,e=0;e<n;e++){var r=i[e];r.instances=t.find(r.id),r.instances.sort((function(t,n){return parseInt(n.metadata.timestamp)-parseInt(t.metadata.timestamp)}))}},e}));