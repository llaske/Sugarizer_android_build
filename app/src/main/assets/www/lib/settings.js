define(["sugar-web/datastore"],(function(t){var e={init:function(){this.initialized=!1,this.name="<No name>",this.color=22,this.colorvalue=null,this.view=0,this.language="en";var t=navigator.language;t&&(-1!=t.indexOf("fr")?this.language="fr":-1!=t.indexOf("es")?this.language="es":-1!=t.indexOf("de")?this.language="de":-1!=t.indexOf("ar")?this.language="ar":-1!=t.indexOf("ja")?this.language="ja":-1!=t.indexOf("pl")?this.language="pl":-1!=t.indexOf("pt")&&(this.language="pt")),this.options={stats:!0,sync:!0},this.connected=!1,this.server=null,this.networkId=null,this.privateJournal=null,this.sharedJournal=null,this.token=null,this.scrollValue=0}};return e.init(),e.load=function(e){var n=this;t.localStorage.load((function(){var i=t.localStorage.getValue("sugar_settings");null!=i&&void 0!==i.name?(n.initialized=!0,n.name=i.name,n.color=i.color,n.colorvalue=i.colorvalue,n.view=i.view,n.scrollValue=i.scrollValue,void 0!==i.language&&(n.language=i.language),void 0!==i.connected&&(n.connected=i.connected),void 0!==i.server&&(n.server=i.server),void 0!==i.networkId&&(n.networkId=i.networkId),void 0!==i.privateJournal&&(n.privateJournal=i.privateJournal),void 0!==i.sharedJournal&&(n.sharedJournal=i.sharedJournal),void 0!==i.token&&(n.token=i.token),void 0!==i.options&&(n.options=i.options),l10n.language.code=n.language,e&&e(i)):e&&e(null)}))},e.save=function(){t.localStorage.setValue("sugar_settings",{name:this.name,color:this.color,options:this.options,colorvalue:xoPalette.colors[this.color],activities:activities.get(),view:app.getView(),language:this.language,connected:this.connected,server:this.server,networkId:this.networkId,privateJournal:this.privateJournal,sharedJournal:this.sharedJournal,token:this.token,scrollValue:this.scrollValue})},e.saveToServer=function(t,e,n){if(null!=this.networkId){var i=this;t.putUser(this.networkId,{name:i.name,color:xoPalette.colors[i.color],language:i.language,options:i.options,favorites:activities.getFavoritesName()},(function(t,n){e&&e()}),(function(t,e){console.log("WARNING: Error updating network user"),n&&n(t,e)}))}else e&&e()},e.merge=function(t){var e=!1;if(this.initialized=!0,void 0!==t.name&&t.name!=this.name&&(this.name=t.name,e=!0),null!=this.colorvalue&&(void 0===t.color||t.color.fill==this.colorvalue.fill&&t.color.stroke==this.colorvalue.stroke)||(this.colorvalue=t.color,this.color=util.getColorIndex(this.colorvalue),e=!0),void 0!==t.language&&t.language!=this.language&&(this.language=t.language,e=!0),void 0!==t.favorites)for(var n=activities.get(),i=0;i<n.length;i++){var o=n[i].favorite;n[i].favorite=!1;for(var a=0;a<t.favorites.length;a++)t.favorites[a]==n[i].id&&(n[i].favorite=!0);e=e||o!=n[i].favorite}else e=!0;if(void 0!==t.server&&t.server!=this.server&&(this.server=t.server,e=!0),void 0!==t.networkId&&t.networkId!=this.networkId&&(this.networkId=t.networkId,e=!0),void 0!==t.private_journal&&t.private_journal!=this.privateJournal&&(this.privateJournal=t.private_journal),void 0!==t.shared_journal&&t.shared_journal!=this.sharedJournal&&(this.sharedJournal=t.shared_journal),void 0!==t.options&&void 0!==this.options)for(var r in t.options)this.options.hasOwnProperty(r)&&this.options[r]==t.options[r]||(this.options[r]=t.options[r],e=!0);return e},e.reset=function(e){t.localStorage.removeValue("sugar_settings"),e&&(historic.clean(),stats.clean())},e.getName=function(){return this.name},e.getColor=function(){return xoPalette.colors[this.color]},e.getView=function(){return this.view},e.getLanguage=function(){return this.language},e.getActivities=function(){return activities.get()},e.isConnected=function(){return this.connected||util.getClientType()==constant.webAppType},e.isUserConnected=function(){return this.connected},e.isInitialized=function(){return this.initialized},e.getServer=function(){return this.server},e.getNetworkId=function(){var t=this.token;return t&&t.x_key?t.x_key:null},e.getPrivateJournal=function(){return this.privateJournal},e.getSharedJournal=function(){return this.sharedJournal},e.getToken=function(){return this.token},e.getOptions=function(t){if(this.options)return this.options[t]},e.getScrollValue=function(){return this.scrollValue},e.setName=function(t){this.name=t},e.setColor=function(t){t>=0&&t<xoPalette.colors.length&&(this.color=t)},e.setLanguage=function(t){this.language=t},e.setActivities=function(t){activities.set(t)},e.setConnected=function(t){this.connected=t},e.setServer=function(t){this.server=t},e.setNetworkId=function(t){this.networkId=t},e.setPrivateJournal=function(t){this.privateJournal=t},e.setSharedJournal=function(t){this.sharedJournal=t},e.setToken=function(t){this.token=t},e.setOptions=function(t,e){this.options||(this.options={}),this.options[t]=e},e.setScrollValue=function(t){this.scrollValue=t},e.nextColor=function(){this.color=(this.color+1)%xoPalette.colors.length},e.runActivity=function(e,n,i,o,a){if(null!=e.type&&"native"==e.type){if(sugarizerOS)return sugarizerOS.runActivity(e.id),void sugarizerOS.addApplicationToJournal(sugarizerOS.log,e,t);console.log("No sugarizerOS instance found")}null==e.activityId&&(e.activityId=t.createUUID()),this.save();var r=e.directory+"/index.html?aid="+e.activityId+"&a="+e.id;r=void 0===n?null!=e.instances&&e.instances.length>0?r+"&o="+(n=e.instances[0].objectId)+"&n="+e.instances[0].metadata.title:r+"&n="+e.name:null!=n?r+"&o="+n+"&n="+i:r+"&n="+e.name,o&&(r=r+"&s="+o),a&&(r+="&h=1"),stats.trace(constant.viewNames[app.getView()==constant.assignmentView?constant.journalView:app.getView()],(n?"re":"")+"launch_activity",e.id,n),window.location=r},e}));