define(["sugar-web/datastore"],(function(t){var i={init:function(){this.name="<No name>",this.color=22,this.colorvalue=null,this.activities=[],this.view=0,this.language="en";var t=navigator.language;t&&(-1!=t.indexOf("fr")?this.language="fr":-1!=t.indexOf("es")?this.language="es":-1!=t.indexOf("de")?this.language="de":-1!=t.indexOf("ar")?this.language="ar":-1!=t.indexOf("ja")?this.language="ja":-1!=t.indexOf("pl")?this.language="pl":-1!=t.indexOf("pt")&&(this.language="pt")),this.options={stats:!0,sync:!0},this.connected=!1,this.server=null,this.networkId=null,this.privateJournal=null,this.sharedJournal=null,this.genericActivity={directory:"icons",icon:"application-x-generic.svg"},this.token=null,this.histoy=null}};return i.init(),i.load=function(i){var e=this;t.localStorage.load((function(){e.history=t.localStorage.getValue("sugar_history");var n=t.localStorage.getValue("sugar_settings");null!=n&&void 0!==n.name?(e.name=n.name,e.color=n.color,e.colorvalue=n.colorvalue,e.view=n.view,void 0!==n.language&&(e.language=n.language),void 0!==n.connected&&(e.connected=n.connected),void 0!==n.server&&(e.server=n.server),void 0!==n.networkId&&(e.networkId=n.networkId),void 0!==n.privateJournal&&(e.privateJournal=n.privateJournal),void 0!==n.sharedJournal&&(e.sharedJournal=n.sharedJournal),void 0!==n.token&&(e.token=n.token),void 0!==n.options&&(e.options=n.options),l10n.language.code=e.language,e.activities=n.activities,e.updateEntries(),i&&i(!0)):i&&i(!1)}))},i.updateEntries=function(){for(var i=this.activities?this.activities.length:0,e=0;e<i;e++){var n=this.activities[e];n.instances=t.find(n.id),n.instances.sort((function(t,i){return parseInt(i.metadata.timestamp)-parseInt(t.metadata.timestamp)}))}},i.save=function(){t.localStorage.setValue("sugar_settings",{name:this.name,color:this.color,options:this.options,colorvalue:xoPalette.colors[this.color],activities:this.activities,view:app.getView(),language:this.language,connected:this.connected,server:this.server,networkId:this.networkId,privateJournal:this.privateJournal,sharedJournal:this.sharedJournal,token:this.token})},i.saveToServer=function(t,i,e){if(null!=this.networkId){t.putUser(this.networkId,{name:this.name,color:xoPalette.colors[this.color],language:this.language,options:this.options,favorites:this.getFavoritesActivitiesName()},(function(t,e){i&&i()}),(function(t,i){console.log("WARNING: Error updating network user"),e&&e(t,i)}))}else i&&i()},i.merge=function(t){var i=!1;if(void 0!==t.name&&t.name!=this.name&&(this.name=t.name,i=!0),null!=this.colorvalue&&(void 0===t.color||t.color.fill==this.colorvalue.fill&&t.color.stroke==this.colorvalue.stroke)||(this.colorvalue=t.color,this.color=util.getColorIndex(this.colorvalue),i=!0),void 0!==t.language&&t.language!=this.language&&(this.language=t.language,i=!0),void 0!==t.favorites)for(var e=0;e<this.activities.length;e++){var n=this.activities[e].favorite;this.activities[e].favorite=!1;for(var o=0;o<t.favorites.length;o++)t.favorites[o]==this.activities[e].id&&(this.activities[e].favorite=!0);i=i||n!=this.activities[e].favorite}if(void 0!==t.server&&t.server!=this.server&&(this.server=t.server,i=!0),void 0!==t.networkId&&t.networkId!=this.networkId&&(this.networkId=t.networkId,i=!0),void 0!==t.private_journal&&t.private_journal!=this.privateJournal&&(this.privateJournal=t.private_journal),void 0!==t.shared_journal&&t.shared_journal!=this.sharedJournal&&(this.sharedJournal=t.shared_journal),void 0!==t.options&&void 0!==this.options)for(var s in t.options)this.options.hasOwnProperty(s)&&this.options[s]==t.options[s]||(this.options[s]=t.options[s],i=!0);return i},i.reset=function(i){t.localStorage.removeValue("sugar_settings"),i&&(t.localStorage.removeValue("sugar_history"),t.localStorage.removeValue("sugar_stats"))},i.getName=function(){return this.name},i.getColor=function(){return xoPalette.colors[this.color]},i.getView=function(){return this.view},i.getLanguage=function(){return this.language},i.getActivities=function(){return this.activities},i.getActivitiesByName=function(t){if(void 0===t||null==t||0==t.length)return this.activities;for(var i=this.activities,e=[],n=0;n<i.length;n++)-1!=i[n].name.toLowerCase().indexOf(t)&&e.push(i[n]);return e},i.getActivity=function(t){for(var i=0;i<this.activities.length;i++)if(this.activities[i].id==t)return this.activities[i];return this.genericActivity},i.getFavoritesActivities=function(){for(var t=[],i=0;i<this.activities.length;i++)this.activities[i].favorite&&t.push(this.activities[i]);return t},i.getFavoritesActivitiesName=function(){for(var t=this.getFavoritesActivities(),i=[],e=0;e<t.length;e++)i.push(t[e].id);return i},i.isConnected=function(){return this.connected||util.getClientType()==constant.webAppType},i.getServer=function(){return this.server},i.getNetworkId=function(){var t=this.token;return t&&t.x_key?t.x_key:null},i.getPrivateJournal=function(){return this.privateJournal},i.getSharedJournal=function(){return this.sharedJournal},i.getToken=function(){return this.token},i.getHistory=function(){return this.history},i.getOptions=function(t){if(this.options)return this.options[t]},i.setName=function(t){this.name=t},i.setColor=function(t){t>=0&&t<xoPalette.colors.length&&(this.color=t)},i.setLanguage=function(t){this.language=t},i.setActivities=function(t){this.activities=[];for(var i=0;i<t.length;i++)(t[i].isNative||t[i].type&&"native"==t[i].type)&&!window.sugarizerOS||this.activities.push(t[i])},i.setConnected=function(t){this.connected=t},i.setServer=function(t){this.server=t},i.setNetworkId=function(t){this.networkId=t},i.setPrivateJournal=function(t){this.privateJournal=t},i.setSharedJournal=function(t){this.sharedJournal=t},i.setToken=function(t){this.token=t},i.setOptions=function(t,i){this.options||(this.options={}),this.options[t]=i},i.addUserInHistory=function(){for(var i={name:this.name,color:this.color,server:this.server},e=this.history?this.history:[],n=0;n<e.length;n++)if(this.name.toLowerCase()==e[n].name.toLowerCase()&&(null==this.server&&null==e[n].server||this.server&&this.server.url&&e[n].server&&e[n].server.url&&this.server.url==e[n].server.url))return e[n]=e[e.length-1],e[e.length-1]=i,void t.localStorage.setValue("sugar_history",e);if(e.push(i),e.length>constant.maxUserHistory){var o=[];for(n=0;n<e.length-1;n++)o.push(e[n+1]);e=o}t.localStorage.setValue("sugar_history",e)},i.updateActivities=function(t){for(var i=!1,e=0,n=0;n<t.length;n++){for(var o=!1,s=0;!o&&s<this.activities.length;s++)t[n].id==this.activities[s].id&&(o=!0,e++,this.activities[s].version!=t[n].version&&(this.activities[s].name=t[n].name,this.activities[s].version=t[n].version,this.activities[s].directory=t[n].directory,this.activities[s].icon=t[n].icon,i=!0));o||(this.activities.push(t[n]),i=!0)}if(e!=this.activities.length){i=!0;var r=[];for(n=0;n<this.activities.length;n++)for(o=!1,s=0;!o&&s<t.length;s++)this.activities[n].id!=t[s].id&&"native"!=this.activities[n].type||(o=!0,r.push(this.activities[n]));this.activities=r}return i},i.nextColor=function(){this.color=(this.color+1)%xoPalette.colors.length},i.runActivity=function(i,e,n,o,s){if(null!=i.type&&"native"==i.type){if(sugarizerOS)return sugarizerOS.runActivity(i.id),void sugarizerOS.addApplicationToJournal(sugarizerOS.log,i,t);console.log("No sugarizerOS instance found")}null==i.activityId&&(i.activityId=t.createUUID()),this.save();var r=i.directory+"/index.html?aid="+i.activityId+"&a="+i.id;r=void 0===e?null!=i.instances&&i.instances.length>0?r+"&o="+(e=i.instances[0].objectId)+"&n="+i.instances[0].metadata.title:r+"&n="+i.name:null!=e?r+"&o="+e+"&n="+n:r+"&n="+i.name,o&&(r=r+"&s="+o),s&&(r+="&h=1"),stats.trace(constant.viewNames[app.getView()],(e?"re":"")+"launch_activity",i.id,e),window.location=r},i.switchFavoriteActivity=function(t){return t.favorite=!t.favorite,t.favorite},i}));