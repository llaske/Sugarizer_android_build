define(["l10n","sugar-web/datastore","FileSaver"],(function(e,t,o){var n={},r=[{name:"Years",factor:30758400},{name:"Months",factor:2592e3},{name:"Weeks",factor:604800},{name:"Days",factor:86400},{name:"Hours",factor:3600},{name:"Minutes",factor:60}];function nextIndex(e){var t=e+1;return t==xoPalette.colors.length&&(t=0),t}function previousIndex(e){var t=e-1;return t<0&&(t=xoPalette.colors.length-1),t}n.platform={ios:/(iPhone|iPad|iPod)/.test(navigator.userAgent),android:-1!=navigator.userAgent.indexOf("Android"),firefox:-1!=navigator.userAgent.indexOf("Firefox"),chrome:-1!=navigator.userAgent.indexOf("Chrome"),safari:-1!=navigator.userAgent.indexOf("Safari"),windows:-1!=navigator.platform.indexOf("Win"),macos:-1!=navigator.platform.indexOf("Mac"),unix:-1!=navigator.platform.indexOf("X11"),linux:-1!=navigator.platform.indexOf("Linux"),electron:-1!=navigator.userAgent.indexOf("Electron"),touch:"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,androidChrome:/Android .* Chrome\/(\d+)[.\d]+/.test(navigator.userAgent)},n.timestampToElapsedString=function(t,o,n,a="Ago"){for(var i=n?"_short":"",l=0,s="",c=((new Date).getTime()-t)/1e3,p=0;p<r.length;p++){var d=r[p].factor,m=Math.floor(c/d);if(m>0&&(l>0&&(s+=","),s+=" "+m+" "+(1==m?e.get(r[p].name+"_one"+i):e.get(r[p].name+"_other"+i)),c-=m*d),""!=s&&(l+=1),l==o)break}return 0==l?e.get("Seconds"+a+i):e.get(a+i,{time:s})},n.getDateRange=function(e){if(void 0===e)return null;var t=new Date,o=new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime();t=t.getTime();var n=null;switch(e){case 1:n={min:o,max:t};break;case 2:n={min:o-864e5,max:t};break;case 3:n={min:o-6048e5,max:t};break;case 4:n={min:o-2592e6,max:t};break;case 5:n={min:o-307584e5,max:t}}return n},n.getNextStrokeColor=function(e){var t=n.getColorIndex(e);if(-1==t)return e;for(var o=nextIndex(t);xoPalette.colors[o].stroke!=xoPalette.colors[t].stroke;)o=nextIndex(o);return xoPalette.colors[o]},n.getPreviousStrokeColor=function(e){var t=n.getColorIndex(e);if(-1==t)return e;for(var o=previousIndex(t);xoPalette.colors[o].stroke!=xoPalette.colors[t].stroke;)o=previousIndex(o);return xoPalette.colors[o]},n.getNextFillColor=function(e){var t=n.getColorIndex(e);if(-1==t)return e;for(var o=nextIndex(t);xoPalette.colors[o].fill!=xoPalette.colors[t].fill;)o=nextIndex(o);return xoPalette.colors[o]},n.getPreviousFillColor=function(e){var t=n.getColorIndex(e);if(-1==t)return e;for(var o=previousIndex(t);xoPalette.colors[o].fill!=xoPalette.colors[t].fill;)o=previousIndex(o);return xoPalette.colors[o]},n.getColorIndex=function(e){for(var t=0;t<xoPalette.colors.length;t++)if(e.stroke==xoPalette.colors[t].stroke&&e.fill==xoPalette.colors[t].fill)return t;return-1},n.getCanvasCenter=function(){var e=document.getElementById("canvas")||document.getElementById("body"),t=e.offsetHeight,o=e.offsetWidth,n=parseFloat(t)/2;return{x:parseFloat(o)/2,y:n,dx:o,dy:t}},n.computeMargin=function(e,t){var o=document.getElementById("canvas"),n=o.offsetHeight,r=o.offsetWidth,a=e.width<=r?e.width:t.width*r,i=e.height<=n?e.height:t.height*n;return{left:parseFloat(r-a)/2,top:parseFloat(n-i)/2,width:a,height:i}},n.cursorIsInside=function(e){var t=document.getElementById(e.getAttribute("id"));if(null==t)return!1;var o={};for(o.x=t.offsetLeft,o.y=t.offsetTop,o.dx=t.clientWidth,o.dy=t.clientHeight;t.offsetParent&&(o.x=o.x+t.offsetParent.offsetLeft,o.y=o.y+t.offsetParent.offsetTop-t.scrollTop,t!=document.getElementsByTagName("body")[0]);)t=t.offsetParent;return mouse.position.x>=o.x&&mouse.position.x<=o.x+o.dx&&mouse.position.y>=o.y&&mouse.position.y<=o.y+o.dy},n.setToolbar=function(e){toolbar!=e&&(toolbar=e,e.renderInto(document.getElementById("toolbar")))},n.getBrowserName=function(){return n.platform.android?"Android":n.platform.ios?"iOS":n.platform.chrome?"Chrome":n.platform.firefox?"Firefox":n.platform.safari?"Safari":"Unknown"},n.getBrowserVersion=function(){navigator.appVersion;var e,t,o,n=navigator.userAgent,r=""+parseFloat(navigator.appVersion),a=parseInt(navigator.appVersion,10);return-1!=(t=n.indexOf("Chrome"))?r=n.substring(t+7):-1!=(t=n.indexOf("Firefox"))?(browserName="Firefox",r=n.substring(t+8)):-1!=(t=n.indexOf("Safari"))?(browserName="Safari",r=n.substring(t+7),-1!=(t=n.indexOf("Version"))&&(r=n.substring(t+8))):(e=n.lastIndexOf(" ")+1)<(t=n.lastIndexOf("/"))&&(browserName=n.substring(e,t),r=n.substring(t+1),browserName.toLowerCase()==browserName.toUpperCase()&&(browserName=navigator.appName)),-1!=(o=r.indexOf(";"))&&(r=r.substring(0,o)),-1!=(o=r.indexOf(" "))&&(r=r.substring(0,o)),a=parseInt(""+r,10),isNaN(a)&&(r=""+parseFloat(navigator.appVersion),a=parseInt(navigator.appVersion,10)),r},n.getClientType=function(){return"http"!=document.location.protocol.substr(0,4)||constant.noServerMode?constant.appType:constant.webAppType},n.getClientName=function(){return this.getClientType()==constant.webAppType?"Web App":"App"},n.getCurrentServerUrl=function(){var e=window.location.href;return e.substring(0,e.lastIndexOf("/"))},n.getMinPasswordSize=function(){var e=constant.minPasswordSize,t=preferences.getServer();return t&&t.options&&t.options["min-password-size"]&&(e=t.options["min-password-size"]),e},n.restartApp=function(){location.assign(location.href.replace(/\?rst=?./g,"?rst=0"))},n.vibrate=function(){(n.platform.android||n.platform.ios)&&n.getClientType()==constant.appType&&navigator.vibrate&&navigator.vibrate(30)},n.hideNativeToolbar=function(){n.platform.android&&n.getClientType()==constant.appType&&!constant.noServerMode&&AndroidFullScreen.immersiveMode((function(){}),(function(){}))},n.handleVolumeButtons=function(){if(n.platform.android&&n.getClientType()==constant.appType&&!constant.noServerMode){var emptyf=function(){};document.addEventListener("volumeupbutton",(function(){cordova.plugins.VolumeControl.getVolume((function(e){var t=parseInt(e);t<100&&cordova.plugins.VolumeControl.setVolume(t+10,emptyf,emptyf)}),emptyf)}),!1),document.addEventListener("volumedownbutton",(function(){cordova.plugins.VolumeControl.getVolume((function(e){var t=parseInt(e);t>0&&cordova.plugins.VolumeControl.setVolume(t-1,emptyf,emptyf)}),emptyf)}),!1)}};n.updateFavicon=function(){var e=preferences.getColor(),t=preferences.getName();e||(e={stroke:"#005FE4",fill:"#FF2B34"}),document.title=(t&&"<No name>"!=t?t+" - ":"")+"Sugarizer";var o='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\t\t<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" width="16" height="16" version="1.0" >\t\t<g transform="translate(37.943468,-309.4636)">\t\t<g transform="matrix(0.05011994,0,0,0.05012004,-41.76673,299.66011)" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-opacity:1">\t\t<circle transform="matrix(0.969697,0,0,0.969697,-90.879133,125.06999)" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-width:20.62502098;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" cx="331.38321" cy="134.2677" r="51.220825" />\t\t<path d="m 290.55846,302.47333 -58.81513,59.20058 -59.39461,-59.40024 c -25.19828,-24.48771 -62.7038,13.33148 -38.1941,37.98719 l 60.04451,58.9817 -59.73639,59.42563 c -24.83976,24.97559 12.91592,63.26505 37.66786,37.75282 l 59.95799,-59.28294 58.75912,59.21065 c 24.50656,25.09065 62.43116,-13.00322 37.87956,-37.85772 l -59.24184,-59.02842 58.87574,-59.14782 c 25.1689,-25.18348 -13.0489,-62.75154 -37.80271,-37.84143 z" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-width:20.00002098;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" />\t\t</g></g></svg>'.replace(new RegExp("&fill_color;","g"),e.fill).replace(new RegExp("&stroke_color;","g"),e.stroke),n=(new XMLSerializer).serializeToString((new DOMParser).parseFromString(o,"text/xml")),r=document.createElement("canvas");r.width=16,r.height=16;var a=r.getContext("2d"),i=new Image;i.src="data:image/svg+xml;base64,"+btoa(n),i.onload=function(){a.drawImage(i,0,0);var e=document.querySelector("link[rel*='icon']")||document.createElement("link");e.type="image/x-icon",e.rel="shortcut icon",e.href=r.toDataURL("image/x-icon"),document.getElementsByTagName("head")[0].appendChild(e)}};var a=0,i=null;function closeQR(){QRScanner.cancelScan((function(e){})),i&&i(),document.getElementById("toolbar").style.opacity=1,document.getElementById("canvas").style.opacity=1,document.getElementById("qrclosebutton").style.visibility="hidden",document.getElementById("qrswitchbutton").style.visibility="hidden";var e=document.getElementById("qrbackground");e.parentNode.removeChild(e)}function switchCameraQR(){a=(a+1)%2,QRScanner.useCamera(a,(function(e,t){}))}function writeFileToStore(e,t,o){if("application/json"==e.type){var n=null;try{if(!(n=JSON.parse(t)).metadata)return void o(e.name,-1)}catch(t){return void o(e.name,-1)}o(e.name,0,n.metadata,n.text)}else{var r="",a=e.type;"application/vnd.ms-excel"==e.type||"text/csv"==e.type||"text/x-csv"==e.type||"text/tab-separated-values"==e.type||"text/comma-separated-values"==e.type?(r="org.sugarlabs.ChartActivity",a="text/csv"):"text/plain"!=e.type&&"application/pdf"!=e.type&&"application/msword"!=e.type&&"application/vnd.oasis.opendocument.text"!=e.type&&(r="org.olpcfrance.MediaViewerActivity");var i={title:e.name,mimetype:a,activity:r};o(e.name,0,i,t)}}function base64toBlob(e,t){for(var o=e,n=atob(t.substr(t.indexOf(";base64,")+8)),r=[],a=0;a<n.length;a+=1024){for(var i=n.slice(a,a+1024),l=new Array(i.length),s=0;s<i.length;s++)l[s]=i.charCodeAt(s);var c=new Uint8Array(l);r.push(c)}return new Blob(r,{type:o})}return n.scanQRCode=function(e,t){a=0,i=t;var o=document.createElement("div");o.className="first-qrbackground",o.id="qrbackground",document.getElementById("canvas").appendChild(o),document.getElementById("qrclosebutton").addEventListener("click",closeQR),document.getElementById("qrswitchbutton").addEventListener("click",switchCameraQR),QRScanner.prepare((function(t,o){document.getElementById("toolbar").style.opacity=0,document.getElementById("canvas").style.opacity=0,document.getElementById("qrclosebutton").style.visibility="visible",document.getElementById("qrswitchbutton").style.visibility="visible",t?console.log("Error "+t):(QRScanner.scan((function(t,o){t?console.log("Error "+t):e&&e(o),n.cancelScan(),document.getElementById("toolbar").style.opacity=1,document.getElementById("canvas").style.opacity=1,document.getElementById("qrclosebutton").style.visibility="hidden",document.getElementById("qrswitchbutton").style.visibility="hidden"})),QRScanner.show((function(e){})))}))},n.cancelScan=function(){QRScanner.cancelScan((function(e){})),i=null,document.getElementById("qrclosebutton").removeEventListener("click",closeQR),document.getElementById("qrswitchbutton").removeEventListener("click",switchCameraQR);var e=document.getElementById("qrbackground");e&&e.parentNode.removeChild(e)},n.writeFile=function(e,t,r,a){var i=null,l=null,s="json",c=t.title,p="application/json";t&&t.mimetype?("image/jpeg"==(p=t.mimetype)?s="jpg":"image/png"==p?s="png":"audio/wav"==p?s="wav":"video/webm"==p?s="webm":"audio/mp3"==p||"audio/mpeg"==p?s="mp3":"video/mp4"==p?s="mp4":"text/plain"==p?(s="txt",l=r):"application/pdf"==p?s="pdf":"application/msword"==p?s="doc":"application/vnd.oasis.opendocument.text"==p?s="odt":"text/csv"==p?(s="csv",l=r):s="bin",i=function base64DecToArr(e,t){for(var o,n,r,a=e.replace(/[^A-Za-z0-9\+\/]/g,""),i=a.length,l=t?Math.ceil((3*i+1>>2)/t)*t:3*i+1>>2,s=new Uint8Array(l),c=0,p=0,d=0;d<i;d++)if(n=3&d,c|=((r=a.charCodeAt(d))>64&&r<91?r-65:r>96&&r<123?r-71:r>47&&r<58?r+4:43===r?62:47===r?63:0)<<6*(3-n),3===n||i-d==1){for(o=0;o<3&&p<l;o++,p++)s[p]=c>>>(16>>>o&24)&255;c=0}return s}(r.substr(r.indexOf("base64,")+7)).buffer):l=JSON.stringify({metadata:t,text:r});var d=c;if(-1==d.indexOf("."+s)&&(d+="."+s),n.getClientType()==constant.appType&&(n.platform.android||n.platform.ios||n.platform.electron)&&!constant.noServerMode)if(n.platform.android||n.platform.ios){var m=cordova.file.externalRootDirectory;n.platform.ios&&(m=cordova.file.documentsDirectory),window.resolveLocalFileSystemURL(m,(function(e){e.getFile(d,{create:!0},(function(e){e&&e.createWriter((function(t){if(t.seek(t.length),l){var o=new Blob([l],{type:p});t.write(o)}else t.write(i);a(null,e.fullPath)}),(function(e){a(error.code,null)}))}))}))}else{var f=require("electron").ipcRenderer;f.removeAllListeners("save-file-reply"),f.send("save-file-dialog",{directory:e,filename:d,mimetype:p,extension:s,text:l,binary:r}),f.on("save-file-reply",(function(e,t){a(t.err,t.filename)}))}else{var u=new Blob(l?[l]:[i],{type:p});o.saveAs(u,d),a(null,d)}},n.loadFile=function(e,t){if(n.getClientType()==constant.webAppType||constant.noServerMode||n.platform.android||n.platform.ios||n.getClientType()==constant.appType&&!n.platform.electron){var o=["application/vnd.ms-excel","text/csv","text/x-csv","text/tab-separated-values","text/comma-separated-values"];if(-1==["application/json","image/jpeg","image/png","audio/wav","video/webm","audio/mp3","audio/mpeg","video/mp4","text/plain","application/pdf","application/msword","application/vnd.oasis.opendocument.text"].indexOf(e.type)&&-1==o.indexOf(e.type))return void t(e.name,-1);var r=new FileReader;r.onload=function(){writeFileToStore(e,r.result,t)},"application/json"==e.type||"text/plain"==e.type||o.includes(e.type)?r.readAsText(e):r.readAsDataURL(e)}},n.askDirectory=function(e){if(n.getClientType()==constant.appType&&!n.platform.android&&!n.platform.ios){var t=require("electron").ipcRenderer;t.removeAllListeners("choose-directory-reply"),t.send("choose-directory-dialog"),t.on("choose-directory-reply",(function(t,o){e(o)}))}},n.askFiles=function(e){if(n.getClientType()==constant.appType){var t=require("electron").ipcRenderer;t.removeAllListeners("choose-files-reply"),t.send("choose-files-dialog"),t.on("choose-files-reply",(function(t,o,n,r){n?e(o.name,-1):writeFileToStore(o,r,e)}))}},n.openAsDocument=function(t,o,r){if(n.getClientType()!=constant.webAppType&&(n.getClientType()!=constant.appType||enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios||enyo.platform.electron)&&!constant.noServerMode)if(enyo.platform.android||enyo.platform.androidChrome){var a=cordova.file.externalCacheDirectory;enyo.platform.ios&&(a=cordova.file.documentsDirectory),window.resolveLocalFileSystemURL(a,(function(e){e.getFile("sugarizertemp",{create:!0,exclusive:!1},(function(e){e&&e.createWriter((function(e){e.seek(e.length);var n=base64toBlob(t.mimetype,o);e.write(n);var r=a+"sugarizertemp";cordova.InAppBrowser.open(r,"_system")}),(function(e){}))}))}))}else if(enyo.platform.ios)window.localStorage.setItem("sugar_inappbrowser_objectId",r),cordova.InAppBrowser.open("inapp.html","_blank","location=no,closebuttoncaption="+e.get("Ok"));else{var i=require("electron"),l=i.shell,s=i.ipcRenderer;s.removeAllListeners("create-tempfile-reply"),s.send("create-tempfile",{metadata:t,text:o}),s.on("create-tempfile-reply",(function(e,t){l.openExternal("file://"+t)}))}else{var c=base64toBlob(t.mimetype,o),p=URL.createObjectURL(c);window.open(p,"_blank")}},n.openAsUrl=function(t){if(n.getClientType()==constant.webAppType||n.getClientType()==constant.appType&&!n.platform.android&&!n.platform.ios&&!n.platform.electron||constant.noServerMode)window.open(t,"_blank");else if(n.platform.android||n.platform.ios)n.platform.ios?cordova.InAppBrowser.open(t,"_blank","location=no,closebuttoncaption="+e.get("Ok")):cordova.InAppBrowser.open(t,"_system");else{require("electron").shell.openExternal(t)}},n.cleanDatastore=function(e,o){var n=t.find(),r=0,removeOneEntry=function(e){++r<n.length?t.remove(n[r].objectId,removeOneEntry):o&&o()};preferences.reset(e),n.length?t.remove(n[r].objectId,removeOneEntry):o&&o()},n.getOptions=function(){var e=t.localStorage.getValue("sugar_options");return e||{}},n.setOptions=function(e){t.localStorage.setValue("sugar_options",e)},n.computeDatastoreSize=function(e){var o=0;for(var r in localStorage){var a=2*localStorage[r].length;isNaN(a)||(o+=a)}for(var i=t.find(),l=0;l<i.length;l++){var s=i[l].metadata.textsize;s&&(o+=s)}e&&e({bytes:o,formatted:n.formatSize(o)})},n.formatSize=function(t){return formated=t>1048576?(t/1024/1024).toFixed()+" "+e.get("ShortForMegabytes"):t>1024?(t/1024).toFixed()+" "+e.get("ShortForKilobytes"):0==t?"-":t+" "+e.get("ShortForBytes"),formated},n.quitApp=function(){new Sugar.EE({mode:2}).renderInto(document.getElementById("body")),window.setTimeout((function(){"undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime&&window.top.postMessage("","*"),window.close(),/Edge/.test(navigator.userAgent)||(window.open("","_self",""),window.close()),navigator&&(navigator.app?navigator.app.exitApp():navigator.device&&navigator.device.exitApp())}),constant.timerBeforeClose)},n}));