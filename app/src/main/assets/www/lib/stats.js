define(["settings","sugar-web/datastore"],(function(t,e){var a={},n="Sugarizer";return a.isActive=function(){if(!t.getOptions("stats"))return!1;if(!t.isConnected())return!1;var e=t.getServer();return!!(e&&e.options&&e.options.statistics)},a.trace=function(s,o,r,i){if(a.isActive()){console.log(n+": "+o+"("+s+", "+r+", "+i+")");var u=function computeStat(e,a,s,o){var r={};return r.user_id=t.getNetworkId(),r.user_agent=navigator.userAgent,r.timestamp=(new Date).getTime(),r.client_type=util.getClientName(),r.event_source=n,r.event_object=e,r.event_action=a,r.event_label=s,r.event_value=o,r}(s,o,r,i),c=e.localStorage.getValue("sugar_stats");c||(c=[]),c.push(u),e.localStorage.setValue("sugar_stats",c),c.length>=constant.statPackageSize&&(console.log(n+": Send stat to server"),function sendStats(t,e,a){myserver.postStats(t,(function(){e&&e()}),(function(t,e){20!=t.code&&console.log("Error sending log"),a&&a()}))}(c,(function(){e.localStorage.setValue("sugar_stats",[])}),(function(){c.length>constant.statMaxLocalSize&&(c.shift(),e.localStorage.setValue("sugar_stats",c))})))}},a.clean=function(){e.localStorage.removeValue("sugar_stats")},a}));