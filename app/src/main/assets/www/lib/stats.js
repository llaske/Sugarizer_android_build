define(["settings","sugar-web/datastore"],(function(t,e){var a={};return a.isActive=function(){if(!t.getOptions("stats"))return!1;if(!t.isConnected())return!1;var e=t.getServer();return!!(e&&e.options&&e.options.statistics)},a.trace=function(n,s,o,r){if(a.isActive()){console.log("Sugarizer: "+s+"("+n+", "+o+", "+r+")");var i=function computeStat(e,a,n,s){var o={};return o.user_id=t.getNetworkId(),o.user_agent=navigator.userAgent,o.timestamp=(new Date).getTime(),o.client_type=util.getClientName(),o.event_source="Sugarizer",o.event_object=e,o.event_action=a,o.event_label=n,o.event_value=s,o}(n,s,o,r),u=e.localStorage.getValue("sugar_stats");u||(u=[]),u.push(i),e.localStorage.setValue("sugar_stats",u),u.length>=constant.statPackageSize&&(console.log("Sugarizer: Send stat to server"),function sendStats(t,e,a){myserver.postStats(t,(function(){e&&e()}),(function(t,e){20!=t.code&&console.log("Error sending log"),a&&a()}))}(u,(function(){e.localStorage.setValue("sugar_stats",[])}),(function(){u.length>constant.statMaxLocalSize&&(u.shift(),e.localStorage.setValue("sugar_stats",u))})))}},a.clean=function(){e.localStorage.removeValue("sugar_stats")},a}));