define(["settings"],(function(e){var t={},computeHeader=function(e){return{"x-key":e.x_key,"x-access-token":e.access_token}},getErrorCode=function(e){if(!e||!e.response||!e.response.data)return 404;try{return e.response.data.code}catch(e){return 500}},sessionExpired=function(){if(util.getClientType()==constant.webAppType)return util.cleanDatastore(null,(function(){util.restartApp()})),!0;window.setTimeout((function(){humane.log(l10n.get("SessionExpired")),app&&app.toolbar&&app.toolbar.showServerWarning&&app.toolbar.showServerWarning(!0)}),500);var t=e.getToken();return t.expired=!0,e.setToken(t),!1};return t.getServer=function(){var t=e.getServer();return null!=t&&t.url?t.url:util.getClientType()==constant.webAppType?util.getCurrentServerUrl():constant.http+"localhost"},t.getServerUrl=function(){var e=t.getServer();return e.length&&"/"==e[e.length-1]&&(e=e.substr(0,e.length-1)),e},t.getActivitiesUrl=function(){var n=e.getToken();return n?t.getServerUrl()+constant.dynamicInitActivitiesURL+"?x_key="+n.x_key+"&access_token="+n.access_token:(sessionExpired(),"")},t.getServerInformation=function(e,t,n){var r=e;r.length&&"/"==r[e.length-1]&&(r=r.substr(0,r.length-1)),axios.create({responseType:"json"}).get(r+constant.serverInformationURL).then((function(e){t&&t(null,e.data)})).catch((function(e){n&&n(e,getErrorCode(e))}))},t.getActivities=function(n,r){axios.create({responseType:"json",headers:computeHeader(e.getToken())}).get(t.getServerUrl()+constant.dynamicInitActivitiesURL).then((function(e){var t={data:e.data};n&&n(null,t)})).catch((function(e){var t=getErrorCode(e);3==t&&sessionExpired()||r&&r(e,t)}))},t.getUser=function(n,r,o,a){axios.create({responseType:"json",headers:computeHeader(e.getToken())}).get((a||t.getServerUrl())+constant.initNetworkURL+n).then((function(e){r(null,e.data)})).catch((function(e){var t=getErrorCode(e);3==t&&sessionExpired()||o&&o(e,t)}))},t.postUser=function(n,r,o){axios.create({responseType:"json"}).post(t.getServerUrl()+constant.signupURL,{user:JSON.stringify(n)}).then((function(o){if(!n.beforeSignup){var a={name:n.name,password:n.password};t.loginUser(a,(function(t,n){e.setToken({x_key:n.user._id,access_token:n.token})}))}r&&r(null,o.data)})).catch((function(e){var t=getErrorCode(e);3==t&&sessionExpired()||o&&o(e,t)}))},t.loginUser=function(e,n,r){var o=e;o.role=["student","teacher"],axios.create({responseType:"json"}).post(t.getServerUrl()+constant.loginURL,{user:JSON.stringify(o)}).then((function(e){n(null,e.data)})).catch((function(e){var t=getErrorCode(e);3==t&&sessionExpired()||r&&r(e,t)}))},t.putUser=function(n,r,o,a){axios.create({responseType:"json",headers:computeHeader(e.getToken())}).put(t.getServerUrl()+constant.initNetworkURL+n,{user:JSON.stringify(r)}).then((function(e){o(null,e.data)})).catch((function(e){var t=getErrorCode(e);3==t&&sessionExpired()||a&&a(e,t)}))},t.deleteUser=function(n,r,o){axios.create({responseType:"json",headers:computeHeader(e.getToken())}).delete(t.getServerUrl()+constant.initNetworkURL+n).then((function(e){r(null,e.data)})).catch((function(e){var t=getErrorCode(e);3==t&&sessionExpired()||o&&o(e,t)}))},t.getJournal=function(n,r,o,a){var s=r.typeactivity,i=r.stime,c=r.favorite,u=r.assignment,l=(r.field,r.limit),p=r.offset,f=r.title,d=r.sort,g=t.getServerUrl()+constant.sendCloudURL+n+"?limit="+l,v={};void 0!==s&&(v.aid=s),void 0!==i&&(v.stime=i),void 0!==c&&(v.favorite=c),void 0!==u&&(v.assignment=u),void 0!==p&&(v.offset=p),void 0!==f&&(v.title=f),v.sort=void 0!==d?d:"-timestamp",axios.create({responseType:"json",headers:computeHeader(e.getToken()),params:v}).get(g).then((function(e){o(null,e.data)})).catch((function(e){var t=getErrorCode(e);3==t&&sessionExpired()||a&&a(e,t)}))},t.getJournalEntry=function(n,r,o,a){axios.create({responseType:"json",headers:computeHeader(e.getToken()),params:{oid:r,fields:"text,metadata"}}).get(t.getServerUrl()+constant.sendCloudURL+n).then((function(e){o(null,e.data)})).catch((function(e){var t=getErrorCode(e);3==t&&sessionExpired()||a&&a(e,t)}))},t.postJournalEntry=function(n,r,o,a){var s=e.getToken();r.metadata.user_id=s.x_key,axios.create({responseType:"json",headers:computeHeader(s)}).post(t.getServerUrl()+constant.sendCloudURL+n,{journal:JSON.stringify(r)}).then((function(e){o(null,e.data)})).catch((function(e){var t=getErrorCode(e);3==t&&sessionExpired()||a&&a(e,t)}))},t.putJournalEntry=function(n,r,o,a,s){var i=e.getToken();o.metadata.user_id=i.x_key,axios.create({responseType:"json",params:{oid:r},headers:computeHeader(i)}).put(t.getServerUrl()+constant.sendCloudURL+n,{journal:JSON.stringify(o)}).then((function(e){a(null,e.data)})).catch((function(e){var t=getErrorCode(e);3==t&&sessionExpired()||s&&s(e,t)}))},t.deleteJournalEntry=function(n,r,o,a){axios.create({responseType:"json",params:{oid:r,type:"partial"},headers:computeHeader(e.getToken())}).delete(t.getServerUrl()+constant.sendCloudURL+n).then((function(e){o(null,e.data)})).catch((function(e){var t=getErrorCode(e);3==t&&sessionExpired()||a&&a(e,t)}))},t.postStats=function(n,r,o){axios.create({responseType:"json",headers:computeHeader(e.getToken())}).post(t.getServerUrl()+constant.statsURL,{stats:JSON.stringify(n)}).then((function(e){r&&r(null,e.data)})).catch((function(e){var t=getErrorCode(e);o&&o(e,t)}))},t.postAssignment=function(n,r,o,a){axios.create({responseType:"json",params:{oid:r},headers:computeHeader(e.getToken())}).put(t.getServerUrl()+constant.submitAssignment+n).then((function(e){o&&o(null,e.data)})).catch((function(e){var t=getErrorCode(e);a&&a(e,t)}))},t}));