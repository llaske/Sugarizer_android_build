define(["settings"],(function(e){var n={},setHeader=function(e,n){e.setHeaders({"x-key":n.x_key,"x-access-token":n.access_token})},getErrorCode=function(e){if(!e||!e.xhrResponse||!e.xhrResponse.body)return 404;try{return JSON.parse(e.xhrResponse.body).code}catch(e){return 500}},sessionExpired=function(){if(util.getClientType()==constant.webAppType)return util.cleanDatastore(null,(function(){util.restartApp()})),!0;window.setTimeout((function(){humane.log(l10n.get("SessionExpired")),app.toolbar&&app.toolbar.showServerWarning&&app.toolbar.showServerWarning(!0)}),500);var n=e.getToken();return n.expired=!0,e.setToken(n),!1};return n.getServer=function(){var n=e.getServer();return null!=n&&n.url?n.url:util.getClientType()==constant.webAppType?util.getCurrentServerUrl():constant.http+"localhost"},n.getServerUrl=function(){var e=n.getServer();return e.length&&"/"==e[e.length-1]&&(e=e.substr(0,e.length-1)),e},n.getActivitiesUrl=function(){var t=e.getToken();return t?n.getServerUrl()+constant.dynamicInitActivitiesURL+"?x_key="+t.x_key+"&access_token="+t.access_token:(sessionExpired(),"")},n.getServerInformation=function(e,n,t){var r=e;r.length&&"/"==r[e.length-1]&&(r=r.substr(0,r.length-1));var o=new enyo.Ajax({url:r+constant.serverInformationURL,method:"GET",handleAs:"json"});o.response((function(e,t){n&&n(e,t)})),o.error((function(e){t&&t(e,getErrorCode(e))})),o.go()},n.getActivities=function(t,r){var o=new enyo.Ajax({url:n.getServerUrl()+constant.dynamicInitActivitiesURL,method:"GET",handleAs:"json"});setHeader(o,e.getToken()),o.response((function(e,n){t&&t(e,{data:n})})),o.error((function(e){var n=getErrorCode(e);3==n&&sessionExpired()||r&&r(e,n)})),o.go()},n.getUser=function(t,r,o,s){var a=new enyo.Ajax({url:(s||n.getServerUrl())+constant.initNetworkURL+t,method:"GET",handleAs:"json"});setHeader(a,e.getToken()),a.response(r),a.error((function(e){var n=getErrorCode(e);3==n&&sessionExpired()||o&&o(e,n)})),a.go()},n.postUser=function(t,r,o){var s=new enyo.Ajax({url:n.getServerUrl()+constant.signupURL,method:"POST",handleAs:"json",postBody:{user:JSON.stringify(t)}});s.response((function(o,s){if(!t.beforeSignup){var a={name:t.name,password:t.password};n.loginUser(a,(function(n,t){e.setToken({x_key:s._id,access_token:t.token})}))}r&&r(o,s)})),s.error((function(e){var n=getErrorCode(e);3==n&&sessionExpired()||o&&o(e,n)})),s.go()},n.loginUser=function(e,t,r){var o=e;o.role=["student","teacher"];var s=new enyo.Ajax({url:n.getServerUrl()+constant.loginURL,method:"POST",handleAs:"json",postBody:{user:JSON.stringify(o)}});s.response(t),s.error((function(e){var n=getErrorCode(e);3==n&&sessionExpired()||r&&r(e,n)})),s.go()},n.putUser=function(t,r,o,s){var a=new enyo.Ajax({url:n.getServerUrl()+constant.initNetworkURL+t,method:"PUT",handleAs:"json",postBody:{user:JSON.stringify(r)}});setHeader(a,e.getToken()),a.response(o),a.error((function(e){var n=getErrorCode(e);3==n&&sessionExpired()||s&&s(e,n)})),a.go()},n.getJournal=function(t,r,o,s){var a=r.typeactivity,i=r.stime,u=r.favorite,l=(r.field,r.limit),c=r.offset,d=r.title,g=r.sort,v=n.getServerUrl()+constant.sendCloudURL+t+"?limit="+l,f={};void 0!==a&&(f.aid=a),void 0!==i&&(f.stime=i),void 0!==u&&(f.favorite=u),void 0!==c&&(f.offset=c),void 0!==d&&(f.title=d),f.sort=void 0!==g?g:"-timestamp";var p=new enyo.Ajax({url:v,method:"GET",handleAs:"json"});setHeader(p,e.getToken()),p.response(o),p.error((function(e){var n=getErrorCode(e);3==n&&sessionExpired()||s&&s(e,n)})),p.go(f)},n.getJournalEntry=function(t,r,o,s){var a={},i=new enyo.Ajax({url:n.getServerUrl()+constant.sendCloudURL+t,method:"GET",handleAs:"json"});a.oid=r,a.fields="text,metadata",setHeader(i,e.getToken()),i.response(o),i.error((function(e){var n=getErrorCode(e);3==n&&sessionExpired()||s&&s(e,n)})),i.go(a)},n.postJournalEntry=function(t,r,o,s){var a=e.getToken();r.metadata.user_id=a.x_key;var i=new enyo.Ajax({url:n.getServerUrl()+constant.sendCloudURL+t,method:"POST",handleAs:"json",postBody:{journal:JSON.stringify(r)}});setHeader(i,a),i.response(o),i.error((function(e){var n=getErrorCode(e);3==n&&sessionExpired()||s&&s(e,n)})),i.go()},n.putJournalEntry=function(t,r,o,s,a){var i={},u=e.getToken();o.metadata.user_id=u.x_key;var l=new enyo.Ajax({url:n.getServerUrl()+constant.sendCloudURL+t,method:"PUT",handleAs:"json",postBody:{journal:JSON.stringify(o)}});setHeader(l,u),l.response(s),l.error((function(e){var n=getErrorCode(e);3==n&&sessionExpired()||a&&a(e,n)})),i.oid=r,l.go(i)},n.deleteJournalEntry=function(t,r,o,s){var a={},i=new enyo.Ajax({url:n.getServerUrl()+constant.sendCloudURL+t,method:"DELETE",handleAs:"json"});setHeader(i,e.getToken()),i.response(o),i.error((function(e){var n=getErrorCode(e);3==n&&sessionExpired()||s&&s(e,n)})),a.oid=r,a.type="partial",i.go(a)},n.postStats=function(t,r,o){var s=new enyo.Ajax({url:n.getServerUrl()+constant.statsURL,method:"POST",handleAs:"json",postBody:{stats:JSON.stringify(t)}});setHeader(s,e.getToken()),s.response((function(e,n){r&&r(e,n)})),s.error((function(e){var n=getErrorCode(e);o&&o(e,n)})),s.go()},n}));