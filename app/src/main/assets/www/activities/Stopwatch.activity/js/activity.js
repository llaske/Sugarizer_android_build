define(["sugar-web/activity/activity","mustache","sugar-web/env","tutorial","l10n"],(function(t,e,s,n,o){requirejs(["domReady!"],(function(n){t.setup();var i=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;function pad(t,e,s){return s=s||"0",(t+="").length>=(e=e||2)?t:new Array(e-t.length+1).join(s)+t}function Stopwatch(t,s){this.elem=document.createElement("li"),document.getElementById("stopwatch-list").appendChild(this.elem);var n=document.getElementsByTagName("li").length;this.template='<div class="card-body"><div class="row" id="'+n+'"><div class="col-sm-2 col-md-2 col-lg-2 d-flex justify-content-center align-items-center"><div class="counter">00:00:00</div></div><div class="col-sm-4 col-md-4 col-lg-4 d-flex justify-content-center align-items-center"><div class="buttons-group"><button class="start-stop-button start" title="Start"></button><button class="reset-button" title="Reset"></button><button class="mark-button" title="Mark"></button></div></div><div class="col-sm-5 col-md-5 col-lg-5 d-flex align-items-center justify-content-center"><div class="marks"></div></div><div class="col-sm-1 col-md-1 col-lg-1 d-flex justify-content-center align-items-center p-0"><button class ="remove" title="Remove"></button></div></div></div>',this.elem.innerHTML=e.render(this.template,{}),this.counterElem=this.elem.querySelector(".counter"),this.marksElem=this.elem.querySelector(".marks"),this.running=!1,this.previousTime=Date.now(),this.tenthsOfSecond=0,this.seconds=0,this.minutes=0,s?(this.marks=s,this.updateMarks()):this.marks=[],t&&(this.minutes=parseInt(t.split(":")[0]),this.seconds=parseInt(t.split(":")[1]),this.tenthsOfSecond=parseInt(t.split(":")[2]),this.updateView());var i=this;this.startStopButton=this.elem.querySelector(".start-stop-button"),this.startStopButton.onclick=function(){i.onStartStopClicked()},this.resetButton=this.elem.querySelector(".reset-button"),this.resetButton.onclick=function(){i.onResetClicked()},this.markButton=this.elem.querySelector(".mark-button"),this.markButton.onclick=function(){i.onMarkClicked()},this.removeButton=this.elem.querySelector(".remove"),this.removeButton.onclick=function(){i.onRemoveClicked()}}Stopwatch.prototype.onStartStopClicked=function(){this.running?(this.running=!1,this.startStopButton.title="Start",this.resetButton=this.elem.querySelector(".reset-button"),this.resetButton.disabled=!1):(this.running=!0,this.tick(),this.startStopButton=this.elem.querySelector(".start-stop-button"),this.startStopButton.title="Stop",this.resetButton=this.elem.querySelector(".reset-button"),this.resetButton.disabled=!0),this.updateButtons()},Stopwatch.prototype.onResetClicked=function(){this.tenthsOfSecond=0,this.seconds=0,this.minutes=0,this.running?this.onStartStopClicked():this.running=!1,this.updateView(),this.onClearMarksClicked()},Stopwatch.prototype.onMarkClicked=function(){this.marks.length>=10&&this.marks.shift(),0==pad(this.minutes)&&0==pad(this.seconds)&&0==pad(this.tenthsOfSecond)||this.marks.push(pad(this.minutes)+":"+pad(this.seconds)+":"+pad(this.tenthsOfSecond)),this.updateMarks()},Stopwatch.prototype.onClearMarksClicked=function(){this.marks=[],this.updateMarks()},Stopwatch.prototype.onRemoveClicked=function(){document.getElementById("stopwatch-list").removeChild(this.elem)},Stopwatch.prototype.tick=function(){if(this.running){var t=Date.now();t-this.previousTime>100&&(this.previousTime=t,this.update(),this.updateView()),i(this.tick.bind(this))}},Stopwatch.prototype.update=function(){this.tenthsOfSecond+=1,10==this.tenthsOfSecond&&(this.tenthsOfSecond=0,this.seconds+=1),60==this.seconds&&(this.seconds=0,this.minutes+=1)},Stopwatch.prototype.updateView=function(){this.counterElem.innerHTML=pad(this.minutes)+":"+pad(this.seconds)+":"+pad(this.tenthsOfSecond)},Stopwatch.prototype.updateMarks=function(){this.marksElem.innerHTML="";for(var t=0;t<this.marks.length;t++)this.marksElem.innerHTML+=this.marks[t],t!==this.marks.length-1&&(this.marksElem.innerHTML+=" - ")},Stopwatch.prototype.updateButtons=function(){this.running?(this.startStopButton.classList.add("stop"),this.startStopButton.classList.remove("start")):(this.startStopButton.classList.add("start"),this.startStopButton.classList.remove("stop"))},document.getElementById("add-stopwatch").onclick=function(){new Stopwatch},s.getEnvironment((function(e,s){currentenv=s;var n="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,i=s.user?s.user.language:n;if(o.init(i),s.objectId)t.getDatastoreObject().loadAsText((function(t,e,s){var n;if(null==t&&null!=s)for(stopwatchData=JSON.parse(s),n=0;n<Object.keys(stopwatchData).length;n++)counter=stopwatchData[n].counter,marks=stopwatchData[n].marks,new Stopwatch(counter,marks)}));else for(var a=0;a<5;a++)new Stopwatch}))})),document.getElementById("stop-button").addEventListener("click",(function(e){var s,n=document.getElementById("stopwatch-list").getElementsByTagName("li");for(stopwatchDict={},s=0;s<n.length;s++)stopwatchDict[s]={},stopwatchDict[s].counter=n[s].getElementsByClassName("counter")[0].innerHTML,stopwatchDict[s].marks=n[s].getElementsByClassName("marks")[0].innerHTML.split(" - ");stopwatchJSON=JSON.stringify(stopwatchDict),t.getDatastoreObject().setDataAsText(stopwatchJSON),t.getDatastoreObject().save()})),document.getElementById("fullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.display="none",document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible"})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.display="block",document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden"})),document.getElementById("help-button").addEventListener("click",(function(t){n.start()})),document.getElementById("export-csv-button").addEventListener("click",(function(){var t=document.getElementById("stopwatch-list").getElementsByTagName("li"),e="Marks No.,Time (s),Marks,Counter\n",s=[];for(i=0;i<t.length;i++)for(var n=t[i].getElementsByClassName("marks")[0].innerHTML.split(" - "),a=0;a<n.length&&(1!==n.length||n[0]);a++){var r=n[a],c=60*parseInt(r.split(":")[0])+parseInt(r.split(":")[1])+parseInt(r.split(":")[2])/10;s.includes(r)||s.push(r);var l=s.indexOf(r)+1;e+=`${l},${c||""},${r},${i+1}\n`}var u={mimetype:"text/csv",title:"Stopwatch export.csv",activity:"org.sugarlabs.ChartActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};requirejs(["sugar-web/datastore","humane"],(function(t,s){t.create(u,(function(){s.log(o.get("exportAsCSV"))}),e)}))}))}));