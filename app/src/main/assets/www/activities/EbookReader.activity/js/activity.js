requirejs.config({baseUrl:"lib"});var defaultUrlLibrary="https://sugarizer.org/content/books.php",app=new Vue({el:"#app",components:{"ebook-reader":EbookReader,"library-viewer":LibraryViewer,toolbar:Toolbar,localization:Localization,popup:Popup,tutorial:Tutorial},data:{currentBook:null,currentEpub:null,currentView:LibraryViewer,currentLibrary:{database:[]},timer:null},created:function(){requirejs(["sugar-web/activity/activity","sugar-web/env"],(function(t,e){t.setup()}))},mounted:function(){var t=this;requirejs(["sugar-web/activity/activity","sugar-web/env"],(function(e,n){n.getEnvironment((function(i,r){n.getEnvironment((function(t,e){document.getElementById("canvas").style.backgroundColor=e.user.colorvalue.fill})),r.objectId?e.getDatastoreObject().loadAsText((function(e,n,i){if(null==e&&null!=i){var r=JSON.parse(i);t.currentLibrary=r.library,void 0!==r.current?(t.currentBook=t.currentLibrary.database[r.current],t.currentEpub=ePub(t.currentLibrary.information.fileprefix+t.currentBook.file),t.currentView=EbookReader):0==t.currentLibrary.database.length&&t.loadLibrary(defaultUrlLibrary),document.getElementById("spinner").style.visibility="hidden"}})):(t.loadLibrary(defaultUrlLibrary),t.saveContextToJournal())}))})),window.addEventListener("resize",(function(){t.onResize()})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){t.unfullscreen()}))},updated:function(){this.currentView===EbookReader&&this.$refs.view.render(this.currentEpub,this.currentBook.location)},methods:{localized:function(){this.$refs.toolbar.localized(this.$refs.localization),this.$refs.tutorial.localized(this.$refs.localization)},loadLibrary:function(t){var e=this;e.currentLibrary={database:[]},defaultUrlLibrary=t,document.getElementById("spinner").style.visibility="visible",axios.get(t+"?lang="+e.$refs.localization.code).then((function(t){e.currentLibrary=t.data,document.getElementById("spinner").style.visibility="hidden",document.getElementById("cloudwarning").style.visibility="hidden"})).catch((function(t){document.getElementById("spinner").style.visibility="hidden",document.getElementById("cloudwarning").style.visibility="visible"}))},saveContext:function(){this.currentView===EbookReader?this.$refs.view.getLocation()&&(this.currentBook.location=this.$refs.view.getLocation()):this.currentLibrary=this.$refs.view.library},switchView:function(){this.saveContext(),this.currentView===EbookReader?this.currentView=LibraryViewer:this.currentBook&&(this.currentView=EbookReader)},showContents:function(){this.$refs.view.goToPage(this.currentEpub.contents)},fullscreen:function(){if(document.getElementById("main-toolbar").style.opacity=0,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",this.currentView===EbookReader){var t=this.$refs.view;t.render(this.currentEpub,t.getLocation())}},unfullscreen:function(){if(document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",this.currentView===EbookReader){var t=this.$refs.view;t.render(this.currentEpub,t.getLocation())}},setLibraryUrl:function(){var t=this.$refs.localization.get("Ok"),e=this.$refs.localization.get("Cancel"),n=this.$refs.localization.get("Settings"),i=this.$refs.localization.get("Url");this.$refs.settings.show({content:"\n\t\t\t\t\t<div id='popup-toolbar' class='toolbar' style='padding: 0'>\n\t\t\t\t\t\t<button class='toolbutton pull-right' id='popup-ok-button' title='"+t+"' style='outline:none;background-image: url(lib/sugar-web/graphics/icons/actions/dialog-ok.svg)'></button>\n\t\t\t\t\t\t<button class='toolbutton pull-right' id='popup-cancel-button' title='"+e+"' style='outline:none;background-image: url(lib/sugar-web/graphics/icons/actions/dialog-cancel.svg)'></button>\n\t\t\t\t\t\t<div style='position: absolute; top: 20px; left: 60px;'>"+n+"</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div id='popup-container' style='width: 100%; overflow:auto'>\n\t\t\t\t\t\t<div class='popup-label'>"+i+"</div>\n\t\t\t\t\t\t<input id='input' class='popup-input'/>\n\t\t\t\t\t</div>",closeButton:!1,modalStyles:{backgroundColor:"white",height:"160px",width:"600px",maxWidth:"90%"}})},settingsShown:function(){var t=this;document.getElementById("popup-container").style.height=document.getElementById("popup-toolbar").parentNode.offsetHeight-110+"px",document.getElementById("popup-ok-button").addEventListener("click",(function(){t.$refs.settings.close(!0)})),document.getElementById("popup-cancel-button").addEventListener("click",(function(){t.$refs.settings.close()})),document.getElementById("input").value=defaultUrlLibrary},settingsClosed:function(t){t&&this.loadLibrary(document.getElementById("input").value),this.$refs.settings.destroy()},onBookSelected:function(t){if(this.currentView===LibraryViewer){var e=this;e.currentBook=t,Vue.set(t,"spinner",!0),e.currentEpub=new ePub.Book;var n=new XMLHttpRequest;n.open("GET",e.currentLibrary.information.fileprefix+e.currentBook.file,!0),n.responseType="arraybuffer",n.onload=function(){e.currentEpub.open(this.response).then((function(){e.currentEpub.loaded.navigation.then((function(t){t.forEach((function(t){"CONTENTS"==t.label.toUpperCase().trim()&&(e.currentEpub.contents=t.href)}))})),e.currentView=EbookReader,t.spinner=!1}),(function(){console.log("Error loading "+e.currentLibrary.information.fileprefix+e.currentBook.file),t.spinner=!1}))},n.send()}},onResize:function(){var t=this;if(t.currentView===EbookReader){var e=t.$refs.view;this.timer&&window.clearTimeout(this.timer),this.timer=window.setTimeout((function(){t.currentBook.location=e.getLocation(),e.render(t.currentEpub,t.currentBook.location),this.timer=null}),500)}},onHelp:function(){var t={};t.switchbutton=this.$refs.toolbar.$refs.switchbutton.$el,t.contentsbutton=null,this.$refs.toolbar.$refs.contentsbutton&&(t.contentsbutton=this.$refs.toolbar.$refs.contentsbutton.$el),t.settingsbutton=this.$refs.toolbar.$refs.settings.$el,t.fullscreenbutton=this.$refs.toolbar.$refs.fullscreen.$el,this.currentView===LibraryViewer&&this.$refs.view.$refs.item0&&this.$refs.view.$refs.item0[0]?t.book=this.$refs.view.$refs.item0[0].$el:this.currentView===EbookReader&&(t.prevbutton=document.getElementById("left"),t.nextbutton=document.getElementById("right")),this.$refs.tutorial.show(t)},saveContextToJournal:function(){var t=this;t.saveContext(),requirejs(["sugar-web/activity/activity"],(function(e){console.log("writing...");var n={library:{information:t.currentLibrary.information,database:t.currentLibrary.database}};t.currentView===EbookReader&&(n.current=t.currentLibrary.database.indexOf(t.currentBook));var i=JSON.stringify(n);e.getDatastoreObject().setDataAsText(i),e.getDatastoreObject().save((function(t){null===t?console.log("write done."):console.log("write failed.")}))}))},onStop:function(){this.saveContextToJournal()}}});