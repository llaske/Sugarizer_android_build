var Player={template:'\n\t\t<div>\n\t\t\t<div id="back" class="editor-goback" v-on:click="goBack()"></div>\n\t\t\t<img id="miniletter" class="editor-miniletter" v-bind:src="item.image" v-bind:style="{visibility:item.image?\'visible\':\'hidden\'}"></img>\n\t\t\t<div id="miniword" class="editor-miniword" v-bind:style="computeStyle()">{{item.text}}</div>\n\t\t\t<div id="area" class="editor-area">\n\t\t\t\t<canvas id="letter"></canvas>\n\t\t\t</div>\n\t\t\t<button id="player-restart" class="player-restart"></button>\n\t\t\t<button id="player-next-letter" class="player-next" v-on:click="nextItem()"></button>\n\t\t\t<div id="cursor" class="player-cursor"></div>\n\t\t\t<div id="debugpos" class="player-debug-position">X: 0 / Y: 0</div>\n\t\t\t<div id="debugtarget" class="player-debug-target">CX: 0 / CY: 0</div>\n\t\t</div>',props:["item"],data:function(){return{size:-1,imageSize:-1,fontSize:6,zoom:-1,starts:[],current:{start:-1,stroke:-1,strokes:[],index:-1,cursor:{x:0,y:0},timeout:null},zoomMult:1,computed:!1,mode:"",drawing:!1,debug:!1,precision:5,angleTolerance:.7,isText:!1}},methods:{computeSize:function(){var t=this,e=document.getElementById("canvas")||document.getElementById("body"),r=e.offsetHeight-50,n={width:e.offsetWidth-50,height:r};t.size=Math.min(n.width,n.height);var o=document.getElementById("letter");if(t.isText=t.item.text,o.width=t.isText?1.5*t.size:t.size,o.height=t.size,o.style.marginLeft=(t.isText?0:(n.width-t.size)/2-50)+"px",t.isText&&!t.computed){for(var i={width:100,height:100},s=!1,a=6,u=a;u<300&&!s;u++){let t=getTextSize(this.item.text,u+"px Arial");(s=t.width>i.width||2*t.height>i.height)||(a=u)}t.fontSize=a;let e=(a-50)/64;t.zoomMult=1+e,t.computed=!0}t.zoom=t.size/t.imageSize*t.zoomMult,t.size*=t.zoomMult,this.draw()},computeStyle:function(){var t={};return t.visibility=this.item.text?"visible":"hidden",t.fontSize=this.fontSize+"px",t},init:function(){var t=this;t.computed=!1,t.initComponent((function(){t.onLoad(),t.startDemoMode()}))},initComponent:function(t){var e=this;if(e.item.image){e.starts=[];for(var r=0;r<e.item.starts.length;r++)e.starts.push(e.item.starts[r]);var n=new Image;n.onload=function(){if(e.imageSize=n.width,t){let e=[];e.push({image:n,x:0,y:0}),t(e)}},n.src=e.item.image}else if(e.item.text){var o=[];for(let t=0;t<e.item.text.length;t++){var i=e.item.text[t],s=("b"==i||"o"==i||"v"==i||"w"==i)&&t!=e.item.text.length-1,a="e"==i&&0!=t;for(let t=0;t<app.currentLibrary.length;t++)for(let e=0;e<app.currentLibrary[t].images.length;e++){var u=app.currentLibrary[t].images[e];if(i==u.letter&&(!s||u.low)&&(!a||u.high)){o.push(u);break}}}e.starts=[];let r=[];for(let t=0;t<o.length;t++){let e=0,n=Number.MAX_VALUE;for(let r=0;r<o[t].starts.length;r++){let i=o[t].starts[r];e=Math.max(i.x,e),n=Math.min(i.x,n);for(var c=0;c<i.path.length;c++)e=Math.max(i.path[c].x,e),n=Math.min(i.path[c].x,n)}"j"==o[t].letter&&t>0&&(n=Math.min(o[t].starts[0].x)),r.push({max:e,min:n})}let n=0,l=[],m=[];for(let t=0;t<o.length;t++){let i=3-r[t].min;n+=0==t?0:r[t-1].max-r[t-1].min,l.push(n+i);for(let r=0;r<o[t].starts.length;r++){let s=JSON.parse(JSON.stringify(o[t].starts[r]));s.x+=n+i;for(c=0;c<s.path.length;c++)s.path[c].x+=n+i;"i"!=o[t].letter&&"j"!=o[t].letter||r!=o[t].starts.length-1?e.starts.push(s):m.push(s)}}m.length>0&&Array.prototype.push.apply(e.starts,m);let d=o.length,h=[];for(let r=0;r<o.length;r++){let n=new Image;h.push({image:n,x:l[r],y:0}),n.onload=function(){0==--d&&(e.imageSize=n.width,t(h))},n.src=o[r].image}}},initEvent:function(){var t=this;document.getElementById("player-restart").addEventListener("click",(function(e){t.startDemoMode()})),t.debug&&(document.getElementById("debugpos").style.visibility="visible",document.getElementById("debugtarget").style.visibility="visible");var e="mousedown",r="mousemove",n="mouseup",o="ontouchstart"in document.documentElement;o&&(e="touchstart",r="touchmove",n="touchend");var i=document.getElementById("cursor");i.addEventListener(r,(function(e){if(e.preventDefault(),"input"==t.mode&&t.drawing){o&&(e=e.touches[0],t.precision=8e3/window.innerHeight,t.angleTolerance=1.4);var r=Math.floor((e.clientX-s.getBoundingClientRect().left)/t.zoom),n=Math.floor((e.clientY-s.getBoundingClientRect().top)/t.zoom);t.handleMouseMove(r,n)}})),i.addEventListener(e,(function(e){e.preventDefault(),t.drawing="input"==t.mode})),i.addEventListener(n,(function(e){e.preventDefault(),t.drawing=!1}));var s=document.getElementById("letter");s.addEventListener(e,(function(e){e.preventDefault(),t.drawing="input"==t.mode})),s.addEventListener(n,(function(e){e.preventDefault(),t.drawing=!1})),s.addEventListener(r,(function(e){if(e.preventDefault(),"input"==t.mode&&t.drawing){o&&(e=e.touches[0]);var r=Math.floor((e.clientX-s.getBoundingClientRect().left)/t.zoom),n=Math.floor((e.clientY-s.getBoundingClientRect().top)/t.zoom);t.handleMouseMove(r,n)}}))},draw:function(){var t=this,e=document.getElementById("letter"),r=e.getContext("2d");r.clearRect(0,0,t.zoom*(t.isText?e.width:t.imageSize),t.size),t.initComponent((function(e){if(t.drawLines(),e)for(let n=0;n<e.length;n++){let o=e[n];t.isText?r.drawImage(o.image,t.zoom*o.x,t.zoom*o.y,t.size,t.size):r.drawImage(o.image,0,0,t.size,t.size)}"input"==t.mode&&t.current.strokes.length&&t.drawStoke()}))},drawLines:function(){if(app.$refs.toolbar.$refs.lines.isActive){var t=this,e=document.getElementById("letter"),r=e.getContext("2d");r.strokeStyle="lightgray",r.lineWidth=3;for(var n=[8,85,122,202],o=0;o<n.length;o++)r.beginPath(),r.moveTo(0*t.zoom,t.zoom*n[o]),r.lineTo(t.zoom*(t.isText?e.width:t.imageSize),t.zoom*n[o]),r.stroke()}},drawStoke:function(){var t=this,e=document.getElementById("letter").getContext("2d");e.strokeStyle=app.color.stroke,e.lineWidth=10,e.lineCap="round",e.lineJoin="round";for(var r=0;r<t.current.strokes.length;r++){e.beginPath();for(var n=0;n<t.current.strokes[r].length;n++)e.lineTo(t.zoom*t.current.strokes[r][n].x,t.zoom*t.current.strokes[r][n].y);e.stroke()}},moveCursor:function(t){var e=document.getElementById("cursor");e&&(e.style.left=t.x+letter.getBoundingClientRect().left-23+"px",e.style.top=t.y+"px",this.current.cursor={x:t.x,y:t.y})},setCursorVisibility:function(t){var e=document.getElementById("cursor");e&&(e.style.visibility=t?"visible":"hidden")},handleMouseMove:function(t,e){var r=this,n=r.starts[r.current.start].path.length?r.starts[r.current.start].path[r.current.index]:r.starts[r.current.start];r.debug&&(document.getElementById("debugpos").innerText="X: "+t+" / Y: "+e,document.getElementById("debugtarget").innerText="CX: "+n.x+" / CY: "+n.y),r.moveCursor({x:r.zoom*n.x,y:r.zoom*n.y});var o=Math.sqrt(Math.pow(t-n.x,2)+Math.pow(e-n.y,2)),i=r.current.index>0?r.starts[r.current.start].path[r.current.index-1]:n,s=t-i.x,a=e-i.y,u=n.x-i.x,c=n.y-i.y,l=Math.abs(Math.atan(c/u)-Math.atan(a/s));if(o<=r.precision&&(l<r.angleTolerance||Number.isNaN(l))&&(r.current.strokes[r.current.start].push({x:n.x,y:n.y}),r.drawStoke(),r.current.index++,r.current.index>=r.starts[r.current.start].path.length))if(r.current.start++,r.current.index=0,r.current.start>=r.starts.length)r.mode="end",r.setCursorVisibility(!1),setTimeout((function(){confetti({particleCount:200,spread:70,origin:{y:.6}})}),500);else{var m=[{x:r.starts[r.current.start].x,y:r.starts[r.current.start].y}];r.moveCursor({x:r.zoom*m[0].x,y:r.zoom*m[0].y}),r.current.strokes.push(m),r.drawStoke()}},startDemoMode:function(){var t=this,e=70/(t.isText?t.item.text.length:1);t.mode="show";var step=function(){if(t.current&&t.current.strokes&&t.current.strokes[t.current.start]&&t.current.strokes[t.current.start][t.current.stroke]){var r=t.current.strokes[t.current.start][t.current.stroke],n=document.getElementById("letter");if(n){var o=n.getContext("2d");o.beginPath(),o.strokeStyle=app.color.stroke,o.lineWidth=10,o.lineCap="round",o.lineJoin="round",o.moveTo(t.zoom*r.x0,t.zoom*r.y0),o.lineTo(t.zoom*r.x1,t.zoom*r.y1),o.stroke(),t.moveCursor({x:t.zoom*r.x1,y:t.zoom*r.y1}),t.current.stroke++,t.current.stroke>=t.current.strokes[t.current.start].length?(t.current.start++,t.current.stroke=0,t.current.start<t.current.strokes.length?t.current.timeout=setTimeout((function(){t.current.timeout=setTimeout(step,e)}),3*e):t.current.timeout=setTimeout((function(){t.startInputMode(),t.current.timeout=null}),10*e)):t.current.timeout=setTimeout(step,e)}}};if(t.starts&&t.starts[0].path.length){t.draw(),t.current.start=0,t.current.stroke=0,t.current.strokes=[];for(var r=0;r<t.starts.length;r++)if(t.starts[r].path){var n=[],o=t.starts[r].path;t.starts[r].path.length?n.push({x0:t.starts[r].x,y0:t.starts[r].y,x1:o[0].x,y1:o[0].y}):n.push({x0:t.starts[r].x,y0:t.starts[r].y,x1:t.starts[r].x,y1:t.starts[r].y});for(var i=0;i<o.length;i++)i+1<o.length&&n.push({x0:o[i].x,y0:o[i].y,x1:o[i+1].x,y1:o[i+1].y});t.current.strokes.push(n)}var s=t.current.strokes[t.current.start][t.current.stroke];t.moveCursor({x:t.zoom*s.x0,y:t.zoom*s.y0}),t.setCursorVisibility(!0),t.current.timeout=setTimeout(step,100)}},startInputMode:function(){var t=this;if(t.mode="input",t.current.start=0,t.current.stroke=0,t.current.index=0,t.current.strokes=[],t.starts&&t.starts.length){var e=[{x:t.starts[0].x,y:t.starts[0].y}];t.moveCursor({x:t.zoom*e[0].x,y:t.zoom*e[0].y}),t.setCursorVisibility(!0),t.current.strokes.push(e)}t.draw()},onLoad:function(){this.computeSize(),this.initEvent(),requirejs(["sugar-web/graphics/icon"],(function(t){t.colorize(document.getElementById("cursor"),app.color,(function(){}))}))},doZoom:function(t){var e=this,r=1,n=e.current.cursor.x/e.zoom,o=e.current.cursor.y/e.zoom;switch(t.zoom){case 0:r=.9;break;case 1:e.zoomMult=1;break;case 2:r*=1.1}e.zoomMult*=r,e.computeSize(),e.moveCursor({x:e.zoom*n,y:e.zoom*o})},doFullscreen:function(t){var e=this,r=e.current.cursor.x/e.zoom,n=e.current.cursor.y/e.zoom;e.computeSize(),e.moveCursor({x:e.zoom*r,y:e.zoom*n})},goBack:function(){app.displayTemplateView()},nextItem:function(){this.item=app.nextItem(this.item),this.init()}},mounted:function(){this.init()},beforeDestroy:function(){this.current.timeout&&clearTimeout(this.current.timeout)}};