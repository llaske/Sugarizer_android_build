requirejs.config({baseUrl:"lib",paths:{activity:"../js"}});var app=new Vue({el:"#app",components:{toolbar:Toolbar,localization:Localization,tutorial:Tutorial,"template-viewer":TemplateViewer,editor:Editor,player:Player,popup:Popup},data:{currentView:TemplateViewer,currentLibrary:null,currentTemplate:null,currentItem:null,color:{stroke:"#00000",fill:"#ffffff"},l10n:{stringWord0:"",stringWord1:"",stringWord2:"",stringWord3:"",stringWord4:"",stringWord5:"",stringWord6:"",stringWord7:"",stringWord8:"",stringWord9:"",stringWord10:"",stringWord11:"",stringWord12:"",stringWord13:"",stringWord14:""}},created:function(){requirejs(["sugar-web/activity/activity","sugar-web/env","activity/palettes/templatepalette"],(function(e,t,r){e.setup()}))},mounted:function(){var e=this;requirejs(["sugar-web/activity/activity","sugar-web/env"],(function(t,r){r.getEnvironment((function(n,i){r.getEnvironment((function(t,r){e.color=r.user.colorvalue,document.getElementById("canvas").style.backgroundColor=e.color.fill})),i.objectId?t.getDatastoreObject().loadAsText((function(t,r,n){if(null==t&&null!=n){var i=JSON.parse(n);e.currentLibrary=i.library,e.currentTemplate=i.library[i.template],document.getElementById("template-button").style.backgroundImage="url(icons/"+e.currentTemplate.name+".svg)",e.$refs.toolbar.$refs.templatebutton.paletteObject.getPalette().children[0].style.backgroundImage="url(icons/"+e.currentTemplate.name+".svg)"}else e.currentLibrary=defaultTemplates,e.currentTemplate=defaultTemplates[0]})):(e.currentLibrary=defaultTemplates,e.currentTemplate=defaultTemplates[0])}))})),window.addEventListener("resize",(function(){e.onResize()})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){e.unfullscreen()}))},methods:{localized:function(){var e=this;requirejs(["sugar-web/env"],(function(t){t.getEnvironment((function(t,r){var n=r.user.name,i=[],o="";for(let t=0;t<n.length;t++)e.validateText(n[t])&&(o+=n[t]);o.length&&i.push({text:o});for(let e=0;e<15;e++)i.push({text:app.$refs.localization.get("Word"+e)});defaultTemplates[2].images=i}))})),this.$refs.toolbar.localized(this.$refs.localization),this.$refs.tutorial.localized(this.$refs.localization)},displayTemplateView:function(){var e=this;e.$refs.toolbar.$refs.lines.isDisabled=!0,e.$refs.toolbar.$refs.zoombutton.isDisabled=!0,e.currentView=TemplateViewer,e.$refs.toolbar.$refs.insertimage.isDisabled=!e.$refs.view.editMode||e.currentTemplate&&"template-word"==e.currentTemplate.name,e.$refs.toolbar.$refs.inserttext.isDisabled=!e.$refs.view.editMode||e.currentTemplate&&"template-word"!=e.currentTemplate.name,document.getElementById("canvas").style.backgroundColor=e.color.fill,document.getElementById("settings-button").style.backgroundImage=e.$refs.view.editMode?"url(icons/play.svg)":"url(icons/settings.svg)"},fullscreen:function(){document.getElementById("main-toolbar").style.opacity=0,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",this.currentView===Player&&this.$refs.view.doFullscreen(!0)},unfullscreen:function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",this.currentView===Player&&this.$refs.view.doFullscreen(!1)},onTemplateSelected:function(e){for(var t=this,r=0;r<t.currentLibrary.length;r++)if(t.currentTemplate==t.currentLibrary[r]){t.currentLibrary[r]=t.currentTemplate;break}t.currentTemplate=t.currentLibrary[e.index],t.displayTemplateView()},onItemSelected:function(e,t){var r=this;if(r.currentView===TemplateViewer){if(t){for(var n=-1,i=0;i<r.currentTemplate.images.length;i++)if(r.currentTemplate.images[i]==e){n=i;break}return void r.currentTemplate.images.splice(n,1)}r.$refs.toolbar.$refs.lines.isDisabled=!1,r.$refs.toolbar.$refs.zoombutton.isDisabled=!1,r.$refs.toolbar.$refs.insertimage.isDisabled=!0,r.$refs.toolbar.$refs.inserttext.isDisabled=!0,r.currentView=Player,r.currentItem=e,document.getElementById("canvas").style.backgroundColor="#ffffff"}},nextItem:function(e){for(var t=this,r=-1,n=0;n<t.currentTemplate.images.length;n++)if(e.image&&t.currentTemplate.images[n].image==e.image||e.text&&t.currentTemplate.images[n].text==e.text){r=n;break}++r===t.currentTemplate.images.length&&(r=0);var i=t.currentTemplate.images[r];return!1===i.visible?t.nextItem(i):i},onZoom:function(e){this.currentView===Player&&this.$refs.view.doZoom(e.detail)},onSettings:function(){var e=this;e.currentView===TemplateViewer?(e.$refs.view.editMode=!e.$refs.view.editMode,e.$refs.toolbar.$refs.insertimage.isDisabled=!e.$refs.view.editMode||e.currentTemplate&&"template-word"==e.currentTemplate.name,e.$refs.toolbar.$refs.inserttext.isDisabled=!e.$refs.view.editMode||e.currentTemplate&&"template-word"!=e.currentTemplate.name,document.getElementById("settings-button").style.backgroundImage=e.$refs.view.editMode?"url(icons/play.svg)":"url(icons/settings.svg)"):e.currentView===Player?(document.getElementById("settings-button").style.backgroundImage="url(icons/play.svg)",e.currentItem.image?e.currentView=Editor:e.showTypeTextPopup(e.currentItem.text,(function(t){if(t&&t.length){e.currentItem.text=t;var r=e.$refs.view;r.initComponent((function(){r.onLoad(),r.startDemoMode()}))}document.getElementById("settings-button").style.backgroundImage="url(icons/settings.svg)"}))):(e.currentView=Player,document.getElementById("settings-button").style.backgroundImage="url(icons/settings.svg)")},onInsertImage:function(){var e=this;e.currentView===TemplateViewer&&e.$refs.view.editMode&&requirejs(["sugar-web/datastore","sugar-web/graphics/journalchooser"],(function(t,r){setTimeout((function(){r.show((function(r){r&&new t.DatastoreObject(r.objectId).loadAsText((function(t,r,n){e.currentTemplate.images.push({image:n})}))}),{mimetype:"image/png"},{mimetype:"image/jpeg"})}),0)}))},onInsertText:function(){var e=this;e.showTypeTextPopup(e.$refs.localization.get("TextDefault"),(function(t){t&&t.length&&e.currentTemplate.images.push({text:t})}))},onLines:function(){var e=this;e.$refs.toolbar.$refs.lines.isActive=!e.$refs.toolbar.$refs.lines.isActive,e.currentView===Player&&e.$refs.view.draw()},onResize:function(){this.currentView===Player&&this.$refs.view.computeSize()},onHelp:function(){var e=this,t={};t.currentView=e.currentView,t.editMode=e.$refs.view.editMode||e.currentView===Editor,t.templatebutton=e.$refs.toolbar.$refs.templatebutton.$el,t.fullscreenbutton=e.$refs.toolbar.$refs.fullscreen.$el,t.settingsbutton=e.$refs.toolbar.$refs.settings.$el,e.currentView===TemplateViewer?(t.insertimagebutton="template-word"!=e.currentTemplate.name?e.$refs.toolbar.$refs.insertimage.$el:e.$refs.toolbar.$refs.inserttext.$el,e.currentTemplate&&e.currentTemplate.images&&e.currentTemplate.images[0]&&(t.item=e.$refs.view.$refs.item0[0].$el)):(t.linesbutton=e.$refs.toolbar.$refs.lines.$el,t.zoombutton=e.$refs.toolbar.$refs.zoombutton.$el,t.backbutton=document.getElementById("back"),t.restartbutton=document.getElementById("player-restart"),t.nextbutton=document.getElementById("player-next-letter"),t.editoraddbutton=document.getElementById("editor-add"),t.editorremovebutton=document.getElementById("editor-remove"),t.editoraddpathbutton=document.getElementById("editor-addpath"),t.editorremovepathbutton=document.getElementById("editor-removepath")),this.$refs.tutorial.show(t)},onStop:function(){var e=this;requirejs(["sugar-web/activity/activity"],(function(t){console.log("writing..."),requirejs(["sugar-web/activity/activity"],(function(t){console.log("writing...");for(var r=0;r<e.currentLibrary.length;r++)if(e.currentTemplate==e.currentLibrary[r]){e.currentLibrary[r]=e.currentTemplate;break}var n={library:e.currentLibrary,template:r},i=JSON.stringify(n);t.getDatastoreObject().setDataAsText(i),t.getDatastoreObject().save((function(e){null===e?console.log("write done."):console.log("write failed.")}))}))}))},showTypeTextPopup:function(e,t){var r=this.$refs.localization.get("Ok"),n=this.$refs.localization.get("Cancel"),i=this.$refs.localization.get("TextTitle");this.$refs.inserttextpopup.show({data:{defaultText:e,callback:t},content:"\n\t\t\t\t\t<div id='popup-toolbar' class='toolbar' style='padding: 0'>\n\t\t\t\t\t\t<button class='toolbutton pull-right' id='popup-ok-button' title='"+r+"' style='outline:none;background-image: url(lib/sugar-web/graphics/icons/actions/dialog-ok.svg)'></button>\n\t\t\t\t\t\t<button class='toolbutton pull-right' id='popup-cancel-button' title='"+n+"' style='outline:none;background-image: url(lib/sugar-web/graphics/icons/actions/dialog-cancel.svg)'></button>\n\t\t\t\t\t\t<div style='position: absolute; top: 20px; left: 60px;'>"+i+"</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div id='popup-container' style='width: 100%; overflow:auto'>\n\t\t\t\t\t\t<input id='newitem-text' class='popup-input'/>\n\t\t\t\t\t</div>",closeButton:!1,modalStyles:{backgroundColor:"white",height:"170px",width:"420px",maxWidth:"90%"}})},insertPopupShown:function(){var e=this;document.getElementById("popup-ok-button").addEventListener("click",(function(){e.$refs.inserttextpopup.close(!0)})),document.getElementById("popup-cancel-button").addEventListener("click",(function(){e.$refs.inserttextpopup.close()}));let t=document.getElementById("newitem-text");t.value=e.$refs.inserttextpopup.data.defaultText,t.setSelectionRange(0,t.value.length),t.focus();var r,n;r=t,n=function(t){return e.validateText(t)},["input","keydown","keyup","mousedown","mouseup","select","contextmenu","drop"].forEach((function(e){r.addEventListener(e,(function(){n(this.value)?(this.oldValue=this.value,this.oldSelectionStart=this.selectionStart,this.oldSelectionEnd=this.selectionEnd):this.hasOwnProperty("oldValue")?(this.value=this.oldValue,this.setSelectionRange(this.oldSelectionStart,this.oldSelectionEnd)):this.value=""}))}))},insertPopupClosed:function(e){e?this.$refs.inserttextpopup.data.callback(document.getElementById("newitem-text").value):this.$refs.inserttextpopup.data.callback(null),this.$refs.inserttextpopup.destroy()},validateText:function(e){return/^[A-Za-z]*$/.test(e)}}});