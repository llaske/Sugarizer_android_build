!function(t){"use strict";t.widget("aerolab.blockrain",{options:{autoplay:!1,autoplayRestart:!0,showFieldOnStart:!0,theme:null,blockWidth:10,autoBlockWidth:!1,autoBlockSize:24,difficulty:"normal",speed:20,asdwKeys:!0,highestScore:0,playButtonText:"Play",gameOverText:"Game Over",restartButtonText:"Play Again",scoreText:"Score",highscoreText:"High Score",onStart:function(){},onRestart:function(){},onGameOver:function(t){},onPlaced:function(){},onLine:function(t,e,o){}},start:function(){this._board.started||(this._doStart(),this.options.onStart.call(this.element))},restart:function(){this.options.onRestart.call(this.element),this._doStart()},gameover:function(){this.showGameOverMessage(),this._board.gameover=!0,this.options.onGameOver.call(this.element,this._filled.score)},_doStart:function(){this._filled.clearAll(),this._filled._resetScore(),this._filled._showHighScore(),this._board.cur=this._board.nextShape(),this._board.started=!0,this._board.gameover=!1,this._board.dropDelay=5,this._board.render(!0),this._board.animate(),this._$start.fadeOut(150),this._$gameover.fadeOut(150),this._$score.fadeIn(150),this._$highscore.fadeIn(150)},pause:function(){this._board.paused=!0,this._unbindButtons()},resume:function(){this._board.paused&&this._setupTouchControls(!1),this._board.paused=!1},autoplay:function(t){"boolean"!=typeof t&&(t=!0),this.options.autoplay=t,t&&!this._board.started&&this._doStart(),this._setupControls(!t),this._setupTouchControls(!t)},controls:function(t){"boolean"!=typeof t&&(t=!0),this._setupControls(t)},touchControls:function(t){"boolean"!=typeof t&&(t=!0),this._setupTouchControls(t)},score:function(t){return void 0!==t&&parseInt(t)>=0&&(this._filled.score=parseInt(t),this._$scoreText.text(this._filled_score)),this._filled.score},highscore:function(){return this._filled.highscore=parseInt(game.options.highestScore),this._$highscoreText.text(this._filled_highscore),this._filled.highscore},freesquares:function(){return this._filled.getFreeSpaces()},showStartMessage:function(){this._$start.show()},showGameOverMessage:function(){this._$gameover.show()},updateSizes:function(){this._PIXEL_WIDTH=this.element.innerWidth(),this._PIXEL_HEIGHT=this.element.innerHeight(),this._BLOCK_WIDTH=this.options.blockWidth,this._BLOCK_HEIGHT=Math.floor(this.element.innerHeight()/this.element.innerWidth()*this._BLOCK_WIDTH),this._block_size=Math.floor(this._PIXEL_WIDTH/this._BLOCK_WIDTH),this._border_width=2,this._PIXEL_WIDTH=this._block_size*this._BLOCK_WIDTH,this._PIXEL_HEIGHT=this._block_size*this._BLOCK_HEIGHT,this._$canvas.attr("width",this._PIXEL_WIDTH).attr("height",this._PIXEL_HEIGHT)},theme:function(e){if(void 0===e)return this.options.theme||this._theme;"string"==typeof e?(this.options.theme=e,this._theme=t.extend(!0,{},BlockrainThemes[e])):(this.options.theme=null,this._theme=e),void 0!==this._theme&&null!==this._theme||(this._theme=t.extend(!0,{},BlockrainThemes.retro),this.options.theme="retro"),(isNaN(parseInt(this._theme.strokeWidth))||"number"!=typeof parseInt(this._theme.strokeWidth))&&(this._theme.strokeWidth=2),this._preloadThemeAssets(),null!==this._board&&("string"==typeof this._theme.background&&this._$canvas.css("background-color",this._theme.background),this._board.render())},_theme:{},_$game:null,_$canvas:null,_$gameholder:null,_$start:null,_$gameover:null,_$score:null,_$scoreText:null,_$highscore:null,_$highscoreText:null,_canvas:null,_ctx:null,_create:function(){var e=this;this.theme(this.options.theme),this._createHolder(),this._createUI(),this._refreshBlockSizes(),this.updateSizes(),t(window).resize((function(){})),this._SetupShapeFactory(),this._SetupFilled(),this._SetupInfo(),this._SetupBoard(),this._info.init(),this._board.init();var renderLoop=function(){requestAnimationFrame(renderLoop),e._board.render()};renderLoop(),this.options.autoplay?(this.autoplay(!0),this._setupTouchControls(!1)):(this._setupControls(!0),this._setupTouchControls(!1))},_checkCollisions:function(t,e,o,i){for(var r,n,s=0,a=o.length;s<a;s+=2){if(r=t+o[s],(n=e+o[s+1])>=this._BLOCK_HEIGHT||this._filled.check(r,n))return!0;if(!i&&r<0||r>=this._BLOCK_WIDTH)return!0}return!1},_board:null,_info:null,_filled:null,_drawBackground:function(){if("string"==typeof this._theme.background){if(this._theme.backgroundGrid instanceof Image){if(0===this._theme.backgroundGrid.width||0===this._theme.backgroundGrid.height)return;this._ctx.globalAlpha=1;for(var t=0;t<this._BLOCK_WIDTH;t++)for(var e=0;e<this._BLOCK_HEIGHT;e++){var o=t*this._block_size,i=e*this._block_size;this._ctx.drawImage(this._theme.backgroundGrid,0,0,this._theme.backgroundGrid.width,this._theme.backgroundGrid.height,o,i,this._block_size,this._block_size)}}else if("string"==typeof this._theme.backgroundGrid){var r=this._theme.strokeWidth;Math.round(.23*this._block_size),Math.round(.3*this._block_size);this._ctx.globalAlpha=1,this._ctx.fillStyle=this._theme.backgroundGrid;for(t=0;t<this._BLOCK_WIDTH;t++)for(e=0;e<this._BLOCK_HEIGHT;e++){o=t*this._block_size,i=e*this._block_size;this._ctx.fillRect(o+r,i+r,this._block_size-2*r,this._block_size-2*r)}}this._ctx.globalAlpha=1}},_shapeFactory:null,_shapes:{line:[[0,-1,0,-2,0,-3,0,-4],[2,-2,1,-2,0,-2,-1,-2],[0,-4,0,-3,0,-2,0,-1],[-1,-2,0,-2,1,-2,2,-2]],square:[[0,0,1,0,0,-1,1,-1],[1,0,1,-1,0,0,0,-1],[1,-1,0,-1,1,0,0,0],[0,-1,0,0,1,-1,1,0]],arrow:[[0,-1,1,-1,2,-1,1,-2],[1,0,1,-1,1,-2,0,-1],[2,-1,1,-1,0,-1,1,0],[1,-2,1,-1,1,0,2,-1]],rightHook:[[2,0,1,0,1,-1,1,-2],[2,-2,2,-1,1,-1,0,-1],[0,-2,1,-2,1,-1,1,0],[0,0,0,-1,1,-1,2,-1]],leftHook:[[0,0,1,0,1,-1,1,-2],[2,0,2,-1,1,-1,0,-1],[2,-2,1,-2,1,-1,1,0],[0,-2,0,-1,1,-1,2,-1]],leftZag:[[0,0,0,-1,1,-1,1,-2],[2,-1,1,-1,1,-2,0,-2],[1,-2,1,-1,0,-1,0,0],[0,-2,1,-2,1,-1,2,-1]],rightZag:[[1,0,1,-1,0,-1,0,-2],[2,-1,1,-1,1,0,0,0],[0,-2,0,-1,1,-1,1,0],[0,0,1,0,1,-1,2,-1]]},_SetupShapeFactory:function(){var e=this;function Shape(e,o,i,r){return t.extend(this,{x:0,y:0,symmetrical:i,init:function(){return t.extend(this,{orientation:0,x:Math.floor(e._BLOCK_WIDTH/2)-1,y:-1}),this},blockType:r,blockVariation:null,blocksLen:o[0].length,orientations:o,orientation:0,rotate:function(t){var o=(this.orientation+("left"===t?1:-1)+4)%4;e._checkCollisions(this.x,this.y,this.getBlocks(o))||(this.orientation=o,e._board.renderChanged=!0)},moveRight:function(){e._checkCollisions(this.x+1,this.y,this.getBlocks())||(this.x++,e._board.renderChanged=!0)},moveLeft:function(){e._checkCollisions(this.x-1,this.y,this.getBlocks())||(this.x--,e._board.renderChanged=!0)},drop:function(){e._checkCollisions(this.x,this.y+1,this.getBlocks())||(this.y++,e._board.dropCount=-1,e._board.animate(),e._board.renderChanged=!0)},getBlocks:function(t){return this.orientations[void 0!==t?t:this.orientation]},draw:function(t,o,i){for(var r=this.getBlocks(i),n=void 0===t?this.x:t,s=void 0===o?this.y:o,a=0,h=0;a<this.blocksLen;a+=2)e._board.drawBlock(n+r[a],s+r[a+1],this.blockType,this.blockVariation,h,this.orientation,!0),h++},getBounds:function(e){for(var o=t.isArray(e)?e:this.getBlocks(e),i=0,r=o.length,n=999,s=-999,a=999,h=-999;i<r;i+=2)o[i]<n&&(n=o[i]),o[i]>s&&(s=o[i]),o[i+1]<a&&(a=o[i+1]),o[i+1]>h&&(h=o[i+1]);return{left:n,right:s,top:a,bottom:h,width:s-n,height:h-a}}}),this.init()}null===this._shapeFactory&&(this._shapeFactory={line:function(){return new Shape(e,e._shapes.line,!1,"line")},square:function(){return new Shape(e,e._shapes.square,!1,"square")},arrow:function(){return new Shape(e,e._shapes.arrow,!1,"arrow")},leftHook:function(){return new Shape(e,e._shapes.leftHook,!1,"leftHook")},rightHook:function(){return new Shape(e,e._shapes.rightHook,!1,"rightHook")},leftZag:function(){return new Shape(e,e._shapes.leftZag,!1,"leftZag")},rightZag:function(){return new Shape(e,e._shapes.rightZag,!1,"rightZag")}})},_SetupFilled:function(){var t=this;null===this._filled&&(this._filled={data:new Array(t._BLOCK_WIDTH*t._BLOCK_HEIGHT),score:0,highscore:t.options.highestScore,toClear:{},check:function(t,e){return this.data[this.asIndex(t,e)]},add:function(e,o,i,r,n,s){e>=0&&e<t._BLOCK_WIDTH&&o>=0&&o<t._BLOCK_HEIGHT&&(this.data[this.asIndex(e,o)]={blockType:i,blockVariation:r,blockIndex:n,blockOrientation:s})},getFreeSpaces:function(){for(var t=0;t<this.data.length;t++)this.data[t]?1:0},asIndex:function(e,o){return e+o*t._BLOCK_WIDTH},asX:function(e){return e%t._BLOCK_WIDTH},asY:function(e){return Math.floor(e/t._BLOCK_WIDTH)},clearAll:function(){delete this.data,this.data=new Array(t._BLOCK_WIDTH*t._BLOCK_HEIGHT)},_popRow:function(e){for(var o=t._BLOCK_WIDTH*(e+1)-1;o>=0;o--)this.data[o]=o>=t._BLOCK_WIDTH?this.data[o-t._BLOCK_WIDTH]:void 0},checkForClears:function(){var e,o,i,r,n=t._board.lines,s=[];for(e=0,o=this.data.length;e<o;e++)0==(r=this.asX(e))&&(i=0),this.data[e]&&void 0!==this.data[e]&&"string"==typeof this.data[e].blockType&&(i+=1),r==t._BLOCK_WIDTH-1&&i==t._BLOCK_WIDTH&&s.push(this.asY(e));for(e=0,o=s.length;e<o;e++)this._popRow(s[e]),t._board.lines++,t._board.lines%10==0&&t._board.dropDelay>1&&(t._board.dropDelay*=.9);var a=t._board.lines-n;this._updateScore(a),this.score>this.highscore&&this._updateHighScore()},_updateScore:function(e){if(!(e<=0)){var o=[0,400,1e3,3e3,12e3];e>=o.length&&(e=o.length-1),this.score+=o[e],t._$scoreText.text(this.score),t.options.onLine.call(t.element,e,o[e],this.score)}},_resetScore:function(){this.score=0,t._$scoreText.text(this.score)},_showHighScore:function(){t._$highscoreText.text(this.highscore)},_updateHighScore:function(){this.highscore=this.score,t._$highscoreText.text(this.highscore)},draw:function(){for(var e,o=0,i=this.data.length;o<i;o++)if(void 0!==this.data[o]){e=this.asY(o);var r=this.data[o];t._board.drawBlock(this.asX(o),e,r.blockType,r.blockVariation,r.blockIndex,r.blockOrientation)}}})},_SetupInfo:function(){var t=this;this._info={mode:t.options.difficulty,modes:["normal","nice","evil"],modesY:170,autopilotY:null,init:function(){this.mode=t.options.difficulty},setMode:function(e){this.mode=e,t._board.nextShape(!0)}}},_SetupBoard:function(){var e=this,o=this._info;this._board={animateDelay:1e3/e.options.speed,animateTimeoutId:null,cur:null,lines:0,dropCount:0,dropDelay:5,holding:{left:null,right:null,drop:null},holdingThreshold:200,started:!1,gameover:!1,renderChanged:!0,init:function(){this.cur=this.nextShape(),e.options.showFieldOnStart&&(e._drawBackground(),e._board.createRandomBoard(),e._board.render()),this.showStartMessage()},showStartMessage:function(){e._$start.show()},showGameOverMessage:function(){e._$gameover.show()},nextShape:function(i){var r,n,s,a=this.next;if(r="nice"==o.mode||"evil"==o.mode?e._niceShapes:e._randomShapes(),e.options.no_preview){if(this.next=null,i)return null;if(!(n=r(e._filled,e._checkCollisions,e._BLOCK_WIDTH,e._BLOCK_HEIGHT,o.mode)))throw new Error("No shape returned from shape function!",r);n.init(),s=n}else{if(!(n=r(e._filled,e._checkCollisions,e._BLOCK_WIDTH,e._BLOCK_HEIGHT,o.mode)))throw new Error("No shape returned from shape function!",r);if(n.init(),this.next=n,i)return null;s=a||this.nextShape()}return e.options.autoplay&&(e._niceShapes(e._filled,e._checkCollisions,e._BLOCK_WIDTH,e._BLOCK_HEIGHT,"normal",s),s.orientation=s.best_orientation,s.x=s.best_x),void 0!==e._theme.complexBlocks?t.isArray(e._theme.complexBlocks[s.blockType])?s.blockVariation=e._randInt(0,e._theme.complexBlocks[s.blockType].length-1):s.blockVariation=null:void 0!==e._theme.blocks&&(t.isArray(e._theme.blocks[s.blockType])?s.blockVariation=e._randInt(0,e._theme.blocks[s.blockType].length-1):s.blockVariation=null),s},animate:function(){var t=!1,o=!1,i=!1,r=Date.now();if(this.animateTimeoutId&&clearTimeout(this.animateTimeoutId),!this.paused&&!this.gameover&&(this.dropCount++,(this.dropCount>=this.dropDelay||e.options.autoplay||this.holding.drop&&r-this.holding.drop>=this.holdingThreshold)&&(t=!0,o=!0,this.dropCount=0),this.holding.left&&r-this.holding.left>=this.holdingThreshold&&(o=!0,this.cur.moveLeft()),this.holding.right&&r-this.holding.right>=this.holdingThreshold&&(o=!0,this.cur.moveRight()),t)){var n=this.cur,s=n.x,a=n.y,h=n.getBlocks();if(e._checkCollisions(s,a+1,h,!0)){t=!1;for(var l=0,c=(i=!1,0);c<n.blocksLen;c+=2){var _=s+h[c],d=a+h[c+1];d<=0&&(i=!0),e._filled.add(_,d,n.blockType,n.blockVariation,l,n.orientation),l++}e._filled.checkForClears(),this.cur=this.nextShape(),this.renderChanged=!0,this.holding.left=null,this.holding.right=null,this.holding.drop=null,e.options.onPlaced.call(e.element),i&&e.gameover()}}t&&(o=!0,this.cur.y++),(t||o)&&(this.renderChanged=!0),i?(this.gameover=!0,e.gameover(),e.options.autoplay&&e.options.autoplayRestart&&e.restart(),this.renderChanged=!0):(this.animateDelay=1e3/e.options.speed,this.animateTimeoutId=window.setTimeout((function(){e._board.animate()}),this.animateDelay))},createRandomBoard:function(){var t,o,i,r,n,s;for(t=Object.keys(e._shapeFactory),o=0,i=e._BLOCK_WIDTH;o<i;o++)for(r=0,n=e._randChoice([e._randInt(0,8),e._randInt(5,9)]);r<n;r++)s&&e._randInt(0,3)||(s=e._randChoice(t)),e._filled.add(o,e._BLOCK_HEIGHT-r,s,e._randInt(0,3),null,e._randInt(0,3));e._board.render(!0)},render:function(t){(this.renderChanged||t)&&(this.renderChanged=!1,e._ctx.clearRect(0,0,e._PIXEL_WIDTH,e._PIXEL_HEIGHT),e._drawBackground(),e._filled.draw(),this.cur.draw())},drawBlock:function(t,o,i,r,n,s,a){t*=e._block_size,o*=e._block_size,a="boolean"==typeof a&&a;var h=e._theme.strokeWidth,l=Math.round(.23*e._block_size),c=Math.round(.3*e._block_size),_=this.getBlockColor(i,r,n,a);if(e._ctx.globalAlpha=1,_ instanceof Image){if(e._ctx.globalAlpha=1,0===_.width||0===_.height)return;if(void 0!==e._theme.blocks&&null!==e._theme.blocks)e._ctx.drawImage(_,0,0,_.width,_.height,t,o,e._block_size,e._block_size);else if(void 0!==e._theme.complexBlocks&&null!==e._theme.complexBlocks){null==n&&(n=0);var d=function(t,o,i){var r=e._shapes[o][0],n=Math.min(r[0],r[2],r[4],r[6]),s=Math.max(r[0],r[2],r[4],r[6]),a=Math.min(r[1],r[3],r[5],r[7]),h=s-n+1,l=Math.max(r[1],r[3],r[5],r[7])-a+1,c=t.width/h,_=t.height/l;return{x:c*(r[2*i]-n),y:_*Math.abs(a-r[2*i+1]),w:c,h:_}}(_,i,n);e._ctx.save(),e._ctx.translate(t,o),e._ctx.translate(e._block_size/2,e._block_size/2),e._ctx.rotate(-Math.PI/2*s),e._ctx.drawImage(_,d.x,d.y,d.w,d.h,-e._block_size/2,-e._block_size/2,e._block_size,e._block_size),e._ctx.restore()}else e._ctx.fillStyle="#ff0000",e._ctx.fillRect(t,o,e._block_size,e._block_size)}else"string"==typeof _&&(e._ctx.fillStyle=_,e._ctx.fillRect(t,o,e._block_size,e._block_size),"string"==typeof e._theme.innerShadow&&(e._ctx.globalAlpha=1,e._ctx.strokeStyle=e._theme.innerShadow,e._ctx.lineWidth=1,e._ctx.strokeRect(t+1,o+1,e._block_size-2,e._block_size-2)),"string"==typeof e._theme.stroke&&(e._ctx.globalAlpha=1,e._ctx.fillStyle=e._theme.stroke,e._ctx.strokeStyle=e._theme.stroke,e._ctx.lineWidth=h,e._ctx.strokeRect(t,o,e._block_size,e._block_size)),"string"==typeof e._theme.innerStroke&&(e._ctx.fillStyle=e._theme.innerStroke,e._ctx.fillRect(t+l,o+l,e._block_size-2*l,h),e._ctx.fillRect(t+l,o+l+h,h,e._block_size-2*l-h)),"string"==typeof e._theme.innerSquare&&(e._ctx.fillStyle=e._theme.innerSquare,e._ctx.globalAlpha=.2,e._ctx.fillRect(t+c,o+c,e._block_size-2*c,e._block_size-2*c)));e._ctx.globalAlpha=1},getBlockColor:function(o,i,r,n){var getBlockVariation=function(e,o){return t.isArray(e)?null!==o&&void 0!==e[o]?e[o]:e.length>0?e[0]:null:e};return"boolean"!=typeof n&&(n=!0),n?"string"==typeof e._theme.primary&&""!==e._theme.primary?e._theme.primary:void 0!==e._theme.blocks&&null!==e._theme.blocks?getBlockVariation(e._theme.blocks[o],i):getBlockVariation(e._theme.complexBlocks[o],i):"string"==typeof e._theme.secondary&&""!==e._theme.secondary?e._theme.secondary:void 0!==e._theme.blocks&&null!==e._theme.blocks?getBlockVariation(e._theme.blocks[o],i):getBlockVariation(e._theme.complexBlocks[o],i)}},e._niceShapes=e._getNiceShapes()},_randInt:function(t,e){return t+Math.floor(Math.random()*(1+e-t))},_randSign:function(){return 2*this._randInt(0,1)-1},_randChoice:function(t){return t[this._randInt(0,t.length-1)]},_preloadThemeAssets:function(){var e=this,o=new RegExp("^#[A-F0-9+]{3,6}","i"),i=(new RegExp("^data:image/(png|gif|jpg);base64,","i"),function(){e._board&&e._board.render(!0)}),loadAsset=function(t){var e=t;return o.test(e)?t=e:((t=new Image).src=e,t.onload=i),t},startAssetLoad=function(e){if(t.isArray(e)&&e.length>0)for(var o=0;o<e.length;o++)e[o]=loadAsset(e[o]);else"string"==typeof e&&(e=loadAsset(e));return e};if(void 0!==this._theme.complexBlocks)for(var r=Object.keys(this._theme.complexBlocks),n=0;n<r.length;n++)this._theme.complexBlocks[r[n]]=startAssetLoad(this._theme.complexBlocks[r[n]]);else if(void 0!==this._theme.blocks)for(r=Object.keys(this._theme.blocks),n=0;n<r.length;n++)this._theme.blocks[r[n]]=startAssetLoad(this._theme.blocks[r[n]]);if(void 0!==this._theme.backgroundGrid&&"string"==typeof this._theme.backgroundGrid&&!o.test(this._theme.backgroundGrid)){var s=this._theme.backgroundGrid;this._theme.backgroundGrid=new Image,this._theme.backgroundGrid.src=s,this._theme.backgroundGrid.onload=i}},_createHolder:function(){this._$gameholder=t('<div class="blockrain-game-holder"></div>'),this._$gameholder.css("position","relative").css("width","100%").css("height","100%"),this.element.html("").append(this._$gameholder),this._$canvas=t('<canvas style="display:block; width:100%; height:100%; padding:0; margin:0; border:none;" />'),"string"==typeof this._theme.background&&this._$canvas.css("background-color",this._theme.background),this._$gameholder.append(this._$canvas),this._canvas=this._$canvas.get(0),this._ctx=this._canvas.getContext("2d")},_createUI:function(){var e=this;e._$score=t('<div class="blockrain-score-holder" style="position:absolute;"><div class="blockrain-score"><div class="blockrain-score-msg">'+this.options.scoreText+'</div><div class="blockrain-score-num">0</div></div></div>').hide(),e._$scoreText=e._$score.find(".blockrain-score-num"),e._$gameholder.append(e._$score),e._$highscore=t('<div class="blockrain-Hscore-holder" style="position:absolute;"><div class="blockrain-Hscore"><div class="blockrain-Hscore-msg">'+this.options.highscoreText+'</div><div class="blockrain-Hscore-num">0</div></div></div>').hide(),e._$highscoreText=e._$highscore.find(".blockrain-Hscore-num"),e._$gameholder.append(e._$highscore),e._$start=t('<div class="blockrain-start-holder" style="position:absolute;"><div class="blockrain-start"><a class="blockrain-btn blockrain-start-btn">'+this.options.playButtonText+"</a></div></div>").hide(),e._$gameholder.append(e._$start),e._$start.find(".blockrain-start-btn").click((function(t){t.preventDefault(),e.start()})),e._$gameover=t('<div class="blockrain-game-over-holder" style="position:absolute;"><div class="blockrain-game-over"><div class="blockrain-game-over-msg">'+this.options.gameOverText+'</div><a class="blockrain-btn blockrain-game-over-btn">'+this.options.restartButtonText+"</a></div></div>").hide(),e._$gameover.find(".blockrain-game-over-btn").click((function(t){t.preventDefault(),e.restart()})),e._$gameholder.append(e._$gameover),this._createControls()},_createControls:function(){var e=this;e._$touchLeft=t('<a class="blockrain-touch blockrain-touch-left" />').appendTo(e._$gameholder),e._$touchRight=t('<a class="blockrain-touch blockrain-touch-right" />').appendTo(e._$gameholder),e._$touchRotateRight=t('<a class="blockrain-touch blockrain-touch-rotate-right" />').appendTo(e._$gameholder),e._$touchRotateLeft=t('<a class="blockrain-touch blockrain-touch-rotate-left" />').appendTo(e._$gameholder),e._$touchDrop=t('<a class="blockrain-touch blockrain-touch-drop" />').appendTo(e._$gameholder)},_refreshBlockSizes:function(){this.options.autoBlockWidth&&(this.options.blockWidth=Math.ceil(this.element.width()/this.options.autoBlockSize))},_getNiceShapes:function(){var t=this,e={};for(var o in this._shapeFactory)e[o]=this._shapeFactory[o]();function scoreBlocks(e,o,i,r,n,s,a){var h,l,c,_,d=o.length,u=0,f={};for(h=0;h<d;h+=2)u+=e[t._filled.asIndex(i+o[h],r+o[h+1])]||0;for(h=0;h<d;h+=2)l=o[h],c=o[h+1],(void 0===f[l]||f[l]<c)&&(f[l]=c);for(l in _=0,f)for(c=f[l=parseInt(l)]+1,h=0;r+c<a;c++,h++)if(!t._filled.check(i+l,r+c)){_+=0==h?2:1;break}return u-=_}var func=function(o,i,r,n,s,a){a||function resetShapes(){for(var t in e)e[t].x=0,e[t].y=-1}();var h,l,c,_,d,u,f,b,p,g,k,m,v,y,x,w=new Array(r*n),T="evil"==s,I=999*(T?1:-1);for(h=0;h<r;h++)for(l=0;l<=n;l++)if(l==n||o.check(h,l)){for(c=l-4;c<l;c++)w[o.asIndex(h,c)]=c;break}var C=void 0===a?e:{cur:a};for(_ in C){for(d=C[_],v=-999,u=0;u<(d.symmetrical?2:4);u++)for(f=d.getBlocks(u),h=-(b=d.getBounds(f)).left;h<r-b.width;h++)for(l=-1;l<n-b.bottom;l++)if(t._checkCollisions(h,l+1,f,!0)){(p=scoreBlocks(w,f,h,l,0,0,n))>v&&(v=p,y=u,x=h);break}(T&&v<I||!T&&v>I)&&(g=d,I=v,k=y,m=x)}return g.best_orientation=k,g.best_x=m,g};return func.no_preview=!0,func},_randomShapes:function(){var e=[];return t.each(this._shapeFactory,(function(t,o){e.push(o)})),this._randChoice(e)},_setupControls:function(e){var o=this,moveLeft=function(t){t?o._board.holding.left||(o._board.cur.moveLeft(),o._board.holding.left=Date.now(),o._board.holding.right=null):o._board.holding.left=null},moveRight=function(t){t?o._board.holding.right||(o._board.cur.moveRight(),o._board.holding.right=Date.now(),o._board.holding.left=null):o._board.holding.right=null},drop=function(t){t?o._board.holding.drop||(o._board.cur.drop(),o._board.holding.drop=Date.now()):o._board.holding.drop=null},handleKeyDown=function(t){if(!o._board.cur)return!0;var e=!1;if(e=!0,o.options.asdwKeys)switch(t.keyCode){case 65:moveLeft(!0),o.start();break;case 68:moveRight(!0),o.start();break;case 83:drop(!0),o.start();break;case 87:o._board.cur.rotate("right"),o.start()}switch(t.keyCode){case 37:moveLeft(!0),o.start();break;case 39:moveRight(!0),o.start();break;case 40:drop(!0),o.start();break;case 38:case 88:o._board.cur.rotate("right"),o.start();break;case 90:o._board.cur.rotate("left"),o.start();break;default:e=!1}return e&&t.preventDefault(),!e},handleKeyUp=function(t){if(!o._board.cur)return!0;var e=!1;if(e=!0,o.options.asdwKeys)switch(t.keyCode){case 65:moveLeft(!1),o.start();break;case 68:moveRight(!1),o.start();break;case 83:drop(!1),o.start()}switch(t.keyCode){case 37:moveLeft(!1),o.start();break;case 39:moveRight(!1),o.start();break;case 40:drop(!1),o.start();break;default:e=!1}return e&&t.preventDefault(),!e};function getKey(t){return"safekeypress."+t.keyCode}t(document).unbind("keydown.blockrain").unbind("keyup.blockrain"),o.options.autoplay||e&&t(document).bind("keydown.blockrain",(function keydown(e){var o=getKey(e);return t.data(this,o,(t.data(this,o)||0)-1),handleKeyDown.call(this,e)})).bind("keyup.blockrain",(function keyup(e){return t.data(this,getKey(e),0),handleKeyUp.call(this,e),function isStopKey(t){var e={stopKeys:{37:1,38:1,39:1,40:1}},o=e.stopKeys[t.keyCode]||e.moreStopKeys&&e.moreStopKeys[t.keyCode];return o&&t.preventDefault(),o}(e)}))},_setupTouchControls:function(e){var o=this,moveLeft=function(t){t.preventDefault(),o._board.cur.moveLeft(),o._board.holding.left=Date.now(),o._board.holding.right=null,o._board.holding.drop=null},moveRight=function(t){t.preventDefault(),o._board.cur.moveRight(),o._board.holding.right=Date.now(),o._board.holding.left=null,o._board.holding.drop=null},drop=function(t){t.preventDefault(),o._board.cur.drop(),o._board.holding.drop=Date.now()},endMoveLeft=function(t){t.preventDefault(),o._board.holding.left=null},endMoveRight=function(t){t.preventDefault(),o._board.holding.right=null},endDrop=function(t){t.preventDefault(),o._board.holding.drop=null},rotateRight=function(t){t.preventDefault(),o._board.cur.rotate("right")};o._$touchLeft.unbind("touchstart touchend click"),o._$touchRight.unbind("touchstart touchend click"),o._$touchRotateLeft.unbind("touchstart touchend click"),o._$touchRotateRight.unbind("touchstart touchend click"),o._$touchDrop.unbind("touchstart touchend click"),!o.options.autoplay&&e?(o._$touchLeft.show().bind("touchstart click",moveLeft).bind("touchend",endMoveLeft),o._$touchRight.show().bind("touchstart click",moveRight).bind("touchend",endMoveRight),o._$touchDrop.show().bind("touchstart click",drop).bind("touchend",endDrop),o._$touchRotateLeft.show().bind("touchstart click",(function(t){t.preventDefault(),o._board.cur.rotate("left")})),o._$touchRotateRight.show().bind("touchstart click",rotateRight)):(o._$touchLeft.hide(),o._$touchRight.hide(),o._$touchRotateLeft.hide(),o._$touchRotateRight.hide(),o._$touchDrop.hide()),t("#left-arrow").bind("touchstart click",(function(t){moveLeft(t),endMoveLeft(t)})),t("#right-arrow").bind("touchstart click",(function(t){moveRight(t),endMoveRight(t)})),t("#up-arrow").bind("touchstart click",rotateRight),t("#down-arrow").bind("touchstart click",(function(t){o.start(),drop(t),endDrop(t)}))},_unbindButtons:function(){t("#left-arrow").unbind("touchstart click"),t("#right-arrow").unbind("touchstart click"),t("#up-arrow").unbind("touchstart click"),t("#down-arrow").unbind("touchstart click")}})}(jQuery);