/*!
 Based on ndef.parser, by Raphael Graf(r@undefined.ch)
 http://www.undefined.ch/mparser/index.html

 Ported to JavaScript and modified by Matthew Crumley (email@matthewcrumley.com, http://silentmatt.com/)

 You are free to use and modify this code in anyway you find useful. Please leave this comment in the code
 to acknowledge its original source. If you feel like it, I enjoy hearing about projects that use my code,
 but don't feel like you have to let me know or ask permission.
*/
Array.indexOf||(Array.prototype.indexOf=function(t,s){for(var e=s||0;e<this.length;e++)if(this[e]===t)return e;return-1});var Parser=function(t){function object(t){function F(){}return F.prototype=t,new F}var s=0,e=1,i=2,n=3,r=4;function Token(t,o,h,a){this.type_=t,this.index_=o||0,this.prio_=h||0,this.number_=null!=a?a:0,this.toString=function(){switch(this.type_){case s:return this.number_;case e:case i:case n:return this.index_;case r:return"CALL";default:return"Invalid Token"}}}function Expression(t,s,e,i){this.tokens=t,this.ops1=s,this.ops2=e,this.functions=i}var o=/[\\\'\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,h={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","'":"\\'","\\":"\\\\"};function add(t,s){return Number(t)+Number(s)}function sub(t,s){return t-s}function mul(t,s){return t*s}function div(t,s){return t/s}function mod(t,s){return t%s}function concat(t,s){return""+t+s}function sinh(t){return Math.sinh?Math.sinh(t):(Math.exp(t)-Math.exp(-t))/2}function cosh(t){return Math.cosh?Math.cosh(t):(Math.exp(t)+Math.exp(-t))/2}function tanh(t){return Math.tanh?Math.tanh(t):t===1/0?1:t===-1/0?-1:(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))}function asinh(t){return Math.asinh?Math.asinh(t):t===-1/0?t:Math.log(t+Math.sqrt(t*t+1))}function acosh(t){return Math.acosh?Math.acosh(t):Math.log(t+Math.sqrt(t*t-1))}function atanh(t){return Math.atanh?Math.atanh(t):Math.log((1+t)/(1-t))/2}function log10(t){return Math.log(t)*Math.LOG10E}function neg(t){return-t}function trunc(t){return Math.trunc?Math.trunc(t):x<0?Math.ceil(x):Math.floor(x)}function random(t){return Math.random()*(t||1)}function fac(t){for(var s=t=Math.floor(t);t>1;)s*=--t;return s}function hypot(){if(Math.hypot)return Math.hypot.apply(this,arguments);for(var t=0,s=arguments.length,e=0;e<s;e++){if(arguments[e]===1/0||arguments[e]===-1/0)return 1/0;t+=arguments[e]*arguments[e]}return Math.sqrt(t)}function append(t,s){return"[object Array]"!=Object.prototype.toString.call(t)?[t,s]:((t=t.slice()).push(s),t)}function Parser(){this.success=!1,this.errormsg="",this.expression="",this.pos=0,this.tokennumber=0,this.tokenprio=0,this.tokenindex=0,this.tmpprio=0,this.ops1={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:sinh,cosh:cosh,tanh:tanh,asinh:asinh,acosh:acosh,atanh:atanh,sqrt:Math.sqrt,log:Math.log,lg:log10,log10:log10,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:trunc,"-":neg,exp:Math.exp},this.ops2={"+":add,"-":sub,"*":mul,"/":div,"%":mod,"^":Math.pow,",":append,"||":concat},this.functions={random:random,fac:fac,min:Math.min,max:Math.max,hypot:hypot,pyt:hypot,pow:Math.pow,atan2:Math.atan2},this.consts={E:Math.E,PI:Math.PI}}Expression.prototype={simplify:function(t){t=t||{};var r,o,h,a,p=[],u=[],c=this.tokens.length,f=0;for(f=0;f<c;f++){var l=(a=this.tokens[f]).type_;if(l===s)p.push(a);else if(l===n&&a.index_ in t)a=new Token(s,0,0,t[a.index_]),p.push(a);else if(l===i&&p.length>1)o=p.pop(),r=p.pop(),h=this.ops2[a.index_],a=new Token(s,0,0,h(r.number_,o.number_)),p.push(a);else if(l===e&&p.length>0)r=p.pop(),h=this.ops1[a.index_],a=new Token(s,0,0,h(r.number_)),p.push(a);else{for(;p.length>0;)u.push(p.shift());u.push(a)}}for(;p.length>0;)u.push(p.shift());return new Expression(u,object(this.ops1),object(this.ops2),object(this.functions))},substitute:function(t,s){s instanceof Expression||(s=(new Parser).parse(String(s)));var e,i=[],r=this.tokens.length,o=0;for(o=0;o<r;o++){if((e=this.tokens[o]).type_===n&&e.index_===t)for(var h=0;h<s.tokens.length;h++){var a=s.tokens[h],p=new Token(a.type_,a.index_,a.prio_,a.number_);i.push(p)}else i.push(e)}return new Expression(i,object(this.ops1),object(this.ops2),object(this.functions))},evaluate:function(t){t=t||{};var o,h,a,p,u=[],c=this.tokens.length,f=0;for(f=0;f<c;f++){var l=(p=this.tokens[f]).type_;if(l===s)u.push(p.number_);else if(l===i)h=u.pop(),o=u.pop(),a=this.ops2[p.index_],u.push(a(o,h));else if(l===n)if(p.index_ in t)u.push(t[p.index_]);else{if(!(p.index_ in this.functions))throw new Error("undefined variable: "+p.index_);u.push(this.functions[p.index_])}else if(l===e)o=u.pop(),a=this.ops1[p.index_],u.push(a(o));else{if(l!==r)throw new Error("invalid Expression");if(o=u.pop(),!(a=u.pop()).apply||!a.call)throw new Error(a+" is not a function");"[object Array]"==Object.prototype.toString.call(o)?u.push(a.apply(void 0,o)):u.push(a.call(void 0,o))}}if(u.length>1)throw new Error("invalid Expression (parity)");return u[0]},toString:function(t){var a,p,u,c,f,l=[],x=this.tokens.length,d=0;for(d=0;d<x;d++){var g=(c=this.tokens[d]).type_;if(g===s)l.push("string"==typeof(f=c.number_)?(o.lastIndex=0,o.test(f)?"'"+f.replace(o,(function(t){var s=h[t];return"string"==typeof s?s:"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)}))+"'":"'"+f+"'"):f);else if(g===i)p=l.pop(),a=l.pop(),u=c.index_,t&&"^"==u?l.push("Math.pow("+a+","+p+")"):l.push("("+a+u+p+")");else if(g===n)l.push(c.index_);else if(g===e)a=l.pop(),"-"===(u=c.index_)?l.push("("+u+a+")"):l.push(u+"("+a+")");else{if(g!==r)throw new Error("invalid Expression");a=l.pop(),u=l.pop(),l.push(u+"("+a+")")}}if(l.length>1)throw new Error("invalid Expression (parity)");return l[0]},variables:function(){for(var t=this.tokens.length,s=[],e=0;e<t;e++){var i=this.tokens[e];i.type_===n&&-1==s.indexOf(i.index_)&&s.push(i.index_)}return s},toJSFunction:function(t,s){return new Function(t,"with(Parser.values) { return "+this.simplify(s).toString(!0)+"; }")}},Parser.parse=function(t){return(new Parser).parse(t)},Parser.evaluate=function(t,s){return Parser.parse(t).evaluate(s)},Parser.Expression=Expression,Parser.values={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:sinh,cosh:cosh,tanh:tanh,asinh:asinh,acosh:acosh,atanh:atanh,sqrt:Math.sqrt,log:Math.log,lg:log10,log10:log10,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:trunc,random:random,fac:fac,exp:Math.exp,min:Math.min,max:Math.max,hypot:hypot,pyt:hypot,pow:Math.pow,atan2:Math.atan2,E:Math.E,PI:Math.PI};var a=16,p=32,u=64;return Parser.prototype={parse:function(t){this.errormsg="",this.success=!0;var o=[],h=[];this.tmpprio=0;var c=77,f=0;for(this.expression=t,this.pos=0;this.pos<this.expression.length;)if(this.isOperator())this.isSign()&&c&u?(this.isNegativeSign()&&(this.tokenprio=2,this.tokenindex="-",f++,this.addfunc(h,o,e)),c=77):this.isComment()||(0==(2&c)&&this.error_parsing(this.pos,"unexpected operator"),f+=2,this.addfunc(h,o,i),c=77);else if(this.isNumber()){0==(1&c)&&this.error_parsing(this.pos,"unexpected number");var l=new Token(s,0,0,this.tokennumber);h.push(l),c=50}else if(this.isString()){0==(1&c)&&this.error_parsing(this.pos,"unexpected string");l=new Token(s,0,0,this.tokennumber);h.push(l),c=50}else if(this.isLeftParenth())0==(8&c)&&this.error_parsing(this.pos,'unexpected "("'),128&c&&(f+=2,this.tokenprio=-2,this.tokenindex=-1,this.addfunc(h,o,r)),c=333;else if(this.isRightParenth()){if(256&c){l=new Token(s,0,0,[]);h.push(l)}else 0==(c&a)&&this.error_parsing(this.pos,'unexpected ")"');c=186}else if(this.isComma())0==(c&p)&&this.error_parsing(this.pos,'unexpected ","'),this.addfunc(h,o,i),f+=2,c=77;else if(this.isConst()){0==(1&c)&&this.error_parsing(this.pos,"unexpected constant");var x=new Token(s,0,0,this.tokennumber);h.push(x),c=50}else if(this.isOp2())0==(4&c)&&this.error_parsing(this.pos,"unexpected function"),this.addfunc(h,o,i),f+=2,c=8;else if(this.isOp1())0==(4&c)&&this.error_parsing(this.pos,"unexpected function"),this.addfunc(h,o,e),f++,c=8;else if(this.isVar()){0==(1&c)&&this.error_parsing(this.pos,"unexpected variable");var d=new Token(n,this.tokenindex,0,0);h.push(d),c=186}else this.isWhite()||(""===this.errormsg?this.error_parsing(this.pos,"unknown character"):this.error_parsing(this.pos,this.errormsg));for((this.tmpprio<0||this.tmpprio>=10)&&this.error_parsing(this.pos,'unmatched "()"');o.length>0;){var g=o.pop();h.push(g)}return f+1!==h.length&&this.error_parsing(this.pos,"parity"),new Expression(h,object(this.ops1),object(this.ops2),object(this.functions))},evaluate:function(t,s){return this.parse(t).evaluate(s)},error_parsing:function(t,s){throw this.success=!1,this.errormsg="parse error [column "+t+"]: "+s,this.column=t,new Error(this.errormsg)},addfunc:function(t,s,e){for(var i=new Token(e,this.tokenindex,this.tokenprio+this.tmpprio,0);s.length>0&&i.prio_<=s[s.length-1].prio_;)t.push(s.pop());s.push(i)},isNumber:function(){for(var t=!1,s="";this.pos<this.expression.length;){var e=this.expression.charCodeAt(this.pos);if(!(e>=48&&e<=57||46===e))break;s+=this.expression.charAt(this.pos),this.pos++,this.tokennumber=parseFloat(s),t=!0}return t},unescape:function(t,s){for(var e=[],i=!1,n=0;n<t.length;n++){var r=t.charAt(n);if(i){switch(r){case"'":e.push("'");break;case"\\":e.push("\\");break;case"/":e.push("/");break;case"b":e.push("\b");break;case"f":e.push("\f");break;case"n":e.push("\n");break;case"r":e.push("\r");break;case"t":e.push("\t");break;case"u":var o=parseInt(t.substring(n+1,n+5),16);e.push(String.fromCharCode(o)),n+=4;break;default:throw this.error_parsing(s+n,"Illegal escape sequence: '\\"+r+"'")}i=!1}else"\\"==r?i=!0:e.push(r)}return e.join("")},isString:function(){var t=!1,s="",e=this.pos;if(this.pos<this.expression.length&&"'"==this.expression.charAt(this.pos))for(this.pos++;this.pos<this.expression.length;){if("'"==this.expression.charAt(this.pos)&&"\\"!=s.slice(-1)){this.pos++,this.tokennumber=this.unescape(s,e),t=!0;break}s+=this.expression.charAt(this.pos),this.pos++}return t},isConst:function(){for(var t in this.consts){var s=t.length;if(t===this.expression.substr(this.pos,s))return this.tokennumber=this.consts[t],this.pos+=s,!0}return!1},isOperator:function(){var t=this.expression.charCodeAt(this.pos);if(43===t)this.tokenprio=0,this.tokenindex="+";else if(45===t)this.tokenprio=0,this.tokenindex="-";else if(124===t){if(124!==this.expression.charCodeAt(this.pos+1))return!1;this.pos++,this.tokenprio=0,this.tokenindex="||"}else if(42===t||8729===t||8226===t)this.tokenprio=1,this.tokenindex="*";else if(47===t)this.tokenprio=2,this.tokenindex="/";else if(37===t)this.tokenprio=2,this.tokenindex="%";else{if(94!==t)return!1;this.tokenprio=3,this.tokenindex="^"}return this.pos++,!0},isSign:function(){var t=this.expression.charCodeAt(this.pos-1);return 45===t||43===t},isPositiveSign:function(){return 43===this.expression.charCodeAt(this.pos-1)},isNegativeSign:function(){return 45===this.expression.charCodeAt(this.pos-1)},isLeftParenth:function(){return 40===this.expression.charCodeAt(this.pos)&&(this.pos++,this.tmpprio+=10,!0)},isRightParenth:function(){return 41===this.expression.charCodeAt(this.pos)&&(this.pos++,this.tmpprio-=10,!0)},isComma:function(){return 44===this.expression.charCodeAt(this.pos)&&(this.pos++,this.tokenprio=-1,this.tokenindex=",",!0)},isWhite:function(){var t=this.expression.charCodeAt(this.pos);return(32===t||9===t||10===t||13===t)&&(this.pos++,!0)},isOp1:function(){for(var t="",s=this.pos;s<this.expression.length;s++){var e=this.expression.charAt(s);if(e.toUpperCase()===e.toLowerCase()&&(s===this.pos||"_"!=e&&(e<"0"||e>"9")))break;t+=e}return t.length>0&&t in this.ops1&&(this.tokenindex=t,this.tokenprio=5,this.pos+=t.length,!0)},isOp2:function(){for(var t="",s=this.pos;s<this.expression.length;s++){var e=this.expression.charAt(s);if(e.toUpperCase()===e.toLowerCase()&&(s===this.pos||"_"!=e&&(e<"0"||e>"9")))break;t+=e}return t.length>0&&t in this.ops2&&(this.tokenindex=t,this.tokenprio=5,this.pos+=t.length,!0)},isVar:function(){for(var t="",s=this.pos;s<this.expression.length;s++){var e=this.expression.charAt(s);if(e.toUpperCase()===e.toLowerCase()&&(s===this.pos||"_"!=e&&(e<"0"||e>"9")))break;t+=e}return t.length>0&&(this.tokenindex=t,this.tokenprio=4,this.pos+=t.length,!0)},isComment:function(){return 47===this.expression.charCodeAt(this.pos-1)&&42===this.expression.charCodeAt(this.pos)&&(this.pos=this.expression.indexOf("*/",this.pos)+2,1===this.pos&&(this.pos=this.expression.length),!0)}},t.Parser=Parser,Parser}("undefined"==typeof exports?{}:exports);