var currentview="ListView";function preloadDataURI(e,t){var _loadDataURIfromURL=function(e,t){if(e){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="blob",n.onload=function(){var e=new FileReader;e.readAsDataURL(n.response),e.onload=function(e){t(e.target.result)}},n.send()}else t(null)},n={};_loadDataURIfromURL(e.url,(function(a){n.url=a,_loadDataURIfromURL(e.specUrl,(function(a){n.specUrl=a,_loadDataURIfromURL(e.cloudUrl,(function(a){n.cloudUrl=a,_loadDataURIfromURL(e.ringUrl,(function(a){n.ringUrl=a,_loadDataURIfromURL(e.bumpUrl,(function(e){n.bumpUrl=e,t(n)}))}))}))}))}))}define(["sugar-web/activity/activity","sugar-web/env","sugar-web/datastore","webL10n","tutorial","humane"],(function(e,t,n,a,i,o){requirejs(["domReady!"],(function(l){e.setup();var r=new THREE.Scene,d=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),s=new THREE.WebGLRenderer({preserveDrawingBuffer:!0}),c=new THREE.TrackballControls(d,s.domElement);c.target.set(0,0,0);var u=["Name","Type","Year","Mass","Temperature","Moons","Radius","SunDistance"],m=planets,p=document.getElementById("planets-list"),E=document.getElementById("planet-container"),g=document.getElementById("planet-display"),y=document.getElementById("planet-info"),v=document.getElementById("planet-pos"),b=document.getElementById("canvas"),f=5,h=!1,w=document.createElement("div");w.id="back-button",w.title="Back to Planet List",E.appendChild(w),E.style.display="none",document.getElementById("rotation-button").style.display="none",document.getElementById("info-button").style.display="none",document.getElementById("image-button").style.display="none",document.getElementById("list-button").style.display="none";var B=[!1,null,!0,!0];function initPlanet(e,t,i,l,m,f,T,I){var H={};H.url="images/"+e.toLowerCase()+"map.jpg","Earth"===e&&(H.specUrl="images/"+e.toLowerCase()+"spec.png",H.cloudUrl="images/"+e.toLowerCase()+"cloudmap.jpg"),"Saturn"!==e&&"Uranus"!==e||(H.ringUrl="images/"+e.toLowerCase()+"ringcolor.jpg"),"Terrestrial"===t&&(H.bumpUrl="images/"+e.toLowerCase()+"bump.png"),preloadDataURI(H,(function(H){var L,R,M=H.url,P=!0,S=!0,D=(new THREE.TextureLoader).load(M),U=new THREE.SphereGeometry(2,32,32),k=new THREE.MeshPhongMaterial({map:D,shininess:5}),x=new THREE.DirectionalLight(16777215),C=new THREE.Group,j=new THREE.Mesh(U,k);if("Earth"===e){var z=H.specUrl,V=H.cloudUrl,N=(new THREE.TextureLoader).load(V),W=new THREE.SphereGeometry(2.03,32,32),G=new THREE.MeshPhongMaterial({map:N,side:THREE.DoubleSide,opacity:.5,transparent:!0,depthWrite:!1}),A=new THREE.Mesh(W,G);k.specularMap=(new THREE.TextureLoader).load(z),k.specular=new THREE.Color("grey"),j.add(A)}if("Saturn"===e||"Uranus"===e){var O=H.ringUrl,q=(new THREE.TextureLoader).load(O);if("Saturn"===e){var Y=(X=new THREE.RingBufferGeometry(2.5,5,40)).attributes.position,F=new THREE.Vector3;for(let e=0;e<Y.count;e++)F.fromBufferAttribute(Y,e),X.attributes.uv.setXY(e,F.length()<4?0:1,1)}else var X=new THREE.RingBufferGeometry(3.8,4,40);var J=new THREE.MeshPhongMaterial({map:q,side:THREE.DoubleSide,opacity:.6,transparent:!0,depthWrite:!0}),_=new THREE.Mesh(X,J)}if("Terrestrial"===t){var K=H.bumpUrl;k.bumpMap=(new THREE.TextureLoader).load(K),k.bumpScale=.1}document.getElementById("rotation-button").classList.add("active"),document.getElementById("info-button").classList.add("active"),createPlanet=function(){for(S=!0,L=!0,b.style.backgroundColor="#c0c0c0",E.style.display="block",p.style.display="none",document.getElementById("planet-info").style.display="block",g.style.width="60%",document.getElementById("position-button").style.display="none",document.getElementById("list-button").style.display="none",document.getElementById("rotation-button").style.display="inline",document.getElementById("info-button").style.display="inline",document.getElementById("image-button").style.display="inline",currentview="ExploreView",B[0]=!1,B[1]=e;r.children.length>0;)r.remove(r.children[0]);s.setSize(g.clientWidth,window.innerHeight),g.appendChild(s.domElement),x.position.set(1,1,5),C.add(x),r.add(C),r.add(j),r.add(d),"Saturn"!==e&&"Uranus"!==e||(_.rotation.x="Saturn"===e?33:0,r.add(_)),d.position.z=5;for(var v=0;v<8;v++){var h=document.createElement("div");h.id=u[v],h.className="info",y.appendChild(h)}document.getElementById("Name").innerHTML="<p>"+a.get("PlanetName")+"</br>"+a.get(e)+"</p>",document.getElementById("Type").innerHTML="<p>"+a.get("PlanetType")+"</br>"+a.get(t.replace(/\s+/g,""))+"</p>",document.getElementById("Year").innerHTML="<p>"+a.get("YearLength")+"</br>"+a.get("EarthDays",{year:i})+"</p>",document.getElementById("Mass").innerHTML="<p>"+a.get("Mass")+"</br>"+l+"</p>",document.getElementById("Temperature").innerHTML="<p>"+a.get("SurfaceTemperature")+"</br>"+m+"</p>",document.getElementById("Moons").innerHTML="<p>"+a.get("NumberOfMoons")+"</br>"+f+"</p>",document.getElementById("Radius").innerHTML="<p>"+a.get("PlanetRadius")+"</br>"+T+"</p>",document.getElementById("SunDistance").innerHTML="<p>"+a.get("SunDistance")+"</br>"+I+"</p>",saveImage=function(){var t=s.domElement.toDataURL(),i={mimetype:"image/jpeg",title:"Image "+e,activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};R&&n.create(i,(function(){o.log(a.get("PlanetImageSaved",{planet:e})),console.log("export done."),R=!1}),t)},animatePlanet=function(){resizePlanet(s)&&(d.aspect=g.clientWidth/g.clientHeight,d.updateProjectionMatrix(),c.handleResize()),!0===L?requestAnimationFrame(animatePlanet):cancelAnimationFrame(animatePlanet),!0===S&&(j.rotation.y+=.1*Math.PI/180),c.update(),C.quaternion.copy(d.quaternion),s.render(r,d)},resizePlanet=function(e){var t=g.clientWidth,n=g.clientHeight,a=g.width!==t||g.height!==n;return a&&e.setSize(t,n),a},document.getElementById("image-button").addEventListener("click",(function(){R=!0,saveImage()})),animatePlanet()},!1!==h?createPlanet():document.getElementById("planet-"+e).addEventListener("click",createPlanet),document.getElementById("rotation-button").addEventListener("click",(function(){S?(S=!1,document.getElementById("rotation-button").classList.remove("active")):(S=!0,document.getElementById("rotation-button").classList.add("active")),B[2]=S})),document.getElementById("info-button").addEventListener("click",(function(){P?(document.getElementById("planet-info").style.display="none",g.style.width="100%",s.setSize(window.innerWidth,window.innerHeight),resizePlanet(s),P=!1,document.getElementById("info-button").classList.remove("active")):(document.getElementById("planet-info").style.display="block",g.style.width="60%",s.setSize(g.clientWidth,window.innerHeight),resizePlanet(s),P=!0,document.getElementById("info-button").classList.add("active")),B[3]=P,g.appendChild(s.domElement)})),w.addEventListener("click",(function(){if(B=[!1,null,!0,!0],S=!1,L=!1,S=!0,P=!0,E.style.display="none",b.style.backgroundColor="black",document.getElementById("rotation-button").classList.add("active"),document.getElementById("info-button").classList.add("active"),document.getElementById("rotation-button").style.display="none",document.getElementById("info-button").style.display="none",document.getElementById("image-button").style.display="none",h&&"ExploreView"===currentview){for(;r.children.length>0;)r.remove(r.children[0]);document.getElementById("position-button").style.display="none",p.style.display="none",v.style.display="block",document.getElementById("position-button").click(),h=!1}else if("PositionView"!=currentview){for(;r.children.length>0;)r.remove(r.children[0]);currentview="ListView",document.getElementById("position-button").style.display="inline",p.style.display="block"}}))}))}function initPosition(e,t,n,i,o,l,d,c){var u={};u.url="images/"+e.toLowerCase()+"map.jpg","Earth"===e&&(u.specUrl="images/"+e.toLowerCase()+"spec.png",u.cloudUrl="images/"+e.toLowerCase()+"cloudmap.jpg"),"Saturn"!==e&&"Uranus"!==e||(u.ringUrl="images/"+e.toLowerCase()+"ringcolor.jpg"),"Terrestrial"===t&&(u.bumpUrl="images/"+e.toLowerCase()+"bump.png"),preloadDataURI(u,(function(u){var m,E,g=u.url;"Sun"===e?m=45:"Mercury"===e?m=.5:"Venus"===e||"Earth"===e?m=2:"Mars"===e?m=1:"Jupiter"===e||"Saturn"===e?m=10:"Uranus"!==e&&"Neptune"!=e||(m=5);var y,b=(new THREE.TextureLoader).load(g),w=new THREE.SphereGeometry(m,32,32),T=new THREE.MeshBasicMaterial({map:b,side:THREE.DoubleSide}),I=new THREE.DirectionalLight(16777215),H=new THREE.Group,L=new THREE.Mesh(w,T);if("Earth"===e){var R=(new THREE.TextureLoader).load(u.cloudUrl),M=new THREE.SphereGeometry(m,32,32),P=new THREE.MeshPhongMaterial({map:R,side:THREE.DoubleSide,opacity:.2,transparent:!0,depthWrite:!1}),S=new THREE.Mesh(M,P);T.specularMap=(new THREE.TextureLoader).load(u.specUrl),T.specular=new THREE.Color("grey"),L.add(S)}if("Saturn"===e||"Uranus"===e){var D=(new THREE.TextureLoader).load(u.ringUrl);if("Saturn"===e){var U=(x=new THREE.RingBufferGeometry(12,23,64)).attributes.position,k=new THREE.Vector3;for(let e=0;e<U.count;e++)k.fromBufferAttribute(U,e),x.attributes.uv.setXY(e,k.length()<14?0:1,1)}else var x=new THREE.RingBufferGeometry(9,10,64);var C=new THREE.MeshPhongMaterial({map:D,side:THREE.DoubleSide,opacity:.4,transparent:!0}),j=new THREE.Mesh(x,C)}var z=0;if("Sun"===e?y=-123:"Mercury"===e?(y=-71,z=11.5):"Venus"===e?(y=-56,z=19.2):"Earth"===e?(y=-41,z=27.5):"Mars"===e?(y=-26,z=35.8):"Uranus"===e?(y=62,z=80.6):"Neptune"===e?(y=82,z=91.6):"Jupiter"===e?(y=-9,z=44.1):(y=27,z=62.6),"Terrestrial"===t){T.bumpMap=(new THREE.TextureLoader).load(u.bumpUrl),T.bumpScale=.1;var V=document.createElement("div");V.id="div-"+e,V.className="planet-div",v.appendChild(V),document.getElementById("div-"+e).style.padding="2%",document.getElementById("div-"+e).style.marginLeft=z-1+"%"}if("Sun"!==e){if(null==document.getElementById("new-name-"+e)){var N=document.createElement("div");N.id="new-name-"+e,N.className="planet-new-name",N.innerHTML=a.get(e),v.appendChild(N)}document.getElementById("new-name-"+e).style.marginLeft=z+"%"}L.position.x=y,L.name=e,L.userData.typeOfPlanet=t,L.userData.year=n,L.userData.mass=i,L.userData.temperature=o,L.userData.moons=l,L.userData.radius=d,L.userData.sunDistance=c,document.getElementById("position-button").addEventListener("click",(function(a){var u=v.clientHeight/v.clientWidth,m=new THREE.OrthographicCamera(f/-20,f/20,f*u/20,f*u/-20,-500,2e3),g=new THREE.Raycaster,y=new THREE.Vector2;document.getElementById("position-button").style.display="none",p.style.display="none",v.style.display="block",document.getElementById("list-button").style.display="inline",currentview="PositionView",B[0]=!0,E=!0,r.add(L),s.setSize(v.clientWidth,v.clientHeight),v.appendChild(s.domElement),I.position.set(1,-.5,5),H.add(I),r.add(H),r.add(L),r.add(m),"Saturn"!==e&&"Uranus"!==e||("Saturn"===e?(j.rotation.x=30,j.position.x=27):(j.rotation.x=0,j.position.x=62),r.add(j)),m.zoom=.0026,m.updateProjectionMatrix(),clickMesh=function(e){e.preventDefault(),canvasBounds=v.getBoundingClientRect(),"ontouchend"in s.domElement?(y.x=(e.changedTouches[0].clientX-canvasBounds.left)/(canvasBounds.right-canvasBounds.left)*2-1,y.y=-(e.changedTouches[0].clientY-canvasBounds.top)/(canvasBounds.bottom-canvasBounds.top)*2+1):(y.x=(e.clientX-canvasBounds.left)/(canvasBounds.right-canvasBounds.left)*2-1,y.y=-(e.clientY-canvasBounds.top)/(canvasBounds.bottom-canvasBounds.top)*2+1),g.setFromCamera(y,m);for(var t=g.intersectObjects(r.children),n=0;n<t.length;n++)"Sun"!==t[n].object.name&&(v.style.display="none",h=!0,initPlanet(t[n].object.name,t[n].object.userData.typeOfPlanet,t[n].object.userData.year,t[n].object.userData.mass,t[n].object.userData.temperature,t[n].object.userData.moons,t[n].object.userData.radius,t[n].object.userData.sunDistance))},animatePlanet=function(){if(resizePlanet(s)){var e=v.clientHeight/v.clientWidth;m.left=f/-20,m.right=f/20,m.top=f*e/20,m.bottom=-f*e/20,m.updateProjectionMatrix()}m.updateProjectionMatrix(),!0===E&&"ExploreView"!==currentview&&requestAnimationFrame(animatePlanet),s.render(r,m)},resizePlanet=function(e){var t=v.clientWidth,n=v.clientHeight,a=v.width!==t||v.height!==n;return a&&e.setSize(v.clientWidth,v.clientHeight),a},"ontouchend"in s.domElement?s.domElement.addEventListener("touchend",clickMesh,!1):s.domElement.addEventListener("click",clickMesh,!1),null!==document.getElementById("div-"+e)&&document.getElementById("div-"+e).addEventListener("click",(function(){v.style.display="none",currentview="ExploreView",h=!0,E&&initPlanet(e,t,n,i,o,l,d,c),E=!1})),animatePlanet()})),document.getElementById("list-button").addEventListener("click",(function(){currentview="ListView",B[1]=null,B[0]=!1,E=!1}))}))}v.style.display="none",t.getEnvironment((function(t,n){n;var i="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18.getUILanguage():navigator.language,o=n.user?n.user.language:i;a.language.code=o,initPosition("Sun","Star",null),window.addEventListener("localized",(function(){p.innerHTML="",v.innerHTML="",11.5;for(var e=0;e<m.length;e++){var t=document.createElement("div");t.id="planet-"+m[e].name,t.className="planets",p.appendChild(t);var n=document.createElement("img");n.className=m[e].name,n.src="images/"+m[e].name.toLowerCase()+".jpg",n.width=240,document.getElementById("planet-"+m[e].name).appendChild(n);var i=document.createElement("span");i.className="name",i.innerHTML="<p>"+a.get(m[e].name)+"</p>",document.getElementById("planet-"+m[e].name).appendChild(i),initPlanet(m[e].name,m[e].type,m[e].year,m[e].mass,m[e].temperature,m[e].moons,m[e].radius,m[e].distancefromsun),initPosition(m[e].name,m[e].type,m[e].year,m[e].mass,m[e].temperature,m[e].moons,m[e].radius,m[e].distancefromsun),document.getElementById("fullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.opacity=0,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",document.getElementById("back-button").style.bottom="740px"})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",document.getElementById("back-button").style.bottom="685px"})),document.getElementById("list-button").addEventListener("click",(function(){p.style.display="block",v.style.display="none",h=!1,-80,requestAnim=!1,3.5,document.getElementById("position-button").style.display="inline",document.getElementById("list-button").style.display="none"}))}})),n.objectId?(console.log("Existing instance"),e.getDatastoreObject().loadAsText((function(e,t,n){null==e&&null!=n&&(B=JSON.parse(n),console.log(B[1]),!0===B[0]&&"ExploreView"!==currentview?document.getElementById("position-button").click():null!==B[1]&&(document.getElementById("planet-"+B[1]).click(),!1===B[2]&&document.getElementById("rotation-button").click(),!1===B[3]&&document.getElementById("info-button").click()))}))):console.log("New instance")})),document.getElementById("help-button").addEventListener("click",(function(e){i.start()})),document.getElementById("stop-button").addEventListener("click",(function(t){console.log("writing...");var n=JSON.stringify(B);e.getDatastoreObject().setDataAsText(n),e.getDatastoreObject().save((function(e){null===e?console.log("writing done"):console.log("writing failed")}))}))}))}));