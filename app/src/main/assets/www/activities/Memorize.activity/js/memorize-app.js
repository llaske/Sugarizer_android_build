define(["activity/sample-ressources","activity/palettes/template-palette","activity/palettes/size-palette","activity/lz-string","sugar-web/graphics/journalchooser","sugar-web/datastore","tutorial"],(function(e,t,a,i,r,o,n){var d="#84f060",s="classic",l="splitted",c="equal",m="non_equal",g="#inline#",u={name:"Letters",icon:"letters.svg",cards:[[{text:"A"},{text:"a"}],[{text:"B"},{text:"b"}],[{text:"C"},{text:"c"}],[{text:"D"},{text:"d"}],[{text:"E"},{text:"e"}],[{text:"F"},{text:"f"}],[{text:"G"},{text:"g"}],[{text:"H"},{text:"h"}],[{text:"I"},{text:"i"}],[{text:"J"},{text:"j"}],[{text:"K"},{text:"k"}],[{text:"L"},{text:"l"}],[{text:"M"},{text:"m"}],[{text:"N"},{text:"n"}],[{text:"O"},{text:"o"}],[{text:"P"},{text:"p"}],[{text:"Q"},{text:"q"}],[{text:"R"},{text:"r"}],[{text:"S"},{text:"s"}],[{text:"T"},{text:"t"}],[{text:"U"},{text:"u"}],[{text:"V"},{text:"v"}],[{text:"W"},{text:"w"}],[{text:"X"},{text:"x"}],[{text:"Y"},{text:"y"}],[{text:"Z"},{text:"z"}]],mode:l},p={strings:{add:"Add",update:"Update",remove:"Remove"},ui:{},templates:[{name:"Addition",icon:"addition.svg",cards:[[{text:"3+4"},{text:"7"}],[{text:"5+5"},{text:"10"}],[{text:"5+6"},{text:"11"}],[{text:"4+4"},{text:"8"}],[{text:"4+5"},{text:"9"}],[{text:"3+3"},{text:"6"}],[{text:"2+2"},{text:"4"}],[{text:"1+1"},{text:"2"}],[{text:"1+2"},{text:"3"}],[{text:"9+9"},{text:"18"}],[{text:"10+9"},{text:"19"}],[{text:"8+8"},{text:"16"}],[{text:"8+9"},{text:"17"}],[{text:"7+7"},{text:"14"}],[{text:"7+8"},{text:"15"}],[{text:"6+6"},{text:"12"}]],mode:l},u,{name:"Sounds",icon:"sounds.svg",cards:[[{image:g+"drumkit1_b",sound:g+"beat1_a"},{image:g+"drumkit1_b",sound:g+"beat1_a"}],[{image:g+"drumkit2_b",sound:g+"beat1_b"},{image:g+"drumkit2_b",sound:g+"beat1_b"}],[{image:g+"drumkit3_b",sound:g+"beat1_c"},{image:g+"drumkit3_b",sound:g+"beat1_c"}],[{image:g+"drumkit4_b",sound:g+"beat8"},{image:g+"drumkit4_b",sound:g+"beat8"}],[{image:g+"drumkit5_b",sound:g+"beat10"},{image:g+"drumkit5_b",sound:g+"beat10"}],[{image:g+"drumkit6_b",sound:g+"beat3"},{image:g+"drumkit6_b",sound:g+"beat3"}],[{image:g+"drumkit7_b",sound:g+"beat4"},{image:g+"drumkit7_b",sound:g+"beat4"}],[{image:g+"drumkit8_b",sound:g+"beat14"},{image:g+"drumkit8_b",sound:g+"beat14"}],[{image:g+"drumkit9_b",sound:g+"beat6_2"},{image:g+"drumkit9_b",sound:g+"beat6_2"}],[{image:g+"drumkit10_b",sound:g+"beat2"},{image:g+"drumkit10_b",sound:g+"beat2"}],[{image:g+"drumkit11_b",sound:g+"beat16"},{image:g+"drumkit11_b",sound:g+"beat16"}],[{image:g+"drumkit12_b",sound:g+"beat17"},{image:g+"drumkit12_b",sound:g+"beat17"}],[{image:g+"guitar1_2",sound:g+"bending_a"},{image:g+"guitar1_2",sound:g+"bending_a"}],[{image:g+"guitar2_2",sound:g+"bending_b"},{image:g+"guitar2_2",sound:g+"bending_b"}],[{image:g+"guitar3_2",sound:g+"flashcomp2a"},{image:g+"guitar3_2",sound:g+"flashcomp2a"}],[{image:g+"guitar4_2",sound:g+"flashcomp2b"},{image:g+"guitar4_2",sound:g+"flashcomp2b"}],[{image:g+"guitar5_2",sound:g+"gedaempft"},{image:g+"guitar5_2",sound:g+"gedaempft"}],[{image:g+"guitar6_2",sound:g+"ungedaempft"},{image:g+"guitar6_2",sound:g+"ungedaempft"}],[{image:g+"guitar7_2",sound:g+"jimi4"},{image:g+"guitar7_2",sound:g+"jimi4"}],[{image:g+"guitar8_2",sound:g+"git_hit1"},{image:g+"guitar8_2",sound:g+"git_hit1"}],[{image:g+"guitar9_2",sound:g+"git_hit4"},{image:g+"guitar9_2",sound:g+"git_hit4"}],[{image:g+"guitar10_2",sound:g+"jimi1"},{image:g+"guitar10_2",sound:g+"jimi1"}],[{image:g+"guitar11_2",sound:g+"flasholet4"},{image:g+"guitar11_2",sound:g+"flasholet4"}],[{image:g+"guitar12_2",sound:g+"guitcello"},{image:g+"guitar12_2",sound:g+"guitcello"}]],mode:s}],isHost:!1,editor:{pairMode:c,card1:{},card2:{},selectedPair:-1},game:{template:u,multiplayer:!1,selectedCards:[],mode:void 0,cards:[],currentPlayer:"",players:[],size:4},computeCards:function computeCards(e){if(p.game.cards=[],p.game.selectedCards=[],!p.game.template)return;p.game.mode=p.game.template.mode;var t={name:p.game.template.name,cards:[]};t.cards=JSON.parse(JSON.stringify(shuffle(p.game.template.cards)));var a=0;a=p.game.size%2==0?p.game.size*p.game.size:p.game.size*p.game.size-2;if(p.game.mode==s){for(var i=[],r=0;r<t.cards.length&&r<a/2;r++){var o=t.cards[r][0],n=t.cards[r][1];o.id=r,n.id=r,i.push(o),i.push(n)}p.game.cards=shuffle(i)}if(p.game.mode==l){var d=[],c=[];for(r=0;r<a/2&&r<t.cards.length;r++){o=t.cards[r][0],n=t.cards[r][1];o.id=r,n.id=r,d.push(o),c.push(n)}var m=shuffle(d);for(r=0;r<m.length;r++)p.game.cards.push(m[r]);var g=shuffle(c);for(r=0;r<g.length;r++)p.game.cards.push(g[r])}e||saveGame()},inEditMode:!1,shareActivity:function shareActivity(e){if(!p.presence.isConnected())return;p.inEditMode=!1,leaveEditMode(),function disableEditMode(){p.ui.gameEditorButton.disabled=!0,p.ui.gameEditorButton.style.opacity=.3,p.ui.gameEditorButton.style.backgroundImage="url(icons/cog.svg)",p.ui.gameEditorInsertModeButton.disabled=!0,p.ui.gameEditorInsertModeButton.style.opacity=.3,p.ui.gameEditorPlayModeButton.disabled=!0,p.ui.gameEditorPlayModeButton.style.opacity=.3,p.ui.gameEditorClearButton.disabled=!0,p.ui.gameEditorClearButton.style.opacity=.3}(),p.game.multiplayer=!0,p.isHost=e,p.me=p.presence.userInfo,p.game.currentPlayer=p.me.networkId,p.ui.gamePlayers.style.display="block"},initUI:function initUI(e){p.ui.gameGrid=document.getElementById("game-grid"),p.ui.gamePlayers=document.getElementById("game-players"),p.ui.gameEditor=document.getElementById("game-editor"),p.ui.gameTemplatesButton=document.getElementById("game-templates-button"),new t.TemplatePalette(p.ui.gameTemplatesButton,void 0,p.templates).addEventListener("template",(function(e){for(var t=0;t<p.game.players.length;t++)p.game.players[t].score=0;p.game.template=e.detail.value,p.ui.gameTemplatesButton.style.backgroundImage="url(icons/"+e.detail.value.icon+")",p.computeCards(),p.drawGame(),sendMessage({action:"updateGame",game:p.game})})),p.ui.gameSizeButton=document.getElementById("game-size-button"),new a.SizePalette(p.ui.gameSizeButton).addEventListener("size",(function(e){for(var t=0;t<p.game.players.length;t++)p.game.players[t].score=0;p.game.size=e.detail.value,p.ui.gameSizeButton.style.background="url(icons/"+e.detail.value+"x"+e.detail.value+".svg)",p.computeCards(),p.drawGame(),sendMessage({action:"updateGame",game:p.game})})),p.ui.gameResetButton=document.getElementById("game-reset-button"),p.ui.gameResetButton.addEventListener("click",(function(){for(var e=0;e<p.game.players.length;e++)p.game.players[e].score=0;p.game.selectedCards=[],p.game.cards=[],displayUsersAndScores(),p.computeCards(),p.drawGame(),sendMessage({action:"updateGame",game:p.game})})),p.ui.gameEditorButton=document.getElementById("game-editor-button"),p.ui.gameEditorInsertModeButton=document.getElementById("game-editor-insert-mode-button"),p.ui.gameEditorPlayModeButton=document.getElementById("game-editor-play-mode-button"),p.ui.gameEditorPlayModeButton.addEventListener("click",(function(){p.game.template.mode==s?(p.game.template.mode=l,p.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game2.svg)"):(p.game.template.mode=s,p.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game1.svg)"),saveGame(),displayEditor()})),p.ui.gameEditorClearButton=document.getElementById("game-editor-clear-button"),p.ui.gameEditorInsertModeButton.addEventListener("click",(function(){p.editor.pairMode==c?(p.editor.pairMode=m,p.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-non-equals.svg)"):(p.editor.pairMode=c,p.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-equals.svg)"),saveGame(),displayEditor()})),p.ui.gameEditorClearButton.addEventListener("click",(function(){p.game.template.cards=[],saveGame(),displayEditor()})),p.ui.gameEditorButton.addEventListener("click",(function(){p.inEditMode?leaveEditMode():function enterEditMode(){p.inEditMode=!0,p.ui.gameGrid.innerHTML="",p.ui.gameGrid.style.display="none",p.ui.gameEditor.style.display="block",p.game.selectedCards=[],p.editor.selectedPair=-1,p.ui.gameTemplatesButton.disabled=!0,p.ui.gameTemplatesButton.style.opacity=.3,p.ui.gameSizeButton.disabled=!0,p.ui.gameSizeButton.style.opacity=.3,p.ui.gameResetButton.disabled=!0,p.ui.gameResetButton.style.opacity=.3,p.ui.gameEditorInsertModeButton.disabled=!1,p.ui.gameEditorInsertModeButton.style.opacity=1,p.ui.gameEditorPlayModeButton.disabled=!1,p.ui.gameEditorPlayModeButton.style.opacity=1,p.ui.gameEditorClearButton.disabled=!1,p.ui.gameEditorClearButton.style.opacity=1,p.ui.gameEditorButton.style.backgroundImage="url(icons/play.svg)",displayEditor()}()})),p.ui.tutorialButton=document.getElementById("help-button"),p.ui.tutorialButton.addEventListener("click",(function(){Object.keys(p.game.cards[0]);var e=p.game.template.mode==l?1:2;p.inEditMode?n.startEditorTutorial():n.startMainTutorial(e)})),p.ui.gameEditorInsertModeButton.disabled=!0,p.ui.gameEditorInsertModeButton.style.opacity=.3,p.ui.gameEditorPlayModeButton.disabled=!0,p.ui.gameEditorPlayModeButton.style.opacity=.3,p.ui.gameEditorClearButton.disabled=!0,p.ui.gameEditorClearButton.style.opacity=.3,window.onresize=function(){setTimeout((function(){p.inEditMode?displayEditor():p.drawGame()}),250)},e&&e()},drawGame:drawGame,onUsersListChanged:function onUsersListChanged(e){for(var t=0;t<p.game.players.length;t++)p.game.players[t].online=!1;if(!p.hasLoadedMultiplayer&&e.length>=3)return void document.getElementById("stop-button").click();if(p.hasLoadedMultiplayer=!0,p.game.players=[],1==e.length)return p.isHost=!0,p.game.currentPlayer=p.me.networkId,p.game.selectedCards=[],p.game.players.push(e[0]),p.game.players[0].online=!0,p.game.players[0].score=0,drawGame(),void displayUsersAndScores();for(t=0;t<e.length;t++){for(var a=!1,i=0;i<p.game.players.length;i++)if(p.game.players[i].networkId==e[t].networkId){p.game.players[i].online=!0,a=!0;break}if(!a){var r=e[t];r.score=0,r.online=!0,p.game.players.push(r)}}p.isHost&&sendMessage({action:"updateGame",game:p.game});displayUsersAndScores()},onDataReceived:function onDataReceived(e){if(e.user.networkId==p.me.networkId)return;e.content=JSON.parse(i.decompressFromUTF16(e.content)),"updateCurrentPlayer"==e.content.action&&(p.game.currentPlayer=e.content.currentPlayer,displayUsersAndScores());"updateGame"==e.content.action&&(p.game=e.content.game,p.ui.gameSizeButton.style.background="url(icons/"+p.game.size+"x"+p.game.size+".svg)",p.ui.gameTemplatesButton.style.backgroundImage="url(icons/"+p.game.template.icon+")",p.drawGame(),displayUsersAndScores(),saveGame());if("cardClick"==e.content.action){for(var t=p.ui.gameGrid.childNodes,a=[],r=0;r<t.length;r++)t[r].style.clear&&""!=t[r].style.clear||a.push(t[r]);for(r=0;r<p.game.players.length;r++)p.game.players[r].networkId==e.user.networkId&&cardClick(a[e.content.position],!1,p.game.players[r])}}};function shuffle(e){for(var t,a,i=e.length;0!==i;)a=Math.floor(Math.random()*i),t=e[i-=1],e[i]=e[a],e[a]=t;return e}function resizeTextInsideTextCardDivs(){for(var e=document.getElementsByClassName("textCard"),t=0;t<e.length;t++){for(var a=e[t];a.scrollHeight>a.offsetHeight;)a.style.fontSize=parseInt(a.style.fontSize)-1+"px";for(;a.scrollWidth>a.offsetWidth;)a.style.fontSize=parseInt(a.style.fontSize)-1+"px"}}function createFullCardDiv(e,t,a,i){var r=document.createElement("div");return r.cardPosition=e,r.webkitPerspective="500px",r.perspective="500px",r.style.border="3px solid #fff",r.style.borderRadius="6px",r.style.margin="3px",r.style.webkitTransition="transform 0.5s",r.style.transition="transform 0.5s",p.game.template.mode==l?r.id=e<i?"numberOneTutorial":"numberTwoTutorial":e===i-2?r.id="soundTutorial":e===i+2&&(r.id="soundTutorial2"),r.style.transitionDuration="0.5s",r.style.webkitTransitionDuration="0.5s",r.style.transformStyle="preserve-3d",r.style.webkitTransformStyle="preserve-3d",r.style.position="relative",r.style.float="left",r.style.height=t+"px",r.style.width=t+"px",a.solved?(r.style.webkitTransform="rotateY(180deg)",r.style.transform="rotateY(180deg)"):(r.style.webkitTransform="",r.style.transform=""),0!=p.game.selectedCards.length&&p.game.selectedCards[0].cardPosition==r.cardPosition&&(r.style.webkitTransform="",r.style.transform=""),r}function createFrontDiv(e,t,a){var i=document.createElement("div");return p.game.mode==s&&(i.style.background="#777"),p.game.mode==l&&(i.style.background=e<t?"#777 url(icons/number1.svg)":"#777 url(icons/number2.svg)"),i.zIndex=2,i.style.borderRadius="6px",i.style.webkitBackfaceVisibility="hidden",i.style.backfaceVisibility="hidden",i.style.backgroundPosition="center center",i.style.backgroundRepeat="no-repeat",i.style.height=a+"px",i.style.position="absolute",i.style.top="0px",i.style.left="0px",i.style.width=a+"px",i}function createDiv(t,a,i){var r=document.createElement("div"),o=function generateCardDiv(t,a){var i;return t.image?(0==t.image.indexOf(g)&&(t.image=e[t.image.slice(g.length)]),(i=document.createElement("div")).style.background="url('"+t.image+"')",i.style.backgroundRepeat="no-repeat",i.style.backgroundSize="contain",i.style.webkitBackgroundSize="contain",i.style.backgroundPosition="center center",i.style.height=a+"px",i.style.width=a+"px",i):t.text?(0==t.text.indexOf(g)&&(t.text=e[t.text.slice(g.length)]),(i=document.createElement("div")).className="textCard",i.style.textAlign="center",i.style.display="block",i.innerHTML=t.text,i.style.lineHeight=a+"px",i.style.fontSize=a+"px",i.style.color="#000",i.style.width=a+"px",i.style.height=a+"px",i):void 0}(p.game.cards[t],a);return r.appendChild(o),r.style.height=a+"px",r.style.webkitBackfaceVisibility="hidden",r.style.backfaceVisibility="hidden",r.style.mozBackfaceVisibility="hidden",r.style.position="absolute",r.style.webkitTransform="rotateY(180deg)",r.style.transform="rotateY(180deg)",r.style.top="0px",r.style.left="0px",r.style.borderRadius="6px",r.style.width=a+"px",r.style.background="#fff",i.solved&&(r.style.backgroundColor=d),r}function cardClick(t,a,i){var r=p.game.cards.length/2;!function createAudioContextIfMissing(){if(!p.context){var e=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;if(e){e=new e,p.context=e;var t=e.createBuffer(1,1,22050),a=e.createBufferSource();p.source=a,a.buffer=t,a.connect(e.destination),a.start(0)}}}();var o=t;if(!o.card.solved&&2!=p.game.selectedCards.length){if(p.game.mode==l&&1==p.game.selectedCards.length){if(o.cardPosition<r&&p.game.selectedCards[0].cardPosition<r)return;if(o.cardPosition>=r&&p.game.selectedCards[0].cardPosition>=r)return}if(o.style.webkitTransform="rotateY(180deg)",o.style.transform="rotateY(180deg)",1!=p.game.selectedCards.length||p.game.selectedCards[0]!=o){if(p.game.selectedCards.push(o),o.card.sound){0==o.card.sound.indexOf(g)&&(o.card.sound=e[o.card.sound.slice(g.length)]);var n=o.card.sound.split("base64,")[1];n=f.decodeArrayBuffer(btoa(atob(n))),p.context&&p.context.decodeAudioData(n,(function(e){var t=p.context.createBufferSource();if(p.source)try{p.source.stop(0)}catch(e){}p.source=t,t.buffer=e,t.connect(p.context.destination);try{t.start(0)}catch(e){}}),(function(e){console.log("err(decodeAudioData): "+e)}))}if(1!=p.game.selectedCards.length){if(p.game.selectedCards[0].card.id==o.card.id){if(p.game.selectedCards[0].card.solved=!0,o.card.solved=!0,1==p.game.players.length)p.game.players[0].score=p.game.players[0].score+1;else for(var s=0;s<p.game.players.length;s++)p.game.players[s].networkId==i.networkId&&(p.game.players[s].score=p.game.players[s].score+1);displayUsersAndScores();var c=p.game.selectedCards[0].resultDiv,m=o.resultDiv;return setTimeout((function(){c.style.backgroundColor=d,m.style.backgroundColor=d}),1e3),p.game.selectedCards=[],void saveGame()}p.game.currentPlayer="",setTimeout((function(){try{o.style.webkitTransform="",o.style.transform="",p.game.selectedCards[0].style.webkitTransform="",p.game.selectedCards[0].style.transform="",p.game.selectedCards=[],setTimeout((function(){if(a)for(var e=0;e<p.game.players.length;e++){if(p.game.players[e].online&&p.game.players[e].networkId!=p.me.networkId){p.game.currentPlayer=p.game.players[e].networkId,sendMessage({action:"updateCurrentPlayer",currentPlayer:p.game.currentPlayer}),displayUsersAndScores();break}p.game.currentPlayer=p.game.players[0].networkId}}),300)}catch(e){}}),2e3)}}}}function saveGame(){p.activity.getDatastoreObject().setDataAsText(JSON.stringify({game:p.game})),p.activity.getDatastoreObject().save((function(e,t){}))}function onCardClick(){if(p.game.multiplayer){if(p.game.currentPlayer!=p.me.networkId)return;sendMessage({action:"cardClick",position:this.cardPosition}),0!=p.game.players.length&&1!=p.game.players.length||cardClick(this,!0);for(var e=0;e<p.game.players.length;e++)p.game.players[e].networkId==p.me.networkId&&cardClick(this,!0,p.game.players[e])}else cardClick(this,!0)}function drawGame(){p.editor.pairMode==c?p.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-non-equals.svg)":p.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-equals.svg)",p.game.template.mode==s?p.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game1.svg)":p.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game2.svg)",p.ui.gameSizeButton.style.background="url(icons/"+p.game.size+"x"+p.game.size+".svg)",p.ui.gameTemplatesButton.style.backgroundImage="url(icons/"+p.game.template.icon+")",p.ui.gameGrid.innerHTML="";var e=p.ui.gameGrid,t=document.body.clientWidth,a=document.body.clientHeight,i=p.game.cards.length/2,r=a;t<a&&(r=t),r-=228,r/=p.game.size;for(var o=0;o<p.game.cards.length;o++){var n=p.game.cards[o];if(o%p.game.size==0&&o>0)(m=document.createElement("div")).style.clear="both",e.appendChild(m);var d=createFullCardDiv(o,r,n,i),l=createFrontDiv(o,i,r),m=createDiv(o,r,n);d.card=n,d.resultDiv=m;var g="click";("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0)&&(g="touchend"),d.addEventListener(g,onCardClick,!1),d.appendChild(m),d.appendChild(l),e.appendChild(d)}e.style.width=parseInt(r+10)*parseInt(p.game.size+1)+"px",e.style.marginLeft="auto",e.style.marginRight="auto",resizeTextInsideTextCardDivs()}function sendMessage(e){if(p.game.multiplayer){var t=window.top.sugar.environment.sharedId;t||(t=p.presence.getSharedInfo().id),p.presence.sendMessage(t,{user:p.presence.getUserInfo(),content:i.compressToUTF16(JSON.stringify(e))})}}function displayUsersAndScores(){if(0!=p.game.players.length){var e=document.createElement("div"),t=!1;p.game.currentPlayer==p.me.networkId&&(t=!0);var a=document.createElement("div");a.style.float="left",a.style.marginTop="10px",a.style.width="30px",a.style.marginRight="3px",a.style.borderRight="1px solid #fff",a.style.height="30px",a.style.backgroundImage=t?"url(icons/play.svg)":"url(icons/sandclock.svg)",a.style.backgroundPosition="center center",a.style.backgroundRepeat="no-repeat",e.appendChild(a);for(var i=0;i<p.game.players.length;i++){var r=p.game.players[i],o=document.createElement("div");o.style.paddingTop="15px";for(var n=generateXOLogoWithColor(r.colorvalue),d="",s=0;s<r.score;s++)d+='<img style="height:13px;" src="icons/pair-add.svg">';o.innerHTML='<img style="height:23px; vertical-align:middle; " src="'+n+'"><span style="color:#fff;">'+r.name+"</span> "+d,o.style.float="left",0!=i&&(o.style.marginLeft="10px"),e.appendChild(o)}p.ui.gamePlayers.innerHTML="",p.ui.gamePlayers.appendChild(e)}}var y='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>';function generateXOLogoWithColor(e){var t=y;return t=(t=t.replace("#010101",e.stroke)).replace("#FFFFFF",e.fill),"data:image/svg+xml;base64,"+btoa(t)}function generateEditorDiv(e){var t=document.body.clientWidth;t>document.body.clientHeight&&(t=document.body.clientHeight);var a=document.createElement("div");a.style.width=parseInt(t/3.5)+"px",a.style.marginLeft="25px",a.style.float="left",a.style.marginTop="7px";var i=document.createElement("div");i.style.width=parseInt(t/3.5)-10+"px",i.style.height=parseInt(t/3.5)-10+"px",i.style.background="rgb(119, 119, 119)",i.style.border="4px solid #000",i.style.textAlign="center",i.style.borderRadius="9px",i.style.color="#fff",i.style.fontSize=parseInt(t/3.5)-10+"px",i.style.lineHeight=parseInt(t/3.5)-10+"px",i.className="textCard",i.style.backgroundRepeat="no-repeat",i.style.backgroundSize="100%",i.style.backgroundPosition="center",e&&e.text?i.innerHTML=e.text:e&&e.image&&(i.style.backgroundImage="url('"+e.image+"')");var r=document.createElement("img");r.id="InsertImage",r.style.marginLeft="5px",r.style.marginTop="5px",r.style.textAlign="center",r.setAttribute("src","icons/import_picture.svg"),r.style.width="30px",r.className="insertImage";var o=document.createElement("input");return o.id="InputBox",o.setAttribute("type","text"),o.style.marginRight="auto",o.style.marginLeft="auto",o.style.width=parseInt(t/3.5)-50+"px",o.style.marginTop="5px",o.card=e,e&&e.text&&(o.value=e.text),o.linkedDiv=i,o.onkeyup=function(){this.linkedDiv.innerHTML=this.value,this.linkedDiv.style.fontSize=this.linkedDiv.style.width,this.card.text=this.value,resizeTextInsideTextCardDivs()},a.appendChild(i),a.appendChild(o),a.appendChild(r),a}function generateCardFromCardsList(t,a,i){a-=10;var r=document.createElement("div");r.style.display="inline-block",r.style.height=a+"px",r.style.marginLeft="5px",i==p.editor.selectedPair&&(r.style.border="3px solid #00f");var o=document.createElement("div");o.style.backgroundRepeat="no-repeat",o.style.backgroundSize="cover",o.style.backgroundPosition="center center",o.innerHTML="&nbsp;",o.style.backgroundColor="#666",o.className="textCard",t[0].text?(0==t[0].text.indexOf(g)&&(t[0].text=e[t[0].image.slice(g.length)]),o.innerHTML=t[0].text):t[0].image&&(0==t[0].image.indexOf(g)&&(t[0].image=e[t[0].image.slice(g.length)]),o.style.backgroundImage="url('"+t[0].image+"')"),o.style.width=parseInt(a/2)+"px",o.style.height=parseInt(a/2)+"px",o.style.lineHeight=o.style.width+"",o.style.borderRadius="6px",o.style.textAlign="center",o.style.fontSize=parseInt(a/8)+"px",o.style.border="1px solid #000",o.style.color="#fff",o.style.marginBottom="5px";var n=document.createElement("div");return n.style.backgroundRepeat="no-repeat",n.style.backgroundPosition="center center",n.style.backgroundSize="cover",n.innerHTML="&nbsp;",n.style.backgroundColor="#666",n.className="textCard",t[1].text?(0==t[1].text.indexOf(g)&&(t[1].text=e[t[1].image.slice(g.length)]),n.innerHTML=t[1].text):t[1].image&&(0==t[1].image.indexOf(g)&&(t[1].image=e[t[1].image.slice(g.length)]),n.style.backgroundImage="url('"+t[1].image+"')"),n.style.width=parseInt(a/2)+"px",n.style.height=parseInt(a/2)+"px",n.style.textAlign="center",n.style.lineHeight=n.style.width+"",n.style.borderRadius="6px",n.style.fontSize=parseInt(a/8)+"px",n.style.border="1px solid #000",n.style.color="#fff",r.appendChild(o),r.appendChild(n),r}function displayEditor(){p.ui.gameEditor.innerHTML="",p.editor.pairMode==c&&p.ui.gameEditor.appendChild(generateEditorDiv(p.editor.card1)),p.editor.pairMode==m&&(p.ui.gameEditor.appendChild(generateEditorDiv(p.editor.card1)),p.ui.gameEditor.appendChild(generateEditorDiv(p.editor.card2))),function insertimagebuttonsFun(){document.getElementsByClassName("insertImage")[0].onclick=function(){r.show((function(e){e&&new o.DatastoreObject(e.objectId).loadAsText((function(t,a,i){var r=document.createElement("img");"org.olpcfrance.PaintActivity"==e.metadata.activity?r.src=LZString.decompressFromUTF16(JSON.parse(i).src):r.src=i,r.onload=function(){document.getElementsByClassName("textCard")[0].style.backgroundImage="url("+r.src+")",p.editor.pairMode==c?(p.editor.card1.image=r.src,p.editor.card1.text="",p.editor.card2.image=r.src,p.editor.card2.text=""):(p.editor.card1.image=r.src,p.editor.card1.text="");var e=[];p.editor.pairMode==c&&(e[0]=p.editor.card1,e[1]=p.editor.card1),p.editor.pairMode==m&&(e[0]=p.editor.card1,e[1]=p.editor.card2),(e[0].text||e[0].image||e[0].sound)&&(e[1].text||e[1].image||e[1].sound)&&(e=JSON.parse(JSON.stringify(e)),p.editor.selectedPair>-1&&(p.game.template.cards[p.editor.selectedPair]=e),saveGame(),displayEditor())}}))}),{mimetype:"image/png"},{mimetype:"image/jpeg"},{activity:"org.olpcfrance.PaintActivity"})},document.getElementsByClassName("insertImage")[1]&&(document.getElementsByClassName("insertImage")[1].onclick=function(){r.show((function(e){e&&new o.DatastoreObject(e.objectId).loadAsText((function(e,t,a){var i=document.createElement("img");i.src=a,i.onload=function(){document.getElementsByClassName("textCard")[1].style.backgroundImage="url("+i.src+")",p.editor.pairMode==c?(p.editor.card1.image=i.src,p.editor.card1.text="",p.editor.card2.image=i.src,p.editor.card2.text=""):(p.editor.card2.image=i.src,p.editor.card2.text="");var e=[];p.editor.pairMode==c&&(e[0]=p.editor.card1,e[1]=p.editor.card1),p.editor.pairMode==m&&(e[0]=p.editor.card1,e[1]=p.editor.card2),(e[0].text||e[0].image||e[0].sound)&&(e[1].text||e[1].image||e[1].sound)&&(e=JSON.parse(JSON.stringify(e)),p.editor.selectedPair>-1&&(p.game.template.cards[p.editor.selectedPair]=e),saveGame(),displayEditor())}}))}),{mimetype:"image/png"},{mimetype:"image/jpeg"})})}(),p.ui.gameEditor.appendChild(function generateAddEditRemoveButton(){var e=document.createElement("div"),t=document.body.clientWidth;t>document.body.clientHeight&&(t=document.body.clientHeight),e.style.float="right",e.style.height=parseInt(t/3.5)+"px",e.style.marginRight="20px",e.style.marginTop="7px";var a=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div"),o=parseInt(t/3.5/5)+"px";return a.id="EditorAddButton",a.style.padding="5px",a.style.userSelect="none",a.style.webkitUserSelect="none",a.style.mozUserSelect="none",a.innerHTML="<img style='height:"+o+"; width:"+o+";' src='icons/pair-add.svg'><br/>"+p.strings.add,a.onmouseover=function(){this.style.background="#888"},a.onmouseout=function(){this.style.background="transparent"},a.addEventListener("click",(function(){var e=[];p.editor.pairMode==c&&(e[0]=p.editor.card1,e[1]=p.editor.card1),p.editor.pairMode==m&&(e[0]=p.editor.card1,e[1]=p.editor.card2),(e[0].text||e[0].image||e[0].sound)&&(e[1].text||e[1].image||e[1].sound)&&(e=JSON.parse(JSON.stringify(e)),p.editor.card1={},p.editor.card2={},p.game.template.cards.push(e),p.editor.selectedPair=-1,saveGame(),displayEditor())})),i.id="EditorUpdateButton",i.style.padding="5px",i.style.userSelect="none",i.style.webkitUserSelect="none",i.style.mozUserSelect="none",i.innerHTML="<img style='height:"+o+"; width:"+o+";' src='icons/pair-update.svg'><br/>"+p.strings.update,i.onmouseover=function(){this.style.background="#888"},i.onmouseout=function(){this.style.background="transparent"},i.addEventListener("click",(function(){var e=[];p.editor.pairMode==c&&(e[0]=p.editor.card1,e[1]=p.editor.card1),p.editor.pairMode==m&&(e[0]=p.editor.card1,e[1]=p.editor.card2),(e[0].text||e[0].image||e[0].sound)&&(e[1].text||e[1].image||e[1].sound)&&(e=JSON.parse(JSON.stringify(e)),p.editor.selectedPair>-1&&(p.game.template.cards[p.editor.selectedPair]=e),saveGame(),displayEditor())})),r.id="EditorDeleteButton",r.style.padding="5px",r.style.userSelect="none",r.style.webkitUserSelect="none",r.style.mozUserSelect="none",r.innerHTML="<img style='height:"+o+"; width:"+o+";' src='icons/remove.svg'><br/>"+p.strings.remove,r.onmouseover=function(){this.style.background="#888"},r.onmouseout=function(){this.style.background="transparent"},r.addEventListener("click",(function(){p.editor.selectedPair>-1&&p.game.template.cards.splice(p.editor.selectedPair,1),p.editor.selectedPair=-1,p.editor.card1={},p.editor.card2={},saveGame(),displayEditor()})),e.appendChild(a),e.appendChild(i),e.appendChild(r),e}()),p.ui.gameEditor.appendChild(function generateClearBoth(){var e=document.createElement("div");return e.style.clear="both",e}()),p.ui.gameEditor.appendChild(function generateCardsList(){var e=document.createElement("div"),t=document.body.clientWidth;t>document.body.clientHeight&&(t=document.body.clientHeight),e.style.position="fixed",e.style.bottom=0,e.style.width=document.body.clientWidth+"px",e.style.height=parseInt(t/3)+"px",e.style.padding="10px",e.style.paddingBottom="20px",e.style.marginTop="7px",e.style.background="#eee",e.style.overflowX="auto",e.style.whiteSpace="nowrap",e.style.overflowY="hidden";for(var a=0;a<p.game.template.cards.length;a++){var i=p.game.template.cards[a],r=generateCardFromCardsList(i,parseInt(t/3),a);r.cards=i,r.index=a,r.addEventListener("click",(function(){p.editor.selectedPair=this.index,p.editor.pairMode=m,p.editor.card1=this.cards[0],p.editor.card2=this.cards[1],displayEditor()})),e.appendChild(r)}var o=document.createElement("div");return o.style.height=parseInt(t/6)+"px",o.style.width="30px",o.style.display="inline-block",e.appendChild(o),e}()),resizeTextInsideTextCardDivs()}function leaveEditMode(){p.editor.card1={},p.editor.card2={},p.inEditMode=!1,p.ui.gameEditor.innerHTML="",p.ui.gameEditor.style.display="none",p.ui.gameGrid.style.display="block",p.ui.gameTemplatesButton.disabled=!1,p.ui.gameTemplatesButton.style.opacity=1,p.ui.gameSizeButton.disabled=!1,p.ui.gameSizeButton.style.opacity=1,p.ui.gameResetButton.disabled=!1,p.ui.gameResetButton.style.opacity=1,p.ui.gameEditorInsertModeButton.disabled=!0,p.ui.gameEditorInsertModeButton.style.opacity=.3,p.ui.gameEditorPlayModeButton.disabled=!0,p.ui.gameEditorPlayModeButton.style.opacity=.3,p.ui.gameEditorClearButton.disabled=!0,p.ui.gameEditorClearButton.style.opacity=.3,p.ui.gameEditorButton.style.backgroundImage="url(icons/cog.svg)",p.drawGame()}var f={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_arrayBufferToBase64:function(e){for(var t="",a=new Uint8Array(e),i=a.byteLength,r=0;r<i;r++)t+=String.fromCharCode(a[r]);return window.btoa(t)},decodeArrayBuffer:function(e){var t=e.length/4*3,a=new ArrayBuffer(t);return this.decode(e,a),a},removePaddingChars:function(e){return 64==this._keyStr.indexOf(e.charAt(e.length-1))?e.substring(0,e.length-1):e},decode:function(e,t){e=this.removePaddingChars(e),e=this.removePaddingChars(e);var a,i,r,o,n,d,s,l=parseInt(e.length/4*3,10),c=0,m=0;for(a=t?new Uint8Array(t):new Uint8Array(l),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),c=0;c<l;c+=3)i=this._keyStr.indexOf(e.charAt(m++))<<2|(n=this._keyStr.indexOf(e.charAt(m++)))>>4,r=(15&n)<<4|(d=this._keyStr.indexOf(e.charAt(m++)))>>2,o=(3&d)<<6|(s=this._keyStr.indexOf(e.charAt(m++))),a[c]=i,64!=d&&(a[c+1]=r),64!=s&&(a[c+2]=o);return a}};return p}));