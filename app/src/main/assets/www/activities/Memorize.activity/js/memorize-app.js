define(["activity/sample-ressources","activity/palettes/template-palette","activity/palettes/size-palette","activity/lz-string","sugar-web/graphics/journalchooser","sugar-web/datastore","tutorial"],(function(e,t,i,a,n,r,o){var d={name:"Letters",icon:"letters.svg",cards:[[{text:"A"},{text:"a"}],[{text:"B"},{text:"b"}],[{text:"C"},{text:"c"}],[{text:"D"},{text:"d"}],[{text:"E"},{text:"e"}],[{text:"F"},{text:"f"}],[{text:"G"},{text:"g"}],[{text:"H"},{text:"h"}],[{text:"I"},{text:"i"}],[{text:"J"},{text:"j"}],[{text:"K"},{text:"k"}],[{text:"L"},{text:"l"}],[{text:"M"},{text:"m"}],[{text:"N"},{text:"n"}],[{text:"O"},{text:"o"}],[{text:"P"},{text:"p"}],[{text:"Q"},{text:"q"}],[{text:"R"},{text:"r"}],[{text:"S"},{text:"s"}],[{text:"T"},{text:"t"}],[{text:"U"},{text:"u"}],[{text:"V"},{text:"v"}],[{text:"W"},{text:"w"}],[{text:"X"},{text:"x"}],[{text:"Y"},{text:"y"}],[{text:"Z"},{text:"z"}]],mode:"splitted"},s={strings:{add:"Add",update:"Update",remove:"Remove"},ui:{},templates:[{name:"Addition",icon:"addition.svg",cards:[[{text:"3+4"},{text:"7"}],[{text:"5+5"},{text:"10"}],[{text:"5+6"},{text:"11"}],[{text:"4+4"},{text:"8"}],[{text:"4+5"},{text:"9"}],[{text:"3+3"},{text:"6"}],[{text:"2+2"},{text:"4"}],[{text:"1+1"},{text:"2"}],[{text:"1+2"},{text:"3"}],[{text:"9+9"},{text:"18"}],[{text:"10+9"},{text:"19"}],[{text:"8+8"},{text:"16"}],[{text:"8+9"},{text:"17"}],[{text:"7+7"},{text:"14"}],[{text:"7+8"},{text:"15"}],[{text:"6+6"},{text:"12"}]],mode:"splitted"},d,{name:"Sounds",icon:"sounds.svg",cards:[[{image:"#inline#drumkit1_b",sound:"#inline#beat1_a"},{image:"#inline#drumkit1_b",sound:"#inline#beat1_a"}],[{image:"#inline#drumkit2_b",sound:"#inline#beat1_b"},{image:"#inline#drumkit2_b",sound:"#inline#beat1_b"}],[{image:"#inline#drumkit3_b",sound:"#inline#beat1_c"},{image:"#inline#drumkit3_b",sound:"#inline#beat1_c"}],[{image:"#inline#drumkit4_b",sound:"#inline#beat8"},{image:"#inline#drumkit4_b",sound:"#inline#beat8"}],[{image:"#inline#drumkit5_b",sound:"#inline#beat10"},{image:"#inline#drumkit5_b",sound:"#inline#beat10"}],[{image:"#inline#drumkit6_b",sound:"#inline#beat3"},{image:"#inline#drumkit6_b",sound:"#inline#beat3"}],[{image:"#inline#drumkit7_b",sound:"#inline#beat4"},{image:"#inline#drumkit7_b",sound:"#inline#beat4"}],[{image:"#inline#drumkit8_b",sound:"#inline#beat14"},{image:"#inline#drumkit8_b",sound:"#inline#beat14"}],[{image:"#inline#drumkit9_b",sound:"#inline#beat6_2"},{image:"#inline#drumkit9_b",sound:"#inline#beat6_2"}],[{image:"#inline#drumkit10_b",sound:"#inline#beat2"},{image:"#inline#drumkit10_b",sound:"#inline#beat2"}],[{image:"#inline#drumkit11_b",sound:"#inline#beat16"},{image:"#inline#drumkit11_b",sound:"#inline#beat16"}],[{image:"#inline#drumkit12_b",sound:"#inline#beat17"},{image:"#inline#drumkit12_b",sound:"#inline#beat17"}],[{image:"#inline#guitar1_2",sound:"#inline#bending_a"},{image:"#inline#guitar1_2",sound:"#inline#bending_a"}],[{image:"#inline#guitar2_2",sound:"#inline#bending_b"},{image:"#inline#guitar2_2",sound:"#inline#bending_b"}],[{image:"#inline#guitar3_2",sound:"#inline#flashcomp2a"},{image:"#inline#guitar3_2",sound:"#inline#flashcomp2a"}],[{image:"#inline#guitar4_2",sound:"#inline#flashcomp2b"},{image:"#inline#guitar4_2",sound:"#inline#flashcomp2b"}],[{image:"#inline#guitar5_2",sound:"#inline#gedaempft"},{image:"#inline#guitar5_2",sound:"#inline#gedaempft"}],[{image:"#inline#guitar6_2",sound:"#inline#ungedaempft"},{image:"#inline#guitar6_2",sound:"#inline#ungedaempft"}],[{image:"#inline#guitar7_2",sound:"#inline#jimi4"},{image:"#inline#guitar7_2",sound:"#inline#jimi4"}],[{image:"#inline#guitar8_2",sound:"#inline#git_hit1"},{image:"#inline#guitar8_2",sound:"#inline#git_hit1"}],[{image:"#inline#guitar9_2",sound:"#inline#git_hit4"},{image:"#inline#guitar9_2",sound:"#inline#git_hit4"}],[{image:"#inline#guitar10_2",sound:"#inline#jimi1"},{image:"#inline#guitar10_2",sound:"#inline#jimi1"}],[{image:"#inline#guitar11_2",sound:"#inline#flasholet4"},{image:"#inline#guitar11_2",sound:"#inline#flasholet4"}],[{image:"#inline#guitar12_2",sound:"#inline#guitcello"},{image:"#inline#guitar12_2",sound:"#inline#guitcello"}]],mode:"classic"}],isHost:!1,editor:{pairMode:"equal",card1:{},card2:{},selectedPair:-1},game:{template:d,multiplayer:!1,selectedCards:[],mode:void 0,cards:[],currentPlayer:"",players:[],size:4},computeCards:function computeCards(e){if(s.game.cards=[],s.game.selectedCards=[],!s.game.template)return;s.game.mode=s.game.template.mode;var t={name:s.game.template.name,cards:[]};t.cards=JSON.parse(JSON.stringify(shuffle(s.game.template.cards)));var i=0;i=s.game.size%2==0?s.game.size*s.game.size:s.game.size*s.game.size-2;if("classic"==s.game.mode){for(var a=[],n=0;n<t.cards.length&&n<i/2;n++){var r=t.cards[n][0],o=t.cards[n][1];r.id=n,o.id=n,a.push(r),a.push(o)}s.game.cards=shuffle(a)}if("splitted"==s.game.mode){var d=[],l=[];for(n=0;n<i/2&&n<t.cards.length;n++){r=t.cards[n][0],o=t.cards[n][1];r.id=n,o.id=n,d.push(r),l.push(o)}var c=shuffle(d);for(n=0;n<c.length;n++)s.game.cards.push(c[n]);var m=shuffle(l);for(n=0;n<m.length;n++)s.game.cards.push(m[n])}e||saveGame()},inEditMode:!1,shareActivity:function shareActivity(e){if(!s.presence.isConnected())return;s.inEditMode=!1,leaveEditMode(),function disableEditMode(){s.ui.gameEditorButton.disabled=!0,s.ui.gameEditorButton.style.opacity=.3,s.ui.gameEditorButton.style.backgroundImage="url(icons/cog.svg)",s.ui.gameEditorInsertModeButton.disabled=!0,s.ui.gameEditorInsertModeButton.style.opacity=.3,s.ui.gameEditorPlayModeButton.disabled=!0,s.ui.gameEditorPlayModeButton.style.opacity=.3,s.ui.gameEditorClearButton.disabled=!0,s.ui.gameEditorClearButton.style.opacity=.3}(),s.game.multiplayer=!0,s.isHost=e,s.me=s.presence.userInfo,s.game.currentPlayer=s.me.networkId,s.ui.gamePlayers.style.display="block"},initUI:function initUI(e){s.ui.gameGrid=document.getElementById("game-grid"),s.ui.gamePlayers=document.getElementById("game-players"),s.ui.gameEditor=document.getElementById("game-editor"),s.ui.gameTemplatesButton=document.getElementById("game-templates-button"),new t.TemplatePalette(s.ui.gameTemplatesButton,void 0,s.templates).addEventListener("template",(function(e){for(var t=0;t<s.game.players.length;t++)s.game.players[t].score=0;s.game.template=e.detail.value,s.ui.gameTemplatesButton.style.backgroundImage="url(icons/"+e.detail.value.icon+")",s.computeCards(),s.drawGame(),sendMessage({action:"updateGame",game:s.game})})),s.ui.gameSizeButton=document.getElementById("game-size-button"),new i.SizePalette(s.ui.gameSizeButton).addEventListener("size",(function(e){for(var t=0;t<s.game.players.length;t++)s.game.players[t].score=0;s.game.size=e.detail.value,s.ui.gameSizeButton.style.background="url(icons/"+e.detail.value+"x"+e.detail.value+".svg)",s.computeCards(),s.drawGame(),sendMessage({action:"updateGame",game:s.game})})),s.ui.gameResetButton=document.getElementById("game-reset-button"),s.ui.gameResetButton.addEventListener("click",(function(){for(var e=0;e<s.game.players.length;e++)s.game.players[e].score=0;s.game.selectedCards=[],s.game.cards=[],displayUsersAndScores(),s.computeCards(),s.drawGame(),sendMessage({action:"updateGame",game:s.game})})),s.ui.gameEditorButton=document.getElementById("game-editor-button"),s.ui.gameEditorInsertModeButton=document.getElementById("game-editor-insert-mode-button"),s.ui.gameEditorPlayModeButton=document.getElementById("game-editor-play-mode-button"),s.ui.gameEditorPlayModeButton.addEventListener("click",(function(){"classic"==s.game.template.mode?(s.game.template.mode="splitted",s.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game2.svg)"):(s.game.template.mode="classic",s.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game1.svg)"),saveGame(),displayEditor()})),s.ui.gameEditorClearButton=document.getElementById("game-editor-clear-button"),s.ui.gameEditorInsertModeButton.addEventListener("click",(function(){"equal"==s.editor.pairMode?(s.editor.pairMode="non_equal",s.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-non-equals.svg)"):(s.editor.pairMode="equal",s.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-equals.svg)"),saveGame(),displayEditor()})),s.ui.gameEditorClearButton.addEventListener("click",(function(){s.game.template.cards=[],saveGame(),displayEditor()})),s.ui.gameEditorButton.addEventListener("click",(function(){s.inEditMode?leaveEditMode():function enterEditMode(){s.inEditMode=!0,s.ui.gameGrid.innerHTML="",s.ui.gameGrid.style.display="none",s.ui.gameEditor.style.display="block",s.game.selectedCards=[],s.editor.selectedPair=-1,s.ui.gameTemplatesButton.disabled=!0,s.ui.gameTemplatesButton.style.opacity=.3,s.ui.gameSizeButton.disabled=!0,s.ui.gameSizeButton.style.opacity=.3,s.ui.gameResetButton.disabled=!0,s.ui.gameResetButton.style.opacity=.3,s.ui.gameEditorInsertModeButton.disabled=!1,s.ui.gameEditorInsertModeButton.style.opacity=1,s.ui.gameEditorPlayModeButton.disabled=!1,s.ui.gameEditorPlayModeButton.style.opacity=1,s.ui.gameEditorClearButton.disabled=!1,s.ui.gameEditorClearButton.style.opacity=1,s.ui.gameEditorButton.style.backgroundImage="url(icons/play.svg)",displayEditor()}()})),s.ui.tutorialButton=document.getElementById("help-button"),s.ui.tutorialButton.addEventListener("click",(function(){Object.keys(s.game.cards[0]);var e="splitted"==s.game.template.mode?1:2;s.inEditMode?o.startEditorTutorial():o.startMainTutorial(e)})),s.ui.gameEditorInsertModeButton.disabled=!0,s.ui.gameEditorInsertModeButton.style.opacity=.3,s.ui.gameEditorPlayModeButton.disabled=!0,s.ui.gameEditorPlayModeButton.style.opacity=.3,s.ui.gameEditorClearButton.disabled=!0,s.ui.gameEditorClearButton.style.opacity=.3,window.onresize=function(){setTimeout((function(){s.inEditMode?displayEditor():s.drawGame()}),250)},e&&e()},drawGame:drawGame,onUsersListChanged:function onUsersListChanged(e){for(var t=0;t<s.game.players.length;t++)s.game.players[t].online=!1;if(!s.hasLoadedMultiplayer&&e.length>=3)return void document.getElementById("stop-button").click();if(s.hasLoadedMultiplayer=!0,s.game.players=[],1==e.length)return s.isHost=!0,s.game.currentPlayer=s.me.networkId,s.game.selectedCards=[],s.game.players.push(e[0]),s.game.players[0].online=!0,s.game.players[0].score=0,drawGame(),void displayUsersAndScores();for(t=0;t<e.length;t++){for(var i=!1,a=0;a<s.game.players.length;a++)if(s.game.players[a].networkId==e[t].networkId){s.game.players[a].online=!0,i=!0;break}if(!i){var n=e[t];n.score=0,n.online=!0,s.game.players.push(n)}}s.isHost&&sendMessage({action:"updateGame",game:s.game});displayUsersAndScores()},onDataReceived:function onDataReceived(e){if(e.user.networkId==s.me.networkId)return;e.content=JSON.parse(a.decompressFromUTF16(e.content)),"updateCurrentPlayer"==e.content.action&&(s.game.currentPlayer=e.content.currentPlayer,displayUsersAndScores());"updateGame"==e.content.action&&(s.game=e.content.game,s.ui.gameSizeButton.style.background="url(icons/"+s.game.size+"x"+s.game.size+".svg)",s.ui.gameTemplatesButton.style.backgroundImage="url(icons/"+s.game.template.icon+")",s.drawGame(),displayUsersAndScores(),saveGame());if("cardClick"==e.content.action){for(var t=s.ui.gameGrid.childNodes,i=[],n=0;n<t.length;n++)t[n].style.clear&&""!=t[n].style.clear||i.push(t[n]);for(n=0;n<s.game.players.length;n++)s.game.players[n].networkId==e.user.networkId&&cardClick(i[e.content.position],!1,s.game.players[n])}}};function shuffle(e){for(var t,i,a=e.length;0!==a;)i=Math.floor(Math.random()*a),t=e[a-=1],e[a]=e[i],e[i]=t;return e}function resizeTextInsideTextCardDivs(){for(var e=document.getElementsByClassName("textCard"),t=0;t<e.length;t++){for(var i=e[t];i.scrollHeight>i.offsetHeight;)i.style.fontSize=parseInt(i.style.fontSize)-1+"px";for(;i.scrollWidth>i.offsetWidth;)i.style.fontSize=parseInt(i.style.fontSize)-1+"px"}}function createFullCardDiv(e,t,i,a){var n=document.createElement("div");return n.cardPosition=e,n.webkitPerspective="500px",n.perspective="500px",n.style.border="3px solid #fff",n.style.borderRadius="6px",n.style.margin="3px",n.style.webkitTransition="transform 0.5s",n.style.transition="transform 0.5s","splitted"==s.game.template.mode?n.id=e<a?"numberOneTutorial":"numberTwoTutorial":e===a-2?n.id="soundTutorial":e===a+2&&(n.id="soundTutorial2"),n.style.transitionDuration="0.5s",n.style.webkitTransitionDuration="0.5s",n.style.transformStyle="preserve-3d",n.style.webkitTransformStyle="preserve-3d",n.style.position="relative",n.style.float="left",n.style.height=t+"px",n.style.width=t+"px",i.solved?(n.style.webkitTransform="rotateY(180deg)",n.style.transform="rotateY(180deg)"):(n.style.webkitTransform="",n.style.transform=""),0!=s.game.selectedCards.length&&s.game.selectedCards[0].cardPosition==n.cardPosition&&(n.style.webkitTransform="",n.style.transform=""),n}function createFrontDiv(e,t,i){var a=document.createElement("div");return"classic"==s.game.mode&&(a.style.background="#777"),"splitted"==s.game.mode&&(a.style.background=e<t?"#777 url(icons/number1.svg)":"#777 url(icons/number2.svg)"),a.zIndex=2,a.style.borderRadius="6px",a.style.webkitBackfaceVisibility="hidden",a.style.backfaceVisibility="hidden",a.style.backgroundPosition="center center",a.style.backgroundRepeat="no-repeat",a.style.height=i+"px",a.style.position="absolute",a.style.top="0px",a.style.left="0px",a.style.width=i+"px",a}function createDiv(t,i,a){var n=document.createElement("div"),r=function generateCardDiv(t,i){var a;return t.image?(0==t.image.indexOf("#inline#")&&(t.image=e[t.image.slice("#inline#".length)]),(a=document.createElement("div")).style.background="url('"+t.image+"')",a.style.backgroundRepeat="no-repeat",a.style.backgroundSize="contain",a.style.webkitBackgroundSize="contain",a.style.backgroundPosition="center center",a.style.height=i+"px",a.style.width=i+"px",a):t.text?(0==t.text.indexOf("#inline#")&&(t.text=e[t.text.slice("#inline#".length)]),(a=document.createElement("div")).className="textCard",a.style.textAlign="center",a.style.display="block",a.innerHTML=t.text,a.style.lineHeight=i+"px",a.style.fontSize=i+"px",a.style.color="#000",a.style.width=i+"px",a.style.height=i+"px",a):void 0}(s.game.cards[t],i);return n.appendChild(r),n.style.height=i+"px",n.style.webkitBackfaceVisibility="hidden",n.style.backfaceVisibility="hidden",n.style.mozBackfaceVisibility="hidden",n.style.position="absolute",n.style.webkitTransform="rotateY(180deg)",n.style.transform="rotateY(180deg)",n.style.top="0px",n.style.left="0px",n.style.borderRadius="6px",n.style.width=i+"px",n.style.background="#fff",a.solved&&(n.style.backgroundColor="#84f060"),n}function cardClick(t,i,a){var n=s.game.cards.length/2;!function createAudioContextIfMissing(){if(!s.context){var e=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;if(e){e=new e,s.context=e;var t=e.createBuffer(1,1,22050),i=e.createBufferSource();s.source=i,i.buffer=t,i.connect(e.destination),i.start(0)}}}();var r=t;if(!r.card.solved&&2!=s.game.selectedCards.length){if("splitted"==s.game.mode&&1==s.game.selectedCards.length){if(r.cardPosition<n&&s.game.selectedCards[0].cardPosition<n)return;if(r.cardPosition>=n&&s.game.selectedCards[0].cardPosition>=n)return}if(r.style.webkitTransform="rotateY(180deg)",r.style.transform="rotateY(180deg)",1!=s.game.selectedCards.length||s.game.selectedCards[0]!=r){if(s.game.selectedCards.push(r),r.card.sound){0==r.card.sound.indexOf("#inline#")&&(r.card.sound=e[r.card.sound.slice("#inline#".length)]);var o=r.card.sound.split("base64,")[1];o=l.decodeArrayBuffer(btoa(atob(o))),s.context&&s.context.decodeAudioData(o,(function(e){var t=s.context.createBufferSource();if(s.source)try{s.source.stop(0)}catch(e){}s.source=t,t.buffer=e,t.connect(s.context.destination);try{t.start(0)}catch(e){}}),(function(e){console.log("err(decodeAudioData): "+e)}))}if(1!=s.game.selectedCards.length){if(s.game.selectedCards[0].card.id==r.card.id){if(s.game.selectedCards[0].card.solved=!0,r.card.solved=!0,1==s.game.players.length)s.game.players[0].score=s.game.players[0].score+1;else for(var d=0;d<s.game.players.length;d++)s.game.players[d].networkId==a.networkId&&(s.game.players[d].score=s.game.players[d].score+1);displayUsersAndScores();var c=s.game.selectedCards[0].resultDiv,m=r.resultDiv;return setTimeout((function(){c.style.backgroundColor="#84f060",m.style.backgroundColor="#84f060"}),1e3),s.game.selectedCards=[],void saveGame()}s.game.currentPlayer="",setTimeout((function(){try{r.style.webkitTransform="",r.style.transform="",s.game.selectedCards[0].style.webkitTransform="",s.game.selectedCards[0].style.transform="",s.game.selectedCards=[],setTimeout((function(){if(i)for(var e=0;e<s.game.players.length;e++){if(s.game.players[e].online&&s.game.players[e].networkId!=s.me.networkId){s.game.currentPlayer=s.game.players[e].networkId,sendMessage({action:"updateCurrentPlayer",currentPlayer:s.game.currentPlayer}),displayUsersAndScores();break}s.game.currentPlayer=s.game.players[0].networkId}}),300)}catch(e){}}),2e3)}}}}function saveGame(){s.activity.getDatastoreObject().setDataAsText(JSON.stringify({game:s.game})),s.activity.getDatastoreObject().save((function(e,t){}))}function onCardClick(){if(s.game.multiplayer){if(s.game.currentPlayer!=s.me.networkId)return;sendMessage({action:"cardClick",position:this.cardPosition}),0!=s.game.players.length&&1!=s.game.players.length||cardClick(this,!0);for(var e=0;e<s.game.players.length;e++)s.game.players[e].networkId==s.me.networkId&&cardClick(this,!0,s.game.players[e])}else cardClick(this,!0)}function drawGame(){"equal"==s.editor.pairMode?s.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-non-equals.svg)":s.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-equals.svg)","classic"==s.game.template.mode?s.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game1.svg)":s.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game2.svg)",s.ui.gameSizeButton.style.background="url(icons/"+s.game.size+"x"+s.game.size+".svg)",s.ui.gameTemplatesButton.style.backgroundImage="url(icons/"+s.game.template.icon+")",s.ui.gameGrid.innerHTML="";var e=s.ui.gameGrid,t=document.body.clientWidth,i=document.body.clientHeight,a=s.game.cards.length/2,n=i;t<i&&(n=t),n-=228,n/=s.game.size;for(var r=0;r<s.game.cards.length;r++){var o=s.game.cards[r];if(r%s.game.size==0&&r>0)(c=document.createElement("div")).style.clear="both",e.appendChild(c);var d=createFullCardDiv(r,n,o,a),l=createFrontDiv(r,a,n),c=createDiv(r,n,o);d.card=o,d.resultDiv=c;var m="click";"ontouchstart"in document.documentElement&&(m="touchend"),d.addEventListener(m,onCardClick,!1),d.appendChild(c),d.appendChild(l),e.appendChild(d)}e.style.width=parseInt(n+10)*parseInt(s.game.size+1)+"px",e.style.marginLeft="auto",e.style.marginRight="auto",resizeTextInsideTextCardDivs()}function sendMessage(e){if(s.game.multiplayer){var t=window.top.sugar.environment.sharedId;t||(t=s.presence.getSharedInfo().id),s.presence.sendMessage(t,{user:s.presence.getUserInfo(),content:a.compressToUTF16(JSON.stringify(e))})}}function displayUsersAndScores(){if(0!=s.game.players.length){var e=document.createElement("div"),t=!1;s.game.currentPlayer==s.me.networkId&&(t=!0);var i=document.createElement("div");i.style.float="left",i.style.marginTop="10px",i.style.width="30px",i.style.marginRight="3px",i.style.borderRight="1px solid #fff",i.style.height="30px",i.style.backgroundImage=t?"url(icons/play.svg)":"url(icons/sandclock.svg)",i.style.backgroundPosition="center center",i.style.backgroundRepeat="no-repeat",e.appendChild(i);for(var a=0;a<s.game.players.length;a++){var n=s.game.players[a],r=document.createElement("div");r.style.paddingTop="15px";for(var o=generateXOLogoWithColor(n.colorvalue),d="",l=0;l<n.score;l++)d+='<img style="height:13px;" src="icons/pair-add.svg">';r.innerHTML='<img style="height:23px; vertical-align:middle; " src="'+o+'"><span style="color:#fff;">'+n.name+"</span> "+d,r.style.float="left",0!=a&&(r.style.marginLeft="10px"),e.appendChild(r)}s.ui.gamePlayers.innerHTML="",s.ui.gamePlayers.appendChild(e)}}function generateXOLogoWithColor(e){var t='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>';return t=(t=t.replace("#010101",e.stroke)).replace("#FFFFFF",e.fill),"data:image/svg+xml;base64,"+btoa(t)}function generateEditorDiv(e){var t=document.body.clientWidth;t>document.body.clientHeight&&(t=document.body.clientHeight);var i=document.createElement("div");i.style.width=parseInt(t/3.5)+"px",i.style.marginLeft="25px",i.style.float="left",i.style.marginTop="7px";var a=document.createElement("div");a.style.width=parseInt(t/3.5)-10+"px",a.style.height=parseInt(t/3.5)-10+"px",a.style.background="rgb(119, 119, 119)",a.style.border="4px solid #000",a.style.textAlign="center",a.style.borderRadius="9px",a.style.color="#fff",a.style.fontSize=parseInt(t/3.5)-10+"px",a.style.lineHeight=parseInt(t/3.5)-10+"px",a.className="textCard",a.style.backgroundRepeat="no-repeat",a.style.backgroundSize="100%",a.style.backgroundPosition="center",e&&e.text?a.innerHTML=e.text:e&&e.image&&(a.style.backgroundImage="url('"+e.image+"')");var n=document.createElement("img");n.id="InsertImage",n.style.marginLeft="5px",n.style.marginTop="5px",n.style.textAlign="center",n.setAttribute("src","icons/import_picture.svg"),n.style.width="30px",n.className="insertImage";var r=document.createElement("input");return r.id="InputBox",r.setAttribute("type","text"),r.style.marginRight="auto",r.style.marginLeft="auto",r.style.width=parseInt(t/3.5)-50+"px",r.style.marginTop="5px",r.card=e,e&&e.text&&(r.value=e.text),r.linkedDiv=a,r.onkeyup=function(){this.linkedDiv.innerHTML=this.value,this.linkedDiv.style.fontSize=this.linkedDiv.style.width,this.card.text=this.value,resizeTextInsideTextCardDivs()},i.appendChild(a),i.appendChild(r),i.appendChild(n),i}function generateCardFromCardsList(t,i,a){i-=10;var n=document.createElement("div");n.style.display="inline-block",n.style.height=i+"px",n.style.marginLeft="5px",a==s.editor.selectedPair&&(n.style.border="3px solid #00f");var r=document.createElement("div");r.style.backgroundRepeat="no-repeat",r.style.backgroundSize="cover",r.style.backgroundPosition="center center",r.innerHTML="&nbsp;",r.style.backgroundColor="#666",r.className="textCard",t[0].text?(0==t[0].text.indexOf("#inline#")&&(t[0].text=e[t[0].image.slice("#inline#".length)]),r.innerHTML=t[0].text):t[0].image&&(0==t[0].image.indexOf("#inline#")&&(t[0].image=e[t[0].image.slice("#inline#".length)]),r.style.backgroundImage="url('"+t[0].image+"')"),r.style.width=parseInt(i/2)+"px",r.style.height=parseInt(i/2)+"px",r.style.lineHeight=r.style.width+"",r.style.borderRadius="6px",r.style.textAlign="center",r.style.fontSize=parseInt(i/8)+"px",r.style.border="1px solid #000",r.style.color="#fff",r.style.marginBottom="5px";var o=document.createElement("div");return o.style.backgroundRepeat="no-repeat",o.style.backgroundPosition="center center",o.style.backgroundSize="cover",o.innerHTML="&nbsp;",o.style.backgroundColor="#666",o.className="textCard",t[1].text?(0==t[1].text.indexOf("#inline#")&&(t[1].text=e[t[1].image.slice("#inline#".length)]),o.innerHTML=t[1].text):t[1].image&&(0==t[1].image.indexOf("#inline#")&&(t[1].image=e[t[1].image.slice("#inline#".length)]),o.style.backgroundImage="url('"+t[1].image+"')"),o.style.width=parseInt(i/2)+"px",o.style.height=parseInt(i/2)+"px",o.style.textAlign="center",o.style.lineHeight=o.style.width+"",o.style.borderRadius="6px",o.style.fontSize=parseInt(i/8)+"px",o.style.border="1px solid #000",o.style.color="#fff",n.appendChild(r),n.appendChild(o),n}function displayEditor(){s.ui.gameEditor.innerHTML="","equal"==s.editor.pairMode&&s.ui.gameEditor.appendChild(generateEditorDiv(s.editor.card1)),"non_equal"==s.editor.pairMode&&(s.ui.gameEditor.appendChild(generateEditorDiv(s.editor.card1)),s.ui.gameEditor.appendChild(generateEditorDiv(s.editor.card2))),function insertimagebuttonsFun(){document.getElementsByClassName("insertImage")[0].onclick=function(){n.show((function(e){e&&new r.DatastoreObject(e.objectId).loadAsText((function(t,i,a){var n=document.createElement("img");"org.olpcfrance.PaintActivity"==e.metadata.activity?n.src=LZString.decompressFromUTF16(JSON.parse(a).src):n.src=a,n.onload=function(){document.getElementsByClassName("textCard")[0].style.backgroundImage="url("+n.src+")","equal"==s.editor.pairMode?(s.editor.card1.image=n.src,s.editor.card1.text="",s.editor.card2.image=n.src,s.editor.card2.text=""):(s.editor.card1.image=n.src,s.editor.card1.text="");var e=[];"equal"==s.editor.pairMode&&(e[0]=s.editor.card1,e[1]=s.editor.card1),"non_equal"==s.editor.pairMode&&(e[0]=s.editor.card1,e[1]=s.editor.card2),(e[0].text||e[0].image||e[0].sound)&&(e[1].text||e[1].image||e[1].sound)&&(e=JSON.parse(JSON.stringify(e)),s.editor.selectedPair>-1&&(s.game.template.cards[s.editor.selectedPair]=e),saveGame(),displayEditor())}}))}),{mimetype:"image/png"},{mimetype:"image/jpeg"},{activity:"org.olpcfrance.PaintActivity"})},document.getElementsByClassName("insertImage")[1]&&(document.getElementsByClassName("insertImage")[1].onclick=function(){n.show((function(e){e&&new r.DatastoreObject(e.objectId).loadAsText((function(e,t,i){var a=document.createElement("img");a.src=i,a.onload=function(){document.getElementsByClassName("textCard")[1].style.backgroundImage="url("+a.src+")","equal"==s.editor.pairMode?(s.editor.card1.image=a.src,s.editor.card1.text="",s.editor.card2.image=a.src,s.editor.card2.text=""):(s.editor.card2.image=a.src,s.editor.card2.text="");var e=[];"equal"==s.editor.pairMode&&(e[0]=s.editor.card1,e[1]=s.editor.card1),"non_equal"==s.editor.pairMode&&(e[0]=s.editor.card1,e[1]=s.editor.card2),(e[0].text||e[0].image||e[0].sound)&&(e[1].text||e[1].image||e[1].sound)&&(e=JSON.parse(JSON.stringify(e)),s.editor.selectedPair>-1&&(s.game.template.cards[s.editor.selectedPair]=e),saveGame(),displayEditor())}}))}),{mimetype:"image/png"},{mimetype:"image/jpeg"})})}(),s.ui.gameEditor.appendChild(function generateAddEditRemoveButton(){var e=document.createElement("div"),t=document.body.clientWidth;t>document.body.clientHeight&&(t=document.body.clientHeight),e.style.float="right",e.style.height=parseInt(t/3.5)+"px",e.style.marginRight="20px",e.style.marginTop="7px";var i=document.createElement("div"),a=document.createElement("div"),n=document.createElement("div"),r=parseInt(t/3.5/5)+"px";return i.id="EditorAddButton",i.style.padding="5px",i.style.userSelect="none",i.style.webkitUserSelect="none",i.style.mozUserSelect="none",i.innerHTML="<img style='height:"+r+"; width:"+r+";' src='icons/pair-add.svg'><br/>"+s.strings.add,i.onmouseover=function(){this.style.background="#888"},i.onmouseout=function(){this.style.background="transparent"},i.addEventListener("click",(function(){var e=[];"equal"==s.editor.pairMode&&(e[0]=s.editor.card1,e[1]=s.editor.card1),"non_equal"==s.editor.pairMode&&(e[0]=s.editor.card1,e[1]=s.editor.card2),(e[0].text||e[0].image||e[0].sound)&&(e[1].text||e[1].image||e[1].sound)&&(e=JSON.parse(JSON.stringify(e)),s.editor.card1={},s.editor.card2={},s.game.template.cards.push(e),s.editor.selectedPair=-1,saveGame(),displayEditor())})),a.id="EditorUpdateButton",a.style.padding="5px",a.style.userSelect="none",a.style.webkitUserSelect="none",a.style.mozUserSelect="none",a.innerHTML="<img style='height:"+r+"; width:"+r+";' src='icons/pair-update.svg'><br/>"+s.strings.update,a.onmouseover=function(){this.style.background="#888"},a.onmouseout=function(){this.style.background="transparent"},a.addEventListener("click",(function(){var e=[];"equal"==s.editor.pairMode&&(e[0]=s.editor.card1,e[1]=s.editor.card1),"non_equal"==s.editor.pairMode&&(e[0]=s.editor.card1,e[1]=s.editor.card2),(e[0].text||e[0].image||e[0].sound)&&(e[1].text||e[1].image||e[1].sound)&&(e=JSON.parse(JSON.stringify(e)),s.editor.selectedPair>-1&&(s.game.template.cards[s.editor.selectedPair]=e),saveGame(),displayEditor())})),n.id="EditorDeleteButton",n.style.padding="5px",n.style.userSelect="none",n.style.webkitUserSelect="none",n.style.mozUserSelect="none",n.innerHTML="<img style='height:"+r+"; width:"+r+";' src='icons/remove.svg'><br/>"+s.strings.remove,n.onmouseover=function(){this.style.background="#888"},n.onmouseout=function(){this.style.background="transparent"},n.addEventListener("click",(function(){s.editor.selectedPair>-1&&s.game.template.cards.splice(s.editor.selectedPair,1),s.editor.selectedPair=-1,s.editor.card1={},s.editor.card2={},saveGame(),displayEditor()})),e.appendChild(i),e.appendChild(a),e.appendChild(n),e}()),s.ui.gameEditor.appendChild(function generateClearBoth(){var e=document.createElement("div");return e.style.clear="both",e}()),s.ui.gameEditor.appendChild(function generateCardsList(){var e=document.createElement("div"),t=document.body.clientWidth;t>document.body.clientHeight&&(t=document.body.clientHeight),e.style.position="fixed",e.style.bottom=0,e.style.width=document.body.clientWidth+"px",e.style.height=parseInt(t/3)+"px",e.style.padding="10px",e.style.paddingBottom="20px",e.style.marginTop="7px",e.style.background="#eee",e.style.overflowX="auto",e.style.whiteSpace="nowrap",e.style.overflowY="hidden";for(var i=0;i<s.game.template.cards.length;i++){var a=s.game.template.cards[i],n=generateCardFromCardsList(a,parseInt(t/3),i);n.cards=a,n.index=i,n.addEventListener("click",(function(){s.editor.selectedPair=this.index,s.editor.pairMode="non_equal",s.editor.card1=this.cards[0],s.editor.card2=this.cards[1],displayEditor()})),e.appendChild(n)}var r=document.createElement("div");return r.style.height=parseInt(t/6)+"px",r.style.width="30px",r.style.display="inline-block",e.appendChild(r),e}()),resizeTextInsideTextCardDivs()}function leaveEditMode(){s.editor.card1={},s.editor.card2={},s.inEditMode=!1,s.ui.gameEditor.innerHTML="",s.ui.gameEditor.style.display="none",s.ui.gameGrid.style.display="block",s.ui.gameTemplatesButton.disabled=!1,s.ui.gameTemplatesButton.style.opacity=1,s.ui.gameSizeButton.disabled=!1,s.ui.gameSizeButton.style.opacity=1,s.ui.gameResetButton.disabled=!1,s.ui.gameResetButton.style.opacity=1,s.ui.gameEditorInsertModeButton.disabled=!0,s.ui.gameEditorInsertModeButton.style.opacity=.3,s.ui.gameEditorPlayModeButton.disabled=!0,s.ui.gameEditorPlayModeButton.style.opacity=.3,s.ui.gameEditorClearButton.disabled=!0,s.ui.gameEditorClearButton.style.opacity=.3,s.ui.gameEditorButton.style.backgroundImage="url(icons/cog.svg)",s.drawGame()}var l={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_arrayBufferToBase64:function(e){for(var t="",i=new Uint8Array(e),a=i.byteLength,n=0;n<a;n++)t+=String.fromCharCode(i[n]);return window.btoa(t)},decodeArrayBuffer:function(e){var t=e.length/4*3,i=new ArrayBuffer(t);return this.decode(e,i),i},removePaddingChars:function(e){return 64==this._keyStr.indexOf(e.charAt(e.length-1))?e.substring(0,e.length-1):e},decode:function(e,t){e=this.removePaddingChars(e),e=this.removePaddingChars(e);var i,a,n,r,o,d,s,l=parseInt(e.length/4*3,10),c=0,m=0;for(i=t?new Uint8Array(t):new Uint8Array(l),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),c=0;c<l;c+=3)a=this._keyStr.indexOf(e.charAt(m++))<<2|(o=this._keyStr.indexOf(e.charAt(m++)))>>4,n=(15&o)<<4|(d=this._keyStr.indexOf(e.charAt(m++)))>>2,r=(3&d)<<6|(s=this._keyStr.indexOf(e.charAt(m++))),i[c]=a,64!=d&&(i[c+1]=n),64!=s&&(i[c+2]=r);return i}};return s}));