define(["activity/ol","util","print","l10n","flag"],(function(e,t,r,n,o){var a={};a.popup=document.createElement("div"),a.popup.id="popup",a.test=function(){return"ColorMyWorld"},a.currents=[],a.collective_bbox=[],a.current_feature=null,a.last_timeout=null,a.mode=COLORING,a.DELAY=1500,a.RUNNING=!1,a.saveStateCB=function(){r("saveStateCB");var e={};return e.currents=a.currents,e.lang=n.getLanguage(),e.mode=a.mode,e.cmw_bg=a.background_color,e.features=a.loopOverAllFeatures("get",{}),JSON.stringify(e)},a.loopOverAllFeatures=function(t,n){r("loopOverAllFeatures:"+t),r("loopOverAllFeatures:"+n);for(var o=a.CATEGORIES.keys,l=0;l<o.length;l++)for(var u=o[l],i=a.CATEGORIES[u].keys,s=0;s<i.length;s++){var c=i[s];r("loopOverAllFeatures.layer_names: "+c);var g=a.CATEGORIES[u][c].source.getFeatures();r("features: "+g),r("features.length: "+g.length);for(var d=0;d<g.length;d++){var p=null;if((p=g[d].get("Name"))||(p=g[d].get("NAME")),p||(p=g[d].get("name")),r("loopOverAllFeatures.features: "+p),"get"==t){r("GET "+p);var f=a.CATEGORIES[u][c].features[p];INSTALLED[u].polygon_sources[0].fill;n[p]={candidate:f.candidate,stroke_color:INSTALLED[u].polygon_sources[0].color,stroke_width:INSTALLED[u].polygon_sources[0].width,fill_color:INSTALLED[u].polygon_sources[0].fill},f.feature.getStyle()&&(r(p+" stroke_color="+f.feature.getStyle().getStroke().getColor()),r(p+" stroke_width="+f.feature.getStyle().getStroke().getWidth()),r(p+" fill_color="+f.feature.getStyle().getFill().getColor()),n[p].stroke_color=f.feature.getStyle().getStroke().getColor(),n[p].stroke_width=f.feature.getStyle().getStroke().getWidth(),n[p].fill_color=f.feature.getStyle().getFill().getColor())}else if("set"==t){r("SET "+p);f=n[p];a.CATEGORIES[u][c].features[p].candidate=f.candidate;var m=new e.style.Style({fill:new e.style.Fill({color:f.fill_color}),stroke:new e.style.Stroke({color:f.stroke_color,width:f.stroke_width})});a.CATEGORIES[u][c].features[p].feature.setStyle(m)}}}return n},a.sleep=function(e){return new Promise((function(t){setTimeout(t,e)}))},a.loadStateCB=function(e){r("loadStateCB");var t=null;if(null!=e&&(t=JSON.parse(e)),t){r("Loading: "+t),a.currents=t.currents;for(var n=0;n<t.currents.length;n++)a.change_areaCB(1,t.currents[n]);var o=a.getRegion();document.getElementById("regionlabel").src=REGION_ICONS[o],a.mode=t.mode;var u=a.getMode();document.getElementById("modelabel").innerHTML=MODE_NAMES[u],a.set_background(t.cmw_bg),r("sleeping 2000"),a.sleep(2e3).then((function(){r("continuing"),l=a.loopOverAllFeatures("set",t.features),a.updateTitle()}))}},a.mkBrightRGBA=function(){var e=parseInt(255*Math.random()),t=parseInt(255*Math.random()),r=parseInt(255*Math.random());if(e+t+r<300){var n=parseInt(3*Math.random());0==n?r=255:1==n?e=255:2==n&&(t=255)}return"RGBA("+e+","+t+","+r+",255)"},a.updateTitle=function(){var e=n.get("appname").split(""),r=document.getElementById("persistent_title_div");html="";for(var o=0;o<e.length;o++){var l=a.mkBrightRGBA();html+="<span style='text-shadow:none;font-family:Mickey;color:"+l+";'>"+e[o]+"</span>"}r.innerHTML=html,t.resize()},a.setMode=function(e){a.mode=e},a.getMode=function(){return a.mode},a.getRegion=function(){return REGION_NAMES.indexOf(a.currents[0])},a.background_color="rgb(0,120,255)",a.rgbColorString="rgb(255,255,255)",a.setRGBColorString=function(e){a.rgbColorString=e},a.getRGBColorString=function(){return a.rgbColorString},a.set_background=function(e){a.background_color=e||a.getRGBColorString(),document.getElementById("cmw_bg").style.backgroundColor=a.background_color},a.getRunning=function(){return a.RUNNING},a.BASE_SOURCES={OpenStreetMap2:new e.source.OSM},a.CATEGORIES={keys:[],"Base Layers":{keys:["OpenStreetMap2"],OpenStreetMap2:{type:"tile",api:"ol.layer.Tile",layer:new e.layer.Tile({preload:14,opacity:1,title:"OpenStreetMap2",source:a.BASE_SOURCES.OpenStreetMap2}),source:a.BASE_SOURCES.OpenStreetMap2,feature_names:[],style:null,colors:{},toggle:!1}}},a.resize=function(){r("resize");var e=window.innerWidth,n=window.innerHeight,o=t.computeResolution(a.collective_bbox,!1,e,n);window.map.getView().setResolution(o)},a.get_enabled_candidates=function(){r("get_enabled_candidates");for(var e="",t="",n=a.CATEGORIES.keys,o=0;o<n.length;o++){e=n[o];r("checking "+e);var l=a.CATEGORIES[e].keys;r("layer_names="+l+" "+typeof l);for(var u=0;u<l.length;u++){t=l[u];r("checking "+e+"."+t)}}for(var i=[],s=0;s<a.CATEGORIES[e][t].feature_names.length;s++)a.CATEGORIES[e][t].features[a.CATEGORIES[e][t].feature_names[s]].candidate&&i.push(a.CATEGORIES[e][t].feature_names[s]);if(i.length>0){s=parseInt(Math.random()*i.length);return f=a.CATEGORIES[e][t].features[i[s]],[{category:e,layer_key:t,feature_name:i[s]}]}return[]},a.reinit_candidates=function(){r("reinit_candidates");for(var e=a.CATEGORIES.keys,t=0;t<e.length;t++)for(var n=e[t],o=a.CATEGORIES[n].keys,l=0;l<o.length;l++){var u=o[l];if(a.CATEGORIES[n][u].toggle)for(var i=a.CATEGORIES[n][u].feature_names,s=0;s<i.length;s++){var c=i[s];a.CATEGORIES[n][u].features[c].candidate=!0}}},a.change_areaCB=function(t,n){if(r("change_areaCB"),"OpenStreetMap2"!=n||1!=t)if("OpenStreetMap2"!=n||0!=t){1==a.RUNNING&&a.toggleRunning(),a.currents=[n],r("me.currents="+a.currents);for(var o=0;o<a.CATEGORIES.keys.length;o++){c=a.CATEGORIES.keys[o];for(var l=0;l<a.CATEGORIES[c].keys.length;l++){var u=a.CATEGORIES[c].keys[l];r("removing layer: "+u),window.map.removeLayer(a.CATEGORIES[c][u].layer),delete a.CATEGORIES[c][u],r("removing "+c+" BOUNDARY"),window.map.removeLayer(a.CATEGORIES[c].BOUNDARY.layer),delete a.CATEGORIES[c].BOUNDARY.layer}delete a.CATEGORIES[c]}a.CATEGORIES.keys=[];try{for(o=0;o<a.currents.length;o++)r("Removing layer: BOUNDARY"),window.map.removeLayer(a.CATEGORIES[a.currents[o]].BOUNDARY.layer),delete a.CATEGORIES[a.currents[o]].BOUNDARY}catch(e){}a.prepare_layers();r("Adding BOUNDARY layers");for(o=0;o<a.currents.length;o++)window.map.addLayer(a.CATEGORIES[a.currents[o]].BOUNDARY.layer);for(var i=a.CATEGORIES.keys,s=0;s<i.length;s++){var c=i[s];r("Adding "+a.CATEGORIES[c].keys.length);var g=a.CATEGORIES[c].keys;for(l=0;l<g.length;l++){u=g[l];r("Adding layer: "+u),window.map.addLayer(a.CATEGORIES[c][u].layer)}}var d=200,p=200,f=-200,m=-200;for(o=0;o<a.currents.length;o++){var y=INSTALLED[a.currents[o]].bbox;y[0]<d&&(d=y[0]),y[1]<p&&(p=y[1]),y[2]>f&&(f=y[2]),y[3]>m&&(m=y[3])}var _=[(d+f)/2,(p+m)/2];a.collective_bbox=[d,p,f,m],window.map.getView().setCenter(e.proj.transform(_,"EPSG:4326","EPSG:3857")),a.resize(),a.currents[0],r("setting timeout to 2000"),window.setTimeout(a.fill_all_features,2e3,!1)}else window.map.removeLayer(a.CATEGORIES["Base Layers"].OpenStreetMap2.layer);else window.map.getLayers().insertAt(0,a.CATEGORIES["Base Layers"].OpenStreetMap2.layer)},a.fill_all_features=function(){r("fill_all_features");for(var e=a.CATEGORIES.keys,t=0;t<e.length;t++)for(var n=e[t],o=a.CATEGORIES[n].keys,l=0;l<o.length;l++){var u=o[l],i=a.CATEGORIES[n][u].source.getFeatures();if(r("features.length="+i.length),0==i.length)return r("calling self recursively by timeout"),void window.setTimeout(a.fill_all_features,2e3,!1);for(var s=0;s<i.length;s++){var c=null;(c=i[s].get("Name"))||(c=i[s].get("NAME")),c||(c=i[s].get("name")),r(c),a.CATEGORIES[n][u].features[c]={feature:i[s],candidate:!0,color:"rgb(0,0,0)"},a.CATEGORIES[n][u].feature_names.push(c)}}},a.prepare_layers=function(){r("me.prepare_layers: "+a.currents),a.LAYERS={keys:[]};for(var t=0;t<a.currents.length;t++)for(var n=0;n<INSTALLED[a.currents[t]].polygon_sources.length;n++){var o=INSTALLED[a.currents[t]].path+INSTALLED[a.currents[t]].polygon_sources[n].filename,l=new e.source.Vector({url:o,format:new e.format.GeoJSON}),u=new e.layer.Vector({updateWhileAnimating:!0,source:l,style:new e.style.Style({stroke:new e.style.Stroke({color:INSTALLED[a.currents[t]].polygon_sources[n].color,width:INSTALLED[a.currents[t]].polygon_sources[n].width}),fill:new e.style.Fill({color:INSTALLED[a.currents[t]].polygon_sources[n].fill})})});u.set("type","Polygon");var i=INSTALLED[a.currents[t]].polygon_sources[n].category,s=INSTALLED[a.currents[t]].polygon_sources[n].layer_name;u.set("layer_name",s),a.CATEGORIES.keys.indexOf(i)<0&&(r("new category: "+i),a.CATEGORIES.keys.push(i),a.CATEGORIES[i]={keys:[]}),a.CATEGORIES[i].keys.push(s),a.CATEGORIES[i][s]={layer:u,source:l,feature_names:[],features_off:[],features:l.getFeatures(),style:null,colors:{},toggle:!0,type:"Polygon"}}for(t=0;t<a.currents.length;t++){var c=new e.source.Vector({url:INSTALLED[a.currents[t]].path+"boundary.geojson",format:new e.format.GeoJSON}),g=new e.layer.Vector({source:c,style:new e.style.Style({stroke:new e.style.Stroke({color:INSTALLED[a.currents[t]].color,width:INSTALLED[a.currents[t]].width}),fill:new e.style.Fill({color:INSTALLED[a.currents[t]].fill})})});a.CATEGORIES[a.currents[t]].BOUNDARY={api:"ol.layer.Vector",layer:g,source:c,feature_names:[],features_off:[],features:{},style:null,colors:{},toggle:!0,type:"Polygon"}}return r("prepare_layers done"),1},a.setRunning=function(e){a.RUNNING=e},a.toggleRunning=function(){a.mode==COLORING&&(a.setMode(TOUR),document.getElementById("modelabel").innerHTML=n.get(MODE_NAMES[a.mode])),1==a.RUNNING?(r("stopMove"),a.setRunning(!1),$("#run-button").toggleClass("running"),$("#run-button").title="Play"):(r("startMove"),a.setRunning(!0),a.startMove(),$("#run-button").toggleClass("running"),$("#run-button").title="Pause")},a.startMove=function(e){if(0!=a.RUNNING){r("startMove");try{window.clearTimeout(a.last_timeout)}catch(e){r(e)}if(e)r("me.startMove with feature passed");else{var l=a.get_enabled_candidates();if(0==l.length)return r("returning me.end_game()"),a.end_game();r("me.startMove no feature passed so selecting");var u=parseInt(Math.random()*l.length);r("cycling ridx="+u.toString()+"/"+l.length);for(var i=[],s=0;s<l.length;s++)i.push(l[s].feature_name);r("candidates="+i);for(var c=0;c<u;c++)l.push(l.shift());r("shifting me.current_feature"),a.current_feature=l.shift()}var g=null;g=a.current_feature.feature_name;var d=n.get(a.current_feature.layer_key),p="<center><h3>Next:</h3><h1>"+n.get(g.replace(/ /g,"_")).replace(/_/g," ")+"</h1><h3>"+d+"</h3></center>";a.mode==TOUR?p="<center><h3>"+t.descore(n.get(t.enscore("Next")))+":</h3><h1>"+t.descore(o[`${g.replace(/ /g,"_")}`]+" "+n.get(t.enscore(g)))+"</h1><h3>"+d+"</h3></center>":a.mode==INTERACTIVE&&(p="<center><h3>"+t.descore(n.get(t.enscore("Find")))+":</h3><h1>"+t.descore(n.get(t.enscore(g)))+"</h1><h3>"+d+"</h3></center>"),r("me.startMove:"+g+" "+d),a.showPopup(p)}},a.showPopup=function(e){for(;a.popup.childNodes.length>0;)try{a.popup.removeChild(a.popup.childNodes[0])}catch(e){r(e)}a.popup.innerHTML="";var t=document.createElement("div");if(t.classname="info_div",t.innerHTML=e,a.popup.appendChild(t),a.current_feature){target_name=a.current_feature.feature_name,r("ADD IMAGE HERE:"+target_name);var n=new Image;n.src="country_img/"+target_name+".png",n.onload=function(){var e=n.width,t=n.height;r("iW="+e),r("iH="+t),e>t?(r("iW>iH"),n.style.width="270px",n.style.height=parseInt(270*t/e)+"px"):(r("iW<iH"),n.style.height="270px",n.style.width=parseInt(270*e/t)+"px"),a.popup.appendChild(n),a.popup.style.left=window.innerWidth/2-150+"px",a.popup.style.top=window.innerHeight/2-200+"px",a.popup.style.width="300px",a.popup.style.opacity=0,document.body.appendChild(a.popup),$("#popup").animate({opacity:1},a.DELAY,(function(){a.last_timeout=window.setTimeout(a.popdown,1*a.DELAY)}))}}else a.popup.style.left=window.innerWidth/2-150+"px",a.popup.style.top=window.innerHeight/2-200+"px",a.popup.style.width="300px",a.popup.style.opacity=0,document.body.appendChild(a.popup),$("#popup").animate({opacity:1},a.DELAY,(function(){a.last_timeout=window.setTimeout(a.popdown,1*a.DELAY)}))},a.popdown=function(e){r("popdown");try{window.clearTimeout(a.last_timeout)}catch(e){}$("#popup").animate({opacity:0},a.DELAY,(function(){try{document.body.removeChild(a.popup)}catch(e){}if(a.mode==TOUR&&null!=a.current_feature){var e=a.current_feature,t=e.category,r=e.layer_key,n=e.feature_name,o=a.CATEGORIES[t][r].features[n].feature.getGeometry().getExtent(),l=[(o[0]+o[2])/2,(o[1]+o[3])/2];a.pan_zoom(l)}a.mode==TOUR&&null==a.current_feature&&a.toggleRunning()}))},a.end_game=function(){try{document.body.removeChild(a.popup)}catch(e){r("me.end_game")}var e="<center><h1>Congratulations!<br>You Finished!</h1></center>";"en-us"!=n.getLanguage()&&(e="<center><h1>"+t.descore(n.get("Congratulations"))+"!<br>",e+=t.descore(n.get("You_Finished"))+"!</h1></center>"),r(e),a.toggleRunning(),a.setMode(COLORING),a.reinit_candidates(),document.getElementById("modelabel").innerHTML=n.get(MODE_NAMES[a.mode]),a.showPopup(e)},a.random_styles=[];for(var l=0;l<NUM_COLORS;l++){var u=new e.style.Style({fill:new e.style.Fill({color:a.mkBrightRGBA()}),stroke:new e.style.Stroke({color:DEFAULT_STROKE,width:1})});a.random_styles.push(u)}return a.check_feature=function(e){if(a.current_feature){var n;r("check_feature:"+a.current_feature.feature_name),r("me.check_feature clearing last_timeout"),window.clearTimeout(a.last_timeout);var o=[],u=!1;if(e||a.mode!=TOUR)l=window.map.forEachFeatureAtPixel(e,(function(e,t){var n=null;(n=e.get("NAME"))||(n=e.get("Name")),n||(n=e.get("name")),r("returning: "+n),o.push(e)}));else{var i=a.current_feature.category,s=a.current_feature.layer_key,c=a.current_feature.feature_name;o.push(a.CATEGORIES[i][s].features[c].feature)}if(r("features.length="+o.length),o.length>0&&!u){for(var g=0;g<o.length;g++){n=o[g];i=a.current_feature.category;var d=null;if(d=a.current_feature.feature_name,target_layer=a.current_feature.layer_key,r(g.toString()+" "+target_layer+"."+d),target_feature=a.CATEGORIES[i][target_layer].features[d].feature,n==target_feature){if(r("***** Correct! *****"),"Point"==a.CATEGORIES[i][target_layer].type)n.setStyle(t.point_correct_style);else{var p=parseInt(Math.random()*a.random_styles.length);n.setStyle(a.random_styles[p])}return u=!0,a.CATEGORIES[i][a.current_feature.layer_key].features[d].candidate=!1,a.current_feature=null,void(a.mode==TOUR?(r("check_feature setting timeout for pan_zoom_home"),a.last_timeout=window.setTimeout(a.pan_zoom_home,2*a.DELAY)):window.setTimeout(a.startMove,2*a.DELAY))}c=null;(c=n.get("NAME"))||(c=n.get("Name")),c||(c=n.get("name")),r(c+" != "+target_feature.toString())}r("starting move passing feature: "+d),a.startMove(n)}else r("game over")}else r("check_feature: No Current Feature ... returning")},a.flyTo=function(e,t,r){var n=window.map.getView(),o=a.DELAY,l=(n.getZoom(),n.getResolution()),u=2,i=!1;function callback(e){--u,i||0!==u&&e||(i=!0,r(e))}n.animate({center:e,duration:o},callback),l>t?n.animate({resolution:1.05*l,duration:.25*o},{resolution:t,duration:.75*o},callback):n.animate({resolution:1.05*t,duration:.75*o},{resolution:t,duration:.25*o},callback)},a.pan_zoom=function(e){r("pan_zoom: "+e);var n=2*a.DELAY,o=a.current_feature,l=o.category,u=o.layer_key,i=o.feature_name,s=a.CATEGORIES[l][u].features[i].feature.getGeometry().getExtent(),c=t.computeResolution(s,!0,window.innerWidth,window.innerHeight);if(0==(c*=1.2)&&(c=100),a.flyTo(e,c,(function(){})),null!=a.current_feature){try{window.clearTimeout(a.last_timeout)}catch(e){r(e)}r("pan_zoom setting timeout for check_feature"),a.last_timeout=window.setTimeout(a.check_feature,n)}else{try{window.clearTimeout(a.last_timeout)}catch(e){r(e)}r("pan_zoom calling start_move directly"),a.start_move(null)}},a.pan_zoom_home=function(){r("bounce_home");a.DELAY;var n=window.innerWidth,o=window.innerHeight,l=a.collective_bbox,u=t.computeResolution(l,!1,n,o),i=e.proj.transform([(l[0]+l[2])/2,(l[1]+l[3])/2],"EPSG:4326","EPSG:3857");a.flyTo(i,u,(function(){}));try{window.clearTimeout(a.last_timeout)}catch(e){r(e)}r("pan_zoom_home setting timeout for start_move"),a.last_timeout=window.setTimeout(a.startMove,a.delay)},window.colormyworld=a,a}));