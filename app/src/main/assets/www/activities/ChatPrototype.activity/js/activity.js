define(["sugar-web/activity/activity","webL10n","sugar-web/graphics/palette","sugar-web/graphics/presencepalette","sugar-web/datastore","sugar-web/graphics/journalchooser","tutorial","sugar-web/env"],(function(e,t,n,a,o,r,l,i){e=requirejs("sugar-web/activity/activity");requirejs(["domReady!"],(function(n){e.setup(),i.getEnvironment((function(e,n){var a="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,o=n.user?n.user.language:a;t.language.code=o}));var s="(?:[^\"'>]|\"[^\"]*\"|'[^']*')*",c=new RegExp("<(?:!--(?:(?:-*[^->])*--+|-?)|script\\b"+s+">[\\s\\S]*?</script\\s*|style\\b"+s+">[\\s\\S]*?</style\\s*|/?[a-z]"+s+")>","gi");document.getElementById("message-form");var d=document.getElementById("message"),m=document.getElementById("messages"),u=document.getElementById("status"),g=document.getElementById("content"),p=document.getElementById("image-upload");window.addEventListener("localized",(function(){document.getElementById("status").innerHTML=t.get("status"),d.placeholder=t.get("WriteYourMessage")}));var y,v=null;function shareActivity(){a.popDown(),y=e.getPresenceObject((function(e,n){if(e)return u.innerHTML=t.get("Error"),void(u.className="error");v=n.getUserInfo(),u.innerHTML=t.get("Connected"),u.className="open",d.readOnly=!1,window.top.sugar.environment.sharedId||n.createSharedActivity("org.sugarlabs.ChatPrototype",(function(e){})),n.onConnectionClosed((function(e){console.log(t.get("ConnectionClosed")),u.innerHTML=t.get("DisconnectedFromWebSocket"),u.className="closed"})),n.onSharedActivityUserChanged((function(e){var n=e.user.name.replace("<","&lt;").replace(">","&gt;");m.innerHTML+='<li class="received message-line" style = "color:blue">'+n+" "+(e.move>0?t.get("Join"):t.get("Leave"))+" "+t.get("Chat")+"</li>",p.style.visibility="visible"})),n.onDataReceived((function(e){if("text"==e.type||void 0===e.type){var t=e.content,n=e.user.name.replace("<","&lt;").replace(">","&gt;"),a='<span style = "color:'+(o=e.user.colorvalue).stroke+';width: auto; padding-right: 10px;">'+n+":</span>";myElem=document.createElement("li"),myElem.className="received message-line",myElem.style.background=o.fill,myElem.innerHTML=a+t,myElem.style.color=o.stroke,m.appendChild(myElem),g.scrollTop=g.scrollHeight}else if("image"==e.type){var o,r=e.content;n=e.user.name.replace("<","&lt;").replace(">","&gt;"),a='<span style = "color:'+(o=e.user.colorvalue).stroke+';width: auto; padding-right: 10px;">'+n+":</span>";myElem=document.createElement("li"),myElem.className="received message-line",myElem.style.background=o.fill,myElem.innerHTML=a+"<img src='"+r+"' style='max-height:150px;'>",myElem.style.color=o.stroke,m.appendChild(myElem),g.scrollTop=g.scrollHeight}}))}))}function senddata(e,t){var n={user:v,content:e,type:t};y.sendMessage(y.getSharedInfo().id,n)}var h=document.getElementById("network-button");(a=new a.PresencePalette(h,void 0)).addEventListener("shared",shareActivity),window.top.sugar.environment.sharedId&&(shareActivity(),a.setShared(!0)),d.onkeydown=function(e){if(13===e.keyCode)return senddata(function removeTags(e){var t;do{t=e,e=e.replace(c,"")}while(e!==t);return e.replace(/</g,"&lt;")}(d.value),"text"),d.placeholder=t.get("WriteYourMessage"),d.value="",d.setSelectionRange(0,0),!1},p.addEventListener("click",(function(e){r.show((function(e){e&&new o.DatastoreObject(e.objectId).loadAsText((function(e,t,n){senddata(n,"image")}))}),{mimetype:"image/png"},{mimetype:"image/jpeg"})}));for(var E,f=document.getElementById("smiley-button"),b=[[128513,128515],[128517,128519],[128521,128528]],w=0;w<b.length;w++)for(var I=(H=b[w])[0];I<H[1];I++)(E=document.createElement("option")).value=I,E.innerHTML="&#"+I+";",f.appendChild(E);var L,C=document.getElementById("sad-button"),T=[[128531,128533],[128545,128551],[128555,128558]];for(w=0;w<T.length;w++)for(I=(H=T[w])[0];I<H[1];I++)(L=document.createElement("option")).value=I,L.innerHTML="&#"+I+";",C.appendChild(L);var M,k=document.getElementById("others-button"),B=[[128568,128573],[128582,128588]];for(w=0;w<B.length;w++){var H;for(I=(H=B[w])[0];I<H[1];I++)(M=document.createElement("option")).value=I,M.innerHTML="&#"+I+";",k.appendChild(M)}document.getElementById("help-button").addEventListener("click",(function(e){l.start()}))}))}));