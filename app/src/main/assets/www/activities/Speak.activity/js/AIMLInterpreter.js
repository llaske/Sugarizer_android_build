var storedVariableValues={},botAttributes={},lastWildCardValue="",wildCardArray=[],domArray=[],domIndex=0,isAIMLFileLoadingStarted=!1,isAIMLFileLoaded=!1,previousAnswer="",previousThinkTag=!1,AIMLInterpreter=function(e){var r=this;botAttributes=e,this.loadAIMLFilesIntoArray=function(e){isAIMLFileLoadingStarted=!0;var r=0,readAIMLFile=function(t){var a;r++,$(document).ready((function(){$.ajax({url:t,dataType:"text",success:function(t){a=t,(new DomJS).parse(a,(function(t,a){null==a&&(a="<aiml></aiml>"),a.name,domArray[domIndex]=a,domIndex++,r<e.length?readAIMLFile(e[r]):(console.log("AIML file is loaded!"),isAIMLFileLoaded=!0)}))}})}))};readAIMLFile(e[r])},this.findAnswerInLoadedAIMLFiles=function(e,t){if(isAIMLFileLoaded){wildCardArray=[];for(var a="",n=0;n<domArray.length&&(cleanDom(domArray[n].children),!(a=findCorrectCategory(e,domArray[n].children)));n++);a&&(a=cleanStringFormatCharacters(a),previousAnswer=a),t(a,wildCardArray,e)}else{setTimeout(function(e,t){return function(){r.findAnswerInLoadedAIMLFiles(e,t)}}(e,t),1e3)}},this.restartDom=function(){domArray=[],domIndex=0}},cleanStringFormatCharacters=function(e){var r=e.replace(/\r\n/gi,"");return r=(r=r.replace(/^\s*/,"")).replace(/\s*$/,"")},cleanDom=function(e){for(var r=0;r<e.length;r++)e[r].hasOwnProperty("text")&"string"==typeof e[r].text&&e[r].text.match(/^\s*\r\n\s*$/gi)&&e.splice(r,1);for(var t=0;t<e.length;t++)e[t].hasOwnProperty("children")&&cleanDom(e[t].children)},findCorrectCategory=function(e,r){var t=0,travereseThroughDomToFindMatchingPattern=function(r){for(var t=r.length-1;t>=0;t--)if("category"===r[t].name){var a=travereseThroughDomToFindMatchingPattern(r[t].children);if(checkIfMessageMatchesPattern(e,a))if(checkForThatMatching(r[t].children)){if(a=findFinalTextInTemplateNode(r[t].children))return a;break}}else if("pattern"===r[t].name){return a=resolveChildNodesInPatternNode(r[t].children)}},checkForThatMatching=function(e){for(var r=0;r<e.length;r++)if("that"===e[r].name)return e[r].children[0].text==previousAnswer;return!0},resolveChildNodesInPatternNode=function(e){for(var r="",t=0;t<e.length;t++)"bot"===e[t].name?r+=botAttributes[e[t].attributes.name]:"get"===e[t].name?r+=storedVariableValues[e[t].attributes.name]:"set"===e[t].name?r+=e[t].children[0].text:r+=e[t].text;return r},findFinalTextInTemplateNode=function(e){for(var t="",a=0;a<e.length;a++){if("template"===e[a].name)return findFinalTextInTemplateNode(e[a].children);if("condition"===e[a].name)return resolveSpecialNodes(e);if("random"===e[a].name)return resolveSpecialNodes(e);if("srai"===e[a].name){var n=""+findFinalTextInTemplateNode(e[a].children);return n=n.toUpperCase(),t=findCorrectCategory(n,r)}if("li"===e[a].name)return findFinalTextInTemplateNode(e[a].children);if("br"===e[a].name)return resolveSpecialNodes(e);if("pattern"!==e[a].name){if("think"===e[a].name)return t=resolveSpecialNodes(e);if("bot"===e[a].name)return t=resolveSpecialNodes(e);if("set"===e[a].name)return t=resolveSpecialNodes(e);if("get"===e[a].name)return t=resolveSpecialNodes(e);if("sr"===e[a].name)return t=resolveSpecialNodes(e);if("star"===e[a].name)return t=resolveSpecialNodes(e);if("that"===e[a].name);else if(""===(t=resolveSpecialNodes(e)).match("[\\n|\\t]*[^A-Z|^a-z|^!|^?]*")[0]&&-1===t.indexOf("function ()"))return t}else resolveSpecialNodes(e[a].children)}},resolveSpecialNodes=function(e){for(var a="",n=0;n<e.length;n++)if("bot"===e[n].name)a+=botAttributes[e[n].attributes.name];else if("get"===e[n].name){var i=storedVariableValues[e[n].attributes.name];a+=void 0===i?"":i}else if("set"===e[n].name){var l="";"star"===e[n].children[0].name?(l=resolveSpecialNodes(e[n].children),storedVariableValues[e[n].attributes.name]=l,previousThinkTag||(a+=l)):"*"===e[n].children[0].text?(storedVariableValues[e[n].attributes.name]=wildCardArray[t],t++):storedVariableValues[e[n].attributes.name]=e[n].children[0].text,previousThinkTag?(previousThinkTag=!1,a+=""):a+=resolveSpecialNodes(e[n].children)}else if("br"===e[n].name)a+="\n";else if("think"===e[n].name)previousThinkTag=!0,a+=resolveSpecialNodes(e[n].children);else if("sr"===e[n].name){for(var s,o=0;o<domArray.length;o++)if(s=findCorrectCategory(lastWildCardValue,domArray[o].children)){a+=s;break}}else if("random"===e[n].name){var d=Math.floor(Math.random()*e[n].children.length);a+=findFinalTextInTemplateNode([e[n].children[d]])}else if("star"===e[n].name)a+=lastWildCardValue;else if("srai"===e[n].name){var u=""+findFinalTextInTemplateNode(e[n].children);u=u.toUpperCase(),a+=findCorrectCategory(u,r)}else if("condition"===e[n].name){if(void 0===e[n].attributes.name){if(void 0===e[n].children)return;for(var c in e[n].children)if("li"===(f=e[n].children[c]).name&&(null==f.attributes.value||storedVariableValues[f.attributes.name]===f.attributes.value.toUpperCase()))return findFinalTextInTemplateNode(f.children)}else if(void 0!==e[n].attributes.value)storedVariableValues[e[n].attributes.name]===e[n].attributes.value.toUpperCase()&&(a+=resolveSpecialNodes(e[n].children));else if(void 0!==e[n].children){var f;for(var c in e[n].children)if("li"===(f=e[n].children[c]).name&&(void 0===f.attributes.value||storedVariableValues[e[n].attributes.name]===f.attributes.value.toUpperCase()))return resolveSpecialNodes(f.children);return}}else void 0===e[n].name&&(a+=e[n].text);return a=cleanStringFormatCharacters(a)};return travereseThroughDomToFindMatchingPattern(r)},checkIfMessageMatchesPattern=function(e,r){var t=convertWildcardToRegex(r);" "!=e.charAt(0)&&(e=" "+e);var a=e.length-1;" "!=e.charAt(a)&&(e+=" ");var n=e.toUpperCase().match(t);if(!n)return!1;if(n[0].length>=e.length||t.indexOf("[A-Z|0-9|\\s]*[A-Z|0-9|-]*[A-Z|0-9]*[!|.|?|\\s]*")>-1){getWildCardValue(e,r);return!0}},convertWildcardToRegex=function(e){if("*"!=e.charAt(0))e=" "+e;var r=e.length-1,t=e.charAt(r),a=e.replace(" *","*");return a=a.replace(/\*/g,"[A-Z|0-9|\\s]*[A-Z|0-9|*|-]*[A-Z|0-9]*[!|.|?|\\s]*"),"*"!=t&&(a+="[\\s|?|!|.]*"),a},getWildCardValue=function(e,r){var t=r.split("*"),a=e;if(t.length>1){for(var n=0;n<t.length;n++)a=a.replace(new RegExp(t[n],"i"),"|");a=a.split("|");var i=0;for(n=0;n<a.length;n++)if(""!=a[n]&&" "!=a[n]&&null!=a){var l=a[n],s=l.length-1,o=l.charAt(0),d=l.charAt(s);try{" "===o&&(s=(l=l.splice(0)).length-1,d=l.charAt(s))," "===d&&(s=(l=l.substr(0,s)).length-1,d=l.charAt(s)),"?"===d&&(l=l.substr(0,s))}catch(e){}wildCardArray[i]=l,i++}}return wildCardArray.length-1>=0&&(lastWildCardValue=wildCardArray[wildCardArray.length-1]),wildCardArray};