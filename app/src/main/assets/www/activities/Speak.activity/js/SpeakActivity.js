define(["sugar-web/graphics/palette","sugar-web/env","webL10n","sugar-web/datastore","sugar-web/activity/activity"],(function(e,t,n,l,o){var a=document.getElementById("canvas"),i=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight-55;var d,g,m=a.getBoundingClientRect().width,u=a.getBoundingClientRect().height,c=Math.min(m,u)/6.5,r=Math.min(m,u)/28,s=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],y={x:1.35*m/4,y:45+2*u/3},h={x:2.65*m/4,y:45+2*u/3},f=2,E=!0;function idleTimer(){E=!0,clearInterval(g),g=setInterval((function(){E=!1;var e=document.getElementById("speaklang").innerHTML,t=n.get("Sleepy");x.playVoice(e,t),clearInterval(g)}),12e4)}o.getXOColor((function(e,t){d=t})),$(window).resize((function(){a.width=window.innerWidth,a.height=window.innerHeight-55,m=a.getBoundingClientRect().width,u=a.getBoundingClientRect().height,y={x:1.35*m/4,y:45+2*u/3},h={x:2.65*m/4,y:45+2*u/3},c=Math.min(m,u)/6.5,r=Math.min(m,u)/28,setEyes()})),a.addEventListener("mousemove",(function(e){setMousePosition(a,e)}),!1);var I,M=!!document.all,B=-1,T=-1,v=0,p=1,x=null,b={},L=!0;function setEyes(e){var t,n=a.getBoundingClientRect(),l=n.width-n.width/4.5,o=n.height,i=n.width/2,d=l*e/5/(e-1);if(e%2==0){for(t=0;t<Math.floor(e/2);t++)s[t+1].x=i-d/2-(Math.floor(e/2)-t-1)*d,s[t+1].y=45+o/3;for(t=0;t<Math.floor(e/2);t++)s[t+Math.floor(e/2)+1].x=i+d/2+t*d,s[t+Math.floor(e/2)+1].y=45+o/3}if(e%2==1){for(s[1].x=i,s[1].y=45+o/3,t=0;t<Math.floor(e/2);t++)s[t+2].x=i-(Math.floor(e/2)-t)*d,s[t+2].y=45+o/3;for(t=0;t<Math.floor(e/2);t++)s[t+Math.floor(e/2)+2].x=i+(t+1)*d,s[t+Math.floor(e/2)+2].y=45+o/3}}function setMousePosition(e,t){var n=e.getBoundingClientRect();B=(t.clientX-n.left)*e.width/n.width,T=(t.clientY-n.top)*e.height/n.height}function getEyeballOffset(e){var t,n;-1==B&&-1==T?(t=0,n=0):(t=B-s[e].x,n=T-s[e].y);var l=1,o=1;t<0&&(l=-1),n<0&&(o=-1);var a=Math.atan(Math.abs(n/t));return isNaN(a)&&(a=0),{x:l*Math.min((c-r)*Math.cos(a),Math.abs(t)),y:o*Math.min((c-r)*Math.sin(a),Math.abs(n))}}function closeChat(){document.getElementById("chat").style.display="none"}function addToChat(){var e=document.getElementById("userText").value,t=document.getElementById("chatbox"),n=document.createElement("li");n.style.borderRadius="10px",n.style.backgroundColor="#999999",n.style.listStyleType="none",n.style.padding="15px",n.style.margin="-15px",n.appendChild(document.createTextNode(e)),t.appendChild(n)}function startMouthAnim(){var e=document.getElementById("rate").innerHTML;document.getElementById("speaking").innerHTML=1,I=setInterval((function(){!function animateMouth(e){"0"==document.getElementById("speaking").innerHTML&&(clearInterval(I),v=0);var t=e/70+1;t=Math.min(4,t),t=Math.max(1,t),1==p?(v-=t)<-40&&(p=2):2==p&&(v+=t)>40&&(p=1)}(e)}),10)}function moveMouth(e){""!=e&&("2"==document.getElementById("mode").innerHTML?setTimeout((function(){startMouthAnim()}),4e3):startMouthAnim())}function updateCanvas(){!function clearCanvas(){i.clearRect(0,0,a.width,a.height),i.beginPath(),i.rect(0,0,a.width,a.height),i.fillStyle=d.fill,i.fill()}(),setEyes(f=parseInt(document.getElementById("numeyes").innerHTML)),function drawEyes(){if(E){var e=document.getElementById("eyetype").innerHTML;for(n=1;n<=f;n++){if(i.beginPath(),i.fillStyle="#000000",1==e)i.arc(s[n].x,s[n].y,1.1*c,0,2*Math.PI),i.fill();else{var t=1.1*c;i.fillRect(s[n].x-t,s[n].y-t,2*t,2*t)}i.closePath()}for(n=1;n<=f;n++){if(i.beginPath(),i.fillStyle="#FFFFFF",1==e)i.arc(s[n].x,s[n].y,c,0,2*Math.PI),i.fill();else{t=c;i.fillRect(s[n].x-t,s[n].y-t,2*t,2*t)}i.closePath()}}else for(n=1;n<=f;n++){var n;i.beginPath(),i.arc(s[n].x,s[n].y,1.1*c,.4,Math.PI-.4),i.lineWidth=20,i.stroke(),i.closePath()}}(),function drawEyeballs(){var e;if(E)for(e=1;e<=f;e++)i.beginPath(),i.fillStyle="#000000",i.arc(s[e].x+getEyeballOffset(e).x,s[e].y+getEyeballOffset(e).y,r,0,2*Math.PI),i.fill(),i.closePath()}(),function drawMouth(){i.beginPath(),i.moveTo(y.x,y.y),i.bezierCurveTo(y.x+100,y.y+v,h.x-100,h.y+v,h.x,h.y),i.lineWidth=10,i.stroke(),i.closePath(),i.beginPath(),i.moveTo(y.x,y.y),i.bezierCurveTo(y.x+100,y.y-v,h.x-100,h.y-v,h.x,h.y),i.lineWidth=10,i.stroke(),i.closePath()}()}document.getElementById("userArea").onmouseup=function(e){!function hidePalettes(){for(var e=document.getElementsByClassName("palette"),t=0;t<e.length;t++)e[t].style.visibility="hidden"}()},document.getElementById("speakText").onmousedown=function(e){var t=document.getElementById("speaklang").innerHTML,n=document.getElementById("userText").value;x.playVoice(t,n),idleTimer()},document.getElementById("speakText").onmouseup=function(e){moveMouth(document.getElementById("userText").value),"3"==document.getElementById("mode").innerHTML&&addToChat()},document.getElementById("userText").onkeypress=function(e){if(13==(e.keyCode||e.which)){var t=document.getElementById("speaklang").innerHTML,n=document.getElementById("userText").value;x.playVoice(t,n),moveMouth(n),idleTimer(),"3"==document.getElementById("mode").innerHTML&&addToChat()}},document.getElementById("userText").oninput=function(e){var t=this.getBoundingClientRect(),n={clientX:t.left+20*document.getElementById("userText").selectionStart,clientY:t.top};setMousePosition(a,n),updateCanvas()},document.getElementById("userText").addEventListener("mousemove",(function(e){setMousePosition(a,e),updateCanvas()}),!1),document.getElementById("gamemode1-button").onmouseup=function(e){document.getElementById("mode").innerHTML="1",document.getElementById("canvas").style.display="block",closeChat()},document.getElementById("gamemode2-button").onmouseup=function(e){document.getElementById("mode").innerHTML="2",document.getElementById("canvas").style.display="block",closeChat()},document.getElementById("gamemode3-button").onmouseup=function(e){document.getElementById("mode").innerHTML="3",document.getElementById("canvas").style.display="none",function setupChat(){document.getElementById("chat").style.display="block"}()},function init(){x=Speech(),t.getEnvironment((function(e,t){var l="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language;t.user||(t.user={language:l}),b=t.user,x.init(b),M||document.captureEvents(Event.MOUSEMOVE);setInterval((function(){updateCanvas()}),1e3/30),window.addEventListener("localized",(function(){if(L)return n.language.code=b.language,void(L=!1);!function localize(){document.getElementById("gamemode1-button").title=n.get("TypeSomethingToHear"),document.getElementById("gamemode2-button").title=n.get("AskRobot"),document.getElementById("gamemode3-button").title=n.get("VoiceChat"),document.getElementById("language-button").title=n.get("Language"),document.getElementById("speech-button").title=n.get("Speech"),document.getElementById("face-button").title=n.get("Face"),document.getElementById("ratelabel").innerHTML=n.get("ratelabel"),document.getElementById("pitchlabel").innerHTML=n.get("pitchlabel"),document.getElementById("eyesnumber").innerHTML=n.get("eyesnumber"),document.getElementById("eyes").title=n.get("eyes"),document.getElementById("glasses").title=n.get("glasses"),document.getElementById("speakText").title=n.get("speak"),document.getElementById("lang-en").innerHTML=n.get("langen"),document.getElementById("lang-ca").innerHTML=n.get("langca"),document.getElementById("lang-cs").innerHTML=n.get("langcs"),document.getElementById("lang-de").innerHTML=n.get("langde"),document.getElementById("lang-el").innerHTML=n.get("langel"),document.getElementById("lang-eo").innerHTML=n.get("langeo"),document.getElementById("lang-es").innerHTML=n.get("langes"),document.getElementById("lang-fi").innerHTML=n.get("langfi"),document.getElementById("lang-fr").innerHTML=n.get("langfr"),document.getElementById("lang-hu").innerHTML=n.get("langhu"),document.getElementById("lang-it").innerHTML=n.get("langit"),document.getElementById("lang-kn").innerHTML=n.get("langkn"),document.getElementById("lang-la").innerHTML=n.get("langla"),document.getElementById("lang-lv").innerHTML=n.get("langlv"),document.getElementById("lang-nl").innerHTML=n.get("langnl"),document.getElementById("lang-pl").innerHTML=n.get("langpl"),document.getElementById("lang-pt").innerHTML=n.get("langpt"),document.getElementById("lang-ro").innerHTML=n.get("langro"),document.getElementById("lang-sk").innerHTML=n.get("langsk"),document.getElementById("lang-sv").innerHTML=n.get("langsv"),document.getElementById("lang-tr").innerHTML=n.get("langtr"),document.getElementById("lang-zh").innerHTML=n.get("langzh")}();var e=window.setTimeout((function(){window.clearTimeout(e);var t=document.getElementById("speaklang").innerHTML,l=n.get("TypeSomething",{name:b.name});document.getElementById("combo-box").title=n.get("SavedTalk"),document.getElementsByClassName("dropdown").title=n.get("SavedTalk"),x.playVoice(t,l),moveMouth(l)}),100)}))})),idleTimer()}()}));