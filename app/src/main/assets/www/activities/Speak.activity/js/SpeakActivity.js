define(["sugar-web/graphics/palette","sugar-web/env","l10n","sugar-web/datastore","sugar-web/activity/activity"],(function(e,t,n,o,a){var i=document.getElementById("canvas"),l=i.getContext("2d");i.width=window.innerWidth,i.height=window.innerHeight-55;var d,u,r=i.getBoundingClientRect().width,c=i.getBoundingClientRect().height,m=45,s=Math.min(r,c)/6.5,g=Math.min(r,c)/28,y=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],h={x:1.35*r/4,y:m+2*c/3},f={x:2.65*r/4,y:m+2*c/3},v=2,M=!0;function idleTimer(){M=!0,clearInterval(u),u=setInterval((function(){M=!1;var e=document.getElementById("speaklang").innerHTML,t=n.get("Sleepy");b.playVoice(e,t),clearInterval(u)}),12e4)}$(window).resize((function(){i.width=window.innerWidth,i.height=window.innerHeight-55,r=i.getBoundingClientRect().width,c=i.getBoundingClientRect().height,h={x:1.35*r/4,y:m+2*c/3},f={x:2.65*r/4,y:m+2*c/3},s=Math.min(r,c)/6.5,g=Math.min(r,c)/28,setEyes()})),i.addEventListener("mousemove",(function(e){setMousePosition(i,e)}),!1);var p,E=!!document.all,T=-1,x=-1,I=0,B=1,b=null,w={},C=!0;function setEyes(e){var t,n=i.getBoundingClientRect(),o=n.width-n.width/4.5,a=n.height,l=n.width/2,d=o*e/5/(e-1);if(e%2==0){for(t=0;t<Math.floor(e/2);t++)y[t+1].x=l-d/2-(Math.floor(e/2)-t-1)*d,y[t+1].y=m+a/3;for(t=0;t<Math.floor(e/2);t++)y[t+Math.floor(e/2)+1].x=l+d/2+t*d,y[t+Math.floor(e/2)+1].y=m+a/3}if(e%2==1){for(y[1].x=l,y[1].y=m+a/3,t=0;t<Math.floor(e/2);t++)y[t+2].x=l-(Math.floor(e/2)-t)*d,y[t+2].y=m+a/3;for(t=0;t<Math.floor(e/2);t++)y[t+Math.floor(e/2)+2].x=l+(t+1)*d,y[t+Math.floor(e/2)+2].y=m+a/3}}function setMousePosition(e,t){var n=e.getBoundingClientRect();T=(t.clientX-n.left)*e.width/n.width,x=(t.clientY-n.top)*e.height/n.height}function getEyeballOffset(e){var t,n;-1==T&&-1==x?(t=0,n=0):(t=T-y[e].x,n=x-y[e].y);var o=1,a=1;t<0&&(o=-1),n<0&&(a=-1);var i=Math.atan(Math.abs(n/t));return isNaN(i)&&(i=0),{x:o*Math.min((s-g)*Math.cos(i),Math.abs(t)),y:a*Math.min((s-g)*Math.sin(i),Math.abs(n))}}function closeChat(){document.getElementById("chat").style.display="none"}function addToChat(){var e=document.getElementById("userText").value,t=document.getElementById("chatbox"),n=document.createElement("li");n.style.borderRadius="10px",n.style.backgroundColor="#999999",n.style.listStyleType="none",n.style.padding="15px",n.style.margin="-15px",n.appendChild(document.createTextNode(e)),t.appendChild(n)}function startMouthAnim(){var e=document.getElementById("rate").innerHTML;document.getElementById("speaking").innerHTML=1,p=setInterval((function(){!function animateMouth(e){"0"==document.getElementById("speaking").innerHTML&&(clearInterval(p),I=0);var t=e/70+1;t=Math.min(4,t),t=Math.max(1,t),1==B?(I-=t)<-40&&(B=2):2==B&&(I+=t)>40&&(B=1)}(e)}),10)}function moveMouth(e){""!=e&&("2"==document.getElementById("mode").innerHTML?setTimeout((function(){startMouthAnim()}),4e3):startMouthAnim())}function updateCanvas(){!function clearCanvas(){l.clearRect(0,0,i.width,i.height),l.beginPath(),l.rect(0,0,i.width,i.height),l.fillStyle=d.fill,l.fill()}(),setEyes(v=parseInt(document.getElementById("numeyes").innerHTML)),function drawEyes(){if(M){var e=document.getElementById("eyetype").innerHTML;for(n=1;n<=v;n++){if(l.beginPath(),l.fillStyle="#000000",1==e)l.arc(y[n].x,y[n].y,1.1*s,0,2*Math.PI),l.fill();else{var t=1.1*s;l.fillRect(y[n].x-t,y[n].y-t,2*t,2*t)}l.closePath()}for(n=1;n<=v;n++)l.beginPath(),l.fillStyle="#FFFFFF",1==e?(l.arc(y[n].x,y[n].y,s,0,2*Math.PI),l.fill()):(t=s,l.fillRect(y[n].x-t,y[n].y-t,2*t,2*t)),l.closePath()}else for(n=1;n<=v;n++){var n;l.beginPath(),l.arc(y[n].x,y[n].y,1.1*s,.4,Math.PI-.4),l.lineWidth=20,l.stroke(),l.closePath()}}(),function drawEyeballs(){var e;if(M)for(e=1;e<=v;e++)l.beginPath(),l.fillStyle="#000000",l.arc(y[e].x+getEyeballOffset(e).x,y[e].y+getEyeballOffset(e).y,g,0,2*Math.PI),l.fill(),l.closePath()}(),function drawMouth(){l.beginPath(),l.moveTo(h.x,h.y),l.bezierCurveTo(h.x+100,h.y+I,f.x-100,f.y+I,f.x,f.y),l.lineWidth=10,l.stroke(),l.closePath(),l.beginPath(),l.moveTo(h.x,h.y),l.bezierCurveTo(h.x+100,h.y-I,f.x-100,f.y-I,f.x,f.y),l.lineWidth=10,l.stroke(),l.closePath()}()}document.getElementById("userArea").onmouseup=function(e){!function hidePalettes(){for(var e=document.getElementsByClassName("palette"),t=0;t<e.length;t++)e[t].style.visibility="hidden"}()},document.getElementById("speakText").onmousedown=function(e){var t=document.getElementById("speaklang").innerHTML,n=document.getElementById("userText").value;b.playVoice(t,n),idleTimer()},document.getElementById("speakText").onmouseup=function(e){moveMouth(document.getElementById("userText").value),"3"==document.getElementById("mode").innerHTML&&addToChat()},document.getElementById("userText").onkeypress=function(e){if(13==(e.keyCode||e.which)){var t=document.getElementById("speaklang").innerHTML,n=document.getElementById("userText").value;b.playVoice(t,n),moveMouth(n),idleTimer(),"3"==document.getElementById("mode").innerHTML&&addToChat()}},document.getElementById("userText").oninput=function(e){var t=this.getBoundingClientRect(),n={clientX:t.left+20*document.getElementById("userText").selectionStart,clientY:t.top};setMousePosition(i,n),updateCanvas()},document.getElementById("userText").addEventListener("mousemove",(function(e){setMousePosition(i,e),updateCanvas()}),!1),document.getElementById("gamemode1-button").onmouseup=function(e){document.getElementById("mode").innerHTML="1",document.getElementById("canvas").style.display="block",closeChat()},document.getElementById("gamemode2-button").onmouseup=function(e){document.getElementById("mode").innerHTML="2",document.getElementById("canvas").style.display="block",closeChat()},document.getElementById("gamemode3-button").onmouseup=function(e){document.getElementById("mode").innerHTML="3",document.getElementById("canvas").style.display="none",function setupChat(){document.getElementById("chat").style.display="block"}()},function init(){b=Speech(),t.getEnvironment((function(e,t){var o="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language;t.user||(t.user={language:o}),w=t.user,n.init(o),b.init(w),a.getXOColor((function(e,t){d=t})),E||document.captureEvents(Event.MOUSEMOVE);setInterval((function(){updateCanvas()}),1e3/30),window.addEventListener("localized",(function(){if(C)return n.init(w.language),void(C=!1);!function localize(){for(var e=["gamemode1-button","gamemode2-button","gamemode3-button","language-button","speech-button","face-button","ratelabel","pitchlabel","eyesnumber","eyes","glasses","speakText","lang-en","lang-ca","lang-cs","lang-de","lang-el","lang-eo","lang-es"],t=["title","title","title","title","title","title","innerHTML","innerHTML","innerHTML","title","title","title","innerHTML","innerHTML","innerHTML","innerHTML","innerHTML","innerHTML","innerHTML"],o=["TypeSomethingToHear","AskRobot","VoiceChat","Language","Speech","Face","ratelabel","pitchlabel","eyesnumber","eyes","glasses","speak","langen","langca","langcs","langde","langel","langeo","langes"],a=0;a<e.length;a++){var i=document.getElementById(e[a]);i?i[t[a]]=n.get(o[a]):console.warn("Element with id "+e[a]+" not found")}}();var e=window.setTimeout((function(){window.clearTimeout(e);var t=document.getElementById("speaklang").innerHTML,o=n.get("TypeSomething",{name:w.name});document.getElementById("combo-box").title=n.get("SavedTalk"),document.getElementsByClassName("dropdown").title=n.get("SavedTalk"),b.playVoice(t,o),moveMouth(o)}),100)}))})),idleTimer()}()}));