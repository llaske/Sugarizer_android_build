define(["sugar-web/graphics/palette","sugar-web/env","webL10n","sugar-web/datastore","sugar-web/activity/activity"],(function(e,t,n,o,l){var a=document.getElementById("canvas"),i=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight-55;var d,g,m=a.getBoundingClientRect().width,u=a.getBoundingClientRect().height,c=45,r=Math.min(m,u)/6.5,y=Math.min(m,u)/28,s=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],h={x:1.35*m/4,y:c+2*u/3},f={x:2.65*m/4,y:c+2*u/3},E=2,I=!0;function idleTimer(){I=!0,clearInterval(g),g=setInterval((function(){I=!1;var e=document.getElementById("speaklang").innerHTML,t=n.get("Sleepy");b.playVoice(e,t),clearInterval(g)}),12e4)}l.getXOColor((function(e,t){d=t})),$(window).resize((function(){a.width=window.innerWidth,a.height=window.innerHeight-55,m=a.getBoundingClientRect().width,u=a.getBoundingClientRect().height,h={x:1.35*m/4,y:c+2*u/3},f={x:2.65*m/4,y:c+2*u/3},r=Math.min(m,u)/6.5,y=Math.min(m,u)/28,setEyes()})),a.addEventListener("mousemove",(function(e){setMousePosition(a,e)}),!1);var M,B=!!document.all,T=-1,v=-1,p=0,x=1,b=null,L={},H=!0;function setEyes(e){var t,n=a.getBoundingClientRect(),o=n.width-n.width/4.5,l=n.height,i=n.width/2,d=o*e/5/(e-1);if(e%2==0){for(t=0;t<Math.floor(e/2);t++)s[t+1].x=i-d/2-(Math.floor(e/2)-t-1)*d,s[t+1].y=c+l/3;for(t=0;t<Math.floor(e/2);t++)s[t+Math.floor(e/2)+1].x=i+d/2+t*d,s[t+Math.floor(e/2)+1].y=c+l/3}if(e%2==1){for(s[1].x=i,s[1].y=c+l/3,t=0;t<Math.floor(e/2);t++)s[t+2].x=i-(Math.floor(e/2)-t)*d,s[t+2].y=c+l/3;for(t=0;t<Math.floor(e/2);t++)s[t+Math.floor(e/2)+2].x=i+(t+1)*d,s[t+Math.floor(e/2)+2].y=c+l/3}}function setMousePosition(e,t){var n=e.getBoundingClientRect();T=(t.clientX-n.left)*e.width/n.width,v=(t.clientY-n.top)*e.height/n.height}function getEyeballOffset(e){var t,n;-1==T&&-1==v?(t=0,n=0):(t=T-s[e].x,n=v-s[e].y);var o=1,l=1;t<0&&(o=-1),n<0&&(l=-1);var a=Math.atan(Math.abs(n/t));return isNaN(a)&&(a=0),{x:o*Math.min((r-y)*Math.cos(a),Math.abs(t)),y:l*Math.min((r-y)*Math.sin(a),Math.abs(n))}}function closeChat(){document.getElementById("chat").style.display="none"}function addToChat(){var e=document.getElementById("userText").value,t=document.getElementById("chatbox"),n=document.createElement("li");n.style.borderRadius="10px",n.style.backgroundColor="#999999",n.style.listStyleType="none",n.style.padding="15px",n.style.margin="-15px",n.appendChild(document.createTextNode(e)),t.appendChild(n)}function startMouthAnim(){var e=document.getElementById("rate").innerHTML;document.getElementById("speaking").innerHTML=1,M=setInterval((function(){!function animateMouth(e){"0"==document.getElementById("speaking").innerHTML&&(clearInterval(M),p=0);var t=e/70+1;t=Math.min(4,t),t=Math.max(1,t),1==x?(p-=t)<-40&&(x=2):2==x&&(p+=t)>40&&(x=1)}(e)}),10)}function moveMouth(e){""!=e&&("2"==document.getElementById("mode").innerHTML?setTimeout((function(){startMouthAnim()}),4e3):startMouthAnim())}function updateCanvas(){!function clearCanvas(){i.clearRect(0,0,a.width,a.height),i.beginPath(),i.rect(0,0,a.width,a.height),i.fillStyle=d.fill,i.fill()}(),setEyes(E=parseInt(document.getElementById("numeyes").innerHTML)),function drawEyes(){if(I){var e=document.getElementById("eyetype").innerHTML;for(n=1;n<=E;n++){if(i.beginPath(),i.fillStyle="#000000",1==e)i.arc(s[n].x,s[n].y,1.1*r,0,2*Math.PI),i.fill();else{var t=1.1*r;i.fillRect(s[n].x-t,s[n].y-t,2*t,2*t)}i.closePath()}for(n=1;n<=E;n++)i.beginPath(),i.fillStyle="#FFFFFF",1==e?(i.arc(s[n].x,s[n].y,r,0,2*Math.PI),i.fill()):(t=r,i.fillRect(s[n].x-t,s[n].y-t,2*t,2*t)),i.closePath()}else for(n=1;n<=E;n++){var n;i.beginPath(),i.arc(s[n].x,s[n].y,1.1*r,.4,Math.PI-.4),i.lineWidth=20,i.stroke(),i.closePath()}}(),function drawEyeballs(){var e;if(I)for(e=1;e<=E;e++)i.beginPath(),i.fillStyle="#000000",i.arc(s[e].x+getEyeballOffset(e).x,s[e].y+getEyeballOffset(e).y,y,0,2*Math.PI),i.fill(),i.closePath()}(),function drawMouth(){i.beginPath(),i.moveTo(h.x,h.y),i.bezierCurveTo(h.x+100,h.y+p,f.x-100,f.y+p,f.x,f.y),i.lineWidth=10,i.stroke(),i.closePath(),i.beginPath(),i.moveTo(h.x,h.y),i.bezierCurveTo(h.x+100,h.y-p,f.x-100,f.y-p,f.x,f.y),i.lineWidth=10,i.stroke(),i.closePath()}()}document.getElementById("userArea").onmouseup=function(e){!function hidePalettes(){for(var e=document.getElementsByClassName("palette"),t=0;t<e.length;t++)e[t].style.visibility="hidden"}()},document.getElementById("speakText").onmousedown=function(e){var t=document.getElementById("speaklang").innerHTML,n=document.getElementById("userText").value;b.playVoice(t,n),idleTimer()},document.getElementById("speakText").onmouseup=function(e){moveMouth(document.getElementById("userText").value),"3"==document.getElementById("mode").innerHTML&&addToChat()},document.getElementById("userText").onkeypress=function(e){if(13==(e.keyCode||e.which)){var t=document.getElementById("speaklang").innerHTML,n=document.getElementById("userText").value;b.playVoice(t,n),moveMouth(n),idleTimer(),"3"==document.getElementById("mode").innerHTML&&addToChat()}},document.getElementById("userText").oninput=function(e){var t=this.getBoundingClientRect(),n={clientX:t.left+20*document.getElementById("userText").selectionStart,clientY:t.top};setMousePosition(a,n),updateCanvas()},document.getElementById("userText").addEventListener("mousemove",(function(e){setMousePosition(a,e),updateCanvas()}),!1),document.getElementById("gamemode1-button").onmouseup=function(e){document.getElementById("mode").innerHTML="1",document.getElementById("canvas").style.display="block",closeChat()},document.getElementById("gamemode2-button").onmouseup=function(e){document.getElementById("mode").innerHTML="2",document.getElementById("canvas").style.display="block",closeChat()},document.getElementById("gamemode3-button").onmouseup=function(e){document.getElementById("mode").innerHTML="3",document.getElementById("canvas").style.display="none",function setupChat(){document.getElementById("chat").style.display="block"}()},function init(){b=Speech(),t.getEnvironment((function(e,t){var o="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language;t.user||(t.user={language:o}),L=t.user,b.init(L),B||document.captureEvents(Event.MOUSEMOVE);setInterval((function(){updateCanvas()}),1e3/30),window.addEventListener("localized",(function(){if(H)return n.language.code=L.language,void(H=!1);!function localize(){document.getElementById("gamemode1-button").title=n.get("TypeSomethingToHear"),document.getElementById("gamemode2-button").title=n.get("AskRobot"),document.getElementById("gamemode3-button").title=n.get("VoiceChat"),document.getElementById("language-button").title=n.get("Language"),document.getElementById("speech-button").title=n.get("Speech"),document.getElementById("face-button").title=n.get("Face"),document.getElementById("ratelabel").innerHTML=n.get("ratelabel"),document.getElementById("pitchlabel").innerHTML=n.get("pitchlabel"),document.getElementById("eyesnumber").innerHTML=n.get("eyesnumber"),document.getElementById("eyes").title=n.get("eyes"),document.getElementById("glasses").title=n.get("glasses"),document.getElementById("speakText").title=n.get("speak"),document.getElementById("lang-en").innerHTML=n.get("langen"),document.getElementById("lang-ca").innerHTML=n.get("langca"),document.getElementById("lang-cs").innerHTML=n.get("langcs"),document.getElementById("lang-de").innerHTML=n.get("langde"),document.getElementById("lang-el").innerHTML=n.get("langel"),document.getElementById("lang-eo").innerHTML=n.get("langeo"),document.getElementById("lang-es").innerHTML=n.get("langes"),document.getElementById("lang-fi").innerHTML=n.get("langfi"),document.getElementById("lang-fr").innerHTML=n.get("langfr"),document.getElementById("lang-hu").innerHTML=n.get("langhu"),document.getElementById("lang-it").innerHTML=n.get("langit"),document.getElementById("lang-kn").innerHTML=n.get("langkn"),document.getElementById("lang-la").innerHTML=n.get("langla"),document.getElementById("lang-lv").innerHTML=n.get("langlv"),document.getElementById("lang-nl").innerHTML=n.get("langnl"),document.getElementById("lang-pl").innerHTML=n.get("langpl"),document.getElementById("lang-pt").innerHTML=n.get("langpt"),document.getElementById("lang-ro").innerHTML=n.get("langro"),document.getElementById("lang-sk").innerHTML=n.get("langsk"),document.getElementById("lang-sv").innerHTML=n.get("langsv"),document.getElementById("lang-tr").innerHTML=n.get("langtr"),document.getElementById("lang-zh").innerHTML=n.get("langzh")}();var e=window.setTimeout((function(){window.clearTimeout(e);var t=document.getElementById("speaklang").innerHTML,o=n.get("TypeSomething",{name:L.name});document.getElementById("combo-box").title=n.get("SavedTalk"),document.getElementsByClassName("dropdown").title=n.get("SavedTalk"),b.playVoice(t,o),moveMouth(o)}),100)}))})),idleTimer()}()}));