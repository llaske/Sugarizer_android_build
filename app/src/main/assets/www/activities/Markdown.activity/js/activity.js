define(["sugar-web/activity/activity","l10n","sugar-web/datastore","sugar-web/env"],(function(t,e,n,d){requirejs(["domReady!"],(function(o){l10n=e,t.setup();var l=["insertText","wmd-bold-button-second","wmd-italic-button-second","wmd-heading-button","wmd-hr-button","wmd-olist-button","wmd-ulist-button","wmd-code-button","wmd-quote-button","wmd-link-button","wmd-undo-button","wmd-redo-button","wmd-showHideEditor-button","wmd-showHidePreview-button"];inputTextContent=document.getElementById("wmd-input-second");var s=t.getDatastoreObject();inputTextContent.onblur=function(){var t=JSON.stringify(inputTextContent.value.toString());s.setDataAsText(t),s.save((function(){}))},markdownParsing(),d.getEnvironment((function(t,e){var n="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,d=e.user?e.user.language:n;window.addEventListener("localized",(function(){for(i=0;i<l.length;i++)document.getElementById(l[i]).title=l10n.get(l[i]);e.objectId?s.loadAsText((function(t,e,n){markdowntext=JSON.parse(n),inputTextContent.value=markdowntext,markdownParsing()})):(inputTextContent.value="#"+l10n.get("sample-input"),markdownParsing())})),l10n.init(d)})),document.getElementById("insertText").onclick=function(){t.showObjectChooser((function(t,e){new n.DatastoreObject(e).loadAsText((function(t,e,n){try{textdata=JSON.parse(n)}catch(t){textdata=n}!function insertAtCursor(t,e){if(document.selection)t.focus(),sel=document.selection.createRange(),sel.text=e;else if(t.selectionStart||"0"==t.selectionStart){var n=t.selectionStart,i=t.selectionEnd;t.value=t.value.substring(0,n)+e+t.value.substring(i,t.value.length)}else t.value+=e}(document.getElementById("wmd-input-second"),textdata)}))}))};var u=document.getElementById("wmd-showHideEditor-button"),a=document.getElementById("wmd-showHidePreview-button"),r=document.getElementById("wmd-panel"),c=document.getElementById("wmd-preview-second");document.getElementById("wmd-input-second");function isElementHidden(t){return"none"===window.getComputedStyle(t,null).getPropertyValue("display")}function markdownParsing(){var t=new Markdown.Converter,e={helpButton:{handler:function(){alert(l10n.get("need-help"))}},strings:{quoteexample:l10n.get("put-it-right-here")}};new Markdown.Editor(t,"-second",e).run()}u.onclick=function(){isElementHidden(c)&&(c.style.display="inline",c.style.width="97%",r.style.width="1%"),isElementHidden(r)?(r.style.display="inline",r.style.width="47%",c.style.width="47%"):(r.style.display="none",r.style.width="1%",c.style.width="97%")},a.onclick=function(){isElementHidden(r)&&(r.style.display="inline",r.style.width="97%",c.style.width="1%"),isElementHidden(c)?(c.style.display="inline",c.style.width="47%",r.style.width="47%"):(c.style.display="none",c.style.width="1%",r.style.width="94%")}}))}));