requirejs.config({baseUrl:"lib",paths:{activity:"../js"}});const CHART_TYPES={line:"stringLineChart",horizontalBar:"stringHorizontalBarChart",bar:"stringVerticalBarChart",pie:"stringPieChart"},app=new Vue({el:"#app",components:{chartview:ChartView,"csv-view":CsvView},data:{isLocalized:!1,pendingNewInstance:!1,currentenv:null,SugarL10n:null,SugarPresence:null,activityTitle:"",tabularData:[],jsonData:{data:[],header:[]},pref:{chartType:"bar",chartColor:{stroke:"",fill:""},labels:{x:"",y:""},font:{propertyOrder:["title","labels","tick"],title:{fontsize:26,fontfamily:"Arial",color:"#005fe4"},labels:{fontsize:22,fontfamily:"Arial",color:"#555555"},tick:{fontsize:14,fontfamily:"Arial",color:"#282828"}}},selectedField:{i:0,axis:"x"},selectedFontIdx:0,l10n:{stringChartActivity:"",stringAddValue:"",stringRemoveValue:"",stringVerticalBarChart:"",stringHorizontalBarChart:"",stringLineChart:"",stringPieChart:"",stringPieChartText:"",stringChartColor:"",stringLineColor:"",stringHorizontalLabel:"",stringVerticalLabel:"",stringFontColor:"",stringFontColorText:"",stringSelectFont:"",stringSelectFontText:"",stringTitleFont:"",stringTitleFontText:"",stringLabelsFont:"",stringLabelsFontText:"",stringTickFont:"",stringTickFontText:"",stringFontMinusButton:"",stringFontPlusButton:"",stringFullscreen:"",stringNetwork:"",stringMoveUp:"",stringMoveDown:"",stringLabel:"",stringValue:"",stringHelp:"",stringConfigs:"",stringTextPalette:"",stringTextPaletteText:"",stringTutoPrev:"",stringTutoNext:"",stringTutoEnd:"",stringTutoExplainContent:"",stringTutoAddData:"",stringTutoAddButton:"",stringTutoRemoveButton:"",stringTutoChartTitle:"",stringTutoChartType:"",stringTutoConfig:"",stringTutoSaveImage:"",stringTutoExportCsv:"",stringexportAsCSV:"",stringSaveImage:"",stringInsertChart:"",stringTutoViewCsv:"",stringLines:"",stringVerticalBars:"",stringHorizontalBars:"",stringExportSettings:"",stringViewCsv:"",stringTutoCsvColumn1:"",stringTutoCsvColumn2:"",stringTutoCsvNumOnly:"",stringTutoCsvRightArr:"",stringTutoCsvLeftArr:""},configActive:!1,textPalActive:!1,isFullscreen:!1},created(){this.palettes={}},mounted(){this.SugarL10n=this.$refs.SugarL10n,this.SugarPresence=this.$refs.SugarPresence,this.SugarPopup=this.$refs.SugarPopup,this.SugarJournal=this.$refs.SugarJournal,this.chartview=this.$refs.chartview},methods:{initialized(){const t=this.$refs;this.palettes.strokeColor=t.strokeColorPal.paletteObject,this.palettes.fillColor=t.fillColorPal.paletteObject,this.palettes.textColor=t.textColorPal.paletteObject,this.palettes.font=t.fontPal.paletteObject,this.palettes.share=t.sharedPal.paletteObject,this.palettes.export=t.exportPal.paletteObject,this.currentenv=t.SugarActivity.getEnvironment();const{stroke:e,fill:i}=this.currentenv.user.colorvalue;this.pref.chartColor={stroke:e,fill:i},this.updateActivityTitle(this.currentenv.activityName),this.updatePalletes();this.activityInput=document.querySelector("#activity-palette .container input"),this.activityInput.addEventListener("input",(t=>{this.updateActivityTitle(t.target.value),t.target.value=this.activityInput.value}))},localized(){this.isLocalized=!0,this.SugarL10n.localize(this.l10n),document.getElementById("export-csv-button").title=this.l10n.stringexportAsCSV,document.getElementById("export-img-button").title=this.l10n.stringSaveImage,this.pendingNewInstance&&(this.onJournalNewInstance(),this.pendingNewInstance=!1)},addData(){const t={x:this.tabularData.length+1,y:Math.floor(10*Math.random()+1)+""};this.executeAndSendAction(Action_Types.ADD_TABLE_DATA,{obj:t});var e=this.tabularData.length-1;this.$nextTick((function(){this.$refs.input[e].focus()})),this.selectedField.i=e},removeData(){this.selectedField.i<0||(this.executeAndSendAction(Action_Types.REMOVE_TABLE_DATA,{idx:this.selectedField.i}),this.selectedField.i--,this.selectedField.i<0&&(this.selectedField.i+=this.tabularData.length))},validateInput(t){t.target.value=t.target.value.replace(/[^0-9.-]/g,"").replace(/(\..*?)\..*/g,"$1").replace(/(?!^)-/g,""),this.updateInput(t)},updateInput(t){const e={selectedField:this.selectedField,value:t.target.value};this.executeAndSendAction(Action_Types.UPDATE_TABLE_DATA,e)},swapUp(){this.tabularData;let t=this.selectedField.i;t<1||(this.executeAndSendAction(Action_Types.SWAP_DATA,{a:t,b:t-1}),t--,this.selectedField.i=t)},swapDown(){const t=this.tabularData;let e=this.selectedField.i;!t.length||e>t.length-2||(this.executeAndSendAction(Action_Types.SWAP_DATA,{a:e,b:e+1}),e++,this.selectedField.i=e)},popDownPal(){for(const t in this.palettes)this.palettes[t]&&this.palettes[t].popDown()},toggleConfig(){this.executeAndSendAction(Action_Types.TOGGLE_PALETTE,{configActive:!this.configActive,textPalActive:!1})},toggleTextPal(){this.executeAndSendAction(Action_Types.TOGGLE_PALETTE,{textPalActive:!this.textPalActive,configActive:!1})},onNetworkDataReceived(t){Execute[t.content.action](this,t)},onNetworkUserChanged(t){if(this.SugarPresence.isHost){const t={user:this.SugarPresence.getUserInfo(),content:{action:Action_Types.INIT,data:{tabularData:this.tabularData,pref:this.pref,title:this.activityTitle,csvJsonData:this.jsonData}}};this.SugarPresence.sendMessage(t)}},executeAndSendAction(t,e){const i={content:{action:t,data:e}};Execute[t](this,i),this.SugarPresence.isShared()&&(i.user=this.SugarPresence.getUserInfo(),this.SugarPresence.sendMessage(i))},onJournalNewInstance(){if(!this.isLocalized)return void(this.pendingNewInstance=!0);const t=this.shuffleArray([1,2,3,4,5,6]);for(let e=0;e<3;e++){const i="EgLabel"+t[e];this.tabularData.push({x:this.SugarL10n.get(i),y:t[e]+6+""})}this.pref.labels.x=this.SugarL10n.get("Sports"),this.pref.labels.y=this.SugarL10n.get("Students"),this.updateActivityTitle(this.l10n.stringChartActivity);const e=[this.pref.labels.x,this.pref.labels.y];this.$refs.csvView.updateJsonData(this.tabularData,e,!0)},onJournalDataLoaded(t,e){if(this.LZ=this.SugarJournal.LZString,"text/csv"===e.mimetype){this.isCsvFile=!0,this.csvTitle=this.currentenv.activityName,this.pref.chartType="csvMode";const e=CSVParser.csvToJson(t);return void this.$refs.csvView.updateJsonData(e.data,e.headers)}const i=JSON.parse(this.LZ.decompressFromUTF16(t)),s=i.pref;let n=s.labels.x;n==s.labels.y&&(n+="__"),this.$refs.csvView.updateJsonData(i.tabularData,[n,s.labels.y],!0),this.updatePreference(s)},exportFile(t){switch(t.format){case"csv":this.exportAsCsv();break;case"png":this.exportAsImage()}},exportAsImage(){const{imgData:t,metadata:e}=this.chartview.getImgData();this.createJournalEntry(t,e,this.SugarL10n.get("exportImage"))},exportAsCsv(){const t=[this.pref.labels.x,this.pref.labels.y],e=CSVParser.jsonToCsv(this.tabularData,t),i={mimetype:"text/csv",title:this.activityTitle+".csv",activity:"org.sugarlabs.ChartActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};this.createJournalEntry(e,i,this.SugarL10n.get("exportedLogAsCSV"))},createJournalEntry(t,e,i){this.SugarJournal.createEntry(t,e).then((()=>{i&&this.SugarPopup.log(i)}))},handleDataChange(t,e){let i="label"===t?"x":"y";this.pref.labels[i]=e.startsWith("__")?"":e,this.jsonData.data.forEach(((t,s)=>{let n=t[e];"y"===i&&void 0!==n&&(n=n.replace(/,/g,"")),this.tabularData[s]||this.tabularData.push({x:"",y:""}),this.tabularData[s][i]=n}))},handleColSwap(t,e){this.executeAndSendAction(Action_Types.SWAP_COLUMN,{a:t,b:e})},handleLabel(t,e){this.executeAndSendAction(Action_Types.UPDATE_LABEL,{value:t.target.value,axis:e})},handleChartColor(t,e){this.executeAndSendAction(Action_Types.UPDATE_CHART_COLOR,{color:t.detail.color,type:e})},setChartType(t){if("bar"===this.pref.chartType&&"horizontalBar"===t||"horizontalBar"===this.pref.chartType&&"bar"===t){const t=this.pref.labels.x;this.pref.labels.x=this.pref.labels.y,this.pref.labels.y=t}this.executeAndSendAction(Action_Types.UPDATE_CHART_TYPE,{chartType:t})},handleTextColor(t){this.executeAndSendAction(Action_Types.UPDATE_TEXT_COLOR,{selectedFontIdx:this.selectedFontIdx,color:t.detail.color})},handleFontFamily(t){this.executeAndSendAction(Action_Types.UPDATE_FONT_FAMILY,{selectedFontIdx:this.selectedFontIdx,family:t.detail.family})},handleFontSize(t){this.executeAndSendAction(Action_Types.UPDATE_FONT_SIZE,{selectedFontIdx:this.selectedFontIdx,value:t})},updateActivityTitle(t){this.executeAndSendAction(Action_Types.UPDATE_TITLE,{title:t})},updateTitleInput(t){const e=document.activeElement;this.activityInput.style.visibility="visible",this.activityInput.value=t,this.activityInput.focus(),this.activityInput.blur(),e.focus(),this.activityInput.style.visibility="unset"},updatePalletes(){this.palettes.strokeColor.setColor(this.pref.chartColor.stroke),this.palettes.fillColor.setColor(this.pref.chartColor.fill),this.palettes.textColor.setColor(this.pref.font.title.color),this.palettes.font.setFont(this.pref.font.title.fontfamily)},updateFontField(t){this.selectedFontIdx=t,this.palettes.textColor.setColor(this.selectedFontField.color),this.palettes.font.setFont(this.selectedFontField.fontfamily)},updatePreference(t){this.pref=t,this.$nextTick((function(){this.chartview.updateChartColor(),this.chartview.updateChartType(),this.updatePalletes(),["x","y"].forEach((t=>{this.chartview.updateLabel(t)})),["color","fontsize","fontfamily"].forEach((t=>{this.pref.font.propertyOrder.forEach((e=>{this.chartview.updateFontValues(e,t)}))}))}))},setSelectedField(t,e){this.selectedField.i=t,this.selectedField.axis=e},onHelp(){const t=[{title:this.l10n.stringChartActivity,intro:this.l10n.stringTutoExplainContent},{element:"#activity-button",position:"bottom",title:this.l10n.stringChartActivity,intro:this.l10n.stringTutoChartTitle},{element:"#add-button",position:"bottom",title:this.l10n.stringAddValue,intro:this.l10n.stringTutoAddData},{element:"#remove-button",position:"bottom",title:this.l10n.stringRemoveValue,intro:this.l10n.stringTutoRemoveButton},{title:this.l10n.stringChartActivity,intro:this.l10n.stringTutoChartType},{element:"#line-chart-button",position:"bottom",title:this.l10n.stringLineChart,intro:this.l10n.stringLines},{element:"#horizontalBar-chart-button",position:"bottom",title:this.l10n.stringHorizontalBarChart,intro:this.l10n.stringHorizontalBars},{element:"#bar-chart-button",position:"bottom",title:this.l10n.stringVerticalBarChart,intro:this.l10n.stringVerticalBars},{element:"#pie-chart-button",position:"bottom",title:this.l10n.stringPieChart,intro:this.l10n.stringPieChartText},{element:"#csv-button",position:"bottom",title:this.l10n.stringViewCsv,intro:this.l10n.stringTutoViewCsv},{element:".csv-header #header0",position:"right",title:this.l10n.stringViewCsv,intro:this.l10n.stringTutoCsvColumn1},{element:".csv-header #header1",position:"right",title:this.l10n.stringViewCsv,intro:`${this.l10n.stringTutoCsvColumn2}. ${this.l10n.stringTutoCsvNumOnly}`},{element:".csv-view #up-button",position:"top",title:this.l10n.stringViewCsv,intro:this.l10n.stringTutoCsvLeftArr},{element:".csv-view #down-button",position:"top",title:this.l10n.stringViewCsv,intro:this.l10n.stringTutoCsvRightArr},{element:"#config-button",position:"bottom",title:this.l10n.stringConfigs,intro:this.l10n.stringTutoConfig},{element:"#text-palette-button",position:"bottom",title:this.l10n.stringTextPalette,intro:this.l10n.stringTextPaletteText},{element:"#title-font-button",position:"bottom",title:this.l10n.stringTitleFont,intro:this.l10n.stringTitleFontText},{element:"#labels-font-button",position:"bottom",title:this.l10n.stringLabelsFont,intro:this.l10n.stringLabelsFontText},{element:"#tick-font-button",position:"bottom",title:this.l10n.stringTickFont,intro:this.l10n.stringTickFontText},{element:"#font-button",position:"bottom",title:this.l10n.stringSelectFont,intro:this.l10n.stringSelectFontText},{element:"#text-color",position:"bottom",title:this.l10n.stringFontColor,intro:this.l10n.stringFontColorText},{element:"#export-img-button",position:"bottom",title:this.l10n.stringSaveImage,intro:this.l10n.stringTutoSaveImage},{element:"#export-csv-button",position:"bottom",title:this.l10n.stringexportAsCSV,intro:this.l10n.stringTutoExportCsv}],e=this.$refs.SugarTutorial.introJs;e.onbeforechange((t=>{switch(t.id){case"pie-chart-button":case"config-button":this.$refs.csvView.$refs.csvView.style.zIndex="unset",this.textPalActive=!1;break;case"header0":case"header1":setTimeout((()=>{document.querySelector(".introjs-helperLayer").style.height="calc(100vh - 95px)"}),0);case"down-button":this.pref.chartType="csvMode",this.$refs.csvView.$refs.csvView.style.zIndex="9999991";break;case"title-font-button":this.pref.chartType=CHART_TYPES.line,this.textPalActive=!0,this.palettes.export.popDown();break;case"export-img-button":this.palettes.export.popUp()}})),e.onexit((()=>{this.textPalActive=!1,this.palettes.export.popDown()})),this.configActive=this.textPalActive=!1,this.$refs.SugarTutorial.show(t)},onStop(){const t={tabularData:this.tabularData,pref:this.pref};if(this.isCsvFile){const i={title:this.activityTitle,activity:"org.sugarlabs.ChartActivity",timestamp:(new Date).getTime()+1e3,creation_time:(new Date).getTime()+1e3,file_size:0};var e=this.LZ.compressToUTF16(JSON.stringify(t));return this.createJournalEntry(e,i),void this.updateTitleInput(this.csvTitle)}this.$refs.SugarJournal.saveData(t)},shuffleArray(t){for(let e=t.length-1;e>0;e--){const i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}return t}},computed:{selectedFontField(){return this.pref.font[this.selectedFontName]},selectedFontName(){const t=this.selectedFontIdx;return this.pref.font.propertyOrder[t]}},watch:{"pref.labels.x"(){this.chartview.updateLabel("x")},"pref.labels.y"(){this.chartview.updateLabel("y")},"pref.chartType"(){"csvMode"!==this.pref.chartType&&this.chartview.updateChartType()},"pref.chartColor":{handler(){this.chartview.updateChartColor()},deep:!0},"selectedFontField.color"(){this.chartview.updateFontValues(this.selectedFontName,"color")},"selectedFontField.fontfamily"(){this.chartview.updateFontValues(this.selectedFontName,"fontfamily")},"selectedFontField.fontsize"(){this.chartview.updateFontValues(this.selectedFontName,"fontsize")}}});