define(["sugar-web/activity/activity","sugar-web/env","sugar-web/graphics/icon","webL10n","sugar-web/graphics/presencepalette","toolpalette","humane","tutorial"],(function(e,t,n,o,r,a,d,s){requirejs(["domReady!"],(function(n){e.setup();var i=document.getElementById("level-button"),l=[{id:1,title:o.get("easy")},{id:2,title:o.get("medium")},{id:3,title:o.get("hard")}];levelpalette=new a.FilterPalette(i,void 0),levelpalette.setCategories(l),levelpalette.addEventListener("filter",(function(){!function setLevel(e){var t=p;1===e?t="easy":2===e?t="medium":3===e&&(t="hard");p!==t&&(p=t,startGame())}(levelpalette.getFilter()),levelpalette.popDown()}));var c=document.getElementById("filter-button");fpalette=new a.FilterPalette(c,void 0),fpalette.setCategories([{id:1,title:"+"},{id:2,title:"-"},{id:3,title:"x"},{id:4,title:"+ / x / -"}]),fpalette.addEventListener("filter",(function(){!function setOperation(e){E!==e&&(E=e,startGame())}(fpalette.getFilter()),fpalette.popDown()}));var u=null,m=!1,g=new r.PresencePalette(document.getElementById("network-button"),void 0);g.addEventListener("shared",(function(){g.popDown(),u=e.getPresenceObject((function(e,t){e?console.log("Sharing error"):(t.createSharedActivity("org.sugarlabs.SprintMath",(function(e){console.log("Activity shared"),hidetoolbarbuttons(),m=!0})),t.onDataReceived(onNetworkDataReceived),t.onSharedActivityUserChanged(onNetworkUserChanged))}))}));var v,h,f,y=!1,b=[],I=0,p="easy",E=1,w=[],B=[],M=!1;function hide(e){document.getElementById(e).style.display="none"}function show(e){document.getElementById(e).style.display="block"}function gameOver(){clearInterval(h),document.getElementById("timeremaining").innerHTML=60,hide("time"),hide("correct"),hide("score"),hide("wrong"),hide("box1"),hide("box2"),hide("box3"),hide("box4"),show("gameOver"),function setGameOverMessage(){u?(u.sendMessage(u.getSharedInfo().id,{user:u.getUserInfo(),content:{action:"gameover",data:v}}),w.push({user:currentenv.user,score:v}),showAllUserScores()):(document.getElementById("gameOver").innerHTML=o.get("GameOver",{name:currentenv.user.name,score:v}),document.getElementById("gameOver").style.backgroundColor=currentenv.user.colorvalue.stroke,document.getElementById("gameOver").style.color=currentenv.user.colorvalue.fill);document.getElementById("question").innerHTML="";for(var e=1;e<5;e++)document.getElementById("box"+e).innerHTML=""}(),M=!0,!(y=!1)&&u&&m&&hidetoolbarbuttons()}function showAllUserScores(){var e=document.createElement("div");for(L=0;L<w.length;L++){(t=document.createElement("div")).innerHTML=o.get("GameOver",{name:w[L].user.name,score:w[L].score}),t.style.backgroundColor=w[L].user.colorvalue.stroke,t.style.color=w[L].user.colorvalue.fill,e.appendChild(t)}for(L=0;L<B.length;L++){var t;(t=document.createElement("div")).innerHTML=o.get("GamePlaying",{name:B[L].name}),t.style.backgroundColor=B[L].colorvalue.stroke,t.style.color=B[L].colorvalue.fill,e.appendChild(t)}document.getElementById("gameOver").innerHTML="",document.getElementById("gameOver").appendChild(e)}function startCountdown(){h=setInterval((function(){f-=1,document.getElementById("timeremaining").innerHTML=f,0==f&&gameOver()}),1e3)}for(var L=1;L<5;L++)document.getElementById("box"+L).onclick=function(){var e=b[I].answer;y&&(this.innerHTML==e?(v++,document.getElementById("scorevalue").innerHTML=v,hide("wrong"),show("correct"),setTimeout((function(){hide("correct")}),1e3),I++,displayCurrentQuestion()):(show("wrong"),hide("correct"),setTimeout((function(){hide("wrong")}),1e3)))};function startGame(){clearInterval(h),v=0,y=!0,f=60,I=0,document.getElementById("scorevalue").innerHTML=v,hide("gameOver"),show("time"),show("box1"),show("box2"),show("box3"),show("box4"),show("score"),startCountdown(),u?m&&(w=[],(B=[]).push(currentenv.user)):(b=[],generateQuestions()),M&&!m&&(B.push(currentenv.user),adduser()),y&&u&&(m&&(b=[],generateQuestions()),hidetoolbarbuttons(),displayCurrentQuestion())}function generateQuestions(){for(L=0;L<200;L++){var e=5;"easy"===p?e=5:"medium"===p?e=7:"hard"===p&&(e=10);var t=1;t=4===E?1+Math.round(3*Math.random()):E;var n,o,r=1+Math.round((e-1)*Math.random()),a=1+Math.round((e-1)*Math.random());1===t?(o=r+a,n=r+"+"+a):2===t?r>=a?(o=r-a,n=r+"-"+a):(o=a-r,n=a+"-"+r):(o=r*a,n=r+"x"+a);for(var d=[o],s=1;s<4;s++){var i;do{i=1===E||2===E?1+Math.round((e+e)*Math.random()):1+Math.round(e*e*Math.random())}while(d.indexOf(i)>-1);d.push(i)}shuffleArray(d),b.push({question:n,answer:o,choices:d})}u&&m&&u.sendMessage(u.getSharedInfo().id,{user:u.getUserInfo(),content:{action:"init",data:b,gameover:w,gameplaying:B}}),displayCurrentQuestion()}function shuffleArray(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),o=e[t];e[t]=e[n],e[n]=o}}function displayCurrentQuestion(){var e=b[I].question,t=b[I].choices;document.getElementById("question").innerHTML=e;for(var n=1;n<5;n++)document.getElementById("box"+n).innerHTML=t[n-1]}document.getElementById("restart-button").onclick=startGame,document.getElementById("help-button").addEventListener("click",(function(e){s.start()})),document.getElementById("stop-button").addEventListener("click",(function(t){console.log("writing..."),object_store={play:y,score:v,timeremaining:f,questions:b,questionNumber:I,gameLevel:p,gameOperation:E};var n=JSON.stringify(object_store);e.getDatastoreObject().setDataAsText(n),e.getDatastoreObject().save((function(e){null===e?console.log("write done."):console.log("write failed.")}))})),t.getEnvironment((function(t,n){currentenv=n,function setColor(e,t){document.getElementById("box1").style.backgroundColor=t,document.getElementById("box2").style.backgroundColor=t,document.getElementById("box3").style.backgroundColor=t,document.getElementById("box4").style.backgroundColor=t,tinycolor(t).isLight()?document.getElementById("choices").style.color="black":document.getElementById("choices").style.color="white";document.getElementById("container").style.color=e}(currentenv.user.colorvalue.fill,currentenv.user.colorvalue.stroke);var r="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,a=n.user?n.user.language:r;o.language.code=a,n.objectId?e.getDatastoreObject().loadAsText((function(e,t,n){null==e&&null!=n?(stored_data=JSON.parse(n),y=stored_data.play,v=stored_data.score,f=stored_data.timeremaining,b=stored_data.questions,I=stored_data.questionNumber,p=stored_data.gameLevel,E=stored_data.gameOperation,y&&f>0?function resumeGame(){document.getElementById("scorevalue").innerHTML=v,document.getElementById("timeremaining").innerHTML=f,show("time"),startCountdown(),displayCurrentQuestion()}():startGame()):console.log(e)})):startGame(),n.sharedId&&(hidetoolbarbuttons(),u=e.getPresenceObject((function(e,t){t.onDataReceived(onNetworkDataReceived),t.onSharedActivityUserChanged(onNetworkUserChanged)})))})),window.addEventListener("localized",(function(){document.getElementById("timeString").innerHTML=o.get("Time"),document.getElementById("scoreString").innerHTML=o.get("Score"),document.getElementById("correct").innerHTML=o.get("correct"),document.getElementById("wrong").innerHTML=o.get("wrong");var e=[{id:1,title:o.get("easy")},{id:2,title:o.get("medium")},{id:3,title:o.get("hard")}];levelpalette.setCategories(e)}));var onNetworkDataReceived=function(e){if(u.getUserInfo().networkId!==e.user.networkId)switch(e.content.action){case"init":0===B.length&&(b=e.content.data,w=e.content.gameover,B=e.content.gameplaying,startGame());break;case"adduser":B=e.content.data,showAllUserScores();break;case"removeuser":0===(B=e.content.data).length&&m&&function showtoolbarbuttons(){document.getElementById("restart-button").disabled=!1,document.getElementById("filter-button").disabled=!1,document.getElementById("level-button").disabled=!1,document.getElementById("restart-button").classList.remove("disabled"),document.getElementById("filter-button").classList.remove("disabled"),document.getElementById("level-button").classList.remove("disabled")}(),showAllUserScores();break;case"gameover":B=B.filter((function(t){return t.name!==e.user.name})),u&&u.sendMessage(u.getSharedInfo().id,{user:u.getUserInfo(),content:{action:"removeuser",data:B}}),w.push({user:e.user,score:e.content.data}),showAllUserScores()}},onNetworkUserChanged=function(e){m&&(u.sendMessage(u.getSharedInfo().id,{user:u.getUserInfo(),content:{action:"init",data:b,gameover:w,gameplaying:B}}),1===e.move&&(B.push(e.user),adduser()),-1===e.move&&(B=B.filter((function(t){return t.name!==e.user.name})),function removeuser(){u.sendMessage(u.getSharedInfo().id,{user:u.getUserInfo(),content:{action:"removeuser",data:B}})}()),showAllUserScores());var t=e.user.name.replace("<","&lt;").replace(">","&gt;");1===e.move?d.log(o.get("joined",{name:t})):d.log(o.get("left",{name:t}))};function adduser(){u&&u.sendMessage(u.getSharedInfo().id,{user:u.getUserInfo(),content:{action:"adduser",data:B}})}function hidetoolbarbuttons(){document.getElementById("restart-button").disabled=!0,document.getElementById("filter-button").disabled=!0,document.getElementById("level-button").disabled=!0,document.getElementById("restart-button").classList.add("disabled"),document.getElementById("filter-button").classList.add("disabled"),document.getElementById("level-button").classList.add("disabled")}}))}));