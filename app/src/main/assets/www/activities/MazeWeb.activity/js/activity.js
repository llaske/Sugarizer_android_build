define(["sugar-web/activity/activity","tween","rAF","activity/directions","sugar-web/graphics/presencepalette","sugar-web/env","sugar-web/graphics/icon","l10n","sugar-web/graphics/palette","rot","humane","tutorial"],(function(t,e,n,o,i,r,a,s,l,c,d,h){requirejs(["domReady!"],(function(n){t.setup();var a={},l=0,u=0;a.width=void 0,a.height=void 0,a.startPoint={},a.goalPoint={},a.walls=[],a.visited=[],a.directions=[],a.forks=[];r.getEnvironment((function(e,n){var o="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,i=n.user?n.user.language:o;s.init(i),n.sharedId&&(console.log("Shared instance"),A=t.getPresenceObject((function(t,e){e.onDataReceived(onNetworkDataReceived),e.onSharedActivityUserChanged(onNetworkUserChanged)}))),n.objectId&&t.getDatastoreObject().loadAsText((function(t,e,n){null==t&&null!=n&&(n=JSON.parse(n),a=n.maze,B=n.gameSize,updateMazeSize(),updateSprites(),onLevelStart())}))})),document.getElementById("fullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.opacity=0,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",onWindowResize()})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",onWindowResize()}));var f,g,v,w,y,m,p,x,b,generateXOLogoWithColor=function(t){var e='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>';return e=(e=e.replace("#010101",t.stroke)).replace("#FFFFFF",t.fill),"data:image/svg+xml;base64,"+btoa(e)},onNetworkDataReceived=function(t){if(A.getUserInfo().networkId!==t.user.networkId)switch(t.action){case"start":!1,l=0,a=t.content,B=t.SizeOfGame,u=t.oponentCount,updateMazeSize(),updateSprites(),onLevelStart();break;case"ended":l++;var e=t.user.name.replace("<","&lt;").replace(">","&gt;"),n="<img style='height:30px;' src='"+generateXOLogoWithColor(t.user.colorvalue)+"'>";d.log(n+s.get("PlayerEndLevel",{user:e}))}},onNetworkUserChanged=function(t){var e=t.user.name.replace("<","&lt;").replace(">","&gt;"),n="<img style='height:30px;' src='"+generateXOLogoWithColor(t.user.colorvalue)+"'>";1===t.move?(u++,d.log(n+s.get("PlayerJoin",{user:e}))):-1===t.move&&(u--,d.log(n+s.get("PlayerLeave",{user:e}))),F&&A.sendMessage(A.getSharedInfo().id,{user:A.getUserInfo(),action:"start",SizeOfGame:B,oponentCount:u,content:a}),console.log("User "+t.user.name+" "+(1==t.move?"join":"leave"))},P=".mp3",k="hsl(0, 0%, 80%)",I=[],E={arrows:[38,39,40,37],wasd:[87,68,83,65],ijkl:[73,76,75,74],mouse:[-1,-1,-1,-1]},M=["arrows","wasd","ijkl","mouse"],C={},S={},T={},B=60,O=document.getElementById("maze"),L=document.createElement("canvas"),updateMazeSize=function(){var t=document.getElementById("main-toolbar");f=window.innerWidth,g="visible"==document.getElementById("unfullscreen-button").style.visibility?window.innerHeight-3:window.innerHeight-t.offsetHeight-3,w=Math.floor(f/a.width),y=Math.floor(g/a.height),O.width=f,O.height=g,L.width=2*w,L.height=y*M.length},onWindowResize=function(){updateMazeSize(),updateSprites(),drawMaze()};window.addEventListener("resize",onWindowResize);var updateSprites=function(){for(control in E)control in C&&createPlayerSprite(control)},createPlayerSprite=function(t){var e=M.indexOf(t);return ctx=L.getContext("2d"),drawPlayerFace(ctx,0,e,C[t].normal),drawPlayerFace(ctx,1,e,C[t].blocked),{normal:{image:L,x:0,y:e},blocked:{image:L,x:1,y:e}}},drawCell=function(t,e,n,o){t.fillStyle=o,t.fillRect(w*e,y*n,w,y)},drawGround=function(t,e,n,o){drawCell(t,e,n,1==o?"#101010":"#ffffff")},drawPoint=function(t,e,n,o,i){var r=w*(e+.5),a=y*(n+.5),s=i*Math.min(w,y)/2;t.beginPath(),t.arc(r,a,s,0,2*Math.PI,!1),t.fillStyle=o,t.fill()},drawPlayerFace=function(t,e,n,o){drawPoint(t,e,n,o,.9);var i=w*(e+.3),r=y*(n+.45),a=.28*Math.min(w,y)/2;t.beginPath(),t.arc(i,r,a,0,2*Math.PI,!1);var s=w*(e+.7),l=y*(n+.45);t.arc(s,l,a,0,2*Math.PI,!1),t.fillStyle="#ffffff",t.fill(),t.beginPath(),t.arc(i,r,a/2,0,2*Math.PI,!1),t.arc(s,l,a/2,0,2*Math.PI,!1),t.fillStyle="#000000",t.fill(),t.beginPath(),t.moveTo(w*(e+.25),y*(n+.65)),t.quadraticCurveTo(w*(e+.5),y*(n+.75),w*(e+.75),y*(n+.65)),t.quadraticCurveTo(w*(e+.5),y*(n+.75),w*(e+.75),y*(n+.65)),t.quadraticCurveTo(w*(e+.5),y*(n+1),w*(e+.25),y*(n+.65)),t.quadraticCurveTo(w*(e+.5),y*(n+1),w*(e+.25),y*(n+.65)),t.fillStyle="#ffffff",t.fill()},drawSprite=function(t,e,n,o){t.drawImage(o.image,w*o.x,y*o.y,w,y,w*e,y*n,w,y)},drawMaze=function(t){void 0===t&&(t=O.getContext("2d"));for(var e=0;e<a.width;e++)for(var n=0;n<a.height;n++)drawGround(t,e,n,a.walls[e][n]),void 0!==a.visited[e][n]&&drawPoint(t,e,n,a.visited[e][n],.5);for(control in drawPoint(t,a.startPoint.x,a.startPoint.y,k,.9),drawPlayerFace(t,a.startPoint.x,a.startPoint.y,"hsl(0, 90%, 50%)"),drawCell(t,a.goalPoint.x,a.goalPoint.y,v),T){var o=T[control];drawSprite(t,e,n,o.sprite)}},onLevelStart=function(){p="starting",tween=new e.Tween({t:0}),tween.to({t:1},900),tween.easing(e.Easing.Quadratic.InOut),tween.onUpdate((function(){b=this.t})),tween.onComplete((function(){b=void 0,p="playing",drawMaze()})),tween.start()},nextLevel=function(){B*=1.2,I=[],runLevel()},Player=function(t){if(this.control=t,this.x=a.startPoint.x,this.y=a.startPoint.y,!(t in C)){var e=Math.floor(360*Math.random());C[t]={normal:"hsl("+e+", 90%, 50%)",blocked:"hsl("+e+", 90%, 80%)",visited:"hsl("+e+", 30%, 80%)"},S[t]=createPlayerSprite(t)}this.color=C[t].normal,this.sprite=S[t].normal,this.visitedColor=C[t].visited,this.path=void 0,this.animation=void 0,this.blockTween=void 0,I.push({x:this.x,y:this.y})},countOptions=function(t,e){return a.directions[t][e].reduce((function(t,e){return t+e}))},isDeadEnd=function(t,e){return 1==countOptions(t,e)},isFork=function(t,e){return countOptions(t,e)>2},initialize=function(t,e){var n,o,i,r,s,l;a.height=Math.sqrt(e/t),a.width=a.height*t,a.height=Math.floor(a.height),a.width=Math.floor(a.width),n=a.width%2?a.width-2:a.width-3,o=a.height%2?a.height-2:a.height-3,Math.random()<.5?(i=1,l=n):(i=n,l=1),Math.random()<.5?(s=1,r=o):(s=o,r=1),a.startPoint={x:i,y:s},a.goalPoint={x:l,y:r}},createMatrix=function(t,e){for(var n=[],o=0;o<t;o++)n[o]=new Array(e);return n},onCellGenerated=function(t,e,n){a.walls[t][e]=n},findDirections=function(){for(var t=0;t<a.width;t++)for(var e=0;e<a.height;e++)a.directions[t][e]=getDirections(t,e)},getDirections=function(t,e){var n=[0,0,0,0];return 1==a.walls[t][e]||(0==a.walls[t-1][e]&&(n[o.west]=1),0==a.walls[t+1][e]&&(n[o.east]=1),0==a.walls[t][e-1]&&(n[o.north]=1),0==a.walls[t][e+1]&&(n[o.south]=1)),n},findForks=function(){for(var t=0;t<a.width;t++)for(var e=0;e<a.height;e++)(isDeadEnd(t,e)||isFork(t,e))&&(a.forks[t][e]=1)},runLevel=function(){var t;t=window.innerWidth/window.innerHeight,initialize(t,B),a.walls=createMatrix(a.width,a.height),a.visited=createMatrix(a.width,a.height),a.directions=createMatrix(a.width,a.height),a.forks=createMatrix(a.width,a.height),new c.Map.IceyMaze(a.width,a.height,1).create(onCellGenerated),findDirections(),findForks(),updateMazeSize(),updateSprites(),A&&A.sendMessage(A.getSharedInfo().id,{user:A.getUserInfo(),action:"start",SizeOfGame:B,content:a,oponentCount:u}),!1,l=0,T={},m=void 0,onLevelStart()};runLevel(),document.getElementById("restart-button").addEventListener("click",(function(t){B=60,I=[],runLevel()})),document.getElementById("help-button").addEventListener("click",(function(t){h.start()})),Player.prototype.isMoving=function(){return void 0!==this.animation},Player.prototype.canGo=function(t){return 1==a.directions[this.x][this.y][o[t]]},Player.prototype.findPath=function(t){var find=function(t,e,n,i){if(!i&&(isDeadEnd(t,e)||isFork(t,e)))return[];var r=function(t,e,n){var i=t,r=e;"north"==n&&(r-=1),"east"==n&&(i+=1),"south"==n&&(r+=1),"west"==n&&(i-=1);var s=a.directions[i][r].slice(0);return s[o[o.getOpposite(n)]]=0,{x:i,y:r,direction:o.orders[s.indexOf(1)]}}(t,e,n),s=find(r.x,r.y,r.direction,!1);return s.unshift(n),s};return find(this.x,this.y,t,!0)},Player.prototype.stop=function(){clearInterval(this.animation),this.animation=void 0},Player.prototype.showBlocked=function(){var t=this;function restoreColor(){t.color=C[t.control].normal,t.sprite=S[t.control].normal,I.push({x:t.x,y:t.y})}void 0!==this.blockTween&&(this.blockTween.stop(),restoreColor()),this.blockTween=new e.Tween({}).to({},300),this.color=C[this.control].blocked,this.sprite=S[this.control].blocked,I.push({x:this.x,y:this.y}),this.blockTween.onComplete((function(){restoreColor()})),this.blockTween.start(),new Audio("sounds/tick"+P).play()},Player.prototype.move=function(t){if(!this.isMoving())if(this.canGo(t)){var n=this;this.path=this.findPath(t),this.animation=setInterval((function(){var t=n.path.shift();null==t&&n.stop(),a.visited[n.x][n.y]=n.visitedColor,I.push({x:n.x,y:n.y}),"north"==t&&(n.y-=1),"east"==t&&(n.x+=1),"south"==t&&(n.y+=1),"west"==t&&(n.x-=1),I.push({x:n.x,y:n.y}),n.x==a.goalPoint.x&&n.y==a.goalPoint.y&&function(t){m=t,p="transition",!0,A&&A.sendMessage(A.getSharedInfo().id,{user:A.getUserInfo(),action:"ended"});var n=new Audio("sounds/win"+P);for(control in n.play(),T)T[control].stop();var o=Math.sqrt(Math.pow(window.innerWidth,2)+Math.pow(window.innerHeight,2));if(tween=new e.Tween({radius:0}),tween.to({radius:o},1200),tween.easing(e.Easing.Circular.Out),tween.onUpdate((function(){x=this.radius})),a.startPoint={},T={},A)if(l+1==u)tween.onComplete((function(){nextLevel()}));else{var i=u-l-1;d.log(s.get(i>1?"PlayersWaitMany":"PlayersWaitOne",{count:i}))}else tween.onComplete((function(){nextLevel()}));tween.start()}(n)}),40)}else this.showBlocked()};var mazeClick=function(t){if("transition"!=p){var e="mouse";e in T||(T[e]=new Player(e));var n=T[e],o=w*(n.x+.5),i=y*(n.y+.5),r=t.clientX,a=t.clientY,s=document.getElementById("maze");r-=s.offsetLeft,a-=s.offsetTop;var l=180*Math.atan2(a-i,r-o)/Math.PI;45<l&&l<135?n.move("south"):-45>l&&l>-135?n.move("north"):-45<l&&l<45?n.move("east"):n.move("west")}};O.addEventListener?O.addEventListener("mousedown",mazeClick):O.attachEvent("onclick",mazeClick);document.addEventListener("keydown",(function(t){if("transition"!=p){var e,n;for(control in E)-1!=E[control].indexOf(t.keyCode)&&(e=control,n=o.orders[E[control].indexOf(t.keyCode)]);if(void 0!==e)e in T||(T[e]=new Player(e)),T[e].move(n)}}));var animateGoal=function(t){var e=Math.floor(120*(1+Math.cos(t/3e3))),n=Math.floor(50+10*(1+Math.cos(t/300)));v="hsl("+e+", 90%, "+n+"%)",I.push({x:a.goalPoint.x,y:a.goalPoint.y})},animate=function(t){switch(e.update(t),p){case"transition":!function(t){void 0===t&&(t=O.getContext("2d"));var e=w*(m.x+.5),n=y*(m.y+.5),o=x;t.beginPath(),t.arc(e,n,o,0,2*Math.PI,!1),t.fillStyle=m.color,t.fill()}();break;case"starting":animateGoal(t),function(t){void 0===t&&(t=O.getContext("2d")),t.fillStyle=v;var e,n,o=w*b,i=y*b;e=1==a.goalPoint.x?w:(a.goalPoint.x+1)*w-o,n=1==a.goalPoint.y?y:(a.goalPoint.y+1)*y-i,t.fillRect(e,n,o,i),drawPoint(t,a.startPoint.x,a.startPoint.y,k,.9*b)}();break;case"playing":animateGoal(t),I.forEach((function(t){!function(t,e,n){for(control in void 0===n&&(n=O.getContext("2d")),drawGround(n,t,e,a.walls[t][e]),void 0!==a.visited[t][e]&&drawPoint(n,t,e,a.visited[t][e],.5),t==a.startPoint.x&&e==a.startPoint.y&&drawPoint(n,a.startPoint.x,a.startPoint.y,k,.9),t==a.goalPoint.x&&e==a.goalPoint.y&&drawCell(n,a.goalPoint.x,a.goalPoint.y,v),T){var o=T[control];t==o.x&&e==o.y&&drawSprite(n,t,e,o.sprite)}}(t.x,t.y)})),I=[]}requestAnimationFrame(animate),/Android/i.test(navigator.userAgent)&&"http"!=document.location.protocol.substr(0,4)&&(O.style.display="none",O.offsetHeight,O.style.display="block")};animate();var A=null,F=!1,z=new i.PresencePalette(document.getElementById("network-button"),void 0);z.addEventListener("shared",(function(){z.popDown(),console.log("Want to share"),A=t.getPresenceObject((function(t,e){t?console.log("Sharing error"):(e.createSharedActivity("org.sugarlabs.MazeWebActivity",(function(t){console.log("Activity shared"),F=!0,A.sendMessage(A.getSharedInfo().id,{user:A.getUserInfo(),action:"connect"})})),e.onDataReceived(onNetworkDataReceived),e.onSharedActivityUserChanged(onNetworkUserChanged))}))})),document.getElementById("stop-button").addEventListener("click",(function(e){a.visited=createMatrix(a.width,a.height);var n={maze:a,gameSize:B},o=JSON.stringify(n);t.getDatastoreObject().setDataAsText(o),t.getDatastoreObject().save()}))}))}));