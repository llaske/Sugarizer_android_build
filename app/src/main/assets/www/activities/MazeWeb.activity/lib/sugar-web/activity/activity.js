define(["sugar-web/activity/shortcut","sugar-web/bus","sugar-web/env","sugar-web/datastore","sugar-web/presence","sugar-web/graphics/icon","sugar-web/graphics/activitypalette"],(function(e,t,n,o,i,a,r){"use strict";var s=null,l=null,c=null,u={},d={};return u.setup=function(){function sendStopEvent(){var e=document.createEvent("CustomEvent");e.initCustomEvent("activityStop",!1,!1,{cancelable:!0}),window.dispatchEvent(e)&&s.save((function(){o.waitPendingSave((function(){u.close()}))}))}t.listen(),t.onNotification("activity.pause",(function sendPauseEvent(){var e=document.createEvent("CustomEvent");e.initCustomEvent("activityPause",!1,!1,{cancelable:!0}),window.dispatchEvent(e)})),t.onNotification("activity.stop",sendStopEvent),s=new o.DatastoreObject,o.localStorage.load((function(){var e=o.localStorage.getValue("sugar_settings");if(null==e||void 0===e.name)if("file:"!=window.location.protocol)location.href=window.location.protocol+"//"+window.location.host+"?redirect="+encodeURIComponent(window.location.href);else{let e=window.location.pathname.substring(0,window.location.pathname.indexOf("index.html"));e=e.substring(0,e.lastIndexOf("/")),e=e.substring(0,e.lastIndexOf("/")),e=e.substring(0,e.lastIndexOf("/")),location.href=e+"/index.html?redirect="+encodeURIComponent(window.location.href)}}));var v=document.getElementById("activity-button"),g=new r.ActivityPalette(v,s);u.getXOColor((function(e,t){a.colorize(v,t);var n=document.querySelector("#activity-palette .palette-invoker");a.colorize(n,t);var o='<?xml version="1.0" encoding="UTF-8" standalone="no"?>                <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" width="16" height="16" version="1.0" >                <g transform="translate(37.943468,-309.4636)">                <g transform="matrix(0.05011994,0,0,0.05012004,-41.76673,299.66011)" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-opacity:1">                <circle transform="matrix(0.969697,0,0,0.969697,-90.879133,125.06999)" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-width:20.62502098;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" cx="331.38321" cy="134.2677" r="51.220825" />                <path d="m 290.55846,302.47333 -58.81513,59.20058 -59.39461,-59.40024 c -25.19828,-24.48771 -62.7038,13.33148 -38.1941,37.98719 l 60.04451,58.9817 -59.73639,59.42563 c -24.83976,24.97559 12.91592,63.26505 37.66786,37.75282 l 59.95799,-59.28294 58.75912,59.21065 c 24.50656,25.09065 62.43116,-13.00322 37.87956,-37.85772 l -59.24184,-59.02842 58.87574,-59.14782 c 25.1689,-25.18348 -13.0489,-62.75154 -37.80271,-37.84143 z" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-width:20.00002098;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" />                </g></g></svg>'.replace(new RegExp("&fill_color;","g"),t.fill).replace(new RegExp("&stroke_color;","g"),t.stroke),i=(new XMLSerializer).serializeToString((new DOMParser).parseFromString(o,"text/xml")),r=document.createElement("canvas");r.width=r.height=16;var s=r.getContext("2d"),l=new Image;l.src="data:image/svg+xml;base64,"+btoa(i),l.onload=function(){s.drawImage(l,0,0);var e=document.querySelector("link[rel*='icon']")||document.createElement("link");e.type="image/x-icon",e.rel="shortcut icon",e.href=r.toDataURL("image/x-icon"),document.getElementsByTagName("head")[0].appendChild(e)}})),document.getElementById("stop-button").addEventListener("click",(function(e){sendStopEvent()})),e.add("Ctrl","Q",this.close),n.getEnvironment((function(e,t){d=t.user;for(var o={en:"{{name}} Activity",fr:"Activité {{name}}",es:"Actividad {{name}}",pt:"{{name}} Atividade",de:"Aktivität {{name}}"},r="",u=0;u<t.user.activities.length;u++)if(t.user.activities[u].id==t.bundleId){r=t.user.activities[u].name;break}document.title=(o[t.user.language]||o.en).replace("{{name}}",r)+" - Sugarizer",t.objectId||s.setMetadata({title:(o[t.user.language]||o.en).replace("{{name}}",t.activityName),title_set_by_user:"0",activity:t.bundleId,activity_id:t.activityId}),n.isSugarizer()&&i.joinNetwork((function(e,n){t.sharedId&&n.joinSharedActivity(t.sharedId,(function(){var e=n.getSharedInfo().colorvalue;a.colorize(v,e),s.setMetadata({buddy_color:e}),s.save((function(){}))})),l?l(e,n):c={error:e,presence:n}})),s.save((function(){s.getMetadata((function(e,t){g.setTitleDescription(t)}))})),t.standAlone&&(document.getElementById("stop-button").style.visibility="hidden")}))},u.getDatastoreObject=function(){return s},u.getPresenceObject=function(e){return null==c?l=e:(e(c.error,c.presence),c=null),i},u.getXOColor=function(e){t.sendMessage("activity.get_xo_color",[],(function onResponseReceived(t,n){e(null,null===t?{stroke:n[0][0],fill:n[0][1]}:{stroke:"#00A0FF",fill:"#8BFF7A"})}))},u.close=function(e){u.traceStats("activity","stop",window.top.sugar.environment.objectId,null),t.sendMessage("activity.close",[],(function onResponseReceived(t,n){null===t?e(null):e(t,null)}))},u.traceStats=function(e,t,n,i){if(d.options.stats){var a=o.localStorage.getValue("sugar_stats");if(a){var r={};r.user_id=d.networkId,r.user_agent=navigator.userAgent,r.timestamp=(new Date).getTime(),r.client_type="http"==document.location.protocol.substr(0,4)?"Web App":"App",r.event_source=window.top.sugar.environment.bundleId,r.event_object=e,r.event_action=t,r.event_label=n,r.event_value=i,a.push(r),o.localStorage.setValue("sugar_stats",a)}}},u.showObjectChooser=function(e){t.sendMessage("activity.show_object_chooser",[],(function onResponseReceived(t,n){null===t?e(null,n[0]):e(t,null)}))},u}));