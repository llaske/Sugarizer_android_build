import clone from"clone";import equal from"deep-equal";import extend from"extend";import Delta,{AttributeMap}from"quill-delta";import{EmbedBlot,Scope,TextBlot}from"parchment";import Quill from"../core/quill";import logger from"../core/logger";import Module from"../core/module";const debug=logger("quill:keyboard"),SHORTKEY=/Mac/i.test(navigator.platform)?"metaKey":"ctrlKey";class Keyboard extends Module{static match(e,t){return!["altKey","ctrlKey","metaKey","shiftKey"].some(l=>!!t[l]!==e[l]&&null!==t[l])&&(t.key===e.key||t.key===e.which)}constructor(e,t){super(e,t),this.bindings={},Object.keys(this.options.bindings).forEach(e=>{this.options.bindings[e]&&this.addBinding(this.options.bindings[e])}),this.addBinding({key:"Enter",shiftKey:null},this.handleEnter),this.addBinding({key:"Enter",metaKey:null,ctrlKey:null,altKey:null},()=>{}),/Firefox/i.test(navigator.userAgent)?(this.addBinding({key:"Backspace"},{collapsed:!0},this.handleBackspace),this.addBinding({key:"Delete"},{collapsed:!0},this.handleDelete)):(this.addBinding({key:"Backspace"},{collapsed:!0,prefix:/^.?$/},this.handleBackspace),this.addBinding({key:"Delete"},{collapsed:!0,suffix:/^.?$/},this.handleDelete)),this.addBinding({key:"Backspace"},{collapsed:!1},this.handleDeleteRange),this.addBinding({key:"Delete"},{collapsed:!1},this.handleDeleteRange),this.addBinding({key:"Backspace",altKey:null,ctrlKey:null,metaKey:null,shiftKey:null},{collapsed:!0,offset:0},this.handleBackspace),this.listen()}addBinding(e,t={},l={}){const i=normalize(e);if(null==i)return void debug.warn("Attempted to add invalid keyboard binding",i);"function"==typeof t&&(t={handler:t}),"function"==typeof l&&(l={handler:l});(Array.isArray(i.key)?i.key:[i.key]).forEach(e=>{const n=extend({},i,{key:e},t,l);this.bindings[n.key]=this.bindings[n.key]||[],this.bindings[n.key].push(n)})}listen(){this.quill.root.addEventListener("keydown",e=>{if(e.defaultPrevented)return;const t=(this.bindings[e.key]||[]).concat(this.bindings[e.which]||[]).filter(t=>Keyboard.match(e,t));if(0===t.length)return;const l=this.quill.getSelection();if(null==l||!this.quill.hasFocus())return;const[i,n]=this.quill.getLine(l.index),[s,r]=this.quill.getLeaf(l.index),[o,a]=0===l.length?[s,r]:this.quill.getLeaf(l.index+l.length),u=s instanceof TextBlot?s.value().slice(0,r):"",d=o instanceof TextBlot?o.value().slice(a):"",c={collapsed:0===l.length,empty:0===l.length&&i.length()<=1,format:this.quill.getFormat(l),line:i,offset:n,prefix:u,suffix:d,event:e};t.some(e=>{if(null!=e.collapsed&&e.collapsed!==c.collapsed)return!1;if(null!=e.empty&&e.empty!==c.empty)return!1;if(null!=e.offset&&e.offset!==c.offset)return!1;if(Array.isArray(e.format)){if(e.format.every(e=>null==c.format[e]))return!1}else if("object"==typeof e.format&&!Object.keys(e.format).every(t=>!0===e.format[t]?null!=c.format[t]:!1===e.format[t]?null==c.format[t]:equal(e.format[t],c.format[t])))return!1;return!(null!=e.prefix&&!e.prefix.test(c.prefix))&&(!(null!=e.suffix&&!e.suffix.test(c.suffix))&&!0!==e.handler.call(this,l,c,e))})&&e.preventDefault()})}handleBackspace(e,t){const l=/[\uD800-\uDBFF][\uDC00-\uDFFF]$/.test(t.prefix)?2:1;if(0===e.index||this.quill.getLength()<=1)return;let i={};const[n]=this.quill.getLine(e.index);let s=(new Delta).retain(e.index-l).delete(l);if(0===t.offset){const[t]=this.quill.getLine(e.index-1);if(t){const t=n.formats(),l=this.quill.getFormat(e.index-1,1);if(i=AttributeMap.diff(t,l)||{},Object.keys(i).length>0){const t=(new Delta).retain(e.index+n.length()-2).retain(1,i);s=s.compose(t)}}}this.quill.updateContents(s,Quill.sources.USER),this.quill.focus()}handleDelete(e,t){const l=/^[\uD800-\uDBFF][\uDC00-\uDFFF]/.test(t.suffix)?2:1;if(e.index>=this.quill.getLength()-l)return;let i={};const[n]=this.quill.getLine(e.index);let s=(new Delta).retain(e.index).delete(l);if(t.offset>=n.length()-1){const[t]=this.quill.getLine(e.index+1);if(t){const l=n.formats(),r=this.quill.getFormat(e.index,1);i=AttributeMap.diff(l,r)||{},Object.keys(i).length>0&&(s=s.retain(t.length()-1).retain(1,i))}}this.quill.updateContents(s,Quill.sources.USER),this.quill.focus()}handleDeleteRange(e){const t=this.quill.getLines(e);let l={};if(t.length>1){const e=t[0].formats(),i=t[t.length-1].formats();l=AttributeMap.diff(i,e)||{}}this.quill.deleteText(e,Quill.sources.USER),Object.keys(l).length>0&&this.quill.formatLine(e.index,1,l,Quill.sources.USER),this.quill.setSelection(e.index,Quill.sources.SILENT),this.quill.focus()}handleEnter(e,t){const l=Object.keys(t.format).reduce((e,l)=>(this.quill.scroll.query(l,Scope.BLOCK)&&!Array.isArray(t.format[l])&&(e[l]=t.format[l]),e),{}),i=(new Delta).retain(e.index).delete(e.length).insert("\n",l);this.quill.updateContents(i,Quill.sources.USER),this.quill.setSelection(e.index+1,Quill.sources.SILENT),this.quill.focus(),Object.keys(t.format).forEach(e=>{null==l[e]&&(Array.isArray(t.format[e])||"code"!==e&&"link"!==e&&this.quill.format(e,t.format[e],Quill.sources.USER))})}}function makeCodeBlockHandler(e){return{key:"Tab",shiftKey:!e,format:{"code-block":!0},handler(t){const l=this.quill.scroll.query("code-block"),i=0===t.length?this.quill.getLines(t.index,1):this.quill.getLines(t);let{index:n,length:s}=t;i.forEach((t,i)=>{e?(t.insertAt(0,l.TAB),0===i?n+=l.TAB.length:s+=l.TAB.length):t.domNode.textContent.startsWith(l.TAB)&&(t.deleteAt(0,l.TAB.length),0===i?n-=l.TAB.length:s-=l.TAB.length)}),this.quill.update(Quill.sources.USER),this.quill.setSelection(n,s,Quill.sources.SILENT)}}}function makeEmbedArrowHandler(e,t){return{key:e,shiftKey:t,altKey:null,["ArrowLeft"===e?"prefix":"suffix"]:/^$/,handler(l){let{index:i}=l;"ArrowRight"===e&&(i+=l.length+1);const[n]=this.quill.getLeaf(i);return!(n instanceof EmbedBlot)||("ArrowLeft"===e?t?this.quill.setSelection(l.index-1,l.length+1,Quill.sources.USER):this.quill.setSelection(l.index-1,Quill.sources.USER):t?this.quill.setSelection(l.index,l.length+1,Quill.sources.USER):this.quill.setSelection(l.index+l.length+1,Quill.sources.USER),!1)}}}function makeFormatHandler(e){return{key:e[0],shortKey:!0,handler(t,l){this.quill.format(e,!l.format[e],Quill.sources.USER)}}}function makeTableArrowHandler(e){return{key:e?"ArrowUp":"ArrowDown",collapsed:!0,format:["table"],handler(t,l){const i=e?"prev":"next",n=l.line,s=n.parent[i];if(null!=s){if("table-row"===s.statics.blotName){let e=s.children.head,t=n;for(;null!=t.prev;)t=t.prev,e=e.next;const i=e.offset(this.quill.scroll)+Math.min(l.offset,e.length()-1);this.quill.setSelection(i,0,Quill.sources.USER)}}else{const t=n.table()[i];null!=t&&(e?this.quill.setSelection(t.offset(this.quill.scroll)+t.length()-1,0,Quill.sources.USER):this.quill.setSelection(t.offset(this.quill.scroll),0,Quill.sources.USER))}return!1}}}function normalize(e){if("string"==typeof e||"number"==typeof e)e={key:e};else{if("object"!=typeof e)return null;e=clone(e,!1)}return e.shortKey&&(e[SHORTKEY]=e.shortKey,delete e.shortKey),e}function tableSide(e,t,l,i){return null==t.prev&&null==t.next?null==l.prev&&null==l.next?0===i?-1:1:null==l.prev?-1:1:null==t.prev?-1:null==t.next?1:null}Keyboard.DEFAULTS={bindings:{bold:makeFormatHandler("bold"),italic:makeFormatHandler("italic"),underline:makeFormatHandler("underline"),indent:{key:"Tab",format:["blockquote","indent","list"],handler(e,t){return!(!t.collapsed||0===t.offset)||(this.quill.format("indent","+1",Quill.sources.USER),!1)}},outdent:{key:"Tab",shiftKey:!0,format:["blockquote","indent","list"],handler(e,t){return!(!t.collapsed||0===t.offset)||(this.quill.format("indent","-1",Quill.sources.USER),!1)}},"outdent backspace":{key:"Backspace",collapsed:!0,shiftKey:null,metaKey:null,ctrlKey:null,altKey:null,format:["indent","list"],offset:0,handler(e,t){null!=t.format.indent?this.quill.format("indent","-1",Quill.sources.USER):null!=t.format.list&&this.quill.format("list",!1,Quill.sources.USER)}},"indent code-block":makeCodeBlockHandler(!0),"outdent code-block":makeCodeBlockHandler(!1),"remove tab":{key:"Tab",shiftKey:!0,collapsed:!0,prefix:/\t$/,handler(e){this.quill.deleteText(e.index-1,1,Quill.sources.USER)}},tab:{key:"Tab",handler(e,t){if(t.format.table)return!0;this.quill.history.cutoff();const l=(new Delta).retain(e.index).delete(e.length).insert("\t");return this.quill.updateContents(l,Quill.sources.USER),this.quill.history.cutoff(),this.quill.setSelection(e.index+1,Quill.sources.SILENT),!1}},"blockquote empty enter":{key:"Enter",collapsed:!0,format:["blockquote"],empty:!0,handler(){this.quill.format("blockquote",!1,Quill.sources.USER)}},"list empty enter":{key:"Enter",collapsed:!0,format:["list"],empty:!0,handler(e,t){const l={list:!1};t.format.indent&&(l.indent=!1),this.quill.formatLine(e.index,e.length,l,Quill.sources.USER)}},"checklist enter":{key:"Enter",collapsed:!0,format:{list:"checked"},handler(e){const[t,l]=this.quill.getLine(e.index),i=extend({},t.formats(),{list:"checked"}),n=(new Delta).retain(e.index).insert("\n",i).retain(t.length()-l-1).retain(1,{list:"unchecked"});this.quill.updateContents(n,Quill.sources.USER),this.quill.setSelection(e.index+1,Quill.sources.SILENT),this.quill.scrollIntoView()}},"header enter":{key:"Enter",collapsed:!0,format:["header"],suffix:/^$/,handler(e,t){const[l,i]=this.quill.getLine(e.index),n=(new Delta).retain(e.index).insert("\n",t.format).retain(l.length()-i-1).retain(1,{header:null});this.quill.updateContents(n,Quill.sources.USER),this.quill.setSelection(e.index+1,Quill.sources.SILENT),this.quill.scrollIntoView()}},"table backspace":{key:"Backspace",format:["table"],collapsed:!0,offset:0,handler(){}},"table delete":{key:"Delete",format:["table"],collapsed:!0,suffix:/^$/,handler(){}},"table enter":{key:"Enter",shiftKey:null,format:["table"],handler(e){const t=this.quill.getModule("table");if(t){const[l,i,n,s]=t.getTable(e),r=tableSide(l,i,n,s);if(null==r)return;let o=l.offset();if(r<0){const t=(new Delta).retain(o).insert("\n");this.quill.updateContents(t,Quill.sources.USER),this.quill.setSelection(e.index+1,e.length,Quill.sources.SILENT)}else if(r>0){o+=l.length();const e=(new Delta).retain(o).insert("\n");this.quill.updateContents(e,Quill.sources.USER),this.quill.setSelection(o,Quill.sources.USER)}}}},"table tab":{key:"Tab",shiftKey:null,format:["table"],handler(e,t){const{event:l,line:i}=t,n=i.offset(this.quill.scroll);l.shiftKey?this.quill.setSelection(n-1,Quill.sources.USER):this.quill.setSelection(n+i.length(),Quill.sources.USER)}},"list autofill":{key:" ",shiftKey:null,collapsed:!0,format:{list:!1,"code-block":!1,blockquote:!1,header:!1,table:!1},prefix:/^\s*?(\d+\.|-|\*|\[ ?\]|\[x\])$/,handler(e,t){if(null==this.quill.scroll.query("list"))return!0;const{length:l}=t.prefix,[i,n]=this.quill.getLine(e.index);if(n>l)return!0;let s;switch(t.prefix.trim()){case"[]":case"[ ]":s="unchecked";break;case"[x]":s="checked";break;case"-":case"*":s="bullet";break;default:s="ordered"}this.quill.insertText(e.index," ",Quill.sources.USER),this.quill.history.cutoff();const r=(new Delta).retain(e.index-n).delete(l+1).retain(i.length()-2-n).retain(1,{list:s});return this.quill.updateContents(r,Quill.sources.USER),this.quill.history.cutoff(),this.quill.setSelection(e.index-l,Quill.sources.SILENT),!1}},"code exit":{key:"Enter",collapsed:!0,format:["code-block"],prefix:/^$/,suffix:/^\s*$/,handler(e){const[t,l]=this.quill.getLine(e.index);let i=2,n=t;for(;null!=n&&n.length()<=1&&n.formats()["code-block"];)if(n=n.prev,i-=1,i<=0){const i=(new Delta).retain(e.index+t.length()-l-2).retain(1,{"code-block":null}).delete(1);return this.quill.updateContents(i,Quill.sources.USER),this.quill.setSelection(e.index-1,Quill.sources.SILENT),!1}return!0}},"embed left":makeEmbedArrowHandler("ArrowLeft",!1),"embed left shift":makeEmbedArrowHandler("ArrowLeft",!0),"embed right":makeEmbedArrowHandler("ArrowRight",!1),"embed right shift":makeEmbedArrowHandler("ArrowRight",!0),"table down":makeTableArrowHandler(!1),"table up":makeTableArrowHandler(!0)}};export{Keyboard as default,SHORTKEY,normalize};