import Delta from"quill-delta";import{EmbedBlot,Scope}from"parchment";import Quill from"../core/quill";import logger from"../core/logger";import Module from"../core/module";const debug=logger("quill:toolbar");class Toolbar extends Module{constructor(t,e){if(super(t,e),Array.isArray(this.options.container)){const e=document.createElement("div");addControls(e,this.options.container),t.container.parentNode.insertBefore(e,t.container),this.container=e}else"string"==typeof this.options.container?this.container=document.querySelector(this.options.container):this.container=this.options.container;if(!(this.container instanceof HTMLElement))return debug.error("Container required for toolbar",this.options);this.container.classList.add("ql-toolbar"),this.controls=[],this.handlers={},Object.keys(this.options.handlers).forEach((t=>{this.addHandler(t,this.options.handlers[t])})),Array.from(this.container.querySelectorAll("button, select")).forEach((t=>{this.attach(t)})),this.quill.on(Quill.events.EDITOR_CHANGE,((t,e)=>{t===Quill.events.SELECTION_CHANGE&&this.update(e)})),this.quill.on(Quill.events.SCROLL_OPTIMIZE,(()=>{const[t]=this.quill.selection.getRange();this.update(t)}))}addHandler(t,e){this.handlers[t]=e}attach(t){let e=Array.from(t.classList).find((t=>0===t.indexOf("ql-")));if(!e)return;if(e=e.slice("ql-".length),"BUTTON"===t.tagName&&t.setAttribute("type","button"),null==this.handlers[e]&&null==this.quill.scroll.query(e))return void debug.warn("ignoring attaching to nonexistent format",e,t);const l="SELECT"===t.tagName?"change":"click";t.addEventListener(l,(l=>{let i;if("SELECT"===t.tagName){if(t.selectedIndex<0)return;const e=t.options[t.selectedIndex];i=!e.hasAttribute("selected")&&(e.value||!1)}else i=!t.classList.contains("ql-active")&&(t.value||!t.hasAttribute("value")),l.preventDefault();this.quill.focus();const[s]=this.quill.selection.getRange();if(null!=this.handlers[e])this.handlers[e].call(this,i);else if(this.quill.scroll.query(e).prototype instanceof EmbedBlot){if(i=prompt(`Enter ${e}`),!i)return;this.quill.updateContents((new Delta).retain(s.index).delete(s.length).insert({[e]:i}),Quill.sources.USER)}else this.quill.format(e,i,Quill.sources.USER);this.update(s)})),this.controls.push([e,t])}update(t){const e=null==t?{}:this.quill.getFormat(t);this.controls.forEach((l=>{const[i,s]=l;if("SELECT"===s.tagName){let l;if(null==t)l=null;else if(null==e[i])l=s.querySelector("option[selected]");else if(!Array.isArray(e[i])){let t=e[i];"string"==typeof t&&(t=t.replace(/"/g,'\\"')),l=s.querySelector(`option[value="${t}"]`)}null==l?(s.value="",s.selectedIndex=-1):l.selected=!0}else if(null==t)s.classList.remove("ql-active");else if(s.hasAttribute("value")){const t=e[i]===s.getAttribute("value")||null!=e[i]&&e[i].toString()===s.getAttribute("value")||null==e[i]&&!s.getAttribute("value");s.classList.toggle("ql-active",t)}else s.classList.toggle("ql-active",null!=e[i])}))}}function addButton(t,e,l){const i=document.createElement("button");i.setAttribute("type","button"),i.classList.add(`ql-${e}`),null!=l&&(i.value=l),t.appendChild(i)}function addControls(t,e){Array.isArray(e[0])||(e=[e]),e.forEach((e=>{const l=document.createElement("span");l.classList.add("ql-formats"),e.forEach((t=>{if("string"==typeof t)addButton(l,t);else{const e=Object.keys(t)[0],i=t[e];Array.isArray(i)?addSelect(l,e,i):addButton(l,e,i)}})),t.appendChild(l)}))}function addSelect(t,e,l){const i=document.createElement("select");i.classList.add(`ql-${e}`),l.forEach((t=>{const e=document.createElement("option");!1!==t?e.setAttribute("value",t):e.setAttribute("selected","selected"),i.appendChild(e)})),t.appendChild(i)}Toolbar.DEFAULTS={},Toolbar.DEFAULTS={container:null,handlers:{clean(){const t=this.quill.getSelection();if(null!=t)if(0===t.length){const t=this.quill.getFormat();Object.keys(t).forEach((t=>{null!=this.quill.scroll.query(t,Scope.INLINE)&&this.quill.format(t,!1,Quill.sources.USER)}))}else this.quill.removeFormat(t,Quill.sources.USER)},direction(t){const{align:e}=this.quill.getFormat();"rtl"===t&&null==e?this.quill.format("align","right",Quill.sources.USER):t||"right"!==e||this.quill.format("align",!1,Quill.sources.USER),this.quill.format("direction",t,Quill.sources.USER)},indent(t){const e=this.quill.getSelection(),l=this.quill.getFormat(e),i=parseInt(l.indent||0,10);if("+1"===t||"-1"===t){let e="+1"===t?1:-1;"rtl"===l.direction&&(e*=-1),this.quill.format("indent",i+e,Quill.sources.USER)}},link(t){!0===t&&(t=prompt("Enter link URL:")),this.quill.format("link",t,Quill.sources.USER)},list(t){const e=this.quill.getSelection(),l=this.quill.getFormat(e);"check"===t?"checked"===l.list||"unchecked"===l.list?this.quill.format("list",!1,Quill.sources.USER):this.quill.format("list","unchecked",Quill.sources.USER):this.quill.format("list",t,Quill.sources.USER)}}};export{Toolbar as default,addControls};