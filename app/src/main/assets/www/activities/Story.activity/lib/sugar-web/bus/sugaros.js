define(["sugar-web/env"],(function(e){"use strict";var t=0,n={},r={},a=null,s=[];function WebSocketClient(t){this.queue=[],this.socket=null;var n=this;e.getEnvironment((function(e,t){var r=t.apiSocketPort,a=new WebSocket("ws://127.0.0.1:"+r);a.binaryType="arraybuffer",a.onopen=function(){var e=[t.activityId,t.apiSocketKey];for(a.send(JSON.stringify({method:"authenticate",id:"authenticate",params:e}));n.queue.length>0;)a.send(n.queue.shift())},a.onmessage=function(e){n.onMessage(e)},n.socket=a}))}WebSocketClient.prototype.send=function(e){this.socket&&this.socket.readyState==WebSocket.OPEN?this.socket.send(e):this.queue.push(e)},WebSocketClient.prototype.close=function(){this.socket.close()};var o={};function InputStream(){this.streamId=null,this.readCallback=null}function OutputStream(){this.streamId=null}return InputStream.prototype.open=function(e){var t=this;o.sendMessage("open_stream",[],(function(n,r){t.streamId=r[0],s[t.streamId]=t,e(n)}))},InputStream.prototype.read=function(e,t){if(this.readCallback)throw new Error("Read already in progress");this.readCallback=t;var n=new ArrayBuffer(8);new Uint8Array(n,0,1)[0]=this.streamId,new Uint32Array(n,4,1)[0]=e,o.sendBinary(n)},InputStream.prototype.gotData=function(e){var t=this.readCallback;this.readCallback=null,t(null,e)},InputStream.prototype.close=function(e){var t=this;o.sendMessage("close_stream",[this.streamId],(function onStreamClosed(n,r){e&&e(n),delete s[t.streamId]}))},OutputStream.prototype.open=function(e){var t=this;o.sendMessage("open_stream",[],(function(n,r){t.streamId=r[0],e(n)}))},OutputStream.prototype.write=function(e){var t=new ArrayBuffer(e.byteLength+1),n=new Uint8Array(t);n[0]=this.streamId,n.set(new Uint8Array(e),1),o.sendBinary(t)},OutputStream.prototype.close=function(e){o.sendMessage("close_stream",[this.streamId],e)},o.createInputStream=function(e){return new InputStream},o.createOutputStream=function(e){return new OutputStream},o.sendMessage=function(e,r,s){var o={method:e,id:t,params:r,jsonrpc:"2.0"};s&&(n[t]=s),a.send(JSON.stringify(o)),t++},o.onNotification=function(e,t){r[e]=t},o.sendBinary=function(e,t){a.send(e)},o.listen=function(e){(a=e||new WebSocketClient).onMessage=function(e){if("string"==typeof e.data){var t=JSON.parse(e.data),a=t.id;if(t.method){var o=r[t.method];void 0!==o&&o(t.params)}else if(a in n){var i=n[a];null===t.error?i(null,t.result):i(new Error(t.error),null),delete n[a]}}else{var u=new Uint8Array(e.data)[0];u in s&&s[u].gotData(e.data.slice(1))}}},o.close=function(){a.close(),a=null},o}));