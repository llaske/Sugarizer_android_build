requirejs.config({baseUrl:"lib",paths:{activity:"../js"}});var app=new Vue({el:"#app",data:{environment:null,SugarL10n:null,isConnected:null,db_url:null,grid:!0,modeId:"grid-mode",images:[],imagesURL:[],gridImageURL:null,activeImage:"",activeImageIndex:0,previousBtnId:null,nextBtnId:null,recordIconId:null,recording:!1,recordRTC:null,mediaStream:null,gridAudioRecord:null,singleAudioRecords:[],audio:null,isPlaying:!1,playIconId:"play-inactive",speakIconId:"speak-inactive",currentTime:0,imageCount:9,imageLoaded:0,intervalIds:[],colors:null,isLoaded:!1,sizes:["16px","24px","32px","40px","48px","56px","64px","72px","80px","100px"],gridEditorContent:null,singleEditorsContent:[],editor:null,fontColor:null,backgroundColor:null,fontSelected:null,fontSize:null,SugarPresence:null,cursors:null,myid:null,connectedPlayers:[],isHost:!1,l10n:{stringNetwork:"",stringToggleMode:"",stringGridSize:"",stringForegroundColor:"",stringBackgroundColor:"",stringFormatText:"",stringChooseFont:"",stringIncreaseFont:"",stringDecreaseFont:"",stringExportStory:"",stringExportAsSound:"",stringStop:"",stringTutoPrev:"",stringTutoNext:"",stringTutoEnd:"",stringTutoExplainTitle:"",stringTutoExplainContent:"",stringTutoNetworkTitle:"",stringTutoNetworkContent:"",stringTutoToggleModeTitle:"",stringTutoToggleModeContent:"",stringTutoGridSizeTitle:"",stringTutoGridSizeContent:"",stringTutoForegroundColorTitle:"",stringTutoForegroundColorContent:"",stringTutoBackgroundColorTitle:"",stringTutoBackgroundColorContent:"",stringTutoFormatTextTitle:"",stringTutoFormatTextContent:"",stringTutoChooseFontTitle:"",stringTutoChooseFontContent:"",stringTutoIncreaseFontTitle:"",stringTutoIncreaseFontContent:"",stringTutoDecreaseFontTitle:"",stringTutoDecreaseFontContent:"",stringTutoExportStoryTitle:"",stringTutoExportStoryContent:"",stringTutoExportSoundTitle:"",stringTutoExportSoundContent:"",stringTutoRecordTitle:"",stringTutoRecordContent:"",stringTutoPlayTitle:"",stringTutoPlayContent:"",stringTutoSpeakTitle:"",stringTutoSpeakContent:"",stringTutoNextImageTitle:"",stringTutoNextImageContent:"",stringTutoPrevImageTitle:"",stringTutoPrevImageContent:""}},mounted(){this.SugarPresence=this.$refs.SugarPresence,this.SugarL10n=this.$refs.SugarL10n},methods:{initialized:async function(){var t=this,e=this.$refs.SugarActivity.getEnvironment();this.environment=e,this.colors=[e.user.colorvalue.fill,e.user.colorvalue.stroke,"#FFFFFF"],0===this.activeImageIndex?(this.previousBtnId="previous-btn-inactive",this.nextBtnId="next-btn"):this.activeImageIndex===this.imageCount-1&&(this.previousBtnId="previous-btn",this.nextBtnId="next-btn-inactive"),this.recordIconId="record";for(var i=0;i<this.imageCount;i++)this.singleEditorsContent.push(null),this.singleAudioRecords.push(null),this.imagesURL.push(null);var n=document.location.href.substr(0,document.location.href.indexOf("/activities/"))+"/activities/Abecedarium.activity/images/database/_ping.png";this.isConnected=await this.checkFileExists(n);var o=new XMLHttpRequest,s=document.location.href.substr(0,document.location.href.indexOf("/activities/"))+"/activities/Abecedarium.activity/database/db_url.json";o.onload=function(){var e=JSON.parse(o.response);t.db_url=e},o.onerror=function(t){console.log("Error: ",o.statusText)},o.open("GET",s),o.send(),this.loadEditor()},localized:function(){this.SugarL10n.localize(this.l10n)},imageLoaders:function(){const t=this;function getColor(){return t.colors[function getRandomInt(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}(0,2)]}var e=document.getElementsByClassName("questionmark"),i=e.length;this.grid||(i=1);for(var n=0;n<i;n++)e[n].style.background=getColor(),function(i){var n=setInterval((function(){e[i].style.background=getColor()}),900);t.intervalIds.push(n)}(n)},checkFileExists:function(t){try{return new Promise((function(e,i){var n=new XMLHttpRequest;n.open("GET",t,!0),n.onload=function(){404==n.status||200!==n.status&&""==n.response||e(!0),e(!1)},n.onerror=function(){e(!1)},n.send()}))}catch(t){resolve(!1)}},loadFile:function(t,e){var i=this;try{return new Promise((function(n,o){var s=new XMLHttpRequest;s.open("GET",t,!0),s.onload=function(){-1!==i.images.indexOf(e)||404===s.status||200!==s.status&&"\t"==s.response||(i.images.push(e),n(!0)),n(!1)},s.onerror=function(){n(!1)},s.send()}))}catch(t){resolve(!1)}},loadImages:function(t){var e=new XMLHttpRequest,i=this,n=document.location.href.substr(0,document.location.href.indexOf("/activities/"))+"/activities/Abecedarium.activity/database/db_meta.json";e.onload=async function(){var n;n=JSON.parse(e.response);for(var o=0;o<i.imageCount;o++){var s=n[Math.floor(Math.random()*n.length)].code;(i.isConnected?s.includes("lower_")?await i.loadFile(document.location.href.substr(0,document.location.href.indexOf("/activities/"))+"/activities/Abecedarium.activity/images/letters/"+s.toLowerCase()[6]+"0.png",s):s.includes("upper_")?await i.loadFile(document.location.href.substr(0,document.location.href.indexOf("/activities/"))+"/activities/Abecedarium.activity/images/letters/"+s.toLowerCase()[6]+"1.png",s):await i.loadFile(document.location.href.substr(0,document.location.href.indexOf("/activities/"))+"/activities/Abecedarium.activity/images/database/"+s+".png",s):s.includes("lower_")?await i.loadFile(i.db_url+"images/letters/"+s.toLowerCase()[6]+"0.png",s):s.includes("upper_")?await i.loadFile(i.db_url+"images/letters/"+s.toLowerCase()[6]+"1.png",s):await i.loadFile(i.db_url+"images/database/"+s+".png",s))||o--}if(i.activeImage=i.images[i.activeImageIndex],!i.grid){i.isLoaded=!0;for(o=0;o<i.imageCount;o++)clearInterval(i.intervalIds[o]);i.storeData()}t()},e.onerror=function(t){console.log("Error: ",e.statusText)},e.open("GET",n,!0),e.send()},loadEditor:function(){Quill.register("modules/cursors",QuillCursors);var t=document.getElementById("editor-area"),e=new Quill(t,{modules:{toolbar:".toolbar-container",cursors:!0},cursors:{transformOnTextChange:!0}});e.format("size","24px");const i=e.getModule("cursors");Quill.import("delta");var n=this;e.on("text-change",(function(t,i,o){if(e.getText().length>1?n.speakIconId="speak":n.speakIconId="speak-inactive","user"==o&&n.SugarPresence&&n.SugarPresence.isShared()){var s=n.editor.getSelection();n.SugarPresence.sendMessage({user:n.SugarPresence.getUserInfo(),content:{action:"typing",data:t,range:s,grid:n.grid,activeImageIndex:n.activeImageIndex,allText:e.getContents()}})}})),this.editor=e,this.cursors=i},updateEditor:function(){null!=this.fontColor&&this.editor.format("color",this.fontColor),null!=this.backgroundColor&&this.editor.format("background-color",this.backgroundColor),null!=this.fontSelected&&this.editor.format("font",this.fontSelected),null!=this.fontSize?this.editor.format("size",this.fontSize):this.editor.format("size","24px")},getUrlImg:function(t){return this.isConnected?t.includes("lower")?"../Abecedarium.activity/images/letters/"+t.toLowerCase()[6]+"0.png":t.includes("upper")?"../Abecedarium.activity/images/letters/"+t.toLowerCase()[6]+"1.png":"../Abecedarium.activity/images/database/"+t+".png":t.includes("lower")?this.db_url+"images/letters/"+t.toLowerCase()[6]+"0.png":t.includes("upper")?this.db_url+"images/letters/"+t.toLowerCase()[6]+"1.png":this.db_url+"images/database/"+t+".png"},toggleMode:function(){this.currentTime=0;var t=this;if(this.grid){if(null==this.gridImageURL&&null!=document.getElementById("display-grid")){var e=document.getElementById("display-grid");html2canvas(e).then((function(e){var i=e.toDataURL("image/png");t.gridImageURL=i}))}this.gridEditorContent=this.editor.getContents(),this.editor.setContents(this.singleEditorsContent[this.activeImageIndex]),this.updateEditor(),this.grid=!1,this.modeId="single-mode",null!=this.singleAudioRecords[this.activeImageIndex]?this.playIconId="play":this.playIconId="play-inactive"}else this.activeImage=this.images[this.activeImageIndex],this.singleEditorsContent[this.activeImageIndex]=this.editor.getContents(),this.editor.setContents(this.gridEditorContent),this.updateEditor(),0===this.activeImageIndex&&(this.previousBtnId="previous-btn-inactive"),this.grid=!0,this.modeId="grid-mode",null!=this.gridAudioRecord?this.playIconId="play":this.playIconId="play-inactive";this.editor.getText().length>1?this.speakIconId="speak":this.speakIconId="speak-inactive",this.editor.setSelection(this.editor.getText().length),this.storeData()},previousImage:function(){0!==this.activeImageIndex&&(this.currentTime=0,this.nextBtnId="next-btn",this.singleEditorsContent[this.activeImageIndex]=this.editor.getContents(),this.activeImageIndex=this.activeImageIndex-1,this.editor.setContents(this.singleEditorsContent[this.activeImageIndex]),this.updateEditor(),this.activeImage=this.images[this.activeImageIndex],this.editor.setSelection(this.editor.getText().length),this.storeData(),this.editor.getText().length>1?this.speakIconId="speak":this.speakIconId="speak-inactive",null!=this.singleAudioRecords[this.activeImageIndex]?this.playIconId="play":this.playIconId="play-inactive",0===this.activeImageIndex&&(this.previousBtnId="previous-btn-inactive"))},nextImage:function(){this.activeImageIndex!==this.images.length-1&&(this.currentTime=0,this.previousBtnId="previous-btn",this.singleEditorsContent[this.activeImageIndex]=this.editor.getContents(),this.activeImageIndex=this.activeImageIndex+1,this.editor.setContents(this.singleEditorsContent[this.activeImageIndex]),this.updateEditor(),this.activeImage=this.images[this.activeImageIndex],this.editor.setSelection(this.editor.getText().length),this.storeData(),this.editor.getText().length>1?this.speakIconId="speak":this.speakIconId="speak-inactive",null!=this.singleAudioRecords[this.activeImageIndex]?this.playIconId="play":this.playIconId="play-inactive",this.activeImageIndex===this.images.length-1&&(this.nextBtnId="next-btn-inactive"))},loaded:function(){var t=this;if(this.imageLoaded++,this.imageLoaded===this.imageCount){this.isLoaded=!0,this.activeImage=this.images[this.activeImageIndex];for(var e=0;e<this.imageCount;e++)clearInterval(this.intervalIds[e]);function toDataURL(e,i){var n=new Image;n.crossOrigin="Anonymous",n.onload=function(){var e,n=document.createElement("CANVAS"),o=n.getContext("2d");n.height=this.naturalHeight,n.width=this.naturalWidth,o.drawImage(this,0,0),e=n.toDataURL("image/png"),t.imagesURL[i]=e},n.src=e,(n.complete||void 0===n.complete)&&(n.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",n.src=e)}this.storeData();for(e=0;e<this.imageCount;)toDataURL(""+t.getUrlImg(t.images[e]),e),e++;setTimeout(()=>{if(null!=document.getElementById("display-grid")){var e=document.getElementById("display-grid");html2canvas(e).then((function(e){var i=e.toDataURL("image/png");t.gridImageURL=i}))}},100)}},openImage:function(t){this.grid&&(this.gridEditorContent=this.editor.getContents()),this.grid=!1,this.activeImageIndex=t,this.activeImage=this.images[this.activeImageIndex],this.editor.setContents(this.singleEditorsContent[this.activeImageIndex]),this.modeId="single-mode",this.storeData(),this.editor.getText().length>1?this.speakIconId="speak":this.speakIconId="speak-inactive",null!=this.singleAudioRecords[this.activeImageIndex]?this.playIconId="play":this.playIconId="play-inactive",0===t?(this.previousBtnId="previous-btn-inactive",this.nextBtnId="next-btn"):t===this.images.length-1?(this.previousBtnId="previous-btn",this.nextBtnId="next-btn-inactive"):(this.previousBtnId="previous-btn",this.nextBtnId="next-btn")},onGridSizeChange:function(t){var e=this;if(!this.SugarPresence.isShared()){this.grid=!0,this.modeId="grid-mode",this.activeImage="",this.activeImageIndex=0,this.imageCount=t.count,document.getElementById("size-palette").style.background="url(icons/"+t.count/3+"X3.svg)",this.gridAudioRecord=null,this.singleAudioRecords=[],this.singleEditorsContent=[],this.gridEditorContent=null,this.images=[];for(var i=0;i<this.imageCount;i++)this.singleEditorsContent.push(null);this.editor.setContents(this.gridEditorContent),this.imageLoaders(),this.loadImages(()=>{function toDataURL(t,i){var n=new Image;n.crossOrigin="Anonymous",n.onload=function(){var t,n=document.createElement("CANVAS"),o=n.getContext("2d");n.height=this.naturalHeight,n.width=this.naturalWidth,o.drawImage(this,0,0),t=n.toDataURL("image/png"),e.imagesURL[i]=t},n.src=t,(n.complete||void 0===n.complete)&&(n.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",n.src=t)}for(var t=0;t<this.imageCount;)toDataURL(""+e.getUrlImg(e.images[t]),t),t++;setTimeout(()=>{if(e.storeData(),null!=document.getElementById("display-grid")){var t=document.getElementById("display-grid");html2canvas(t).then((function(t){var i=t.toDataURL("image/png");e.gridImageURL=i}))}},100)})}},increaseFont:function(){var t=this.editor.getFormat();if(null==t.size){var e=this.sizes.indexOf("24px");this.editor.format("size",this.sizes[e+1]),this.fontSize=this.sizes[e+1]}else{e=this.sizes.indexOf(t.size);++e<this.sizes.length&&(this.editor.format("size",this.sizes[e]),this.fontSize=this.sizes[e])}},decreaseFont:function(){var t=this.editor.getFormat();if(null==t.size){(e=this.sizes.indexOf("24px"))>0&&this.editor.format("size",this.sizes[e-1]),this.fontSize=this.sizes[e-1]}else{var e=this.sizes.indexOf(t.size);--e>=0&&(this.editor.format("size",this.sizes[e]),this.fontSize=this.sizes[e])}},onFormatText:function(t){this.editor.focus()},onFontChange:function(t){var e=t.font;"Arial"==e&&(e="arial"),"Comic Sans MS"==e&&(e="comic"),"Times New Roman"==e&&(e="Times"),"Courier New"==e&&(e="Courier"),"Lucida Console"==e&&(e="Lucida"),"Impact"==e&&(e="Impact"),"Georgia"==e&&(e="Georgia"),this.editor.format("font",e),this.fontSelected=e,this.editor.focus()},onForegroundColorChange:function(t){this.fontColor=t.detail.color,this.editor.format("color",this.fontColor)},onBackgroundColorChange:function(t){this.backgroundColor=t.detail.color,this.editor.format("background-color",this.backgroundColor)},onExport:function(t){var e=this,i=document.createElement("div"),n=new Quill(i,{});switch(this.grid?this.gridEditorContent=this.editor.getContents():this.singleEditorsContent[this.activeImageIndex]=this.editor.getContents(),this.storeData(),t.fileType){case"txt":var o=document.getElementById("title").value,s="text/plain",r="";n.setContents(e.gridEditorContent),(d=n.getText()).length>1&&(r+=n.getText());for(var a=0;a<e.imageCount;a++){n.setContents(e.singleEditorsContent[a]);var d=n.getText();a==e.activeImageIndex&&e.editor.getText().length>1?r+=e.editor.getText():d.length>1&&(r+=n.getText())}var l={mimetype:s,title:o+".txt",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};this.$refs.SugarJournal.createEntry(r,l),this.$refs.SugarPopup.log(e.SugarL10n.get("ExportToTxt"));break;case"pdf":o=document.getElementById("title").value;document.getElementById("spinner-container").style.display="block";var g=this.activeImageIndex,c=this.grid;this.grid=!0,e.editor.setContents(e.gridEditorContent);var u=new jsPDF("p","mm","",!0);function generateOnePdf(t){html2canvas(document.getElementById("display-single")).then((function(i){t<e.imageCount-1&&(e.activeImageIndex=t+1,e.activeImage=e.images[t+1]),e.editor.setContents(e.singleEditorsContent[t]),e.editor.scrollingContainer.style.overflowY="visible";var n=e.editor.scrollingContainer.offsetHeight;e.editor.scrollingContainer.style.height="auto",e.editor.scrollingContainer.scrollTop=0,html2canvas(e.editor.scrollingContainer).then((function(s){e.editor.scrollingContainer.style.height=n,e.editor.scrollingContainer.style.overflowY="auto";var r=s.toDataURL("image/png"),a=210*s.height/s.width,d=a,l=120;if(e.editor.getText().length>1)for(u.addPage(),u.addImage(i.toDataURL("image/png"),"PNG",55,10,100,100,"","FAST"),u.addImage(r,"PNG",0,l,210,a-10,"","FAST"),d-=175;d>=0;)l=d-a,u.addPage(),u.addImage(r,"PNG",0,l,210,a-10,"","FAST"),d-=295;t!=e.imageCount-1?generateOnePdf(t+1):function generateEndPdf(){var t=u.output("dataurlstring"),i={mimetype:"application/pdf",title:o+".pdf",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};e.$refs.SugarJournal.createEntry(t,i),document.getElementById("spinner-container").style.display="none",e.$refs.SugarPopup.log(e.SugarL10n.get("ExportToPdf")),e.grid=c,c?(e.activeImageIndex=g,e.editor.setContents(e.gridEditorContent)):(e.activeImageIndex=g,e.activeImage=e.images[g],e.editor.setContents(e.singleEditorsContent[e.activeImageIndex]))}()}))}))}function generatePdf(){generateOnePdf(0)}setTimeout((async function generatePdfGrid(){e.editor.scrollingContainer.style.overflowY="visible";var t=e.editor.scrollingContainer.offsetHeight;e.editor.scrollingContainer.style.height="auto",e.editor.scrollingContainer.scrollTop=0;var i=document.getElementById("display-grid"),n=e.editor.getText().length;await html2canvas(i).then((function(i){var o=i.toDataURL("image/png");html2canvas(e.editor.scrollingContainer).then((function(i){e.editor.scrollingContainer.style.height=t,e.editor.scrollingContainer.style.overflowY="auto";var s=i.toDataURL("image/png"),r=210*i.height/i.width,a=r;if(n>1){3==e.imageCount?(u.addImage(o,"PNG",55,20,100,40,"","FAST"),u.addImage(s,"PNG",0,60,210,r-10,"","FAST")):6==e.imageCount?(u.addImage(o,"PNG",55,20,100,70,"","FAST"),u.addImage(s,"PNG",0,90,210,r-10,"","FAST")):(u.addImage(o,"PNG",55,20,100,100,"","FAST"),u.addImage(s,"PNG",0,120,210,r-10,"","FAST"));var d=120;for(a-=175;a>=0;)d=a-r,u.addPage(),u.addImage(s,"PNG",0,d,210,r-10,"","FAST"),a-=295}}))})),e.activeImageIndex=0,e.activeImage=e.images[0],e.editor.setContents(e.singleEditorsContent[0]),e.grid=!1,setTimeout(generatePdf,200)}),200);break;case"doc":o=document.getElementById("title").value,this.editor.root.innerHTML;var h="";if(n.setContents(e.gridEditorContent),(d=n.root.innerHTML).length>11){for(a=0;a<e.imageCount/3;a++)h+=`\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<img style="display:inline-block; height:150px; width:150px; margin:auto" src=${e.imagesURL[3*a+a%3]} />\n\t\t\t\t\t\t\t<img style="display:inline-block; height:150px; width:150px; margin:auto" src=${e.imagesURL[3*a+(a+1)%3]} />\n\t\t\t\t\t\t\t<img style="display:inline-block; height:150px; width:150px; margin:auto" src=${e.imagesURL[3*a+(a+2)%3]} />\n\t\t\t\t\t\t\t</div>`;h+=d}for(a=0;a<e.imageCount;a++){n.setContents(e.singleEditorsContent[a]);d=n.root.innerHTML;a==e.activeImageIndex&&e.editor.root.innerHTML.length>11?(h+=`<img style="display:block; margin:auto" src=${e.imagesURL[a]} />`,h+=e.editor.root.innerHTML):d.length>11&&(h+=`<img style="display:block; margin:auto" src=${e.imagesURL[a]} />`,h+=d)}r="data:application/vnd.ms-word;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent("<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'></head><body>"+h+"</body></html>"))),l={mimetype:s="application/msword",title:o+".doc",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};this.$refs.SugarJournal.createEntry(r,l),this.$refs.SugarPopup.log(e.SugarL10n.get("ExportToDoc"));break;case"odt":g=this.activeImageIndex,c=this.grid;this.grid=!1;var m=document.createElement("div");if(e.editor.setContents(e.gridEditorContent),e.editor.getText().length>1){(v=(v=document.getElementById("editor-area")).cloneNode(!0)).getElementsByTagName("div")[0];var I=v.getElementsByTagName("div")[0],p=document.createElement("p");(f=document.createElement("IMG")).height="100px",f.setAttribute("src",e.gridImageURL),p.appendChild(f),I.insertBefore(p,I.childNodes[0]),m.append(...I.childNodes)}for(a=0;a<e.imageCount;a++)if(e.activeImageIndex=a,e.editor.setContents(e.singleEditorsContent[a]),e.editor.getText().length>1){var v;(v=(v=document.getElementById("editor-area")).cloneNode(!0)).getElementsByTagName("div")[0];var f;I=v.getElementsByTagName("div")[0],p=document.createElement("p");(f=document.createElement("IMG")).height="500px",f.setAttribute("src",e.imagesURL[a]),p.appendChild(f),I.insertBefore(p,I.childNodes[0]),m.append(...I.childNodes)}e.grid=c,c?(e.activeImageIndex=g,e.editor.setContents(e.gridEditorContent)):(e.activeImageIndex=g,e.editor.setContents(e.singleEditorsContent[e.activeImageIndex]));var C=traverse(m);s="application/vnd.oasis.opendocument.text",o=document.getElementById("title").value,r="data:application/vnd.oasis.opendocument.text;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(C))),l={mimetype:s,title:o+".odt",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};resetXML(),e.$refs.SugarJournal.createEntry(r,l),e.$refs.SugarPopup.log(e.SugarL10n.get("ExportToOdt"))}},onJournalNewInstance:function(){console.log("New instance");for(var t=0;t<this.imageCount;t++)this.singleEditorsContent.push(null);this.imageLoaders();var e=this;document.getElementById("size-palette").style.background="url(icons/3X3.svg)",window.setTimeout((function(){e.loadImages(()=>{})}),910)},onJournalDataLoaded:function(t,e){console.log("Existing instance"),this.grid=t.grid,this.imageLoaders(),this.images=t.images,this.imageCount=t.imageCount,this.gridEditorContent=JSON.parse(t.gridEditorContent),this.singleEditorsContent=JSON.parse(t.singleEditorsContent),this.fontSelected=t.fontSelected,this.fontSize=t.fontSize,this.activeImageIndex=t.activeImageIndex,this.gridAudioRecord=t.gridAudioRecord,this.singleAudioRecords=t.singleAudioRecords,this.imagesURL=JSON.parse(t.imagesURL),this.gridImageURL=t.gridImageURL,this.isLoaded=!0,document.getElementById("size-palette").style.background="url(icons/"+t.imageCount/3+"X3.svg)",this.activeImage=this.images[this.activeImageIndex];for(var i=0;i<9;i++)clearInterval(this.intervalIds[i]);t.grid?(this.grid=!0,this.editor.setContents(this.gridEditorContent),this.updateEditor(),null!=this.gridAudioRecord?this.playIconId="play":this.playIconId="play-inactive"):(this.grid=!1,this.editor.setContents(this.singleEditorsContent[this.activeImageIndex]),this.updateEditor(),this.modeId="single-mode",0===this.activeImageIndex?(this.previousBtnId="previous-btn-inactive",this.nextBtnId="next-btn"):this.activeImageIndex===this.imageCount-1?(this.previousBtnId="previous-btn",this.nextBtnId="next-btn-inactive"):(this.nextBtnId="next-btn",this.previousBtnId="previous-btn"),null!=this.singleAudioRecords[this.activeImageIndex]?this.playIconId="play":this.playIconId="play-inactive"),this.editor.getText().length>1?this.speakIconId="speak":this.speakIconId="speak-inactive",this.editor.setSelection(this.editor.getText().length)},onJournalLoadError:function(t){console.log("Error loading from journal")},onJournalSharedInstance:function(){console.log("Shared instance")},onNetworkDataReceived:function(t){switch(t.content.action){case"init":const i=t.content.data;this.grid=i.grid,this.imageLoaders(),document.getElementById("size-palette").style.background="url(icons/"+i.imageCount/3+"X3.svg)",this.images=i.images,this.imageCount=i.imageCount,this.gridEditorContent=JSON.parse(i.gridEditorContent),this.singleEditorsContent=JSON.parse(i.singleEditorsContent),this.connectedPlayers=i.connectedPlayers,this.imagesURL=JSON.parse(i.imagesURL),this.gridImageURL=i.gridImageURL,this.activeImageIndex=i.activeImageIndex,this.activeImage=this.images[i.activeImageIndex],0===this.activeImageIndex?(this.previousBtnId="previous-btn-inactive",this.nextBtnId="next-btn"):this.activeImageIndex===this.imageCount-1?(this.previousBtnId="previous-btn",this.nextBtnId="next-btn-inactive"):(this.nextBtnId="next-btn",this.previousBtnId="previous-btn"),this.isLoaded=!0;for(var e=0;e<this.imageCount;e++)clearInterval(this.intervalIds[e]);i.grid?this.editor.setContents(this.gridEditorContent):(this.activeImage=this.images[i.activeImageIndex],this.editor.setContents(this.singleEditorsContent[this.activeImageIndex]),this.modeId="single-mode"),this.editor.setSelection(this.editor.getText().length),this.storeData();break;case"typing":t.content.grid?this.grid?this.editor.updateContents(t.content.data):this.gridEditorContent=t.content.allText:this.grid?this.singleEditorsContent[t.content.activeImageIndex]=t.content.allText:this.activeImageIndex==t.content.activeImageIndex?this.editor.updateContents(t.content.data):this.singleEditorsContent[t.content.activeImageIndex]=t.content.allText,this.editor.getText().length>1?this.speakIconId="speak":this.speakIconId="speak-inactive";break;case"update-players":this.connectedPlayers=t.content.connectedPlayers}},onNetworkUserChanged:function(t){var e={};if(this.SugarPresence.isHost){this.grid?this.gridEditorContent=this.editor.getContents():this.singleEditorsContent[this.activeImageIndex]=this.editor.getContents();var i=this.editor.getSelection();e.range=i,this.cursors.createCursor(this.SugarPresence.presence.userInfo.networkId,this.SugarPresence.presence.userInfo.name,this.SugarPresence.presence.userInfo.colorvalue.stroke);var n=this.cursors.cursors();this.isHost||this.connectedPlayers.push(this.SugarPresence.presence.userInfo),this.isHost=!0;var o={grid:this.grid,images:this.images,imageCount:this.imageCount,activeImageIndex:this.activeImageIndex,gridEditorContent:JSON.stringify(this.gridEditorContent),singleEditorsContent:JSON.stringify(this.singleEditorsContent),imagesURL:JSON.stringify(this.imagesURL),gridImageURL:this.gridImageURL};this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"init",data:o,allcursors:n}}),e.range=null}this.myid||(this.myid=t.user.networkId);var s=t.user.name.replace("<","&lt;").replace(">","&gt;");if(1==t.move){this.connectedPlayers.push(t.user);var r=this.cursors.createCursor(t.user.networkId,s,t.user.colorvalue.stroke);this.myid==t.user.networkId&&(e=r)}if(-1==t.move){t.user.networkId===this.connectedPlayers[0].networkId&&this.$refs.SugarPopup.log(this.connectedPlayers[1].name+" is the new host");var a=this.connectedPlayers.filter(e=>e.networkId!=t.user.networkId);this.connectedPlayers=a,this.SugarPresence.isHost=this.connectedPlayers[0].networkId===this.SugarPresence.getUserInfo().networkId,this.cursors.removeCursor(t.user.networkId)}this.SugarPresence.isHost&&(this.grid||(0===this.activeImageIndex?(this.previousBtnId="previous-btn-inactive",this.nextBtnId="next-btn"):this.activeImageIndex===this.images.length-1?(this.nextBtnId="next-btn-inactive",this.previousBtnId="previous-btn"):(this.previousBtnId="previous-btn",this.nextBtnId="next-btn")),this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"update-players",connectedPlayers:this.connectedPlayers}}))},onRecord:function(t){var e=this;if(!this.SugarPresence.isShared()&&!this.isPlaying)if(window.cordova||window.PhoneGap){try{navigator.device.capture.captureAudio((function(t){var i,n,o;for(i=0,o=t.length;i<o;i+=1)-1==(n=t[i].fullPath).indexOf("file:/")&&(n="file:/"+n),n=n.replace("file:/","file:///"),window.resolveLocalFileSystemURL(n,(function(t){t.file((function(t){var i=new FileReader;i.onloadend=function(t){e.playIconId="play",e.grid?e.gridAudioRecord=t.target.result:e.singleAudioRecords[e.activeImageIndex]=t.target.result},i.readAsDataURL(t)}),(function(t){}))}),(function(t){}))}),(function(t){console.log("Error occured in capturing audio",t)}),{limit:1})}catch(t){console.log("error",t)}}else if(e.recording)e.recording=!1,e.recordIconId="record",e.recordRTC.stopRecording((function(){e.recordRTC.getDataURL((function(t){e.playIconId="play",e.grid?e.gridAudioRecord=t:e.singleAudioRecords[e.activeImageIndex]=t,e.mediaStream.stop&&e.mediaStream.stop()}),!1)}));else try{e.recording=!0,navigator.mediaDevices.getUserMedia({audio:!0}).then((function(t){var i=RecordRTC(t,{type:"audio"});e.recordIconId="record-start",e.recordRTC=i,e.mediaStream=t,i.startRecording()})).catch((function(t){e.recording=!1}))}catch(t){e.recording=!1}},exportRecord:function(){if(this.grid){if(null!=this.gridAudioRecord){var t={mimetype:(e=this.gridAudioRecord).split(";")[0].split(":")[1],title:"Story by "+this.environment.user.name+" in Grid Mode",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};this.$refs.SugarJournal.createEntry(e,t),this.$refs.SugarPopup.log(this.SugarL10n.get("GridModeAudioExported"))}}else if(null!=this.singleAudioRecords[this.activeImageIndex]){var e;t={mimetype:(e=this.singleAudioRecords[this.activeImageIndex]).split(";")[0].split(":")[1],title:"Story by "+this.environment.user.name+" for Image "+(this.activeImageIndex+1),activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};this.$refs.SugarJournal.createEntry(e,t),this.$refs.SugarPopup.log(this.SugarL10n.get("SingleModeAudioExported"))}},playAudio:function(){var t=this;if(!this.recording)if(this.grid&&null!=this.gridAudioRecord)if(t.isPlaying)t.currentTime=t.audio.currentTime,t.audio.pause(),t.playIconId="play",t.isPlaying=!1;else{var e=document.createElement("audio");t.audio=e,t.audio.src=t.gridAudioRecord,t.audio.play(),t.playIconId="pause-play",t.isPlaying=!0,0!=t.currentTime&&(t.audio.currentTime=t.currentTime),e.onended=function(){t.grid?null!=t.gridAudioRecord?t.playIconId="play":t.playIconId="play-inactive":null!=t.singleAudioRecords[t.activeImageIndex]?t.playIconId="play":t.playIconId="play-inactive",t.isPlaying=!1,t.currentTime=0}}else if(!this.grid&&null!=this.singleAudioRecords[this.activeImageIndex])if(t.isPlaying)t.currentTime=t.audio.currentTime,t.audio.pause(),t.playIconId="play",t.isPlaying=!1;else{e=document.createElement("audio");t.audio=e,t.audio.src=t.singleAudioRecords[t.activeImageIndex],t.audio.play(),t.playIconId="pause-play",t.isPlaying=!0,0!=t.currentTime&&(t.audio.currentTime=t.currentTime),e.onended=function(){t.grid?null!=t.gridAudioRecord?t.playIconId="play":t.playIconId="play-inactive":null!=t.singleAudioRecords[t.activeImageIndex]?t.playIconId="play":t.playIconId="play-inactive",t.isPlaying=!1,t.currentTime=0}}},stopAudio:function(){this.currentTime=0,this.audio.pause(),this.grid?null!=this.gridAudioRecord?this.playIconId="play":this.playIconId="play-inactive":null!=this.singleAudioRecords[this.activeImageIndex]?this.playIconId="play":this.playIconId="play-inactive",this.isPlaying=!1},speakStory:function(){if(!this.isPlaying){var t=this.editor.getText();this.$refs.SugarSpeak.speech(t)}},onHelp:function(){var t=[{element:"",orphan:!0,placement:"bottom",title:this.l10n.stringTutoExplainTitle,content:this.l10n.stringTutoExplainContent},{element:"#network-button",placement:"bottom",title:this.l10n.stringTutoNetworkTitle,content:this.l10n.stringTutoNetworkContent},{element:"#grid-mode, #single-mode",placement:"bottom",title:this.l10n.stringTutoToggleModeTitle,content:this.l10n.stringTutoToggleModeContent},{element:"#size-palette",placement:"bottom",title:this.l10n.stringTutoGridSizeTitle,content:this.l10n.stringTutoGridSizeContent},{element:"#foreground-color-button",placement:"bottom",title:this.l10n.stringTutoForegroundColorTitle,content:this.l10n.stringTutoForegroundColorContent},{element:"#background-color-button",placement:"bottom",title:this.l10n.stringTutoBackgroundColorTitle,content:this.l10n.stringTutoBackgroundColorContent},{element:"#format-text-button",placement:"bottom",title:this.l10n.stringTutoFormatTextTitle,content:this.l10n.stringTutoFormatTextContent},{element:"#font-button",placement:"bottom",title:this.l10n.stringTutoChooseFontTitle,content:this.l10n.stringTutoChooseFontContent},{element:"#increase-font",placement:"bottom",title:this.l10n.stringTutoIncreaseFontTitle,content:this.l10n.stringTutoIncreaseFontContent},{element:"#decrease-font",placement:"bottom",title:this.l10n.stringTutoDecreaseFontTitle,content:this.l10n.stringTutoDecreaseFontContent},{element:"#export-palette",placement:"bottom",title:this.l10n.stringTutoExportStoryTitle,content:this.l10n.stringTutoExportStoryContent},{element:"#export-sound",placement:"bottom",title:this.l10n.stringTutoExportSoundTitle,content:this.l10n.stringTutoExportSoundContent},{element:"#record, #record-start",placement:"left",title:this.l10n.stringTutoRecordTitle,content:this.l10n.stringTutoRecordContent},{element:"#play, #play-inactive",placement:"left",title:this.l10n.stringTutoPlayTitle,content:this.l10n.stringTutoPlayContent},{element:"#speak-inactive, #speak",placement:"left",title:this.l10n.stringTutoSpeakTitle,content:this.l10n.stringTutoSpeakContent},{element:"#next-btn",placement:"left",title:this.l10n.stringTutoNextImageTitle,content:this.l10n.stringTutoNextImageContent},{element:"#previous-btn",placement:"left",title:this.l10n.stringTutoPrevImageTitle,content:this.l10n.stringTutoPrevImageContent}];this.$refs.SugarTutorial.show(t)},storeData:function(){this.grid?this.gridEditorContent=this.editor.getContents():this.singleEditorsContent[this.activeImageIndex]=this.editor.getContents();var t={grid:this.grid,images:this.images,imageCount:this.imageCount,gridEditorContent:JSON.stringify(this.gridEditorContent),singleEditorsContent:JSON.stringify(this.singleEditorsContent),activeImageIndex:this.activeImageIndex,fontSelected:this.fontSelected,fontSize:this.fontSize,gridAudioRecord:this.gridAudioRecord,singleAudioRecords:this.singleAudioRecords,imagesURL:JSON.stringify(this.imagesURL),gridImageURL:this.gridImageURL};this.$refs.SugarJournal.saveData(t)},onStop:function(){this.storeData()}}});