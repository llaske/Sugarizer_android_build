define(["activity/data-model","webL10n"],(function(e,l){"use strict";var a,t,i=document.querySelector("canvas").getContext("2d"),o=document.querySelector("img#moon"),r=l.get;function drawEclipse(){var l;(-1!==e.next_lunar_eclipse_sec||e.last_lunar_eclipse_sec<=7200)&&(e.next_lunar_eclipse_sec<=7200||-1!==e.last_lunar_eclipse_sec)&&Math.min(e.next_lunar_eclipse_sec,e.last_lunar_eclipse_sec)<=7200&&(l=-1==e.next_lunar_eclipse_sec?e.last_lunar_eclipse_sec/7200:-1==e.last_lunar_eclipse_sec?e.next_lunar_eclipse_sec/7200:Math.min(e.next_lunar_eclipse_sec,e.last_lunar_eclipse_sec)/7200,i.save(),i.globalAlpha=.25*(1-l),i.globalCompositeOperation="multiply",i.fillStyle="red",i.fillRect(0,0,a,a),i.restore())}function drawEllipse(e,l,a,t,o,r,s,n){i.beginPath(),e+=a/2,l+=t/2;var f=a/2,c=t/2;i.ellipse(e,l,f,c,o,r,s,n),i.stroke()}function drawLine(e,l,a,t){i.beginPath(),i.moveTo(e,l),i.lineTo(a,t),i.stroke()}function drawLabel(e,l,a,t,o){var r=i.fillStyle;i.fillRect(e,l,a,t),i.fillStyle="white",i.fillText(o,e+5,l+18),i.fillStyle=r}return i.ellipse||(i.ellipse=function(e,l,a,t,o,r,s,n){e-=a,l-=t;var f=(a*=2)/2*.5522848,c=(t*=2)/2*.5522848,_=e+a,h=l+t,p=e+a/2,d=l+t/2;r===Math.PI/2&&s===3*Math.PI/2?(i.moveTo(p,h),i.bezierCurveTo(p-f,h,e,d+c,e,d),i.bezierCurveTo(e,d-c,p-f,l,p,l)):r===3*Math.PI/2&&s===Math.PI/2?(i.moveTo(p,l),i.bezierCurveTo(p+f,l,_,d-c,_,d),i.bezierCurveTo(_,d+c,p+f,h,p,h)):0===r&&s===2*Math.PI&&(i.moveTo(_,d),i.bezierCurveTo(_,d+c,p+f,h,p,h),i.bezierCurveTo(p-f,h,e,d+c,e,d),i.bezierCurveTo(e,d-c,p-f,l,p,l),i.bezierCurveTo(p+f,l,_,d-c,_,d))}),{moon:function drawMoon(){var l=null;i.strokeStyle="black",i.fillStyle="black",i.fillRect(0,0,a,a),e.phase_of_moon<.25?(l=1-4*(e.phase_of_moon-Math.abs(Math.sin(e.phase_of_moon*Math.PI*4)/18)),i.fillStyle="white",i.fillRect(t,0,t,a),i.fillStyle="black",drawEllipse(t-a*l/2,0,a*l,a,0,3*Math.PI/2,Math.PI/2),i.fill()):e.phase_of_moon<.5?(l=4*(e.phase_of_moon+Math.abs(Math.sin(e.phase_of_moon*Math.PI*4)/18)-.25),i.fillStyle="white",i.fillRect(t,0,t,a),i.fillStyle="white",drawEllipse(t-a*l/2,0,a*l,a,0,Math.PI/2,3*Math.PI/2),i.fill()):e.phase_of_moon<.75?(l=1-4*(e.phase_of_moon-Math.abs(Math.sin(e.phase_of_moon*Math.PI*4)/18)-.5),i.fillStyle="white",i.fillRect(0,0,t,a),i.fillStyle="white",drawEllipse(t-a*l/2,0,a*l,a,0,3*Math.PI/2,Math.PI/2),i.fill()):(l=4*(e.phase_of_moon+Math.abs(Math.sin(e.phase_of_moon*Math.PI*4)/18)-.75),i.fillStyle="white",i.fillRect(0,0,t,a),i.fillStyle="black",drawEllipse(t-a*l/2,0,a*l,a,0,Math.PI/2,3*Math.PI/2),i.fill()),i.save(),i.globalCompositeOperation="multiply",i.drawImage(o,0,0,a,a),i.globalAlpha=.5,i.globalCompositeOperation="source-over",i.drawImage(o,0,0,a,a),i.restore(),drawEclipse()},eclipse:drawEclipse,grid:function drawGrid(e){var l=.08*a;i.font="16px Sans",i.lineWidth=3,i.fillStyle="blue",drawLabel(t+1,t,26,22,"0°"),drawLabel(t+1,.5*t,36,22,"30°"),drawLabel(t+1,1.5*t,36,22,"30°"),drawLabel(t+1,.15*t,36,22,"60°"),drawLabel(t+1,1.85*t,36,22,"60°"),i.fillStyle="red",drawLabel(.48*t,t,36,22,"30°"),drawLabel(1.52*t,t,36,22,"30°"),drawLabel(.15*t,t,36,22,"60°"),drawLabel(1.85*t,t,36,22,"60°"),i.strokeStyle="blue",drawLine(0,t,a,t),drawLine(.15*t,.5*t,a-.15*t,.5*t),drawLine(.15*t,1.5*t,a-.15*t,1.5*t),drawLine(.5*t,.15*t,a-.5*t,.15*t),drawLine(.5*t,1.85*t,a-.5*t,1.85*t),i.strokeStyle="red",drawLine(t,0,t,a),drawEllipse(.15*t,0,a-.15*a,a,0,0,2*Math.PI),drawEllipse(.48*t,0,a-.48*a,a,0,0,2*Math.PI),i.fillStyle="red",i.fillRect(16,l,l,4),i.fillText(e[3],0,l+8),i.fillText(e[2],l+16+4,l+8),i.fillText(r("Longitude"),0,a-16),i.fillStyle="blue",i.fillRect(.5*l+16,.5*l,4,l),i.fillText(e[0],.5*l+16-4,.5*l-8),i.fillText(e[1],.5*l+16-4,1.5*l+16+4),i.fillText(r("Latitude"),0,a-40)},setImageSize:function setImageSize(e){t=.5*(a=e)}}}));