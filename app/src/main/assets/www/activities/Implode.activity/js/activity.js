define(["sugar-web/activity/activity","sugar-web/env","picoModal","l10n","tutorial"],(function(e,t,i,n,r){requirejs(["domReady!"],(function(s){e.setup();var a=document.getElementById("canvas"),o=document.getElementById("mainCanvas"),l=new createjs.Stage("mainCanvas");createjs.Touch.enable(l);var c="#5959B3",g=[[8,6],[12,10],[20,15]],h=15,d=0,u=0,_=g[d].slice(),m=["#E6000A","#00EA11","#FFFA00","#5E008C","#FF8F00"],p={},y=[],v=[],f=[],b=[];l.enableMouseOver(30);var B=!0,C="playing",w=c;document.getElementById("undo").addEventListener("click",(function(){1==B&&Undo()})),document.getElementById("redo").addEventListener("click",(function(){1==B&&Redo()})),document.getElementById("new-game").addEventListener("click",(function(){new_game(d)})),document.getElementById("replay").addEventListener("click",(function(){1==B&&function replay_game(){if("playing"==C){var e=Object.keys(p);for(var t in e){t=e[parseInt(t)];for(var i=0;i<p[t].length;i++){(n=l.getChildByName(`${t}_${i}`)).graphics._instructions[2].style=m[p[t][i]-1],n.prev_color=m[p[t][i]-1]}}}else l.removeAllChildren(),init();for(t=0;t<f.length;t++){var n,r=f[t].split("_");(n=l.getChildByName(`${parseInt(r[0])}_${parseInt(r[1])}`)).highlighted=!1,n.graphics._stroke.style=c,n.graphics._strokeStyle.width=border_width(d)}y=[],v=[],f=[],adjust_circle()}()})),document.getElementById("easy").addEventListener("click",(function(){new_game(0)})),document.getElementById("medium").addEventListener("click",(function(){new_game(1)})),document.getElementById("hard").addEventListener("click",(function(){new_game(2)})),document.getElementById("help-button").addEventListener("click",(function(e){r.start()}));var k=!1;function button_highlight(e){0==e?(document.getElementById("easy").style.backgroundColor="grey",document.getElementById("medium").style.backgroundColor="#282828",document.getElementById("hard").style.backgroundColor="#282828"):1==e?(document.getElementById("easy").style.backgroundColor="#282828",document.getElementById("medium").style.backgroundColor="grey",document.getElementById("hard").style.backgroundColor="#282828"):(document.getElementById("easy").style.backgroundColor="#282828",document.getElementById("medium").style.backgroundColor="#282828",document.getElementById("hard").style.backgroundColor="grey")}function SetMaxSize(e){for(var t=Object.keys(e),i=0,n=0;n<t.length;n++)i<e[parseInt(t[n])].length&&(i=e[parseInt(t[n])].length);_[0]=t.length,_[1]=i}function new_game(e){button_highlight(e),l.removeAllChildren(),u=2==(d=e)?2:0,_=g[d].slice();var t=generate_board(u,5,_);t[0].simplify(),SetMaxSize(p=t[0]._data),y=[],v=[],f=[],stage_resize(),init()}function draw_square(e,t,i,n){e.graphics.beginStroke(c),e.graphics.setStrokeStyle(border_width(d)),e.graphics.beginFill(n),e.graphics.drawRect(t*h,i*h,h-border_width(d),h-border_width(d)),e.graphics.endFill()}function border_width(e){return Math.floor(h/10)}function init(){C="playing";for(var e=0;e<_[0];e++)for(var t=0,i=_[1]-1;i>=0;i--){draw_square(a=new createjs.Shape,e,t,c),a.name=`${e}_${i}`,a.highlighted=!1,a.marked=!1,a.prev_color=c,a.addEventListener("mouseover",(function(e){1==B&&0==("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0)&&(highlight_mouseover(e.target),l.update())})),a.addEventListener("click",(function(e){1==B&&1==("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0)&&HandleTap(e)})),l.addChild(a),t++}var n=Object.keys(p);for(var e in n){e=n[parseInt(e)];for(i=0;i<p[e].length;i++){var r=l.getChildByName(`${e}_${i}`);r.graphics._instructions[2].style=m[p[e][i]-1],r.prev_color=m[p[e][i]-1]}}var s=new createjs.Shape,a=l.getChildByName("0_0");s.graphics.beginFill("white").drawCircle(a.graphics._instructions[1].h/2+a.graphics._instructions[1].x,a.graphics._instructions[1].h/2+a.graphics._instructions[1].y,a.graphics._instructions[1].h/9),s.graphics.endFill(),s.name="white_circle",s.parent_box=a.name,l.addChild(s),highlight_mouseover(a),l.update()}document.getElementById("fullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.display="none",document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",k=!0,"won"==C?winning_smiley(w):stage_resize()})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.display="block",document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",k=!1,"won"==C?winning_smiley(w):stage_resize()})),document.addEventListener("keydown",(function(e){var t=e.which||e.keyCode;null!=keys[t]&&"visible"!=document.getElementById("activity-palette").style.visibility&&e.preventDefault()})),document.addEventListener("keyup",(function(e){e.preventDefault();var t=e.which||e.keyCode,i=l.getChildByName("white_circle");if(1==B&&"visible"!=document.getElementById("activity-palette").style.visibility)switch(keys[t]){case"up":if(null!=i&&"playing"==C){var n=i.parent_box.split("_"),r=l.getChildByName(`${parseInt(n[0])}_${parseInt(n[1])+1}`);null!=r&&1==r.visible&&(highlight_mouseover(r),l.update())}break;case"down":if(null!=i&&"playing"==C){n=i.parent_box.split("_");var s=l.getChildByName(`${parseInt(n[0])}_${parseInt(n[1])-1}`);null!=s&&1==s.visible&&(highlight_mouseover(s),l.update())}break;case"left":if(null!=i&&"playing"==C){n=i.parent_box.split("_");var a=l.getChildByName(`${parseInt(n[0])-1}_${parseInt(n[1])}`);null!=a&&1==a.visible&&(highlight_mouseover(a),l.update())}break;case"right":if(null!=i&&"playing"==C){n=i.parent_box.split("_");var o=l.getChildByName(`${parseInt(n[0])+1}_${parseInt(n[1])}`);null!=o&&1==o.visible&&(highlight_mouseover(o),l.update())}break;case"select":"playing"==C&&move();break;case"new":new_game(d);break;case"easy_level":new_game(0);break;case"medium_level":new_game(1);break;case"hard_level":new_game(2);break;case"undo_move":Undo();break;case"redo_move":Redo()}}));var I=!1;function HandleTap(e){e.preventDefault(),1==e.target.highlighted&&f.length>2?(highlight_mouseover(e.target),move()):(highlight_mouseover(e.target),l.update())}function move(){if(f.length>2&&1==B){B=!1;for(var e=createjs.Ticker.on("tick",l),t=0;t<f.length;t++)createjs.Tween.get(l.getChildByName(f[t])).to({alpha:0},150);setTimeout((function(){createjs.Ticker.off("tick",e);for(var t=0;t<f.length;t++)l.getChildByName(f[t]).alpha=1;!function drop(){v=[];for(var e=0;e<_[0]*_[1];e++){var t=l.getChildAt(e);t.prev_color=t.graphics._instructions[2].style}for(var i=0;i<_[0];i++)for(var n=0;n<_[1];n++)if(l.getChildByName(`${i}_${n}`).highlighted){for(var r=n;r<_[1];r++){var s=l.getChildByName(`${i}_${r}`),a=l.getChildByName(`${i}_${r+1}`);r<_[1]-1?(s.graphics._instructions[2].style=a.graphics._instructions[2].style,s.highlighted=a.highlighted):(s.graphics._instructions[2].style=c,s.highlighted=!1)}n--}}();for(t=0;t<f.length;t++){var r=f[t].split("_"),s=l.getChildByName(`${parseInt(r[0])}_${parseInt(r[1])}`);s.highlighted=!1,s.graphics._stroke.style=c,s.graphics._strokeStyle.width=border_width()}l.update(),setTimeout((function(){!function shiftLeft(){for(var e=0;e<_[0];e++)if(l.getChildByName(`${e}_0`).graphics._instructions[2].style==c)for(var t=e;t<_[0];t++){var i=1;if(t+i<_[0])for(;l.getChildByName(`${t+i}_0`).graphics._instructions[2].style==c&&t+ ++i!=_[0];);for(var n=0;n<_[1];n++)if(t+i!=_[0]){var r=l.getChildByName(`${t}_${n}`),s=l.getChildByName(`${t+i}_${n}`);r.graphics._instructions[2].style=s.graphics._instructions[2].style,l.getChildByName(`${t+i}_${n}`).graphics._instructions[2].style=c}}for(var a={},o=0;o<_[0]*_[1];o++){(g=l.getChildAt(o)).graphics._instructions[2].style!=g.prev_color&&(a[g.name]=g.prev_color)}for(o=0;o<f.length;o++){var g,h=f[o].split("_");a[(g=l.getChildByName(`${parseInt(h[0])}_${parseInt(h[1])}`)).name]=g.prev_color}y.push(a),f=[]}(),adjust_circle(),function IsGameOver(){for(var e=0;e<_[0]*_[1];e++){var t=l.getChildAt(e);if(1==t.visible){var r=t.name.split("_");r[0]=parseInt(r[0]),r[1]=parseInt(r[1]),sameColorLeft(r[0],r[1],t.graphics._instructions[2].style);for(var s=b.length,a=0;a<b.length;a++){var o=b[a].split("_");o[0]=parseInt(o[0]),o[1]=parseInt(o[1]),l.getChildByName(`${o[0]}_${o[1]}`).marked=!1}if(b=[],s>2)return}}l.getChildByName("0_0").graphics._instructions[2].style==c?setTimeout((function(){C="won",winning_smiley(w=l.getChildByName("0_0").prev_color)}),5):setTimeout((function(){!function lose(){var e=n.get("Continue"),t=n.get("StuckMessage");i({content:"<div style = 'width:400px;margin-bottom:60px'><div style='width:40vw;float:left;margin-left:20px;'><div style='color:white;margin-top:10px;font-size:18px;'>"+t+"</div></div></div><div><button class='continue warningbox-refresh-button'>"+e+"</button></div>",closeButton:!1,modalStyles:{backgroundColor:"#000000",height:"120px",width:"60%",textColor:"white"}}).afterCreate((function(e){e.modalElem().addEventListener("click",(function(t){(t.target&&t.target.matches(".continue")||t.target&&t.target.matches(".cancel-changes"))&&e.close()}))})).show()}()}),500)}(),B=!0}),150)}),300)}}function adjust_circle(){var e=l.getChildByName("white_circle").parent_box;I=!0,highlight_mouseover(l.getChildByName(e)),I=!1,stage_resize()}function highlight_mouseover(e){var t=l.getChildByName("white_circle"),i=e.name.split("_");if(i[0]=parseInt(i[0]),i[1]=parseInt(i[1]),l.getChildByName(`${i[0]}_0`).graphics._instructions[2].style!=c){clear_prev_higlight();var n=e.graphics._instructions[1].h/2+e.graphics._instructions[1].x,r=e.graphics._instructions[1].h/2+e.graphics._instructions[1].y;t.graphics._instructions[1].x=n,t.graphics._instructions[1].y=r,t.graphics._instructions[1].radius=e.graphics._instructions[1].h/9,t.parent_box=e.name}else if(l.getChildByName(`${i[0]}_0`).graphics._instructions[2].style==c&&1==I){clear_prev_higlight();for(var s=_[0]-1;s>=0&&l.getChildByName(`${s}_0`).graphics._instructions[2].style==c;s--);if(-1==s)return;(i=(e=l.getChildByName(`${s}_${i[1]}`)).name.split("_"))[0]=parseInt(i[0]),i[1]=parseInt(i[1]);n=e.graphics._instructions[1].h/2+e.graphics._instructions[1].x,r=e.graphics._instructions[1].h/2+e.graphics._instructions[1].y;t.graphics._instructions[1].x=n,t.graphics._instructions[1].y=r,t.graphics._instructions[1].radius=e.graphics._instructions[1].h/9,t.parent_box=e.name}if(e.graphics._instructions[2].style!=c||0==e.highlighted){var a=l.getChildByName(`${i[0]}_${i[1]}`).graphics._instructions[2].style;sameColorBlocks(i[0],i[1],a),function highlight_same_color(){if(f.length>2)for(var e=0;e<f.length;e++){var t=f[e].split("_");t[0]=parseInt(t[0]),t[1]=parseInt(t[1]);var i=l.getChildByName(`${t[0]}_${t[1]}`);i.graphics._stroke.style="white",i.graphics._strokeStyle.width=border_width()}}()}}function clear_prev_higlight(){for(var e=0;e<f.length;e++){var t=f[e].split("_");t[0]=parseInt(t[0]),t[1]=parseInt(t[1]);var i=l.getChildByName(`${t[0]}_${t[1]}`);i.highlighted=!1,i.graphics._stroke.style=c,i.graphics._strokeStyle.width=border_width()}f=[]}function sameColorBlocks(e,t,i){var n=l.getChildByName(`${e}_${t}`),r=n.graphics._instructions[2].style;r==c||n.highlighted||r!=i||(n.highlighted=!0,f.push(`${e}_${t}`),t>0&&sameColorBlocks(e,t-1,i),t<_[1]-1&&sameColorBlocks(e,t+1,i),e>0&&sameColorBlocks(e-1,t,i),e<_[0]-1&&sameColorBlocks(e+1,t,i))}function sameColorLeft(e,t,i){var n=l.getChildByName(`${e}_${t}`),r=n.graphics._instructions[2].style;r==c||n.marked||r!=i||(n.marked=!0,b.push(`${e}_${t}`),t>0&&sameColorLeft(e,t-1,i),t<_[1]-1&&sameColorLeft(e,t+1,i),e>0&&sameColorLeft(e-1,t,i),e<_[0]-1&&sameColorLeft(e+1,t,i))}function winning_smiley(e){l.removeAllChildren(),l.removeAllEventListeners(),y=[],v=[],f=[];var t=(window.innerWidth-200)/10;o.height=k?window.innerHeight-45:window.innerHeight-95,t<(h=o.height/9)&&(h=t),o.width=10*h+15,o.height=9*h+8;for(var i=0;i<10;i++)for(var n=0;n<9;n++){var r=new createjs.Shape;r.graphics.beginStroke(c),r.graphics.setStrokeStyle(5),r.graphics.beginFill(c),r.graphics.drawRect(i*h,n*h,h-5,h-5),r.graphics.endFill(),r.name=`${i}_${n}`,l.addChild(r)}setTimeout((function(){for(var t=2;t<8;t++){l.getChildByName(`${t}_0`).graphics._instructions[2].style=e,l.getChildByName(`${t}_8`).graphics._instructions[2].style=e}for(t=2;t<7;t++){l.getChildByName(`0_${t}`).graphics._instructions[2].style=e,l.getChildByName(`9_${t}`).graphics._instructions[2].style=e}l.getChildByName("1_1").graphics._instructions[2].style=e,l.getChildByName("8_1").graphics._instructions[2].style=e,l.getChildByName("1_7").graphics._instructions[2].style=e,l.getChildByName("8_7").graphics._instructions[2].style=e,l.update(),setTimeout((function(){l.getChildByName("3_3").graphics._instructions[2].style=e,l.getChildByName("6_3").graphics._instructions[2].style=e,l.getChildByName("2_5").graphics._instructions[2].style=e,l.getChildByName("7_5").graphics._instructions[2].style=e;for(var t=3;t<7;t++){l.getChildByName(`${t}_6`).graphics._instructions[2].style=e}l.update()}),100)}),100)}function Undo(){if(y.length>0){for(var e={},t=y[y.length-1],i=Object.keys(t),n=0;n<i.length;n++){var r=i[n].split("_"),s=l.getChildByName(`${parseInt(r[0])}_${parseInt(r[1])}`),a=t[i[n]];e[i[n]]=s.graphics._instructions[2].style,s.graphics._instructions[2].style=a}y.pop(),v.push(e),adjust_circle()}}function Redo(){if(v.length>0){for(var e={},t=v[v.length-1],i=Object.keys(t),n=0;n<i.length;n++){var r=i[n].split("_"),s=l.getChildByName(`${parseInt(r[0])}_${parseInt(r[1])}`),a=t[i[n]];e[i[n]]=s.graphics._instructions[2].style,s.graphics._instructions[2].style=a}v.pop(),y.push(e),adjust_circle()}}function stage_resize(){document.getElementById("activity-palette").style.left=window.innerWidth>770?"55px":"8px";var e=!1,t=0,i=0;if(l.children.length>0){for(var n=0;n<_[0]*_[1];n++){(d=l.getChildAt(n)).visible=!0}for(n=_[1]-1;n>=0;n--){for(var r=0;r<_[0];r++)if(l.getChildByName(`${r}_${n}`).graphics._instructions[2].style!=c){e=!0;break}if(1==e)break;t++}for(n=_[1]-1;n>=_[1]-t;n--)for(r=0;r<_[0];r++)l.getChildByName(`${r}_${n}`).visible=!1;e=!1;for(n=_[0]-1;n>=0;n--){for(r=0;r<_[1];r++)if(l.getChildByName(`${n}_${r}`).graphics._instructions[2].style!=c){e=!0;break}if(1==e)break;i++}for(n=_[0]-1;n>=_[0]-i;n--)for(r=0;r<_[1];r++)l.getChildByName(`${n}_${r}`).visible=!1}var s=h,a=(window.innerWidth-200)/(_[0]-i);if(o.height=k?window.innerHeight-45:window.innerHeight-95,a<(h=o.height/(_[1]-t))&&(h=a),o.width=h*(_[0]-i)+15,o.height=h*(_[1]-t)+8,l.children.length>0&&s!=h){r=0;var g=0;for(n=0;n<_[0]*_[1];n++){var d;(d=l.getChildAt(n)).graphics._instructions[1].h=h-border_width(),d.graphics._instructions[1].w=h-border_width(),d.graphics._instructions[1].x=g*h,d.graphics._instructions[1].y=r*h,d.graphics._instructions[3].width=border_width(),r==_[1]-1?(r=0,g++):r++}}if(l.x=10,l.y=5,l.children.length>0){var u=l.getChildByName("white_circle"),m=l.getChildByName(u.parent_box);if(null!=m){0==m.visible&&(m=l.getChildByName("0_0"),u.parent_box="0_0");var p=m.graphics._instructions[1].h/2+m.graphics._instructions[1].x,y=m.graphics._instructions[1].h/2+m.graphics._instructions[1].y;u.graphics._instructions[1].x=p,u.graphics._instructions[1].y=y,u.graphics._instructions[1].radius=m.graphics._instructions[1].h/9,highlight_mouseover(m)}}_[1]-t-1>=0&&l.children.length>0&&l.setTransform(10,-1*(l.getChildByName("0_"+(_[1]-t-1)).graphics._instructions[1].y-5)),l.update()}a.addEventListener("click",(function(e){"ontouchstart"in document.documentElement==0&&move()})),t.getEnvironment((function(t,i){currentenv=i;var r="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,s=i.user?i.user.language:r;if(n.init(s),i.objectId)e.getDatastoreObject().loadAsText((function(e,t,i){if(null==e&&null!=i){var n=JSON.parse(i);if(button_highlight(d=n.level),u=2==d?2:0,_=g[d].slice(),SetMaxSize(p=n.pieces),y=n.undo_stack,v=n.redo_stack,"won"==n.game_status)C="won",w=n.smiley_color,winning_smiley(n.smiley_color);else{init();for(var r=0;r<l.children.length;r++){var s=l.getChildAt(r);"white_circle"!=s.name&&(s.graphics._instructions[2].style=n.blocks_data[s.name][0],s.prev_color=n.blocks_data[s.name][1],s.visible=n.blocks_data[s.name][2])}var a=l.getChildByName("white_circle");a.parent_box=n.circle_parent,highlight_mouseover(l.getChildByName(a.parent_box)),stage_resize()}}}));else{button_highlight(d),u=2==d?2:0;var a=generate_board(u,5,_);a[0].simplify(),SetMaxSize(p=a[0]._data),stage_resize(),init()}})),document.getElementById("stop-button").addEventListener("click",(function(t){if(console.log("writing..."),"won"==C)var i={blocks_data:{},level:d,pieces:p,undo_stack:y,redo_stack:v,circle_parent:"",game_status:C,smiley_color:w};else{for(var n={},r=0;r<_[0]*_[1];r++){var s=[],a=l.getChildAt(r);s.push(a.graphics._instructions[2].style),s.push(a.prev_color),s.push(a.visible),n[a.name]=s}var o=l.getChildByName("white_circle");i={blocks_data:n,level:d,pieces:p,undo_stack:y,redo_stack:v,circle_parent:o.parent_box,game_status:C,smiley_color:w}}var c=JSON.stringify(i);e.getDatastoreObject().setDataAsText(c),e.getDatastoreObject().save((function(e){null===e?console.log("write done."):console.log("write failed.")}))})),window.addEventListener("resize",(function(){"won"==C?winning_smiley(w):stage_resize()})),window.addEventListener("localized",(function(){document.getElementById("new-game").title=n.get("NewGame"),document.getElementById("replay").title=n.get("Replay"),document.getElementById("undo").title=n.get("Undo"),document.getElementById("redo").title=n.get("Redo"),document.getElementById("easy").title=n.get("Easy"),document.getElementById("medium").title=n.get("Medium"),document.getElementById("hard").title=n.get("Hard")}))}))}));