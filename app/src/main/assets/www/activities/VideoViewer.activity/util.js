var app;function uint6ToB64(t){return t<26?t+65:t<52?t+71:t<62?t-4:62===t?43:63===t?47:65}Util={},Util.context={filter:{category:"",text:"",favorite:!1},libraries:null,library:null,favorites:{},readtimes:{},currentindex:0},Util.saveContext=function(){if(!Util.onSugar()&&app&&app.activity){var t=app.activity.getDatastoreObject(),e=JSON.stringify(Util.context);t.setDataAsText(e),t.save((function(){}))}},Util.loadContext=function(t,e){Util.onSugar()?(Util.context=e,app.loadDatabase(),app.hideLibraries()):requirejs(["sugar-web/env"],(function(e){e.getEnvironment((function(e,i){i.objectId?app.activity.getDatastoreObject().loadAsText((function(e,i,r){var n=JSON.parse(r);n?(Util.context=n,app.loadDatabase()):app.loadLibraries(),t()})):app.loadLibraries()}))}))},Util.setFilter=function(t){void 0!==t.favorite&&(Util.context.filter.favorite=t.favorite),void 0!==t.category&&(Util.context.filter.category=t.category),void 0!==t.text&&(Util.context.filter.text=t.text),app.filterChanged()},Util.getFilter=function(){return Util.context.filter},Util.getCollection=function(){for(var t=Util.database,e=[],i=0;i<t.length;i++)Util.context.filter.favorite&&!Util.getFavorite(t[i].id)||Util.context.filter.category.length>0&&t[i].category!=Util.context.filter.category||Util.context.filter.text.length>0&&-1==t[i].title.toLowerCase().indexOf(Util.context.filter.text.toLowerCase())||e.push(t[i]);return e},Util.setFavorite=function(t,e){Util.context.favorites[t]=e||void 0},Util.getFavorite=function(t){return Util.context.favorites[t]},Util.setReadTime=function(t,e){Util.context.readtimes[t]=e||void 0},Util.getReadTime=function(t){return Util.context.readtimes[t]},Util.database=[],Util.categories=[],Util.loadLibraries=function(t,e){Util.getLanguage((function(i){var r=new enyo.Ajax({url:constant.librariesUrl+"?lang="+i,method:"GET",handleAs:"json"});r.response((function(e,i){Util.context.libraries=i,t()})),r.error(e),r.go()}))},Util.loadDatabase=function(t,e){null!=Util.context.library&&Util.getLanguage((function(i){var r=Util.context.library.database.replace(new RegExp("%language%","g"),i);"https:"==document.location.protocol&&(r=r.replace("http://","https://"));var n=new enyo.Ajax({url:r,method:"GET",handleAs:"json"});n.response((function(e,i){Util.database=i,Util.categories=[];for(var r=0;r<i.length;r++){var n=i[r].category;if(void 0!==n){for(var a=!1,o=0;!a&&o<Util.categories.length;o++)n==Util.categories[o].id&&(a=!0);a||Util.categories.push({id:n,title:n})}}app.getFilter().setCategories(Util.categories),t(i)})),n.error(e),n.go()}))},Util.getDatabase=function(){return Util.database},Util.getVideos=function(){return Util.context.library.videos},Util.getImages=function(){return Util.context.library.images},Util.setIndex=function(t){Util.context.currentindex=t},Util.getIndex=function(){return Util.context.currentindex},Util.setLibrary=function(t){Util.context.library=t},Util.getLibrary=function(){return Util.context.library},Util.addLibrary=function(t){Util.context.libraries.push(t)},Util.removeLibrary=function(t){if(Util.context.library!=t&&1!=Util.context.libraries.length){for(var e=[],i=0;i<Util.context.libraries.length;i++)Util.context.libraries[i]!=t&&e.push(Util.context.libraries[i]);Util.context.libraries=e}},Util.onSugar=function(){var t;return(t=RegExp("[?&]"+"onsugar"+"=([^&]*)").exec(window.location.search))&&decodeURIComponent(t[1].replace(/\+/g," "))},Util.getLanguage=function(t){Util.onSugar()?t(navigator.language):"undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.storage.local.get("sugar_settings",(function(e){t(JSON.parse(e.sugar_settings).language)})):t(JSON.parse(localStorage.sugar_settings).language)},Util.toBase64=function(t){for(var e,i=(3-t.length%3)%3,r="",n=t.length,a=0,o=0;o<n;o++)e=o%3,a|=t[o]<<(16>>>e&24),2!==e&&t.length-o!=1||(r+=String.fromCharCode(uint6ToB64(a>>>18&63),uint6ToB64(a>>>12&63),uint6ToB64(a>>>6&63),uint6ToB64(63&a)),a=0);return 0===i?r:r.substring(0,r.length-i)+(1===i?"=":"==")};