define(["sugar-web/activity/activity","webL10n","sugar-web/datastore","sugar-web/graphics/colorpalette","zoompalette","sugar-web/graphics/presencepalette","humane","fontpalette","tutorial","sugar-web/env"],(function(e,t,n,o,a,l,i,c,r,d,s){var u=!1,g=!1,f=null,m={};requirejs(["domReady!"],(function(s){e.setup();var v=0,y=document.getElementById("nodetext-button"),h=document.getElementById("link-button"),p=document.getElementById("delete-button"),switchMode=function(e){v=e,y.classList.remove("active"),h.classList.remove("active"),p.classList.remove("active"),0==e?y.classList.add("active"):1==e?h.classList.add("active"):2==e&&p.classList.add("active"),hideSubToolbar(),null!=_&&(unselectAllNode(),_=null)};y.addEventListener("click",(function(){switchMode(0)}),!0),h.addEventListener("click",(function(){switchMode(1),_=null}),!0),p.addEventListener("click",(function(){switchMode(2)}),!0);var b=document.getElementById("zoom-button");zoomPalette=new a.zoomPalette(b),zoomPalette.addEventListener("pop",(function(e){hideSubToolbar()})),zoomPalette.addEventListener("zoom",(function(e){var t=e.detail.zoom,n=cy.zoom(),o=.25;0==t?n!=cy.minZoom()&&n-o>cy.minZoom()&&cy.zoom(n-o):1==t?n!=cy.maxZoom()&&cy.zoom(n+o):2==t?cy.fit():3==t&&cy.center()}));var E=document.getElementById("png-button");E.addEventListener("click",(function(e){var o=cy.png(),a=o.split(";")[0].split(":")[1],l=a.split("/")[0],c={mimetype:a,title:l.charAt(0).toUpperCase()+l.slice(1)+" LabyrinthJS",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};n.create(c,(function(){i.log(t.get("LabyrinthImage")),console.log("export done.")}),o)}));var w=document.getElementById("sub-toolbar"),x=document.getElementById("textvalue"),k=document.getElementById("erasetext-button"),B=document.getElementById("bold-button"),I=document.getElementById("italics-button"),L=document.getElementById("foreground-button");foregroundPalette=new o.ColorPalette(L),foregroundPalette.setColor("rgb(0, 0, 0)");var C=!1,P=document.getElementById("background-button");backgroundPalette=new o.ColorPalette(P),backgroundPalette.setColor("rgb(255, 255, 255)");var T=!1,z=document.getElementById("fontminus-button"),S=document.getElementById("fontplus-button"),D=document.getElementById("font-button");fontPalette=new c.TextPalette(D),document.getElementById("help-button").addEventListener("click",(function(e){if(r.setElement("activity",document.getElementById("activity-button")),r.setElement("stop",document.getElementById("stop-button")),r.setElement("undo",document.getElementById("undo-button")),r.setElement("redo",document.getElementById("redo-button")),r.setElement("node",y),r.setElement("link",h),r.setElement("remove",p),r.setElement("png",E),r.setElement("zoom",b),r.setElement("textvalue",x),r.setElement("bold",B),r.setElement("italic",I),r.setElement("foreground",L),r.setElement("background",P),r.setElement("font",D),r.setElement("fontminus",z),r.setElement("fontplus",S),r.setElement("board",document.getElementById("canvas")),cy){var t=_;if(!t){var n=cy.elements("node");n.length>0&&(t=n[0],_=t,selectNode(t))}t&&showSubToolbar(t)}r.start()})),foregroundPalette.addEventListener("colorChange",(function(e){C||(_.style("color",e.detail.color),_.data("color",e.detail.color),pushState()),C=!1})),backgroundPalette.addEventListener("colorChange",(function(e){T||(_.style("background-color",e.detail.color),_.data("background-color",e.detail.color),pushState()),T=!1})),fontPalette.addEventListener("fontChange",(function(e){var t=e.detail.family;_.data("font-family",t),_.removeClass("arial-text comic-text verdana-text"),updateNodeText(_),"Arial"==t?_.addClass("arial-text"):"Comic Sans MS"==t?_.addClass("comic-text"):"Verdana"==t&&_.addClass("verdana-text"),pushState()})),x.addEventListener("input",(function(){x.value.length>0?$("#erasetext-button").show():$("#erasetext-button").hide(),updateNodeText(_,x.value),pushState()})),k.addEventListener("click",(function(){x.value="",x.focus(),updateNodeText(_,x.value),$("#erasetext-button").hide(),pushState()})),B.addEventListener("click",(function(){_.toggleClass("bold-text"),_.hasClass("bold-text")?B.classList.add("active"):B.classList.remove("active"),updateNodeText(_),pushState()})),I.addEventListener("click",(function(){_.toggleClass("italic-text"),_.hasClass("italic-text")?I.classList.add("active"):I.classList.remove("active"),updateNodeText(_),pushState()})),z.addEventListener("click",(function(){_.data("font-size",Math.max(6,_.data("font-size")-2)),updateNodeText(_),pushState()})),S.addEventListener("click",(function(){_.data("font-size",Math.min(100,_.data("font-size")+2)),updateNodeText(_),pushState()}));var showSubToolbar=function(e){zoomPalette.popDown(),w.style.visibility="visible",x.value=e.style().content,e.hasClass("bold-text")?B.classList.add("active"):B.classList.remove("active"),e.hasClass("italic-text")?I.classList.add("active"):I.classList.remove("active"),C=!0,foregroundPalette.setColor(e.style().color),T=!0,backgroundPalette.setColor(e.style()["background-color"]),fontPalette.setFont(e.data("font-family"))},hideSubToolbar=function(){w.style.visibility="hidden",backgroundPalette.popDown(),foregroundPalette.popDown(),fontPalette.popDown()};document.getElementById("stop-button").addEventListener("click",(function(e){console.log("writing..."),saveGraph((function(e){null===e?console.log("write done."):console.log("write failed.")}))})),window.addEventListener("localized",(function(){d.getEnvironment((function(e,n){var o="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,a=n.user?n.user.language:o;t.language.code!=a&&(t.language.code=a);var l=j;if(j=t.get("YourNewIdea"),y.title=t.get("nodetextTitle"),h.title=t.get("linkButtonTitle"),p.title=t.get("removeButtonTitle"),N.title=t.get("undoButtonTitle"),V.title=t.get("redoButtonTitle"),b.title=t.get("zoomButtonTitle"),L.title=t.get("foregroundButtonTitle"),P.title=t.get("backgroundButtonTitle"),x.placeholder=t.get("typeText"),B.title=t.get("boldButtonTitle"),I.title=t.get("italicButtonTitle"),z.title=t.get("fontMinusButtonTitle"),S.title=t.get("fontPlusButtonTitle"),D.title=t.get("fontButtonTitle"),E.title=t.get("pngButtonTitle"),cy)for(var i=cy.elements("node"),c=0;c<i.length;c++){var r=i[c];r.data("content")==l&&(r.data("content",j),r.style({content:j}))}}))}),!1),cy=cytoscape({container:document.getElementById("cy"),ready:function(){var e=createNode(j,getCenter());e.select(),selectNode(e),_=e,showSubToolbar(e),pushState(),loadGraph()},style:[{selector:".standard-node",css:{"text-valign":"center","text-halign":"center","border-color":"darkgray","border-width":"1px",shape:"roundrectangle"}},{selector:".bold-text",css:{"font-weight":"bold"}},{selector:".italic-text",css:{"font-style":"italic"}},{selector:".arial-text",css:{"font-family":"Arial"}},{selector:".comic-text",css:{"font-family":"Comic Sans MS"}},{selector:".verdana-text",css:{"font-family":"Verdana"}},{selector:"edge",style:{width:3}}]}),cy.on("tap","node",(function(){return 2==v?(deleteNode(this),pushState(),void(_==this&&(_=null))):1==v?(null!=_&&_!=this&&(createEdge(_,this),pushState()),void(_=this)):(isSelectedNode(this)?(unselectNode(this),hideSubToolbar()):(selectNode(this),showSubToolbar(this),x.value==j?x.setSelectionRange(0,x.value.length):x.setSelectionRange(x.value.length,x.value.length)),void(_=this))})),cy.on("unselect","node",(function(){unselectNode(this)})),cy.on("select","edge",(function(){if(2==v)return deleteEdge(this),void pushState();hideSubToolbar()})),cy.on("tap",(function(e){if(e.cyTarget===cy&&0==v){var t=createNode(j,e.cyPosition);null!=_&&(createEdge(_,t),unselectNode(_)),pushState(),t.select(),selectNode(t),_=t,showSubToolbar(t)}})),cy.on("free","node",(function(e){pushState()}));var F=0,A=0,M="Arial",_=null,j="<Your new idea>",createNode=function(e,t){var n=computeStringSize(e,M,16,!1,!1);cy.add({group:"nodes",nodes:[{data:{id:"n"+ ++F,"font-family":M,"font-size":16,"font-weight":"normal",content:e,color:"rgb(0, 0, 0)","background-color":"rgb(255, 255, 255)"},position:{x:t.x,y:t.y}}]});var o=cy.getElementById("n"+F);return o.style({content:e,width:n.width,height:n.height,color:"rgb(0, 0, 0)","font-family":"Arial","font-size":"16px","background-color":"rgb(255, 255, 255)"}),o.addClass("standard-node"),o},updateNodeText=function(e,t){void 0===t?t=e.style().content:e.data("content",t);var n=e.data("font-size"),o=e.data("font-family"),a=computeStringSize(t,o,n,e.hasClass("bold-text"),e.hasClass("italic-text"));e.style({content:t,"font-size":n+"px","font-family":o,width:a.width,height:a.height})},isSelectedNode=function(e){return"dashed"==e.style()["border-style"]},selectNode=function(e){e.style({"border-color":"black","border-style":"dashed","border-width":"4px"})},unselectNode=function(e){e.style({"border-color":"darkgray","border-style":"solid","border-width":"1px"})},unselectAllNode=function(){for(var e=cy.collection("node"),t=0;t<e.length;t++)unselectNode(e[t])},deleteNode=function(e){cy.remove(e)},createEdge=function(e,t){cy.add({group:"nodes",edges:[{data:{id:"e"+ ++A,source:e.id(),target:t.id()}}]})},deleteEdge=function(e){cy.remove(e)},computeStringSize=function(e,t,n,o,a){var l=document.getElementById("fontsizecomputer");return l.innerHTML=e.replace("<","&lt;").replace(">","&gt;"),l.style.fontFamily=t,l.style.fontSize=n+"px",l.style.fontWeight=o?"bold":"normal",l.style.fontStyle=a?"italic":"normal",{width:l.clientWidth+n+"px",height:l.clientHeight+n+"px"}},getCenter=function(){var e=document.getElementById("canvas");return{x:e.clientWidth/2,y:e.clientHeight/2}},loadGraph=function(){e.getDatastoreObject().loadAsText((function(e,t,n){null!=n&&(displayGraph(JSON.parse(n)),reinitState(),pushState())}))},saveGraph=function(t){var n=e.getDatastoreObject(),o=getGraph();n.setDataAsText(JSON.stringify(o)),n.save(t)},deepCopy=function(e){var t,n=e;if(e&&"object"==typeof e)for(t in n="[object Array]"===Object.prototype.toString.call(e)?[]:{},e)n[t]=deepCopy(e[t]);return n},getGraph=function(){return deepCopy(cy.json())},displayGraph=function(e){cy.remove("node"),cy.remove("edge"),hideSubToolbar(),_=null,cy.add({group:"nodes",nodes:e.elements.nodes});for(var t=cy.collection("node"),n=0,o=0;o<t.length;o++){var a=t[o];updateNodeText(a,a.data("content")),a.style("color",a.data("color")),a.style("background-color",a.data("background-color")),(i=a.data("id").substr(1))>n&&(n=i)}if(F=n+1,n=0,e.elements.edges){cy.add({group:"edges",edges:e.elements.edges});var l=cy.collection("edge");for(o=0;o<l.length;o++){var i;(i=l[o].data("id").substr(1))>n&&(n=i)}}A=n+1},U=[],O=0,N=document.getElementById("undo-button");N.addEventListener("click",(function(){undoState()}),!0);var V=document.getElementById("redo-button");V.addEventListener("click",(function(){redoState()}),!0);var reinitState=function(){U=[],O=0},pushState=function(e){if(O<U.length-1){for(var t=[],n=0;n<O+1;n++)t.push(U[n]);U=t}var o=U.length-1,a=getGraph();if(o<30)U.push(a);else{for(n=0;n<o-1;n++)U[n]=U[n+1];U[o-1]=a}O=U.length-1,u&&!e&&sendMessage({action:"updateBoard",data:getGraph()}),updateStateButtons()},undoState=function(e){U.length<1||U.length>=1&&0==O||(displayGraph(U[--O]),u&&!e&&sendMessage({action:"undoBoard"}),updateStateButtons())},redoState=function(e){O+1>=U.length||(displayGraph(U[++O]),u&&!e&&sendMessage({action:"redoBoard"}),updateStateButtons())},updateStateButtons=function(){var e=U.length;N.disabled=U.length<1||U.length>=1&&0==O,V.disabled=O+1>=e},generateXOLogoWithColor=function(e){var t='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>';return t=(t=t.replace("#010101",e.stroke)).replace("#FFFFFF",e.fill),"data:image/svg+xml;base64,"+btoa(t)},displayConnectedPeople=function(e){var t=document.getElementById("presence-users");e&&t&&f.listSharedActivityUsers(f.getSharedInfo().id,(function(e){m={};for(var t=0;t<e.length;t++){var n=e[t];m[n.networkId]=n}!function(){var e=document.getElementById("presence-users"),t="<hr><ul style='list-style: none; padding:0;'>";for(var n in m)t+="<li><img style='height:30px;' src='"+generateXOLogoWithColor(m[n].colorvalue)+"'>"+m[n].name+"</li>";t+="</ul>",e.innerHTML=t}()}))},Y=document.getElementById("network-button"),H=new l.PresencePalette(Y,void 0);Y.addEventListener("click",(function(e){hideSubToolbar()}));var shareActivity=function(){f=e.getPresenceObject((function(e,t){e?console.log("error"):(u=!0,userSettings=t.getUserInfo(),console.log("connected"),window.top.sugar.environment.sharedId||(g=!0,t.createSharedActivity("org.olpc-france.labyrinthjs",(function(e){}))),t.onConnectionClosed((function(e){console.log(e),console.log("Connection closed")})),t.onSharedActivityUserChanged((function(e){onNetworkUserChanged(e)})),t.onDataReceived(onNetworkDataReceived))}))},sendMessage=function(e){try{f.sendMessage(f.getSharedInfo().id,{user:f.getUserInfo(),content:e})}catch(e){}},onNetworkDataReceived=function(e){if(f.getUserInfo().networkId!==e.user.networkId)switch(e.content.action){case"initialBoard":displayGraph(e.content.data);break;case"updateBoard":displayGraph(e.content.data),pushState(!0);break;case"undoBoard":undoState(!0);break;case"redoBoard":redoState(!0)}},onNetworkUserChanged=function(e){var n=e.user.name.replace("<","&lt;").replace(">","&gt;"),o="<img style='height:30px;' src='"+generateXOLogoWithColor(e.user.colorvalue)+"'>";1===e.move?(i.log(o+t.get("PlayerJoin",{user:n})),g&&sendMessage({action:"initialBoard",data:getGraph()})):-1===e.move&&i.log(o+t.get("PlayerLeave",{user:n})),f.listSharedActivities((function(e){for(var t=0;t<e.length;t++)e[t].id===f.getSharedInfo().id&&displayConnectedPeople(e[t].users)}))};H.addEventListener("shared",(function(){H.popDown(),shareActivity()})),window.top&&window.top.sugar&&window.top.sugar.environment&&window.top.sugar.environment.sharedId&&(console.log("ehy00"),shareActivity(),H.setShared(!0))}))}));