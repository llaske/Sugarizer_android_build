define(["sugar-web/activity/activity","l10n","sugar-web/datastore","sugar-web/graphics/colorpalette","zoompalette","sugar-web/graphics/presencepalette","humane","fontpalette","tutorial","sugar-web/env"],(function(t,e,n,o,l,a,i,c,r,d){var s=!1,u=!1,g=null,f={};requirejs(["domReady!"],(function(m){t.setup();var v=0,y=document.getElementById("nodetext-button"),h=document.getElementById("link-button"),p=document.getElementById("delete-button"),switchMode=function(t){v=t,y.classList.remove("active"),h.classList.remove("active"),p.classList.remove("active"),0==t?y.classList.add("active"):1==t?h.classList.add("active"):2==t&&p.classList.add("active"),hideSubToolbar(),null!=j&&(unselectAllNode(),j=null)};y.addEventListener("click",(function(){switchMode(0)}),!0),h.addEventListener("click",(function(){switchMode(1),j=null}),!0),p.addEventListener("click",(function(){switchMode(2)}),!0);var b=document.getElementById("zoom-button");zoomPalette=new l.zoomPalette(b),zoomPalette.addEventListener("pop",(function(t){hideSubToolbar()})),zoomPalette.addEventListener("zoom",(function(t){var e=t.detail.zoom,n=cy.zoom(),o=.25;0==e?n!=cy.minZoom()&&n-o>cy.minZoom()&&cy.zoom(n-o):1==e?n!=cy.maxZoom()&&cy.zoom(n+o):2==e?cy.fit():3==e&&cy.center()}));var E=document.getElementById("png-button");E.addEventListener("click",(function(t){var o=cy.png(),l=o.split(";")[0].split(":")[1],a=l.split("/")[0],c={mimetype:l,title:a.charAt(0).toUpperCase()+a.slice(1)+" LabyrinthJS",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};n.create(c,(function(){i.log(e.get("LabyrinthImage")),console.log("export done.")}),o)}));var w=document.getElementById("sub-toolbar"),x=document.getElementById("textvalue"),k=document.getElementById("erasetext-button"),B=document.getElementById("bold-button"),I=document.getElementById("italics-button"),L=document.getElementById("foreground-button");foregroundPalette=new o.ColorPalette(L),foregroundPalette.setColor("rgb(0, 0, 0)");var C=!1,P=document.getElementById("background-button");backgroundPalette=new o.ColorPalette(P),backgroundPalette.setColor("rgb(255, 255, 255)");var T=!1,z=document.getElementById("fontminus-button"),S=document.getElementById("fontplus-button"),D=document.getElementById("font-button");fontPalette=new c.TextPalette(D),document.getElementById("help-button").addEventListener("click",(function(t){if(r.setElement("activity",document.getElementById("activity-button")),r.setElement("stop",document.getElementById("stop-button")),r.setElement("undo",document.getElementById("undo-button")),r.setElement("redo",document.getElementById("redo-button")),r.setElement("node",y),r.setElement("link",h),r.setElement("remove",p),r.setElement("png",E),r.setElement("zoom",b),r.setElement("textvalue",x),r.setElement("bold",B),r.setElement("italic",I),r.setElement("foreground",L),r.setElement("background",P),r.setElement("font",D),r.setElement("fontminus",z),r.setElement("fontplus",S),r.setElement("board",document.getElementById("canvas")),cy){var e=j;if(!e){var n=cy.elements("node");n.length>0&&(e=n[0],j=e,selectNode(e))}e&&showSubToolbar(e)}r.start()})),foregroundPalette.addEventListener("colorChange",(function(t){C||(j.style("color",t.detail.color),j.data("color",t.detail.color),pushState()),C=!1})),backgroundPalette.addEventListener("colorChange",(function(t){T||(j.style("background-color",t.detail.color),j.data("background-color",t.detail.color),pushState()),T=!1})),fontPalette.addEventListener("fontChange",(function(t){var e=t.detail.family;j.data("font-family",e),j.removeClass("arial-text comic-text verdana-text"),updateNodeText(j),"Arial"==e?j.addClass("arial-text"):"Comic Sans MS"==e?j.addClass("comic-text"):"Verdana"==e&&j.addClass("verdana-text"),pushState()})),x.addEventListener("input",(function(){x.value.length>0?$("#erasetext-button").show():$("#erasetext-button").hide(),updateNodeText(j,x.value),pushState()})),k.addEventListener("click",(function(){x.value="",x.focus(),updateNodeText(j,x.value),$("#erasetext-button").hide(),pushState()})),B.addEventListener("click",(function(){j.toggleClass("bold-text"),j.hasClass("bold-text")?B.classList.add("active"):B.classList.remove("active"),updateNodeText(j),pushState()})),I.addEventListener("click",(function(){j.toggleClass("italic-text"),j.hasClass("italic-text")?I.classList.add("active"):I.classList.remove("active"),updateNodeText(j),pushState()})),z.addEventListener("click",(function(){j.data("font-size",Math.max(6,j.data("font-size")-2)),updateNodeText(j),pushState()})),S.addEventListener("click",(function(){j.data("font-size",Math.min(100,j.data("font-size")+2)),updateNodeText(j),pushState()}));var showSubToolbar=function(t){zoomPalette.popDown(),w.style.visibility="visible",x.value=t.style().content,t.hasClass("bold-text")?B.classList.add("active"):B.classList.remove("active"),t.hasClass("italic-text")?I.classList.add("active"):I.classList.remove("active"),C=!0,foregroundPalette.setColor(t.style().color),T=!0,backgroundPalette.setColor(t.style()["background-color"]),fontPalette.setFont(t.data("font-family"))},hideSubToolbar=function(){w.style.visibility="hidden",backgroundPalette.popDown(),foregroundPalette.popDown(),fontPalette.popDown()};document.getElementById("stop-button").addEventListener("click",(function(t){console.log("writing..."),saveGraph((function(t){null===t?console.log("write done."):console.log("write failed.")}))})),d.getEnvironment((function(t,n){var o="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,l=n.user?n.user.language:o;e.language.code!=l&&e.init(l)})),window.addEventListener("localized",(function(){var t=M;if(M=e.get("YourNewIdea"),y.title=e.get("nodetextTitle"),h.title=e.get("linkButtonTitle"),p.title=e.get("removeButtonTitle"),N.title=e.get("undoButtonTitle"),V.title=e.get("redoButtonTitle"),b.title=e.get("zoomButtonTitle"),L.title=e.get("foregroundButtonTitle"),P.title=e.get("backgroundButtonTitle"),x.placeholder=e.get("typeText"),B.title=e.get("boldButtonTitle"),I.title=e.get("italicButtonTitle"),z.title=e.get("fontMinusButtonTitle"),S.title=e.get("fontPlusButtonTitle"),D.title=e.get("fontButtonTitle"),E.title=e.get("pngButtonTitle"),cy)for(var n=cy.elements("node"),o=0;o<n.length;o++){var l=n[o];l.data("content")==t&&(l.data("content",M),l.style({content:M}))}})),cy=cytoscape({container:document.getElementById("cy"),ready:function(){var t=createNode(M,getCenter());t.select(),selectNode(t),j=t,showSubToolbar(t),pushState(),loadGraph()},style:[{selector:".standard-node",css:{"text-valign":"center","text-halign":"center","border-color":"darkgray","border-width":"1px",shape:"roundrectangle"}},{selector:".bold-text",css:{"font-weight":"bold"}},{selector:".italic-text",css:{"font-style":"italic"}},{selector:".arial-text",css:{"font-family":"Arial"}},{selector:".comic-text",css:{"font-family":"Comic Sans MS"}},{selector:".verdana-text",css:{"font-family":"Verdana"}},{selector:"edge",style:{width:3}}]}),cy.on("tap","node",(function(){return 2==v?(deleteNode(this),pushState(),void(j==this&&(j=null))):1==v?(null!=j&&j!=this&&(createEdge(j,this),pushState()),void(j=this)):(isSelectedNode(this)?(unselectNode(this),hideSubToolbar()):(selectNode(this),showSubToolbar(this),x.value==M?x.setSelectionRange(0,x.value.length):x.setSelectionRange(x.value.length,x.value.length)),void(j=this))})),cy.on("unselect","node",(function(){unselectNode(this)})),cy.on("select","edge",(function(){if(2==v)return deleteEdge(this),void pushState();hideSubToolbar()})),cy.on("tap",(function(t){if(t.cyTarget===cy&&0==v){var e=createNode(M,t.cyPosition);null!=j&&(createEdge(j,e),unselectNode(j)),pushState(),e.select(),selectNode(e),j=e,showSubToolbar(e)}})),cy.on("free","node",(function(t){pushState()}));var F=0,A=0,_="Arial",j=null,M="<Your new idea>",createNode=function(t,e){var n=computeStringSize(t,_,16,!1,!1);cy.add({group:"nodes",nodes:[{data:{id:"n"+ ++F,"font-family":_,"font-size":16,"font-weight":"normal",content:t,color:"rgb(0, 0, 0)","background-color":"rgb(255, 255, 255)"},position:{x:e.x,y:e.y}}]});var o=cy.getElementById("n"+F);return o.style({content:t,width:n.width,height:n.height,color:"rgb(0, 0, 0)","font-family":"Arial","font-size":"16px","background-color":"rgb(255, 255, 255)"}),o.addClass("standard-node"),o},updateNodeText=function(t,e){void 0===e?e=t.style().content:t.data("content",e);var n=t.data("font-size"),o=t.data("font-family"),l=computeStringSize(e,o,n,t.hasClass("bold-text"),t.hasClass("italic-text"));t.style({content:e,"font-size":n+"px","font-family":o,width:l.width,height:l.height})},isSelectedNode=function(t){return"dashed"==t.style()["border-style"]},selectNode=function(t){t.style({"border-color":"black","border-style":"dashed","border-width":"4px"})},unselectNode=function(t){t.style({"border-color":"darkgray","border-style":"solid","border-width":"1px"})},unselectAllNode=function(){for(var t=cy.collection("node"),e=0;e<t.length;e++)unselectNode(t[e])},deleteNode=function(t){cy.remove(t)},createEdge=function(t,e){cy.add({group:"nodes",edges:[{data:{id:"e"+ ++A,source:t.id(),target:e.id()}}]})},deleteEdge=function(t){cy.remove(t)},computeStringSize=function(t,e,n,o,l){var a=document.getElementById("fontsizecomputer");return a.innerText=t,a.style.fontFamily=e,a.style.fontSize=n+"px",a.style.fontWeight=o?"bold":"normal",a.style.fontStyle=l?"italic":"normal",{width:a.clientWidth+n+"px",height:a.clientHeight+n+"px"}},getCenter=function(){var t=document.getElementById("canvas");return{x:t.clientWidth/2,y:t.clientHeight/2}},loadGraph=function(){t.getDatastoreObject().loadAsText((function(t,e,n){null!=n&&(displayGraph(JSON.parse(n)),reinitState(),pushState())}))},saveGraph=function(e){var n=t.getDatastoreObject(),o=getGraph();n.setDataAsText(JSON.stringify(o)),n.save(e)},deepCopy=function(t){var e,n=t;if(t&&"object"==typeof t)for(e in n="[object Array]"===Object.prototype.toString.call(t)?[]:{},t)n[e]=deepCopy(t[e]);return n},getGraph=function(){return deepCopy(cy.json())},displayGraph=function(t){cy.remove("node"),cy.remove("edge"),hideSubToolbar(),j=null,cy.add({group:"nodes",nodes:t.elements.nodes});for(var e=cy.collection("node"),n=0,o=0;o<e.length;o++){var l=e[o];updateNodeText(l,l.data("content")),l.style("color",l.data("color")),l.style("background-color",l.data("background-color")),(i=l.data("id").substr(1))>n&&(n=i)}if(F=n+1,n=0,t.elements.edges){cy.add({group:"edges",edges:t.elements.edges});var a=cy.collection("edge");for(o=0;o<a.length;o++){var i;(i=a[o].data("id").substr(1))>n&&(n=i)}}A=n+1},U=[],O=0,N=document.getElementById("undo-button");N.addEventListener("click",(function(){undoState()}),!0);var V=document.getElementById("redo-button");V.addEventListener("click",(function(){redoState()}),!0);var reinitState=function(){U=[],O=0},pushState=function(t){if(O<U.length-1){for(var e=[],n=0;n<O+1;n++)e.push(U[n]);U=e}var o=U.length-1,l=getGraph();if(o<30)U.push(l);else{for(n=0;n<o-1;n++)U[n]=U[n+1];U[o-1]=l}O=U.length-1,s&&!t&&sendMessage({action:"updateBoard",data:getGraph()}),updateStateButtons()},undoState=function(t){U.length<1||U.length>=1&&0==O||(displayGraph(U[--O]),s&&!t&&sendMessage({action:"undoBoard"}),updateStateButtons())},redoState=function(t){O+1>=U.length||(displayGraph(U[++O]),s&&!t&&sendMessage({action:"redoBoard"}),updateStateButtons())},updateStateButtons=function(){var t=U.length;N.disabled=U.length<1||U.length>=1&&0==O,V.disabled=O+1>=t},generateXOLogoWithColor=function(t){var e='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>';return e=(e=e.replace("#010101",t.stroke)).replace("#FFFFFF",t.fill),"data:image/svg+xml;base64,"+btoa(e)},displayConnectedPeople=function(t){var e=document.getElementById("presence-users");t&&e&&g.listSharedActivityUsers(g.getSharedInfo().id,(function(t){f={};for(var e=0;e<t.length;e++){var n=t[e];f[n.networkId]=n}!function(){var t=document.getElementById("presence-users"),e="<hr><ul style='list-style: none; padding:0;'>";for(var n in f)e+="<li><img style='height:30px;' src='"+generateXOLogoWithColor(f[n].colorvalue)+"'>"+f[n].name+"</li>";e+="</ul>",t.innerHTML=e}()}))},Y=document.getElementById("network-button"),J=new a.PresencePalette(Y,void 0);Y.addEventListener("click",(function(t){hideSubToolbar()}));var shareActivity=function(){g=t.getPresenceObject((function(t,e){t?console.log("error"):(s=!0,userSettings=e.getUserInfo(),console.log("connected"),window.top.sugar.environment.sharedId||(u=!0,e.createSharedActivity("org.olpc-france.labyrinthjs",(function(t){}))),e.onConnectionClosed((function(t){console.log(t),console.log("Connection closed")})),e.onSharedActivityUserChanged((function(t){onNetworkUserChanged(t)})),e.onDataReceived(onNetworkDataReceived))}))},sendMessage=function(t){try{g.sendMessage(g.getSharedInfo().id,{user:g.getUserInfo(),content:t})}catch(t){}},onNetworkDataReceived=function(t){if(g.getUserInfo().networkId!==t.user.networkId)switch(t.content.action){case"initialBoard":displayGraph(t.content.data);break;case"updateBoard":displayGraph(t.content.data),pushState(!0);break;case"undoBoard":undoState(!0);break;case"redoBoard":redoState(!0)}},onNetworkUserChanged=function(t){var n=t.user.name.replace("<","&lt;").replace(">","&gt;"),o="<img style='height:30px;' src='"+generateXOLogoWithColor(t.user.colorvalue)+"'>";1===t.move?(i.log(o+e.get("PlayerJoin",{user:n})),u&&sendMessage({action:"initialBoard",data:getGraph()})):-1===t.move&&i.log(o+e.get("PlayerLeave",{user:n})),g.listSharedActivities((function(t){for(var e=0;e<t.length;e++)t[e].id===g.getSharedInfo().id&&displayConnectedPeople(t[e].users)}))};J.addEventListener("shared",(function(){J.popDown(),shareActivity()})),window.top&&window.top.sugar&&window.top.sugar.environment&&window.top.sugar.environment.sharedId&&(console.log("ehy00"),shareActivity(),J.setShared(!0))}))}));