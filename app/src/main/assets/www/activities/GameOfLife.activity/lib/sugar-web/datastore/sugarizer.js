define(["sugar-web/bus","sugar-web/env"],(function(e,t){"use strict";var n={},a={},o={},l="sugar_datastore_",r="sugar_filestore",i=!1,u=0,d=null;function removePending(){0==--u&&d&&(d(),d=null)}function DatastoreObject(e){this.objectId=e,this.newMetadata={},this.newDataAsText=null,this.toload=!1,i||t.getEnvironment((function(){i=!0}));if(void 0===this.objectId){var n=window.top.sugar.environment.objectId;null!=n&&(this.objectId=n,this.toload=!0)}}function indexedDB_setValue(e,t,n){var a=o.db.transaction([r],"readwrite").objectStore(r).put({objectId:e,text:t});a.onerror=function(e){n&&n(a.errorCode)},a.onsuccess=function(e){n&&n(null)}}function indexedDB_getValue(e,t){var n=o.db.transaction([r],"readonly").objectStore(r).get(e);n.onerror=function(e){t&&t(n.errorCode,null)},n.onsuccess=function(e){t&&t(null,n.result?n.result.text:null)}}function indexedDB_getAll(e){var t=o.db.transaction([r],"readonly").objectStore(r).openCursor(),n=[];t.onerror=function(n){e&&e(t.errorCode,null)},t.onsuccess=function(t){var a=t.target.result;a?(n.push(a.key),a.continue()):e&&e(null,n)}}function indexedDB_removeValue(e,t){var n=o.db.transaction([r],"readwrite").objectStore(r).delete(e);n.onerror=function(e){t&&t(n.errorCode)},n.onsuccess=function(e){t&&t(null)}}return n.getUrlParameter=function(e){var t=RegExp("[?&]"+e+"=([^&]*)").exec(window.location.search);return t&&decodeURIComponent(t[1].replace(/\+/g," "))},n.createUUID=function(){for(var e=[],t="0123456789abcdef",n=0;n<36;n++)e[n]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")},n.callbackChecker=function(e){return null==e&&(e=function(){}),e},n.create=function(e,t,r){var i=n.callbackChecker(t),u=n.createUUID();void 0!==r&&(e.textsize=r.length);var d=a.getValue("sugar_settings");d&&(e.buddy_name=d.name,e.buddy_color=d.colorvalue),a.setValue(l+u,{metadata:e,text:void 0===r?null:{link:u}})?void 0!==r?o.setValue(u,r,(function(e){e?i(-1,null):i(null,u)})):i(null,u):i(-1,null)},n.find=function(e){var t=[];if(!a.test())return t;for(var n in a.getAll())if(n.substr(0,l.length)==l){var o=a.getValue(n);o.objectId=n.substr(l.length),void 0!==e&&o.metadata.activity!=e||t.push(o)}return t},n.remove=function(e,t){a.removeValue(l+e),o.removeValue(e,t)},n.waitPendingSave=function(e){!function waitPending(e){setTimeout((function(){0==u?e&&e():d=e}),50)}(e)},DatastoreObject.prototype.getMetadata=function(e){var t=n.callbackChecker(e),o=a.getValue(l+this.objectId);null!=o&&(this.setMetadata(o.metadata),this.toload=!1,t(null,o.metadata))},DatastoreObject.prototype.loadAsText=function(e){var t=n.callbackChecker(e),r=this,i=a.getValue(l+r.objectId);if(null!=i){r.setMetadata(i.metadata);i.text?o.getValue(r.objectId,(function(e,n){e?t(-1,null,null):(r.setDataAsText(n),r.toload=!1,t(null,i.metadata,n))})):(r.toload=!1,t(null,i.metadata,null))}},DatastoreObject.prototype.setMetadata=function(e){for(var t in e)this.newMetadata[t]=e[t]},DatastoreObject.prototype.setDataAsText=function(e){this.newDataAsText=e},DatastoreObject.prototype.save=function(e,t){if(function addPending(){u++}(),void 0===this.objectId){var r=this;this.newMetadata.timestamp=this.newMetadata.creation_time=(new Date).getTime(),this.newMetadata.file_size=0,n.create(this.newMetadata,(function(e,t){null==e&&(r.objectId=t)}))}else this.toload&&(this.getMetadata(null),this.toload=!1);var i=n.callbackChecker(e);t||(this.newMetadata.timestamp=(new Date).getTime());var d=a.getValue("sugar_settings");d&&!t&&(this.newMetadata.buddy_name=d.name,this.newMetadata.buddy_color=d.colorvalue),null!=this.newDataAsText&&(t||(this.newMetadata.textsize=this.newDataAsText.length));r=this;a.setValue(l+this.objectId,{metadata:this.newMetadata,text:void 0===this.newDataAsText?null:{link:this.objectId}})?null!=this.newDataAsText?o.setValue(r.objectId,this.newDataAsText,(function(e){e?i(-1,null,null):i(null,r.newMetadata,r.newDataAsText),removePending()})):(i(null,this.newMetadata,this.newDataAsText),removePending()):(i(-1,null),removePending())},n.DatastoreObject=DatastoreObject,n.localStorage=a,n.indexedDB=o,a.load=function(e){e&&e()},a.load(),a.test=function(){return"undefined"!=typeof Storage&&void 0!==window.localStorage},a.setValue=function(e,t){if(this.test())try{return window.localStorage.setItem(e,JSON.stringify(t)),!0}catch(e){return console.log("ERROR: Unable to update local storage"),!1}},a.getValue=function(e){if(this.test())try{return JSON.parse(window.localStorage.getItem(e))}catch(e){return null}return null},a.removeValue=function(e){if(this.test())try{window.localStorage.removeItem(e)}catch(e){}},a.getAll=function(){if(this.test())try{return window.localStorage}catch(e){return null}return null},o.db=null,o.test=function(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB},o.load=function(e){if(null==o.db)if(o.test()){var t=window.indexedDB.open(r,1);t.onerror=function(t){e&&e(-2)},t.onsuccess=function(n){o.db=t.result,e&&e(null)},t.onupgradeneeded=function(e){e.target.result.createObjectStore(r,{keyPath:"objectId"}).createIndex("objectId","objectId",{unique:!0})}}else e&&e(-1);else e(null)},o.setValue=function(e,t,n){null==o.db?o.load((function(a){a?console.log("FATAL ERROR: indexedDB not supported, could be related to use of private mode"):indexedDB_setValue(e,t,n)})):indexedDB_setValue(e,t,n)},o.getValue=function(e,t){null==o.db?o.load((function(n){n?console.log("FATAL ERROR: indexedDB not supported, could be related to use of private mode"):indexedDB_getValue(e,t)})):indexedDB_getValue(e,t)},o.getAll=function(e){null==o.db?o.load((function(t){t?console.log("FATAL ERROR: indexedDB not supported, could be related to use of private mode"):indexedDB_getAll(e)})):indexedDB_getAll(e)},o.removeValue=function(e,t){null==o.db?o.load((function(n){n?console.log("FATAL ERROR: indexedDB not supported, could be related to use of private mode"):indexedDB_removeValue(e,t)})):indexedDB_removeValue(e,t)},n}));