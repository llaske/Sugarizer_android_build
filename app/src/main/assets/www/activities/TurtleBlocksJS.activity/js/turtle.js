const DEFAULTCOLOR=0,DEFAULTVALUE=50,DEFAULTCHROMA=100,DEFAULTSTROKE=5,DEFAULTFONT="sans-serif",TURTLEBASEPATH="images/";function Turtle(t,s,e){this.name=t,this.turtles=s,this.drum=e,e&&console.log("turtle "+t+" is a drum."),this.running=!1,this.trash=!1,this.container=null,this.x=0,this.y=0,this.bitmap=null,this.skinChanged=!1,this.blinkFinished=!0,this.beforeBlinkSize=null,this.startBlock=null,this.decorationBitmap=null,this.queue=[],this.listeners={},this.penstrokes=null,this.imageContainer=null,this.svgOutput="",this.svgPath=!1,this.color=0,this.value=50,this.chroma=100,this.stroke=5,this.canvasColor="rgba(255,0,49,1)",this.canvasAlpha=1,this.orientation=0,this.fillState=!1,this.hollowState=!1,this.penState=!0,this.font=DEFAULTFONT,this.media=[];var i=document.getElementById("overlayCanvas"),a=i.getContext("2d");this._svgArc=function(t,s,e,i,a,r){var h=a;if(null==r)var n=Math.PI/t;else n=(r-a)/t;for(var l=0;l<t;l++){var o=s+i*Math.cos(h),c=e+i*Math.sin(h);this.svgOutput+=o+","+c+" ",h+=n}},this.doBezier=function(t,s,e,i,r,h){if(this.penState&&this.hollowState){var n=r,l=h,o=this.turtles.turtleX2screenX(this.x),c=this.turtles.turtleY2screenY(this.y),u=this.turtles.turtleX2screenX(r),v=this.turtles.turtleY2screenY(h),d=this.turtles.turtleX2screenX(t),p=this.turtles.turtleY2screenY(s),m=this.turtles.turtleX2screenX(e),g=this.turtles.turtleY2screenY(i);this.closeSVG();var f=this.stroke;if(this.stroke=1,a.lineWidth=this.stroke,a.lineCap="round",f<3)var C=.5;else C=(f-2)/2;steps=Math.max(Math.floor(f,1));var b=Math.atan2(t-this.x,s-this.y);(b=180*b/Math.PI)<0&&(b+=360);var k=Math.atan2(n-e,l-i);(k=180*k/Math.PI)<0&&(k+=360);var S=(b-90)*Math.PI/180,x=C*Math.sin(S),y=-C*Math.cos(S),M=(k-90)*Math.PI/180,X=C*Math.sin(M),B=-C*Math.cos(M),Y=o-x,P=c-y,w=Y*this.turtles.scale,T=P*this.turtles.scale,A=v-B,_=(this.turtles.scale,this.turtles.scale,u+X),O=v+B,I=_*this.turtles.scale,F=O*this.turtles.scale,L=c+y,N=(this.turtles.scale,this.turtles.scale,(d+x)*this.turtles.scale),V=(p+y)*this.turtles.scale,E=(m+X)*this.turtles.scale,R=(g+B)*this.turtles.scale;a.moveTo(Y,P),this.svgPath=!0,this.svgOutput+='<path d="M '+w+","+T+" ";var z=o,G=c,j=(W=(180+b)/180*Math.PI)-Math.PI,U=W;a.arc(z,G,C,j,U,!1),this._svgArc(steps,z*this.turtles.scale,G*this.turtles.scale,C*this.turtles.scale,j,U),a.bezierCurveTo(d+x,p+y,m+X,g+B,_,O),this.svgOutput+="C "+N+","+V+" "+E+","+R+" "+I+","+F+" ",this.svgOutput+="M "+I+","+F+" ";var W;z=u,G=v,j=(W=k/180*Math.PI)-Math.PI,U=W;a.arc(z,G,C,j,U,!1),this._svgArc(steps,z*this.turtles.scale,G*this.turtles.scale,C*this.turtles.scale,j,U),a.bezierCurveTo(m-X,g-B,d-x,p-y,Y,P),this.svgOutput+="C "+E+","+R+" "+N+","+V+" "+w+","+T+" ",this.closeSVG(),a.stroke(),a.closePath(),this.stroke=f,a.lineWidth=this.stroke,a.lineCap="round",a.moveTo(u,v),this.x=r,this.y=h}else if(this.penState){"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var D=this.canvasColor.substr(0,this.canvasColor.length-2);a.strokeStyle=D+this.canvasAlpha+")",a.fillStyle=D+this.canvasAlpha+")",a.lineWidth=this.stroke,a.lineCap="round",a.beginPath(),a.moveTo(this.container.x,this.container.y);u=this.turtles.turtleX2screenX(r),v=this.turtles.turtleY2screenY(h),d=this.turtles.turtleX2screenX(t),p=this.turtles.turtleY2screenY(s),m=this.turtles.turtleX2screenX(e),g=this.turtles.turtleY2screenY(i);if(a.bezierCurveTo(d,p,m,g,u,v),!this.svgPath){this.svgPath=!0;o=this.turtles.turtleX2screenX(this.x),c=this.turtles.turtleY2screenY(this.y);var H=o*this.turtles.scale,K=c*this.turtles.scale;this.svgOutput+='<path d="M '+H+","+K+" "}N=d*this.turtles.scale,V=p*this.turtles.scale,E=m*this.turtles.scale,R=g*this.turtles.scale;var q=u*this.turtles.scale,Q=v*this.turtles.scale;this.svgOutput+="C "+N+","+V+" "+E+","+R+" "+q+","+Q,this.x=r,this.y=h,a.stroke(),this.fillState||a.closePath()}else{this.x=r,this.y=h;u=this.turtles.turtleX2screenX(r),v=this.turtles.turtleY2screenY(h)}this.container.x=u,this.container.y=v;var J=Math.atan2(n-e,l-i);J=180*J/Math.PI,this.doSetHeading(J)},this.move=function(t,s,e,r,h){if(h?(t=this.turtles.turtleX2screenX(t),s=this.turtles.turtleY2screenY(s),nx=this.turtles.turtleX2screenX(e),ny=this.turtles.turtleY2screenY(r)):(nx=e,ny=r),this.penState&&this.hollowState){this.closeSVG(),this.svgPath=!0;var n=this.stroke;if(this.stroke=1,a.lineWidth=this.stroke,a.lineCap="round",n<3)var l=.5;else l=(n-2)/2;var o=(this.orientation-90)*Math.PI/180,c=l*Math.sin(o),u=-l*Math.cos(o);a.moveTo(t+c,s+u);var v=(t+c)*this.turtles.scale,d=(s+u)*this.turtles.scale;this.svgOutput+='<path d="M '+v+","+d+" ",a.lineTo(nx+c,ny+u);var p=(nx+c)*this.turtles.scale,m=(ny+u)*this.turtles.scale;this.svgOutput+=p+","+m+" ";o=(this.orientation+90)*Math.PI/180,c=l*Math.sin(o),u=-l*Math.cos(o);var g=this.orientation/180*Math.PI,f=nx,C=ny,b=g-Math.PI,k=g;a.arc(f,C,l,b,k,!1);p=(nx+c)*this.turtles.scale,m=(ny+u)*this.turtles.scale;var S=l*this.turtles.scale;steps=Math.max(Math.floor(n,1)),this._svgArc(steps,f*this.turtles.scale,C*this.turtles.scale,S,b),this.svgOutput+=p+","+m+" ",a.lineTo(t+c,s+u);p=(t+c)*this.turtles.scale,m=(s+u)*this.turtles.scale;this.svgOutput+=p+","+m+" ";o=(this.orientation-90)*Math.PI/180,c=l*Math.sin(o),u=-l*Math.cos(o),f=t,C=s,b=(g=(this.orientation+180)/180*Math.PI)-Math.PI,k=g;a.arc(f,C,l,b,k,!1);p=(t+c)*this.turtles.scale,m=(s+u)*this.turtles.scale,S=l*this.turtles.scale;this._svgArc(steps,f*this.turtles.scale,C*this.turtles.scale,S,b),this.svgOutput+=p+","+m+" ",this.closeSVG(),a.stroke(),a.closePath(),this.stroke=n,a.lineWidth=this.stroke,a.lineCap="round",a.moveTo(nx,ny)}else if(this.penState){if(a.lineTo(nx,ny),!this.svgPath){this.svgPath=!0;v=t*this.turtles.scale,d=s*this.turtles.scale;this.svgOutput+='<path d="M '+v+","+d+" "}p=nx*this.turtles.scale,m=ny*this.turtles.scale;this.svgOutput+=p+","+m+" ",a.stroke(),this.fillState||a.closePath()}else a.moveTo(nx,ny);this.penstrokes.image=i,this.container.x=nx,this.container.y=ny,h?(this.x=e,this.y=r):(this.x=this.turtles.screenX2turtleX(e),this.y=this.turtles.screenY2turtleY(r))},this.rename=function(t){this.name=t,null!=this.startBlock&&(this.startBlock.overrideName=this.name,this.name===_("start drum")?this.startBlock.collapseText.text=_("drum"):this.startBlock.collapseText.text=this.name,this.startBlock.regenerateArtwork(!1),this.startBlock.value=this.turtles.turtleList.indexOf(this))},this.arc=function(t,s,e,i,r,h,n,l,o,c,u){if(u?(t=this.turtles.turtleX2screenX(t),s=this.turtles.turtleY2screenY(s),e=this.turtles.turtleX2screenX(e),i=this.turtles.turtleY2screenY(i),nx=this.turtles.turtleX2screenX(r),ny=this.turtles.turtleY2screenY(h)):(nx=r,ny=h),c?(sa=l,ea=o):(sa=l-Math.PI,ea=o-Math.PI),this.penState&&this.hollowState){this.closeSVG(),this.svgPath=!0;var v=this.stroke;if(this.stroke=1,a.lineWidth=this.stroke,a.lineCap="round",v<3)var d=.5;else d=(v-2)/2;var p=(this.orientation+90)*Math.PI/180,m=d*Math.sin(p),g=-d*Math.cos(p);if(c){a.moveTo(e+m,i+g);var f=(e+m)*this.turtles.scale,C=(i+g)*this.turtles.scale}else{a.moveTo(e-m,i-g);f=(e-m)*this.turtles.scale,C=(i-g)*this.turtles.scale}this.svgOutput+='<path d="M '+f+","+C+" ",a.arc(t,s,n+d,sa,ea,c),nsteps=Math.max(Math.floor(n*Math.abs(sa-ea)/2),2),steps=Math.max(Math.floor(v,1)),this._svgArc(nsteps,t*this.turtles.scale,s*this.turtles.scale,(n+d)*this.turtles.scale,sa,ea);p=(this.orientation+90)*Math.PI/180,m=d*Math.sin(p),g=-d*Math.cos(p);var b=nx,k=ny,S=ea,x=ea+Math.PI;a.arc(b,k,d,S,x,c),this._svgArc(steps,b*this.turtles.scale,k*this.turtles.scale,d*this.turtles.scale,S,x),a.arc(t,s,n-d,ea,sa,!c),this._svgArc(nsteps,t*this.turtles.scale,s*this.turtles.scale,(n-d)*this.turtles.scale,ea,sa);var y=e,M=i,X=sa-Math.PI,B=sa;a.arc(y,M,d,X,B,c),this._svgArc(steps,y*this.turtles.scale,M*this.turtles.scale,d*this.turtles.scale,X,B),this.closeSVG(),a.stroke(),a.closePath(),this.stroke=v,a.lineWidth=this.stroke,a.lineCap="round",a.moveTo(nx,ny)}else if(this.penState){if(a.arc(t,s,n,sa,ea,c),!this.svgPath){this.svgPath=!0;f=e*this.turtles.scale,C=i*this.turtles.scale;this.svgOutput+='<path d="M '+f+","+C+" "}if(c)var Y=0;else Y=1;var P=nx*this.turtles.scale,w=ny*this.turtles.scale,T=n*this.turtles.scale;this.svgOutput+="A "+T+","+T+" 0 0 "+Y+" "+P+","+w+" ",a.stroke(),this.fillState||a.closePath()}else a.moveTo(nx,ny);this.container.x=nx,this.container.y=ny,u?(this.x=r,this.y=h):(this.x=this.screenX2turtles.turtleX(r),this.y=this.screenY2turtles.turtleY(h))},this.doClear=function(t,s){if(this.x=0,this.y=0,this.orientation=0,t){var e=this.turtles.turtleList.indexOf(this)%10;this.color=10*e,this.value=50,this.chroma=100,this.stroke=5,this.font=DEFAULTFONT}this.container.x=this.turtles.turtleX2screenX(this.x),this.container.y=this.turtles.turtleY2screenY(this.y),s&&(this.drum?this.name!==_("start drum")&&this.rename(_("start drum")):this.name!==_("start")&&this.rename(_("start")),this.skinChanged&&(this.doTurtleShell(55,"images/turtle-"+e.toString()+".svg"),this.skinChanged=!1)),this.bitmap.rotation=this.orientation,this.updateCache();for(e=0;e<this.media.length;e++)this.imageContainer.removeChild(this.media[e]),this.turtles.stage.removeChild(this.media[e]),delete this.media[e];this.media=[],this.penState=!0,this.fillState=!1,this.hollowState=!1,this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1])),this.svgOutput="",this.svgPath=!1,this.penstrokes.image=null,a.beginPath(),a.clearRect(0,0,i.width,i.height),this.penstrokes.image=i,this.turtles.refreshCanvas()},this.clearPenStrokes=function(){this.penState=!0,this.fillState=!1,this.hollowState=!1,this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1])),a.beginPath(),a.clearRect(0,0,i.width,i.height);var t=this.canvasColor.substr(0,this.canvasColor.length-2);a.strokeStyle=t+this.canvasAlpha+")",a.fillStyle=t+this.canvasAlpha+")",a.lineWidth=this.stroke,a.lineCap="round",a.beginPath(),this.penstrokes.image=i,this.svgOutput="",this.svgPath=!1,this.turtles.refreshCanvas()},this.doForward=function(t){if(!this.fillState){"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var s=this.canvasColor.substr(0,this.canvasColor.length-2);a.strokeStyle=s+this.canvasAlpha+")",a.fillStyle=s+this.canvasAlpha+")",a.lineWidth=this.stroke,a.lineCap="round",a.beginPath(),a.moveTo(this.container.x,this.container.y)}var e=this.turtles.screenX2turtleX(this.container.x),i=this.turtles.screenY2turtleY(this.container.y),r=this.orientation*Math.PI/180,h=e+Number(t)*Math.sin(r),n=i+Number(t)*Math.cos(r);this.move(e,i,h,n,!0),this.turtles.refreshCanvas()},this.doSetXY=function(t,s){if(!this.fillState){"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var e=this.canvasColor.substr(0,this.canvasColor.length-2);a.strokeStyle=e+this.canvasAlpha+")",a.fillStyle=e+this.canvasAlpha+")",a.lineWidth=this.stroke,a.lineCap="round",a.beginPath(),a.moveTo(this.container.x,this.container.y)}var i=this.turtles.screenX2turtleX(this.container.x),r=this.turtles.screenY2turtleY(this.container.y),h=Number(t),n=Number(s);this.move(i,r,h,n,!0),this.turtles.refreshCanvas()},this.doArc=function(t,s){s<0&&(s=-s);var e=Number(t);if(e<0){var i=-1;e=-e}else i=1;for(var a=e%90,r=Math.floor(e/90),h=0;h<r;h++)this._doArcPart(90*i,s);a>0&&this._doArcPart(a*i,s)},this._doArcPart=function(t,s){if(!this.fillState){"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var e=this.canvasColor.substr(0,this.canvasColor.length-2);a.strokeStyle=e+this.canvasAlpha+")",a.fillStyle=e+this.canvasAlpha+")",a.lineWidth=this.stroke,a.lineCap="round",a.beginPath(),a.moveTo(this.container.x,this.container.y)}var i=Number(t),r=i/180*Math.PI,h=this.orientation/180*Math.PI,n=Number(s);if(ox=this.turtles.screenX2turtleX(this.container.x),oy=this.turtles.screenY2turtleY(this.container.y),i<0){var l=!0;i=-i;var o=ox-Math.cos(h)*n,c=oy+Math.sin(h)*n,u=o+Math.cos(h+r)*n,v=c-Math.sin(h+r)*n}else l=!1,o=ox+Math.cos(h)*n,c=oy-Math.sin(h)*n,u=o-Math.cos(h+r)*n,v=c+Math.sin(h+r)*n;this.arc(o,c,ox,oy,u,v,n,h,h+r,l,!0),l?this.doRight(-i):this.doRight(i),this.turtles.refreshCanvas()},this.doShowImage=function(t,s){if(null!==s){var e=new Image,i=this;e.onload=function(){var s=new createjs.Bitmap(e);i.imageContainer.addChild(s),i.media.push(s),s.scaleX=Number(t)/e.width,s.scaleY=s.scaleX,s.scale=s.scaleX,s.x=i.container.x,s.y=i.container.y,s.regX=e.width/2,s.regY=e.height/2,s.rotation=i.orientation,i.turtles.refreshCanvas()},e.src=s}},this.doShowURL=function(t,s){if(null!==s){var e=new Image;e.src=s;var i=this;e.onload=function(){var s=new createjs.Bitmap(e);i.imageContainer.addChild(s),i.media.push(s),s.scaleX=Number(t)/e.width,s.scaleY=s.scaleX,s.scale=s.scaleX,s.x=i.container.x,s.y=i.container.y,s.regX=e.width/2,s.regY=e.height/2,s.rotation=i.orientation,i.turtles.refreshCanvas()}}},this.doTurtleShell=function(t,s){if(null!==s){var e=new Image;e.src=s;var i=this;e.onload=function(){i.container.removeChild(i.bitmap),i.bitmap=new createjs.Bitmap(e),i.container.addChild(i.bitmap),i.bitmap.scaleX=Number(t)/e.width,i.bitmap.scaleY=i.bitmap.scaleX,i.bitmap.scale=i.bitmap.scaleX,i.bitmap.x=0,i.bitmap.y=0,i.bitmap.regX=e.width/2,i.bitmap.regY=e.height/2,i.bitmap.rotation=i.orientation,i.skinChanged=!0,i.container.uncache();var a=i.container.getBounds();i.container.cache(a.x,a.y,a.width,a.height);var r=new createjs.Shape;if(r.graphics.beginFill("#FFF").drawRect(0,0,a.width,a.height),r.x=-a.width/2,r.y=-a.height/2,i.container.hitArea=r,null!=i.startBlock){i.startBlock.container.removeChild(i.decorationBitmap),i.decorationBitmap=new createjs.Bitmap(s),i.startBlock.container.addChild(i.decorationBitmap),i.decorationBitmap.name="decoration";a=i.startBlock.container.getBounds();i.decorationBitmap.x=a.width-50*i.startBlock.protoblock.scale/2,i.decorationBitmap.y=20*i.startBlock.protoblock.scale/2,i.decorationBitmap.scaleX=27.5/e.width*i.startBlock.protoblock.scale/2,i.decorationBitmap.scaleY=27.5/e.height*i.startBlock.protoblock.scale/2,i.decorationBitmap.scale=27.5/e.width*i.startBlock.protoblock.scale/2,i.startBlock.updateCache()}i.turtles.refreshCanvas()}}},this.resizeDecoration=function(t,s){this.decorationBitmap.x=s-30*t/2,this.decorationBitmap.y=35*t/2,this.decorationBitmap.scaleX=this.decorationBitmap.scaleY=this.decorationBitmap.scale=.5*t/2},this.doShowText=function(t,s){var e=t.toString()+"px "+this.font,i=new createjs.Text(s.toString(),e,this.canvasColor);i.textAlign="left",i.textBaseline="alphabetic",this.turtles.stage.addChild(i),this.media.push(i),i.x=this.container.x,i.y=this.container.y,i.rotation=this.orientation;var a=i.x*this.turtles.scale,r=i.y*this.turtles.scale,h=t*this.turtles.scale;this.svgOutput+='<text x="'+a+'" y = "'+r+'" fill="'+this.canvasColor+'" font-family = "'+this.font+'" font-size = "'+h+'">'+s+"</text>",this.turtles.refreshCanvas()},this.doRight=function(t){this.orientation+=Number(t),this.orientation%=360,this.bitmap.rotation=this.orientation,this.blinkFinished&&this.updateCache()},this.doSetHeading=function(t){this.orientation=Number(t),this.orientation%=360,this.bitmap.rotation=this.orientation,this.blinkFinished&&this.updateCache()},this.doSetFont=function(t){this.font=t,this.updateCache()},this.doSetColor=function(t){this.closeSVG(),this.color=Number(t);var s=getcolor(this.color);this.canvasValue=s[0],this.canvasChroma=s[1],this.canvasColor=s[2],"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var e=this.canvasColor.substr(0,this.canvasColor.length-2);a.strokeStyle=e+this.canvasAlpha+")",a.fillStyle=e+this.canvasAlpha+")"},this.doSetPenAlpha=function(t){this.canvasAlpha=t},this.doSetHue=function(t){this.closeSVG(),this.color=Number(t),this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var s=this.canvasColor.substr(0,this.canvasColor.length-2);a.strokeStyle=s+this.canvasAlpha+")",a.fillStyle=s+this.canvasAlpha+")"},this.doSetValue=function(t){this.closeSVG(),this.value=Number(t),this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var s=this.canvasColor.substr(0,this.canvasColor.length-2);a.strokeStyle=s+this.canvasAlpha+")",a.fillStyle=s+this.canvasAlpha+")"},this.doSetChroma=function(t){this.closeSVG(),this.chroma=Number(t),this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var s=this.canvasColor.substr(0,this.canvasColor.length-2);a.strokeStyle=s+this.canvasAlpha+")",a.fillStyle=s+this.canvasAlpha+")"},this.doSetPensize=function(t){this.closeSVG(),this.stroke=t,a.lineWidth=this.stroke},this.doPenUp=function(){this.closeSVG(),this.penState=!1},this.doPenDown=function(){this.penState=!0},this.doStartFill=function(){a.beginPath(),this.fillState=!0},this.doEndFill=function(){a.fill(),a.closePath(),this.closeSVG(),this.fillState=!1},this.doStartHollowLine=function(){this.hollowState=!0},this.doEndHollowLine=function(){this.hollowState=!1},this.closeSVG=function(){if(this.svgPath){var t=this.canvasColor.replace(/rgba/g,"rgb");t=t.substr(0,this.canvasColor.length-4)+");",this.svgOutput+='" style="stroke-linecap:round;fill:',this.fillState?this.svgOutput+=t+"fill-opacity:"+this.canvasAlpha+";":this.svgOutput+="none;",this.svgOutput+="stroke:"+t+"stroke-opacity:"+this.canvasAlpha+";";var s=this.stroke*this.turtles.scale;this.svgOutput+="stroke-width:"+s+'pt;" />',this.svgPath=!1}},this.createCache=function(){var t=this;t.bounds=t.container.getBounds(),null==t.bounds?setTimeout((function(){t.createCache()}),200):t.container.cache(t.bounds.x,t.bounds.y,t.bounds.width,t.bounds.height)},this.updateCache=function(){var t=this;null==t.bounds?(console.log("Block container for "+t.name+" not yet ready."),setTimeout((function(){t.updateCache()}),300)):(t.container.updateCache(),t.turtles.refreshCanvas())},this.blink=function(t,s){var e,i=this;0==this.blinkFinished?e=this.beforeBlinkSize:(e=i.bitmap.scaleX,this.beforeBlinkSize=e),this.blinkFinished=!1,i.container.uncache();var a=4*(s+200)/1e3;i.bitmap.alpha=.5,i.bitmap.scaleX=e*(60/55)*a,i.bitmap.scaleY=i.bitmap.scaleX,i.bitmap.scale=i.bitmap.scaleX;var r=i.skinChanged;i.skinChanged=!0,createjs.Tween.get(i.bitmap).to({alpha:1,scaleX:e,scaleY:e,scale:e},500/t),setTimeout((function(){i.bitmap.scaleX=e,i.bitmap.scaleY=i.bitmap.scaleX,i.bitmap.scale=i.bitmap.scaleX,i.bitmap.rotation=i.orientation,i.skinChanged=r;var t=i.container.getBounds();i.container.cache(t.x,t.y,t.width,t.height),i.blinkFinished=!0}),500/t)}}function Turtles(){this.stage=null,this.refreshCanvas=null,this.scale=1,this._canvas=null,this._rotating=!1,this._drum=!1,this.turtleList=[],this.setCanvas=function(t){return this._canvas=t,this},this.setStage=function(t){return this.stage=t,this},this.setRefreshCanvas=function(t){return this.refreshCanvas=t,this},this.setScale=function(t){return this.scale=t,this},this.setBlocks=function(t){return this.blocks=t,this},this.addDrum=function(t,s){this._drum=!0,this.add(t,s)},this.addTurtle=function(t,s){this._drum=!1,this.add(t,s)},this.add=function(t,s){null!=t?(console.log("adding a new turtle "+t.name),t.value!==this.turtleList.length&&(t.value=this.turtleList.length,console.log("turtle #"+t.value))):console.log("adding a new turtle startBlock is null");var e=!1;"object"==typeof s&&8===Object.keys(s).length&&(e=!0);var i=this.turtleList.length,a=new Turtle(i.toString(),this,this._drum);e&&(a.x=s.xcor,a.y=s.ycor),this.turtleList.push(a),a.imageContainer=new createjs.Container,this.stage.addChild(a.imageContainer),a.penstrokes=new createjs.Bitmap,this.stage.addChild(a.penstrokes);new Image;i%=10,a.container=new createjs.Container,this.stage.addChild(a.container),a.container.x=this.turtleX2screenX(a.x),a.container.y=this.turtleY2screenY(a.y);var r=new createjs.Shape;function __processTurtleBitmap(t,s,e,i){if(a.bitmap=e,a.bitmap.regX=27,a.bitmap.regY=27,a.bitmap.cursor="pointer",a.container.addChild(a.bitmap),a.createCache(),a.startBlock=i,null!=i){i.updateCache(),a.decorationBitmap=a.bitmap.clone(),i.container.addChild(a.decorationBitmap),a.decorationBitmap.name="decoration";var r=i.container.getBounds();if(null==i.expandBitmap)var h=75;else h=40;a.decorationBitmap.x=r.width-h*i.protoblock.scale/2,a.decorationBitmap.y=35*i.protoblock.scale/2,a.decorationBitmap.scaleX=a.decorationBitmap.scaleY=a.decorationBitmap.scale=.5*i.protoblock.scale/2,i.updateCache()}t.refreshCanvas()}if(r.graphics.beginFill("#FFF").drawEllipse(-27,-27,55,55),r.x=0,r.y=0,a.container.hitArea=r,this._drum)var h=DRUMSVG;else h=TURTLESVG;sugarizerCompatibility.isInsideSugarizer()?this._makeTurtleBitmap(h.replace(/fill_color/g,sugarizerCompatibility.xoColor.fill).replace(/stroke_color/g,sugarizerCompatibility.xoColor.stroke),"turtle",__processTurtleBitmap,t):this._makeTurtleBitmap(h.replace(/fill_color/g,FILLCOLORS[i]).replace(/stroke_color/g,STROKECOLORS[i]),"turtle",__processTurtleBitmap,t),a.color=10*i,a.canvasColor=getMunsellColor(a.color,50,100);var n=this;a.container.on("mousedown",(function(t){if(!n._rotating){var s=a.container.x-t.stageX/n.scale,e=a.container.y-t.stageY/n.scale;a.container.on("pressmove",(function(t){a.running||(a.container.x=t.stageX/n.scale+s,a.container.y=t.stageY/n.scale+e,a.x=n.screenX2turtleX(a.container.x),a.y=n.screenY2turtleY(a.container.y),n.refreshCanvas())}))}})),a.container.on("click",(function(t){console.log("--\x3e [click"+a.name+"]"),n.stage.dispatchEvent("click"+a.name)})),a.container.on("mouseover",(function(t){a.bitmap.scaleX=1.2,a.bitmap.scaleY=1.2,a.bitmap.scale=1.2,n.refreshCanvas()})),a.container.on("mouseout",(function(t){a.bitmap.scaleX=1,a.bitmap.scaleY=1,a.bitmap.scale=1,n.refreshCanvas()})),document.getElementById("loader").className="",setTimeout((function(){e&&(a.doSetHeading(s.heading),a.doSetPensize(s.pensize),a.doSetChroma(s.grey),a.doSetValue(s.shade),a.doSetColor(s.color))}),1e3),this.refreshCanvas()},this._makeTurtleBitmap=function(t,s,e,i){var a=new Image,r=this;a.onload=function(){complete=!0;var t=new createjs.Bitmap(a);e(r,s,t,i)},a.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(t)))},this.screenX2turtleX=function(t){return t-this._canvas.width/(2*this.scale)},this.screenY2turtleY=function(t){return this.invertY(t)},this.turtleX2screenX=function(t){return this._canvas.width/(2*this.scale)+t},this.turtleY2screenY=function(t){return this.invertY(t)},this.invertY=function(t){return this._canvas.height/(2*this.scale)-t},this.markAsStopped=function(){for(var t in this.turtleList)this.turtleList[t].running=!1},this.running=function(){for(var t in this.turtleList)if(this.turtleList[t].running)return!0;return!1}}function Queue(t,s,e,i){this.blk=t,this.count=s,this.parentBlk=e,this.args=i}function hex2rgb(t){var s=parseInt(t,16);return"rgba("+(s>>16&255)+","+(s>>8&255)+","+(255&s)+",1)"}