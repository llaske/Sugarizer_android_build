const LONGPRESSTIME=1500,COLLAPSABLES=["drum","start","action","matrix","pitchdrummatrix","rhythmruler","status","pitchstaircase","tempo","pitchslider","modewidget"],NOHIT=["hidden","hiddennoflow"],SPECIALINPUTS=["text","number","solfege","eastindiansolfege","notename","voicename","modename","drumname"];function Block(e,t,i){null!==e?(this.protoblock=e,this.name=e.name,this.overrideName=i,this.blocks=t,this.collapsed=!1,this.trash=!1,this.loadComplete=!1,this.label=null,this.text=null,this.value=null,this.privateData=null,this.image=e.image,this.imageBitmap=null,this.container=null,this.bounds=null,this.bitmap=null,this.highlightBitmap=null,this.artwork=null,this.collapseArtwork=null,this.collapseContainer=null,this.collapseBitmap=null,this.expandBitmap=null,this.collapseBlockBitmap=null,this.highlightCollapseBlockBitmap=null,this.collapseText=null,this.size=1,this.docks=[],this.connections=[],this.clampCount=[1,1],this.argClampSlots=[1],this.postProcess=null,this.postProcessArg=null,this._label_lock=!1,this._createCache=function(){var e=this;e.bounds=e.container.getBounds(),null==e.bounds?setTimeout((function(){e._createCache()}),200):e.container.cache(e.bounds.x,e.bounds.y,e.bounds.width,e.bounds.height)},this.updateCache=function(){var e=this;null==e.bounds?setTimeout((function(){e.updateCache()}),300):(e.container.updateCache(),e.blocks.refreshCanvas())},this.offScreen=function(e){return!this.trash&&e.offScreen(this.container.x,this.container.y)},this.copySize=function(){this.size=this.protoblock.size},this.getInfo=function(){return this.name+" block"},this.highlight=function(){this.collapsed&&-1!==COLLAPSABLES.indexOf(this.name)?this.highlightCollapseBlockBitmap&&(this.highlightCollapseBlockBitmap.visible=!0,this.collapseBlockBitmap.visible=!1,this.collapseText.visible=!0,this.bitmap.visible=!1,this.highlightBitmap.visible=!1):(this.bitmap.visible=!1,this.highlightBitmap.visible=!0,-1!==COLLAPSABLES.indexOf(this.name)&&this.highlightCollapseBlockBitmap&&(null!==this.collapseText&&(this.collapseText.visible=!1),null!==this.collapseBlockBitmap.visible&&(this.collapseBlockBitmap.visible=!1),null!==this.highlightCollapseBlockBitmap.visible&&(this.highlightCollapseBlockBitmap.visible=!1))),this.updateCache()},this.unhighlight=function(){this.collapsed&&-1!==COLLAPSABLES.indexOf(this.name)?this.highlightCollapseBlockBitmap&&(this.highlightCollapseBlockBitmap.visible=!1,this.collapseBlockBitmap.visible=!0,this.collapseText.visible=!0,this.bitmap.visible=!1,this.highlightBitmap.visible=!1):(this.bitmap.visible=!0,this.highlightBitmap.visible=!1,-1!==COLLAPSABLES.indexOf(this.name)&&this.highlightCollapseBlockBitmap&&(this.highlightCollapseBlockBitmap.visible=!1,this.collapseBlockBitmap.visible=!1,this.collapseText.visible=!1)),this.updateCache()},this.updateArgSlots=function(e){this.argClampSlots=e,this._newArtwork(),this.regenerateArtwork(!1)},this.updateSlots=function(e,t){this.clampCount[e]+=t,this._newArtwork(t),this.regenerateArtwork(!1)},this.resize=function(e){var t=this;if(this.postProcess=function(i){if(null!==t.imageBitmap&&(t._positionMedia(t.imageBitmap,t.imageBitmap.image.width,t.imageBitmap.image.height,e),z=t.container.getNumChildren()-1,t.container.setChildIndex(t.imageBitmap,z)),"start"===t.name||"drum"===t.name)for(var l=0;l<t.blocks.turtles.turtleList.length;l++)if(t.blocks.turtles.turtleList[l].startBlock===t){t.blocks.turtles.turtleList[l].resizeDecoration(e,t.bitmap.image.width),t._ensureDecorationOnTop();break}t.updateCache(),t._calculateBlockHitArea(),t.trash&&t.hide()},this.postProcessArg=null,this.protoblock.scale=e,this._newArtwork(0),this.regenerateArtwork(!0,[]),null!==this.text&&this._positionText(e),null!==this.collapseContainer){this.collapseContainer.uncache();this._generateCollapseArtwork((function(t){t.collapseBitmap.scaleX=t.collapseBitmap.scaleY=t.collapseBitmap.scale=e/2,t.expandBitmap.scaleX=t.expandBitmap.scaleY=t.expandBitmap.scale=e/2;var i=t.collapseContainer.getBounds();i&&t.collapseContainer.cache(i.x,i.y,i.width,i.height),t._positionCollapseContainer(t.protoblock.scale),t._calculateCollapseHitArea()}));var i=10*e;this.collapseText.font=i+"px Sans",this._positionCollapseLabel(e)}},this._newArtwork=function(e){if(COLLAPSABLES.indexOf(this.name)>-1){var t=new ProtoBlock("collapse");t.scale=this.protoblock.scale,t.extraWidth=10,t.basicBlockCollapsed();var i=t.generator();this.collapseArtwork=i[0];i=this.protoblock.generator(this.clampCount[0])}else if("ifthenelse"===this.name)i=this.protoblock.generator(this.clampCount[0],this.clampCount[1]);else if("clamp"===this.protoblock.style)i=this.protoblock.generator(this.clampCount[0]);else switch(this.name){case"equal":case"greater":case"less":i=this.protoblock.generator(this.clampCount[0]);break;case"calcArg":case"doArg":case"namedcalcArg":case"nameddoArg":i=this.protoblock.generator(this.argClampSlots);this.size=2;for(var l=0;l<this.argClampSlots.length;l++)this.size+=this.argClampSlots[l];this.docks=[],this.docks.push([i[1][0][0],i[1][0][1],this.protoblock.dockTypes[0]]);break;default:if(this.isArgBlock())i=this.protoblock.generator(this.clampCount[0]);else if(this.isTwoArgBlock())i=this.protoblock.generator(this.clampCount[0]);else i=this.protoblock.generator();this.size+=e}switch(this.name){case"nameddoArg":for(l=1;l<i[1].length-1;l++)this.docks.push([i[1][l][0],i[1][l][1],"anyin"]);this.docks.push([i[1][2][0],i[1][2][1],"in"]);break;case"namedcalcArg":for(l=1;l<i[1].length;l++)this.docks.push([i[1][l][0],i[1][l][1],"anyin"]);break;case"doArg":this.docks.push([i[1][1][0],i[1][1][1],this.protoblock.dockTypes[1]]);for(l=2;l<i[1].length-1;l++)this.docks.push([i[1][l][0],i[1][l][1],"anyin"]);this.docks.push([i[1][3][0],i[1][3][1],"in"]);break;case"calcArg":this.docks.push([i[1][1][0],i[1][1][1],this.protoblock.dockTypes[1]]);for(l=2;l<i[1].length;l++)this.docks.push([i[1][l][0],i[1][l][1],"anyin"])}this.artwork=i[0];for(l=0;l<this.docks.length;l++)this.docks[l][0]=i[1][l][0],this.docks[l][1]=i[1][l][1]},this.imageLoad=function(){var e=10*this.protoblock.scale;this.text=new createjs.Text("",e+"px Sans","#000000"),this.generateArtwork(!0,[])},this._addImage=function(){var e=new Image,t=this;e.onload=function(){var i=new createjs.Bitmap(e);i.name="media",t.container.addChild(i),t._positionMedia(i,e.width,e.height,t.protoblock.scale),t.imageBitmap=i,t.updateCache()},e.src=this.image},this.regenerateArtwork=function(e){null!=this.bitmap&&this.container.removeChild(this.bitmap),null!=this.highlightBitmap&&this.container.removeChild(this.highlightBitmap),e&&null!==this.collapseBitmap&&(this.collapseContainer.removeChild(this.collapseBitmap),this.collapseContainer.removeChild(this.expandBitmap),this.container.removeChild(this.collapseBlockBitmap),this.container.removeChild(this.highlightCollapseBlockBitmap)),this.generateArtwork(!1)},this.generateArtwork=function(e){var t=this.blocks.blockList.indexOf(this),i="";function __processHighlightBitmap(i,l,s){null!=s.highlightBitmap&&s.container.removeChild(s.highlightBitmap),s.highlightBitmap=l,s.container.addChild(s.highlightBitmap),s.highlightBitmap.x=0,s.highlightBitmap.y=0,s.highlightBitmap.name="bmp_highlight_"+t,s.highlightBitmap.cursor="pointer",s.highlightBitmap.visible=!1,e||s.container.uncache(),s._createCache(),s.blocks.refreshCanvas(),e?(s._loadEventHandlers(),null!==s.image&&s._addImage(),s._finishImageLoad()):("start"!==s.name&&"drum"!==s.name||s._ensureDecorationOnTop(),s.blocks.adjustDocks(t,!0),s._positionText(s.protoblock.scale),-1!==COLLAPSABLES.indexOf(s.name)&&(s.bitmap.visible=!s.collapsed,s.highlightBitmap.visible=!1,s.updateCache()),null!=s.postProcess&&(s.postProcess(s.postProcessArg),s.postProcess=null))}for(this.overrideName?-1!==["nameddo","nameddoArg","namedcalc","namedcalcArg"].indexOf(this.name)?(i=this.overrideName).length>8&&(i=i.substr(0,7)+"..."):i=this.overrideName:this.protoblock.staticLabels.length>0&&!this.protoblock.image&&(i=this.protoblock.staticLabels[0]);this.protoblock.staticLabels.length<this.protoblock.args+1;)this.protoblock.staticLabels.push("");if(e){var l=this.protoblock.generator();this.artwork=l[0];for(var s=0;s<l[1].length;s++)this.docks.push([l[1][s][0],l[1][s][1],this.protoblock.dockTypes[s]])}if(this.protoblock.disabled)var a=this.artwork.replace(/fill_color/g,DISABLEDFILLCOLOR).replace(/stroke_color/g,DISABLEDSTROKECOLOR).replace("block_label",i);else a=this.artwork.replace(/fill_color/g,PALETTEFILLCOLORS[this.protoblock.palette.name]).replace(/stroke_color/g,PALETTESTROKECOLORS[this.protoblock.palette.name]).replace("block_label",i);for(s=1;s<this.protoblock.staticLabels.length;s++)a=a.replace("arg_label_"+s,this.protoblock.staticLabels[s]);_makeBitmap(a,this.name,(function __processBitmap(e,l,s){if(null!=s.bitmap&&s.container.removeChild(s.bitmap),s.bitmap=l,s.container.addChild(s.bitmap),s.bitmap.x=0,s.bitmap.y=0,s.bitmap.name="bmp_"+t,s.bitmap.cursor="pointer",s.blocks.refreshCanvas(),s.protoblock.disabled)var a=s.artwork.replace(/fill_color/g,DISABLEDFILLCOLOR).replace(/stroke_color/g,DISABLEDSTROKECOLOR).replace("block_label",i);else a=s.artwork.replace(/fill_color/g,PALETTEHIGHLIGHTCOLORS[s.protoblock.palette.name]).replace(/stroke_color/g,HIGHLIGHTSTROKECOLORS[s.protoblock.palette.name]).replace("block_label",i);for(var o=1;o<s.protoblock.staticLabels.length;o++)a=a.replace("arg_label_"+o,s.protoblock.staticLabels[o]);_makeBitmap(a,s.name,__processHighlightBitmap,s)}),this)},this._finishImageLoad=function(){this.blocks.blockList.indexOf(this);if(-1!==SPECIALINPUTS.indexOf(this.name)){if(null==this.value)switch(this.name){case"text":this.value="---";break;case"solfege":case"eastindiansolfege":this.value="sol";break;case"notename":this.value="G";break;case"rest":this.value=_("rest");break;case"number":this.value=NUMBERBLOCKDEFAULT;break;case"modename":this.value=getModeName(DEFAULTMODE);break;case"voicename":this.value=DEFAULTVOICE;break;case"drumname":this.value=getDrumName(DEFAULTDRUM)}if("solfege"===this.name){var e=splitSolfege(this.value),t=i18nSolfege(e[0]);"♮"!==(i=e[1])&&(t+=i)}else if("eastindiansolfege"===this.name){var i;e=splitSolfege(this.value),t=WESTERN2EISOLFEGENAMES[e[0]];"♮"!==(i=e[1])&&(t+=i)}else t=this.value.toString();t.length>8&&(t=t.substr(0,7)+"..."),this.text.text=t,this.container.addChild(this.text),this._positionText(this.protoblock.scale)}else this.protoblock.parameter&&(this.container.addChild(this.text),this._positionText(this.protoblock.scale));if(-1===COLLAPSABLES.indexOf(this.name))this.loadComplete=!0,null!==this.postProcess&&(this.postProcess(this.postProcessArg),this.postProcess=null),this.blocks.refreshCanvas(),this.blocks.cleanupAfterLoad(this.name);else{var l=new ProtoBlock("collapse");l.scale=this.protoblock.scale,l.extraWidth=10,l.basicBlockCollapsed();e=l.generator();this.collapseArtwork=e[0];this._generateCollapseArtwork((function(e){e._loadCollapsibleEventHandlers(),e.loadComplete=!0,null!==e.postProcess&&(e.postProcess(e.postProcessArg),e.postProcess=null)}))}},this._generateCollapseArtwork=function(e){var t=this.blocks.blockList.indexOf(this);function __processHighlightCollapseBitmap(i,l,s){if(s.highlightCollapseBlockBitmap=l,s.highlightCollapseBlockBitmap.name="highlight_collapse_"+t,s.container.addChild(s.highlightCollapseBlockBitmap),s.highlightCollapseBlockBitmap.visible=!1,null===s.collapseText){var a=10*s.protoblock.scale;switch(s.name){case"action":s.collapseText=new createjs.Text(_("action"),a+"px Sans","#000000");break;case"start":s.collapseText=new createjs.Text(_("start"),a+"px Sans","#000000");break;case"matrix":s.collapseText=new createjs.Text(_("matrix"),a+"px Sans","#000000");break;case"status":s.collapseText=new createjs.Text(_("status"),a+"px Sans","#000000");break;case"pitchdrummatrix":s.collapseText=new createjs.Text(_("drum"),a+"px Sans","#000000");break;case"rhythmruler":s.collapseText=new createjs.Text(_("ruler"),a+"px Sans","#000000");break;case"pitchstaircase":s.collapseText=new createjs.Text(_("stair"),a+"px Sans","#000000");break;case"tempo":s.collapseText=new createjs.Text(_("tempo"),a+"px Sans","#000000");case"modewidget":s.collapseText=new createjs.Text(_("mode"),a+"px Sans","#000000");break;case"pitchslider":s.collapseText=new createjs.Text(_("slider"),a+"px Sans","#000000");break;case"drum":s.collapseText=new createjs.Text(_("drum"),a+"px Sans","#000000")}s.collapseText.textAlign="left",s.collapseText.textBaseline="alphabetic",s.container.addChild(s.collapseText)}s._positionCollapseLabel(s.protoblock.scale),s.collapseText.visible=s.collapsed,s._ensureDecorationOnTop(),s.updateCache(),s.collapseContainer=new createjs.Container,s.collapseContainer.snapToPixelEnabled=!0;var o=new Image;o.onload=function(){s.collapseBitmap=new createjs.Bitmap(o),s.collapseBitmap.scaleX=s.collapseBitmap.scaleY=s.collapseBitmap.scale=s.protoblock.scale/2,s.collapseContainer.addChild(s.collapseBitmap),s.collapseBitmap.visible=!s.collapsed,finishCollapseButton(s)},o.src="images/collapse.svg",finishCollapseButton=function(t){var i=new Image;i.onload=function(){t.expandBitmap=new createjs.Bitmap(i),t.expandBitmap.scaleX=t.expandBitmap.scaleY=t.expandBitmap.scale=t.protoblock.scale/2,t.collapseContainer.addChild(t.expandBitmap),t.expandBitmap.visible=t.collapsed;var l=t.collapseContainer.getBounds();l&&t.collapseContainer.cache(l.x,l.y,l.width,l.height),t.blocks.stage.addChild(t.collapseContainer),null!==e&&e(t),t.blocks.refreshCanvas(),t.blocks.cleanupAfterLoad(t.name)},i.src="images/expand.svg"}}_makeBitmap(this.collapseArtwork.replace(/fill_color/g,PALETTEFILLCOLORS[this.protoblock.palette.name]).replace(/stroke_color/g,PALETTESTROKECOLORS[this.protoblock.palette.name]).replace("block_label",""),"",(function __processCollapseBitmap(e,i,l){l.collapseBlockBitmap=i,l.collapseBlockBitmap.name="collapse_"+t,l.container.addChild(l.collapseBlockBitmap),l.collapseBlockBitmap.visible=l.collapsed,l.blocks.refreshCanvas(),_makeBitmap(l.collapseArtwork.replace(/fill_color/g,PALETTEHIGHLIGHTCOLORS[l.protoblock.palette.name]).replace(/stroke_color/g,HIGHLIGHTSTROKECOLORS[l.protoblock.palette.name]).replace("block_label",""),"",__processHighlightCollapseBitmap,l)}),this)},this.hide=function(){this.container.visible=!1,null!==this.collapseContainer&&(this.collapseContainer.visible=!1,this.collapseText.visible=!1)},this.show=function(){this.trash||-1===COLLAPSABLES.indexOf(this.name)&&this.collapsed||(this.container.visible=!0,null!==this.collapseContainer&&(this.collapseContainer.visible=!0,this.collapseText.visible=!0))},this.isValueBlock=function(){return"value"===this.protoblock.style},this.isNoHitBlock=function(){return-1!==NOHIT.indexOf(this.name)},this.isArgBlock=function(){return"value"===this.protoblock.style||"arg"===this.protoblock.style},this.isTwoArgBlock=function(){return"twoarg"===this.protoblock.style},this.isTwoArgBooleanBlock=function(){return-1!==["equal","greater","less"].indexOf(this.name)},this.isClampBlock=function(){return"clamp"===this.protoblock.style||this.isDoubleClampBlock()||this.isArgFlowClampBlock()},this.isArgFlowClampBlock=function(){return"argflowclamp"===this.protoblock.style},this.isDoubleClampBlock=function(){return"doubleclamp"===this.protoblock.style},this.isNoRunBlock=function(){return"action"===this.name},this.isArgClamp=function(){return"argclamp"===this.protoblock.style||"argclamparg"===this.protoblock.style},this.isExpandableBlock=function(){return this.protoblock.expandable},this.getBlockId=function(){return"_"+blockBlocks.blockList.indexOf(this).toString()},this.removeChildBitmap=function(e){for(var t=0;t<this.container.getNumChildren();t++)if(this.container.children[t].name===e){this.container.removeChild(this.container.children[t]);break}},this.loadThumbnail=function(e){var t=this.blocks.blockList.indexOf(this),i=this;if(null!==this.blocks.blockList[t].value||null!==e){var l=new Image;l.onload=function(){i.removeChildBitmap("media");var e=new createjs.Bitmap(l);e.name="media";var t=new createjs.Container;t.addChild(e);l.width>l.height?l.width>600&&(e.scaleX=e.scaleY=e.scale=600/l.width):l.height>450&&(e.scaleX=e.scaleY=e.scale=450/l.height);var s=t.getBounds();t.cache(s.x,s.y,s.width,s.height),i.value=t.getCacheDataURL(),i.imageBitmap=e,i._positionMedia(e,e.image.width,e.image.height,i.protoblock.scale),i.container.addChild(e),i.updateCache()},l.src=null===e?this.value:e}},this._doOpenMedia=function(e){var t=docById("myOpenAll"),i=this;readerAction=function(l){window.scroll(0,0);var s=new FileReader;s.onloadend=function(){if(s.result){if("media"===i.name)return i.value=s.result,void i.loadThumbnail(null);i.value=[t.files[0].name,s.result],i.blocks.updateBlockText(e)}},"media"===i.name?s.readAsDataURL(t.files[0]):s.readAsText(t.files[0]),t.removeEventListener("change",readerAction)},t.addEventListener("change",readerAction,!1),t.focus(),t.click(),window.scroll(0,0)},this.collapseToggle=function(){var e=this,t=this.blocks.blockList.indexOf(this);this.blocks.findDragGroup(t),function __toggle(){var t=e.collapsed;if(null!==e.collapseBitmap){if(e.collapsed=!t,e.collapseBitmap.visible=t,e.expandBitmap.visible=!t,e.collapseBlockBitmap.visible=!t,e.highlightCollapseBlockBitmap.visible=!1,e.collapseText.visible=!t,t?e.bitmap.visible=!0:(e.bitmap.visible=!1,e.updateCache()),e.highlightBitmap.visible=!1,"action"===e.name)if(null!==e.connections[1]){var i=e.blocks.blockList[e.connections[1]].value;i.length>8&&(i=i.substr(0,7)+"..."),e.collapseText.text=i}else e.collapseText.text="";var l=e.container.getNumChildren()-1;if(e.container.setChildIndex(e.collapseText,l),e.blocks.dragGroup.length>0)for(var s=1;s<e.blocks.dragGroup.length;s++){var a=e.blocks.dragGroup[s];e.blocks.blockList[a].collapsed=!t,e.blocks.blockList[a].container.visible=t}e.collapseContainer.updateCache(),e.updateCache()}else console.log("collapse bitmap not ready")}()},this._positionText=function(e){this.text.textBaseline="alphabetic",this.text.textAlign="right";var t=10*e;if(this.text.font=t+"px Sans",this.text.x=TEXTX*e/2,this.text.y=TEXTY*e/2,-1!==SPECIALINPUTS.indexOf(this.name))this.text.textAlign="center",this.text.x=VALUETEXTX*e/2;else if(0===this.protoblock.args){var i=this.container.getBounds();this.text.x=i.width-25}else this.text.textAlign="left","booleanout"===this.docks[0][2]&&(this.text.y=this.docks[0][1]);z=this.container.getNumChildren()-1,this.container.setChildIndex(this.text,z),this.updateCache()},this._positionMedia=function(e,t,i,l){e.scaleX=e.scaleY=e.scale=t>i?MEDIASAFEAREA[2]/t*l/2:MEDIASAFEAREA[3]/i*l/2,e.x=(MEDIASAFEAREA[0]-10)*l/2,e.y=MEDIASAFEAREA[1]*l/2},this._calculateCollapseHitArea=function(){var e=this.collapseContainer.getBounds(),t=new createjs.Shape,i=e.width,l=e.height;t.graphics.beginFill("#FFF").drawEllipse(-i/2,-l/2,i,l),t.x=i/2,t.y=l/2,this.collapseContainer.hitArea=t},this._positionCollapseLabel=function(e){this.collapseText.x=COLLAPSETEXTX*e/2,this.collapseText.y=COLLAPSETEXTY*e/2,z=this.container.getNumChildren()-1,this.container.setChildIndex(this.collapseText,z)},this._positionCollapseContainer=function(e){this.collapseContainer.x=this.container.x+COLLAPSEBUTTONXOFF*e/2,this.collapseContainer.y=this.container.y+COLLAPSEBUTTONYOFF*e/2},this._loadCollapsibleEventHandlers=function(){var e=this,i=this.blocks.blockList.indexOf(this);this._calculateCollapseHitArea(),this.collapseContainer.on("mouseover",(function(t){e.blocks.highlight(i,!0),e.blocks.activeBlock=i,e.blocks.refreshCanvas()}));var l=!1,s=!1,a=!1,o={x:0,y:0};function handleClick(){s||(s=!0,setTimeout((function(){s=!1}),500),hideDOMLabel(),l||e.collapseToggle())}this.collapseContainer.on("click",(function(e){handleClick()})),this.collapseContainer.on("mousedown",(function(i){hideDOMLabel(),trashcan.show(),l=!1,a=!0;var s=new Date;t.mouseDownTime=s.getTime(),o={x:e.collapseContainer.x-Math.round(i.stageX/t.blockScale),y:e.collapseContainer.y-Math.round(i.stageY/t.blockScale)}})),this.collapseContainer.on("pressup",(function(s){if(a)if(a=!1,l)e._collapseOut(t,i,l,s),l=!1;else if((o=new Date).getTime()-t.mouseDownTime>1e3){var o=new Date;t.mouseDownTime=o.getTime(),handleClick()}})),this.collapseContainer.on("mouseout",(function(s){if(a)if(a=!1,l)e._collapseOut(t,i,l,s),l=!1;else if((o=new Date).getTime()-t.mouseDownTime<200){var o=new Date;t.mouseDownTime=o.getTime(),handleClick()}})),this.collapseContainer.on("pressmove",(function(s){if(a){l=!0;var n=e.collapseContainer.x,c=e.collapseContainer.y;e.collapseContainer.x=Math.round(s.stageX/t.blockScale)+o.x,e.collapseContainer.y=Math.round(s.stageY/t.blockScale)+o.y;var h=e.collapseContainer.x-n,r=e.collapseContainer.y-c;if(e.container.x+=h,e.container.y+=r,trashcan.overTrashcan(s.stageX/t.blockScale,s.stageY/t.blockScale)?trashcan.startHighlightAnimation():trashcan.stopHighlightAnimation(),e.blocks.findDragGroup(i),e.blocks.dragGroup.length>0)for(var p=0;p<e.blocks.dragGroup.length;p++){var u=e.blocks.dragGroup[p];0!==p&&e.blocks.moveBlockRelative(u,h,r)}e.blocks.refreshCanvas()}}))},this._collapseOut=function(e,t,i,l){trashcan.hide(),e.unhighlight(t),i&&(trashcan.overTrashcan(l.stageX/e.blockScale,l.stageY/e.blockScale)?trashcan.isVisible&&e.sendStackToTrash(this):e.blockMoved(t)),e.activeBlock===myBlock&&(e.unhighlight(null),e.activeBlock=null,e.refreshCanvas())},this._calculateBlockHitArea=function(){var e=new createjs.Shape,t=this.container.getBounds();null===t&&(this._createCache(),t=this.bounds),this.isClampBlock()||this.isArgClamp()?e.graphics.beginFill("#FFF").drawRect(0,0,t.width,STANDARDBLOCKHEIGHT):this.isNoHitBlock()?e.graphics.beginFill("#FFF").drawRect(0,0,0,0):e.graphics.beginFill("#FFF").drawRect(0,0,t.width,.75*t.height),this.container.hitArea=e},this._loadEventHandlers=function(){var e=this,t=this.blocks.blockList.indexOf(this),i=this.blocks;this._calculateBlockHitArea(),this.container.on("mouseover",(function(e){i.highlight(t,!0),i.activeBlock=t,i.refreshCanvas()}));var l=!1,s=!1,a=!1,o=window.hasMouse;this.container.on("click",(function(n){if(i.activeBlock=t,l=!0,!a&&(a=!0,setTimeout((function(){a=!1}),500),hideDOMLabel(),!window.hasMouse&&o||window.hasMouse&&!s))if(i.selectingStack){var c=i.findTopBlock(t);i.selectedStack=c,i.selectingStack=!1}else if("media"===e.name)e._doOpenMedia(t);else if("loadFile"===e.name)e._doOpenMedia(t);else if(-1!==SPECIALINPUTS.indexOf(e.name))e.trash||e._changeLabel();else if(!i.inLongPress){c=i.findTopBlock(t);console.log("running from "+i.blockList[c].name),i.logo.runLogoCommands(c)}})),this.container.on("mousedown",(function(a){if(null==e.connections[0]){var n=new Date;i.mouseDownTime=n.getTime(),i.longPressTimeout=setTimeout((function(){i.triggerLongPress(e)}),1500)}trashcan.show(),i.raiseStackToTop(t),null!=e.collapseContainer&&i.stage.setChildIndex(e.collapseContainer,i.stage.getNumChildren()-1),s=!1;var c=e.container.x-Math.round(a.stageX/i.blockScale),h=e.container.y-Math.round(a.stageY/i.blockScale);e.container.on("mouseout",(function(t){l||(i.inLongPress||e._mouseoutCallback(t,s,l,!0),s=!1)})),e.container.on("pressup",(function(t){l||(i.inLongPress||e._mouseoutCallback(t,s,l,!0),s=!1)}));var r=a.stageX/i.blockScale,p=a.stageY/i.blockScale;e.container.on("pressmove",(function(l){l.nativeEvent.preventDefault(),null!=i.longPressTimeout&&(clearTimeout(i.longPressTimeout),i.longPressTimeout=null),s||null==e.label||(e.label.style.display="none"),window.hasMouse?s=!0:setTimeout((function(){s=Math.abs(l.stageX/i.blockScale-r)+Math.abs(l.stageY/i.blockScale-p)>20&&!window.hasMouse,o=!s}),200);var a=e.container.x,n=e.container.y,u=Math.round(Math.round(l.stageX/i.blockScale)+c-a),d=Math.round(Math.round(l.stageY/i.blockScale)+h-n),b=n+d;if(0===i.stage.y&&b<45*i.blockScale&&(d+=45*i.blockScale-b),i.moveBlockRelative(t,u,d),trashcan.overTrashcan(l.stageX/i.blockScale,l.stageY/i.blockScale)?trashcan.startHighlightAnimation():trashcan.stopHighlightAnimation(),e.isValueBlock()&&"media"!==e.name){var m=e.container.getNumChildren()-1;e.container.setChildIndex(e.text,m)}else null!=e.collapseContainer&&e._positionCollapseContainer(e.protoblock.scale);if(i.findDragGroup(t),i.dragGroup.length>0)for(var g=0;g<i.dragGroup.length;g++){var k=i.dragGroup[g];0!==g&&i.moveBlockRelative(k,u,d)}i.refreshCanvas()}))})),this.container.on("mouseout",(function(t){i.inLongPress||e._mouseoutCallback(t,s,l,!0),s=!1})),this.container.on("pressup",(function(t){i.inLongPress||e._mouseoutCallback(t,s,l,!1),s=!1}))},this._mouseoutCallback=function(e,i,l,s){var a=this.blocks.blockList.indexOf(this);if(trashcan.hide(),null!=this.blocks.longPressTimeout&&(clearTimeout(this.blocks.longPressTimeout),this.blocks.longPressTimeout=null),i)if(trashcan.overTrashcan(e.stageX/t.blockScale,e.stageY/t.blockScale))trashcan.isVisible&&t.sendStackToTrash(this);else{var o=new Date;t.mouseDownTime=o.getTime(),this.blocks.blockMoved(a),this.blocks.adjustDocks(this.blocks.blockList.indexOf(this),!0)}else if(-1!==SPECIALINPUTS.indexOf(this.name)||-1!==["media","loadFile"].indexOf(this.name)){if(!l)if((o=new Date).getTime()-t.mouseDownTime<500&&!this.trash){o=new Date;t.mouseDownTime=o.getTime(),"media"===this.name||"loadFile"===this.name?this._doOpenMedia(a):this._changeLabel()}}s&&(null!=this.bounds&&(e.stageX/t.blockScale<this.container.x||e.stageX/t.blockScale>this.container.x+this.bounds.width||e.stageY/t.blockScale<this.container.y||e.stageY/t.blockScale>this.container.y+this.bounds.height)?(this._labelChanged(),hideDOMLabel(),this.blocks.unhighlight(null),this.blocks.refreshCanvas()):this.blocks.activeBlock!==a&&(hideDOMLabel(),this.blocks.unhighlight(null),this.blocks.refreshCanvas()),this.blocks.activeBlock=null)},this._ensureDecorationOnTop=function(){for(var e=0;e<this.container.getNumChildren();e++)if("decoration"===this.container.children[e].name){if("drum"===this.name){var t=this.container.getBounds();if(this.collapsed)var i=25*this.protoblock.scale/2;else i=0;for(var l=0;l<this.blocks.turtles.turtleList.length;l++)if(this.blocks.turtles.turtleList[l].startBlock===this){this.blocks.turtles.turtleList[l].decorationBitmap.x=t.width-i-50*this.protoblock.scale/2;break}}this.container.setChildIndex(this.container.children[e],this.container.getNumChildren()-1);break}},this._changeLabel=function(){var e=this,t=this.blocks,i=this.container.x,l=this.container.y,s=t.canvas.offsetLeft+28*t.blockScale,a=t.canvas.offsetTop+6*t.blockScale,o=!1;if(!window.hasMouse&&t.stage.y+l>75){o=!0;var n=t.stage.y;t.stage.y=75-l}var c=this.label?this.label.value:this.value,h=docById("labelDiv");if("text"===this.name){h.innerHTML='<input id="textLabel" style="position: absolute; -webkit-user-select: text;-moz-user-select: text;-ms-user-select: text;" class="text" type="text" value="'+c+'" />',h.classList.add("hasKeyboard"),this.label=docById("textLabel")}else if("solfege"===this.name){for(var r=(m=splitSolfege(this.value))[0],p=m[1],u=_("ti la sol fa mi re do").split(" "),d='<select name="solfege" id="solfegeLabel" style="position: absolute;  background-color: #88e20a; width: 100px;">',b=0;b<SOLFNOTES.length;b++)r===u[b]||r===SOLFNOTES[b]?d+='<option value="'+SOLFNOTES[b]+'" selected>'+u[b]+"</option>":d+='<option value="'+SOLFNOTES[b]+'">'+u[b]+"</option>";d+="</select>",""===p&&(p="♮"),d+='<select name="noteattr" id="noteattrLabel" style="position: absolute;  background-color: #88e20a; width: 60px;">';for(b=0;b<SOLFATTRS.length;b++)p===SOLFATTRS[b]?d+='<option value="'+p+'" selected>'+p+"</option>":d+='<option value="'+SOLFATTRS[b]+'">'+SOLFATTRS[b]+"</option>";d+="</select>",h.innerHTML=d,this.label=docById("solfegeLabel"),this.labelattr=docById("noteattrLabel")}else if("eastindiansolfege"===this.name){var m=splitSolfege(this.value),g=(r=WESTERN2EISOLFEGENAMES[m[0]],p=m[1],["ni","dha","pa","ma","ga","re","sa"]);for(d='<select name="solfege" id="solfegeLabel" style="position: absolute;  background-color: #88e20a; width: 100px;">',b=0;b<SOLFNOTES.length;b++)r===g[b]||r===WESTERN2EISOLFEGENAMES[SOLFNOTES[b]]?d+='<option value="'+SOLFNOTES[b]+'" selected>'+g[b]+"</option>":d+='<option value="'+SOLFNOTES[b]+'">'+g[b]+"</option>";d+="</select>",""===p&&(p="♮"),d+='<select name="noteattr" id="noteattrLabel" style="position: absolute;  background-color: #88e20a; width: 60px;">';for(b=0;b<SOLFATTRS.length;b++)p===SOLFATTRS[b]?d+='<option value="'+p+'" selected>'+p+"</option>":d+='<option value="'+SOLFATTRS[b]+'">'+SOLFATTRS[b]+"</option>";d+="</select>",h.innerHTML=d,this.label=docById("solfegeLabel"),this.labelattr=docById("noteattrLabel")}else if("notename"===this.name){const e=["B","A","G","F","E","D","C"],t=["♯♯","♯","♮","♭","♭♭"];if(null!=this.value){r=this.value[0];if(1===this.value.length)p="♮";else if(2===this.value.length)p=this.value[1];else p=this.value[1]+this.value[1]}else r="G",p="♮";for(d='<select name="notename" id="notenameLabel" style="position: absolute;  background-color: #88e20a; width: 60px;">',b=0;b<e.length;b++)r===e[b]?d+='<option value="'+r+'" selected>'+r+"</option>":d+='<option value="'+e[b]+'">'+e[b]+"</option>";d+="</select>",""===p&&(p="♮"),d+='<select name="noteattr" id="noteattrLabel" style="position: absolute;  background-color: #88e20a; width: 60px;">';for(b=0;b<t.length;b++)p===t[b]?d+='<option value="'+p+'" selected>'+p+"</option>":d+='<option value="'+t[b]+'">'+t[b]+"</option>";d+="</select>",h.innerHTML=d,this.label=docById("notenameLabel"),this.labelattr=docById("noteattrLabel")}else if("modename"===this.name){if(null!=this.value)var k=this.value[0];else k=getModeName(DEFAULTMODE);for(d='<select name="modename" id="modenameLabel" style="position: absolute;  background-color: #88e20a; width: 60px;">',b=0;b<MODENAMES.length;b++)0===MODENAMES[b][0].length?d+='<option value="'+MODENAMES[b][1]+'">'+MODENAMES[b][1]+"</option>":r===MODENAMES[b][0]||r===MODENAMES[b][1]?d+='<option value="'+k+'" selected>'+k+"</option>":d+='<option value="'+MODENAMES[b][0]+'">'+MODENAMES[b][0]+"</option>";d+="</select>",h.innerHTML=d,this.label=docById("modenameLabel")}else if("drumname"===this.name){if(null!=this.value)var f=getDrumName(this.value);else f=getDrumName(DEFAULTDRUM);for(d='<select name="drumname" id="drumnameLabel" style="position: absolute;  background-color: #00b0a4; width: 60px;">',b=0;b<DRUMNAMES.length;b++)0===DRUMNAMES[b][0].length?d+='<option value="'+DRUMNAMES[b][1]+'">'+DRUMNAMES[b][1]+"</option>":f===DRUMNAMES[b][0]||f===DRUMNAMES[b][1]?d+='<option value="'+f+'" selected>'+f+"</option>":d+='<option value="'+DRUMNAMES[b][0]+'">'+DRUMNAMES[b][0]+"</option>";d+="</select>",h.innerHTML=d,this.label=docById("drumnameLabel")}else if("voicename"===this.name){if(null!=this.value)var v=getVoiceName(this.value);else v=getVoiceName(DEFAULTVOICE);for(d='<select name="voicename" id="voicenameLabel" style="position: absolute;  background-color: #00b0a4; width: 60px;">',b=0;b<VOICENAMES.length;b++)0===VOICENAMES[b][0].length?d+='<option value="'+VOICENAMES[b][1]+'">'+VOICENAMES[b][1]+"</option>":v===VOICENAMES[b][0]||v===VOICENAMES[b][1]?d+='<option value="'+v+'" selected>'+v+"</option>":d+='<option value="'+VOICENAMES[b][0]+'">'+VOICENAMES[b][0]+"</option>";d+="</select>",h.innerHTML=d,this.label=docById("voicenameLabel")}else{h.innerHTML='<input id="numberLabel" style="position: absolute; -webkit-user-select: text;-moz-user-select: text;-ms-user-select: text;" class="number" type="number" value="'+c+'" />',h.classList.add("hasKeyboard"),this.label=docById("numberLabel")}var C=!1,__blur=function(i){C&&(e._labelChanged(),i.preventDefault(),h.classList.remove("hasKeyboard"),window.scroll(0,0),e.label.removeEventListener("keypress",__keypress),o&&(t.stage.y=n,t.updateStage()))};"text"!==this.name&&"number"!==this.name||this.label.addEventListener("blur",__blur);var __keypress=function(e){-1!==[13,10,9].indexOf(e.keyCode)&&__blur(e)};this.label.addEventListener("keypress",__keypress),this.label.addEventListener("change",(function(){e._labelChanged()})),null!=this.labelattr&&this.labelattr.addEventListener("change",(function(){e._labelChanged()})),this.label.style.left=Math.round((i+t.stage.x)*t.blockScale+s)+"px",this.label.style.top=Math.round((l+t.stage.y)*t.blockScale+a)+"px",null!=this.labelattr?(this.label.style.width=Math.round(60*t.blockScale)*this.protoblock.scale/2+"px",this.labelattr.style.left=Math.round((i+t.stage.x+60)*t.blockScale+s)+"px",this.labelattr.style.top=Math.round((l+t.stage.y)*t.blockScale+a)+"px",this.labelattr.style.width=Math.round(60*t.blockScale)*this.protoblock.scale/2+"px",this.labelattr.style.fontSize=Math.round(20*t.blockScale*this.protoblock.scale/2)+"px"):this.label.style.width=Math.round(100*t.blockScale)*this.protoblock.scale/2+"px",this.label.style.fontSize=Math.round(20*t.blockScale*this.protoblock.scale/2)+"px",this.label.style.display="",this.label.focus(),setTimeout((function(){e.label.style.display="",e.label.focus(),C=!0}),100)},this._labelChanged=function(){if(null!=this&&null!=this.label){this._label_lock=!0,this.label.style.display="none",null!=this.labelattr&&(this.labelattr.style.display="none");var e=this.value;""===this.label.value&&(this.label.value="_");var i=this.label.value;if(null!=this.labelattr){var l=this.labelattr.value;switch(l){case"♯♯":case"♯":case"♭♭":case"♭":i+=l}}if(e!==i){var s=this.connections[0];if("text"===this.name&&null!=s)switch(this.blocks.blockList[s].name){case"action":var a=this;setTimeout((function(){a.blocks.palettes.removeActionPrototype(e)}),1e3);var o=this.blocks.findUniqueActionName(i);if(o!==i)i=o,this.value=i,(h=this.value.toString()).length>8&&(h=h.substr(0,7)+"..."),this.text.text=h,this.label.value=i,this.updateCache()}if("number"===this.name){if(this.value=Number(i),isNaN(this.value)){var n=this.blocks.blockList.indexOf(this);this.blocks.errorMsg(i+": Not a number",n),this.blocks.refreshCanvas(),this.value=e}}else this.value=i;if("solfege"===this.name){var c=splitSolfege(this.value),h=i18nSolfege(c[0]);"♮"!==(r=c[1])&&(h+=r)}else if("eastindiansolfege"===this.name){var r;c=splitSolfege(this.value),h=WESTERN2EISOLFEGENAMES[c[0]];"♮"!==(r=c[1])&&(h+=r)}else h=this.value.toString();h.length>8&&(h=h.substr(0,7)+"..."),this.text.text=h,this.label.style.display="none";var p=this.container.getNumChildren()-1;this.container.setChildIndex(this.text,p),this.updateCache();s=this.connections[0];if("text"===this.name&&null!=s)switch(this.blocks.blockList[s].name){case"action":this.blocks.renameDos(e,i),e===_("action")&&(this.blocks.newNameddoBlock(i,this.blocks.actionHasReturn(s),this.blocks.actionHasArgs(s)),this.blocks.setActionProtoVisiblity(!1)),this.blocks.newNameddoBlock(i,this.blocks.actionHasReturn(s),this.blocks.actionHasArgs(s));for(var u=t.palettes.dict.action,d=0;d<u.protoList.length;d++){var b=u.protoList[d];e===_("action")?"nameddo"===b.name&&0===b.defaults.length&&(b.hidden=!0):"nameddo"===b.name&&b.defaults[0]===e&&u.remove(b,e)}e===_("action")&&(this.blocks.newNameddoBlock(i,this.blocks.actionHasReturn(s),this.blocks.actionHasArgs(s)),this.blocks.setActionProtoVisiblity(!1)),this.blocks.renameNameddos(e,i),this.blocks.palettes.hide(),this.blocks.palettes.updatePalettes("action"),this.blocks.palettes.show();break;case"storein":"box"!==this.value&&(this.blocks.newStoreinBlock(this.value),this.blocks.newNamedboxBlock(this.value)),this.blocks.renameBoxes(e,i),this.blocks.renameNamedboxes(e,i),this.blocks.palettes.hide(),this.blocks.palettes.updatePalettes("boxes"),this.blocks.palettes.show();break;case"setdrum":case"playdrum":_THIS_IS_MUSIC_BLOCKS_&&"http"===i.slice(0,4)&&this.blocks.logo.synth.loadSynth(i)}this._label_lock=!1,_THIS_IS_MUSIC_BLOCKS_&&("drumname"===this.name?this.blocks.logo.synth.loadSynth(getDrumSynthName(this.value)):"voicename"===this.name&&this.blocks.logo.synth.loadSynth(getVoiceSynthName(this.value)))}else this._label_lock=!1}else this._label_lock=!1}):console.log("null protoblock sent to Block")}function $(){for(var e=new Array,t=0;t<arguments.length;t++){var i=arguments[t];if("string"==typeof i&&(i=docById(i)),1===arguments.length)return i;e.push(i)}return e}function _makeBitmap(e,t,i,l){var s=new Image;s.onload=function(){var e=new createjs.Bitmap(s);i(t,e,l)},s.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(e)))}window.hasMouse=!1,document.addEventListener("mousemove",(function(e){window.hasMouse=!0}));