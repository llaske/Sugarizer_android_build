const _THIS_IS_MUSIC_BLOCKS_=!1,_THIS_IS_TURTLE_BLOCKS_=!0;function facebookInit(){window.fbAsyncInit=function(){FB.init({appId:"1496189893985945",xfbml:!0,version:"v2.1"})}}try{!function(e,t,a){var o,n=e.getElementsByTagName(t)[0];e.getElementById(a)||((o=e.createElement(t)).id=a,o.src="https://connect.facebook.net/en_US/sdk.js",n.parentNode.insertBefore(o,n))}(document,"script","facebook-jssdk")}catch(e){}var lang=document.webL10n.getLanguage();-1!==lang.indexOf("-")&&(lang=lang.slice(0,lang.indexOf("-")),document.webL10n.setLanguage(lang)),MYDEFINES=["activity/sugarizer-compatibility","activity/platformstyle","easeljs-0.8.2.min","tweenjs-0.6.2.min","preloadjs-0.6.2.min","howler","p5.min","p5.sound.min","p5.dom.min","mespeak","Chart","activity/utils","activity/artwork","activity/status","activity/munsell","activity/trash","activity/boundary","activity/turtle","activity/palette","activity/protoblocks","activity/blocks","activity/block","activity/turtledefs","activity/logo","activity/clearbox","activity/savebox","activity/utilitybox","activity/samplesviewer","activity/basicblocks","activity/blockfactory","activity/analytics","activity/macros","activity/musicutils","activity/lilypond","prefixfree.min"],define(MYDEFINES,(function(e){function domReady(e){createDefaultStack(),createHelpContent(),window.scroll(0,0);try{meSpeak.loadConfig("lib/mespeak_config.json");var t=document.webL10n.getLanguage();sugarizerCompatibility.isInsideSugarizer()&&(t=sugarizerCompatibility.getLanguage()),-1!==["es","ca","de","el","eo","fi","fr","hu","it","kn","la","lv","nl","pl","pt","ro","sk","sv","tr","zh"].indexOf(t)?meSpeak.loadVoice("lib/voices/"+t+".json"):meSpeak.loadVoice("lib/voices/en/en.json")}catch(e){console.log(e)}var a=docById("myCanvas");new createjs.LoadQueue(!1);if(window.File&&window.FileReader&&window.FileList&&window.Blob);else{alert("The File APIs are not fully supported in this browser.")}var o,i,l,s,r,c,d,u,v,g=docById("myOpenFile"),h=docById("myOpenPlugin"),p=docById("myOpenAll"),m=!0,f=1,C=!0,b=null,y=!0,S=null,k=!1,w=0,L=null,T=null,B=null;for(var E in PALETTECOLORS)PALETTEFILLCOLORS[E]=getMunsellColor(PALETTECOLORS[E][0],PALETTECOLORS[E][1],PALETTECOLORS[E][2]),PALETTESTROKECOLORS[E]=getMunsellColor(PALETTECOLORS[E][0],PALETTECOLORS[E][1]-30,PALETTECOLORS[E][2]),PALETTEHIGHLIGHTCOLORS[E]=getMunsellColor(PALETTECOLORS[E][0],PALETTECOLORS[E][1]+10,PALETTECOLORS[E][2]),HIGHLIGHTSTROKECOLORS[E]=getMunsellColor(PALETTECOLORS[E][0],PALETTECOLORS[E][1]-50,PALETTECOLORS[E][2]);pluginObjs={PALETTEPLUGINS:{},PALETTEFILLCOLORS:{},PALETTESTROKECOLORS:{},PALETTEHIGHLIGHTCOLORS:{},FLOWPLUGINS:{},ARGPLUGINS:{},BLOCKPLUGINS:{},ONLOAD:{},ONSTART:{},ONSTOP:{}};var x={},O=null,R=[];const P=[1,1.5,2,3,4];var I=P.indexOf(DEFAULTBLOCKSCALE);-1===I&&(I=1);var M=!1,D=0,A=0,N=1200===screen.width&&900===screen.height||900===screen.width&&1200===screen.height,j=55;N&&(j=75);var H=[],G=[],F=null,z=null,Y=null,U=0,K=!0;function _findBlocks(){r.showBlocks(),blocksContainer.x=0,blocksContainer.y=0,l.initial_x=55,l.initial_y=55,l.updatePalettes();var e=100*f,t=100*f;for(var o in s.blockList)if(!s.blockList[o].trash){var n=s.blockList[o];if(null==n.connections[0]){var i=e-n.container.x,c=t-n.container.y;if(s.moveBlockRelative(o,i,c),s.findDragGroup(o),s.dragGroup.length>0)for(var d=0;d<s.dragGroup.length;d++){var u=s.dragGroup[d];0!==d&&s.moveBlockRelative(u,i,c)}(e+=200*f)>(a.width-100)/f&&(e=100*f,t+=100*f)}}R[0].visible=!1,R[1].visible=!0,boundary.hide()}function _allClear(){null!=B&&(o.removeChild(B),B=null),r.boxes={},r.time=0,hideMsgs(),r.setBackgroundColor(-1),r.lilypondOutput=LILYPONDHEADER;for(var e=0;e<i.turtleList.length;e++)r.turtleHeaps[e]=[],r.lilypondStaging[e]=[],i.turtleList[e].doClear(!0,!0);blocksContainer.x=0,blocksContainer.y=0,Element.prototype.remove=function(){this.parentElement.removeChild(this)},NodeList.prototype.remove=HTMLCollection.prototype.remove=function(){for(var e=0,t=this.length;e<t;e++)this[e]&&this[e].parentElement&&this[e].parentElement.removeChild(this[e])};var t=document.getElementById("myTable");null!=t&&t.remove()}function _doFastButton(e){var t=r.turtleDelay;r.setTurtleDelay(0),i.running()?0!==t?(console.log("running from step"),r.step()):(console.log("stopping..."),r.doStopTurtle(),setTimeout((function(){console.log("and running"),r.runLogoCommands(null,e)}),500)):(console.log("running"),r.runLogoCommands(null,e))}function _doSlowButton(){r.setTurtleDelay(500),i.running()?r.step():r.runLogoCommands()}function _doStepButton(){var e=0;for(var t in r.stepQueue)e+=1;0===e||-1!==r.turtleDelay?(r.setTurtleDelay(-1),i.running()||r.runLogoCommands(),r.step()):(r.setTurtleDelay(-1),r.step())}pluginsImages={},console.log("initing i18n for music terms"),initDrumI18N(),initModeI18N(),initVoiceI18N(),window.onblur=function(){r.doStopTurtle()};function doStopButton(){r.doStopTurtle()}var X=!1;function _doCartesian(){X?(!function _hideCartesian(){J.visible=!1,J.updateCache(),q=!0}(),X=!1):(!function _showCartesian(){J.visible=!0,J.updateCache(),q=!0}(),X=!0)}var V=!1;function _doPolar(){V?(!function _hidePolar(){W.visible=!1,W.updateCache(),q=!0}(),V=!1):(!function _showPolar(){W.visible=!0,W.updateCache(),q=!0}(),V=!0)}function toggleScroller(){k=!k}function closeAnalytics(e,t){var n=this;n.x=a.width/(2*f)+300/Math.sqrt(2),n.y=300-300/Math.sqrt(2),this.closeButton=_makeButton("cancel-button",_("Close"),n.x,n.y,55,0),this.closeButton.on("click",(function(a){console.log("Deleting Chart"),n.closeButton.visible=!1,o.removeChild(e),r.showBlocks(),q=!0,t.clearRect(0,0,600,600)}))}function doAnalytics(){var e=docById("myChart");if(0!=function _isCanvasBlank(e){var t=document.createElement("canvas");return t.width=e.width,t.height=e.height,e.toDataURL()==t.toDataURL()}(e)){var t=e.getContext("2d");document.body.style.cursor="wait";var n=null,i=analyzeProject(s);console.log(i);var l=scoreToChartData(i),c=this;c.close=closeAnalytics;var d=getChartOptions((function(){var e=n.toBase64Image(),i=new Image;i.onload=function(){var e=new createjs.Bitmap(i);o.addChild(e),e.x=a.width/(2*f)-300,e.y=0,e.scaleX=e.scaleY=e.scale=600/e.image.width,r.hideBlocks(),q=!0,document.body.style.cursor="default",c.close(e,t)},i.src=e}));console.log("creating new chart"),n=new Chart(t).Radar(l,d)}}function doBiggerFont(){I<P.length-1&&(I+=1,s.setBlockScale(P[I]))}function doSmallerFont(){I>0&&(I-=1,s.setBlockScale(P[I]))}var q=!0,J=null,W=null,Q=null,Z=null,$=null,ee={};const te=["emptybox","emptyheap","negroot","noinput","zerodivide","notanumber","nostack","notastring","nomicrophone"];function scrollEvent(e){var t=e.wheelDelta||-e.detail,a=Math.max(-1,Math.min(1,t));e.clientX<j?(l.menuScrollEvent(a,30),l.hidePaletteIconCircles()):(palette=l.findPalette(e.clientX/f,e.clientY/f),palette&&palette.scrollEvent(a,30))}function getStageScale(){return f}function getStageX(){return i.screenX2turtleX(D/f)}function getStageY(){return i.screenY2turtleY(A/f)}function getStageMouseDown(){return M}function _createGrid(e){var t=new Image;t.src=e;var n=new createjs.Container;o.addChild(n);var i=new createjs.Bitmap(t);return n.addChild(i),i.cache(0,0,1200,900),i.x=(a.width-1200)/2,i.y=(a.height-900)/2,i.scaleX=i.scaleY=i.scale=1,i.visible=!1,i.updateCache(),i}function _createMsgContainer(e,t,n,i){var l=new createjs.Container;o.addChild(l),l.x=(a.width-1e3)/2,l.y=i,l.visible=!1;var r=new Image,c=MSGBLOCK.replace("fill_color",e).replace("stroke_color",t);r.onload=function(){var e=new createjs.Bitmap(r);l.addChild(e);var t=new createjs.Text("your message here","20px Arial","#000000");l.addChild(t),t.textAlign="center",t.textBaseline="alphabetic",t.x=500,t.y=30;var a=l.getBounds();l.cache(a.x,a.y,a.width,a.height);var o=new createjs.Shape;o.graphics.beginFill("#FFF").drawRect(0,0,1e3,42),o.x=0,o.y=0,l.hitArea=o,l.on("click",(function(e){l.visible=!1,null!=$&&$.removeAllChildren(),q=!0})),n(t),s.setMsgText(t)},r.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(c)))}function _makeErrorArtwork(e){var t=new createjs.Container;o.addChild(t),t.x=(a.width-1e3)/2,t.y=110,ee[e]=t,ee[e].name=e,ee[e].visible=!1;var n=new Image;n.onload=function(){var e=new createjs.Bitmap(n);t.addChild(e);var a=new createjs.Text("","20px Sans","#000000");t.addChild(a),a.x=70,a.y=10;var o=t.getBounds();t.cache(o.x,o.y,o.width,o.height);var i=new createjs.Shape;i.graphics.beginFill("#FFF").drawRect(0,0,o.width,o.height),i.x=0,i.y=0,t.hitArea=i,t.on("click",(function(e){t.visible=!1,null!=$&&$.removeAllChildren(),q=!0}))},n.src="images/"+e+".svg"}function __keyPressed(e){if(docById("labelDiv").classList.contains("hasKeyboard"))return;9!==e.keyCode&&8!==e.keyCode||e.preventDefault();if(e.altKey)switch(e.keyCode){case 69:_allClear();break;case 82:_doFastButton();break;case 83:r.doStopTurtle()}else if(e.ctrlKey);else{switch(e.keyCode){case 38:null!=s.activeBlock?(s.moveStackRelative(s.activeBlock,0,-STANDARDBLOCKHEIGHT/2),s.blockMoved(s.activeBlock),s.adjustDocks(s.activeBlock,!0)):l.mouseOver?(l.menuScrollEvent(1,10),l.hidePaletteIconCircles()):null!=l.activePalette?l.activePalette.scrollEvent(STANDARDBLOCKHEIGHT,1):k&&(blocksContainer.y-=21);break;case 40:null!=s.activeBlock?(s.moveStackRelative(s.activeBlock,0,STANDARDBLOCKHEIGHT/2),s.blockMoved(s.activeBlock),s.adjustDocks(s.activeBlock,!0)):l.mouseOver?(l.menuScrollEvent(-1,10),l.hidePaletteIconCircles()):null!=l.activePalette?l.activePalette.scrollEvent(-STANDARDBLOCKHEIGHT,1):k&&(blocksContainer.y+=21);break;case 37:null!=s.activeBlock?(s.moveStackRelative(s.activeBlock,-STANDARDBLOCKHEIGHT/2,0),s.blockMoved(s.activeBlock),s.adjustDocks(s.activeBlock,!0)):k&&(blocksContainer.x-=21);break;case 39:null!=s.activeBlock?(s.moveStackRelative(s.activeBlock,STANDARDBLOCKHEIGHT/2,0),s.blockMoved(s.activeBlock),s.adjustDocks(s.activeBlock,!0)):k&&(blocksContainer.x+=21);break;case 36:if(l.mouseOver){var t=Math.max(55-l.buttons.rhythm.y,0);l.menuScrollEvent(1,t),l.hidePaletteIconCircles()}else null!=l.activePalette?l.activePalette.scrollEvent(-l.activePalette.scrollDiff,1):_findBlocks();break;case 9:break;case 27:!function _toggleToolbar(){for(var e in C=!C,S.visible=C,b.visible=C,H)H[e].visible=C;for(var e in G)G[e].visible=C;q=!0}();break;case 13:r.runLogoCommands()}String.fromCharCode(e.keyCode),w=e.keyCode}}function getCurrentKeyCode(){return w}function clearCurrentKeyCode(){"",w=0}function _onResize(){if(!docById("labelDiv").classList.contains("hasKeyboard")){if(platform.androidWebkit)e=window.outerWidth,t=window.outerHeight;else var e=window.innerWidth,t=window.innerHeight;var n=Math.min(e,t);if(n<11*j){var r=!0;f=e<10*j?n/(11*j):Math.max(n/(11*j),.75)}else{r=!1;f=e/1200>t/900?e/1200:t/900}o.scaleX=f,o.scaleY=f,o.canvas.width=e,o.canvas.height=t,i.setScale(f),s.setScale(f),boundary.setScale(e,t,f),l.setScale(f),trashcan.resizeEvent(f),_setupAndroidToolbar(r),J.x=a.width/(2*f)-600,J.y=a.height/(2*f)-450,W.x=a.width/(2*f)-600,W.y=a.height/(2*f)-450,q=!0,_showHelp(!0),r?(l.setMobile(!0),l.hide()):(l.setMobile(!1),l.show(),l.bringToTop());for(var c=0;c<i.turtleList.length;c++)i.turtleList[c].doClear(!1,!1);var d=document.getElementById("overlayCanvas");d.width=e,d.height=t}}function _restoreTrash(){for(var e in s.palettes.dict)s.palettes.dict[e].hideMenu(!0);refreshCanvas();var t=3*-j;if(0!==s.trashStacks.length){var a=s.trashStacks.pop();s.findDragGroup(a);for(var o=0;o<s.dragGroup.length;o++){var n=s.dragGroup[o];s.blockList[n].trash=!1,s.moveBlockRelative(n,0,t),s.blockList[n].show()}if(s.raiseStackToTop(a),"start"===s.blockList[a].name||"drum"===s.blockList[a].name){var l=s.blockList[a].value;i.turtleList[l].trash=!1,i.turtleList[l].container.visible=!0}else if("action"===s.blockList[a].name){var r=s.blockList[s.blockList[a].connections[1]];if(null!=r){var c=r.value;s.blockList[a].trash=!0;var d=s.findUniqueActionName(c);if(s.blockList[a].trash=!1,d!==r){console.log("renaming action when restoring from trash. old name: "+c+" unique name: "+d),r.value=d,(u=r.value.toString()).length>8&&(u=u.substr(0,7)+"..."),r.text.text=u,null!=r.label&&(r.label.value=d),r.container.updateCache();for(o=0;o<s.dragGroup.length;o++){var u,v=s.blockList[s.dragGroup[o]];if(-1!==["nameddo","nameddoArg","namedcalc","namedcalcArg"].indexOf(v.name)&&v.privateData===c)console.log("reassigning nameddo to "+d),v.privateData=d,v.value=d,(u=v.value.toString()).length>8&&(u=u.substr(0,7)+"..."),v.text.text=u,v.overrideName=u,v.regenerateArtwork(),v.container.updateCache()}}r.value!==_("action")&&console.log("FIXME: Check for unique action name here")}}s.refreshCanvas()}else console.log("Trash is empty--nothing to do")}function _deleteBlocksBox(){c.show(f)}function _doUtilityBox(){d.init(f,F.x-27,F.y,_makeButton)}function sendAllToTrash(e,t){for(var a in s.palettes.dict)s.palettes.dict[a].hideMenu(!0);refreshCanvas();var o=3*j;for(var n in s.blockList){if(null==s.blockList[n].connections[0]&&s.trashStacks.push(n),"start"===s.blockList[n].name||"drum"===s.blockList[n].name){console.log("start blk "+n+" value is "+s.blockList[n].value);var l=s.blockList[n].value;s.blockList[n].trash||null==l||(console.log("sending turtle "+l+" to trash"),i.turtleList[l].trash=!0,i.turtleList[l].container.visible=!1)}else"action"===s.blockList[n].name&&(s.blockList[n].trash||s.deleteActionBlock(s.blockList[n]));s.blockList[n].trash=!0,s.moveBlockRelative(n,0,o),s.blockList[n].hide()}e?s.loadNewBlocks(DATAOBJS):t||saveLocally(),q=!0}function _changeBlockVisibility(){s.visible?(r.hideBlocks(),l.hide()):(null!=B&&(o.removeChild(B),B=null),r.showBlocks(),l.show(),l.bringToTop())}function _toggleCollapsibleStacks(){s.visible&&(console.log("calling toggleCollapsibles"),s.toggleCollapsibles())}function onStopTurtle(){O.visible&&_hideStopButton()}function onRunTurtle(){O.visible||function _showStopButton(){O.visible=!0}()}function refreshCanvas(){q=!0}function __tick(e){q&&(q=!1,o.update(e))}function _doOpenSamples(){localStorage.setItem("isStatusHidden",docById("statusDiv").style.visibility),r.doStopTurtle(),Y.visible=!1,docById("helpElem").style.visibility="hidden",console.log("save locally"),saveLocally(),u.show()}function doSave(){v.init(f,z.x-27,z.y-97,_makeButton)}function doSaveTB(){var e=prompt("Filename:","untitled.tb");null!=e&&("tb"!==fileExt(e)&&(e+=".tb"),download(e,"data:text/plain;charset=utf-8,"+encodeURIComponent(prepareExport())))}function doSaveSVG(){var e=prompt("Filename:","untitled.svg");if(null!=e){"svg"!==fileExt(e)&&(e+=".svg");var t=doSVG(r.canvas,r,r.turtles,r.canvas.width,r.canvas.height,1);download(e,"data:image/svg+xml;utf8,"+t,e,'"width='+r.canvas.width+", height="+r.canvas.height+'"')}}function doSavePNG(){alert("Unavailable at the moment")}function doUploadToPlanet(){saveLocally(),u.show()}function doShareOnFacebook(){alert("Facebook Sharing : disabled")}function doLoad(){console.log("Loading .tb file"),document.querySelector("#myOpenFile").focus(),document.querySelector("#myOpenFile").click(),window.scroll(0,0)}function saveLocally(){if(sugarizerCompatibility.isInsideSugarizer()?storage=sugarizerCompatibility.data:storage=localStorage,console.log("overwriting session data"),void 0===storage.currentProject)try{storage.currentProject="My Project",storage.allProjects=JSON.stringify(["My Project"])}catch(e){console.log(e)}try{var e=storage.currentProject;storage["SESSION"+e]=prepareExport()}catch(e){console.log(e)}var t=new Image,o=doSVG(a,r,i,320,240,320/a.width);t.onload=function(){var a=new createjs.Bitmap(t),o=a.getBounds();a.cache(o.x,o.y,o.width,o.height);try{storage["SESSIONIMAGE"+e]=a.getCacheDataURL()}catch(e){console.log(e)}},t.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(o))),sugarizerCompatibility.isInsideSugarizer()&&sugarizerCompatibility.saveLocally()}function runProject(e){console.log("Running Project from Event"),document.removeEventListener("finishedLoading",runProject),setTimeout((function(){console.log("Run"),_changeBlockVisibility(),_doFastButton(e)}),5e3)}function loadProject(e,t,a){t=void 0!==t&&t,document.body.style.cursor="wait",setTimeout((function(){"tb"!==fileExt(e)&&(e+=".tb");try{try{httpGet(null),console.log("running from server or the user can access to examples."),m=!0}catch(e){console.log("running from filesystem or the connection isnt secure"),m=!1}if(m)var t=httpGet(e).replace("\n","");for(var a in s.palettes.dict)s.palettes.dict[a].hideMenu(!0);var o=JSON.parse(t);s.loadNewBlocks(o),saveLocally()}catch(e){console.log(e),loadStartWrapper(_loadStart)}document.body.style.cursor="default",q=!0}),200),t&&K&&(document.addEventListener?document.addEventListener("finishedLoading",(function(){runProject(a)}),!1):document.attachEvent("finishedLoading",(function(){runProject(a)}))),K=!1}function loadRawProject(e){for(var t in console.log("loadRawProject "+e),document.body.style.cursor="wait",_allClear(),s.palettes.dict)s.palettes.dict[t].hideMenu(!0);var a=JSON.parse(e);s.loadNewBlocks(a),document.body.style.cursor="default"}function loadStartWrapper(e,t,a,o){var n=new Date;e(t,a,o);var i=(new Date).getTime()-n.getTime(),l=Math.max(6e3-i);setTimeout(showContents,l)}function showContents(){docById("loading-image-container").style.display="none",docById("hideContents").style.display="block"}function _loadStart(){console.log("LOAD START"),justLoadStart=function(){console.log("loading start and a matrix"),s.loadNewBlocks(DATAOBJS)},sugarizerCompatibility.isInsideSugarizer()?storage=sugarizerCompatibility.data:storage=localStorage,sessionData=null;var e=storage.currentProject;if(sessionData=storage["SESSION"+e],sessionData)try{if("undefined"===sessionData||"[]"===sessionData)console.log("empty session found: loading start"),justLoadStart();else{for(var t in console.log("restoring session: "+sessionData),s.palettes.dict)s.palettes.dict[t].hideMenu(!0);s.loadNewBlocks(JSON.parse(sessionData))}}catch(e){console.log(e)}else justLoadStart();q=!0}function hideMsgs(){for(var e in Z.parent.visible=!1,null!=$&&($.removeAllChildren(),refreshCanvas()),Q.parent.visible=!1,ee)ee[e].visible=!1}function textMsg(e){if(null!=Q){var t=Q.parent;t.visible=!0,Q.text=e,t.updateCache(),o.setChildIndex(t,o.getNumChildren()-1)}}function errorMsg(e,t,n){if(_hideStopButton(),null!=Z){if(void 0!==t&&null!=t&&!s.blockList[t].collapsed){var i=(a.width-1e3)/2,l=s.blockList[t].container.x+blocksContainer.x,r=s.blockList[t].container.y+blocksContainer.y;null==$&&($=new createjs.Container,o.addChild($));var c=new createjs.Shape;$.addChild(c),c.graphics.setStrokeStyle(4).beginStroke("#ff0031").moveTo(i,128).lineTo(l,r),o.setChildIndex($,o.getNumChildren()-1);var d=Math.atan2(l-i,128-r)/Math.PI*180,u=new createjs.Shape;$.addChild(u),u.graphics.setStrokeStyle(4).beginStroke("#ff0031").moveTo(-10,18).lineTo(0,0).lineTo(10,18),u.x=l,u.y=r,u.rotation=d}switch(e){case NOMICERRORMSG:ee.nomicrophone.visible=!0,o.setChildIndex(ee.nomicrophone,o.getNumChildren()-1);break;case NOSTRINGERRORMSG:ee.notastring.visible=!0,o.setChildIndex(ee.notastring,o.getNumChildren()-1);break;case EMPTYHEAPERRORMSG:ee.emptyheap.visible=!0,o.setChildIndex(ee.emptyheap,o.getNumChildren()-1);break;case NOSQRTERRORMSG:ee.negroot.visible=!0,o.setChildIndex(ee.negroot,o.getNumChildren()-1);break;case NOACTIONERRORMSG:null==n&&(n="foo"),ee.nostack.children[1].text=n,ee.nostack.visible=!0,ee.nostack.updateCache(),o.setChildIndex(ee.nostack,o.getNumChildren()-1);break;case NOBOXERRORMSG:null==n&&(n="foo"),ee.emptybox.children[1].text=n,ee.emptybox.visible=!0,ee.emptybox.updateCache(),o.setChildIndex(ee.emptybox,o.getNumChildren()-1);break;case ZERODIVIDEERRORMSG:ee.zerodivide.visible=!0,o.setChildIndex(ee.zerodivide,o.getNumChildren()-1);break;case NANERRORMSG:ee.notanumber.visible=!0,o.setChildIndex(ee.notanumber,o.getNumChildren()-1);break;case NOINPUTERRORMSG:ee.noinput.visible=!0,o.setChildIndex(ee.noinput,o.getNumChildren()-1);break;default:var v=Z.parent;v.visible=!0,Z.text=e,o.setChildIndex(v,o.getNumChildren()-1),v.updateCache()}q=!0}}function pasteStack(){s.pasteStack()}function prepareExport(){for(var e=[],t=0;t<s.blockList.length;t++){(o=s.blockList[t]).trash||e.push(t)}var a=[];for(t=0;t<s.blockList.length;t++){var o;if(!(o=s.blockList[t]).trash){if(o.isValueBlock()||"loadFile"===o.name)var n={value:o.value};else if("start"===o.name||"drum"===o.name){var l=i.turtleList[o.value];if(null==l)n={collapsed:!1,xcor:0,ycor:0,heading:0,color:0,shade:50,pensize:5,grey:100};else n={collapsed:o.collapsed,xcor:l.x,ycor:l.y,heading:l.orientation,color:l.color,shade:l.value,pensize:l.stroke,grey:l.chroma}}else if("action"===o.name)n={collapsed:o.collapsed};else if("matrix"===o.name)n={collapsed:o.collapsed};else if("pitchdrummatrix"===o.name)n={collapsed:o.collapsed};else if("status"===o.name)n={collapsed:o.collapsed};else if("namedbox"===o.name)n={value:o.privateData};else if("nameddo"===o.name)n={value:o.privateData};else if("nameddoArg"===o.name)n={value:o.privateData};else if("namedcalc"===o.name)n={value:o.privateData};else if("namedcalcArg"===o.name)n={value:o.privateData};else if("namedarg"===o.name)n={value:o.privateData};else if("matrixData"===o.name){n={notes:window.savedMatricesNotes,count:window.savedMatricesCount};!0}else n={};connections=[];for(var r=0;r<o.connections.length;r++){var c=e.indexOf(o.connections[r]);null==o.connections[r]||-1===c?connections.push(null):connections.push(c)}a.push([e.indexOf(t),[o.name,n],o.container.x,o.container.y,connections])}}return JSON.stringify(a)}function doOpenPlugin(){h.focus(),h.click()}function _hideStopButton(){O.visible=!1}function updatePasteButton(){if(null===T){var e=new Image;e.onload=function(){var t=Math.floor(j/2),a=new createjs.Bitmap(e);55!==j&&(a.scaleX=j/55,a.scaleY=j/55),a.regX=t/a.scaleX,a.regY=t/a.scaleY,L.addChild(a),T=a,q=!0},e.src="header-icons/paste-button.svg"}else!function blinkPasteButton(e){createjs.Tween.get(e).to({alpha:0,visible:!1},1e3).call((function handleComplete(){createjs.Tween.get(e).to({alpha:1,visible:!0},500)}))}(T)}function _setupAndroidToolbar(e){if(void 0!==b)for(var t in o.removeChild(b),H)o.removeChild(H[t]);(b=new createjs.Shape).graphics.f(platformColor.header).r(0,0,screen.width/f,j),platformColor.doHeaderShadow&&(b.shadow=new createjs.Shadow("#777",0,2,2)),o.addChild(b);var n=[["run",_doFastButton,_("Run fast / long press to run slowly"),_doSlowButton,null,"slow-button",null],["step",_doStepButton,_("Run step by step"),null,null,null,null],["stop-turtle",doStopButton,_("Stop"),null,null,null,null],["clear",_allClear,_("Clean"),null,null,null,null],["hide-blocks",_changeBlockVisibility,_("Show/hide blocks"),null,null,null,null],["collapse-blocks",_toggleCollapsibleStacks,_("Expand/collapse collapsable blocks"),null,null,null,null],["go-home",_findBlocks,_("Home"),null,null,null,null],["help",_showHelp,_("Help"),null,null,null,null]];sugarizerCompatibility.isInsideSugarizer()&&n.push(["sugarizer-stop",function(){sugarizerCompatibility.data.blocks=prepareExport(),sugarizerCompatibility.saveLocally((function(){sugarizerCompatibility.sugarizerStop()}))},"Stop",null,null,null,null]),e&&n.unshift(["popdown-palette",doPopdownPalette]);var i=j,l=Math.floor(i/2),r=l,c=i;for(t=0;t<n.length;t++)if(getMainToolbarButtonNames(n[t][0])){var d=_makeButton(n[t][0]+"-button",n[t][2],l,r,i,0);if(_loadButtonDragHandler(d,l,r,n[t][1],n[t][3],n[t][4],n[t][5],n[t][6]),H.push(d),"stop-turtle"===n[t][0])O=d,l,r;else if("go-home"===n[t][0]){(R=[]).push(d),l,r;var v=_makeButton("go-home-faded-button",_("Home"),l,r,i,0);_loadButtonDragHandler(v,l,r,n[t][1],null,null,null,null),R.push(v),H.push(v),R[0].visible=!1,R[1].visible=!0,boundary.hide(),s.setHomeContainers(R,boundary)}l+=c,r+=0}else console.log("continue");!function _setupRightMenu(e){if(void 0!==S)for(var t in o.removeChild(S),G)o.removeChild(G[t]);var n=[["planet",_doOpenSamples,_("Load samples from server")],["open",doLoad,_("Load project from files")],["save",doSave,_("Save project")],["paste-disabled",pasteStack,_("Paste")],["Cartesian",_doCartesian,_("Cartesian")],["polar",_doPolar,_("Polar")],["utility",_doUtilityBox,_("Settings")],["empty-trash",_deleteBlocksBox,_("Delete all")],["restore-trash",_restoreTrash,_("Undo")]];document.querySelector("#myOpenFile").addEventListener("change",(function(e){u.model.controller.hide()}));var i=j,l=Math.floor(a.width/e)-i/2,s=Math.floor(i/2),r=i;_loadButtonDragHandler(S=_makeButton("menu-button","",l,s,i,y?90:void 0),l,s,_doMenuButton,null,null,null,null);for(t=0;t<n.length;t++)if(getAuxToolbarButtonNames(n[t][0])){l+=0,s+=r;var c=_makeButton(n[t][0]+"-button",n[t][2],l,s,i,0);_loadButtonDragHandler(c,l,s,n[t][1],null,null,null,null),G.push(c),"utility"===n[t][0]?F=c:"save"===n[t][0]&&(z=c),c.visible=!1}if(y)for(var d in G)G[d].visible=!0}(f)}function doPopdownPalette(){console.log("doPopdownPalette"),new PopdownPalette(l).popdown()}function _showHelp(e){if(U=0,e){if(null==Y){Y=new createjs.Container,o.addChild(Y),Y.x=65,Y.y=65,Y.on("click",(function(e){var t=Y.getBounds();if(e.stageY<Y.y+t.height/2)Y.visible=!1,docById("helpElem").style.visibility="hidden";else{(U+=1)>=HELPCONTENT.length&&(U=0);var o=55*f;a.innerHTML='<img src ="'+HELPCONTENT[U][2]+'" style="height:'+o+'px; width: auto"></img> <h2>'+HELPCONTENT[U][0]+"</h2><p>"+HELPCONTENT[U][1]+"</p>"}q=!0}));var t=new Image;t.onload=function(){console.log(f);var e=new createjs.Bitmap(t);Y.children.length>0&&(console.log("delete old help container"),Y.removeChild(Y.children[0])),Y.addChild(e);var a=Y.getBounds(),o=new createjs.Shape;o.graphics.beginFill("#FFF").drawRect(a.x,a.y,a.width,a.height),o.x=0,o.y=0,Y.hitArea=o,docById("helpElem").innerHTML='<img src ="'+HELPCONTENT[U][2]+'"</img> <h2>'+HELPCONTENT[U][0]+"</h2><p>"+HELPCONTENT[U][1]+"</p>",doneTour||(docById("helpElem").style.visibility="visible"),q=!0},t.src="images/help-container.svg"}var a=docById("helpElem");a.style.position="absolute",a.style.display="block",a.style.paddingLeft=20*f+"px",a.style.paddingRight=20*f+"px",a.style.paddingTop="0px",a.style.paddingBottom=20*f+"px",a.style.fontSize="20px",a.style.color="#000000",a.style.left=65*f+"px",a.style.top=105*f+"px";var n=Math.min(300,300),i=Math.min(300,300);if(a.style.width=n+"px",a.style.height=i+"px",f>1)Y.children[0]}doneTour="true"===storage.doneTour,e&&doneTour?(docById("helpElem").style.visibility="hidden",Y.visible=!1):(sugarizerCompatibility.isInsideSugarizer()?sugarizerCompatibility.data.doneTour="true":storage.doneTour="true",docById("helpElem").innerHTML='<img src ="'+HELPCONTENT[U][2]+'"</img> <h2>'+HELPCONTENT[U][0]+"</h2><p>"+HELPCONTENT[U][1]+"</p>",docById("helpElem").style.visibility="visible",Y.visible=!0,q=!0,l.show(),y||doMenuAnimation(1))}function _doMenuButton(){_doMenuAnimation()}function _doMenuAnimation(){var e=last(S.children);if(null!=e){var t=e.rotation;createjs.Tween.get(e).to({rotation:t}).to({rotation:t+90},500)}else setTimeout(_doMenuAnimation,50);setTimeout((function(){if(y)for(var e in y=!1,G)G[e].visible=!1;else for(var e in y=!0,G)G[e].visible=!0;q=!0}),500)}function _makeButton(e,t,a,n,i,l,s){var r=new createjs.Container;"paste-disabled-button"===e&&(L=r),null==s?o.addChild(r):s.addChild(r),r.x=a,r.y=n;var c=new createjs.Text(t,"14px Sans","#282828");r.y<55?(r.x<55?(c.textAlign="left",c.x=-14):(c.textAlign="center",c.x=0),c.y=30):(c.textAlign="right",c.x=-28,c.y=0),c.visible=!1,r.on("mouseover",(function(e){for(var t=0;t<r.children.length;t++)if(null!=r.children[t].text){r.children[t].visible=!0;break}})),r.on("mouseout",(function(e){for(var t=0;t<r.children.length;t++)if(null!=r.children[t].text){r.children[t].visible=!1;break}}));var d=new Image;return d.onload=function(){var e=Math.floor(i/2),t=new createjs.Bitmap(d);55!==i&&(t.scaleX=i/55,t.scaleY=i/55),t.regX=e/t.scaleX,t.regY=e/t.scaleY,void 0!==l&&(t.rotation=l),r.addChild(t);var a=new createjs.Shape;a.graphics.beginFill("#FFF").drawEllipse(-e,-e,i,i),a.x=0,a.y=0,r.hitArea=a,t.cache(0,0,i,i),t.updateCache(),q=!0},d.src="header-icons/"+e+".svg",r.addChild(c),r}function _loadButtonDragHandler(e,t,a,n,i,l,s,r){var c=!1;null===i&&(i=n),null===l&&(l=i);var d,u,v=!1,g=!1,h=e;e.on("mousedown",(function(p){var m=!0;e.x,Math.round(p.stageX/f),e.y,Math.round(p.stageY/f);d=setTimeout((function(){v=!0,null!==s&&(e.visible=!1,e=_makeButton(s,"",t,a,j,0))}),500),u=setTimeout((function(){g=!0,null!==r&&(e.visible=!1,e=_makeButton(r,"",t,a,j,0))}),1e3);var C=showButtonHighlight(t,a,j/2,p,f,o);e.on("pressup",(function(p){hideButtonHighlight(C,o),e.x=t,e.y=a,null===s&&null===r||(e.visible=!1,(e=h).visible=!0),null!=n&&m&&!c&&(c=!0,setTimeout((function(){c=!1}),500),clearTimeout(d),clearTimeout(u),v?g?l():i():n()),m=!1})),v=!1,g=!1}))}!function init(){docById("loader").className="loader",o=new createjs.Stage(a),createjs.Touch.enable(o),createjs.Ticker.timingMode=createjs.Ticker.RAF_SYNCHED,createjs.Ticker.setFPS(30),createjs.Ticker.addEventListener("tick",o),createjs.Ticker.addEventListener("tick",__tick),_createMsgContainer("#ffffff","#7a7a7a",(function(e){Q=e}),55),_createMsgContainer("#ffcbc4","#ff0031",(function(e){Z=e}),110),function _createErrorContainers(){for(var e=0;e<te.length;e++){_makeErrorArtwork(te[e])}}(),palettesContainer=new createjs.Container,blocksContainer=new createjs.Container,trashContainer=new createjs.Container,turtleContainer=new createjs.Container,o.addChild(turtleContainer,trashContainer,blocksContainer,palettesContainer),function _setupBlocksContainerEvents(){var e=!1;o.on("stagemousemove",(function(e){D=e.stageX,A=e.stageY})),o.on("stagemousedown",(function(t){M=!0,null!=o.getObjectUnderPoint()|i.running()?o.on("stagemouseup",(function(e){M=!1})):(e=!0,lastCords={x:t.stageX,y:t.stageY},o.on("stagemousemove",(function(t){e&&(s.inLongPress&&(s.saveStackButton.visible=!1,s.dismissButton.visible=!1,s.inLongPress=!1),k&&(blocksContainer.x+=t.stageX-lastCords.x,blocksContainer.y+=t.stageY-lastCords.y,lastCords={x:t.stageX,y:t.stageY},refreshCanvas()))})),o.on("stagemouseup",(function(t){M=!1,e=!1}),null,!0))}))}(),trashcan=new Trashcan,trashcan.setCanvas(a).setStage(trashContainer).setSize(j).setRefreshCanvas(refreshCanvas).init(),(i=new Turtles).setCanvas(a).setStage(turtleContainer).setRefreshCanvas(refreshCanvas),boundary=new Boundary,boundary.setStage(blocksContainer).init(),(s=new Blocks).setCanvas(a).setStage(blocksContainer).setRefreshCanvas(refreshCanvas).setTrashcan(trashcan).setUpdateStage(o.update).setGetStageScale(getStageScale).setTurtles(i).setErrorMsg(errorMsg),s.makeCopyPasteButtons(_makeButton,updatePasteButton),i.setBlocks(s),(l=new Palettes).setCanvas(a).setStage(palettesContainer).setRefreshCanvas(refreshCanvas).setSize(j).setTrashcan(trashcan).setBlocks(s).init(),initPalettes(l),(r=new Logo).setCanvas(a).setBlocks(s).setTurtles(i).setStage(turtleContainer).setRefreshCanvas(refreshCanvas).setTextMsg(textMsg).setErrorMsg(errorMsg).setHideMsgs(hideMsgs).setOnStopTurtle(onStopTurtle).setOnRunTurtle(onRunTurtle).setGetStageX(getStageX).setGetStageY(getStageY).setGetStageMouseDown(getStageMouseDown).setGetCurrentKeyCode(getCurrentKeyCode).setClearCurrentKeyCode(clearCurrentKeyCode).setMeSpeak(meSpeak).setSaveLocally(saveLocally),s.setLogo(r),r.setBackgroundColor(-1),(c=new ClearBox).setCanvas(a).setStage(o).setRefreshCanvas(refreshCanvas).setClear(sendAllToTrash),(v=new SaveBox).setCanvas(a).setStage(o).setRefreshCanvas(refreshCanvas).setSaveTB(doSaveTB).setSaveSVG(doSaveSVG).setSavePNG(doSavePNG).setSavePlanet(doUploadToPlanet).setSaveFB(doShareOnFacebook);(d=new UtilityBox).setStage(o).setRefreshCanvas(refreshCanvas).setBigger(doBiggerFont).setSmaller(doSmallerFont).setPlugins(doOpenPlugin).setStats(doAnalytics).setScroller(toggleScroller),(u=new SamplesViewer).setStage(o).setRefreshCanvas(refreshCanvas).setClear(sendAllToTrash).setLoad(loadProject).setLoadRaw(loadRawProject).init(),initBasicProtoBlocks(l,s),macroData=storage.macros,null!=macroData&&processMacroData(macroData,l,s,x);if(s.setMacroDictionary(x),l.setMacroDictionary(x),pluginData=storage.plugins,null!=pluginData){var e=processPluginData(pluginData,l,s,r.evalFlowDict,r.evalArgDict,r.evalParameterDict,r.evalSetterDict,r.evalOnStartList,r.evalOnStopList);updatePluginObj(e)}var t=storage.custommode;null!=t&&(customMode=JSON.parse(t),console.log("restoring custom mode: "+customMode));g.addEventListener("click",(function(e){this.value=null})),g.addEventListener("change",(function(e){var t=new FileReader;t.onload=function(e){document.body.style.cursor="wait",setTimeout((function(){var e=t.result.replace("\n"," "),a=JSON.parse(e);for(var o in s.palettes.dict)s.palettes.dict[o].hideMenu(!0);refreshCanvas(),s.loadNewBlocks(a),document.body.style.cursor="default"}),200)},t.readAsText(g.files[0])}),!1),p.addEventListener("click",(function(e){this.value=null})),h.addEventListener("click",(function(e){window.scroll(0,0),this.value=null})),h.addEventListener("change",(function(t){window.scroll(0,0);var a=new FileReader;a.onload=function(t){document.body.style.cursor="wait",setTimeout((function(){if(null!=(e=processRawPluginData(a.result,l,s,errorMsg,r.evalFlowDict,r.evalArgDict,r.evalParameterDict,r.evalSetterDict,r.evalOnStartList,r.evalOnStopList))){var t=preparePluginExports(e);console.log(t),storage.plugins=t}setTimeout((function(){l.visible&&l.hide(),l.show(),l.bringToTop()}),1e3),document.body.style.cursor="default"}),200)},a.readAsText(h.files[0])}),!1),o.mouseMoveOutside=!0,o.enableMouseOver(10),J=_createGrid("images/Cartesian.svg"),W=_createGrid("images/polar.svg");var m=window.location.href,f=null,C=!1;_setupAndroidToolbar(),_onResize();var b=[];if(!sugarizerCompatibility.isInsideSugarizer()&&m.indexOf("?")>0){var y;if((y=m.split("?"))[1].indexOf("&")>0)for(var S=y[1].split("&"),w=0;w<S.length;w++){if(S[w].indexOf("=")>0)switch((T=S[w].split("="))[0].toLowerCase()){case"file":f=T[1];break;case"run":"true"===T[1].toLowerCase()&&(C=!0);break;case"inurl":var L=T[1];(function(e){return new Promise((function(t,a){var o=new XMLHttpRequest;o.open("get",e,!0),o.responseType="json",o.onload=function(){var e=o.status;200===e?t(o.response):a(e)},o.send()}))})(L).then((function(e){console.log("Your Json result is:  "+e.arg),n=e.arg,b.push(parseInt(n))}),(function(e){alert("Something went wrong.")}));break;case"outurl":L=T[1];break;default:errorMsg("Invalid parameters")}}else{if(y[1].indexOf("=")>0)var T=y[1].split("=");"file"===T[0].toLowerCase()&&(f=T[1])}}null!=f?setTimeout((function(){console.log("loading "+f),loadStartWrapper(loadProject,f,C,b)}),2e3):setTimeout((function(){loadStartWrapper(_loadStart)}),2e3);document.addEventListener("mousewheel",scrollEvent,!1),document.addEventListener("DOMMouseScroll",scrollEvent,!1),this.document.onkeydown=__keyPressed,_hideStopButton()}(),window.onresize=function(){_onResize()},window.prepareExport=prepareExport,window.saveLocally=saveLocally}requirejs(["domReady!","activity/sugarizer-compatibility"],(function(e){sugarizerCompatibility.isInsideSugarizer()?(window.addEventListener("localized",(function(){sugarizerCompatibility.loadData((function(){domReady(e)}))})),document.webL10n.setLanguage(sugarizerCompatibility.getLanguage())):domReady(e)}))}));