const DEFAULTVOLUME=50,TONEBPM=240,TARGETBPM=90,DEFAULTDELAY=500,TURTLESTEP=-1,NOTEDIV=8,OSCVOLUMEADJUSTMENT=1.5,NOMICERRORMSG="The microphone is not available.",NANERRORMSG="Not a number.",NOSTRINGERRORMSG="Not a string.",NOBOXERRORMSG="Cannot find box",NOACTIONERRORMSG="Cannot find action.",NOINPUTERRORMSG="Missing argument.",NOSQRTERRORMSG="Cannot take square root of negative number.",ZERODIVIDEERRORMSG="Cannot divide by zero.",EMPTYHEAPERRORMSG="empty heap.",INVALIDPITCH="Not a valid pitch name",POSNUMBER="Argument must be a positive number";function Logo(){if(this.canvas=null,this.blocks=null,this.turtles=null,this.stage=null,this.refreshCanvas=null,this.textMsg=null,this.errorMsg=null,this.hideMsgs=null,this.onStopTurtle=null,this.onRunTurtle=null,this.getStageX=null,this.getStageY=null,this.getStageMouseDown=null,this.getCurrentKeyCode=null,this.clearCurrentKeyCode=null,this.meSpeak=null,this.saveLocally=null,this.pitchTimeMatrix=null,this.pitchDrumMatrix=null,this.rhythmRuler=null,this.pitchStaircase=null,this.tempo=null,this.pitchSlider=null,this.modeWidget=null,this.statusMatrix=null,this.evalFlowDict={},this.evalArgDict={},this.evalParameterDict={},this.evalSetterDict={},this.evalOnStartList={},this.evalOnStopList={},this.eventList={},this.boxes={},this.actions={},this.returns=[],this.turtleHeaps={},this.invertList={},this.endOfClampSignals={},this.time=0,this.firstNoteTime=null,this.waitTimes={},this.turtleDelay=0,this.sounds=[],this.cameraID=null,this.stopTurtle=!1,this.lastKeyCode=null,this.saveTimeout=0,this.notesPlayed={},this.showPitchDrumMatrix=!1,this.inPitchDrumMatrix=!1,this.inRhythmRuler=!1,this.rhythmRulerMeasure=null,this.inPitchStaircase=!1,this.inTempo=!1,this.inPitchSlider=!1,this._currentDrumBlock=null,this.inMatrix=!1,this.keySignature={},this.tupletRhythms=[],this.addingNotesToTuplet=!1,this.drumBlocks=[],this.pitchBlocks=[],this.inNoteBlock=[],this.whichNoteBlock=[],this.transposition={},this._masterBPM=TARGETBPM,this.defaultBPMFactor=TONEBPM/this._masterBPM,this.beatFactor={},this.dotCount={},this.noteBeat={},this.oscList={},this.noteDrums={},this.notePitches={},this.noteOctaves={},this.noteCents={},this.noteHertz={},this.noteTranspositions={},this.noteBeatValues={},this.lastNotePlayed={},this.noteStatus={},this.pitchNumberOffset=39,this.forwardListener={},this.rightListener={},this.arcListener={},this.currentNotes={},this.currentOctaves={},this.bpm={},this.turtleTime=[],this.noteDelay=0,this.playedNote={},this.playedNoteTimes={},this.pushedNote={},this.duplicateFactor={},this.skipFactor={},this.skipIndex={},this.crescendoDelta={},this.crescendoVolume={},this.crescendoInitialVolume={},this.intervals={},this.perfect={},this.diminished={},this.augmented={},this.major={},this.minor={},this.staccato={},this.swing={},this.swingTarget={},this.swingCarryOver={},this.tie={},this.tieNote={},this.tieCarryOver={},this.polyVolume={},this.validNote=!0,this.drift={},this.drumStyle={},this.voices={},this.backward={},this.vibratoIntensity={},this.vibratoRate={},this.justCounting={},this.suppressOutput={},this.dispatchFactor={},this.tuplet=!1,this.tupletParams=[],this.pitchDrumTable={},this.checkingLilypond=!1,this.checkingLilypond=!1,this.lilypondNotes={},this.lilypondStaging={},this.lilypondOutput=getLilypondHeader(),this.runningLilypond=!1,this.numerator=3,this.denominator=4,_THIS_IS_MUSIC_BLOCKS_?(this.synth=new Synth,this.synth.loadSynth("poly")):this.turtleOscs={},this._modeBlock=null,this.inStatusMatrix=!1,this.updatingStatusMatrix=!1,this.statusFields=[],this.stepQueue={},this.unhighlightStepQueue={},this.cp1x={},this.cp1y={},this.cp2x={},this.cp2y={},this.svgOutput="",this.svgBackground=!0,_THIS_IS_MUSIC_BLOCKS_)this.mic=new Tone.UserMedia,this.limit=1024,this.analyser=new Tone.Analyser({type:"waveform",size:this.limit}),this.mic.connect(this.analyser);else try{this.mic=new p5.AudioIn}catch(e){console.log(e),console.log(NOMICERRORMSG),this.mic=null}this.setCanvas=function(e){return this.canvas=e,this},this.setBlocks=function(e){return this.blocks=e,this},this.setTurtles=function(e){return this.turtles=e,this},this.setStage=function(e){return this.stage=e,this},this.setRefreshCanvas=function(e){return this.refreshCanvas=e,this},this.setTextMsg=function(e){return this.textMsg=e,this},this.setHideMsgs=function(e){return this.hideMsgs=e,this},this.setErrorMsg=function(e){return this.errorMsg=e,this},this.setOnStopTurtle=function(e){return this.onStopTurtle=e,this},this.setOnRunTurtle=function(e){return this.onRunTurtle=e,this},this.setGetStageX=function(e){return this.getStageX=e,this},this.setGetStageY=function(e){return this.getStageY=e,this},this.setGetStageMouseDown=function(e){return this.getStageMouseDown=e,this},this.setGetCurrentKeyCode=function(e){return this.getCurrentKeyCode=e,this},this.setClearCurrentKeyCode=function(e){return this.clearCurrentKeyCode=e,this},this.setMeSpeak=function(e){return this.meSpeak=e,this},this.setSaveLocally=function(e){return this.saveLocally=e,this},this.setTurtleDelay=function(e){this.turtleDelay=e,this.noteDelay=0},this.setNoteDelay=function(e){this.noteDelay=e,this.turtleDelay=0},this.step=function(){for(var e in this.stepQueue)if(this.stepQueue[e].length>0){e in this.unhighlightStepQueue&&null!=this.unhighlightStepQueue[e]&&(this.blocks.visible&&this.blocks.unhighlight(this.unhighlightStepQueue[e]),this.unhighlightStepQueue[e]=null);var r=this.stepQueue[e].pop();null!=r&&this._runFromBlockNow(this,e,r,0,null)}},this.stepNote=function(){var e={},r={},l={},s=this;!function __stepNote(){for(var o in s.stepQueue)if((!(o in s.playedNote)||!s.playedNote[o])&&s.stepQueue[o].length>0){o in s.unhighlightStepQueue&&null!=s.unhighlightStepQueue[o]&&(s.blocks.visible&&s.blocks.unhighlight(s.unhighlightStepQueue[o]),s.unhighlightStepQueue[o]=null);var h=s.stepQueue[o].pop();if(null!=h&&h!==r[o]){var u=s.blocks.blockList[h];"newnote"===u.name&&(e[o]=h,r[o]=last(u.connections),null==r[o]&&(r[o]=last(s.turtles.turtleList[o].queue)&&last(s.turtles.turtleList[o].queue).blk),s.playedNoteTimes[o]=s.playedNoteTimes[o]||0,l[o]=Math.pow(s.parseArg(s,o,u.connections[1],h,null),-1),s.playedNoteTimes[o]+=l[o]),s._runFromBlockNow(s,o,h,0,null)}else s.playedNote[o]=!0}var g=!1;for(var o in s.stepQueue)if(s.stepQueue[o].length>0&&!s.playedNote[o]){g=!0;break}if(g)__stepNote();else{var p=[];for(var o in s.playedNote)s.playedNote[o]=!1,p.push(s.playedNoteTimes[o]);var m,f=Math.min.apply(null,p);for(var o in s.playedNoteTimes)s.playedNoteTimes[o]>f?(m=e[o],s.playedNoteTimes[o]-=l[o]):m=r[o],s._runFromBlock(s,o,m,0,null);f===Math.max.apply(null,p)&&(s.playedNoteTimes={})}}()},this.doStopTurtle=function(){for(var e in this.stopTurtle=!0,this.turtles.markAsStopped(),this.sounds)this.sounds[e].stop();this.sounds=[],_THIS_IS_MUSIC_BLOCKS_&&(this.synth.stopSound("default"),this.synth.stop()),null!=this.cameraID&&doStopVideoCam(this.cameraID,this.setCameraID),this.onStopTurtle(),this.blocks.bringToTop(),this.stepQueue={},this.unhighlightQueue={}},this._clearParameterBlocks=function(){for(var e in this.blocks.blockList)this.blocks.blockList[e].parameter&&(this.blocks.blockList[e].text.text="",this.blocks.blockList[e].container.updateCache());this.refreshCanvas()},this._updateParameterBlock=function(that,turtle,blk){if(this.blocks.blockList[blk].protoblock.parameter){var name=this.blocks.blockList[blk].name,value=0;switch(name){case"and":case"or":case"not":case"less":case"greater":case"equal":value=this.blocks.blockList[blk].value?_("true"):_("false");break;case"random":case"mod":case"sqrt":case"int":case"plus":case"minus":case"multiply":case"power":value=toFixed2(this.blocks.blockList[blk].value);break;case"divide":value=this.blocks.blockList[blk].value;break;case"namedbox":var name=this.blocks.blockList[blk].privateData;name in this.boxes?value=this.boxes[name]:this.errorMsg(NOBOXERRORMSG,blk,name);break;case"box":var cblk=this.blocks.blockList[blk].connections[1],boxname=this.parseArg(that,turtle,cblk,blk);boxname in this.boxes?value=this.boxes[boxname]:this.errorMsg(NOBOXERRORMSG,blk,boxname);break;case"x":value=toFixed2(this.turtles.turtleList[turtle].x);break;case"y":value=toFixed2(this.turtles.turtleList[turtle].y);break;case"heading":value=toFixed2(this.turtles.turtleList[turtle].orientation);break;case"color":case"hue":value=toFixed2(this.turtles.turtleList[turtle].color);break;case"shade":value=toFixed2(this.turtles.turtleList[turtle].value);break;case"grey":value=toFixed2(this.turtles.turtleList[turtle].chroma);break;case"pensize":value=toFixed2(this.turtles.turtleList[turtle].stroke);break;case"time":var d=new Date;value=(d.getTime()-this.time)/1e3;break;case"mousex":value=toFixed2(this.getStageX());break;case"mousey":value=toFixed2(this.getStageY());break;case"keyboard":value=this.lastKeyCode;break;case"loudness":if(null==that.mic)that.errorMsg(NOMICERRORMSG),value=0;else if(_THIS_IS_TURTLE_BLOCKS)value=Math.round(1e3*that.mic.getLevel());else{for(var values=that.analyser.analyse(),sum=0,k=0;k<that.limit;k++)sum+=values[k]*values[k];value=Math.round(Math.sqrt(sum/that.limit))}break;case"consonantstepsizeup":if(null!==this.lastNotePlayed[turtle]){var len=this.lastNotePlayed[turtle][0].length;value=getStepSizeUp(this.keySignature[turtle],this.lastNotePlayed[turtle][0].slice(0,len-1))}else value=getStepSizeUp(this.keySignature[turtle],"A");break;case"consonantstepsizedown":if(null!==this.lastNotePlayed[turtle]){var len=this.lastNotePlayed[turtle][0].length;value=getStepSizeDown(this.keySignature[turtle],this.lastNotePlayed[turtle][0].slice(0,len-1))}else value=getStepSizeDown(this.keySignature[turtle],"A");break;case"transpositionfactor":value=this.transposition[turtle];break;case"staccatofactor":value=last(this.staccato[turtle]);break;case"slurfactor":value=-last(this.staccato[turtle]);break;case"beatfactor":value=this.beatFactor[turtle];break;case"elapsednotes":value=this.notesPlayed[turtle];break;case"duplicatefactor":value=this.duplicateFactor[turtle];break;case"skipfactor":value=this.skipFactor[turtle];break;case"notevolumefactor":value=last(this.polyVolume[turtle]);break;case"turtlepitch":if(null!==this.lastNotePlayed[turtle]){var len=this.lastNotePlayed[turtle][0].length;value=pitchToNumber(this.lastNotePlayed[turtle][0].slice(0,len-1),parseInt(this.lastNotePlayed[turtle][0].slice(len-1)),this.keySignature[turtle])-that.pitchNumberOffset}else console.log("Could not find a note for turtle "+turtle),value=pitchToNumber("A",4,this.keySignature[turtle])-that.pitchNumberOffset;break;case"currentnote":value=this.currentNotes[turtle];break;case"currentoctave":value=this.currentoctave[turtle];break;case"bpmfactor":value=this.bpm[turtle].length>0?last(this.bpm[turtle]):this._masterBPM;break;default:if(!(name in this.evalParameterDict))return;eval(this.evalParameterDict[name])}"string"==typeof value?(value.length>6&&(value=value.substr(0,5)+"..."),this.blocks.blockList[blk].text.text=value):"divide"===name&&(this.blocks.blockList[blk].text.text=mixedNumber(value)),this.blocks.blockList[blk].container.updateCache(),this.refreshCanvas()}},this.runLogoCommands=function(startHere,env){for(var arg in this.saveLocally(),this.evalOnStartList)eval(this.evalOnStartList[arg]);this.stopTurtle=!1,this.blocks.unhighlightAll(),this.blocks.bringToTop(),this.hideMsgs();var d=new Date;for(var turtle in this.time=d.getTime(),this.firstNoteTime=null,0===this.turtles.turtleList.length&&this.turtles.add(null),this.forwardListener)for(var b in this.forwardListener[turtle])for(var i=0;i<this.forwardListener[turtle][b].length;i++)this.stage.removeEventListener("_forward_"+turtle,this.forwardListener[turtle][b][i],!1);for(var turtle in this.rightListener)for(var b in this.rightListener[turtle])for(var i=0;i<this.rightListener[turtle][b].length;i++)this.stage.removeEventListener("_right_"+turtle,this.rightListener[turtle][b][i],!1);for(var turtle in this.arcListener)for(var b in this.arcListener[turtle])for(var i=0;i<this.arcListener[turtle][b].length;i++)this.stage.removeEventListener("_arc_"+turtle,this.arcListener[turtle][b][i],!1);this._masterBPM=TARGETBPM,this.defaultBPMFactor=TONEBPM/this._masterBPM;for(var turtle=0;turtle<this.turtles.turtleList.length;turtle++)this.turtleTime[turtle]=0,this.waitTimes[turtle]=0,this.endOfClampSignals[turtle]={},this.cp1x[turtle]=0,this.cp1y[turtle]=100,this.cp2x[turtle]=100,this.cp2y[turtle]=100,this.inNoteBlock[turtle]=0,this.transposition[turtle]=0,this.noteBeat[turtle]=[],this.noteCents[turtle]=[],this.noteHertz[turtle]=[],this.lastNotePlayed[turtle]=null,this.noteStatus[turtle]=null,this.noteDrums[turtle]=[],this.notePitches[turtle]=[],this.noteOctaves[turtle]=[],this.currentNotes[turtle]="G",this.currentOctaves[turtle]=4,this.noteTranspositions[turtle]=[],this.noteBeatValues[turtle]=[],this.forwardListener[turtle]={},this.rightListener[turtle]={},this.arcListener[turtle]={},this.beatFactor[turtle]=1,this.dotCount[turtle]=0,this.invertList[turtle]=[],this.duplicateFactor[turtle]=1,this.skipFactor[turtle]=1,this.skipIndex[turtle]=0,this.notesPlayed[turtle]=0,this.keySignature[turtle]="C "+_("major"),this.pushedNote[turtle]=!1,this.polyVolume[turtle]=[DEFAULTVOLUME],this.oscList[turtle]=[],this.bpm[turtle]=[],this.crescendoDelta[turtle]=[],this.crescendoInitialVolume[turtle]=[],this.crescendoVolume[turtle]=[],this.intervals[turtle]=[],this.perfect[turtle]=[],this.diminished[turtle]=[],this.augmented[turtle]=[],this.major[turtle]=[],this.minor[turtle]=[],this.staccato[turtle]=[],this.swing[turtle]=[],this.swingTarget[turtle]=[],this.swingCarryOver[turtle]=0,this.tie[turtle]=!1,this.tieNote[turtle]=[],this.tieCarryOver[turtle]=0,this.drift[turtle]=0,this.drumStyle[turtle]=[],this.voices[turtle]=[],this.pitchDrumTable[turtle]={},this.backward[turtle]=[],this.vibratoIntensity[turtle]=[],this.vibratoRate[turtle]=[],this.dispatchFactor[turtle]=1,this.justCounting[turtle]=!1,this.suppressOutput[turtle]=this.runningLilypond;this.pitchNumberOffset=39,this.suppressOutput[turtle]||this._setSynthVolume(DEFAULTVOLUME,Math.max(this.turtles.turtleList.length-1),0),this.inPitchDrumMatrix=!1,this.inMatrix=!1,this.inRhythmRuler=!1,this.rhythmRulerMeasure=null,this._currentDrumBlock=null,this.inStatusMatrix=!1,this.pitchBlocks=[],this.drumBlocks=[],this.tuplet=!1,this._modeBlock=null;for(var turtle=0;turtle<this.turtles.turtleList.length;turtle++){for(var listener in this.turtles.turtleList[turtle].listeners)this.stage.removeEventListener(listener,this.turtles.turtleList[turtle].listeners[listener],!1);this.turtles.turtleList[turtle].listeners={}}for(var blk=0;blk<this.blocks.blockList.length;blk++)null!=this.blocks.blockList[blk].label&&(null!=this.blocks.blockList[blk].labelattr&&"â™®"!==this.blocks.blockList[blk].labelattr.value?this.blocks.blockList[blk].value=this.blocks.blockList[blk].label.value+this.blocks.blockList[blk].labelattr.value:this.blocks.blockList[blk].value=this.blocks.blockList[blk].label.value);for(var turtle=0;turtle<this.turtles.turtleList.length;turtle++)this.turtles.turtleList[turtle].container.x=this.turtles.turtleX2screenX(this.turtles.turtleList[turtle].x),this.turtles.turtleList[turtle].container.y=this.turtles.turtleY2screenY(this.turtles.turtleList[turtle].y);"visible"===docById("statusDiv").style.visibility&&this.statusMatrix.init(this);var startBlocks=[];this.blocks.findStacks(),this.actions={};for(var blk=0;blk<this.blocks.stackList.length;blk++)if("start"===this.blocks.blockList[this.blocks.stackList[blk]].name||"drum"===this.blocks.blockList[this.blocks.stackList[blk]].name)this.blocks.blockList[this.blocks.stackList[blk]].trash||null!=this.blocks.blockList[this.blocks.stackList[blk]].connections[1]&&startBlocks.push(this.blocks.stackList[blk]);else if("action"===this.blocks.blockList[this.blocks.stackList[blk]].name){var c=this.blocks.blockList[this.blocks.stackList[blk]].connections[1],b=this.blocks.blockList[this.blocks.stackList[blk]].connections[2];null!=c&&null!=b&&(this.blocks.blockList[this.blocks.stackList[blk]].trash||(this.actions[this.blocks.blockList[c].value]=b))}this.svgOutput="",this.svgBackground=!0,this.parentFlowQueue={},this.unhightlightQueue={},this.parameterQueue={},0===this.turtleDelay&&this._clearParameterBlocks(),this.onRunTurtle();for(var turtle=0;turtle<this.turtles.turtleList.length;turtle++)this.turtles.turtleList[turtle].running=!1;if(null!=startHere){for(var turtle=0;this.blocks.turtles.turtleList[turtle].trash&&turtle<this.turtles.turtleList.length;)turtle+=1;if("start"===this.blocks.blockList[startHere].name||"drum"===this.blocks.blockList[startHere].name)var turtle=this.blocks.blockList[startHere].value;this.turtles.turtleList[turtle].queue=[],this.parentFlowQueue[turtle]=[],this.unhightlightQueue[turtle]=[],this.parameterQueue[turtle]=[],this.turtles.turtleList[turtle].running=!0,this._runFromBlock(this,turtle,startHere,0,env)}else if(startBlocks.length>0)for(var b=0;b<startBlocks.length;b++){var turtle=this.blocks.blockList[startBlocks[b]].value;this.turtles.turtleList[turtle].queue=[],this.parentFlowQueue[turtle]=[],this.unhightlightQueue[turtle]=[],this.parameterQueue[turtle]=[],this.turtles.turtleList[turtle].trash||(this.turtles.turtleList[turtle].running=!0,this._runFromBlock(this,turtle,startBlocks[b],0,env))}else this.suppressOutput[turtle]&&(this.errorMsg(NOACTIONERRORMSG,null,_("start")),this.suppressOutput[turtle]=!1,this.checkingLilypond=!1,document.body.style.cursor="default");this.refreshCanvas()},this._runFromBlock=function(e,r,l,s,o){if(null!=l){var h=e.turtleDelay+e.waitTimes[r];e.waitTimes[r]=0,e.stopTurtle||(e.turtleDelay===TURTLESTEP?(r in e.stepQueue||(e.stepQueue[r]=[]),e.stepQueue[r].push(l)):setTimeout((function(){e._runFromBlockNow(e,r,l,s,o)}),h))}},this._blockSetter=function(blk,value,turtle){var turtleObj=this.turtles.turtleList[turtle];switch(this.blocks.blockList[blk].name){case"x":turtleObj.doSetXY(value,turtleObj.x);break;case"y":turtleObj.doSetXY(turtleObj.y,value);break;case"heading":turtleObj.doSetHeading(value);break;case"color":turtleObj.doSetColor(value);break;case"shade":turtleObj.doSetValue(value);break;case"grey":turtleObj.doSetChroma(value);break;case"pensize":turtleObj.doSetPensize(value);break;case"namedbox":var name=this.blocks.blockList[blk].privateData;name in this.boxes?this.boxes[name]=value:this.errorMsg(NOBOXERRORMSG,blk,name);break;case"box":var cblk=this.blocks.blockList[blk].connections[1],name=this.parseArg(this,turtle,cblk,blk);name in this.boxes?this.boxes[name]=value:this.errorMsg(NOBOXERRORMSG,blk,name);break;case"bpmfactor":var len=this.bpm[turtle].length;len>0&&(this.bpm[turtle][len-1]=value);break;case"transpositionfactor":var len=this.transposition[turtle].length;len>0&&(this.transposition[turtle][len-1]=value);break;case"staccatofactor":var len=this.staccato[turtle].length;len>0&&(this.staccato[turtle][len-1]=value);break;case"slurfactor":var len=this.staccato[turtle].length;len>0&&(this.staccato[turtle][len-1]=-value);break;case"beatfactor":this.beatFactor[turtle]=value;break;case"duplicatefactor":var len=this.duplicateFactor[turtle].length;len>0&&(this.duplicateFactor[turtle][len-1]=value);break;case"skipfactor":var len=this.skipFactor[turtle].length;len>0&&(this.skipFactor[turtle][len-1]=value);break;case"turtlepitch":var obj=numberToPitch(value+this.pitchNumberOffset);this.lastNotePlayed[turtle]=[obj[0]+obj[1],this.lastNotePlayed[turtle][1]];break;case"currentnote":var len=this.currentNotes[turtle].length;value=parseInt(value.slice(len));var newNoteObj=getNote(this.currentNotes[turtle],this.currentOctaves[turtle],value,this.keySignature[turtle]);this.currentNotes[turtle]=newNoteObj[0],this.currentOctaves[turtle]=newNoteObj[1];break;case"currentoctave":this.currentOctaves[turtle]=Math.round(value),this.currentOctaves[turtle]<1&&(this.currentOctaves[turtle]=1);break;case"notevolumefactor":var len=this.transposition[turtle].length;this.polyVolume[turtle][len-1]=value,this._setSynthVolume(value,turtle);break;default:if(this.blocks.blockList[blk].name in this.evalSetterDict){eval(this.evalSetterDict[this.blocks.blockList[blk].name]);break}this.errorMsg(_("Block does not support incrementing."),blk)}},this._runFromBlockNow=function(that,turtle,blk,isflow,receivedArg,queueStart){void 0===queueStart&&(queueStart=0);var args=[];if(that.blocks.blockList[blk].protoblock.args>0)for(var i=1;i<that.blocks.blockList[blk].protoblock.args+1;i++)"in"===that.blocks.blockList[blk].protoblock.dockTypes[i]&&null==that.blocks.blockList[blk].connections[i]?console.log("skipping null inflow args"):args.push(that.parseArg(that,turtle,that.blocks.blockList[blk].connections[i],blk,receivedArg));if(that.blocks.blockList[blk].isValueBlock())var nextFlow=null;else{if(that.backward[turtle].length>0){if("backward"===that.blocks.blockList[last(that.backward[turtle])].name)var c=1;else var c=2;if(that.blocks.sameGeneration(that.blocks.blockList[last(that.backward[turtle])].connections[c],blk)){var nextFlow=that.blocks.blockList[blk].connections[0];if("action"===that.blocks.blockList[nextFlow].name||"backward"===that.blocks.blockList[nextFlow].name)nextFlow=null;else if(that.blocks.sameGeneration(that.blocks.blockList[last(that.backward[turtle])].connections[c],nextFlow))var nextFlow=that.blocks.blockList[blk].connections[0];else var nextFlow=last(that.blocks.blockList[blk].connections)}else var nextFlow=last(that.blocks.blockList[blk].connections)}else var nextFlow=last(that.blocks.blockList[blk].connections);-1===nextFlow&&(nextFlow=null);var queueBlock=new Queue(nextFlow,1,blk,receivedArg);null!=nextFlow&&that.turtles.turtleList[turtle].queue.push(queueBlock)}var childFlow=null,childFlowCount=0,actionArgs=[];switch(that.blocks.visible&&that.blocks.highlight(blk,!1),that.blocks.blockList[blk].name){case"dispatch":if(1===args.length){if(!(args[0]in that.eventList)){var event=new Event(args[0]);that.eventList[args[0]]=event}that.stage.dispatchEvent(args[0])}break;case"listen":if(2===args.length)if(args[1]in that.actions){var __listener=function(e){if(that.turtles.turtleList[turtle].running){var r=new Queue(that.actions[args[1]],1,blk);that.parentFlowQueue[turtle].push(blk),that.turtles.turtleList[turtle].queue.push(r)}else isflow?that._runFromBlockNow(that,turtle,that.actions[args[1]],isflow,receivedArg):that._runFromBlock(that,turtle,that.actions[args[1]],isflow,receivedArg)};that._setListener(turtle,args[0],__listener)}else that.errorMsg(NOACTIONERRORMSG,blk,args[1]),that.stopTurtle=!0;break;case"start":case"drum":1===args.length&&(childFlow=args[0],childFlowCount=1);break;case"nameddo":var name=that.blocks.blockList[blk].privateData;if(name in that.actions){if(that.justCounting[turtle]||lilypondLineBreak(that,turtle),that.backward[turtle].length>0){childFlow=that.blocks.findBottomBlock(that.actions[name]);var actionBlk=that.blocks.findTopBlock(that.actions[name]);that.backward[turtle].push(actionBlk);var listenerName="_backward_action_"+turtle+"_"+blk,nextBlock=this.blocks.blockList[actionBlk].connections[2];null==nextBlock?that.backward[turtle].pop():that.endOfClampSignals[turtle][nextBlock]=[listenerName];var __listener=function(e){that.backward[turtle].pop()};that._setListener(turtle,listenerName,__listener)}else childFlow=that.actions[name];childFlowCount=1}else that.errorMsg(NOACTIONERRORMSG,blk,name),that.stopTurtle=!0;break;case"action":case"do":args.length>0&&(args[0]in that.actions?(that.justCounting[turtle]||lilypondLineBreak(that,turtle),childFlow=that.actions[args[0]],childFlowCount=1):(console.log("action "+args[0]+" not found"),that.errorMsg(NOACTIONERRORMSG,blk,args[0]),that.stopTurtle=!0));break;case"nameddoArg":for(var name=that.blocks.blockList[blk].privateData;actionArgs.length>0;)actionArgs.pop();if(that.blocks.blockList[blk].argClampSlots.length>0)for(var i=0;i<that.blocks.blockList[blk].argClampSlots.length;i++){var t=that.parseArg(that,turtle,that.blocks.blockList[blk].connections[i+1],blk,receivedArg);actionArgs.push(t)}if(name in that.actions){if(that.justCounting[turtle]||lilypondLineBreak(that,turtle),that.backward[turtle].length>0){childFlow=that.blocks.findBottomBlock(that.actions[name]);var actionBlk=that.blocks.findTopBlock(that.actions[name]);that.backward[turtle].push(actionBlk);var listenerName="_backward_action_"+turtle+"_"+blk,nextBlock=this.blocks.blockList[actionBlk].connections[2];null==nextBlock?that.backward[turtle].pop():that.endOfClampSignals[turtle][nextBlock]=[listenerName];var __listener=function(e){that.backward[turtle].pop()};that._setListener(turtle,listenerName,__listener)}else childFlow=that.actions[name];childFlowCount=1}else that.errorMsg(NOACTIONERRORMSG,blk,name),that.stopTurtle=!0;break;case"doArg":for(;actionArgs.length>0;)actionArgs.pop();if(that.blocks.blockList[blk].argClampSlots.length>0)for(var i=0;i<that.blocks.blockList[blk].argClampSlots.length;i++){var t=that.parseArg(that,turtle,that.blocks.blockList[blk].connections[i+2],blk,receivedArg);actionArgs.push(t)}args.length>=1&&(args[0]in that.actions?(that.justCounting[turtle]||lilypondLineBreak(that,turtle),actionName=args[0],childFlow=that.actions[args[0]],childFlowCount=1):(that.errorMsg(NOACTIONERRORMSG,blk,args[0]),that.stopTurtle=!0));break;case"forever":1===args.length&&(childFlow=args[0],childFlowCount=that.suppressOutput[turtle]?10:-1);break;case"hidden":case"hiddennoflow":break;case"break":that._doBreak(turtle);var parentBlk=that.blocks.blockList[blk].connections[0];null!=parentBlk&&that.unhightlightQueue[turtle].push(parentBlk);break;case"wait":1===args.length&&that._doWait(turtle,args[0]);break;case"print":that.inStatusMatrix||1===args.length&&null!==args[0]&&that.textMsg(args[0].toString());break;case"speak":if(1===args.length&&that.meSpeak){for(var text=args[0],new_text="",i=0;i<text.length;i++)(text[i]>="a"&&text[i]<="z"||text[i]>="A"&&text[i]<="Z"||","===text[i]||"."===text[i]||" "===text[i])&&(new_text+=text[i]);that.meSpeak.speak(new_text)}break;case"repeat":2===args.length&&("string"==typeof args[0]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):args[0]<=0?that.errorMsg(POSNUMBER,blk):(childFlow=args[1],childFlowCount=Math.floor(args[0])));break;case"clamp":1===args.length&&(childFlow=args[0],childFlowCount=1);break;case"until":if(2===args.length)if(childFlow=args[1],childFlowCount=1,args[0])for(var queueLength=that.turtles.turtleList[turtle].queue.length,i=queueLength-1;i>0;i--)that.turtles.turtleList[turtle].queue[i].parentBlk===blk&&that.turtles.turtleList[turtle].queue.pop();else{var queueLength=that.turtles.turtleList[turtle].queue.length;queueLength>0&&that.turtles.turtleList[turtle].queue[queueLength-1].parentBlk===blk&&that.turtles.turtleList[turtle].queue.pop();var parentBlk=that.blocks.blockList[blk].connections[0],queueBlock=new Queue(blk,1,parentBlk);that.parentFlowQueue[turtle].push(parentBlk),that.turtles.turtleList[turtle].queue.push(queueBlock)}break;case"waitFor":if(1===args.length)if(args[0])for(var queueLength=that.turtles.turtleList[turtle].queue.length,i=queueLength-1;i>0;i--)that.turtles.turtleList[turtle].queue[i].parentBlk===blk&&that.turtles.turtleList[turtle].queue.pop();else{var parentBlk=that.blocks.blockList[blk].connections[0],queueBlock=new Queue(blk,1,parentBlk);that.parentFlowQueue[turtle].push(parentBlk),that.turtles.turtleList[turtle].queue.push(queueBlock),that._doWait(.05)}break;case"if":2===args.length&&args[0]&&(childFlow=args[1],childFlowCount=1);break;case"ifthenelse":3===args.length&&(args[0]?(childFlow=args[1],childFlowCount=1):(childFlow=args[2],childFlowCount=1));break;case"while":if(2===args.length)if(args[0]){var queueLength=that.turtles.turtleList[turtle].queue.length;queueLength>0&&that.turtles.turtleList[turtle].queue[queueLength-1].parentBlk===blk&&that.turtles.turtleList[turtle].queue.pop();var parentBlk=that.blocks.blockList[blk].connections[0],queueBlock=new Queue(blk,1,parentBlk);that.parentFlowQueue[turtle].push(parentBlk),that.turtles.turtleList[turtle].queue.push(queueBlock),childFlow=args[1],childFlowCount=1}else for(var queueLength=that.turtles.turtleList[turtle].queue.length,i=queueLength-1;i>0;i--)that.turtles.turtleList[turtle].queue[i].parentBlk===blk&&that.turtles.turtleList[turtle].queue.pop();break;case"storein":2===args.length&&(that.boxes[args[0]]=args[1]);break;case"incrementOne":var i=1;case"increment":if(2===args.length)var i=args[1];if(args.length>=1){var settingBlk=that.blocks.blockList[blk].connections[1];that._blockSetter(settingBlk,args[0]+i,turtle)}break;case"clear":that.svgBackground=!0,that.turtles.turtleList[turtle].doClear(!0,!0);break;case"setxy":2===args.length&&("string"==typeof args[0]||"string"==typeof args[1]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):that.inMatrix?(that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push([args[0],args[1]])):that.turtles.turtleList[turtle].doSetXY(args[0],args[1]));break;case"arc":if(2===args.length)if("string"==typeof args[0]||"string"==typeof args[1])that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0;else if(that.inMatrix)that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push([args[0],args[1]]);else if(that.inNoteBlock[turtle]>0){if(!that.suppressOutput[turtle]){var delta=args[0]/NOTEDIV,listenerName="_arc_"+turtle+"_"+that.whichNoteBlock[turtle],__listener=function(e){that.turtles.turtleList[turtle].doArc(delta*that.dispatchFactor[turtle],args[1])};that.whichNoteBlock[turtle]in that.arcListener[turtle]?that.arcListener[turtle][that.whichNoteBlock[turtle]].push(__listener):that.arcListener[turtle][that.whichNoteBlock[turtle]]=[__listener],that.stage.addEventListener(listenerName,__listener,!1)}}else that.turtles.turtleList[turtle].doArc(args[0],args[1]);break;case"bezier":2===args.length&&("string"==typeof args[0]||"string"==typeof args[1]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):that.turtles.turtleList[turtle].doBezier(that.cp1x[turtle],that.cp1y[turtle],that.cp2x[turtle],that.cp2y[turtle],args[0],args[1]));break;case"controlpoint1":2===args.length&&("string"==typeof args[0]||"string"==typeof args[1]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):(that.cp1x[turtle]=args[0],that.cp1y[turtle]=args[1]));break;case"controlpoint2":2===args.length&&("string"==typeof args[0]||"string"==typeof args[1]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):(that.cp2x[turtle]=args[0],that.cp2y[turtle]=args[1]));break;case"return":1===args.length&&that.returns.push(args[0]);break;case"returnToUrl":var URL=window.location.href,urlParts,outurl;if(URL.indexOf("?")>0){var urlParts=URL.split("?");if(urlParts[1].indexOf("&")>0)for(var newUrlParts=urlParts[1].split("&"),i=0;i<newUrlParts.length;i++)if(newUrlParts[i].indexOf("=")>0){var tempargs=newUrlParts[i].split("=");switch(tempargs[0].toLowerCase()){case"outurl":outurl=tempargs[1]}}}if(1===args.length){var jsonRet={};jsonRet.result=args[0];var json=JSON.stringify(jsonRet),xmlHttp=new XMLHttpRequest;xmlHttp.open("POST",outurl,!0),xmlHttp.onreadystatechange=function(){4===xmlHttp.readyState&&200===xmlHttp.status&&alert(xmlHttp.responseText)},xmlHttp.send(json)}break;case"forward":if(1===args.length)if("string"==typeof args[0])that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0;else if(that.inMatrix)that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0]);else if(that.inNoteBlock[turtle]>0){if(!that.suppressOutput[turtle]){var dist=args[0]/NOTEDIV,listenerName="_forward_"+turtle+"_"+that.whichNoteBlock[turtle],__listener=function(e){that.turtles.turtleList[turtle].doForward(dist*that.dispatchFactor[turtle])};that.whichNoteBlock[turtle]in that.forwardListener[turtle]?that.forwardListener[turtle][that.whichNoteBlock[turtle]].push(__listener):that.forwardListener[turtle][that.whichNoteBlock[turtle]]=[__listener],that.stage.addEventListener(listenerName,__listener,!1)}}else that.turtles.turtleList[turtle].doForward(args[0]);break;case"back":if(1===args.length)if("string"==typeof args[0])that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0;else if(that.inMatrix)that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0]);else if(that.inNoteBlock[turtle]>0){if(!that.suppressOutput[turtle]){var dist=-args[0]/NOTEDIV,listenerName="_forward_"+turtle+"_"+that.whichNoteBlock[turtle],__listener=function(e){that.turtles.turtleList[turtle].doForward(dist*that.dispatchFactor[turtle])};that.whichNoteBlock[turtle]in that.forwardListener[turtle]?that.forwardListener[turtle][that.whichNoteBlock[turtle]].push(__listener):that.forwardListener[turtle][that.whichNoteBlock[turtle]]=[__listener],that.stage.addEventListener(listenerName,__listener,!1)}}else that.turtles.turtleList[turtle].doForward(-args[0]);break;case"right":if(1===args.length)if("string"==typeof args[0])that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0;else if(that.inMatrix)that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0]);else if(that.inNoteBlock[turtle]>0){if(!that.suppressOutput[turtle]){var delta=args[0]/NOTEDIV,listenerName="_right_"+turtle+"_"+that.whichNoteBlock[turtle],__listener=function(e){that.turtles.turtleList[turtle].doRight(delta*that.dispatchFactor[turtle])};that.whichNoteBlock[turtle]in that.rightListener[turtle]?that.rightListener[turtle][that.whichNoteBlock[turtle]].push(__listener):that.rightListener[turtle][that.whichNoteBlock[turtle]]=[__listener],that.stage.addEventListener(listenerName,__listener,!1)}}else that.turtles.turtleList[turtle].doRight(args[0]);break;case"left":if(1===args.length)if("string"==typeof args[0])that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0;else if(that.inMatrix)that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0]);else if(that.inNoteBlock[turtle]>0){if(!that.suppressOutput[turtle]){var delta=-args[0]/NOTEDIV,listenerName="_right_"+turtle+"_"+that.whichNoteBlock[turtle],__listener=function(e){that.turtles.turtleList[turtle].doRight(delta*that.dispatchFactor[turtle])};that.whichNoteBlock[turtle]in that.rightListener[turtle]?that.rightListener[turtle][that.whichNoteBlock[turtle]].push(__listener):that.rightListener[turtle][that.whichNoteBlock[turtle]]=[__listener],that.stage.addEventListener(listenerName,__listener,!1)}}else that.turtles.turtleList[turtle].doRight(-args[0]);break;case"setheading":1===args.length&&("string"==typeof args[0]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):that.inMatrix?(that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0])):that.turtles.turtleList[turtle].doSetHeading(args[0]));break;case"show":if(2===args.length)if("string"==typeof args[1]){var len=args[1].length;14===len&&args[1].substr(0,14)===CAMERAVALUE?doUseCamera(args,that.turtles,turtle,!1,that.cameraID,that.setCameraID,that.errorMsg):13===len&&args[1].substr(0,13)===VIDEOVALUE?doUseCamera(args,that.turtles,turtle,!0,that.cameraID,that.setCameraID,that.errorMsg):len>10&&"data:image"===args[1].substr(0,10)?that.turtles.turtleList[turtle].doShowImage(args[0],args[1]):len>8&&"https://"===args[1].substr(0,8)||len>7&&"http://"===args[1].substr(0,7)||len>7&&"file://"===args[1].substr(0,7)?that.turtles.turtleList[turtle].doShowURL(args[0],args[1]):that.turtles.turtleList[turtle].doShowText(args[0],args[1])}else"object"==typeof args[1]&&"loadFile"===that.blocks.blockList[that.blocks.blockList[blk].connections[2]].name?args[1]?that.turtles.turtleList[turtle].doShowText(args[0],args[1][1]):that.errorMsg(_("You must select a file.")):that.turtles.turtleList[turtle].doShowText(args[0],args[1]);break;case"turtleshell":2===args.length&&("string"==typeof args[0]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):that.turtles.turtleList[turtle].doTurtleShell(args[0],args[1]));break;case"setturtlename":var foundTargetTurtle=!1;if(2===args.length)for(var i=0;i<that.turtles.turtleList.length;i++)if(that.turtles.turtleList[i].name===args[0]){that.turtles.turtleList[i].rename(args[1]),foundTargetTurtle=!0;break}foundTargetTurtle||that.errorMsg("Could not find turtle "+args[0],blk);break;case"startTurtle":var targetTurtle=that._getTargetTurtle(args);if(null==targetTurtle)that.errorMsg("Cannot find turtle: "+args[0],blk);else{if(that.turtles.turtleList[targetTurtle].running){that.errorMsg("Turtle is already running.",blk);break}that.turtles.turtleList[targetTurtle].queue=[],that.turtles.turtleList[targetTurtle].running=!0,that.parentFlowQueue[targetTurtle]=[],that.unhightlightQueue[targetTurtle]=[],that.parameterQueue[targetTurtle]=[];for(var foundStartBlock=!1,i=0;i<that.blocks.blockList.length;i++)if(that.blocks.blockList[i]===that.turtles.turtleList[targetTurtle].startBlock){foundStartBlock=!0;break}foundStartBlock?that._runFromBlock(that,targetTurtle,i,isflow,receivedArg):that.errorMsg("Cannot find start block for turtle: "+args[0],blk)}break;case"stopTurtle":var targetTurtle=that._getTargetTurtle(args);null==targetTurtle?that.errorMsg("Cannot find turtle: "+args[0],blk):(that.turtles.turtleList[targetTurtle].queue=[],that.parentFlowQueue[targetTurtle]=[],that.unhightlightQueue[targetTurtle]=[],that.parameterQueue[targetTurtle]=[],that._doBreak(targetTurtle));break;case"setcolor":1===args.length&&("string"==typeof args[0]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):that.inMatrix?(that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0])):that.turtles.turtleList[turtle].doSetColor(args[0]));break;case"setfont":1===args.length&&("string"==typeof args[0]?that.turtles.turtleList[turtle].doSetFont(args[0]):(that.errorMsg(NOSTRINGERRORMSG,blk),that.stopTurtle=!0));break;case"sethue":1===args.length&&("string"==typeof args[0]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):that.inMatrix?(that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0])):that.turtles.turtleList[turtle].doSetHue(args[0]));break;case"setshade":1===args.length&&("string"==typeof args[0]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):that.inMatrix?(that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0])):that.turtles.turtleList[turtle].doSetValue(args[0]));break;case"settranslucency":if(1===args.length)if("string"==typeof args[0])that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0;else if(that.inMatrix)that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0]);else{args[0]%=101;var alpha=1-args[0]/100;that.turtles.turtleList[turtle].doSetPenAlpha(alpha)}break;case"setgrey":1===args.length&&("string"==typeof args[0]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):that.inMatrix?(that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0])):that.turtles.turtleList[turtle].doSetChroma(args[0]));break;case"setpensize":1===args.length&&("string"==typeof args[0]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):that.inMatrix?(that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0])):that.turtles.turtleList[turtle].doSetPensize(args[0]));break;case"fill":that.turtles.turtleList[turtle].doStartFill(),childFlow=args[0],childFlowCount=1;var listenerName="_fill_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.turtles.turtleList[turtle].doEndFill()};that._setListener(turtle,listenerName,__listener);break;case"beginfill":that.turtles.turtleList[turtle].doStartFill();break;case"endfill":that.turtles.turtleList[turtle].doEndFill();break;case"hollowline":that.turtles.turtleList[turtle].doStartHollowLine(),childFlow=args[0],childFlowCount=1;var listenerName="_hollowline_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.turtles.turtleList[turtle].doEndHollowLine()};that._setListener(turtle,listenerName,__listener);break;case"beginhollowline":that.turtles.turtleList[turtle].doStartHollowLine();break;case"endhollowline":that.turtles.turtleList[turtle].doEndHollowLine();break;case"fillscreen":if(3===args.length){var hue=that.turtles.turtleList[turtle].color,value=that.turtles.turtleList[turtle].value,chroma=that.turtles.turtleList[turtle].chroma;that.turtles.turtleList[turtle].doSetHue(args[0]),that.turtles.turtleList[turtle].doSetValue(args[1]),that.turtles.turtleList[turtle].doSetChroma(args[2]),that.setBackgroundColor(turtle),that.turtles.turtleList[turtle].doSetHue(hue),that.turtles.turtleList[turtle].doSetValue(value),that.turtles.turtleList[turtle].doSetChroma(chroma)}break;case"nobackground":that.svgBackground=!1;break;case"background":that.setBackgroundColor(turtle);break;case"penup":that.turtles.turtleList[turtle].doPenUp();break;case"pendown":that.turtles.turtleList[turtle].doPenDown();break;case"openProject":function ValidURL(e){return!!new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(e)||(that.errorMsg("Please enter a valid URL."),!1)}if(url=args[0],ValidURL(url)){var win=window.open(url,"_blank");win?win.focus():alert("Please allow popups for this site")}break;case"vspace":break;case"playback":var sound=new Howl({urls:[args[0]]});that.sounds.push(sound),sound.play();break;case"stopplayback":for(var sound in that.sounds)that.sounds[sound].stop();that.sounds=[];break;case"stopvideocam":null!=cameraID&&doStopVideoCam(that.cameraID,that.setCameraID);break;case"showblocks":that.showBlocks(),that.setTurtleDelay(DEFAULTDELAY);break;case"hideblocks":that.hideBlocks(),that.setTurtleDelay(0);break;case"savesvg":1===args.length&&(that.svgBackground&&(that.svgOutput='<rect x="0" y="0" height="'+this.canvas.height+'" width="'+this.canvas.width+'" fill="'+body.style.background+'"/> '+that.svgOutput),doSaveSVG(that,args[0]));break;case"showHeap":turtle in that.turtleHeaps||(that.turtleHeaps[turtle]=[]),that.textMsg(JSON.stringify(that.turtleHeaps[turtle]));break;case"emptyHeap":that.turtleHeaps[turtle]=[];break;case"push":1===args.length&&(turtle in that.turtleHeaps||(that.turtleHeaps[turtle]=[]),that.turtleHeaps[turtle].push(args[0]));break;case"saveHeap":function downloadFile(e,r,l){var s=document.createElement("a");s.setAttribute("href","data:"+r+";charset-utf-8,"+l),s.setAttribute("download",e),document.body.appendChild(s),s.click(),document.body.removeChild(s)}args[0]&&turtle in that.turtleHeaps&&downloadFile(args[0],"text/json",JSON.stringify(that.turtleHeaps[turtle]));break;case"loadHeap":var block=that.blocks.blockList[blk];if(turtle in that.turtleHeaps)var oldHeap=that.turtleHeaps[turtle];else var oldHeap=[];var c=block.connections[1];if(null!=c&&"loadFile"===that.blocks.blockList[c].name)if(1!==args.length)that.errorMsg(_("You must select a file."));else try{if(that.turtleHeaps[turtle]=JSON.parse(that.blocks.blockList[c].value[1]),!Array.isArray(that.turtleHeaps[turtle]))throw"is not array"}catch(e){that.turtleHeaps[turtle]=oldHeap,that.errorMsg(_("The file you selected does not contain a valid heap."))}else that.errorMsg(_("The loadHeap block needs a loadFile block."));break;case"loadHeapFromApp":var data=[],url=args[1],name=args[0],xmlHttp=new XMLHttpRequest;if(xmlHttp.open("GET",url,!1),xmlHttp.send(),4!==xmlHttp.readyState||200!==xmlHttp.status){if(4===xmlHttp.readyState&&200!==xmlHttp.status){console.log("fetched the wrong page or network error..."),that.errorMsg(_("404: Page not found"));break}that.errorMsg("xmlHttp.readyState: "+xmlHttp.readyState);break}console.log(xmlHttp.responseText);try{var data=JSON.parse(xmlHttp.responseText)}catch(e){console.log(e),that.errorMsg(_("Error parsing JSON data:")+e)}if(name in that.turtleHeaps)var oldHeap=turtleHeaps[turtle];else var oldHeap=[];that.turtleHeaps[name]=data;break;case"saveHeapToApp":var name=args[0],url=args[1];if(name in that.turtleHeaps){var data=JSON.stringify(that.turtleHeaps[name]),xmlHttp=new XMLHttpRequest;xmlHttp.open("POST",url,!0),xmlHttp.setRequestHeader("Content-Type","application/json;charset=UTF-8"),xmlHttp.send(data)}else that.errorMsg(_("turtleHeaps does not contain a valid heap for")+" "+name);break;case"setHeapEntry":if(2===args.length){turtle in that.turtleHeaps||(that.turtleHeaps[turtle]=[]);var idx=Math.floor(args[0]);for(idx<1&&that.errorMsg(_("Index must be > 0."));that.turtleHeaps[turtle].length<idx;)that.turtleHeaps[turtle].push(null);that.turtleHeaps[turtle][idx-1]=args[1]}break;case"savelilypond":1===args.length&&saveLilypondOutput(that,args[0]);break;case"setmasterbpm":if(1===args.length&&(args[0],1)&&(args[0]<30?(that.errorMsg(_("Beats per minute must be > 30.")),that._masterBPM=30):args[0]>1e3?(that.errorMsg(_("Maximum beats per minute is 1000.")),that._masterBPM=1e3):that._masterBPM=args[0],that.defaultBPMFactor=TONEBPM/this._masterBPM),this.inTempo){that.tempo.BPMBlocks.push(blk);var bpmnumberblock=that.blocks.blockList[blk].connections[1];that.tempo.BPMs.push(that.blocks.blockList[bpmnumberblock].text.text)}break;case"setbpm":if(2===args.length&&(args[0],1)){if(args[0]<30){that.errorMsg(_("Beats per minute must be > 30."));var bpm=30}else if(args[0]>1e3){that.errorMsg(_("Maximum beats per minute is 1000."));var bpm=1e3}else var bpm=args[0];that.bpm[turtle].push(bpm),childFlow=args[1],childFlowCount=1;var listenerName="_bpm_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.bpm[turtle].pop()};that._setListener(turtle,listenerName,__listener)}break;case"setkey":1===args.length&&(that.keySignature[turtle]=args[0]);break;case"setkey2":if(2===args.length){for(var modename="major",i=0;i<MODENAMES.length;i++)if(MODENAMES[i][0]===args[1]){modename=MODENAMES[i][1],that._modeBlock=that.blocks.blockList[blk].connections[2],console.log(modename);break}that.keySignature[turtle]=args[0]+" "+modename}break;case"rhythmruler":console.log("running rhythmruler"),childFlow=args[1],childFlowCount=1,null==that.rhythmRuler&&(that.rhythmRuler=new RhythmRuler),that.rhythmRuler.Rulers=[],that.rhythmRuler.Drums=[],that.inRhythmRuler=!0;var listenerName="_rhythmruler_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.rhythmRuler.init(that)};that._setListener(turtle,listenerName,__listener);break;case"pitchstaircase":null==that.pitchStaircase&&(that.pitchStaircase=new PitchStaircase),that.pitchStaircase.Stairs=[],childFlow=args[0],childFlowCount=1,that.inPitchStaircase=!0;var listenerName="_pitchstaircase_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.pitchStaircase.init(that),that.inPitchStaircase=!1};that._setListener(turtle,listenerName,__listener);break;case"tempo":console.log("running Tempo"),childFlow=args[0],childFlowCount=1,null==that.tempo&&(that.tempo=new Tempo),that.inTempo=!0,that.tempo.BPMblocks=[],that.tempo.BPMs=[];var listenerName="_tempo_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.tempo.init(that)};that._setListener(turtle,listenerName,__listener);break;case"pitchslider":null==that.pitchSlider&&(that.pitchSlider=new PitchSlider),that.pitchSlider.Sliders=[],childFlow=args[0],childFlowCount=1,that.inPitchSlider=!0;var listenerName="_pitchslider_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.pitchSlider.init(that),that.inPitchSlider=!1};that._setListener(turtle,listenerName,__listener);break;case"pitchdrummatrix":1===args.length&&(childFlow=args[0],childFlowCount=1),null==that.pitchDrumMatrix&&(that.pitchDrumMatrix=new PitchDrumMatrix),that.inPitchDrumMatrix=!0,that.pitchDrumMatrix.rowLabels=[],that.pitchDrumMatrix.rowArgs=[],that.pitchDrumMatrix.drums=[],that.pitchDrumMatrix.clearBlocks();var listenerName="_pitchdrummatrix_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){0===that.pitchDrumMatrix.drums.length||0===that.pitchDrumMatrix.rowLabels.length?that.errorMsg(_("You must have at least one pitch block and one drum block in the matrix."),blk):(that.pitchDrumMatrix.init(that),that.pitchDrumMatrix.makeClickable())};that._setListener(turtle,listenerName,__listener);break;case"modewidget":1===args.length&&(childFlow=args[0],childFlowCount=1),null==that.modeWidget&&(that.modeWidget=new ModeWidget);var listenerName="_modewidget_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){console.log(that.keySignature[turtle]),that.modeWidget.init(that,that._modeBlock)};that._setListener(turtle,listenerName,__listener);break;case"status":null==that.statusMatrix&&(that.statusMatrix=new StatusMatrix),that.statusMatrix.init(that),that.statusFields=[],1===args.length&&(childFlow=args[0],childFlowCount=1),that.inStatusMatrix=!0;var listenerName="_status_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.statusMatrix.init(that),that.inStatusMatrix=!1};that._setListener(turtle,listenerName,__listener);break;case"matrix":1===args.length&&(childFlow=args[0],childFlowCount=1),that.inMatrix=!0,null==that.pitchTimeMatrix&&(that.pitchTimeMatrix=new PitchTimeMatrix),that.pitchTimeMatrix.rowLabels=[],that.pitchTimeMatrix.rowArgs=[],that.pitchTimeMatrix.graphicsBlocks=[],that.pitchTimeMatrix.clearBlocks(),that.tupletRhythms=[],that.tupletParams=[],that.addingNotesToTuplet=!1;var listenerName="_matrix_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){if(0===that.tupletRhythms.length||0===that.pitchTimeMatrix.rowLabels.length)that.errorMsg(_("You must have at least one pitch block and one rhythm block in the matrix."),blk);else{that.pitchTimeMatrix.init(that);for(var r=0;r<that.tupletRhythms.length;r++)switch(that.tupletRhythms[r][0]){case"notes":case"simple":var l=[that.tupletParams[that.tupletRhythms[r][1]]];l.push([]);for(var s=2;s<that.tupletRhythms[r].length;s++)l[1].push(that.tupletRhythms[r][s]);that.pitchTimeMatrix.addTuplet(l);break;default:that.pitchTimeMatrix.addNotes(that.tupletRhythms[r][1],that.tupletRhythms[r][2])}that.pitchTimeMatrix.makeClickable()}};that._setListener(turtle,listenerName,__listener);break;case"invert1":if("number"==typeof args[2]&&(args[2]%2==0?args[2]="even":args[2]="odd"),args[2]===_("even")&&(args2="even"),args[2]===_("odd")&&(args2="odd"),"even"!==args[2]&&"odd"!==args[2]){that.errorMsg(NOINPUTERRORMSG,blk),that.stopTurtle=!0;break}var octave=calcOctave(that.currentOctaves[turtle],args[1]);that.invertList[turtle].push([args[0],octave,args[2]]),childFlow=args[3],childFlowCount=1;var listenerName="_invert_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.invertList[turtle].pop()};that._setListener(turtle,listenerName,__listener);break;case"invert2":case"invert":"invert"===that.blocks.blockList[blk].name?that.invertList[turtle].push([args[0],args[1],"even"]):that.invertList[turtle].push([args[0],args[1],"odd"]),childFlow=args[2],childFlowCount=1;var listenerName="_invert_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.invertList[turtle].pop()};that._setListener(turtle,listenerName,__listener);break;case"backward":that.backward[turtle].push(blk),childFlow=that.blocks.findBottomBlock(args[0]),childFlowCount=1;var listenerName="_backward_"+turtle+"_"+blk,nextBlock=this.blocks.blockList[blk].connections[1];null==nextBlock?that.backward[turtle].pop():that.endOfClampSignals[turtle][nextBlock]=[listenerName];var __listener=function(e){that.backward[turtle].pop()};that._setListener(turtle,listenerName,__listener);break;case"rest2":that.notePitches[turtle].push("rest"),that.noteOctaves[turtle].push(4),that.noteCents[turtle].push(0),that.noteHertz[turtle].push(0),turtle in that.beatFactor?that.noteBeatValues[turtle].push(that.beatFactor[turtle]):that.noteBeatValues[turtle].push(1),that.pushedNote[turtle]=!0;break;case"steppitch":if(0===that.inNoteBlock[turtle]){that.errorMsg(_("The Step Pitch Block must be used inside of a Note Block."),blk),that.stopTurtle=!0;break}if("number"!=typeof args[0]){that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0;break}if(null==that.lastNotePlayed[turtle]){that.errorMsg("The Step Pitch Block must be preceded by a Pitch Block.",blk),that.stopTurtle=!0;break}function addPitch(e,r,l){if(that.drumStyle[turtle].length>0){var s=last(that.drumStyle[turtle]),o=that.getNote(e,r,transposition,that.keySignature[turtle]);that.pitchDrumTable[turtle][o[0]+o[1]]=s}that.notePitches[turtle].push(e),that.noteOctaves[turtle].push(r),that.noteCents[turtle].push(l),0!==l?that.noteHertz[turtle].push(pitchToFrequency(e,r,l,that.keySignature[turtle])):that.noteHertz[turtle].push(0)}var len=that.lastNotePlayed[turtle][0].length;if(args[0]>=1)for(var n=Math.floor(args[0]),value=getStepSizeUp(that.keySignature[turtle],that.lastNotePlayed[turtle][0].slice(0,len-1)),noteObj=that.getNote(that.lastNotePlayed[turtle][0].slice(0,len-1),parseInt(that.lastNotePlayed[turtle][0].slice(len-1)),value,that.keySignature[turtle]),i=1;i<n;i++){var value=getStepSizeUp(that.keySignature[turtle],noteObj[0]);noteObj=that.getNote(noteObj[0],noteObj[1],value,that.keySignature[turtle])}else if(args[0]<=-1){var n=-Math.ceil(args[0]);value=getStepSizeDown(that.keySignature[turtle],that.lastNotePlayed[turtle][0].slice(0,len-1));for(var noteObj=that.getNote(that.lastNotePlayed[turtle][0].slice(0,len-1),parseInt(that.lastNotePlayed[turtle][0].slice(len-1)),value,that.keySignature[turtle]),i=1;i<n;i++){var value=getStepSizeDown(that.keySignature[turtle],noteObj[0]);noteObj=that.getNote(noteObj[0],noteObj[1],value,that.keySignature[turtle])}}else var noteObj=that.getNote(that.lastNotePlayed[turtle][0].slice(0,len-1),parseInt(that.lastNotePlayed[turtle][0].slice(len-1)),0,that.keySignature[turtle]);var delta=0;if(0!==that.invertList[turtle].length)for(var len=that.invertList[turtle].length,note1=that.getNote(noteObj[0],noteObj[1],0,that.keySignature[turtle]),num1=getNumber(note1[0],note1[1]),i=len-1;i>-1;i--){var note2=that.getNote(that.invertList[turtle][i][0],that.invertList[turtle][i][1],0,that.keySignature[turtle]),num2=getNumber(note2[0],note2[1]);"even"===that.invertList[turtle][i][2]?delta+=num2-num1:delta+=num2-num1+.5,num1+=2*delta}if(addPitch(noteObj[0],noteObj[1],0),turtle in that.intervals&&that.intervals[turtle].length>0)for(var i=0;i<that.intervals[turtle].length;i++){var ii=getInterval(that.intervals[turtle][i],that.keySignature[turtle],noteObj[0]),noteObj2=that.getNote(noteObj[0],noteObj[1],ii,that.keySignature[turtle]);addPitch(noteObj2[0],noteObj2[1],0)}if(turtle in that.perfect&&that.perfect[turtle].length>0){var noteObj2=that.getNote(noteObj[0],noteObj[1],calcPerfect(last(that.perfect[turtle])),that.keySignature[turtle]);addPitch(noteObj2[0],noteObj2[1],0)}if(turtle in that.diminished&&that.diminished[turtle].length>0){var noteObj2=that.getNote(noteObj[0],noteObj[1],calcDiminished(last(that.diminished[turtle])),that.keySignature[turtle]);addPitch(noteObj2[0],noteObj2[1],0)}if(turtle in that.augmented&&that.augmented[turtle].length>0){var noteObj2=that.getNote(noteObj[0],noteObj[1],calcAugmented(last(that.augmented[turtle])),that.keySignature[turtle]);addPitch(noteObj2[0],noteObj2[1],0)}if(turtle in that.major&&that.major[turtle].length>0){var noteObj2=that.getNote(noteObj[0],noteObj[1],calcMajor(last(that.major[turtle])),that.keySignature[turtle]);addPitch(noteObj2[0],noteObj2[1],0)}if(turtle in that.minor&&that.minor[turtle].length>0){var noteObj2=that.getNote(noteObj[0],noteObj[1],calcMinor(last(that.minor[turtle])),that.keySignature[turtle]);addPitch(noteObj2[0],noteObj2[1],0)}turtle in that.transposition?that.noteTranspositions[turtle].push(that.transposition[turtle]+2*delta):that.noteTranspositions[turtle].push(2*delta),turtle in that.beatFactor?that.noteBeatValues[turtle].push(that.beatFactor[turtle]):that.noteBeatValues[turtle].push(1),that.pushedNote[turtle]=!0;break;case"playdrum":if(1!==args.length||null==args[0]){that.errorMsg(NOINPUTERRORMSG,blk),that.stopTurtle=!0;break}if("string"!=typeof args[0]){that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0;break}var drumname="kick";if("http"===args[0].slice(0,4))drumname=args[0];else for(var drum in DRUMNAMES){if(DRUMNAMES[drum][0]===args[0]){drumname=DRUMNAMES[drum][1];break}if(DRUMNAMES[drum][1]===args[0]){drumname=args[0];break}}if(that.drumStyle[turtle].length>0&&(drumname=last(that.drumStyle[turtle])),that.inPitchDrumMatrix)that.pitchDrumMatrix.drums.push(drumname),that.pitchDrumMatrix.addColBlock(blk),-1===that.drumBlocks.indexOf(blk)&&that.drumBlocks.push(blk);else if(that.inMatrix)that.pitchTimeMatrix.rowLabels.push(drumname),that.pitchTimeMatrix.rowArgs.push(-1),that.pitchTimeMatrix.addRowBlock(blk),-1===that.drumBlocks.indexOf(blk)&&that.drumBlocks.push(blk);else{if(!(that.inNoteBlock[turtle]>0)){that.errorMsg(_("Drum Block: Did you mean to use a Note block?"),blk);break}that.noteDrums[turtle].push(drumname)}turtle in that.beatFactor?that.noteBeatValues[turtle].push(that.beatFactor[turtle]):that.noteBeatValues[turtle].push(1),that.pushedNote[turtle]=!0;break;case"setpitchnumberoffset":if(2!==args.length||null==args[0]||null==args[1]){that.errorMsg(NOINPUTERRORMSG,blk),that.stopTurtle=!0;break}var octave=Math.floor(calcOctave(that.currentOctaves[turtle],args[1]));that.pitchNumberOffset=pitchToNumber(args[0],octave,that.keySignature[turtle]);break;case"pitchnumber":case"scaledegree":case"pitch":if("pitchnumber"==that.blocks.blockList[blk].name){if(1!==args.length||null==args[0]){that.errorMsg(NOINPUTERRORMSG,blk),that.stopTurtle=!0;break}if("number"!=typeof args[0]){that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0;break}var obj=numberToPitch(Math.floor(args[0]+that.pitchNumberOffset));note=obj[0],octave=obj[1],cents=0}else{if(2!==args.length||null==args[0]||null==args[1]){that.errorMsg(NOINPUTERRORMSG,blk),that.stopTurtle=!0;break}if("number"==typeof args[0]&&"pitch"==that.blocks.blockList[blk].name){if(args[0]<1)note="?";else if(args[0]<13){note=scaleDegreeToPitch(that.keySignature[turtle],Math.floor(args[0]));var octave=Math.floor(calcOctave(that.currentOctaves[turtle],args[1])),cents=0}else if(args[0]<A0||args[0]>C8)note="?";else var obj=frequencyToPitch(args[0]),note=obj[0],octave=obj[1],cents=obj[2];if("?"===note){that.errorMsg(INVALIDPITCH,blk),that.stopTurtle=!0;break}}else if("number"==typeof args[0]&&"scaledegree"==that.blocks.blockList[blk].name){if(args[0]<0){var neg=!0;args[0]=-args[0]}else var neg=!1;if(0==args[0])note="?";else{var obj=keySignatureToMode(that.keySignature[turtle]),modeLength=MUSICALMODES[obj[1]].length,scaleDegree=Math.floor(args[0]-1)%modeLength;if(scaleDegree+=1,neg){scaleDegree>1&&(scaleDegree=modeLength-scaleDegree+2),note=scaleDegreeToPitch(that.keySignature[turtle],scaleDegree);var deltaOctave=Math.floor((args[0]+modeLength-2)/modeLength),octave=Math.floor(calcOctave(that.currentOctaves[turtle],args[1]))-deltaOctave}else{note=scaleDegreeToPitch(that.keySignature[turtle],scaleDegree);var deltaOctave=Math.floor((args[0]-1)/modeLength),octave=Math.floor(calcOctave(that.currentOctaves[turtle],args[1]))+deltaOctave}var cents=0}if("?"===note){that.errorMsg(INVALIDPITCH,blk),that.stopTurtle=!0;break}}else{var cents=0,note=args[0];if(calcOctave(that.currentOctaves[turtle],args[1])<0){console.log("minimum allowable octave is 0");var octave=0}else if(calcOctave(that.currentOctaves[turtle],args[1])>10){console.log("clipping octave at 10");var octave=10}else var octave=Math.floor(calcOctave(that.currentOctaves[turtle],args[1]));if(that.getNote(note,octave,0,that.keySignature[turtle]),!that.validNote){that.errorMsg(INVALIDPITCH,blk),that.stopTurtle=!0;break}}}var delta=0;if(that.inPitchDrumMatrix){if("rest"!==note.toLowerCase()&&(that.pitchDrumMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk)),0!==that.invertList[turtle].length)for(var delta=0,len=that.invertList[turtle].length,note1=that.getNote(note,octave,0,that.keySignature[turtle]),num1=that.getNumber(note1[0],note1[1]),i=len-1;i>-1;i--){var note2=that.getNote(that.invertList[turtle][i][0],that.invertList[turtle][i][1],0,that.keySignature[turtle]),num2=getNumber(note2[0],note2[1]);"even"===that.invertList[turtle][i][2]?delta+=num2-num1:delta+=num2-num1+.5,num1+=2*delta}if(that.duplicateFactor[turtle].length>0)var duplicateFactor=that.duplicateFactor[turtle];else var duplicateFactor=1;for(var i=0;i<duplicateFactor;i++){var transposition=2*delta;turtle in that.transposition&&(transposition+=that.transposition[turtle]);var nnote=that.getNote(note,octave,transposition,that.keySignature[turtle]);noteIsSolfege(note)&&(nnote[0]=getSolfege(nnote[0])),that.drumStyle[turtle].length>0?that.pitchDrumMatrix.drums.push(last(that.drumStyle[turtle])):(that.pitchDrumMatrix.rowLabels.push(nnote[0]),that.pitchDrumMatrix.rowArgs.push(nnote[1]))}}else if(that.inMatrix){if("rest"!==note.toLowerCase()&&(that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk)),0!==that.invertList[turtle].length)for(var delta=0,len=that.invertList[turtle].length,note1=that.getNote(note,octave,0,that.keySignature[turtle]),num1=that.getNumber(note1[0],note1[1]),i=len-1;i>-1;i--){var note2=that.getNote(that.invertList[turtle][i][0],that.invertList[turtle][i][1],0,that.keySignature[turtle]),num2=getNumber(note2[0],note2[1]);"even"===that.invertList[turtle][i][2]?delta+=num2-num1:delta+=num2-num1+.5,num1+=2*delta}if(that.duplicateFactor[turtle].length>0)var duplicateFactor=that.duplicateFactor[turtle];else var duplicateFactor=1;for(var i=0;i<duplicateFactor;i++){var transposition=2*delta;turtle in that.transposition&&(transposition+=that.transposition[turtle]);var nnote=that.getNote(note,octave,transposition,that.keySignature[turtle]);noteIsSolfege(note)&&(nnote[0]=getSolfege(nnote[0])),that.drumStyle[turtle].length>0?(that.pitchTimeMatrix.rowLabels.push(last(that.drumStyle[turtle])),that.pitchTimeMatrix.rowArgs.push(-1)):(that.pitchTimeMatrix.rowLabels.push(nnote[0]),that.pitchTimeMatrix.rowArgs.push(nnote[1]))}}else if(that.inNoteBlock[turtle]>0){function addPitch(e,r,l){if(that.drumStyle[turtle].length>0){var s=last(that.drumStyle[turtle]),o=that.getNote(e,r,transposition,that.keySignature[turtle]);that.pitchDrumTable[turtle][o[0]+o[1]]=s}that.notePitches[turtle].push(e),that.noteOctaves[turtle].push(r),that.noteCents[turtle].push(l),0!==l?that.noteHertz[turtle].push(pitchToFrequency(e,r,l,that.keySignature[turtle])):that.noteHertz[turtle].push(0)}if(0!==that.invertList[turtle].length)for(var len=that.invertList[turtle].length,note1=that.getNote(note,octave,0,that.keySignature[turtle]),num1=getNumber(note1[0],note1[1]),i=len-1;i>-1;i--){var note2=that.getNote(that.invertList[turtle][i][0],that.invertList[turtle][i][1],0,that.keySignature[turtle]),num2=getNumber(note2[0],note2[1]);"even"===that.invertList[turtle][i][2]?delta+=num2-num1:delta+=num2-num1+.5,num1+=2*delta}if(addPitch(note,octave,cents),turtle in that.intervals&&that.intervals[turtle].length>0)for(var i=0;i<that.intervals[turtle].length;i++){var ii=getInterval(that.intervals[turtle][i],that.keySignature[turtle],note),noteObj=that.getNote(note,octave,ii,that.keySignature[turtle]);addPitch(noteObj[0],noteObj[1],cents)}if(turtle in that.perfect&&that.perfect[turtle].length>0){var noteObj=that.getNote(note,octave,calcPerfect(last(that.perfect[turtle])),that.keySignature[turtle]);addPitch(noteObj[0],noteObj[1],cents)}if(turtle in that.diminished&&that.diminished[turtle].length>0){var noteObj=that.getNote(note,octave,calcDiminished(last(that.diminished[turtle])),that.keySignature[turtle]);addPitch(noteObj[0],noteObj[1],cents)}if(turtle in that.augmented&&that.augmented[turtle].length>0){var noteObj=that.getNote(note,octave,calcAugmented(last(that.augmented[turtle])),that.keySignature[turtle]);addPitch(noteObj[0],noteObj[1],cents)}if(turtle in that.major&&that.major[turtle].length>0){var noteObj=that.getNote(note,octave,calcMajor(last(that.major[turtle])),that.keySignature[turtle]);addPitch(noteObj[0],noteObj[1],cents)}if(turtle in that.minor&&that.minor[turtle].length>0){var noteObj=that.getNote(note,octave,calcMinor(last(that.minor[turtle])),that.keySignature[turtle]);addPitch(noteObj[0],noteObj[1],cents)}turtle in that.transposition?that.noteTranspositions[turtle].push(that.transposition[turtle]+2*delta):that.noteTranspositions[turtle].push(2*delta),turtle in that.beatFactor?that.noteBeatValues[turtle].push(that.beatFactor[turtle]):that.noteBeatValues[turtle].push(1),that.pushedNote[turtle]=!0}else if(that.drumStyle[turtle].length>0){var drumname=last(that.drumStyle[turtle]),note2=that.getNote(note,octave,transposition,that.keySignature[turtle]);that.pitchDrumTable[turtle][note2[0]+note2[1]]=drumname}else if(that.inPitchStaircase){for(var frequency=pitchToFrequency(args[0],calcOctave(that.currentOctaves[turtle],args[1]),0,that.keySignature[turtle]),note=that.getNote(args[0],calcOctave(that.currentOctaves[turtle],args[1]),0,that.keySignature[turtle]),flag=0,i=0;i<that.pitchStaircase.Stairs.length;i++){if(that.pitchStaircase.Stairs[i][2]<parseFloat(frequency)){that.pitchStaircase.Stairs.splice(i,0,[note[0],note[1],parseFloat(frequency),1,1]),flag=1;break}if(that.pitchStaircase.Stairs[i][2]===parseFloat(frequency)){that.pitchStaircase.Stairs.splice(i,1,[note[0],note[1],parseFloat(frequency),1,1]),flag=1;break}}0===flag&&that.pitchStaircase.Stairs.push([note[0],note[1],parseFloat(frequency),1,1])}else that.errorMsg(_("Pitch Block: Did you mean to use a Note block?"),blk);break;case"rhythm2":case"rhythm":if(args.length<2||"number"!=typeof args[0]||"number"!=typeof args[1]||args[0]<1||args[1]<=0){that.errorMsg(NOINPUTERRORMSG,blk),that.stopTurtle=!0;break}if("rhythm2"===that.blocks.blockList[blk].name)var noteBeatValue=1/args[1];else var noteBeatValue=args[1];if(that.inMatrix){that.pitchTimeMatrix.addColBlock(blk,args[0]);for(var i=0;i<args[0];i++)that._processNote(noteBeatValue,blk,turtle)}else if(that.inRhythmRuler){null===that.rhythmRulerMeasure?that.rhythmRulerMeasure=args[0]*args[1]:that.rhythmRulerMeasure!=args[0]*args[1]&&(that.errorMsg("Rhythm Ruler imbalance.",blk),that.stopTurtle=!0);for(var drumIndex=-1,i=0;i<that.rhythmRuler.Drums.length;i++){var j=that.rhythmRuler.Drums.length-i-1;if(that.rhythmRuler.Drums[j]===that._currentDrumBlock){drumIndex=j;break}}if(-1!==drumIndex)for(var i=0;i<args[0];i++)that.rhythmRuler.Rulers[drumIndex][0].push(noteBeatValue)}else that.errorMsg(_("Rhythm Block: Did you mean to use a Matrix block?"),blk);break;case"wholeNote":that._processNote(1,blk,turtle);break;case"halfNote":that._processNote(2,blk,turtle);break;case"quarterNote":that._processNote(4,blk,turtle);break;case"eighthNote":that._processNote(8,blk,turtle);break;case"sixteenthNote":that._processNote(16,blk,turtle);break;case"thirtysecondNote":that._processNote(32,blk,turtle);break;case"sixtyfourthNote":that._processNote(64,blk,turtle);break;case"meter":break;case"osctime":case"newnote":case"note":if(that.oscList[turtle]=[],that.noteBeat[turtle]=[],that.notePitches[turtle]=[],that.noteOctaves[turtle]=[],that.noteCents[turtle]=[],that.noteHertz[turtle]=[],that.noteTranspositions[turtle]=[],that.noteBeatValues[turtle]=[],that.noteDrums[turtle]=[],args[0]<0){that.errorMsg(_("Note value must be greater than 0"),blk);var noteBeatValue=0}else if("newnote"===that.blocks.blockList[blk].name)var noteBeatValue=1/args[0];else var noteBeatValue=args[0];that.inNoteBlock[turtle]+=1,that.whichNoteBlock[turtle]=blk,childFlow=args[1],childFlowCount=1;var listenerName="_playnote_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that._processNote(noteBeatValue,blk,turtle),that.inNoteBlock[turtle]-=1,that.pitchBlocks=[],that.drumBlocks=[]};that._setListener(turtle,listenerName,__listener);break;case"rhythmicdot":var currentDotFactor=2-1/Math.pow(2,that.dotCount[turtle]);that.beatFactor[turtle]*=currentDotFactor,that.dotCount[turtle]+=1;var newDotFactor=2-1/Math.pow(2,that.dotCount[turtle]);that.beatFactor[turtle]/=newDotFactor,childFlow=args[0],childFlowCount=1;var listenerName="_dot_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){var r=2-1/Math.pow(2,that.dotCount[turtle]);that.beatFactor[turtle]*=r,that.dotCount[turtle]-=1;var l=2-1/Math.pow(2,that.dotCount[turtle]);that.beatFactor[turtle]/=l};that._setListener(turtle,listenerName,__listener);break;case"crescendo":if(args.length>1&&0!==args[0]){that.crescendoDelta[turtle].push(args[0]),that.crescendoVolume[turtle].push(last(that.polyVolume[turtle])),that.crescendoInitialVolume[turtle].push(last(that.polyVolume[turtle])),that.polyVolume[turtle].push(last(that.crescendoVolume[turtle])),childFlow=args[1],childFlowCount=1;var listenerName="_crescendo_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.crescendoDelta[turtle].pop(),that.crescendoVolume[turtle].pop(),that.polyVolume[turtle].pop(),that.crescendoInitialVolume[turtle].pop(),that.justCounting[turtle]||lilypondEndCrescendo(that,turtle)};that._setListener(turtle,listenerName,__listener)}break;case"darbuka":case"clang":case"bottle":case"duck":case"snare":case"hihat":case"tom":case"kick":case"pluck":case"triangle1":case"slap":case"frogs":case"fingercymbals":case"cup":case"cowbell":case"splash":case"ridebell":case"floortom":case"crash":case"chine":case"dog":case"cat":case"clap":case"bubbles":case"cricket":that.drumStyle[turtle].push(that.blocks.blockList[blk].name),childFlow=args[0],childFlowCount=1;var listenerName="_drum_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.drumStyle[turtle].pop()};that._setListener(turtle,listenerName,__listener);break;case"setdrum":var drumname="kick";for(var drum in DRUMNAMES)DRUMNAMES[drum][0]===args[0]?drumname=DRUMNAMES[drum][1]:DRUMNAMES[drum][1]===args[0]&&(drumname=args[0]);that.drumStyle[turtle].push(drumname),childFlow=args[1],childFlowCount=1;var listenerName="_setdrum_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.drumStyle[turtle].pop()};that._setListener(turtle,listenerName,__listener),that.inRhythmRuler&&(that._currentDrumBlock=blk,that.rhythmRuler.Drums.push(blk),that.rhythmRuler.Rulers.push([[],[]]));break;case"setvoice":var voicename=null;for(var voice in VOICENAMES)VOICENAMES[voice][0]===args[0]?voicename=VOICENAMES[voice][1]:VOICENAMES[voice][1]===args[0]&&(voicename=args[0]);if(null==voicename)for(var drum in DRUMNAMES)DRUMNAMES[drum][0]===args[0]?voicename=DRUMNAMES[drum][1]:DRUMNAMES[drum][1]===args[0]&&(voicename=args[0]);if(null==voicename)that.errorMsg(NOINPUTERRORMSG,blk),childFlow=args[1],childFlowCount=1;else{that.voices[turtle].push(voicename),childFlow=args[1],childFlowCount=1;var listenerName="_setvoice_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.voices[turtle].pop()};that._setListener(turtle,listenerName,__listener)}break;case"vibrato":var intensity=args[0],rate=args[1];(intensity<1||intensity>100)&&(that.errorMsg(_("Vibrato intensity must be between 1 and 100."),blk),that.stopTurtle=!0),rate<=0&&(that.errorMsg(_("Vibrato rate must be greater than 0."),blk),that.stopTurtle=!0),childFlow=args[2],childFlowCount=1,that.vibratoIntensity[turtle].push(intensity/100),that.vibratoRate[turtle].push(Math.floor(Math.pow(rate,-1)));var listenerName="_vibrato_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.vibratoIntensity[turtle].pop(),that.vibratoRate[turtle].pop()};that._setListener(turtle,listenerName,__listener);break;case"interval":if("number"!=typeof args[0]){that.errorMsg(NOINPUTERRORMSG,blk),that.stopTurtle=!0;break}if(args[0]>0)var i=Math.floor(args[0]);else var i=Math.ceil(args[0]);if(0!==i){that.intervals[turtle].push(i);var listenerName="_interval_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.intervals[turtle].pop()};that._setListener(turtle,listenerName,__listener)}childFlow=args[1],childFlowCount=1;break;case"perfectx":if(args[0]<0)var interval=mod12(-args[0]);else var interval=mod12(args[0]);var deltaOctave=calcOctaveInterval(args[1]);if(-1!==[1,4,5,8].indexOf(interval)){that.perfect[turtle].push([args[0],deltaOctave]);var listenerName="_perfect_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.perfect[turtle].pop()};that._setListener(turtle,listenerName,__listener)}else that.errorMsg(_("Input to Perfect Block must be 1, 4, 5, or 8"),blk);childFlow=args[2],childFlowCount=1;break;case"perfect":var mod12Arg=mod12(args[0]);if(-1!==[1,4,5,8].indexOf(mod12Arg)){that.perfect[turtle].push([args[0],0]);var listenerName="_perfect_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.perfect[turtle].pop()};that._setListener(turtle,listenerName,__listener)}else that.errorMsg(_("Input to Perfect Block must be 1, 4, 5, or 8"),blk);childFlow=args[1],childFlowCount=1;break;case"diminishedx":if(args[0]<0)var interval=mod12(-args[0]);else var interval=mod12(args[0]);var deltaOctave=calcOctaveInterval(args[1]);if(-1!==[1,2,3,4,5,6,7,8].indexOf(interval)){that.diminished[turtle].push([args[0],deltaOctave]);var listenerName="_diminished_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.diminished[turtle].pop()};that._setListener(turtle,listenerName,__listener)}else that.errorMsg(_("Input to Diminished Block must be 1, 2, 3, 4, 5, 6, 7, or 8"),blk);childFlow=args[2],childFlowCount=1;break;case"diminished":var mod12Arg=mod12(args[0]);if(-1!==[1,2,3,4,5,6,7,8].indexOf(mod12Arg)){that.diminished[turtle].push([args[0],0]);var listenerName="_diminished_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.diminished[turtle].pop()};that._setListener(turtle,listenerName,__listener)}else that.errorMsg(_("Input to Diminished Block must be 1, 2, 3, 4, 5, 6, 7, or 8"),blk);childFlow=args[1],childFlowCount=1;break;case"augmentedx":if(args[0]<0)var interval=mod12(-args[0]);else var interval=mod12(args[0]);var deltaOctave=calcOctaveInterval(args[1]);if(-1!==[1,2,3,4,5,6,7,8].indexOf(interval)){that.augmented[turtle].push([args[0],deltaOctave]);var listenerName="_augmented_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.augmented[turtle].pop()};that._setListener(turtle,listenerName,__listener)}else that.errorMsg(_("Input to Augmented Block must be 1, 2, 3, 4, 5, 6, 7, or 8"),blk);childFlow=args[2],childFlowCount=1;break;case"augmented":var mod12Arg=mod12(args[0]);if(-1!==[1,2,3,4,5,6,7,8].indexOf(mod12Arg)){that.augmented[turtle].push([args[0],0]);var listenerName="_tritone_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.augmented[turtle].pop()};that._setListener(turtle,listenerName,__listener)}else that.errorMsg(_("Input to Augmented Block must be 1, 2, 3, 4, 5, 6, 7, or 8"),blk);childFlow=args[1],childFlowCount=1;break;case"majorx":if(args[0]<0)var interval=mod12(-args[0]);else var interval=mod12(args[0]);var deltaOctave=calcOctaveInterval(args[1]);if(-1!==[2,3,6,7].indexOf(interval)){that.major[turtle].push([args[0],deltaOctave]);var listenerName="_major_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.major[turtle].pop()};that._setListener(turtle,listenerName,__listener)}else that.errorMsg(_("Input to Major Block must be 2, 3, 6, or 7"),blk);childFlow=args[2],childFlowCount=1;break;case"major":var mod12Arg=mod12(args[0]),octaveArg=args[1];if(-1!==[2,3,6,7].indexOf(mod12Arg)){that.major[turtle].push([args[0],0]);var listenerName="_major_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.major[turtle].pop()};that._setListener(turtle,listenerName,__listener)}else that.errorMsg(_("Input to Major Block must be 2, 3, 6, or 7"),blk);childFlow=args[1],childFlowCount=1;break;case"minorx":if(args[0]<0)var interval=mod12(-args[0]);else var interval=mod12(args[0]);var deltaOctave=calcOctaveInterval(args[1]);if(-1!==[2,3,6,7].indexOf(interval)){that.minor[turtle].push([args[0],deltaOctave]);var listenerName="_minor_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.minor[turtle].pop()};that._setListener(turtle,listenerName,__listener)}else that.errorMsg(_("Input to Minor Block must be 2, 3, 6, or 7"),blk);childFlow=args[2],childFlowCount=1;break;case"minor":var mod12Arg=mod12(args[0]);if(-1!==[2,3,6,7].indexOf(mod12Arg)){that.minor[turtle].push([args[0],0]);var listenerName="_minor_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.minor[turtle].pop()};that._setListener(turtle,listenerName,__listener)}else that.errorMsg(_("Input to Minor Block must be 2, 3, 6, or 7"),blk);childFlow=args[1],childFlowCount=1;break;case"newstaccato":case"staccato":if(args.length>1){"newstaccato"===that.blocks.blockList[blk].name?that.staccato[turtle].push(1/args[0]):that.staccato[turtle].push(args[0]),childFlow=args[1],childFlowCount=1;var listenerName="_staccato_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.staccato[turtle].pop()};that._setListener(turtle,listenerName,__listener)}break;case"newslur":case"slur":if(args.length>1){"newslur"===that.blocks.blockList[blk].name?that.staccato[turtle].push(-1/args[0]):that.staccato[turtle].push(-args[0]),that.justCounting[turtle]||lilypondBeginSlur(that,turtle),childFlow=args[1],childFlowCount=1;var listenerName="_staccato_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.staccato[turtle].pop(),that.justCounting[turtle]||lilypondEndSlur(that,turtle)};that._setListener(turtle,listenerName,__listener)}break;case"drift":that.drift[turtle]+=1,childFlow=args[0],childFlowCount=1;var listenerName="_drift_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.drift[turtle]-=1};that._setListener(turtle,listenerName,__listener);break;case"tie":that.tie[turtle]=!0,that.tieNote[turtle]=[],that.tieCarryOver[turtle]=0,childFlow=args[0],childFlowCount=1;var listenerName="_tie_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){if(that.tie[turtle]=!1,that.tieCarryOver[turtle]>0){if(!that.justCounting[turtle])for(var r=0;r<that.notePitches[turtle].length;r++)lilypondRemoveTie(that,turtle);var l=that.tieCarryOver[turtle];that.tieCarryOver[turtle]=0,that._processNote(l,blk,turtle)}that.tieNote[turtle]=[]};that._setListener(turtle,listenerName,__listener);break;case"newswing":case"newswing2":case"swing":"newswing2"===that.blocks.blockList[blk].name?(that.swing[turtle].push(1/args[0]),that.swingTarget[turtle].push(1/args[1]),childFlow=args[2]):"newswing"===that.blocks.blockList[blk].name?(that.swing[turtle].push(1/args[0]),that.swingTarget[turtle].push(null),childFlow=args[1]):(that.swing[turtle].push(args[0]),that.swingTarget[turtle].push(null),childFlow=args[1]),that.swingCarryOver[turtle]=0,childFlowCount=1;var listenerName="_swing_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.swingTarget[turtle].pop(),that.swing[turtle].pop(),that.swingCarryOver[turtle]=0};that._setListener(turtle,listenerName,__listener);break;case"duplicatenotes":var factor=args[0];if(0===factor)that.errorMsg(ZERODIVIDEERRORMSG,blk),that.stopTurtle=!0;else{that.duplicateFactor[turtle]*=factor,childFlow=args[1],childFlowCount=1;var listenerName="_duplicate_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.duplicateFactor[turtle]/=factor};that._setListener(turtle,listenerName,__listener)}break;case"skipnotes":var factor=args[0];if(0===factor)that.errorMsg(ZERODIVIDEERRORMSG,blk),that.stopTurtle=!0;else{that.skipFactor[turtle]*=factor,childFlow=args[1],childFlowCount=1;var listenerName="_skip_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.skipFactor[turtle]/=factor,1===that.skipFactor[turtle]&&(that.skipIndex[turtle]=0)};that._setListener(turtle,listenerName,__listener)}break;case"multiplybeatfactor":var factor=args[0];if(0===factor)that.errorMsg(ZERODIVIDEERRORMSG,blk),that.stopTurtle=!0;else{that.beatFactor[turtle]*=factor,childFlow=args[1],childFlowCount=1;var listenerName="_multiplybeat_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.beatFactor[turtle]/=factor};that._setListener(turtle,listenerName,__listener)}break;case"dividebeatfactor":var factor=args[0];if(0===factor)that.errorMsg(ZERODIVIDEERRORMSG,blk),that.stopTurtle=!0;else{that.beatFactor[turtle]/=factor,childFlow=args[1],childFlowCount=1;var listenerName="_dividebeat_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.beatFactor[turtle]*=factor};that._setListener(turtle,listenerName,__listener)}break;case"settransposition":var transValue=args[0];0!==that.invertList[turtle].length?that.transposition[turtle]-=transValue:that.transposition[turtle]+=transValue,childFlow=args[1],childFlowCount=1;var listenerName="_transposition_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){0!==that.invertList[turtle].length?that.transposition[turtle]+=transValue:that.transposition[turtle]-=transValue};that._setListener(turtle,listenerName,__listener);break;case"sharp":0!==that.invertList[turtle].length?that.transposition[turtle]-=1:that.transposition[turtle]+=1,childFlow=args[0],childFlowCount=1;var listenerName="_sharp_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){0!==that.invertList[turtle].length?that.transposition[turtle]+=1:that.transposition[turtle]-=1};that._setListener(turtle,listenerName,__listener);break;case"flat":0!==that.invertList[turtle].length?that.transposition[turtle]+=1:that.transposition[turtle]-=1,childFlow=args[0],childFlowCount=1;var listenerName="_flat_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){0!==that.invertList[turtle].length?that.transposition[turtle]-=1:that.transposition[turtle]+=1};that._setListener(turtle,listenerName,__listener);break;case"articulation":if(2===args.length&&"number"==typeof args[0]&&args[0]>0){var newVolume=last(that.polyVolume[turtle])*(100+args[0])/100;newVolume>100&&(console.log("articulated volume exceeds 100%. clipping"),newVolume=100),that.polyVolume[turtle].push(newVolume),that._setSynthVolume(newVolume,turtle),that.justCounting[turtle]||lilypondBeginArticulation(that,turtle),childFlow=args[1],childFlowCount=1;var listenerName="_articulation_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.polyVolume[turtle].pop(),that.justCounting[turtle]||lilypondEndArticulation(that,turtle)};that._setListener(turtle,listenerName,__listener)}break;case"setnotevolume2":if(2===args.length&&"number"==typeof args[0]){that.polyVolume[turtle].push(args[0]),that._setSynthVolume(args[0],turtle),childFlow=args[1],childFlowCount=1;var listenerName="_volume_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.polyVolume[turtle].pop()};that._setListener(turtle,listenerName,__listener)}break;case"setnotevolume":1===args.length&&("string"==typeof args[0]?(that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0):that._setSynthVolume(args[0],turtle));break;case"tone":break;case"tone2":_THIS_IS_TURTLE_BLOCKS_&&(void 0===that.turtleOscs[turtle]&&(that.turtleOscs[turtle]=new p5.TriOsc),osc=that.turtleOscs[turtle],osc.stop(),osc.start(),osc.amp(0),osc.freq(args[0]),osc.fade(.5,.2),setTimeout((function(e){e.fade(0,.2)}),args[1],osc));break;case"hertz":if(1!==args.length||null==args[0]){that.errorMsg(NOINPUTERRORMSG,blk),that.stopTurtle=!0;break}if("number"!=typeof args[0]){that.errorMsg(NANERRORMSG,blk),that.stopTurtle=!0;break}var obj=frequencyToPitch(args[0]),note=obj[0],octave=obj[1],cents=obj[2],delta=0;if("?"===note)that.errorMsg(INVALIDPITCH,blk),that.stopTurtle=!0;else if(that.inMatrix)that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0]);else if(that.inNoteBlock[turtle]>0){function addPitch(e,r,l,s){if(that.drumStyle[turtle].length>0){var o=last(that.drumStyle[turtle]),h=that.getNote(e,r,transposition,that.keySignature[turtle]);that.pitchDrumTable[turtle][h[0]+h[1]]=o}that.notePitches[turtle].push(e),that.noteOctaves[turtle].push(r),that.noteCents[turtle].push(l),that.noteHertz[turtle].push(s)}if(0!==that.invertList[turtle].length)for(var len=that.invertList[turtle].length,note1=that.getNote(note,octave,0,that.keySignature[turtle]),num1=getNumber(note1[0],note1[1]),i=len-1;i>-1;i--){var note2=that.getNote(that.invertList[turtle][i][0],that.invertList[turtle][i][1],0,that.keySignature[turtle]),num2=getNumber(note2[0],note2[1]);"even"===that.invertList[turtle][i][2]?delta+=num2-num1:delta+=num2-num1+.5,num1+=2*delta}if(addPitch(note,octave,cents,args[0]),turtle in that.intervals&&that.intervals[turtle].length>0)for(var i=0;i<that.intervals[turtle].length;i++){var ii=getInterval(that.intervals[turtle][i],that.keySignature[turtle],note),noteObj=that.getNote(note,octave,ii,that.keySignature[turtle]);addPitch(noteObj[0],noteObj[1],cents,0)}if(turtle in that.perfect&&that.perfect[turtle].length>0){var noteObj=that.getNote(note,octave,calcPerfect(last(that.perfect[turtle])),that.keySignature[turtle]);addPitch(noteObj[0],noteObj[1],cents,0)}if(turtle in that.diminished&&that.diminished[turtle].length>0){var noteObj=that.getNote(note,octave,calcDiminished(last(that.diminished[turtle])),that.keySignature[turtle]);addPitch(noteObj[0],noteObj[1],cents,0)}if(turtle in that.augmented&&that.augmented[turtle].length>0){var noteObj=that.getNote(note,octave,calcAugmented(last(that.augmented[turtle])),that.keySignature[turtle]);addPitch(noteObj[0],noteObj[1],cents,0)}if(turtle in that.major&&that.major[turtle].length>0){var noteObj=that.getNote(note,octave,calcMajor(last(that.major[turtle])),that.keySignature[turtle]);addPitch(noteObj[0],noteObj[1],cents,0)}if(turtle in that.minor&&that.minor[turtle].length>0){var noteObj=that.getNote(note,octave,calcMinor(last(that.minor[turtle])),that.keySignature[turtle]);addPitch(noteObj[0],noteObj[1],cents,0)}turtle in that.transposition?that.noteTranspositions[turtle].push(that.transposition[turtle]+2*delta):that.noteTranspositions[turtle].push(2*delta),turtle in that.beatFactor?that.noteBeatValues[turtle].push(that.beatFactor[turtle]):that.noteBeatValues[turtle].push(1),that.pushedNote[turtle]=!0}else if(that.inPitchStaircase){for(var frequency=args[0],note=frequencyToPitch(args[0]),flag=0,i=0;i<that.pitchStaircase.Stairs.length;i++){if(that.pitchStaircase.Stairs[i][2]<parseFloat(frequency)){that.pitchStaircase.Stairs.splice(i,0,[note[0],note[1],parseFloat(frequency)]),flag=1;break}if(that.pitchStaircase.Stairs[i][2]===parseFloat(frequency)){that.pitchStaircase.Stairs.splice(i,1,[note[0],note[1],parseFloat(frequency)]),flag=1;break}}0===flag&&that.pitchStaircase.Stairs.push([note[0],note[1],parseFloat(frequency)])}else that.inPitchSlider?that.pitchSlider.Sliders.push([args[0],0,0]):that.errorMsg(_("Hertz Block: Did you mean to use a Note block?"),blk);break;case"triangle":case"sine":case"square":case"sawtooth":if(1===args.length){var obj=frequencyToPitch(args[0]);that.inMatrix?(that.pitchTimeMatrix.addRowBlock(blk),-1===that.pitchBlocks.indexOf(blk)&&that.pitchBlocks.push(blk),that.pitchTimeMatrix.rowLabels.push(that.blocks.blockList[blk].name),that.pitchTimeMatrix.rowArgs.push(args[0])):that.inPitchSlider?that.pitchSlider.Sliders.push([args[0],0,0]):(that.oscList[turtle].push(that.blocks.blockList[blk].name),that.notePitches[turtle].push(obj[0]),that.noteOctaves[turtle].push(obj[1]),that.noteCents[turtle].push(obj[2]),0!==obj[2]?that.noteHertz[turtle].push(pitchToFrequency(obj[0],obj[1],obj[2],that.keySignature[turtle])):that.noteHertz[turtle].push(0),turtle in that.transposition?that.noteTranspositions[turtle].push(that.transposition[turtle]):that.noteTranspositions[turtle].push(0),turtle in that.beatFactor?that.noteBeatValues[turtle].push(that.beatFactor[turtle]):that.noteBeatValues[turtle].push(1),that.pushedNote[turtle]=!0)}break;case"playfwd":that.pitchTimeMatrix.playDirection=1,that._runFromBlock(that,turtle,args[0]);break;case"playbwd":that.pitchTimeMatrix.playDirection=-1,that._runFromBlock(that,turtle,args[0]);break;case"stuplet":if(that.inMatrix){that.pitchTimeMatrix.addColBlock(blk,args[0]);var noteBeatValue=1/args[1]*that.beatFactor[turtle];if(!0===that.tuplet)for(var i=0;i<args[0];i++)that.addingNotesToTuplet||(that.tupletRhythms.push(["notes",0]),that.addingNotesToTuplet=!0),that._processNote(noteBeatValue,blk,turtle);else{that.tupletParams.push([1,noteBeatValue]);for(var obj=["simple",0],i=0;i<args[0];i++)obj.push(1/args[1]*that.beatFactor[turtle]);that.tupletRhythms.push(obj)}}break;case"tuplet2":case"tuplet3":that.inMatrix?("tuplet3"===that.blocks.blockList[blk].name?that.tupletParams.push([args[0],1/args[1]*that.beatFactor[turtle]]):that.tupletParams.push([args[0],args[1]*that.beatFactor[turtle]]),that.tuplet=!0,that.addingNotesToTuplet=!1):that.errorMsg(_("Tuplet Block: Did you mean to use a Matrix block?"),blk),childFlow=args[2],childFlowCount=1;var listenerName="_tuplet_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.inMatrix&&(that.tuplet=!1,that.addingNotesToTuplet=!1)};that._setListener(turtle,listenerName,__listener);break;case"tuplet4":that.inMatrix?(that.tupletParams.push([1,1/args[0]*that.beatFactor[turtle]]),that.tuplet=!0,that.addingNotesToTuplet=!1):that.errorMsg(_("Tuplet Block: Did you mean to use a Matrix block?"),blk),childFlow=args[1],childFlowCount=1;var listenerName="_tuplet_"+turtle;that._setDispatchBlock(blk,turtle,listenerName);var __listener=function(e){that.inMatrix&&(that.tuplet=!1,that.addingNotesToTuplet=!1)};that._setListener(turtle,listenerName,__listener);break;default:that.blocks.blockList[blk].name in that.evalFlowDict?eval(that.evalFlowDict[that.blocks.blockList[blk].name]):(that.blocks.blockList[blk].isArgBlock()?(args.push(that.parseArg(that,turtle,blk)),console.log("block: "+blk+" turtle: "+turtle),console.log("block name: "+that.blocks.blockList[blk].name),console.log("block value: "+that.blocks.blockList[blk].value),null==that.blocks.blockList[blk].value?that.textMsg("null block value"):that.textMsg(that.blocks.blockList[blk].value.toString())):that.errorMsg("I do not know how to "+that.blocks.blockList[blk].name+".",blk),that.stopTurtle=!0)}if(blk in that.endOfClampSignals[turtle]){for(var i=that.endOfClampSignals[turtle][blk].length-1;i>=0;i--){var signal=that.endOfClampSignals[turtle][blk][i];null!=signal&&(that.stage.dispatchEvent(that.endOfClampSignals[turtle][blk][i]),that.endOfClampSignals[turtle][blk][i]=null)}for(var cleanSignals=[],i=0;i<that.endOfClampSignals[turtle][blk].length;i++)null!=that.endOfClampSignals[turtle][blk][i]&&cleanSignals.push(that.endOfClampSignals[turtle][blk][i]);that.endOfClampSignals[turtle][blk]=cleanSignals}if("visible"===docById("statusDiv").style.visibility&&that.statusMatrix.updateAll(),null!=childFlow){if("doArg"===that.blocks.blockList[blk].name||"nameddoArg"===that.blocks.blockList[blk].name)var queueBlock=new Queue(childFlow,childFlowCount,blk,actionArgs);else var queueBlock=new Queue(childFlow,childFlowCount,blk,receivedArg);that.parentFlowQueue[turtle].push(blk),that.turtles.turtleList[turtle].queue.push(queueBlock)}var nextBlock=null,parentBlk=null;if(that.turtles.turtleList[turtle].queue.length>queueStart&&(nextBlock=last(that.turtles.turtleList[turtle].queue).blk,parentBlk=last(that.turtles.turtleList[turtle].queue).parentBlk,passArg=last(that.turtles.turtleList[turtle].queue).args,1===last(that.turtles.turtleList[turtle].queue).count?that.turtles.turtleList[turtle].queue.pop():last(that.turtles.turtleList[turtle].queue).count-=1),null!=nextBlock){if(parentBlk!==blk&&(that.turtleDelay===TURTLESTEP?that.unhighlightStepQueue[turtle]=blk:setTimeout((function(){that.blocks.visible&&that.blocks.unhighlight(blk)}),that.turtleDelay+that.waitTimes[turtle])),(that.backward[turtle].length>0&&null==that.blocks.blockList[blk].connections[0]||0===that.backward[turtle].length&&null==last(that.blocks.blockList[blk].connections))&&(that.parentFlowQueue[turtle].length>0&&that.turtles.turtleList[turtle].queue.length>0&&last(that.turtles.turtleList[turtle].queue).parentBlk!==last(that.parentFlowQueue[turtle])?that.unhightlightQueue[turtle].push(last(that.parentFlowQueue[turtle])):that.unhightlightQueue[turtle].length>0&&setTimeout((function(){that.blocks.visible?that.blocks.unhighlight(that.unhightlightQueue[turtle].pop()):that.unhightlightQueue[turtle].pop()}),that.turtleDelay)),0!==that.turtleDelay)for(var pblk in that.parameterQueue[turtle])that._updateParameterBlock(that,turtle,that.parameterQueue[turtle][pblk]);isflow?that._runFromBlockNow(that,turtle,nextBlock,isflow,passArg,queueStart):that._runFromBlock(that,turtle,nextBlock,isflow,passArg)}else{for(var b in that.endOfClampSignals[turtle])for(var i=0;i<that.endOfClampSignals[turtle][b].length;i++)null!=that.endOfClampSignals[turtle][b][i]&&that.stage.dispatchEvent(that.endOfClampSignals[turtle][b][i]);if(turtle in that.forwardListener)for(var b in that.forwardListener[turtle])for(var i=0;i<this.forwardListener[turtle][b].length;i++)that.stage.removeEventListener("_forward_"+turtle,that.forwardListener[turtle][b][i],!1);if(turtle in that.rightListener)for(var b in that.rightListener[turtle])for(var i=0;i<this.rightListener[turtle][b].length;i++)that.stage.removeEventListener("_right_"+turtle,that.rightListener[turtle][b][i],!1);if(turtle in that.arcListener)for(var b in that.arcListener[turtle])for(var i=0;i<this.arcListener[turtle][b].length;i++)that.stage.removeEventListener("_arc_"+turtle,that.arcListener[turtle][b][i],!1);for(var b in that.turtles.turtleList[turtle].closeSVG(),that.turtles.turtleList[turtle].running=!1,that.turtles.running()||0!==queueStart||that.onStopTurtle(),__checkLilypond=function(){that.turtles.running()||0!==queueStart||!that.suppressOutput[turtle]||that.justCounting[turtle]?that.suppressOutput[turtle]&&setTimeout((function(){__checkLilypond()}),250):(console.log("saving lilypond output: "+that.lilypondStaging),saveLilypondOutput(that,_("My Project")+".ly"),that.suppressOutput[turtle]=!1,that.checkingLilypond=!1,that.runningLilypond=!1,document.body.style.cursor="default")},that.turtles.running()||0!==queueStart||!that.suppressOutput[turtle]||that.justCounting[turtle]||that.checkingLilypond||(that.checkingLilypond=!0,setTimeout((function(){__checkLilypond()}),250)),0!==that.turtles.turtleList[turtle].queue.length&&blk===last(that.turtles.turtleList[turtle].queue).parentBlk||setTimeout((function(){that.blocks.visible&&that.blocks.unhighlight(blk)}),that.turtleDelay),that.parentFlowQueue[turtle])that.blocks.visible&&that.blocks.unhighlight(that.parentFlowQueue[turtle][b]);var i=that.stage.getNumChildren()-1;for(var arg in that.stage.setChildIndex(that.turtles.turtleList[turtle].container,i),that.refreshCanvas(),that.evalOnStopList)eval(that.evalOnStopList[arg])}clearTimeout(this.saveTimeout);var me=this;this.saveTimeout=setTimeout((function(){me.saveLocally()}),1.5*DEFAULTDELAY)},this._setSynthVolume=function(e,r){e>100?e=100:e<0&&(e=0),_THIS_IS_MUSIC_BLOCKS_&&this.synth.setVolume(e)},this._processNote=function(e,r,l){if(this.bpm[l].length>0)var s=TONEBPM/last(this.bpm[l]);else s=TONEBPM/this._masterBPM;if("osctime"===this.blocks.blockList[r].name)if(0==e)var o=0;else o=1e3*s/e;else o=e;this.notesPlayed[l]+=1/(e*this.beatFactor[l]);var h=0,u=0,g=0,p=!1;this.vibratoRate[l].length>0&&(h=last(this.vibratoRate[l]),g=last(this.vibratoIntensity[l]),p=!0);var m=0;if(0===this.crescendoDelta[l].length&&this._setSynthVolume(last(this.polyVolume[l]),l),this.inMatrix){if(this.inNoteBlock[l]>0){this.pitchTimeMatrix.addColBlock(r,1);for(var f=0;f<this.pitchBlocks.length;f++)this.pitchTimeMatrix.addNode(this.pitchBlocks[f],r,0);for(f=0;f<this.drumBlocks.length;f++)this.pitchTimeMatrix.addNode(this.drumBlocks[f],r,0)}if(o*=this.beatFactor[l],!0===this.tuplet)if(this.addingNotesToTuplet){f=this.tupletRhythms.length-1;this.tupletRhythms[f].push(o)}else this.tupletRhythms.push(["notes",this.tupletParams.length-1,o]),this.addingNotesToTuplet=!0;else this.tupletRhythms.push(["",1,o])}else{if(null==this.firstNoteTime&&!this.suppressOutput[l]){var L=new Date;this.firstNoteTime=L.getTime()}var N=((L=new Date).getTime()-this.firstNoteTime)/1e3;if(0===this.drift[l])var S=N-this.turtleTime[l];else S=0;if(this.tie[l]){if(this.tieCarryOver[l]>0){var M=!0;if(this.tieNote[l].length!==this.notePitches[l].length)M=!1;else for(f=0;f<this.tieNote[l].length;f++){if(this.tieNote[l][f][0]!=this.notePitches[l][f]){M=!1;break}if(this.tieNote[l][f][1]!=this.noteOctaves[l][f]){M=!1;break}}if(!M){var w=this.tieCarryOver[l];this.tieCarryOver[l]=0,this.tie[l]=!1;var O=[];for(f=0;f<this.notePitches[l].length;f++)O.push([this.notePitches[l][f],this.noteOctaves[l][f],this.noteCents[l][f],this.noteHertz[l][f]]);this.notePitches[l]=[],this.noteOctaves[l]=[],this.noteCents[l]=[],this.noteHertz[l]=[];for(f=0;f<this.tieNote[l].length;f++)this.notePitches[l].push(this.tieNote[l][f][0]),this.noteOctaves[l].push(this.tieNote[l][f][1]),this.noteCents[l].push(this.tieNote[l][f][2]),this.noteHertz[l].push(this.tieNote[l][f][3]);if(this.tieNote[l]=[],!this.justCounting[l])for(f=0;f<this.notePitches[l].length;f++)lilypondRemoveTie(this,l);this._processNote(w,r,l),this.tie[l]=!0,this.notePitches[l]=[],this.noteOctaves[l]=[],this.noteCents[l]=[],this.noteHertz[l]=[];for(f=0;f<O.length;f++)this.notePitches[l].push(O[f][0]),this.noteOctaves[l].push(O[f][1]),this.noteCents[l].push(O[f][2]),this.noteHertz[l].push(O[f][3])}}if(0===this.tieCarryOver[l]){this.tieNote[l]=[],this.tieCarryOver[l]=o;for(f=0;f<this.notePitches[l].length;f++)this.tieNote[l].push([this.notePitches[l][f],this.noteOctaves[l][f],this.noteCents[l][f],this.noteHertz[l][f]]);o=0}else m=this.tieCarryOver[l],o=1/(1/o+1/this.tieCarryOver[l]),this.tieCarryOver[l]=0}if(this.swing[l].length>0){null==last(this.swingTarget[l])&&(this.swingTarget[l][this.swingTarget[l].length-1]=o);var T=last(this.swing[l]);o===last(this.swingTarget[l])&&(0===this.swingCarryOver[l]?(o=1/(1/o+1/T),this.swingCarryOver[l]=T):(o=o===T?0:1/(1/o-1/T),this.swingCarryOver[l]=0),o<0&&(o=0))}var B=o*this.beatFactor[l];B>0&&!this.suppressOutput[l]&&(this.turtleTime[l]+=(s/B+this.noteDelay/1e3)*this.duplicateFactor[l]),this.suppressOutput[l]||B>0&&this._doWait(l,Math.max((s/B+this.noteDelay/1e3)*this.duplicateFactor[l]-S,0));for(var R=0,F=0;F<this.duplicateFactor[l];F++)if(this.skipFactor[l]>1&&this.skipIndex[l]%this.skipFactor[l]>0)this.skipIndex[l]+=1,B>0&&(this.waitTimes[l]-=1e3*(s/B+this.noteDelay/1e3),this.waitTimes[l]<0&&(this.waitTimes[l]=0));else{if(this.skipFactor[l]>1&&(this.skipIndex[l]+=1),this.suppressOutput[l]?R=0:F>0&&B>0&&(R+=1e3*s/B),__playnote=function(e){var f=[],L=[],N=-1;if(e.notePitches[l].length+e.oscList[l].length>1)if(l in e.lilypondStaging&&!e.justCounting[l])N=e.lilypondStaging[l].length+1;else N=1;if(e.noteBeat[l]=o,isFinite(B)){if(e.staccato[l].length>0){var S=last(e.staccato[l]);if(S<0)var M=s/(o*e.noteBeatValues[l][0])+s/(-S*e.noteBeatValues[l][0]);else if(S>o)M=s/(S*e.noteBeatValues[l][0]);else M=s/(o*e.noteBeatValues[l][0])}else M=s/(o*e.noteBeatValues[l][0]);if(p&&(u=M*(B/h)),e._dispatchTurtleSignals(l,M,r,o),e.notePitches[l].length>0){for(var w=0;w<e.notePitches[l].length;w++){if("rest"===e.notePitches[l][w])T="R";else{var O=e.getNote(e.notePitches[l][w],e.noteOctaves[l][w],e.noteTranspositions[l][w],e.keySignature[l]);if(0!==e.noteCents[l][w])if(0!==e.noteHertz[l][w]&&0===e.noteTranspositions[l][w])var T=e.noteHertz[l][w];else T=Math.floor(pitchToFrequency(O[0],O[1],e.noteCents[l][w],e.keySignature[l]));else T=O[0]+O[1]}"R"!==T&&f.push(T),B>0?(m>0?(0!==w||e.justCounting[l]||lilypondInsertTie(e,l),originalDuration=1/(1/B-1/m)):originalDuration=B,e.justCounting[l]||updateLilypondNotation(e,T,originalDuration,l,N)):e.tieCarryOver[l]>0&&(e.justCounting[l]||updateLilypondNotation(e,T,e.tieCarryOver[l],l,N))}if(e.justCounting[l]?console.log("notes to count "+f+" "+o):console.log("notes to play "+f+" "+o),e.suppressOutput[l]||e.turtles.turtleList[l].blink(B,last(e.polyVolume[l])),f.length>0){var R=f[0].length;if("string"==typeof f[w]&&(e.currentNotes[l]=f[0].slice(0,R-1),e.currentOctaves[l]=parseInt(f[0].slice(R-1))),e.turtles.turtleList[l].drum)for(w=0;w<f.length;w++)f[w]=f[w].replace(/â™­/g,"b").replace(/â™¯/g,"#");else for(w=0;w<f.length;w++)"string"==typeof f[w]&&(f[w]=f[w].replace(/â™­/g,"b").replace(/â™¯/g,"#"));if(!e.suppressOutput[l]&&B>0&&_THIS_IS_MUSIC_BLOCKS_){if(e.oscList[l].length>0)f.length>1&&e.errorMsg(last(e.oscList[l])+": "+_("synth cannot play chords."),r),e.synth.trigger(f,M,last(e.oscList[l]),[g,u]);else if(e.drumStyle[l].length>0)e.synth.trigger(f,M,last(e.drumStyle[l]),[]);else if(e.turtles.turtleList[l].drum)e.synth.trigger(f,M,"drum",[]);else for(var F=0;F<f.length;F++)f[F]in e.pitchDrumTable[l]?e.synth.trigger(f[F],M,e.pitchDrumTable[l][f[F]],[]):l in e.voices&&last(e.voices[l])?e.synth.trigger(f[F],M,last(e.voices[l]),[g,u]):e.synth.trigger(f[F],M,"default",[g,u]);e.synth.start()}e.lastNotePlayed[l]=[f[0],o],e.noteStatus[l]=[f,o]}}if(e.noteDrums[l].length>0){for(w=0;w<e.noteDrums[l].length;w++)L.push(e.noteDrums[l][w]);if(!e.suppressOutput[l]&&B>0&&_THIS_IS_MUSIC_BLOCKS_)for(w=0;w<L.length;w++)e.drumStyle[l].length>0?e.synth.trigger(["C2"],M,last(e.drumStyle[l]),[]):e.synth.trigger(["C2"],M,L[w],[])}setTimeout((function(){e.blocks.visible&&e.blocks.unhighlight(r)}),1e3*M)}},0===R||this.suppressOutput[l])__playnote(this);else{var A=this;setTimeout((function(){__playnote(A)}),R+this.noteDelay)}if(this.crescendoDelta[l].length>0){last(this.crescendoVolume[l])!==last(this.crescendoInitialVolume[l])||this.justCounting[l]||lilypondBeginCrescendo(this,l,last(this.crescendoDelta[l]));var C=this.crescendoVolume[l].length;this.crescendoVolume[l][C-1]+=this.crescendoDelta[l][C-1],this._setSynthVolume(this.crescendoVolume[l][C-1],l);var D=this.polyVolume[l].length;this.polyVolume[l][D-1]=this.crescendoVolume[l][C-1]}}this.pushedNote[l]=!1}},this._dispatchTurtleSignals=function(e,r,l,s){var o=this,h=1e3*r/(NOTEDIV+4);o.dispatchFactor[e]=h>200?.25:h>100?.5:h>50?1:h>25?2:h>12.5?4:8;for(var u=0;u<NOTEDIV/o.dispatchFactor[e];u++)setTimeout((function(){e in o.forwardListener&&l in o.forwardListener[e]&&o.stage.dispatchEvent("_forward_"+e+"_"+l),e in o.rightListener&&l in o.rightListener[e]&&o.stage.dispatchEvent("_right_"+e+"_"+l),e in o.arcListener&&l in o.arcListener[e]&&o.stage.dispatchEvent("_arc_"+e+"_"+l)}),u*h*o.dispatchFactor[e]);setTimeout((function(){if(e in o.forwardListener&&l in o.forwardListener[e]){for(var r=0;r<o.forwardListener[e][l].length;r++)o.stage.removeEventListener("_forward_"+e+"_"+l,o.forwardListener[e][l][r],!1);delete o.forwardListener[e][l]}if(e in o.rightListener&&l in o.rightListener[e]){for(r=0;r<o.rightListener[e][l].length;r++)o.stage.removeEventListener("_right_"+e+"_"+l,o.rightListener[e][l][r],!1);delete o.rightListener[e][l]}if(e in o.arcListener&&l in o.arcListener[e]){for(r=0;r<o.arcListener[e][l].length;r++)o.stage.removeEventListener("_arc_"+e+"_"+l,o.arcListener[e][l][r],!1);delete o.arcListener[e][l]}}),1e3*r)},this._setListener=function(e,r,l){r in this.turtles.turtleList[e].listeners&&this.stage.removeEventListener(r,this.turtles.turtleList[e].listeners[r],!1),this.turtles.turtleList[e].listeners[r]=l,this.stage.addEventListener(r,l,!1)},this._setDispatchBlock=function(e,r,l){if(this.backward[r].length>0){if("backward"===this.blocks.blockList[last(this.backward[r])].name)var s=1;else s=2;if(this.blocks.sameGeneration(this.blocks.blockList[last(this.backward[r])].connections[s],e)){var o=this.blocks.blockList[e].connections[0];this.endOfClampSignals[r][o]=[l]}else o=null}else o=last(this.blocks.blockList[e].connections);null!=o&&(this.endOfClampSignals[r][o]=[l])},this._getTargetTurtle=function(e){var r=e[0];"number"==typeof r&&(r=r.toString());for(var l=0;l<this.turtles.turtleList.length;l++){var s=this.turtles.turtleList[l].name;if("number"==typeof s&&(s=s.toString()),s===r)return l}return null},this._loopBlock=function(e){return-1!==["forever","repeat","while","until"].indexOf(e)},this._doBreak=function(e){for(var r=null,l=-1,s=this.turtles.turtleList[e].queue.length-1;s>-1;s--){if(this._loopBlock(this.blocks.blockList[this.turtles.turtleList[e].queue[s].blk].name)){l=this.turtles.turtleList[e].queue[s].blk,r=this.blocks.blockList[l],this.turtles.turtleList[e].queue.pop();break}if(this._loopBlock(this.blocks.blockList[this.turtles.turtleList[e].queue[s].parentBlk].name)){l=this.turtles.turtleList[e].queue[s].parentBlk,r=this.blocks.blockList[l],this.turtles.turtleList[e].queue.pop();break}}if(null!=r){if("while"===r.name||"until"===r.name){var o=last(r.connections);if(null!=o){var h=new Queue(o,1,l);this.parentFlowQueue[e].push(l),this.turtles.turtleList[e].queue.push(h)}}}else this.turtles.turtleList[e].queue.pop()},this.parseArg=function(that,turtle,blk,parentBlk,receivedArg){if(null==blk)return that.errorMsg("Missing argument.",parentBlk),that.stopTurtle=!0,null;if(that.blocks.blockList[blk].protoblock.parameter&&turtle in that.parameterQueue&&-1===that.parameterQueue[turtle].indexOf(blk)&&that.parameterQueue[turtle].push(blk),that.blocks.blockList[blk].isValueBlock()){if("number"===that.blocks.blockList[blk].name&&"string"==typeof that.blocks.blockList[blk].value)try{that.blocks.blockList[blk].value=Number(that.blocks.blockList[blk].value)}catch(e){console.log(e)}return that.blocks.blockList[blk].value}if(that.blocks.blockList[blk].isArgBlock()||that.blocks.blockList[blk].isArgClamp()||that.blocks.blockList[blk].isArgFlowClampBlock()){switch(that.blocks.blockList[blk].name){case"loudness":if(_THIS_IS_TURTLE_BLOCKS_)try{that.mic.enabled?that.blocks.blockList[blk].value=Math.round(1e3*that.mic.getLevel()):(that.mic.start(),that.blocks.blockList[blk].value=0)}catch(e){console.log(e),that.mic.start(),that.blocks.blockList[blk].value=Math.round(1e3*that.mic.getLevel())}else{for(var values=that.analyser.analyse(),sum=0,k=0;k<that.limit;k++)sum+=values[k]*values[k];var rms=Math.sqrt(sum/that.limit);try{that.mic.open()?that.blocks.blockList[blk].value=Math.round(rms):(that.mic.open(),that.blocks.blockList[blk].value=0)}catch(e){console.log(e),that.mic.open(),that.blocks.blockList[blk].value=Math.round(rms)}}break;case"eval":var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=Number(eval("Math."+a.replace(/x/g,b.toString())));break;case"arg":var cblk=that.blocks.blockList[blk].connections[1],name=that.parseArg(that,turtle,cblk,blk,receivedArg),action_args=receivedArg;if(action_args.length>=Number(name)){var value=action_args[Number(name)-1];that.blocks.blockList[blk].value=value}else that.errorMsg("Invalid argument",blk),that.stopTurtle=!0;return that.blocks.blockList[blk].value;case"box":var cblk=that.blocks.blockList[blk].connections[1],name=that.parseArg(that,turtle,cblk,blk,receivedArg);name in that.boxes?that.blocks.blockList[blk].value=that.boxes[name]:(that.errorMsg(NOBOXERRORMSG,blk,name),that.stopTurtle=!0,that.blocks.blockList[blk].value=null);break;case"turtlename":that.blocks.blockList[blk].value=that.turtles.turtleList[turtle].name;break;case"namedbox":var name=that.blocks.blockList[blk].privateData;that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,that.blocks.blockList[blk].name]):that.updatingStatusMatrix||(name in that.boxes?that.blocks.blockList[blk].value=that.boxes[name]:(that.errorMsg(NOBOXERRORMSG,blk,name),that.stopTurtle=!0,that.blocks.blockList[blk].value=null));break;case"namedarg":var name=that.blocks.blockList[blk].privateData,action_args=receivedArg;if(null==action_args)return that.errorMsg("Invalid argument",blk),that.stopTurtle=!0,void(that.blocks.blockList[blk].value=null);if(action_args.length>=Number(name)){var value=action_args[Number(name)-1];that.blocks.blockList[blk].value=value}else that.errorMsg("Invalid argument",blk);return that.blocks.blockList[blk].value;case"sqrt":if(that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name)that.statusFields.push([blk,that.blocks.blockList[blk].name]);else{var cblk=that.blocks.blockList[blk].connections[1],a=that.parseArg(that,turtle,cblk,blk,receivedArg);a<0&&(that.errorMsg(NOSQRTERRORMSG,blk),that.stopTurtle=!0,a=-a),that.blocks.blockList[blk].value=that._doSqrt(a)}break;case"int":if(that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name)that.statusFields.push([blk,"int"]);else{var cblk=that.blocks.blockList[blk].connections[1],a=that.parseArg(that,turtle,cblk,blk,receivedArg);that.blocks.blockList[blk].value=Math.floor(a)}break;case"mod":if(that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name)that.statusFields.push([blk,"mod"]);else{var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=that._doMod(a,b)}break;case"not":var cblk=that.blocks.blockList[blk].connections[1],a=that.parseArg(that,turtle,cblk,blk,receivedArg);that.blocks.blockList[blk].value=!a;break;case"greater":var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=Number(a)>Number(b);break;case"equal":var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=a===b;break;case"less":var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg),result=Number(a)<Number(b);that.blocks.blockList[blk].value=result;break;case"random":var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=that._doRandom(a,b);break;case"oneOf":var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=that._doOneOf(a,b);break;case"plus":if(that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name)that.statusFields.push([blk,"plus"]);else{var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=that._doPlus(a,b)}break;case"multiply":if(that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name)that.statusFields.push([blk,"multiply"]);else{var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=that._doMultiply(a,b)}break;case"power":if(that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name)that.statusFields.push([blk,"power"]);else{var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=that._doPower(a,b)}break;case"divide":if(that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name)that.statusFields.push([blk,"divide"]);else{var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=that._doDivide(a,b)}break;case"minus":if(that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name)that.statusFields.push([blk,"minus"]);else{var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=that._doMinus(a,b)}break;case"neg":if(that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name)that.statusFields.push([blk,"neg"]);else{var cblk1=that.blocks.blockList[blk].connections[1],a=that.parseArg(that,turtle,cblk1,blk,receivedArg);that.blocks.blockList[blk].value=that._doMinus(0,a)}break;case"toascii":if(that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name)that.statusFields.push([blk,"toascii"]);else{var cblk1=that.blocks.blockList[blk].connections[1],a=that.parseArg(that,turtle,cblk1,blk,receivedArg);that.blocks.blockList[blk].value=String.fromCharCode(a)}break;case"myclick":console.log("[click"+that.turtles.turtleList[turtle].name+"]"),that.blocks.blockList[blk].value="click"+that.turtles.turtleList[turtle].name;break;case"heading":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"heading"]):that.blocks.blockList[blk].value=that.turtles.turtleList[turtle].orientation;break;case"x":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"x"]):that.blocks.blockList[blk].value=that.turtles.screenX2turtleX(that.turtles.turtleList[turtle].container.x);break;case"y":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"y"]):that.blocks.blockList[blk].value=that.turtles.screenY2turtleY(that.turtles.turtleList[turtle].container.y);break;case"xturtle":case"yturtle":for(var cblk=that.blocks.blockList[blk].connections[1],targetTurtle=that.parseArg(that,turtle,cblk,blk,receivedArg),i=0;i<that.turtles.turtleList.length;i++){var thisTurtle=that.turtles.turtleList[i];if(targetTurtle===thisTurtle.name){"yturtle"===that.blocks.blockList[blk].name?that.blocks.blockList[blk].value=that.turtles.screenY2turtleY(thisTurtle.container.y):that.blocks.blockList[blk].value=that.turtles.screenX2turtleX(thisTurtle.container.x);break}}i===that.turtles.turtleList.length&&(that.errorMsg("Could not find turtle "+targetTurtle,blk),that.blocks.blockList[blk].value=0);break;case"bpmfactor":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"bpm"]):that.bpm[turtle].length>0?that.blocks.blockList[blk].value=last(that.bpm[turtle]):that.blocks.blockList[blk].value=that._masterBPM;break;case"staccatofactor":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"staccato"]):that.staccato[turtle].length>0?that.blocks.blockList[blk].value=last(that.staccato[turtle]):that.blocks.blockList[blk].value=0;break;case"slurfactor":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"slur"]):that.staccato[turtle].length>0?that.blocks.blockList[blk].value=-last(that.staccato[turtle]):that.blocks.blockList[blk].value=0;break;case"key":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"key"]):that.blocks.blockList[blk].value=that.keySignature[turtle];break;case"consonantstepsizeup":if(null!==that.lastNotePlayed[turtle]){var len=that.lastNotePlayed[turtle][0].length;that.blocks.blockList[blk].value=getStepSizeUp(that.keySignature[turtle],that.lastNotePlayed[turtle][0].slice(0,len-1))}else that.blocks.blockList[blk].value=getStepSizeUp(that.keySignature[turtle],"A");break;case"consonantstepsizedown":if(null!==that.lastNotePlayed[turtle]){var len=that.lastNotePlayed[turtle][0].length;that.blocks.blockList[blk].value=getStepSizeDown(that.keySignature[turtle],that.lastNotePlayed[turtle][0].slice(0,len-1))}else that.blocks.blockList[blk].value=getStepSizeDown(that.keySignature[turtle],"A");break;case"transpositionfactor":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"transposition"]):that.blocks.blockList[blk].value=that.transposition[turtle];break;case"duplicatefactor":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"duplicate"]):that.blocks.blockList[blk].value=that.duplicateFactor[turtle];break;case"skipfactor":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"skip"]):that.blocks.blockList[blk].value=that.skipFactor[turtle];break;case"notevolumefactor":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"volume"]):that.blocks.blockList[blk].value=last(that.polyVolume[turtle]);break;case"elapsednotes":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"elapsednotes"]):that.blocks.blockList[blk].value=that.notesPlayed[turtle];break;case"beatfactor":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"beatfactor"]):that.blocks.blockList[blk].value=that.beatFactor[turtle];break;case"number2pitch":case"number2octave":var cblk=that.blocks.blockList[blk].connections[1],num=that.parseArg(that,turtle,cblk,blk,receivedArg);if(null!=num&&"number"==typeof num){var obj=numberToPitch(num+that.pitchNumberOffset);"number2pitch"===that.blocks.blockList[blk].name?that.blocks.blockList[blk].value=obj[0]:that.blocks.blockList[blk].value=obj[1]}else that.errorMsg("Invalid argument",blk),that.stopTurtle=!0;break;case"turtlepitch":for(var value=null,cblk=that.blocks.blockList[blk].connections[1],targetTurtle=that.parseArg(that,turtle,cblk,blk,receivedArg),i=0;i<that.turtles.turtleList.length;i++){var thisTurtle=that.turtles.turtleList[i];if(targetTurtle===thisTurtle.name){if(null!==that.lastNotePlayed[turtle])var len=that.lastNotePlayed[turtle][0].length,pitch=that.lastNotePlayed[turtle][0].slice(0,len-1),octave=parseInt(that.lastNotePlayed[turtle][0].slice(len-1)),obj=[pitch,octave];else if(that.notePitches[i].length>0)var obj=that.getNote(that.notePitches[i][0],that.noteOctaves[i][0],that.noteTranspositions[i][0],that.keySignature[i]);else{console.log("Could not find a note for turtle "+turtle);var obj=["C",0]}value=pitchToNumber(obj[0],obj[1],that.keySignature[turtle])-that.pitchNumberOffset,that.blocks.blockList[blk].value=value}}null==value&&(that.errorMsg("Could not find turtle "+targetTurtle,blk),that.blocks.blockList[blk].value=0);break;case"turtlenote":case"turtlenote2":for(var value=null,cblk=that.blocks.blockList[blk].connections[1],targetTurtle=that.parseArg(that,turtle,cblk,blk,receivedArg),i=0;i<that.turtles.turtleList.length;i++){var thisTurtle=that.turtles.turtleList[i];targetTurtle===thisTurtle.name&&(null!==that.lastNotePlayed[turtle]?value=that.lastNotePlayed[turtle][1]:that.notePitches[i].length>0?value=that.noteBeat[i]:(console.log("Could not find a note for turtle "+turtle),value=-1),"turtlenote"===that.blocks.blockList[blk].name?that.blocks.blockList[blk].value=value:that.blocks.blockList[blk].value=0!==value?1/value:0)}null==value&&(that.errorMsg("Could not find turtle "+targetTurtle,blk),that.blocks.blockList[blk].value=-1);break;case"currentnote":that.blocks.blockList[blk].value=that.currentNotes[turtle];break;case"currentoctave":that.blocks.blockList[blk].value=that.currentOctaves[turtle];break;case"color":case"hue":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"color"]):that.blocks.blockList[blk].value=that.turtles.turtleList[turtle].color;break;case"shade":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"shade"]):that.blocks.blockList[blk].value=that.turtles.turtleList[turtle].value;break;case"grey":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"grey"]):that.blocks.blockList[blk].value=that.turtles.turtleList[turtle].chroma;break;case"pensize":that.inStatusMatrix&&"print"===that.blocks.blockList[that.blocks.blockList[blk].connections[0]].name?that.statusFields.push([blk,"pensize"]):that.blocks.blockList[blk].value=that.turtles.turtleList[turtle].stroke;break;case"and":var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=a&&b;break;case"or":var cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],a=that.parseArg(that,turtle,cblk1,blk,receivedArg),b=that.parseArg(that,turtle,cblk2,blk,receivedArg);that.blocks.blockList[blk].value=a||b;break;case"time":var d=new Date;that.blocks.blockList[blk].value=(d.getTime()-that.time)/1e3;break;case"hspace":var cblk=that.blocks.blockList[blk].connections[1],v=that.parseArg(that,turtle,cblk,blk,receivedArg);that.blocks.blockList[blk].value=v;break;case"mousex":that.blocks.blockList[blk].value=that.getStageX();break;case"mousey":that.blocks.blockList[blk].value=that.getStageY();break;case"mousebutton":that.blocks.blockList[blk].value=that.getStageMouseDown();break;case"keyboard":that.lastKeyCode=that.getCurrentKeyCode(),that.blocks.blockList[blk].value=that.lastKeyCode,that.clearCurrentKeyCode();break;case"getred":case"getgreen":case"getblue":var colorString=that.turtles.turtleList[turtle].canvasColor;"#"===colorString[0]&&(colorString=hex2rgb(colorString.split("#")[1]));var obj=colorString.split("("),obj=obj[1].split(",");switch(that.blocks.blockList[blk].name){case"getred":that.blocks.blockList[blk].value=parseInt(Number(obj[0])/2.55);break;case"getgreen":that.blocks.blockList[blk].value=parseInt(Number(obj[1])/2.55);break;case"getblue":that.blocks.blockList[blk].value=parseInt(Number(obj[2])/2.55)}break;case"getcolorpixel":var wasVisible=that.turtles.turtleList[turtle].container.visible;that.turtles.turtleList[turtle].container.visible=!1;var x=that.turtles.turtleList[turtle].container.x,y=that.turtles.turtleList[turtle].container.y;that.refreshCanvas();var ctx=that.canvas.getContext("2d"),imgData=ctx.getImageData(x,y,1,1).data,color=searchColors(imgData[0],imgData[1],imgData[2]);0===imgData[3]&&(color=body.style.background.substring(body.style.background.indexOf("(")+1,body.style.background.lastIndexOf(")")).split(/,\s*/),color=searchColors(color[0],color[1],color[2])),that.blocks.blockList[blk].value=color,wasVisible&&(that.turtles.turtleList[turtle].container.visible=!0);break;case"loadFile":break;case"tofrequency":if(_THIS_IS_MUSIC_BLOCKS_){var block=that.blocks.blockList[blk],cblk1=that.blocks.blockList[blk].connections[1],cblk2=that.blocks.blockList[blk].connections[2],note=that.parseArg(that,turtle,cblk1,blk,receivedArg),octave=Math.floor(calcOctave(that.currentOctaves[turtle],that.parseArg(that,turtle,cblk2,blk,receivedArg)));block.value=Math.round(pitchToFrequency(note,octave,0,that.keySignature[turtle]))}else{const e=["A","Bâ™­","B","C","Dâ™­","D","Eâ™­","E","F","Gâ™­","G","Aâ™­"],r={"Aâ™¯":"Bâ™­","Câ™¯":"Dâ™­","Dâ™¯":"Eâ™­","Fâ™¯":"Gâ™­","Gâ™¯":"Aâ™­"};var block=that.blocks.blockList[blk],cblk=block.connections[1],noteName=that.parseArg(that,turtle,cblk,blk,receivedArg);if("string"==typeof noteName){noteName=noteName.replace("b","â™­"),noteName=noteName.replace("#","â™¯"),noteName in r&&(noteName=r[noteName]);var idx=e.indexOf(noteName);if(-1===idx)this.errorMsg(_("Note name must be one of A, Aâ™¯, Bâ™­, B, C, Câ™¯, Dâ™­, D, Dâ™¯, Eâ™­, E, F, Fâ™¯, Gâ™­, G, Gâ™¯ or Aâ™­.")),block.value=440;else{var cblk=block.connections[2],octave=Math.floor(that.parseArg(that,turtle,cblk,blk,receivedArg));octave<1&&(octave=1),idx>2&&(octave-=1);var i=12*octave+idx;block.value=27.5*Math.pow(1.05946309435929,i)}}else block.value=440*Math.pow(2,(noteName-69)/12)}break;case"pop":var block=that.blocks.blockList[blk];turtle in that.turtleHeaps&&that.turtleHeaps[turtle].length>0?block.value=that.turtleHeaps[turtle].pop():(that.errorMsg(_("empty heap")),block.value=null);break;case"indexHeap":var block=that.blocks.blockList[blk],cblk=that.blocks.blockList[blk].connections[1],a=that.parseArg(that,turtle,cblk,blk,receivedArg);turtle in that.turtleHeaps||(that.turtleHeaps[turtle]=[]);for(;that.turtleHeaps[turtle].length<a;)that.turtleHeaps[turtle].push(null);block.value=that.turtleHeaps[turtle][a-1];break;case"heapLength":var block=that.blocks.blockList[blk];turtle in that.turtleHeaps||(that.turtleHeaps[turtle]=[]),block.value=that.turtleHeaps[turtle].length;break;case"heapEmpty":var block=that.blocks.blockList[blk];turtle in that.turtleHeaps?block.value=0===that.turtleHeaps[turtle].length:block.value=!0;break;case"notecounter":var saveCountingStatus=that.justCounting[turtle],saveSuppressStatus=that.suppressOutput[turtle];that.suppressOutput[turtle]=!0,that.justCounting[turtle]=!0;var actionArgs=[],saveNoteCount=that.notesPlayed[turtle],cblk=that.blocks.blockList[blk].connections[1];null==cblk?that.blocks.blockList[blk].value=0:(that.turtles.turtleList[turtle].running=!0,that._runFromBlockNow(that,turtle,cblk,!0,actionArgs,that.turtles.turtleList[turtle].queue.length),that.blocks.blockList[blk].value=that.notesPlayed[turtle]-saveNoteCount,that.notesPlayed[turtle]=saveNoteCount),that.justCounting[turtle]=saveCountingStatus,that.suppressOutput[turtle]=saveSuppressStatus;break;case"calc":var actionArgs=[],cblk=that.blocks.blockList[blk].connections[1],name=that.parseArg(that,turtle,cblk,blk,receivedArg);actionArgs=receivedArg,name in that.actions?(that.turtles.turtleList[turtle].running=!0,that._runFromBlockNow(that,turtle,that.actions[name],!0,actionArgs,that.turtles.turtleList[turtle].queue.length),that.blocks.blockList[blk].value=that.returns.shift()):(that.errorMsg(NOACTIONERRORMSG,blk,name),that.stopTurtle=!0);break;case"namedcalc":var name=that.blocks.blockList[blk].privateData,actionArgs=[];actionArgs=receivedArg,name in that.actions?(that.turtles.turtleList[turtle].running=!0,that._runFromBlockNow(that,turtle,that.actions[name],!0,actionArgs,that.turtles.turtleList[turtle].queue.length),that.blocks.blockList[blk].value=that.returns.shift()):(that.errorMsg(NOACTIONERRORMSG,blk,name),that.stopTurtle=!0);break;case"calcArg":var actionArgs=[];if(that.blocks.blockList[blk].argClampSlots.length>0)for(var i=0;i<that.blocks.blockList[blk].argClampSlots.length;i++){var t=that.parseArg(that,turtle,that.blocks.blockList[blk].connections[i+2],blk,receivedArg);actionArgs.push(t)}var cblk=that.blocks.blockList[blk].connections[1],name=that.parseArg(that,turtle,cblk,blk,receivedArg);name in that.actions?(that.turtles.turtleList[turtle].running=!0,that._runFromBlockNow(that,turtle,that.actions[name],!0,actionArgs,that.turtles.turtleList[turtle].queue.length),that.blocks.blockList[blk].value=that.returns.pop()):(that.errorMsg(NOACTIONERRORMSG,blk,name),that.stopTurtle=!0);break;case"namedcalcArg":var name=that.blocks.blockList[blk].privateData,actionArgs=[];if(that.blocks.blockList[blk].argClampSlots.length>0)for(var i=0;i<that.blocks.blockList[blk].argClampSlots.length;i++){var t=that.parseArg(that,turtle,that.blocks.blockList[blk].connections[i+1],blk,receivedArg);actionArgs.push(t)}name in that.actions?(that.turtles.turtleList[turtle].running=!0,that._runFromBlockNow(that,turtle,that.actions[name],!0,actionArgs,that.turtles.turtleList[turtle].queue.length),that.blocks.blockList[blk].value=that.returns.pop()):(that.errorMsg(NOACTIONERRORMSG,blk,name),that.stopTurtle=!0);break;case"doArg":case"nameddoArg":return blk;case"returnValue":that.returns.length>0?that.blocks.blockList[blk].value=that.returns.pop():(console.log("WARNING: No return value."),that.blocks.blockList[blk].value=0);break;default:that.blocks.blockList[blk].name in that.evalArgDict?eval(that.evalArgDict[that.blocks.blockList[blk].name]):console.log("ERROR: I do not know how to "+that.blocks.blockList[blk].name)}return that.blocks.blockList[blk].value}return blk},this._doWait=function(e,r){this.waitTimes[e]=1e3*Number(r)},this._doRandom=function(e,r){return"string"==typeof e||"string"==typeof r?(this.errorMsg(NANERRORMSG),this.stopTurtle=!0,0):Math.floor(Math.random()*(Number(r)-Number(e)+1)+Number(e))},this._doOneOf=function(e,r){return Math.random()<.5?e:r},this._doMod=function(e,r){return"string"==typeof e||"string"==typeof r?(this.errorMsg(NANERRORMSG),this.stopTurtle=!0,0):Number(e)%Number(r)},this._doSqrt=function(e){return"string"==typeof e?(this.errorMsg(NANERRORMSG),this.stopTurtle=!0,0):Math.sqrt(Number(e))},this._doPlus=function(e,r){if("string"==typeof e||"string"==typeof r){if("string"==typeof e)var l=e;else l=e.toString();if("string"==typeof r)var s=r;else s=r.toString();return l+s}return Number(e)+Number(r)},this._doMinus=function(e,r){return"string"==typeof e||"string"==typeof r?(this.errorMsg(NANERRORMSG),this.stopTurtle=!0,0):Number(e)-Number(r)},this._doMultiply=function(e,r){return"string"==typeof e||"string"==typeof r?(this.errorMsg(NANERRORMSG),this.stopTurtle=!0,0):Number(e)*Number(r)},this._doPower=function(e,r){return"string"==typeof e||"string"==typeof r?(this.errorMsg(NANERRORMSG),this.stopTurtle=!0,0):Math.pow(e,r)},this._doDivide=function(e,r){return"string"==typeof e||"string"==typeof r?(this.errorMsg(NANERRORMSG),this.stopTurtle=!0,0):0===Number(r)?(this.errorMsg(ZERODIVIDEERRORMSG),this.stopTurtle=!0,0):Number(e)/Number(r)},this.setBackgroundColor=function(e){if(-1===e)var r=platformColor.background;else r=this.turtles.turtleList[e].canvasColor;docById("myCanvas").style.background=r,this.svgOutput=""},this.setCameraID=function(e){this.cameraID=e},this.hideBlocks=function(){this.blocks.hide(),this.refreshCanvas()},this.showBlocks=function(){this.blocks.show(),this.blocks.bringToTop(),this.refreshCanvas()},this.getNote=function(e,r,l,s){this.validNote=!0;var o=!1;r=Math.round(r),l=Math.round(l),"number"==typeof e&&(e=e.toString());var h=e.length;if(h>2){var u=e.slice(h-2);"bb"===u||"â™­â™­"===u?(e=e.slice(0,h-1),l-=1):"##"===u||"â™¯â™¯"===u?(e=e.slice(0,h-1),l+=1):"#b"!==u&&"â™¯â™­"!==u&&"b#"!==u&&"â™­â™¯"!==u||(e=e.slice(0,h-2))}if(e in BTOFLAT?e=BTOFLAT[e]:e in STOSHARP&&(e=STOSHARP[e]),e in EXTRATRANSPOSITIONS)r+=EXTRATRANSPOSITIONS[e][1],note=EXTRATRANSPOSITIONS[e][0];else if(-1!==NOTESSHARP.indexOf(e.toUpperCase()))note=e.toUpperCase();else if(-1!==NOTESFLAT.indexOf(e))note=e;else if(-1!==NOTESFLAT2.indexOf(e))note=NOTESFLAT[notesFlat2.indexOf(e)];else{">"===e.substr(-1)&&(r=parseInt(e.slice(e.indexOf(">")+1,e.indexOf("/")-1)),e=e.substr(0,e.indexOf("<"))),-1!==["#","â™¯","â™­","b"].indexOf(e.substr(-1))&&(o=!0),s||(s="C");var g=getScaleAndHalfSteps(s),p=g[0],m=g[1],f=g[2];g[3];if(-1===(L=p.indexOf(f))){console.log("WARNING: Key "+f+" not found in "+p+". Using default of C");var L=0;p=NOTESSHARP}o&&("#"===e.substr(-1)||"â™¯"===e.substr(-1)?L+=1:("â™­"===e.substr(-1)||"b"===e.substr(-1))&&(L-=1));var N=_("ti la sol fa mi re do").split(" ");if(-1!==N.indexOf(e.substr(0,2).toLowerCase()))var S=SOLFNOTES[N.indexOf(e.substr(0,2).toLowerCase())];else if(-1!==N.indexOf(e.substr(0,3).toLowerCase()))S=SOLFNOTES[N.indexOf(e.substr(0,3).toLowerCase())];else S=e.substr(0,2).toLowerCase();if("rest"===e.toLowerCase().substr(0,4))return["R",""];if(-1===m.indexOf(S))return console.log("WARNING: Note "+e+" not found in "+m+". Returning REST"),this.errorMsg(INVALIDPITCH,null),["R",""];var M=m.indexOf(S)+L;M>11&&(M-=12,r+=1),note=p[M],note in EXTRATRANSPOSITIONS&&(r+=EXTRATRANSPOSITIONS[note][1],note=EXTRATRANSPOSITIONS[note][0])}return l&&0!==l&&(l<0?(deltaOctave=-Math.floor(-l/12),deltaNote=- -l%12):(deltaOctave=Math.floor(l/12),deltaNote=l%12),r+=deltaOctave,-1!==NOTESSHARP.indexOf(note)?(i=NOTESSHARP.indexOf(note),i+=deltaNote,i<0?(i+=12,r-=1):i>11&&(i-=12,r+=1),note=NOTESSHARP[i]):-1!==NOTESFLAT.indexOf(note)?(i=NOTESFLAT.indexOf(note),i+=deltaNote,i<0?(i+=12,r-=1):i>11&&(i-=12,r+=1),note=NOTESFLAT[i]):console.log("note not found? "+note)),r<0?[note,0]:r>10?[note,10]:[note,r]}}