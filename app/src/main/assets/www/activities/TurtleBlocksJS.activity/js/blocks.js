const MINIMUMDOCKDISTANCE=400,CAMERAVALUE="##__CAMERA__##",VIDEOVALUE="##__VIDEO__##";function Blocks(){return sugarizerCompatibility.isInsideSugarizer()?storage=sugarizerCompatibility.data:storage=localStorage,this.canvas=null,this.stage=null,this.refreshCanvas=null,this.trashcan=null,this.updateStage=null,this.getStageScale=null,this.trashStacks=[],this.protoBlockDict={},this.blockList=[],this.mouseDownTime=0,this.longPressTimeout=null,this.selectingStack=!1,this.selectedStack=null,this.selectedBlocksObj=null,this._loopCounter=0,this._sizeCounter=0,this._searchCounter=0,this.palettes=null,this.highlightedBlock=null,this.activeBlock=null,this.visible=!0,this.dragGroup=[],this.stackList=[],this._expandablesList=[],this._loadCounter=0,this._adjustTheseDocks=[],this.blocksToCollapse=[],this._checkTwoArgBlocks=[],this._checkArgClampBlocks=[],this._clampBlocksToCheck=[],this._expandableBlocks=[],this.clampBlocks=[],this.doubleExpandable=[],this.argClampBlocks=[],this.argBlocks=[],this.valueBlocks=[],this.twoArgBlocks=[],this.noRunBlocks=[],this._homeButtonContainers=[],this.blockScale=DEFAULTBLOCKSCALE,this.inLongPress=!1,this.deleteActionTimeout=0,this.setCanvas=function(t){return this.canvas=t,this},this.setStage=function(t){return this.stage=t,this},this.setRefreshCanvas=function(t){return this.refreshCanvas=t,this},this.setTrashcan=function(t){return this.trashcan=t,this},this.setUpdateStage=function(t){return this.updateStage=t,this},this.setGetStageScale=function(t){return this.getStageScale=t,this},this.setBlockScale=function(t){console.log("New block scale is "+t),this.blockScale=t;for(var o=0;o<this.blockList.length;o++)this.blockList[o].resize(t);this.findStacks();for(var s=0;s<this.stackList.length;s++)this.adjustDocks(this.stackList[s],!0);for(var e in this.palettes.dict)for(o=0;o<this.palettes.dict[e].protoList.length;o++)this.palettes.dict[e].protoList[o].scale=t},this.setMsgText=function(t){this.msgText=t},this.setErrorMsg=function(t){return this.errorMsg=t,this},this.setMacroDictionary=function(t){return this.macroDict=t,this},this.setTurtles=function(t){return this.turtles=t,this},this.setLogo=function(t){return this.logo=t,this},this.setScale=function(t){return this.blockScale=t,this},this.toggleCollapsibles=function(){for(var t in this.blockList){var o=this.blockList[t];-1===COLLAPSABLES.indexOf(o.name)||o.trash||o.collapseToggle()}},this.setHomeContainers=function(t,o){return this._homeButtonContainers=t,this.boundary=o,this},this.makeCopyPasteButtons=function(t,o){var s=this;this.updatePasteButton=o,this.dismissButton=t("cancel-button","",0,0,55,0,this.stage),this.dismissButton.visible=!1,this.saveStackButton=t("save-blocks-button",_("Save stack"),0,0,55,0,this.stage),this.saveStackButton.visible=!1,this.dismissButton.on("click",(function(t){s.saveStackButton.visible=!1,s.dismissButton.visible=!1,s.inLongPress=!1,s.refreshCanvas()})),this.saveStackButton.on("click",(function(t){var o=s.findTopBlock(s.activeBlock);s.inLongPress=!1,s.selectedStack=o,s.saveStackButton.visible=!1,s.dismissButton.visible=!1,s.saveStack(),s.refreshCanvas()}))},this.findBlockTypes=function(){for(var t in this.protoBlockDict)this.protoBlockDict[t].expandable&&this._expandableBlocks.push(this.protoBlockDict[t].name),"clamp"===this.protoBlockDict[t].style&&this.clampBlocks.push(this.protoBlockDict[t].name),"argclamp"===this.protoBlockDict[t].style&&this.argClampBlocks.push(this.protoBlockDict[t].name),"argflowclamp"===this.protoBlockDict[t].style&&this.clampBlocks.push(this.protoBlockDict[t].name),"argclamparg"===this.protoBlockDict[t].style&&(this.argClampBlocks.push(this.protoBlockDict[t].name),this.argBlocks.push(this.protoBlockDict[t].name)),"twoarg"===this.protoBlockDict[t].style&&this.twoArgBlocks.push(this.protoBlockDict[t].name),"arg"===this.protoBlockDict[t].style&&this.argBlocks.push(this.protoBlockDict[t].name),"value"===this.protoBlockDict[t].style&&(this.argBlocks.push(this.protoBlockDict[t].name),this.valueBlocks.push(this.protoBlockDict[t].name)),"doubleclamp"===this.protoBlockDict[t].style&&this.doubleExpandable.push(this.protoBlockDict[t].name)},this._actionBlock=function(t){return-1!==["do","doArg","calc","calcArg"].indexOf(t)},this._namedActionBlock=function(t){return-1!==["nameddo","nameddoArg","namedcalc","namedcalcArg"].indexOf(t)},this._adjustBlockPositions=function(){this.dragGroup.length<2||this.adjustDocks(this.dragGroup[0],!0)},this._adjustExpandableClampBlock=function(){if(0!==this._clampBlocksToCheck.length){var t=this._clampBlocksToCheck.pop(),o=t[0],s=t[1],e=this.blockList[o];if(e.isArgFlowClampBlock());else{if(e.isArgBlock()||e.isTwoArgBlock())return;if(e.isArgClamp())return void this._adjustArgClampBlock([o])}!function clampAdjuster(t,o,s,e){if(s.isArgFlowClampBlock())var i=1;else if(0===e)i=s.connections.length-2;else i=s.connections.length-3;t._sizeCounter=0;var n=1;i>0&&null!=s.connections[i]&&(n=Math.max(t._getStackSize(s.connections[i]),1));var l=n-s.clampCount[e];0!==l&&(0===n&&1===s.clampCount[e]||s.updateSlots(e,l)),setTimeout((function(){t._clampBlocksToCheck.length>0&&t._adjustExpandableClampBlock()}),250)}(this,0,e,s)}},this._getBlockSize=function(t){return this.blockList[t].size},this._adjustArgClampBlock=function(t){if(0!==t.length){var o=t.pop(),s=this.blockList[o];if(-1!==["doArg","calcArg"].indexOf(s.name))var e=2;else e=1;for(var i=s.argClampSlots,n=!1,l=0;l<i.length;l++){var c=s.connections[e+l],a=1;null!=c&&(a=Math.max(this._getBlockSize(c),1)),i[l]!==a&&(i[l]=a,n=!0)}n&&s.updateArgSlots(i)}},this._adjustExpandableTwoArgBlock=function(t){if(0!==t.length){var o=t.pop(),s=this.blockList[o],e=s.connections[1],i=1;null!=e&&(i=Math.max(this._getBlockSize(e),1));var n=i-s.clampCount[0];0!==n&&0!==i&&s.updateSlots(0,n)}},this._addRemoveVspaceBlock=function(t){var o=this.blockList[t],s=o.connections[o.connections.length-2],e=1;if(null!=s)e=Math.max(this._getBlockSize(s),1);var i=this,n=function howManyVSpaceBlocksBelow(t){var o=last(i.blockList[t].connections);if(o&&"vspace"===i.blockList[o].name)return 1+howManyVSpaceBlocksBelow(o);return 0}(t);if(e<n+1)for(var l=Math.abs(e-n-1),c=0;c<l;c++){var a=o.connections.length-1,h=this.blockList[o.connections[a]],r=h.connections[1];o.connections[a]=r,null!=r&&(this.blockList[r].connections[0]=t),h.connections=[null,null],h.trash=!0,h.hide()}else if(e>n+1){l=e-n-1;var k=last(o.connections),u=o,b=this.blockList.length;i=this;this._makeNewBlockWithConnections("vspace",b,[null,null],(function vspaceAdjuster(t){var o=t[0],s=t[1],e=t[2],n=t[3],l=t[4],c=i.blockList[e],a=last(o.docks),h=a[0]-c.docks[0][0],r=a[1]-c.docks[0][1];if(c.container.x=o.container.x+h,c.container.y=o.container.y+r,c.connections[0]=i.blockList.indexOf(o),c.connections[1]=s,o.connections[o.connections.length-1]=e,s&&(i.blockList[s].connections[0]=e),n+1<l){var k=i.blockList.length;o=last(i.blockList),s=last(o.connections),i._makeNewBlockWithConnections("vspace",k,[null,null],vspaceAdjuster,[o,s,k,n+1,l])}}),[u,k,b,0,l])}},this._getStackSize=function(t){var o=0;if(this._sizeCounter+=1,this._sizeCounter>2*this.blockList.length)return console.log("Infinite loop encountered detecting size of expandable block? "+t),o;if(null==t)return o;var s=this.blockList[t];if(null==s&&console.log("Something very broken in _getStackSize."),s.isClampBlock()){var e=0;if((i=s.connections.length-2)>0)null!=(n=s.connections[i])&&(e=this._getStackSize(n)),o=0===e?1:e;if(s.isDoubleClampBlock()){var i,n;e=0;if((i=s.connections.length-3)>0)null!=(n=s.connections[i])&&(e=this._getStackSize(n)),o+=0===e?1:e}o+=s.size}else o=s.size;s.isValueBlock()||null!=(n=last(s.connections))&&(o+=this._getStackSize(n));return o},this.adjustDocks=function(t,o){var s=this.blockList[t];if(null!=o&&(this._loopCounter=0),null!=s)if(null!=s.connections)if(0!==s.connections.length){if(1!==s.docks.length)if(this._loopCounter+=1,this._loopCounter>2*this.blockList.length)console.log("Infinite loop encountered while adjusting docks: "+t+" "+this.blockList);else{if(s.isTwoArgBooleanBlock())var e=0;else e=1;for(var i=e;i<s.connections.length;i++){var n=s.docks[i],l=s.connections[i];if(null!=l)if(null!=this.blockList[l]){for(var c=!1,a=0;a<this.blockList[l].connections.length;a++)if(this.blockList[l].connections[a]===t){c=!0;break}if(!c){console.log("Did not find match for "+s.name+" ("+t+") and "+this.blockList[l].name+" ("+l+")"),console.log(s.connections),console.log(this.blockList[l].connections);break}var h=this.blockList[l].docks[a];if(i>0){var r=n[0]-h[0],k=n[1]-h[1];if(null==s.container)console.log("Does this ever happen any more?");else var u=s.container.x+r,b=s.container.y+k;this._moveBlock(l,u,b)}else{r=h[0]-n[0],k=h[1]-n[1],u=this.blockList[l].container.x+r,b=this.blockList[l].container.y+k;this._moveBlock(t,u,b)}i>0&&this.adjustDocks(l,!0)}else console.log("This is not good: we encountered a null block: "+l)}}}else console.log("Saw a block with [] connections: "+t);else console.log("Saw a block with null connections: "+t);else console.log("Saw a null block: "+t)},this.addDefaultBlock=function(t,o,s){if(null!=t)if("action"===this.blockList[t].name){if(null==(i=this.blockList[t].connections[1])){var e=this;postProcess=function(t){var o=t[0],i=t[1],n=e.blockList.length-1;e.blockList[o].connections[1]=n,e.blockList[n].value=e.findUniqueActionName(_("action"));var l=e.blockList[n].value;if(l.length>8&&(l=l.substr(0,7)+"..."),e.blockList[n].text.text=l,e.blockList[n].container.updateCache(),e.blockList[n].value!==e.blockList[i].value){e.newNameddoBlock(e.blockList[n].value,e.actionHasReturn(o),e.actionHasArgs(o));for(var c=e.palettes.dict.action,a=0;a<c.protoList.length;a++){var h=c.protoList[a];if("nameddo"===h.name&&h.defaults[0]===e.blockList[i].value){setTimeout((function(){c.remove(h,e.blockList[i].value),delete e.protoBlockDict["myDo_"+e.blockList[i].value],e.palettes.hide(),e.palettes.updatePalettes("action"),e.palettes.show()}),500);break}}e.renameNameddos(e.blockList[i].value,e.blockList[n].value),s?e.renameDos(e.blockList[i].value,e.blockList[n].value,i):e.renameDos(e.blockList[i].value,e.blockList[n].value)}e.adjustDocks(o,!0)},this._makeNewBlockWithConnections("text",0,[t],postProcess,[t,o],!1)}}else if("storein"===this.blockList[t].name){if(null==(i=this.blockList[t].connections[1])){e=this;postProcess=function(t){var o=t[0],s=(t[1],e.blockList.length-1);e.blockList[o].connections[1]=s,e.blockList[s].value=_("box");var i=e.blockList[s].value;i.length>8&&(i=i.substr(0,7)+"..."),e.blockList[s].text.text=i,e.blockList[s].container.updateCache(),e.adjustDocks(o,!0)},this._makeNewBlockWithConnections("text",0,[t],postProcess,[t,o],!1)}}else if(-1!==["newnote","osctime"].indexOf(this.blockList[t].name)){var i;if(null==(i=this.blockList[t].connections[2])){var n="vspace",l=this.makeBlock(n,"__NOARG__");this.blockList[t].connections[2]=l,this.blockList[l].connections[0]=t;n="rest2";var c=this.makeBlock(n,"__NOARG__");this.blockList[c].connections[0]=l,this.blockList[c].connections[1]=null,this.blockList[l].connections[1]=c}else if("vspace"===this.blockList[i].name&&null==this.blockList[i].connections[1]){n="rest2",c=this.makeBlock(n,"__NOARG__");this.blockList[c].connections[0]=i,this.blockList[c].connections[1]=null,this.blockList[i].connections[1]=c}}},this.deleteNextDefault=function(t){for(var o=this.blockList[t],s=1;s<o.connections.length;s++)if(o.connections[s]&&"rest2"===this.blockList[o.connections[s]].name){var e=o.connections[s],i=this.blockList[e];i.hide(),i.trash=!0,this.blockList[t].connections[s]=i.connections[1];break}},this.deletePreviousDefault=function(t){var o=this.blockList[t];if(o&&this.blockList[o.connections[0]]&&"rest2"===this.blockList[o.connections[0]].name){var s=o.connections[0],e=this.blockList[s];e.hide(),e.trash=!0;for(var i=0;i<this.blockList[e.connections[0]].connections.length;i++)if(this.blockList[e.connections[0]].connections[i]===s){this.blockList[e.connections[0]].connections[i]=t;break}o.connections[0]=e.connections[0]}return o.connections[0]},this.blockMoved=function(t){if(this._clampBlocksToCheck=[],null!=t){var o=this._insideExpandableBlock(t),s=0,e=null;null!=o&&(e=o);for(var i=!1;null!=o;){if((s+=1)>2*this.blockList.length){console.log("Infinite loop encountered checking for expandables?");break}this._clampBlocksToCheck.push([o,0]),o=this._insideExpandableBlock(o)}this._checkTwoArgBlocks=[];var n=[],l=this.blockList[t];if(null!=l){if(null!=(y=l.connections[0]))var c=this.blockList[y];if(l.isArgBlock()&&null!=y&&(this.blockList[y].isTwoArgBlock()||this.blockList[y].isArgClamp()?c.connections[1]===t&&this._checkTwoArgBlocks.push(y):(this.blockList[y].isArgBlock()&&this.blockList[y].isExpandableBlock()||this.blockList[y].isArgClamp())&&c.connections[1]===t&&this._checkTwoArgBlocks.push(y)),null!=y){for(var a=1;a<c.connections.length;a++)if(c.connections[a]===t){c.connections[a]=null;break}l.connections[0]=null,this.raiseStackToTop(t)}for(var h=l.container.x+l.docks[0][0],r=l.container.y+l.docks[0][1],k=null,u=null,b=400/DEFAULTBLOCKSCALE*this.blockScale,d=l.docks[0][2],p=!0,g=0;g<this.blockList.length;g++)if(g!==t&&!this.blockList[g].collapsed&&!this.blockList[g].trash)for(a=1;a<this.blockList[g].connections.length&&a!==this.blockList[g].docks.length;a++)if((a!==this.blockList[g].connections.length-1||null==this.blockList[g].connections[a]||!this.blockList[this.blockList[g].connections[a]].isNoHitBlock())&&(-1===["backward","status"].indexOf(this.blockList[g].name)||1!==a||null==this.blockList[g].connections[1]||!this.blockList[this.blockList[g].connections[1]].isNoHitBlock())&&("action"!==this.blockList[g].name||2!==a||null==this.blockList[g].connections[2]||!this.blockList[this.blockList[g].connections[2]].isNoHitBlock())&&this._testConnectionType(d,this.blockList[g].docks[a][2])){var f=this.blockList[g].container.x+this.blockList[g].docks[a][0],L=this.blockList[g].container.y+this.blockList[g].docks[a][1],m=(f-h)*(f-h)+(L-r)*(L-r);m<b&&(k=g,u=a,b=m)}if(null!=k){l.connections[0]=k;var v=this.blockList[k].connections[u];if(null==v){if(this.blockList[k].isArgClamp())if("doArg"!==this.blockList[k].name&&"calcArg"!==this.blockList[k].name||1!==u)if(-1!==["doArg","nameddoArg"].indexOf(this.blockList[k].name)&&u===this.blockList[k].connections.length-1);else{var B=this._getBlockSize(t),_=this.blockList[k].argClampSlots;if(-1!==["doArg","calcArg"].indexOf(this.blockList[k].name))var x=u-2;else x=u-1;_[x]!==B&&(_[x]=B,this.blockList[k].updateArgSlots(_))}else;}else if(p=!1,this.blockList[k].isArgClamp())if("doArg"!==this.blockList[k].name&&"calcArg"!==this.blockList[k].name||1!==u)if(-1!==["doArg","nameddoArg"].indexOf(this.blockList[k].name)&&u===this.blockList[k].connections.length-1){var C=this.findBottomBlock(t);this.blockList[v].connections[0]=C,this.blockList[C].connections[this.blockList[C].connections.length-1]=v}else{B=this._getBlockSize(t),_=this.blockList[k].argClampSlots;var A=this.blockList[k].connections.indexOf(v);if(-1!==["doArg","calcArg"].indexOf(this.blockList[k].name))x=A-2;else x=A-1;var w=null,S=null;for(w=x;w<_.length;w++)if(null==this.blockList[k].connections[A+w-x]){S=A+w-x;break}if(null==S){_.push(1),this._newLocalArgBlock(_.length),S=A+w-x,this.blockList[k].connections.push(null);for(a=_.length-1;a>x+1;a--)_[a]=_[a-1];for(a=this.blockList[k].connections.length-1;a>A+1;a--)this.blockList[k].connections[a]=this.blockList[k].connections[a-1]}u+=1,_[x+1]=B,this.blockList[k].updateArgSlots(_)}else{this.blockList[v].connections[0]=null,this.findDragGroup(v);for(var y=0;y<this.dragGroup.length;y++)this.moveBlockRelative(this.dragGroup[y],40,40)}else if(l.isArgBlock()){this.blockList[v].connections[0]=null,this.findDragGroup(v);for(y=0;y<this.dragGroup.length;y++)this.moveBlockRelative(this.dragGroup[y],40,40);if("action"===this.blockList[k].name){if(i=!0,l.value!==this.blockList[v].value){y=l.connections[0];l.connections[0]=null;var T=this.findUniqueActionName(l.value);if(l.connections[0]=y,T!==l.value)l.value=T,(N=T).length>8&&(N=N.substr(0,7)+"..."),l.text.text=N,l.container.updateCache();var D=this;setTimeout((function(){var t=D.blockList[v].value;null!=D.protoBlockDict["myDo_"+t]&&(delete D.protoBlockDict["myDo_"+t],D.palettes.dict.action.hideMenu(!0)),D.newNameddoBlock(l.value,D.actionHasReturn(k),D.actionHasArgs(k));for(var o=D.palettes.dict.action,s=0;s<o.protoList.length;s++){var e=o.protoList[s];if("nameddo"===e.name&&e.staticLabels[0]===D.blockList[v].value){setTimeout((function(){o.remove(e,D.blockList[v].value),delete D.protoBlockDict["myDo_"+D.blockList[v].value],D.palettes.hide(),D.palettes.updatePalettes("action"),D.palettes.show()}),500);break}}D.renameNameddos(D.blockList[v].value,l.value),D.renameDos(D.blockList[v].value,l.value)}),750)}}else if("storein"===this.blockList[k].name&&"box"!==l.value){this.newStoreinBlock(l.value),this.newNamedboxBlock(l.value);D=this;setTimeout((function(){D.palettes.hide(),D.palettes.updatePalettes("boxes"),D.palettes.show()}),500)}}else if(!this.blockList[t].isArgFlowClampBlock()){C=this.findBottomBlock(t);this.blockList[v].connections[0]=C,this.blockList[C].connections[this.blockList[C].connections.length-1]=v}if(this.blockList[k].connections[u]=t,null!=this._insideNoteBlock(t)&&(p?k=this.deletePreviousDefault(t):this.deleteNextDefault(C)),"action"===this.blockList[k].name&&!i)for(g=0;g<this.blockList.length;g++){var N;if(g!==k)if("action"===this.blockList[g].name)if(null!=this.blockList[g].connections[1])if(this.blockList[this.blockList[g].connections[1]].value===this.blockList[t].value)this.blockList[t].value=this.findUniqueActionName(this.blockList[t].value),(N=this.blockList[t].value).length>8&&(N=N.substr(0,7)+"..."),this.blockList[t].text.text=N,this.blockList[t].container.updateCache(),this.newNameddoBlock(this.blockList[t].value,this.actionHasReturn(g),this.actionHasArgs(g)),this.setActionProtoVisiblity(!1)}this.adjustDocks(k,!0)}if((l.isArgBlock()||"calcArg"===l.name||"namedcalcArg"===l.name)&&null!=k){this.blockList[k].isTwoArgBlock()?this.blockList[k].connections[1]===t&&-1===this._checkTwoArgBlocks.indexOf(k)&&this._checkTwoArgBlocks.push(k):this.blockList[k].isArgBlock()&&this.blockList[k].isExpandableBlock()&&this.blockList[k].connections[1]===t&&-1===this._checkTwoArgBlocks.indexOf(k)&&this._checkTwoArgBlocks.push(k);var P=this.blockList[k].connections.length;this.blockList[k].connections[P-2]===t&&(this.blockList[k].isArgClamp()||"in"!==this.blockList[k].docks[P-1][2]||n.push(k))}this.addDefaultBlock(e,t,i);D=this;setTimeout((function(){if(n.length>0)for(var o=0;o<n.length;o++)D._addRemoveVspaceBlock(n[o]);D._checkTwoArgBlocks.length>0&&D._adjustExpandableTwoArgBlock(D._checkTwoArgBlocks);for(o=0;o<n.length;o++)D.adjustDocks(n[o],!0);for(var s=D._insideExpandableBlock(t),e=0;null!=s;){if((e+=1)>2*D.blockList.length){console.log("Infinite loop checking for expandables?"),console.log(D.blockList);break}"ifthenelse"===D.blockList[s].name?(D._clampBlocksToCheck.push([s,0]),D._clampBlocksToCheck.push([s,1])):D._clampBlocksToCheck.push([s,0]),s=D._insideExpandableBlock(s)}D._adjustExpandableClampBlock(),D.refreshCanvas()}),250)}else console.log("null block found in blockMoved method: "+t)}else console.log("blockMoved called with null block.")},this._testConnectionType=function(t,o){return"in"===t&&"out"===o||("out"===t&&"in"===o||("numberin"===t&&-1!==["numberout","anyout"].indexOf(o)||(-1!==["numberout","anyout"].indexOf(t)&&"numberin"===o||("textin"===t&&-1!==["textout","anyout"].indexOf(o)||(-1!==["textout","anyout"].indexOf(t)&&"textin"===o||("booleanout"===t&&"booleanin"===o||("booleanin"===t&&"booleanout"===o||("mediain"===t&&"mediaout"===o||("mediaout"===t&&"mediain"===o||("mediain"===t&&"textout"===o||("mediain"===o&&"textout"===t||("filein"===t&&"fileout"===o||("fileout"===t&&"filein"===o||("solfegein"===t&&-1!==["anyout","solfegeout","textout","noteout","numberout"].indexOf(o)||("solfegein"===o&&-1!==["anyout","solfegeout","textout","noteout","numberout"].indexOf(t)||("notein"===t&&-1!==["solfegeout","textout","noteout"].indexOf(o)||("notein"===o&&-1!==["solfegeout","textout","noteout"].indexOf(t)||("anyin"===t&&-1!==["textout","mediaout","numberout","anyout","fileout","solfegeout","noteout"].indexOf(o)||"anyin"===o&&-1!==["textout","mediaout","numberout","anyout","fileout","solfegeout","noteout"].indexOf(t)))))))))))))))))))},this.updateBlockPositions=function(){for(var t=0;t<this.blockList.length;t++)this._moveBlock(t,this.blockList[t].container.x,this.blockList[t].container.y)},this.bringToTop=function(){for(var t in this._adjustTheseStacks=[],this.blockList){null==this.blockList[t].connections[0]&&this._adjustTheseStacks.push(t)}for(t=0;t<this._adjustTheseStacks.length;t++)this.raiseStackToTop(this._adjustTheseStacks[t]);this.refreshCanvas()},this.checkBounds=function(){for(var t=!0,o=0;o<this.blockList.length;o++)if(null==this.blockList[o].connections[0]&&this.blockList[o].offScreen(this.boundary)){this._homeButtonContainers[0].visible=!0,this._homeButtonContainers[1].visible=!1,this.boundary.show(),t=!1;break}t&&(this._homeButtonContainers[0].visible=!1,this._homeButtonContainers[1].visible=!0,this.boundary.hide())},this._moveBlock=function(t,o,s){var e=this.blockList[t];null!=e.container?(e.container.x=o,e.container.y=s,null!=e.collapseContainer&&(e.collapseContainer.x=o+COLLAPSEBUTTONXOFF*(this.blockList[t].protoblock.scale/2),e.collapseContainer.y=s+COLLAPSEBUTTONYOFF*(this.blockList[t].protoblock.scale/2)),this.checkBounds()):console.log("No container yet for block "+e.name)},this.moveBlockRelative=function(t,o,s){this.inLongPress&&(this.saveStackButton.visible=!1,this.dismissButton.visible=!1,this.inLongPress=!1);var e=this.blockList[t];null!=e.container?(e.container.x+=o,e.container.y+=s,null!=e.collapseContainer&&(e.collapseContainer.x+=o,e.collapseContainer.y+=s),this.checkBounds()):console.log("No container yet for block "+e.name)},this.moveStackRelative=function(t,o,s){if(this.findDragGroup(t),this.dragGroup.length>0)for(var e=0;e<this.dragGroup.length;e++)this.moveBlockRelative(this.dragGroup[e],o,s)},this.updateBlockText=function(t){var o=this.blockList[t],s=8;if(null!=o.text){if("loadFile"===o.name){try{var e=o.value[0].toString()}catch(t){e=_("open file")}s=10}else if("solfege"===o.name){var i=splitSolfege(o.value);e=i18nSolfege(i[0]);"♮"!==(n=i[1])&&(e+=n)}else if("eastindiansolfege"===o.name){var n;i=splitSolfege(o.value),e=WESTERN2EISOLFEGENAMES[i[0]];"♮"!==(n=i[1])&&(e+=n)}else e=o.value.toString();e.length>s&&(e=e.substr(0,s-1)+"..."),o.text.text=e;var l=o.container.getNumChildren()-1;o.container.setChildIndex(o.text,l),o.loadComplete?o.container.updateCache():console.log("Load not yet complete for ("+t+") "+o.name)}},this.findTopBlock=function(t){if(null==t)return null;var o=this.blockList[t];if(null==o.connections)return t;if(0===o.connections.length)return t;if(o.connections.length>1&&null!=o.connections[0]&&o.connections[0]===last(o.connections))return console.log("WARNING: CORRUPTED BLOCK DATA. Block "+o.name+" ("+t+") is connected to the same block "+this.blockList[o.connections[0]].name+" ("+o.connections[0]+") twice."),t;for(var s=0;null!=o.connections[0];){if((s+=1)>2*this.blockList.length){console.log("infinite loop finding topBlock?"),console.log(this.blockList.indexOf(o)+" "+o.name);break}t=o.connections[0],o=this.blockList[t]}return t},this.sameGeneration=function(t,o){if(null==t||null==o)return!1;if(t===o)return!0;var s=this.blockList[t];if(null==s.connections)return!1;if(0===s.connections.length)return!1;for(var e=0;null!=last(s.connections);){if((e+=1)>2*this.blockList.length){console.log("infinite loop finding bottomBlock?");break}if(blk=last(s.connections),s=this.blockList[blk],blk===o)return!0}return!1},this.findBottomBlock=function(t){if(null==t)return null;var o=this.blockList[t];if(null==o.connections)return t;if(0===o.connections.length)return t;for(var s=0;null!=last(o.connections);){if((s+=1)>2*this.blockList.length){console.log("infinite loop finding bottomBlock?");break}t=last(o.connections),o=this.blockList[t]}return t},this.findStacks=function(){this.stackList=[];for(var t=0;t<this.blockList.length;t++)null==this.blockList[t].connections[0]&&this.stackList.push(t)},this._findClamps=function(){this._expandablesList=[],this.findStacks();for(var t=0;t<this.stackList.length;t++)this._searchCounter=0,this._searchForExpandables(this.stackList[t]);this._searchForArgFlow()},this._findTwoArgs=function(){this._expandablesList=[];for(var t=0;t<this.blockList.length;t++)(this.blockList[t].isArgBlock()&&this.blockList[t].isExpandableBlock()||this.blockList[t].isTwoArgBlock())&&this._expandablesList.push(t)},this._searchForArgFlow=function(){for(var t=0;t<this.blockList.length;t++)this.blockList[t].isArgFlowClampBlock()&&this._expandablesList.push(t)},this._searchForExpandables=function(t){for(;null!=t&&null!=this.blockList[t]&&!this.blockList[t].isValueBlock();){if(this._searchCounter+=1,this._searchCounter>2*this.blockList.length){console.log("infinite loop searching for Expandables? "+this._searchCounter),console.log(t+" "+this.blockList[t].name);break}if(this.blockList[t].isClampBlock()){this._expandablesList.push(t);var o=this.blockList[t].connections.length-2;if(this._searchForExpandables(this.blockList[t].connections[o]),"ifthenelse"===this.blockList[t].name){o=2;this._searchForExpandables(this.blockList[t].connections[o])}}else this.blockList[t].isArgClamp()&&this._expandablesList.push(t);t=this.blockList[t].connections.length>1?last(this.blockList[t].connections):null}},this._expandTwoArgs=function(){this._findTwoArgs(),this._adjustExpandableTwoArgBlock(this._expandablesList),this.refreshCanvas()},this._expandClamps=function(){this._findClamps(),this._clampBlocksToCheck=[];for(var t=0;t<this._expandablesList.length;t++)"ifthenelse"===this.blockList[this._expandablesList[t]].name?(this._clampBlocksToCheck.push([this._expandablesList[t],0]),this._clampBlocksToCheck.push([this._expandablesList[t],1])):this._clampBlocksToCheck.push([this._expandablesList[t],0]);this._adjustExpandableClampBlock(),this.refreshCanvas()},this.changeDisabledStatus=function(t,o){for(var s in this.blockList){var e=this.blockList[s];e.name===t&&(e.protoblock.disabled=o,e.regenerateArtwork(!1))}},this.unhighlightAll=function(){for(var t in this.blockList)this.unhighlight(t)},this.unhighlight=function(t){if(this.visible){if(null!=t)var o=t;else o=this.highlightedBlock;null!=o&&this.blockList[o].unhighlight(),(this.highlightedBlock=o)&&(this.highlightedBlock=null)}},this.highlight=function(t,o){this.visible&&null!=t&&(o&&this.unhighlight(null),this.blockList[t].highlight(),this.highlightedBlock=t)},this.hide=function(){for(var t in this.blockList)this.blockList[t].hide();this.visible=!1},this.show=function(){for(var t in this.blockList)this.blockList[t].show();this.visible=!0},this._makeNewBlockWithConnections=function(t,o,s,e,i,n){if(void 0===n&&(n=!1),myBlock=this.makeNewBlock(t,e,i),null!=myBlock)for(var l=0;l<s.length&&l!==myBlock.docks.length;l++)null==s[l]?myBlock.connections.push(null):myBlock.connections.push(s[l]+o);else console.log("could not make block "+t)},this.makeNewBlock=function(t,o,s){if(!t in this.protoBlockDict)return console.log("makeNewBlock: no prototype for "+t),null;if(null==this.protoBlockDict[t])return console.log("makeNewBlock: no prototype for "+t),null;if(-1!==["sine","sawtooth","triangle","square"].indexOf(t)&&_THIS_IS_MUSIC_BLOCKS_&&this.logo.synth.loadSynth(t),-1!==["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(t)?this.blockList.push(new Block(this.protoBlockDict[t],this,s[1])):"namedarg"===t?this.blockList.push(new Block(this.protoBlockDict[t],this,"arg "+s[1])):this.blockList.push(new Block(this.protoBlockDict[t],this)),null==last(this.blockList))return console.log("failed to make protoblock for "+t),null;var e=last(this.blockList);return e.copySize(),e.postProcess=o,e.postProcessArg=s,e.container=new createjs.Container,this.stage.addChild(e.container),e.container.snapToPixelEnabled=!0,e.container.x=0,e.container.y=0,e.imageLoad(),e},this.makeBlock=function(t,o){"text"===t&&console.log("makeBlock "+t+" "+o);var s=null,e=null,i=this,n=this.blockList.length;"start"===t?(s=function(t){i.blockList[t].value=i.turtles.turtleList.length,i.turtles.addTurtle(i.blockList[t])},e=n):"drum"===t?(s=function(t){i.blockList[t].value=i.turtles.turtleList.length,i.turtles.addDrum(i.blockList[t])},e=n):"text"===t?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s,i.blockList[o].text.text=s,i.blockList[o].container.updateCache()},e=[n,_("text")]):"solfege"===t?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s,i.blockList[o].text.text=s,i.blockList[o].container.updateCache()},e=[n,"sol"]):"eastindiansolfege"===t?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s,i.blockList[o].text.text=WESTERN2EISOLFEGENAMES[s],i.blockList[o].container.updateCache()},e=[n,"sol"]):"notename"===t?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s,i.blockList[o].text.text=s,i.blockList[o].container.updateCache()},e=[n,"G"]):"drumname"===t?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s,i.blockList[o].text.text=s,i.blockList[o].container.updateCache()},e=[n,"kick"]):"voicename"===t?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s,i.blockList[o].text.text=s,i.blockList[o].container.updateCache()},e=[n,"sine"]):"modename"===t?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s,i.blockList[o].text.text=s,i.blockList[o].container.updateCache()},e=[n,"Major"]):"number"===t?(s=function(t){var o=t[0],s=Number(t[1]);i.blockList[o].value=s,i.blockList[o].text.text=s.toString(),i.blockList[o].container.updateCache()},e=[n,NUMBERBLOCKDEFAULT]):"media"===t?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s,i.blockList[o].image=null==s?"images/load-media.svg":null},e=[n,null]):"camera"===t?(s=function(t){console.log("post process camera "+t[1]);var o=t[0],s=t[1];i.blockList[o].value=CAMERAVALUE,i.blockList[o].image=null==s?"images/camera.svg":null},e=[n,null]):"video"===t?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=VIDEOVALUE,i.blockList[o].image=null==s?"images/video.svg":null},e=[n,null]):"loadFile"===t?(s=function(t){i.updateBlockText(t[0])},e=[n,null]):-1!==["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg","namedarg"].indexOf(t)&&(s=function(t){i.blockList[n].value=null,i.blockList[n].privateData=t[1]},e=[n,o]);var l=!1;for(var c in i.protoBlockDict)if(i.protoBlockDict[c].name===t){if("__NOARG__"===o){i.makeNewBlock(c,s,e),l=!0;break}if(i.protoBlockDict[c].defaults[0]===o){i.makeNewBlock(c,s,e),l=!0;break}if(-1!==["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg","namedarg"].indexOf(t)&&void 0===i.protoBlockDict[c].defaults[0]){i.makeNewBlock(c,s,e),l=!0;break}}l||console.log(t+" not found!!");for(var a=this.blockList.length-1,h=this.blockList[a],r=0;r<h.docks.length;r++)h.connections.push(null);var k=a+1;for(r=0;r<h.protoblock.defaults.length;r++){var u=h.protoblock.defaults[r];"action"===h.name&&(u=this.findUniqueActionName(_("action")))!==_("action")&&(this.newNameddoBlock(u,!1,!1),this.palettes.hide(),this.palettes.updatePalettes("action"),this.palettes.show());i=this,n=this.blockList.length;h.docks.length>r&&"anyin"===h.docks[r+1][2]?null==u?console.log("cannot set default value"):"string"==typeof u?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s;var e=s.toString();e.length>8&&(e=e.substr(0,7)+"..."),i.blockList[o].text.text=e,i.blockList[o].container.updateCache()},this.makeNewBlock("text",s,[n,u])):(s=function(t){var o=t[0],s=Number(t[1]);i.blockList[o].value=s,i.blockList[o].text.text=s.toString()},this.makeNewBlock("number",s,[n,u])):"textin"===h.docks[r+1][2]?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s;var e=s.toString();e.length>8&&(e=e.substr(0,7)+"..."),i.blockList[o].text.text=e},this.makeNewBlock("text",s,[n,u])):"solfegein"===h.docks[r+1][2]?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s;var e=s.toString();i.blockList[o].text.text=e},this.makeNewBlock("solfege",s,[n,u])):"notein"===h.docks[r+1][2]?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s;var e=s.toString();i.blockList[o].text.text=e},this.makeNewBlock("notename",s,[n,u])):"mediain"===h.docks[r+1][2]?(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s},this.makeNewBlock("media",s,[n,u])):"filein"===h.docks[r+1][2]?(s=function(t){i.updateBlockText(t)},this.makeNewBlock("loadFile",s,n)):(s=function(t){var o=t[0],s=t[1];i.blockList[o].value=s,i.blockList[o].text.text=s.toString()},this.makeNewBlock("number",s,[n,u]));var b=this.blockList[k+r];b.connections=[a],b.value=u,h.connections[r+1]=k+r}return this.updateBlockPositions(),this.adjustDocks(a,!0),this.refreshCanvas(),a},this.findDragGroup=function(t){this.dragLoopCounter=0,this.dragGroup=[],this._calculateDragGroup(t)},this._calculateDragGroup=function(t){if(this.dragLoopCounter+=1,this.dragLoopCount>this.blockList.length)console.log("maximum loop counter exceeded in calculateDragGroup... this is bad. "+t);else if(null!=t){var o=this.blockList[t];if(null!=o)if(null!=o.connections)if(0!==o.connections.length){this.dragGroup.push(t);for(var s=1;s<o.connections.length;s++){var e=o.connections[s];null!=e&&this._calculateDragGroup(e)}}else this.dragGroup=[t];else this.dragGroup=[t];else console.log("null block encountered... this is bad. "+t)}else console.log("null block passed to calculateDragGroup")},this.setActionProtoVisiblity=function(t){for(var o=this.palettes.dict.action,s=!1,e=0;e<o.protoList.length;e++){var i=o.protoList[e];"nameddo"===i.name&&0===i.defaults.length&&i.hidden===t&&(i.hidden=!t,s=!0)}s&&(this.palettes.hide(),this.palettes.updatePalettes("action"),this.palettes.show())},this.findUniqueActionName=function(t){t===_("action")&&this.setActionProtoVisiblity(!0);for(var o=[],s=0;s<this.blockList.length;s++)if(("text"===this.blockList[s].name||"string"===this.blockList[s].name)&&!this.blockList[s].trash){var e=this.blockList[s].connections[0];null==e||"action"!==this.blockList[e].name||this.blockList[e].trash||o.push(this.blockList[s].value)}for(var i=1,n=t;-1!==o.indexOf(n);)n=t+i.toString(),i+=1;return n},this._findDrumURLs=function(){for(var t=0;t<this.blockList.length;t++)if("text"===this.blockList[t].name||"string"===this.blockList[t].name){var o=this.blockList[t].connections[0];null!=o&&-1!==["playdrum","setdrum","setvoice"].indexOf(this.blockList[o].name)&&"http"===this.blockList[t].value.slice(0,4)&&_THIS_IS_MUSIC_BLOCKS_&&this.logo.synth.loadSynth(this.blockList[t].value)}},this.renameBoxes=function(t,o){if(t!==o)for(var s=0;s<this.blockList.length;s++)if("text"===this.blockList[s].name){var e=this.blockList[s].connections[0];if(null!=e&&"box"===this.blockList[e].name&&this.blockList[s].value===t){this.blockList[s].value=o,this.blockList[s].text.text=o;try{this.blockList[s].container.updateCache()}catch(t){console.log(t)}}}},this.renameNamedboxes=function(t,o){if(t!==o){for(var s=0;s<this.blockList.length;s++)if("namedbox"===this.blockList[s].name&&this.blockList[s].privateData===t){this.blockList[s].privateData=o,this.blockList[s].overrideName=o,this.blockList[s].regenerateArtwork();try{this.blockList[s].container.updateCache()}catch(t){console.log(t)}}for(var e=this.palettes.dict.boxes,i=!1,n=0;n<e.protoList.length;n++){var l=e.protoList[n];"namedbox"===l.name&&l.defaults[0]!==_("box")&&l.defaults[0]===t&&(l.defaults[0]=o,i=!0)}i&&(this.palettes.hide(),this.palettes.updatePalettes("boxes"),this.palettes.show())}},this.renameDos=function(t,o,s){if(t!==o)for(var e=0;e<this.blockList.length;e++)if(e!==s){var i=this.blockList[e],n=this.blockList[i.connections[0]];if(null!=n)if(-1!==["do","calc","doArg","calcArg","action"].indexOf(n.name))if(i.value===t){i.value=o;var l=i.value;l.length>8&&(l=l.substr(0,7)+"..."),i.text.text=l,i.container.updateCache()}}},this.renameNameddos=function(t,o){if(t!==o){for(var s=0;s<this.blockList.length;s++)if(-1!==["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(this.blockList[s].name)&&this.blockList[s].privateData===t){this.blockList[s].privateData=o;var e=o;e.length>8&&(e=e.substr(0,7)+"..."),this.blockList[s].overrideName=e,this.blockList[s].regenerateArtwork()}for(var i=this.palettes.dict.action,n=!1,l=0;l<i.protoList.length;l++){var c=i.protoList[l];-1!==["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(c.name)&&c.defaults[0]===t&&(c.defaults[0]=o,n=!0)}n&&(this.palettes.hide(),this.palettes.updatePalettes("action"),this.palettes.show())}},this.newStoreinBlock=function(t){if(null!=t)if(null!=t){if(!("myStorein_"+t in this.protoBlockDict)){var o=new ProtoBlock("storein");this.protoBlockDict["myStorein_"+t]=o,o.palette=this.palettes.dict.boxes,o.defaults.push(t),o.defaults.push(NUMBERBLOCKDEFAULT),o.staticLabels.push(_("store in"),_("name"),_("value")),o.adjustWidthToLabel(),o.twoArgBlock(),o.dockTypes[1]="anyin",o.dockTypes[2]="anyin","box"!==t&&o.palette.add(o,!0)}}else console.log("undefined name passed to newStoreinBlock");else console.log("null name passed to newStoreinBlock")},this.newNamedboxBlock=function(t){if(null!=t)if(null!=t){if(!("myBox_"+t in this.protoBlockDict)){var o=new ProtoBlock("namedbox");this.protoBlockDict["myBox_"+t]=o,o.palette=this.palettes.dict.boxes,o.defaults.push(t),o.staticLabels.push(t),o.parameterBlock(),"box"!==t&&o.palette.add(o,!0)}}else console.log("undefined name passed to newNamedboxBlock");else console.log("null name passed to newNamedboxBlock")},this._newLocalArgBlock=function(t){var o="arg_"+t;if(!("myArg_"+t in this.protoBlockDict)&&!(o in this.protoBlockDict)){var s=new ProtoBlock("namedarg");if(this.protoBlockDict["myArg_"+o]=s,s.palette=this.palettes.dict.action,s.defaults.push(t),s.staticLabels.push("arg "+t),s.parameterBlock(),"arg_1"!==o){s.palette.add(s,!0);var e=this;setTimeout((function(){e.palettes.hide(),e.palettes.updatePalettes("action"),e.palettes.show()}),500)}}},this._removeNamedoEntries=function(t){this.protoBlockDict["myDo_"+t]?(this.protoBlockDict["myDo_"+t].hide=!0,delete this.protoBlockDict["myDo_"+t]):this.protoBlockDict["myCalc_"+t]?(this.protoBlockDict["myCalc_"+t].hide=!0,delete this.protoBlockDict["myCalc_"+t]):this.protoBlockDict["myDoArg_"+t]?(this.protoBlockDict["myDoArg_"+t].hide=!0,delete this.protoBlockDict["myDoArg_"+t]):this.protoBlockDict["myCalcArg_"+t]&&(this.protoBlockDict["myCalcArg_"+t].hide=!0,delete this.protoBlockDict["myCalcArg_"+t])},this.newNameddoBlock=function(t,o,s){if(t===_("action"))return!1;if(o&&s)return this.newNamedcalcArgBlock(t),!0;if(!o&&s)return this.newNameddoArgBlock(t),!0;if(o&&!s)return this.newNamedcalcBlock(t),!0;if(void 0===this.protoBlockDict["myDo_"+t]){var e=new ProtoBlock("nameddo");return this.protoBlockDict["myDo_"+t]=e,e.palette=this.palettes.dict.action,e.defaults.push(t),e.staticLabels.push(t),e.zeroArgBlock(),e.palette.add(e,!0),this.palettes.updatePalettes(),!0}return!1},this.newNamedcalcBlock=function(t){if(void 0===this.protoBlockDict["myCalc_"+t]){var o=new ProtoBlock("namedcalc");this.protoBlockDict["myCalc_"+t]=o,o.palette=this.palettes.dict.action,o.defaults.push(t),o.staticLabels.push(t),o.zeroArgBlock(),o.palette.add(o,!0)}},this.newNameddoArgBlock=function(t){if(void 0===this.protoBlockDict["myDoArg_"+t]){var o=new ProtoBlock("nameddoArg");this.protoBlockDict["myDoArg_"+t]=o,o.palette=this.palettes.dict.action,o.defaults.push(t),o.staticLabels.push(t),o.zeroArgBlock(),o.palette.add(o,!0)}},this.newNamedcalcArgBlock=function(t){if(void 0===this.protoBlockDict["myCalcArg_"+t]){var o=new ProtoBlock("namedcalcArg");this.protoBlockDict["myCalcArg_"+t]=o,o.palette=this.palettes.dict.action,o.defaults.push(t),o.staticLabels.push(t),o.zeroArgBlock(),o.palette.add(o,!0)}},this._insideArgClamp=function(t){if(null==this.blockList[t])return console.log("null block in blockList? "+t),null;if(null==this.blockList[t].connections[0])return null;var o=this.blockList[t].connections[0];return this.blockList[o].isArgClamp()?o:null},this._insideExpandableBlock=function(t){if(null==this.blockList[t])return console.log("null block in blockList? "+t),null;if(null==this.blockList[t].connections[0])return null;var o=this.blockList[t].connections[0];return this.blockList[o].isExpandableBlock()?this.blockList[o].isArgFlowClampBlock()?o:t===last(this.blockList[o].connections)?this._insideExpandableBlock(o):o:this._insideExpandableBlock(o)},this._insideNoteBlock=function(t){if(null==this.blockList[t])return console.log("null block in blockList? "+t),null;if(null==this.blockList[t].connections[0])return null;var o=this.blockList[t].connections[0];return this.blockList[o].isExpandableBlock()?t===last(this.blockList[o].connections)?this._insideNoteBlock(o):t===this.blockList[o].connections[1]?null:-1!==["newnote","osctime"].indexOf(this.blockList[o].name)?o:null:this._insideNoteBlock(o)},this.triggerLongPress=function(t){this.timeOut,this.inLongPress=!0;var o=this.stage.getNumChildren()-1,s=this.findTopBlock(this.activeBlock);this.selectedStack=s,this.selectedBlocksObj=JSON.parse(JSON.stringify(this._copyBlocksToObj())),this.updatePasteButton(),"action"===t.name&&(this.dismissButton.visible=!0,this.dismissButton.x=t.container.x-27,this.dismissButton.y=t.container.y-27,this.stage.setChildIndex(this.dismissButton,o-1),this.saveStackButton.visible=!0,this.saveStackButton.x=t.container.x+27,this.saveStackButton.y=t.container.y-27,this.stage.setChildIndex(this.saveStackButton,o-2)),this.refreshCanvas()},this.pasteStack=function(){if(null!=this.selectedStack){for(var t in this.palettes.dict)this.palettes.dict[t].hideMenu(!0);this.loadNewBlocks(this.selectedBlocksObj)}},this.saveStack=function(){if(null!=this.selectedStack){this.palettes.hide();var t=this._copyBlocksToObj(),o=t[0][4][1];if(null==o)console.log("action not named... skipping");else{if(console.log(t[o][1][1]),"string"==typeof t[o][1][1])var s=t[o][1][1];else if("number"==typeof t[o][1][1])s=t[o][1][1].toString();else s=t[o][1][1].value;storage.macros=prepareMacroExports(s,t,this.macroDict),sugarizerCompatibility.isInsideSugarizer()?sugarizerCompatibility.saveLocally((function(){this.addToMyPalette(s,t)})):this.addToMyPalette(s,t)}}},this._copyBlocksToObj=function(){var t=[],o={};this.findDragGroup(this.selectedStack);for(var s=0;s<this.dragGroup.length;s++){if(myBlock=this.blockList[this.dragGroup[s]],0===s?(x=75-this.stage.x,y=75-this.stage.y):(x=0,y=0),myBlock.isValueBlock())switch(myBlock.name){case"media":blockItem=[s,[myBlock.name,null],x,y,[]];break;default:blockItem=[s,[myBlock.name,myBlock.value],x,y,[]]}else-1!==["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg","namedarg"].indexOf(myBlock.name)?blockItem=[s,[myBlock.name,{value:myBlock.privateData}],x,y,[]]:blockItem=[s,myBlock.name,x,y,[]];o[this.dragGroup[s]]=s,t.push(blockItem)}for(s=0;s<this.dragGroup.length;s++){myBlock=this.blockList[this.dragGroup[s]];for(var e=0;e<myBlock.connections.length;e++)null==myBlock.connections[e]?t[s][4].push(null):t[s][4].push(o[myBlock.connections[e]])}return t},this.addToMyPalette=function(t,o){var s=new ProtoBlock("macro_"+t),e="macro_"+t;this.protoBlockDict[e]=s,"myblocks"in this.palettes.dict||this.palettes.add("myblocks"),s.palette=this.palettes.dict.myblocks,s.zeroArgBlock(),s.staticLabels.push(_(t)),this.protoBlockDict[e].palette.add(this.protoBlockDict[e])},this.loadNewBlocks=function(t){for(var o=0;o<t.length;o++){var s=t[o];for(var e in s[4])if(s[4][e]===s[0])return console.log("Circular connection in block data: "+s),console.log("Punting loading of new blocks!"),void console.log(t)}var i=[],l=[];for(o=0;o<this.blockList.length;o++)this.blockList[o].trash||("action"===this.blockList[o].name?null!=this.blockList[o].connections[1]&&(console.log(this.blockList[this.blockList[o].connections[1]].value),i.push(this.blockList[this.blockList[o].connections[1]].value)):"storein"===this.blockList[o].name&&null!=this.blockList[o].connections[1]&&l.push(this.blockList[this.blockList[o].connections[1]].value));this._checkTwoArgBlocks=[],this._checkArgClampBlocks=[];var c={},a={},h={},r={};this.blocksToCollapse=[];for(o=0;o<t.length;o++){if("string"==typeof(s=t[o])[1])var k=s[1];else k=s[1][0];if(!(k in this.protoBlockDict))switch(k){case"hat":k="action";break;case"string":k="text";break;default:console.log("skipping "+k);continue}switch(-1!==["arg","twoarg"].indexOf(this.protoBlockDict[k].style)&&this.protoBlockDict[k].expandable&&this._checkTwoArgBlocks.push(this.blockList.length+o),-1!==["clamp","argclamp","argclamparg","doubleclamp","argflowclamp"].indexOf(this.protoBlockDict[k].style)&&this._checkArgClampBlocks.push(this.blockList.length+o),k){case"text":var u=s[1][1];void 0===c[u]&&(c[u]=[]),c[u].push(o);break;case"action":case"hat":null!=s[4][1]&&(a[o]=s[4][1]);break;case"storein":null!=s[4][1]&&(h[o]=s[4][1]);break;case"nameddo":case"namedcalc":case"nameddoArg":case"namedcalcArg":r[o]=s[1][1].value;break;case"do":case"stack":null!=s[4][1]&&(r[o]=s[4][1])}switch(k){case"action":case"pitchdrummatrix":case"rhythmruler":case"pitchstaircase":case"tempo":case"pitchslider":case"matrix":case"drum":case"status":case"start":"object"==typeof s[1]&&s[1].length>1&&"object"==typeof s[1][1]&&"collapsed"in s[1][1]&&s[1][1].collapsed&&this.blocksToCollapse.push(this.blockList.length+o)}}var b=!1;for(var o in h){s=t[h[o]];if(-1===l.indexOf(s[1][1])){if("string"==typeof s[1][1])k=s[1][1];else k=s[1][1].value;this.newStoreinBlock(k),this.newNamedboxBlock(k),b=!0}}for(var o in a){if("string"==typeof(s=t[a[o]])[1][1])k=s[1][1];else k=s[1][1].value;k===_("action")&&this.setActionProtoVisiblity(!0);for(var d=k,p=1;-1!==i.indexOf(k);)if(k=d+p.toString(),(p+=1)>this.blockList.length){console.log("Could not generate unique action name.");break}for(var g in d!==k&&(console.log("action "+d+" is being renamed "+k),s[1][1]={value:k}),r){var f=t[g];if("string"==typeof f[1])var L=f[1];else L=f[1][0];if(-1!==["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(L))f[1][1].value===d&&(f[1][1]={value:k});else{var m=t[r[g]];"string"==typeof m[1][1]?m[1][1]===d&&(m[1][1]=k):m[1][1].value===d&&(m[1][1]={value:k})}}}b&&(this.palettes.hide(),this.palettes.updatePalettes("action"),this.palettes.show()),blockObjsLength=t.length;var v=0;for(o=0;o<blockObjsLength;o++){if("object"==typeof t[o][1])k=t[o][1][0];else k=t[o][1];switch(k){case"articulation":case"augmented":case"backward":case"crescendo":case"diminished":case"dividebeatfactor":case"drift":case"duplicatenotes":case"invert1":case"fill":case"flat":case"hollowline":case"major":case"minor":case"multiplybeatfactor":case"note":case"newnote":case"newslur":case"newstaccato":case"newswing":case"newswing2":case"osctime":case"perfect":case"pluck":case"rhythmicdot":case"setbpm":case"setnotevolume2":case"settransposition":case"setvoice":case"sharp":case"skipnotes":case"slur":case"staccato":case"swing":case"tie":case"tuplet2":case"vibrato":var B=t[o][4].length;if(null==last(t[o][4]))console.log("last connection of "+k+" is null: adding hidden block"),t[o][4][B-1]=blockObjsLength+v,t.push([blockObjsLength+v,"hidden",0,0,[o,null]]),v+=1;else{if("object"==typeof t[w=t[o][4][B-1]][1])var x=t[w][1][0];else x=t[w][1];"hidden"!==x&&(console.log("last connection of "+k+" is "+x+": adding hidden block"),t[o][4][B-1]=blockObjsLength+v,t[w][4][0]=blockObjsLength+v,t.push([blockObjsLength+v,"hidden",0,0,[o,w]]),v+=1)}if(-1!==["note","slur","staccato","swing"].indexOf(k)){console.log("note: "+o);var C=t[o][4][2];t[o][4][2]=blockObjsLength+v,null==C?t.push([blockObjsLength+v,"vspace",0,0,[o,null]]):(t[C][4][0]=blockObjsLength+v,t.push([blockObjsLength+v,"vspace",0,0,[o,C]])),v+=1;var A=t[o][4][1];t[o][4][1]=blockObjsLength+v,null==A?(t.push([blockObjsLength+v,"divide",0,0,[o,blockObjsLength+v+1,blockObjsLength+v+2]]),t.push([blockObjsLength+v+1,["number",{value:1}],0,0,[blockObjsLength+v]]),t.push([blockObjsLength+v+2,["number",{value:1}],0,0,[blockObjsLength+v]]),v+=3):(t[A][4][0]=blockObjsLength+v,t.push([blockObjsLength+v,"divide",0,0,[o,blockObjsLength+v+1,A]]),t.push([blockObjsLength+v+1,["number",{value:1}],0,0,[blockObjsLength+v]]),v+=2),"object"==typeof t[o][1]?t[o][1][0]="new"+k:t[o][1]="new"+k}break;case"action":B=t[o][4].length;if(null==t[o][4][2])console.log("last connection of "+k+" is null: adding hidden block"),t[o][4][2]=blockObjsLength+v,t.push([blockObjsLength+v,"hidden",0,0,[o,null]]),v+=1;else{var w;if("object"==typeof t[w=t[o][4][2]][1])x=t[w][1][0];else x=t[w][1];"hidden"!==x&&(console.log("last connection of "+k+" is "+x+": adding hidden block"),t[o][4][2]=blockObjsLength+v,t[w][4][0]=blockObjsLength+v,t.push([blockObjsLength+v,"hidden",0,0,[o,w]]),v+=1)}}}this._adjustTheseStacks=[],this._adjustTheseDocks=[],this._loadCounter=t.length;var S=this.blockList.length,y=this.blockList.length;for(o=0;o<this._loadCounter;o++){var T=S+o;if("object"==typeof(s=t[o])[1])if(1===s[1].length)var D=[s[1][0],{value:null}];else if(-1!==["number","string"].indexOf(typeof s[1][1])){D=[s[1][0],{value:s[1][1]}];-1!==COLLAPSABLES.indexOf(s[1][0])&&(D[1].collapsed=!1)}else D=s[1];else{D=[s[1],{value:null}];-1!==COLLAPSABLES.indexOf(s[1])&&(D[1].collapsed=!1)}k=D[0];var N=!1;if(-1!==COLLAPSABLES.indexOf(k)&&(N=D[1].collapsed),null==D[1])var P=null;else P=D[1].value;k in NAMEDICT&&(k=NAMEDICT[k]);var O=this;switch(k){case"start":s[4][0]=null,s[4][2]=null,postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].value=O.turtles.turtleList.length,O.turtles.addTurtle(O.blockList[o],s)},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,D[1]],N);break;case"drum":s[4][0]=null,s[4][2]=null,postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].value=O.turtles.turtleList.length,O.turtles.addDrum(O.blockList[o],s)},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,D[1]],N),_THIS_IS_MUSIC_BLOCKS_&&this.logo.synth.loadSynth("kick");break;case"action":case"hat":s[4][0]=null,s[4][3]=null,this._makeNewBlockWithConnections("action",S,s[4],null,null,N);break;case"namedbox":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].privateData=s,O.blockList[o].value=null},this._makeNewBlockWithConnections("namedbox",S,s[4],postProcess,[T,P]);break;case"namedarg":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].privateData=s,O.blockList[o].value=null},this._makeNewBlockWithConnections("namedarg",S,s[4],postProcess,[T,P]);break;case"namedcalc":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].privateData=s,O.blockList[o].value=null},this._makeNewBlockWithConnections("namedcalc",S,s[4],postProcess,[T,P]);break;case"nameddo":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].privateData=s,O.blockList[o].value=null},this._makeNewBlockWithConnections("nameddo",S,s[4],postProcess,[T,P]);break;case"doArg":postProcess=function(t){var o=t[0],s=t[1].length-4;if(s>0){for(var e=O.blockList[o].argClampSlots,i=0;i<s;i++)e.push(1),O._newLocalArgBlock(e.length),O.blockList[o].connections.push(null);O.blockList[o].updateArgSlots(e);for(i=0;i<t[1].length;i++)null!=t[1][i]?O.blockList[o].connections[i]=t[1][i]+y:O.blockList[o].connections[i]=t[1][i]}O._checkArgClampBlocks.push(o)},this._makeNewBlockWithConnections("doArg",S,s[4],postProcess,[T,s[4]]);break;case"nameddoArg":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].privateData=s,O.blockList[o].value=null;var e=t[2].length-3;if(e>0){for(var i=O.blockList[o].argClampSlots,n=0;n<e;n++)i.push(1),O._newLocalArgBlock(i.length),O.blockList[o].connections.push(null);O.blockList[o].updateArgSlots(i);for(n=0;n<t[2].length;n++)null!=t[2][n]?O.blockList[o].connections[n]=t[2][n]+y:O.blockList[o].connections[n]=t[2][n]}O._checkArgClampBlocks.push(o)},this._makeNewBlockWithConnections("nameddoArg",S,s[4],postProcess,[T,P,s[4]]);break;case"calcArg":postProcess=function(t){var o=t[0],s=t[1].length-3;if(s>0){for(var e=O.blockList[o].argClampSlots,i=0;i<s;i++)e.push(1),O._newLocalArgBlock(e.length),O.blockList[o].connections.push(null);O.blockList[o].updateArgSlots(e);for(i=0;i<t[1].length;i++)null!=t[1][i]?O.blockList[o].connections[i]=t[1][i]+y:O.blockList[o].connections[i]=t[1][i]}O._checkArgClampBlocks.push(o)},this._makeNewBlockWithConnections("calcArg",S,s[4],postProcess,[T,s[4]]);break;case"namedcalcArg":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].privateData=s,O.blockList[o].value=null;var e=t[2].length-2;if(e>0){for(var i=O.blockList[o].argClampSlots,n=0;n<e;n++)i.push(1),O._newLocalArgBlock(i.length),O.blockList[o].connections.push(null);O.blockList[o].updateArgSlots(i);for(n=0;n<t[2].length;n++)null!=t[2][n]?O.blockList[o].connections[n]=t[2][n]+y:O.blockList[o].connections[n]=t[2][n]}O._checkArgClampBlocks.push(o)},this._makeNewBlockWithConnections("namedcalcArg",S,s[4],postProcess,[T,P,s[4]]);break;case"number":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].value=Number(s),O.updateBlockText(o)},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,P]);break;case"text":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].value=s,O.updateBlockText(o)},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,P]);break;case"solfege":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].value=s,O.updateBlockText(o)},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,P]);break;case"eastindiansolfege":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].value=s,O.updateBlockText(o)},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,P]);break;case"notename":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].value=s,O.updateBlockText(o)},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,P]);break;case"modename":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].value=s,O.updateBlockText(o)},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,P]);break;case"drumname":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].value=s,O.updateBlockText(o)},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,P]),_THIS_IS_MUSIC_BLOCKS_&&this.logo.synth.loadSynth(getDrumSynthName(P));break;case"voicename":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].value=s,O.updateBlockText(o)},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,P]),_THIS_IS_MUSIC_BLOCKS_&&this.logo.synth.loadSynth(getVoiceSynthName(P));break;case"media":postProcess=function(t){var o=t[0],s=t[1];O.blockList[o].value=s,null!=s&&O.blockList[o].loadThumbnail(null)},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,P]);break;case"camera":postProcess=function(t){var o=t[0];t[1];O.blockList[o].value=CAMERAVALUE},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,P]);break;case"video":postProcess=function(t){var o=t[0];t[1];O.blockList[o].value=VIDEOVALUE},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,P]);break;case"red":case"black":postProcess=function(t){O.blockList[t].value=0,O.updateBlockText(t)},this._makeNewBlockWithConnections("number",S,s[4],postProcess,T);break;case"white":postProcess=function(t){O.blockList[t].value=100,O.updateBlockText(t)},this._makeNewBlockWithConnections("number",S,s[4],postProcess,T);break;case"orange":postProcess=function(t){O.blockList[t].value=10,O.updateBlockText(t)},this._makeNewBlockWithConnections("number",S,s[4],postProcess,T);break;case"yellow":postProcess=function(t){O.blockList[t].value=20,O.updateBlockText(t)},this._makeNewBlockWithConnections("number",S,s[4],postProcess,T);break;case"green":postProcess=function(t){O.blockList[t].value=40,O.updateBlockText(t)},this._makeNewBlockWithConnections("number",S,s[4],postProcess,T);break;case"blue":postProcess=function(t){O.blockList[t].value=70,O.updateBlockText(t)},this._makeNewBlockWithConnections("number",S,s[4],postProcess,T);break;case"leftpos":postProcess=function(t){O.blockList[t].value=-canvas.width/2,O.updateBlockText(t)},this._makeNewBlockWithConnections("number",S,s[4],postProcess,T);break;case"rightpos":postProcess=function(t){O.blockList[t].value=canvas.width/2,O.updateBlockText(t)},this._makeNewBlockWithConnections("number",S,s[4],postProcess,T);break;case"toppos":postProcess=function(t){O.blockList[t].value=canvas.height/2,O.updateBlockText(t)},this._makeNewBlockWithConnections("number",S,s[4],postProcess,T);break;case"botpos":case"bottompos":postProcess=function(t){O.blockList[t].value=-canvas.height/2,O.updateBlockText(t)},this._makeNewBlockWithConnections("number",S,s[4],postProcess,T);break;case"width":postProcess=function(t){O.blockList[t].value=canvas.width,O.updateBlockText(t)},this._makeNewBlockWithConnections("number",S,s[4],postProcess,T);break;case"height":postProcess=function(t){O.blockList[t].value=canvas.height,O.updateBlockText(t)},this._makeNewBlockWithConnections("number",S,s[4],postProcess,T);break;case"loadFile":postProcess=function(t){O.blockList[t[0]].value=t[1],O.updateBlockText(t[0])},this._makeNewBlockWithConnections(k,S,s[4],postProcess,[T,P]);break;default:if(!k in this.protoBlockDict||null==this.protoBlockDict[k])switch(n=s[4].length,console.log(n+": substituting nop block for "+k),n){case 1:k="nopValueBlock";break;case 2:k="nopZeroArgBlock";break;case 3:k="nopOneArgBlock";break;case 4:k="nopTwoArgBlock";break;case 5:default:k="nopThreeArgBlock"}this._makeNewBlockWithConnections(k,S,s[4],null)}T===this.blockList.length-1&&null==this.blockList[T].connections[0]&&(this.blockList[T].container.x=s[2],this.blockList[T].container.y=s[3],this._adjustTheseDocks.push(T),null==s[4][0]&&this._adjustTheseStacks.push(T),(s[2]<0||s[3]<0||s[2]>canvas.width||s[3]>canvas.height)&&(this._homeButtonContainers[0].visible=!0,this._homeButtonContainers[1].visible=!1))}},this.cleanupAfterLoad=function(t){if(this._loadCounter-=1,!(this._loadCounter>0)){this._findDrumURLs(),this.updateBlockPositions(),this._cleanupStacks();for(var o=0;o<this.blocksToCollapse.length;o++)this.blockList[this.blocksToCollapse[o]].collapseToggle();this.blocksToCollapse=[];for(var s=0;s<this.blockList.length;s++)null!=this.blockList[s].collapseContainer&&(this.blockList[s].collapseContainer.x=this.blockList[s].container.x+COLLAPSEBUTTONXOFF*(this.blockList[s].protoblock.scale/2),this.blockList[s].collapseContainer.y=this.blockList[s].container.y+COLLAPSEBUTTONYOFF*(this.blockList[s].protoblock.scale/2));this.refreshCanvas();var e=!1;for(s=0;s<this.blockList.length;s++)if(!this.blockList[s].trash&&"action"===this.blockList[s].name){null!=(i=this.blockList[s].connections[1])&&this.blockList[i].value!==_("action")&&this.newNameddoBlock(this.blockList[i].value,this.actionHasReturn(s),this.actionHasArgs(s))&&(e=!0)}e&&(this.palettes.hide(),this.palettes.updatePalettes("action"),this.palettes.show());for(e=!1,s=0;s<this.blockList.length;s++)if(!this.blockList[s].trash&&"storein"===this.blockList[s].name){var i;if(null!=(i=this.blockList[s].connections[1])&&this.blockList[i].value!==_("box")){t=this.blockList[i].value;null==this.protoBlockDict["myStorein_"+t]&&(console.log("adding new storein block "+t),this.newNamedboxBlock(this.blockList[i].value),this.newStoreinBlock(this.blockList[i].value),e=!0)}}if(e){var n=this;setTimeout((function(){n.palettes.hide(),n.palettes.updatePalettes("boxes"),n.palettes.show()}),1500)}console.log("Finished block loading");var l=new Event("finishedLoading");document.dispatchEvent(l)}},this._cleanupStacks=function(){if(this._checkArgClampBlocks.length>0)for(var t=0;t<this._checkArgClampBlocks.length;t++)for(var o=0;o<this._checkArgClampBlocks.length;o++)this._adjustArgClampBlock([this._checkArgClampBlocks[o]]);if(this._checkTwoArgBlocks.length>0)for(t=0;t<this._checkTwoArgBlocks.length;t++)for(o=0;o<this._checkTwoArgBlocks.length;o++)this._adjustExpandableTwoArgBlock([this._checkTwoArgBlocks[o]]);for(var s=0;s<this._adjustTheseDocks.length;s++)this.adjustDocks(this._adjustTheseDocks[s],!0),this._expandClamps();for(s=0;s<this._adjustTheseStacks.length;s++)this.raiseStackToTop(this._adjustTheseStacks[s])},this.actionHasReturn=function(t){if("action"!==this.blockList[t].name)return!1;this.findDragGroup(t);for(var o=0;o<this.dragGroup.length;o++)if("return"===this.blockList[this.dragGroup[o]].name)return!0;return!1},this.actionHasArgs=function(t){if("action"!==this.blockList[t].name)return!1;this.findDragGroup(t);for(var o=0;o<this.dragGroup.length;o++)if("arg"===this.blockList[this.dragGroup[o]].name||"namedarg"===this.blockList[this.dragGroup[o]].name)return!0;return!1},this.raiseStackToTop=function(t){var o=this.findTopBlock(t);this.findDragGroup(o);for(var s=this.stage.getNumChildren()-1,e=0;e<this.dragGroup.length;e++)this.stage.setChildIndex(this.blockList[this.dragGroup[e]].container,s),s-=1;this.refreshCanvas},this.deleteActionBlock=function(t){var o=this.blockList[t.connections[1]];if(o){for(var s=o.value,e=0;e<this.blockList.length;e++){t=this.blockList[e];var i=this.blockList[t.connections[0]];if(null!=i&&-1===["namedcalc","calc","nameddo","do","action"].indexOf(i.name)){var n=t.value;n!==_("action")&&n===s&&(i.hide(),t.hide(),t.trash=!0,i.trash=!0)}}this.deleteActionTimeout+=500;var l=this.deleteActionTimeout,c=this;setTimeout((function(){c.deleteActionTimeout-=500,c.palettes.removeActionPrototype(s)}),l)}},this.sendStackToTrash=function(t){for(var o in this.palettes.dict)this.palettes.dict[o].hideMenu(!0);this.refreshCanvas();var s=this.blockList.indexOf(t);this.trashStacks.push(s);var e=t.connections[0];if(null!=e){for(var i in this.blockList[e].connections)if(this.blockList[e].connections[i]===s){this.blockList[e].connections[i]=null;break}t.connections[0]=null,this.addDefaultBlock(e,s)}if("start"===t.name||"drum"===t.name){turtle=t.value;for(var n=0,l=0;l<this.turtles.turtleList.length;l++)this.turtles.turtleList[l].trash||(n+=1);if(!(null!=turtle&&n>1))return this.errorMsg("You must always have at least one start block"),void console.log("null turtle");console.log("putting turtle "+turtle+" in the trash"),this.turtles.turtleList[turtle].trash=!0,this.turtles.turtleList[turtle].container.visible=!1}else"action"===t.name&&(t.trash||this.deleteActionBlock(t));this.findDragGroup(s);for(var c=0;c<this.dragGroup.length;c++){var a=this.dragGroup[c];this.blockList[a].trash=!0,this.blockList[a].hide(),this.refreshCanvas()}if(null!=e){var h=this.findTopBlock(e);this.findDragGroup(h),this._checkTwoArgBlocks=[],this._checkArgClampBlocks=[];for(c=0;c<this.dragGroup.length;c++){a=this.dragGroup[c];(t=this.blockList[a]).isTwoArgBlock()||t.isArgBlock()&&t.isExpandableBlock()||t.isArgClamp()?this._checkTwoArgBlocks.push(a):-1!==["clamp","argclamp","argclamparg","doubleclamp","argflowclamp"].indexOf(t.protoblock.style)&&this._checkArgClampBlocks.push(a)}this._cleanupStacks(),this.refreshCanvas()}},this}