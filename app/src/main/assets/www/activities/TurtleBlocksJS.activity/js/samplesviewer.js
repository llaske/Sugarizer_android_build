const MUSICBLOCKSPREFIX="MusicBlocks_",APIKEY="3tgTzMXbbw6xEKX7",EMPTYIMAGE="data:image/svg+xml;base64,"+btoa('<svg               xmlns="http://www.w3.org/2000/svg" width="320" height="240"               viewBox="0 0 320 240"></svg>'),SERVER="https://turtle.sugarlabs.org/server/";if(window.server=SERVER,_THIS_IS_MUSIC_BLOCKS_)var SHAREURL="https://walterbender.github.io/musicblocks/index.html?file={name}&run=True";else SHAREURL="https://walterbender.github.io/turtleblocksjs/index.html?file={name}&run=True";const NAMESUBTEXT="{name}",LOCAL_PROJECT_STYLE="<style> .shareurlspan {     position: relative; } .shareurlspan .shareurltext {     visibility: hidden;     background-color: black;     color: #fff;     text-align: center;     padding: 10px;     margin-top; 5px;     border-radius: 6px;     position: absolute;     z-index: 1;     text-align: left; } .shareurltext{     top: 25px;     left: -200px;     visibility: hidden; } .tooltiptriangle{     position: absolute;     visibility: hidden;     top: 15px;     left: 0px;     width: 0;     height: 0;     border-style: solid;     border-width: 0 15px 15px 15px;     border-color: transparent transparent black transparent; } </style>",LOCAL_PROJECT_TEMPLATE='<li data=\'{data}\' title="{title}" current="{current}">     <img class="thumbnail" src="{img}" />     <div class="options">         <input type="text" value="{title}"/><br/>         <img class="open icon" title="'+_("Open")+'" alt="'+_("Open")+'" src="header-icons/edit.svg" />         <img class="delete icon" title="'+_("Delete")+'" alt="'+_("Delete")+'" src="header-icons/delete.svg" />         <img class="publish icon" title="'+_("Publish")+'" alt="'+_("Publish")+'" src="header-icons/publish.svg" />         <span class="shareurlspan">         <img class="share icon" title="'+_("Share")+'" alt="'+_("Share")+'" src="header-icons/share.svg" />         <div class="tooltiptriangle" id="shareurltri_NUM_"></div>         <div class="shareurltext" id="shareurldiv_NUM_">             Copy the link to share your project:            <input type="text" name="shareurl" id="shareurlbox_NUM_" value="url here" style="margin-top:5px;width: 350px;text-align:left;" onblur="document.getElementById(\'shareurldiv_NUM_\').style.visibility = \'hidden\';document.getElementById(\'shareurlbox_NUM_\').style.visibility = \'hidden\';document.getElementById(\'shareurltri_NUM_\').style.visibility = \'hidden\';"/>         </div>         </span>         <img class="download icon" title="'+_("Download")+'" alt="'+_("Download")+'" src="header-icons/download.svg" />     </div> </li>',GLOBAL_PROJECT_TEMPLATE='<img class="thumbnail" src="{img}" /> <div class="options">     <span>{title}</span><br/>     <span class="shareurlspan">     <img class="share icon" title="'+_("Share")+'" alt="'+_("Share")+'" src="header-icons/share.svg" />     <div class="tooltiptriangle" id="plshareurltri_NUM_"></div>     <div class="shareurltext" id="plshareurldiv_NUM_">         Copy the link to share your project:        <input type="text" name="shareurl" id="plshareurlbox_NUM_" value="url here" style="margin-top:5px;width: 350px;text-align:left;" onblur="document.getElementById(\'plshareurldiv_NUM_\').style.visibility = \'hidden\';document.getElementById(\'plshareurlbox_NUM_\').style.visibility = \'hidden\';document.getElementById(\'plshareurltri_NUM_\').style.visibility = \'hidden\';"/>     </div>     </span>     <img class="download icon" title="'+_("Download")+'" alt="'+_("Download")+'" src="header-icons/download.svg" /> </div>';function PlanetModel(e){this.controller=e,this.localProjects=[],this.globalProjects=[],this.localChanged=!1,this.globalImagesCache={},this.updated=function(){},this.addGlobalElement=function(){},this.stop=!1,this.count=0;var t=this;sugarizerCompatibility.isInsideSugarizer()?storage=sugarizerCompatibility.data:storage=localStorage,this.start=function(e,l){t.updated=e,t.addGlobalElement=l,t.stop=!1;for(var i=document.querySelector(".planet .content.w");i.firstChild;)i.removeChild(i.firstChild);this.redoLocalStorageData(),t.updated(),this.downloadWorldWideProjects()},this.downloadWorldWideProjects=function(){jQuery.ajax({url:SERVER,headers:{"x-api-key":APIKEY}}).done((function(e){t.globalProjects=[],t.stop=!1;var l=[];e.forEach((function(e,t){-1!==e.indexOf(".b64")&&(_THIS_IS_MUSIC_BLOCKS_||"MusicBlocks_"!=e.slice(0,"MusicBlocks_".length))&&l.push(e)})),t.count=0,t.getImages(l)}))},this.getImages=function(e){if(!0!==t.stop){var l=e.pop();if(void 0!==l){var i=l.replace(".b64",""),a=!1;_THIS_IS_MUSIC_BLOCKS_&&"MusicBlocks_"===i.slice(0,"MusicBlocks_".length)&&(i=i.substring("MusicBlocks_".length),a=!0),void 0!==t.globalImagesCache[l]?(t.globalProjects.push({title:i,img:t.globalImagesCache[l]}),t.addGlobalElement(t.globalProjects[t.globalProjects.length-1],t.count),t.count++,t.getImages(e)):jQuery.ajax({url:SERVER+l,headers:{"x-api-key":"3tgTzMXbbw6xEKX7"},dataType:"text"}).done((function(o){validateImageData(o)||(o="images/planetgraphic.png"),a&&(o="images/planetgraphic.png"),t.globalImagesCache[l]=o,t.globalProjects.push({title:i,img:o,url:l}),t.addGlobalElement(t.globalProjects[t.globalProjects.length-1],t.count),t.count++,t.getImages(e)}))}}},this.redoLocalStorageData=function(){this.localProjects=[],s=JSON.stringify(localStorage),s=s.replace(/\\n/g,"\\n").replace(/\\'/g,"\\'").replace(/\\"/g,'\\"').replace(/\\&/g,"\\&").replace(/\\r/g,"\\r").replace(/\\t/g,"\\t").replace(/\\b/g,"\\b").replace(/\\f/g,"\\f"),s=s.replace(/[\u0000-\u0019]+/g,"");var e=JSON.parse(s);Object.keys(e).forEach((function(e,l){var i=localStorage["SESSIONIMAGE"+e];"undefined"===i&&(i="images/planetgraphic.png");var a={title:e,img:i,data:localStorage["SESSION"+e],current:e===localStorage.currentProject};a.current?t.localProjects.unshift(a):t.localProjects.push(a)})),this.localChanged=!0},this.uniqueName=function(e){var t=JSON.parse(localStorage.allProjects);if(-1===t.indexOf(e))return e;for(var l=1;;){var i=e+" "+l;if(-1===t.indexOf(i))return i;l++}},this.newProject=function(){var e=this.uniqueName("My Project");t.prepLoadingProject(e),this.controller.sendAllToTrash(!0,!0),t.stop=!0},this.renameProject=function(e,l,i){i&&(localStorage.currentProject=l);var a=JSON.parse(localStorage.allProjects);a[a.indexOf(e)]=l,localStorage.allProjects=JSON.stringify(a),localStorage["SESSIONIMAGE"+l]=localStorage["SESSIONIMAGE"+e],localStorage["SESSION"+l]=localStorage["SESSION"+e],localStorage["SESSIONIMAGE"+e]=void 0,localStorage["SESSION"+e]=void 0,t.redoLocalStorageData()},this.delete=function(e){var l=JSON.parse(localStorage.allProjects);l.splice(l.indexOf(e),1),localStorage.allProjects=JSON.stringify(l),localStorage["SESSIONIMAGE"+e]=void 0,localStorage["SESSION"+e]=void 0,t.redoLocalStorageData(),t.updated()},this.open=function(e,l){localStorage.currentProject=e,t.controller.sendAllToTrash(!1,!0),t.controller.loadRawProject(l),t.stop=!0},this.prepLoadingProject=function(e){localStorage.currentProject=e;var t=JSON.parse(localStorage.allProjects);t.push(e),localStorage.allProjects=JSON.stringify(t)},this.load=function(e){t.prepLoadingProject(e),t.controller.sendAllToTrash(!1,!1),jQuery.ajax({url:SERVER+e+".tb",headers:{"x-api-key":"3tgTzMXbbw6xEKX7"},dataType:"text",error:function(l,i,a){jQuery.ajax({url:SERVER+"MusicBlocks_"+e+".tb",headers:{"x-api-key":"3tgTzMXbbw6xEKX7"},dataType:"text"}).done((function(e){t.controller.loadRawProject(e),t.stop=!0}))}}).done((function(e){t.controller.loadRawProject(e),t.stop=!0}))},this.getPublishableName=function(e){return e.replace(/['!"#$%&\\'()\*+,\-\.\/:;<=>?@\[\\\]\^`{|}~']/g,"").replace(/ /g,"_")},this.publish=function(e,l,i){document.body.style.cursor="wait",setTimeout((function(){e=t.getPublishableName(e),_THIS_IS_MUSIC_BLOCKS_&&(e="MusicBlocks_"+e),httpPost(e+".tb",l),httpPost(e+".b64",i),document.body.style.cursor="default"}),250)}}function PlanetView(e,t){this.model=e,this.controller=t;var l=this;document.querySelector(".planet .new").addEventListener("click",(function(){l.model.newProject(),l.controller.hide()})),document.querySelector("#myOpenFile").addEventListener("change",(function(e){l.controller.hide()})),document.querySelector(".planet .open").addEventListener("click",(function(){document.querySelector("#myOpenFile").focus(),document.querySelector("#myOpenFile").click(),window.scroll(0,0)})),document.querySelector(".planet .back").addEventListener("click",(function(){l.controller.hide()})),this.update=function(){if(this.localChanged){html="",html+=LOCAL_PROJECT_STYLE,this.localProjects.forEach((function(e,t){html+=format(LOCAL_PROJECT_TEMPLATE,e).replace(new RegExp("_NUM_","g"),t.toString())})),document.querySelector(".planet .content.l").innerHTML=html;var e=document.querySelectorAll(".planet .content.l li");Array.prototype.forEach.call(e,(function(e,t){e.querySelector(".open").addEventListener("click",l.open(e)),e.querySelector(".publish").addEventListener("click",l.publish(e)),e.querySelector(".share").addEventListener("click",l.share(e,t)),e.querySelector(".download").addEventListener("click",l.download(e)),e.querySelector(".delete").addEventListener("click",l.delete(e)),e.querySelector("input").addEventListener("change",l.input(e)),e.querySelector(".thumbnail").addEventListener("click",l.open(e))})),this.localChanged=!1}},this.addGlobalElement=function(e,t){var i=document.createElement("li");i.setAttribute("url",e.url),i.setAttribute("title",e.title),html="",html+=format(GLOBAL_PROJECT_TEMPLATE,e).replace(new RegExp("_NUM_","g"),t.toString()),i.innerHTML=html;var a=i;a.querySelector(".thumbnail").addEventListener("click",l.load(a)),a.querySelector(".download").addEventListener("click",l.load(a)),a.querySelector(".share").addEventListener("click",l.planetshare(a,t)),document.querySelector(".planet .content.w").appendChild(a)},this.load=function(e){return function(){l.model.load(e.attributes.title.value),l.controller.hide()}},this.publish=function(e){return function(){l.model.publish(e.attributes.title.value,e.attributes.data.value,e.querySelector("img").src)}},this.share=function(e,t){return function(){if(l.model.publish(e.attributes.title.value,e.attributes.data.value,e.querySelector("img").src),_THIS_IS_MUSIC_BLOCKS_)var i=SHAREURL.replace("{name}","MusicBlocks_"+l.model.getPublishableName(e.attributes.title.value)+".tb");else i=SHAREURL.replace("{name}",l.model.getPublishableName(e.attributes.title.value)+".tb");var a=t.toString();docById("shareurldiv"+a).style.visibility="visible",docById("shareurlbox"+a).style.visibility="visible",docById("shareurltri"+a).style.visibility="visible",docById("shareurlbox"+a).value=i,docById("shareurlbox"+a).focus(),docById("shareurlbox"+a).select()}},this.planetshare=function(e,t){return function(){if(_THIS_IS_MUSIC_BLOCKS_)var i=SHAREURL.replace("{name}","MusicBlocks_"+l.model.getPublishableName(e.attributes.title.value)+".tb");else i=SHAREURL.replace("{name}",l.model.getPublishableName(e.attributes.title.value)+".tb");var a=t.toString();docById("plshareurldiv"+a).style.visibility="visible",docById("plshareurlbox"+a).style.visibility="visible",docById("plshareurltri"+a).style.visibility="visible",docById("plshareurlbox"+a).value=i,docById("plshareurlbox"+a).focus(),docById("plshareurlbox"+a).select()}},this.download=function(e){return function(){download(e.attributes.title.value+".tb","data:text/plain;charset=utf-8,"+e.attributes.data.value)}},this.open=function(e){return function(){docById("statusDiv").style.visibility=localStorage.getItem("isStatusHidden"),docById("statusButtonsDiv").style.visibility=localStorage.getItem("isStatusHidden"),docById("statusTableDiv").style.visibility=localStorage.getItem("isStatusHidden"),_THIS_IS_MUSIC_BLOCKS_&&(docById("ptmDiv").style.visibility=localStorage.getItem("isMatrixHidden"),docById("ptmButtonsDiv").style.visibility=localStorage.getItem("isMatrixHidden"),docById("ptmTableDiv").style.visibility=localStorage.getItem("isMatrixHidden"),docById("pscDiv").style.visibility=localStorage.getItem("isStaircaseHidden"),docById("pscButtonsDiv").style.visibility=localStorage.getItem("isStaircaseHidden"),docById("pscTableDiv").style.visibility=localStorage.getItem("isStaircaseHidden"),docById("sliderDiv").style.visibility=localStorage.getItem("isSliderHidden"),docById("sliderButtonsDiv").style.visibility=localStorage.getItem("isSliderHidden"),docById("sliderTableDiv").style.visibility=localStorage.getItem("isSliderHidden"),docById("pdmDiv").style.visibility=localStorage.getItem("isPitchDrumMatrixHidden"),docById("pdmButtonsDiv").style.visibility=localStorage.getItem("isPitchDrumMatrixHidden"),docById("pdmTableDiv").style.visibility=localStorage.getItem("isPitchDrumMatrixHidden"),docById("rulerDiv").style.visibility=localStorage.getItem("isRhythmRulerHidden"),docById("rulerButtonsDiv").style.visibility=localStorage.getItem("isRhythmRulerHidden"),docById("rulerTableDiv").style.visibility=localStorage.getItem("isRhythmRulerHidden"),docById("modeDiv").style.visibility=localStorage.getItem("isModeWidgetHidden"),docById("modeButtonsDiv").style.visibility=localStorage.getItem("isModeWidgetHidden"),docById("modeTableDiv").style.visibility=localStorage.getItem("isModeWidgetHidden")),"true"!==e.attributes.current.value?(l.model.open(e.attributes.title.value,e.attributes.data.value),l.controller.hide()):l.controller.hide()}},this.delete=function(e){return function(){var t=e.attributes.title.value;l.model.delete(t)}},this.input=function(e){return function(){var t=e.querySelector("input").value,i=e.attributes.title.value,a="true"===e.attributes.current.value;l.model.renameProject(i,t,a),e.attributes.title.value=t}}}function SamplesViewer(){this.stage=null,this.sendAllToTrash=null,this.loadProject=null,this.loadRawProject=null,this.init=function(){this.samples=this,document.querySelector("#planetTitle").innerHTML=_("Planet"),document.querySelector("#planetMyDevice").innerHTML=_("On my device"),document.querySelector("#planetWorldwide").innerHTML=_("Worldwide"),this.model=new PlanetModel(this),this.view=new PlanetView(this.model,this)},this.setClear=function(e){return this.sendAllToTrash=e,this},this.setLoad=function(e){return this.loadProject=e,this},this.setStage=function(e){return this._stage=e,this},this.setLoadRaw=function(e){return this.loadRawProject=e,this},this.setRefreshCanvas=function(e){return this._refreshCanvas=e,this},this.setServer=function(e){this.server=e},this.hide=function(){document.querySelector(".planet").style.display="none",document.querySelector("body").classList.remove("samples-shown"),document.querySelector(".canvasHolder").classList.remove("hide"),document.querySelector("#theme-color").content=platformColor.header,this.samples._stage.enableDOMEvents(!0),window.scroll(0,0)},this.show=function(){document.querySelector(".planet").style.display="",document.querySelector("body").classList.add("samples-shown"),document.querySelector(".canvasHolder").classList.add("hide"),document.querySelector("#theme-color").content="#8bc34a";var e=this;return setTimeout((function(){e.samples._stage.enableDOMEvents(!1)}),250),window.scroll(0,0),this.model.start(this.view.update,this.view.addGlobalElement),!0}}function validateImageData(e){return void 0!==e&&(0===e.indexOf("data:image")&&0!=e.split(",")[1].length)}