define(["sugar-web/bus","sugar-web/env"],(function(e,t){"use strict";var n={},a={},o={},l="sugar_filestore",r=!1,u=0,i=null;function removePending(){0==--u&&i&&(i(),i=null)}function DatastoreObject(e){this.objectId=e,this.newMetadata={},this.newDataAsText=null,this.toload=!1,r||t.getEnvironment((function(){r=!0}));if(void 0===this.objectId){var n=window.top.sugar.environment.objectId;null!=n&&(this.objectId=n,this.toload=!0)}}function indexedDB_setValue(e,t,n){var a=o.db.transaction([l],"readwrite").objectStore(l).put({objectId:e,text:t});a.onerror=function(e){n&&n(a.errorCode)},a.onsuccess=function(e){n&&n(null)}}function indexedDB_getValue(e,t){var n=o.db.transaction([l],"readonly").objectStore(l).get(e);n.onerror=function(e){t&&t(n.errorCode,null)},n.onsuccess=function(e){t&&t(null,n.result?n.result.text:null)}}function indexedDB_getAll(e){var t=o.db.transaction([l],"readonly").objectStore(l).openCursor(),n=[];t.onerror=function(n){e&&e(t.errorCode,null)},t.onsuccess=function(t){var a=t.target.result;a?(n.push(a.key),a.continue()):e&&e(null,n)}}function indexedDB_removeValue(e,t){var n=o.db.transaction([l],"readwrite").objectStore(l).delete(e);n.onerror=function(e){t&&t(n.errorCode)},n.onsuccess=function(e){t&&t(null)}}return n.getUrlParameter=function(e){var t=RegExp("[?&]"+e+"=([^&]*)").exec(window.location.search);return t&&decodeURIComponent(t[1].replace(/\+/g," "))},n.createUUID=function(){for(var e=[],t=0;t<36;t++)e[t]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]="0123456789abcdef".substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")},n.callbackChecker=function(e){return null==e&&(e=function(){}),e},n.create=function(e,t,l){var r=n.callbackChecker(t),u=n.createUUID();void 0!==l&&(e.textsize=l.length);var i=a.getValue("sugar_settings");i&&(e.buddy_name=i.name,e.buddy_color=i.colorvalue),a.setValue("sugar_datastore_"+u,{metadata:e,text:void 0===l?null:{link:u}})?void 0!==l?o.setValue(u,l,(function(e){e?r(-1,null):r(null,u)})):r(null,u):r(-1,null)},n.find=function(e){var t=[];if(!a.test())return t;for(var n in a.getAll())if("sugar_datastore_"==n.substr(0,"sugar_datastore_".length)){var o=a.getValue(n);o.objectId=n.substr("sugar_datastore_".length),void 0!==e&&o.metadata.activity!=e||t.push(o)}return t},n.remove=function(e,t){a.removeValue("sugar_datastore_"+e),o.removeValue(e,t)},n.waitPendingSave=function(e){!function waitPending(e){setTimeout((function(){0==u?e&&e():i=e}),50)}(e)},DatastoreObject.prototype.getMetadata=function(e){var t=n.callbackChecker(e),o=a.getValue("sugar_datastore_"+this.objectId);null!=o&&(this.setMetadata(o.metadata),this.toload=!1,t(null,o.metadata))},DatastoreObject.prototype.loadAsText=function(e){var t=n.callbackChecker(e),l=this,r=a.getValue("sugar_datastore_"+l.objectId);if(null!=r){l.setMetadata(r.metadata);r.text?o.getValue(l.objectId,(function(e,n){e?t(-1,null,null):(l.setDataAsText(n),l.toload=!1,t(null,r.metadata,n))})):(l.toload=!1,t(null,r.metadata,null))}},DatastoreObject.prototype.setMetadata=function(e){for(var t in e)this.newMetadata[t]=e[t]},DatastoreObject.prototype.setDataAsText=function(e){this.newDataAsText=e},DatastoreObject.prototype.save=function(e,t){if(function addPending(){u++}(),void 0===this.objectId){var l=this;this.newMetadata.timestamp=this.newMetadata.creation_time=(new Date).getTime(),this.newMetadata.file_size=0,n.create(this.newMetadata,(function(e,t){null==e&&(l.objectId=t)}))}else this.toload&&(this.getMetadata(null),this.toload=!1);var r=n.callbackChecker(e);t||(this.newMetadata.timestamp=(new Date).getTime());var i=a.getValue("sugar_settings");i&&!t&&(this.newMetadata.buddy_name=i.name,this.newMetadata.buddy_color=i.colorvalue),null!=this.newDataAsText&&(t||(this.newMetadata.textsize=this.newDataAsText.length));l=this;a.setValue("sugar_datastore_"+this.objectId,{metadata:this.newMetadata,text:void 0===this.newDataAsText?null:{link:this.objectId}})?null!=this.newDataAsText?o.setValue(l.objectId,this.newDataAsText,(function(e){e?r(-1,null,null):r(null,l.newMetadata,l.newDataAsText),removePending()})):(r(null,this.newMetadata,this.newDataAsText),removePending()):(r(-1,null),removePending())},n.DatastoreObject=DatastoreObject,n.localStorage=a,n.indexedDB=o,a.load=function(e){e&&e()},a.load(),a.test=function(){return"undefined"!=typeof Storage&&void 0!==window.localStorage},a.setValue=function(e,t){if(this.test())try{return window.localStorage.setItem(e,JSON.stringify(t)),!0}catch(e){return console.log("ERROR: Unable to update local storage"),!1}},a.getValue=function(e){if(this.test())try{return JSON.parse(window.localStorage.getItem(e))}catch(e){return null}return null},a.removeValue=function(e){if(this.test())try{window.localStorage.removeItem(e)}catch(e){}},a.getAll=function(){if(this.test())try{return window.localStorage}catch(e){return null}return null},o.db=null,o.test=function(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB},o.load=function(e){if(null==o.db)if(o.test()){var t=window.indexedDB.open(l,1);t.onerror=function(t){e&&e(-2)},t.onsuccess=function(n){o.db=t.result,e&&e(null)},t.onupgradeneeded=function(e){e.target.result.createObjectStore(l,{keyPath:"objectId"}).createIndex("objectId","objectId",{unique:!0})}}else e&&e(-1);else e(null)},o.setValue=function(e,t,n){null==o.db?o.load((function(a){a?console.log("FATAL ERROR: indexedDB not supported, could be related to use of private mode"):indexedDB_setValue(e,t,n)})):indexedDB_setValue(e,t,n)},o.getValue=function(e,t){null==o.db?o.load((function(n){n?console.log("FATAL ERROR: indexedDB not supported, could be related to use of private mode"):indexedDB_getValue(e,t)})):indexedDB_getValue(e,t)},o.getAll=function(e){null==o.db?o.load((function(t){t?console.log("FATAL ERROR: indexedDB not supported, could be related to use of private mode"):indexedDB_getAll(e)})):indexedDB_getAll(e)},o.removeValue=function(e,t){null==o.db?o.load((function(n){n?console.log("FATAL ERROR: indexedDB not supported, could be related to use of private mode"):indexedDB_removeValue(e,t)})):indexedDB_removeValue(e,t)},n}));