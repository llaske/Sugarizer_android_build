define(["sugar-web/activity/activity","l10n","sugar-web/datastore","activity/model","activity/view","activity/controller"],(function(e,t,o,d,n,l){requirejs(["domReady!"],(function(t){var o,r;e.setup(),document.getElementById("new-todo").placeholder=l10n_s.get("new-todo"),document.getElementById("stop-button").addEventListener("click",(function(t){console.log("writing...");var d=JSON.stringify(o.model.items);e.getDatastoreObject().setDataAsText(d),e.getDatastoreObject().save((function(e){null===e?console.log("write done."):console.log("write failed.")}))})),document.allowDrop=function(e){e.preventDefault()},document.drag=function(e){r=e.target,e.dataTransfer.setData("text/plain",e.target.id)},document.drop=function(e){e.preventDefault();var t=r.childNodes[0].childNodes[1],d=parseInt(r.dataset.id),n=e.target,l=e.target.parentNode.parentNode,i=parseInt(l.dataset.id),c=n.innerText;n.innerText=t.innerText,t.innerText=c;var a=l.className;l.className=r.className,r.className=a,l.childNodes[0].childNodes[0].hasAttribute("checked")?r.childNodes[0].childNodes[0].hasAttribute("checked")||(l.childNodes[0].childNodes[0].removeAttribute("checked"),r.childNodes[0].childNodes[0].setAttribute("checked",null)):r.childNodes[0].childNodes[0].hasAttribute("checked")&&(l.childNodes[0].childNodes[0].hasAttribute("checked")||(r.childNodes[0].childNodes[0].removeAttribute("checked"),l.childNodes[0].childNodes[0].setAttribute("checked",null)));var s=o.controller.model.items.map((function(e){return e.id})).indexOf(d),m=o.controller.model.items.map((function(e){return e.id})).indexOf(i);o.controller.model.items[s].title=t.innerText,o.controller.model.items[m].title=n.innerText;var u=parseInt(o.controller.model.items[m].completed);o.controller.model.items[m].completed=o.controller.model.items[s].completed,o.controller.model.items[s].completed=u},o=new function Todo(){this.model=new d.Model,this.view=new n.View,this.controller=new l.Controller(this.model,this.view)},e.getDatastoreObject().loadAsText((function onLoaded(e,t,d){o.controller.loadItems(JSON.parse(d))}));var i=document.getElementById("new-todo");function lookupId(e){for(var t=e;"LI"!==t.nodeName;)t=t.parentNode;return t.dataset.id}i.addEventListener("keypress",(function(e){e.keyCode===o.controller.ENTER_KEY&&(o.controller.addItem(e.target.value)&&(e.target.value=""))})),document.getElementById("new-todo-button").addEventListener("click",(function(e){o.controller.addItem(i.value)&&(i.value="")})),document.getElementById("todo-list").addEventListener("click",(function(e){var t=e.target;t.className.indexOf("remove")>-1&&o.controller.removeItem(lookupId(t)),t.className.indexOf("toggle")>-1&&o.controller.toggleComplete(lookupId(t),t)}))}))}));