function convertReadableMS(t){var e=parseMs(t);return(e.hours?e.hours+24*e.days+":"+e.minutes+":"+e.seconds:e.minutes+":"+e.seconds).split(":").map((function(t){return(""+t).padStart(2,"0")})).join(":")}define(["sugar-web/activity/activity","l10n","activity/progress","activity/stopwatch","sugar-web/env"],(function(t,e,s,r,i){requirejs(["domReady!"],(function(o){t.setup(),i.getEnvironment((function(i,o){currentenv=o;var a="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,n=o.user?o.user.language:a;window.addEventListener("localized",(function(){e.updateDocument()})),e.init(n);var u=t.getDatastoreObject();main(s,r,e,currentenv.user.colorvalue,u)}))}))}));var defaultWorkTimerLimit=1,defaultBreakTimerLimit=1;function main(t,e,s,r,i){var o=this;function mapRange(t,e){return(e-t.from[0])*(t.to[1]-t.to[0])/(t.from[1]-t.from[0])+t.to[0]}function saveInDataStore(){i.setDataAsText({state:this.state}),i.save((function(t){t&&console.errror(t)}))}function convertReadableMS(t){var e=function parseMs(t){if("number"!=typeof t)throw new TypeError("Expected a number");var e=t>0?Math.floor:Math.ceil;return{days:e(t/864e5),hours:e(t/36e5)%24,minutes:e(t/6e4)%60,seconds:e(t/1e3)%60,milliseconds:e(t)%1e3}}(t);return(e.hours?e.hours+24*e.days+":"+e.minutes+":"+e.seconds:e.minutes+":"+e.seconds).split(":").map((function(t){return(""+t).padStart(2,"0")})).join(":")}function startWork(){var t=this,i=!1===this.state.timerLeftAt?60*this.state.workTimerLimit*1e3:this.state.timerLeftAt;this.workTimer=new e(i),this.state.status="work";const o=!1===this.state.progressLeftAt?this.state.workTimerLimit:this.state.progressLeftAt;this.workTimer.onTime((function(t){setProgress(mapRange({from:[i,0],to:[o,0]},t.ms),t.ms),saveInDataStore()})),this.workTimer.onDone((function(){renderTheme(r.fill),setTimeout((function(){this.state.timerLeftAt=!1,this.state.progressLeftAt=!1,renderStatusText(s.get("break")),startBreak(),t.breakTimer.start()}),1e3)}))}function startBreak(){var t=this,i=!1===this.state.timerLeftAt?60*this.state.breakTimerLimit*1e3:this.state.timerLeftAt;this.breakTimer=new e(i),this.state.status="break";const o=!1===this.state.progressLeftAt?this.state.breakTimerLimit:this.state.progressLeftAt;this.breakTimer.onTime((function(t){setProgress(mapRange({from:[i,0],to:[o,0]},t.ms),t.ms),saveInDataStore()})),this.breakTimer.onDone((function(){renderTheme(r.stroke),setTimeout((function(){this.state.timerLeftAt=!1,this.state.progressLeftAt=!1,renderStatusText(s.get("work")),startWork(),t.workTimer.start()}),1e3)}))}function renderStatusText(t){document.querySelector(".status").innerText=t}function setProgress(t,e){this.state.progress=t,"work"===this.state.status?this.state.currentWorkText=convertReadableMS(e):this.state.currentBreakText=convertReadableMS(e),this.state.timerLeftAt=e,this.state.progressLeftAt=t,function renderPomodoro(){"work"===this.state.status?this.pomodoro.update(this.state.progress/this.state.workTimerLimit):this.pomodoro.update(this.state.progress/this.state.breakTimerLimit)}(),renderPomodoroText()}function renderPomodoroText(){var t=document.querySelector(".info-circle span");"work"===this.state.status?t.innerText=this.state.currentWorkText:t.innerText=this.state.currentBreakText}function renderTheme(t){this.state.themeColor=t,document.querySelector(".info-circle").style.backgroundColor=t,document.querySelector(".base-circle").style.backgroundColor=t+"2b",this.pomodoro.updateColor(t,this.state.progress),function renderButtons(){var t=this;document.querySelectorAll(".button").forEach((function(e){e.style.background=t.state.themeColor})),document.querySelectorAll(".button-label, .button-time").forEach((function(e){e.style.color=t.state.themeColor}))}()}function disableButtons(){this.state.isButtonsDisable=!0,document.querySelectorAll(".button, .button-time, .button-label").forEach((function(t){t.classList.add("disable")}))}function enableButtons(){this.state.isButtonsDisable=!1,document.querySelectorAll(".button, .button-time, .button-label").forEach((function(t){t.classList.remove("disable")}))}function updateWorkPomodoro(){this.state.currentWorkText=convertReadableMS(60*this.state.workTimerLimit*1e3),document.querySelector(".button-time.work").innerText=this.state.workTimerLimit,"work"===this.state.status&&(setProgress(this.state.progress,60*this.state.progress*1e3),startWork())}function updateBreakPomodoro(){this.state.currentBreakText=convertReadableMS(60*this.state.breakTimerLimit*1e3),document.querySelector(".button-time.break").innerText=this.state.breakTimerLimit,"break"===this.state.status&&(setProgress(this.state.progress,60*this.state.progress*1e3),startBreak())}this.state={status:"work",workTimerLimit:defaultWorkTimerLimit,breakTimerLimit:defaultBreakTimerLimit,progress:1,currentWorkText:convertReadableMS(1e3*defaultWorkTimerLimit*60),currentBreakText:convertReadableMS(1e3*defaultBreakTimerLimit*60),themeColor:"#FF0060",isButtonsDisable:!1,timerLeftAt:!1,progressLeftAt:!1},i.loadAsText((function(e,i,a){e&&console.error(e),a&&(o.state=a.state),enableButtons(),function afterDataLoad(){"work"===this.state.status?startWork():startBreak(),renderPomodoroText(),renderStatusText(s.get(this.state.status));var e=document.getElementById("pomodoro-container");this.pomodoro=new t(280,r.stroke,this.state.progress,e),this.pomodoro.draw(),"work"===this.state.status?renderTheme(r.stroke):renderTheme(r.fill)}()})),this.handlePausePlay=function(){var t=document.getElementById("play-button");"work"===this.state.status?1===this.workTimer.state?(this.workTimer.stop(),enableButtons(),t.classList.remove("pause"),t.classList.add("play")):(this.workTimer.start(),disableButtons(),t.classList.remove("play"),t.classList.add("pause")):1===this.breakTimer.state?(this.breakTimer.stop(),enableButtons(),t.classList.remove("pause"),t.classList.add("play")):(disableButtons(),this.breakTimer.start(),t.classList.remove("play"),t.classList.add("pause"))},this.handleWorkPlusClick=function(){this.state.isButtonsDisable||(this.state.workTimerLimit=this.state.workTimerLimit+1,"work"===this.state.status&&(this.state.progress+=1),updateWorkPomodoro(),saveInDataStore())},this.handleWorkMinusClick=function(){!this.state.isButtonsDisable&&this.state.workTimerLimit>1&&(this.state.workTimerLimit=this.state.workTimerLimit-1,"work"===this.state.status&&this.state.progress>1&&(this.state.progress-=1),updateWorkPomodoro(),saveInDataStore())},this.handleBreakPlusClick=function(){this.state.isButtonsDisable||(this.state.breakTimerLimit=this.state.breakTimerLimit+1,"break"===this.state.status&&(this.state.progress+=1),updateBreakPomodoro(),saveInDataStore())},this.handleBreakMinusClick=function(){!this.state.isButtonsDisable&&this.state.breakTimerLimit>1&&(this.state.breakTimerLimit=this.state.breakTimerLimit-1,"break"===this.state.status&&this.state.progress>1&&(this.state.progress-=1),updateBreakPomodoro(),saveInDataStore())},function initTimerText(){document.querySelector(".button-time.work").innerText=this.state.workTimerLimit,document.querySelector(".button-time.break").innerText=this.state.breakTimerLimit}(),document.querySelector(".plus-button.work").addEventListener("click",handleWorkPlusClick.bind(this)),document.querySelector(".minus-button.work").addEventListener("click",handleWorkMinusClick.bind(this)),document.querySelector(".plus-button.break").addEventListener("click",handleBreakPlusClick.bind(this)),document.querySelector(".minus-button.break").addEventListener("click",handleBreakMinusClick.bind(this)),document.querySelector("#play-button").addEventListener("click",(function(){o.handlePausePlay()})),document.querySelector("#replay-button").addEventListener("click",function(){(o.workTimer&&o.breakTimer?1===o.workTimer.state||1===o.breakTimer.state:o.workTimer?1===o.workTimer.state:1===o.breakTimer.state)&&this.handlePausePlay(),function resetTimer(){setProgress(1,60*this.state.workTimerLimit*1e3),this.state.timerLeftAt=!1,this.state.progressLeftAt=!1}(),startWork(),o.breakTimer&&o.breakTimer.stop(),renderTheme(r.stroke),renderStatusText(s.get("work")),o.pomodoro.update(1)}.bind(this))}