define(["events"],(function(t){function Stopwatch(t,e){return STATUS={STOPPED:0,RUNNING:1,COMPLETE:2},this.stoptime=0,this.refTime=0,this.tickTimer=0,this.almostDoneFired=!1,this.doneFired=!1,this.countDownMS=t||!1,this.ms=this.countDownMS||0,this._elapsedMS=0,this.state=STATUS.STOPPED,e||(e={}),this.refreshRateMS=e.refreshRateMS||50,this.almostDoneMS=e.almostDoneMS||1e4,this.reset(t),this}return t=t.EventEmitter,Stopwatch.prototype={start:function(){this.tickTimer&&clearInterval(this.tickTimer),this.state=STATUS.RUNNING,this.refTime=(new Date).getTime(),this.refTime-=this._elapsedMS;var t=this;this.tickTimer=setInterval((function(){t._updateTime()}),this.refreshRateMS),this._updateTime(this)},stop:function(){this.tickTimer&&clearInterval(this.tickTimer),this.state===STATUS.RUNNING&&(this.state=STATUS.STOPPED,this._updateTime(this),this.emit("stop"),this.emit("forcestop"))},reset:function(t){this.stop(),this.state=STATUS.STOPPED,this.doneFired=!1,this.almostDoneFired=!1,this._elapsedMS=0,this.refTime=(new Date).getTime(),t&&(this.countDownMS=t),this.ms=this.countDownMS||0,this.emit("time",{ms:this.ms})},startstop:function(){return this.state===STATUS.STOPPED?(this.start(),!0):(this.stop(),!1)},_updateTime:function(){var t=this;t.countDownMS>0?t._timerCountdown(t):t._stopwatchCountup(t)},_timerCountdown:function(){var t=this,e=(new Date).getTime();t._elapsedMS=e-t.refTime;var i=t.countDownMS-t._elapsedMS;i<0&&(i=0),t.ms=i,t.emit("time",{ms:t.ms}),i<=0?(t.stop(),t.doneFired||(t.doneFired=!0,t.state=STATUS.COMPLETE,t.emit("done"))):i<t.almostDoneMS&&(t.almostDoneFired||(t.almostDoneFired=!0,t.emit("almostdone")))},_stopwatchCountup:function(){var t=this,e=(new Date).getTime();t._elapsedMS=e-t.refTime,t.ms=t._elapsedMS,t.emit("time",{ms:t.ms})},onDone:function(t){return this.on("done",t),this},onAlmostDone:function(t){return this.on("almostDone",t),this},onTime:function(t){return this.on("time",t),this},onStop:function(t){return this.on("stop",t),this}},Object.assign(Stopwatch.prototype,t.prototype),Stopwatch}));