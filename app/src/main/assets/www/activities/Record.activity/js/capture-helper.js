define(["activity/recordrtc","sugar-web/activity/activity","sugar-web/datastore","activity/gif-recorder"],(function(e,t,n,d){var o={ids:[],by:"by",popupMode:!1,width:320,height:240,displayLoading:function(){var e=document.getElementById("loading");e.style.top=parseInt(5*document.body.clientHeight/100)+"px",e.style.left=parseInt(5*document.body.clientWidth/100)+"px",e.style.width=parseInt(90*document.body.clientWidth/100)+"px",e.style.padding="10px",e.style.display="block"},hideLoading:function(){document.getElementById("loading").style.display="none"},displayAllData:function(e){for(var t=0;t<e.length;t++)this.displayData(e[t])},forgeAndInsertData:function(e){var d=this;this.insertData(e,(function(e,r){var a=null,s=n.find(),l=!1;for(i=0;i<s.length;i++)if(s[i].objectId==r){l=!0,a=s[i];break}l?(d.ids.push(r),t.getDatastoreObject().setDataAsText(JSON.stringify({ids:d.ids})),t.getDatastoreObject().save((function(e){})),new n.DatastoreObject(a.objectId).loadAsText((function(e,t,i){a.text=i,o.displayData(a,!0)}))):function displayAlertMessage(e){var t=document.createElement("p");t.innerHTML=e,t.style.color="#f00",t.style.position="fixed",t.style.top="0px",t.style.width="auto",t.style.padding="4px",t.style.fontSize="42px",t.style.background="#fff",document.body.appendChild(t),t.style.left=document.body.clientWidth/2-t.getBoundingClientRect().width/2+"px",setTimeout((function(){t.parentNode.removeChild(t)}),3e3)}("No more space<br/><div style='text-align: center;'><img src='icons/emblem-warning.svg'></div>")}))},deleteRecord:function(e,i){var n=this;e.parentNode.removeChild(e),n.ids.splice(n.ids.indexOf(i),1),t.getDatastoreObject().setDataAsText(JSON.stringify({ids:n.ids})),t.getDatastoreObject().save((function(e){}))},generateAudioPopup:function(e,t,i){var n=document.createElement("audio");return n.src=e.data,n.style.padding="0px",n.style.zIndex="98",n.setAttribute("controls",""),n.style.width="100%",n.style.height="100px",n.style.paddingBottom="100px",this.generatePopup(e,n,t,i)},generateVideoPopup:function(e,t,i){var n=document.createElement("video");return n.src=e.data,n.style.padding="0px",n.style.zIndex="98",n.setAttribute("controls",""),n.style.width="100%",n.style.maxHeight=90*document.body.clientHeight/100+"px",n.style.maxWidth=90*document.body.clientWidth/100+"px",n.style.paddingBottom="60px",this.generatePopup(e,n,t,i)},generateImagePopup:function(e,t,i,n){var d=document.createElement("img");return d.style.backgroundImage="url('"+e.data+"')",d.style.backgroundRepeat="no-repeat",d.style.backgroundPosition="center center",d.style.padding="0px",d.style.zIndex="98",d.style.margin="auto",d.style.display="block",d.style.width="100%",d.style.maxHeight=90*document.body.clientHeight/100+"px",d.style.maxWidth=90*document.body.clientWidth/100+"px",d.style.backgroundSize="contain",d.setAttribute("height",d.style.maxHeight),d.setAttribute("width",d.style.maxWidth),this.generatePopup(e,d,t,i,n)},generatePopup:function(e,t,i,n,d){var o=this;void 0===d&&(d=i);var r=document.createElement("div");r.style.position="fixed",r.style.background="#000",r.style.zIndex="97",r.style.minHeight="42px",r.style.top=0,r.style.bottom=0,r.style.left=0,r.style.right=0,r.style.margin="auto",r.style.width=parseInt(80*document.body.clientWidth/100)+"px";var a=document.createElement("span");a.style.zIndex="98",a.style.padding="5px",a.style.position="absolute",a.innerHTML=n.title,a.style.background="#000",a.style.color="#fff",a.style.fontSize="26px",r.appendChild(a),r.appendChild(t);var s=document.createElement("button");s.style.position="absolute",s.style.zIndex="99",s.style.borderRadius="0px",s.style.float="right",s.style.backgroundImage="url(icons/close.svg)",s.style.backgroundRepeat="no-repeat",s.style.backgroundPosition="center center",s.style.width="42px",s.style.height="42px",s.style.top="0px",s.style.right="0px",s.addEventListener("click",(function(){r.parentNode.removeChild(r),o.popupMode=!1})),r.appendChild(s);var l=document.createElement("button");return l.style.display="inline-block",l.style.float="left",l.style.position="absolute",l.zIndex="99",l.className="delbtn",l.style.background="url('icons/delete.svg')",l.onclick=function(e){o.deleteRecord(d,n),r.parentNode.removeChild(r),o.popupMode=!1},r.appendChild(l),r},displayImage:function(e,t,i){var n=this,d=document.createElement("div");d.style.border="1px solid #000",d.style.marginLeft="5px",d.style.marginTop="5px",d.style.width=this.width+"px",d.style.height=this.height+"px",d.style.display="inline-block";var o=document.createElement("div");o.style.display="inline-block",o.style.border="1px solid #000",o.zIndex="98",o.style.position="absolute",o.style.width=this.width+"px",o.style.height=this.height+"px",o.style.backgroundImage="url('"+e.data+"')",o.style.backgroundRepeat="no-repeat",o.style.backgroundPosition="center",o.style.backgroundSize="contain",d.appendChild(o);var r=document.createElement("img");r.style.display="inline-block",r.style.float="left",r.style.position="absolute",r.zIndex="99",r.style.width=this.width+"px",r.style.height=this.height+"px",r.src="icons/photo.svg",d.appendChild(r),t&&this.records.childNodes&&this.records.childNodes.length>0?this.records.insertBefore(d,this.records.firstChild):this.records.appendChild(d),d.addEventListener("click",(function(){if(!n.popupMode){n.popupMode=!0;var t=n.generateImagePopup(e,o,i,d);document.body.appendChild(t)}}))},displayVideo:function(e,t,i){var n=this,d=document.createElement("div");d.style.border="1px solid #000",d.style.marginLeft="5px",d.style.marginTop="5px",d.style.width=this.width+"px",d.style.height=this.height+"px",d.style.display="inline-block";var o=document.createElement("video");o.style.width=this.width+"px",o.style.height=this.height+"px",o.style.float="left",o.zIndex="98",o.style.position="absolute",o.src=e.data,o.style.display="inline-block",d.appendChild(o);var r=document.createElement("img");r.style.display="inline-block",r.style.float="left",r.style.position="absolute",r.zIndex="99",r.style.width=this.width+"px",r.style.height=this.height+"px",r.src="icons/video.svg",d.appendChild(r),t&&this.records.childNodes&&this.records.childNodes.length>0?this.records.insertBefore(d,this.records.firstChild):this.records.appendChild(d),d.addEventListener("click",(function(){if(!n.popupMode){n.popupMode=!0;var t=n.generateVideoPopup(e,d,i);document.body.appendChild(t)}}))},displayAudio:function(e,t,i){var n=this,d=document.createElement("div");d.style.border="1px solid #000",d.style.marginLeft="5px",d.style.display="inline-block",d.style.marginTop="5px",d.style.width=this.width+"px",d.style.height=this.height+"px",d.style.background="#000";var o=document.createElement("img");o.src="icons/audio.svg",o.style.width=this.width+"px",o.style.height=this.height+"px",o.style.display="inline-block",d.appendChild(o),t&&this.records.childNodes&&this.records.childNodes.length>0?this.records.insertBefore(d,this.records.firstChild):this.records.appendChild(d),d.addEventListener("click",(function(){if(!n.popupMode){n.popupMode=!0;var t=n.generateAudioPopup(e,d,i);document.body.appendChild(t)}}))},displayData:function(e,t){var i={id:e.objectId,data:e.text};0===e.metadata.mimetype.indexOf("audio")&&this.displayAudio(i,t,e.metadata),0===e.metadata.mimetype.indexOf("video")&&this.displayVideo(i,t,e.metadata),0===e.metadata.mimetype.indexOf("image")&&this.displayImage(i,t,e.metadata)},getData:function(e,t){for(var i=n.find(),d=[],o=[],r=0;r<i.length;r++){var a=i[r];if(a.metadata&&a.metadata.mimetype&&!(e.indexOf(a.objectId)<0)){var s=a.metadata.mimetype;0!==s.indexOf("audio")&&0!==s.indexOf("video")&&0!==s.indexOf("image")||d.push(a.objectId)}}var l=d.length;for(r=0;r<d.length;r++){new n.DatastoreObject(d[r]).loadAsText((function(e,i,n){o.push({metadata:i,text:n}),t&&0==--l&&t(o.reverse())}))}},helper:void 0,getMimetypeWithData:function(e){return e.split(";")[0].split(":")[1]},insertData:function(e,t){var i=this.getMimetypeWithData(e),d=i.split("/")[0],r={mimetype:i,title:d.charAt(0).toUpperCase()+d.slice(1)+" "+o.by+" "+o.buddy_name.charAt(0).toUpperCase()+o.buddy_name.slice(1),activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};n.create(r,t,e)},isCordova:function(){return!(!window.cordova&&!window.PhoneGap)},init:function(){var e=document.body.clientWidth/160;this.width=document.body.clientWidth/e-10,this.height=240*this.width/320,this.records=document.getElementById("records"),this.isCordova()?this.helper=a:(this.helper=r,this.helper.timerStart=document.getElementById("timer-start"),this.helper.timerEnd=document.getElementById("timer-end"),this.loadingStop=document.getElementById("loading-stop"),this.loadingStop.addEventListener("click",(function(){r.currentRecording&&r.currentRecording.maxTime&&(r.currentRecording.time=r.currentRecording.maxTime)}))),this.helper.init()}},r={recording:!1,currentRecording:{},recordAudio:function(){if(!this.recording){this.recording=!0;var e=this;document.getElementById("loading-stop").style.display="block",e.timerStart.style.display="inline-block",e.timerEnd.style.display="inline-block",document.getElementById("loading-progress").style.display="inline-block",o.displayLoading();try{navigator.mediaDevices.getUserMedia({audio:!0}).then((function(t){var i=RecordRTC(t,{type:"audio"});i.startRecording();e.currentRecording.time=0;var n=document.getElementById("loading-progress");e.currentRecording.maxTime=5,n.setAttribute("max",5..toString()),e.timerEnd.innerHTML=5..toString()+"s",e.timerStart.innerHTML="0s",e.currentRecording.interval=setInterval((function(){e.currentRecording.time++,(n=document.getElementById("loading-progress")).value=e.currentRecording.time,e.currentRecording.time<=5&&(e.timerStart.innerHTML=e.currentRecording.time+"s"),e.currentRecording.time>e.currentRecording.maxTime&&(e.timerStart.innerHTML="",e.timerEnd.innerHTML="",document.getElementById("loading-progress").value=0,clearInterval(e.currentRecording.interval),i.stopRecording((function(){i.getDataURL((function(i){setTimeout((function(){o.forgeAndInsertData(i),t.stop&&t.stop(),e.recording=!1,o.hideLoading()}),500)}),!1)})))}),1e3)})).catch((function(t){e.recording=!1,o.hideLoading()}))}catch(t){e.recording=!1,o.hideLoading()}}},recordVideo:function(){if(!this.recording){this.recording=!0;var e=this;document.getElementById("loading-stop").style.display="block",e.timerStart.style.display="inline-block",e.timerEnd.style.display="inline-block",document.getElementById("loading-progress").style.display="inline-block",o.displayLoading();try{navigator.mediaDevices.getUserMedia({video:!0}).then((function(t){var i=RecordRTC(t,{type:"video",mimeType:"video/webm;codecs=vp8",frameRate:80,quality:0});document.querySelector("#vidDisplay").srcObject=t,i.startRecording();e.currentRecording.time=0;var n=document.getElementById("loading-progress");e.currentRecording.maxTime=15,e.timerEnd.innerHTML=15..toString()+"s",n.setAttribute("max",15..toString()),e.timerStart.innerHTML="0s",e.currentRecording.interval=setInterval((function(){e.currentRecording.time++,(n=document.getElementById("loading-progress")).value=e.currentRecording.time,e.currentRecording.time<=15&&(e.timerStart.innerHTML=e.currentRecording.time+"s"),e.currentRecording.time>e.currentRecording.maxTime&&(e.timerStart.innerHTML="",e.timerEnd.innerHTML="",document.getElementById("loading-progress").value=0,clearInterval(e.currentRecording.interval),i.stopRecording((function(){i.getDataURL((function(i){setTimeout((function(){o.forgeAndInsertData(i),t.stop&&t.stop(),e.recording=!1,o.hideLoading()}),500)}),!1)})))}),1e3)})).catch((function(t){e.recording=!1,o.hideLoading()}))}catch(t){e.recording=!1,o.hideLoading()}}},takePicture:function(){if(!this.recording){this.recording=!0;var e=this;e.timerStart.style.display="none",e.timerEnd.style.display="none",document.getElementById("loading-stop").style.display="none",document.getElementById("loading-progress").style.display="none";document.createElement("video");try{o.displayLoading(),navigator.mediaDevices.getUserMedia({video:!0}).then((function(t){document.querySelector("#vidDisplay").srcObject=t,setTimeout((function(){var i=document.createElement("canvas");i.width=320,i.height=240,i.getContext("2d").drawImage(document.querySelector("#vidDisplay"),0,0,320,240);var n=i.toDataURL("image/png");o.forgeAndInsertData(n),t.stop&&t.stop(),e.recording=!1,o.hideLoading()}),2700)})).catch((function(t){e.recording=!1,o.hideLoading()}))}catch(t){e.recording=!1,o.hideLoading()}}},init:function(){}},a={cordovaLoaded:!1,fileSystem:null,takePicture:function(){navigator.camera.getPicture((function(e){var t="data:image/jpeg;base64,"+e;o.forgeAndInsertData(t)}),(function(e){}),{quality:50,targetWidth:640,targetHeight:480,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA})},recordAudio:function(){try{navigator.device.capture.captureAudio((function(e){var t,i,n;for(t=0,n=e.length;t<n;t+=1)-1==(i=e[t].fullPath).indexOf("file:/")&&(i="file:/"+i),i=i.replace("file:/","file:///"),window.resolveLocalFileSystemURL(i,(function(e){e.file((function(e){var t=new FileReader;t.onloadend=function(e){o.forgeAndInsertData(e.target.result)},t.readAsDataURL(e)}),(function(e){}))}),(function(e){}))}),(function(e){}),{limit:1})}catch(e){}},recordVideo:function(){try{navigator.device.capture.captureVideo((function(e){var t,i,n;for(t=0,n=e.length;t<n;t+=1)-1==(i=e[t].fullPath).indexOf("file:/")&&(i="file:/"+i),i=i.replace("file:/","file:///"),window.resolveLocalFileSystemURL(i,(function(e){e.file((function(e){var t=new FileReader;t.onloadend=function(e){o.forgeAndInsertData(e.target.result)},t.readAsDataURL(e)}),(function(e){}))}),(function(e){}))}),(function(e){}),{limit:1,quality:0,duration:15,width:o.width,height:o.height})}catch(e){}},onDeviceReady:function(){o.helper.cordovaLoaded=!0},init:function(){document.addEventListener("deviceready",this.onDeviceReady,!1)}};return o}));