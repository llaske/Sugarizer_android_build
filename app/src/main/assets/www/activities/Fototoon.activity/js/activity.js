define(["sugar-web/activity/activity","sugar-web/datastore","sugar-web/env","textpalette","sugar-web/graphics/menupalette","sugar-web/graphics/journalchooser","lzstring","l10n","toon","tutorial","picoModal"],(function(t,e,n,i,a,o,l,s,r,d,c){var g;function _(t){return translation=s.get(t),""==translation&&(translation=t),translation}n.getEnvironment((function(t,e){var n="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language;g=e.user?e.user.language:n,s.init(g),console.log("LANG "+g)})),requirejs(["domReady!"],(function(u){t.setup();var m=document.getElementById("mainCanvas"),v=document.getElementById("sortCanvas");m.height=window.innerHeight-75-5,m.width=4*m.height/3,m.style.left=(window.innerWidth-m.width)/2+"px";var h=document.getElementById("previous-button");h.title=_("Previous"),h.addEventListener("click",(function(t){x.showPreviousBox()}));var b=document.getElementById("next-button");b.title=_("Next"),b.addEventListener("click",(function(t){x.showNextBox()}));var w=document.getElementById("text-button");w.title=_("EditText");var p=new i.TextPalette(w,x,_("SetGlobeText")),f=document.getElementById("page-counter"),x=new r.Model({version:"1",boxs:[{globes:[]}]},m,p);x.init(),x.attachPageCounterViewer(f),x.attachPrevNextButtons(h,b);var E=!0,y=document.getElementById("add-globe");y.title=_("AddAglobe");for(var I=[{icon:!0,id:r.TYPE_GLOBE,label:_("Globe")},{icon:!0,id:r.TYPE_EXCLAMATION,label:_("Exclamation")},{icon:!0,id:r.TYPE_WHISPER,label:_("Whisper")},{icon:!0,id:r.TYPE_CLOUD,label:_("Think")},{icon:!0,id:r.TYPE_RECTANGLE,label:_("Box")}],B=new a.MenuPalette(y,_("AddAglobe"),I),T=0;T<B.buttons.length;T++)B.buttons[T].addEventListener("click",(function(t){x.addGlobe(this.id)}));var L=document.getElementById("add-button");L.title=_("Add"),L.addEventListener("click",(function(t){o.show((function(t){t&&new e.DatastoreObject(t.objectId).loadAsText((function(e,n,i){var a=document.createElement("img");"org.olpcfrance.PaintActivity"==t.metadata.activity?a.src=l.decompressFromUTF16(JSON.parse(i).src):a.src=i,a.onload=function(){x.addImage(a.src)}}))}),{mimetype:"image/png"},{mimetype:"image/jpeg"},{activity:"org.olpcfrance.PaintActivity"})})),n.getEnvironment((function(e,n){n.objectId&&t.getDatastoreObject().loadAsText((function(t,e,n){if(null==t&&null!=n){var i=JSON.parse(n),a=i.dataWithoutImages,o=i.dataImages;for(var l in a.images={},o){var s=l;a.images[s]=LZString.decompressFromUTF16(o[s])}x.setData(a),E||(x.changeToEditMode(),E=!0)}}))})),document.getElementById("stop-button").addEventListener("click",(function(e){console.log("writing..."),x.showWait(),E||(x.finishSort(),x.init(),E=!0);var n={};for(var i in n.version=x.getData().version,n.boxs=x.getData().boxs,dataImages={},x.getData().images){var a=i;console.log("saving image "+a),dataImages[a]=LZString.compressToUTF16(x.getData().images[a])}var o={dataWithoutImages:n,dataImages:dataImages};x.hideWait();var l=JSON.stringify(o);t.getDatastoreObject().setDataAsText(l),t.getDatastoreObject().save((function(t){null===t?console.log("write done."):console.log("write failed.")}))}));var A=document.getElementById("image-save");A.title=_("SaveAsImage");var C=[{id:"0",label:_("OneRow")},{id:"1",label:_("OneColumn")},{id:"2",label:_("TwoColumns")}],P=new a.MenuPalette(A,_("SaveAsImage"),C);for(T=0;T<P.buttons.length;T++)P.buttons[T].addEventListener("click",(function(t){x.saveAsImage(this.id)}));var S=document.getElementById("sort-button");S.title=_("Sort"),x.attachSortButton(S),S.addEventListener("click",(function(t){if(!(x.getData().boxs.length<3)){if(x.showWait(),E){x.initPreviews(),v.width=window.innerWidth-150;var e=v.width/x.getData().boxs.length;v.height=3*e/4,v.style.left=(window.innerWidth-v.width)/2+"px",v.style.top=(window.innerHeight-v.height)/2+"px",x.initSort(v)}else x.finishSort(),x.init();x.hideWait(),E=!E}}));var k=document.getElementById("clean-all-button");k.title=_("Clean");var D=_("CancelChanges"),O=_("Continue"),W=_("CleanAllMessage"),j=_("Warning");k.addEventListener("click",(function(t){E&&c({content:"<div style = 'width:400px;margin-bottom:60px'><div style='width:50px;float:left'><img src='icons/emblem-warning.svg' style='padding:10px;height:40px;'></div><div style='width:300px;float:left;margin-left:20px;'><div style='color:white;margin-top:10px;'><b>"+j+"</b></div><div style='color:white;margin-top:2px;'>"+W+"</div></div></div><div><button class='cancel-changes warningbox-cancel-button'><img  src='icons/dialog-cancel.svg' style='width: 20px; height: 16px;margin-right:5px;'> "+D+"</button> <button class='continue warningbox-refresh-button'><img src='icons/dialog-ok.svg' style='width: 20px; height: 16px;margin-right:5px;'> "+O+"</button></div>",closeButton:!1,modalStyles:{backgroundColor:"#000000",height:"120px",width:"60%",textColor:"white"}}).afterCreate((function(t){t.modalElem().addEventListener("click",(function(e){e.target&&e.target.matches(".continue")?(x._data.boxs.splice(1,x._data.boxs.length-1),x._data.boxs[0].globes=[],x._data.previews=[],x.init(),t.close()):e.target&&e.target.matches(".cancel-changes")&&t.close()}))})).show()})),document.getElementById("help-button").addEventListener("click",(function(t){s.init(g);var e=1;window.addEventListener("localized",(function(){e&&(e=0,d.start(g))}))}))}))}));