define(["easel","sugar-web/datastore","sugar-web/env","l10n","humane"],(function(t,i,e,s,h){function _(t){return translation=s.get(t),""==translation&&(translation=t),translation}e.getEnvironment((function(t,i){var e="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,h=i.user?i.user.language:e;s.init(h),console.log("LANG "+h)}));/Android/i.test(navigator.userAgent),window.innerWidth<700||window.innerHeight;var a=3,o="#000000",n="#ffffff",l="abajo",c="arriba",d="izq",p="der",u="normal",m="despacio",x=40,v="GLOBE",w="CLOUD",C="EXCLAMATION",f="RECTANGLE",y="WHISPER",B=14;function createAsyncBitmapButton(t,i,e){var s=new Image;return s.cont=null,s.globe=t,s.onload=function(){var t=new createjs.Bitmap(s);t.setBounds(0,0,s.width,s.height),bounds=t.getBounds();var i=x/bounds.height;if(t.scaleX=i,t.scaleY=i,null==this.cont){this.cont=new createjs.Container,this.cont.name="button";var h=new createjs.Shape;h.graphics.beginFill("#000").drawRect(0,0,x,x),this.cont.width=x,this.cont.height=x,this.cont.hitArea=h,this.cont.addChild(h),this.cont.addChild(t),e(this.globe,this.cont)}},s.src=i,s}function ComicBox(t,i){this.canvas=t,this._model=i,this._width=t.width-2*a,this._height=t.height-2*a,this.stage=new createjs.Stage(t),createjs.Touch.enable(this.stage),this.globes=[],this._globeSelected=null,this._textpalette=null,this.init=function(i,e,s,h,n){this._data=i,this.imagesData=e,this.canRemove=s,this.globes=[],this.stage.removeAllChildren(),this._backContainer=new createjs.Container;var r=new createjs.Shape;r.graphics.setStrokeStyle(a,"round"),r.graphics.beginStroke(o).drawRect(a,a,this._width,this._height),this.stage.addChild(this._backContainer),this._backContainer.addChild(r),this._backContainer.cache(0,0,this.canvas.width,this.canvas.height),null!=this._data&&(""!=this._data.image_name&&null!=this._data.image_name?(this._image_x=this._data.img_x,this._image_y=this._data.img_y,this._image_width=this._data.img_w,this._image_height=this._data.img_h,this._image_name=this._data.image_name,this._slideshow_duration=this._data.slideshow_duration,null!=this.imagesData&&this._setBackgroundImageDataUrl(this.imagesData[this._image_name],h,n)):(this._image_x=0,this._image_y=0,this._image_width=t.width,this._image_height=t.height,this._image_name="",this._slideshow_duration=10,this.createGlobes(),n&&n(h))),this.stage.update()},this._setBackgroundImageDataUrl=function(t,i,e){this._image_x=0,this._image_y=0,this._image_width=this._width,this._image_height=this._height;var s=new Image,h=this;s.addEventListener("load",(function(){bitmap=new createjs.Bitmap(s),bitmap.setBounds(0,0,s.width,s.height);var t=h._width/s.width,o=h._height/s.height,n=Math.min(t,o);bitmap.mouseEnabled=!1,bitmap.x=a,bitmap.y=a,bitmap.scaleX=n,bitmap.scaleY=n,h._backContainer.addChildAt(bitmap,0),h.canRemove?createAsyncBitmapButton(h,"./icons/remove.svg",(function(t,i){i.x=0,i.y=t._height-i.height,i.visible=!0,t._removeButton=i,t._backContainer.addChildAt(i,1),t._backContainer.updateCache(),i.on("click",(function(i){t.remove()})),t.createGlobes()})):(h._backContainer.updateCache(),h.createGlobes()),e&&e(i)})),s.src=t},this.remove=function(){console.log("remove"),this._model.removeBox()},this.attachTextEditionPalette=function(t){this._textpalette=t;var i=this;this._textpalette.editorElem.addEventListener("input",(function(){null!=i.getSelectedGlobe()&&i.getSelectedGlobe().getTextViewer().setText(this.value)}),!1);for(var e=this._textpalette.editorElem,s=this._textpalette.colorButtons,h=0;h<s.length;h++)s[h].addEventListener("click",(function(t){e.style.color=i.getSelectedGlobe().getTextViewer().setColor(this.value)}));this._textpalette.incTextBtn.addEventListener("click",(function(t){e.style.fontSize=i.getSelectedGlobe().getTextViewer().incSize()+"px"})),this._textpalette.decTextBtn.addEventListener("click",(function(t){e.style.fontSize=i.getSelectedGlobe().getTextViewer().decSize()+"px"})),this._textpalette.boldTextBtn.addEventListener("click",(function(t){i.getSelectedGlobe().getTextViewer().toggleBold()?(e.style.fontWeight="bold",document.getElementById("text-set-bold").style.backgroundColor="grey"):(e.style.fontWeight="normal",document.getElementById("text-set-bold").style.backgroundColor="")})),this._textpalette.italicTextBtn.addEventListener("click",(function(t){i.getSelectedGlobe().getTextViewer().toggleItalic()?(e.style.fontStyle="italic",document.getElementById("text-set-italic").style.backgroundColor="grey"):(e.style.fontStyle="normal",document.getElementById("text-set-italic").style.backgroundColor="")}))},this.popupTextEditionPalette=function(){null!=this._textpalette&&(this._textpalette.popUp(),this._textpalette.editorElem.focus())},this.getSelectedGlobe=function(){return this._globeSelected},this.isGlobeSelected=function(t){return this._globeSelected==t},this.selectGlobe=function(t){this._globeSelected=t;var i=this._textpalette;this.globes.forEach((function(e,s,h){e!=t?e.setSelected(!1):null!=i&&(i.setText(e.getTextViewer().getText()),e.getTextViewer().applyTextProperties(i.editorElem))}))},this.addGlobe=function(t){globeData={globe_type:t,x:100,y:100,width:100,height:50,point_0:50,point_1:25,radio:100,direction:l,mode:u},t==y&&(globeData.globe_type=v,globeData.mode=m);var i=new Globe(this,globeData);this.globes.push(i),this.stage.update()},this.getJson=function(){jsonData={},jsonData.img_x=this._image_x,jsonData.img_y=this._image_y,jsonData.img_w=this._image_width,jsonData.img_h=this._image_height,jsonData.image_name=this._image_name,jsonData.slideshow_duration=this._slideshow_duration,jsonData.globes=[];for(var t=0;t<this.globes.length;t++)globe=this.globes[t],globeData={},globeData.globe_type=globe._type,globeData.x=globe._x,globeData.y=globe._y,globeData.width=globe._width,globeData.height=globe._height,globe._type!=f&&(globeData.point_0=globe._point[0],globeData.point_1=globe._point[1]),globe._type==v&&(globeData.mode=globe._mode),globeData.radio=globe._radio,globeData.direction=globe._direction,globeData.title_globe=globe._isTitleGlobe,globeData.text_text=globe._textViewer.getText(),globeData.text_font_description=globe._textViewer.getCairoFontFormat(),globeData.text_color=globe._textViewer.HtmlToGdkColor(globe._textViewer._color),globeData.text_width=globe._textViewer._width,globeData.text_height=globe._textViewer._height,jsonData.globes.push(globeData);return jsonData},this.createGlobes=function(){for(var t=this._data.globes,i=0;i<t.length;i++){var e=new Globe(this,t[i]);this.globes.push(e)}this.stage.update()}}function TextViewer(t,i){return this._globe=t,this._globeData=i,this.init=function(){this._text="",this._color=o,this._width=t._width-20,this._height=x/2,this._size=B,this._bold=!1,this._italic=!1,null!=this._globeData&&(null!=this._globeData.text_text&&(this._text=this._globeData.text_text),null!=this._globeData.text_font_description&&this.ReadHtmlFontFormat(this._globeData.text_font_description),null!=this._globeData.text_color&&(this._color=this.GdkToHtmlColor(this._globeData.text_color)),null!=this._globeData.text_width&&(this._width=this._globeData.text_width),null!=this._globeData.text_height&&(this._height=this._globeData.text_height),this._textView=null)},this.GdkToHtmlColor=function(t){return rh=(t[0]/65535*255).toString(16),gh=(t[1]/65535*255).toString(16),bh=(t[2]/65535*255).toString(16),rh.length<2&&(rh="0"+rh),gh.length<2&&(gh="0"+gh),bh.length<2&&(bh="0"+bh),"#"+rh+gh+bh},this.HtmlToGdkColor=function(t){return rh=t.substr(1,2),gh=t.substr(3,2),bh=t.substr(5,2),r=parseInt(rh,16)/255*65535,g=parseInt(gh,16)/255*65535,b=parseInt(bh,16)/255*65535,[r,g,b]},this.ReadHtmlFontFormat=function(t){var i=t.split(" "),e=i[0];2==i.length?(size=i[1],style=""):3==i.length?(style=i[1]+" ",size=i[2]):(style=i[1]+" "+i[2]+" ",size=i[3]),this._size=Number(size),this._family=e,this._bold=style.toLowerCase().indexOf("bold")>-1,this._italic=style.toLowerCase().indexOf("italic")>-1},this.getCairoFontFormat=function(){var t=this._family;return this._bold&&(t+=" bold"),this._italic&&(t+=" italic"),t+" "+this._size},this.getFontDescription=function(){var t="";return this._bold&&(t+=" bold"),this._italic&&(t+=" italic"),t+" "+this._size+"px "+this._family},this.update=function(){null!=this._textView&&this._globe._stage.removeChild(this._textView),this._textView=new createjs.Text(this._text,this.getFontDescription(),this._color),this._textView.textAlign="center",this._textView.lineWidth=2*this._globe._width,this._textView.x=this._globe._x,this._textView.y=this._globe._y-this._textView.getMeasuredHeight()/2,this._globe._stage.addChild(this._textView),this._globe._stage.update()},this.getText=function(){return this._text},this.setText=function(t){this._text=t,this.update()},this.setColor=function(t){for(var i=document.getElementsByClassName("color-picker"),e=0;e<=9;e++)i[e].value==this._color&&(i[e].style.border="2px solid white"),i[e].value==t&&(i[e].style.border="5px solid #696969");return this._color=t,this.update(),this._color},this.incSize=function(){return this._size<60&&(this._size=this._size+Math.round(this._size/4),this.update()),this._size},this.decSize=function(){return this._size>10&&(this._size=this._size-Math.round(this._size/4),this.update()),this._size},this.toggleBold=function(){return this._bold=!this._bold,this.update(),this._bold},this.toggleItalic=function(){return this._italic=!this._italic,this.update(),this._italic},this.applyTextProperties=function(t){t.style.fontSize=this._size+"px",t.style.color=this._color;for(var i=document.getElementsByClassName("color-picker"),e=0;e<=9;e++)i[e].value==this._color?i[e].style.border="5px solid #696969":i[e].style.border="2px solid white";this._italic?(t.style.fontStyle="italic",document.getElementById("text-set-italic").style.backgroundColor="grey"):(t.style.fontStyle="normal",document.getElementById("text-set-italic").style.backgroundColor=""),this._bold?(t.style.fontWeight="bold",document.getElementById("text-set-bold").style.backgroundColor="grey"):(t.style.fontWeight="normal",document.getElementById("text-set-bold").style.backgroundColor="")},this.remove=function(){this._globe._stage.removeChild(this._textView)},this.init(),this}function Globe(t,i){this._box=t,this._stage=t.stage,this._shapeControls=null,this._pointerControl=null,this._resizeButton=null,this._editButton=null,this._rotateButton=null,this._removeButton=null,this._shapeChanged=!0,this._pointerChanged=!0,this.init=function(){null==i?(this._type=v,this._x=100,this._y=100,this._width=100,this._height=50,this._point=[this._width/2,this._height/2],this._radio=100,this._direction=l,this._textViewer=new TextViewer(this,null),this._mode=u,this._isTitleGlobe=!1):(this._type=i.globe_type,this._x=i.x,this._y=i.y,this._width=i.width,this._height=i.height,this._type!=f?this._point=[i.point_0,i.point_1]:this._point=[0,0],this._type==v?this._mode=i.mode:this._mode=u,this._radio=i.radio,this._direction=i.direction,this._textViewer=new TextViewer(this,i),this._isTitleGlobe=i.title_globe),this._shape=null},this.createShape=function(){null!=this._shape&&(this._stage.removeChild(this._shape),this._type==w&&this._stage.removeChild(this._shapeCircles));var t=this._width/this._radio,i=this._height/this._radio,e=this._x/t,s=this._y/i;this._type==w?this.createShapeCloud(e,s,t,i):this._type==C?this.createShapeExclamation(e,s,t,i):this._type==f?this.createShapeRectangle():this.createShapeGlobe(e,s,t,i),this._shape.on("click",(function(t){this.setSelected(!0)}),this),this._shape.on("pressmove",(function(t){this._x=t.stageX,this._y=t.stageY,this.setSelected(!0),this.update()}),this)},this.getSelected=function(){return this._box.isGlobeSelected(this)},this.setSelected=function(t){t?(this._box.selectGlobe(this),this._shapeControls.visible=!0,this._type!=f&&(this._pointerControl.visible=!0,this._rotateButton.visible=!0),this._resizeButton.visible=!0,this._editButton.visible=!0,this._isTitleGlobe||(this._removeButton.visible=!0)):(this._shapeControls.visible=!1,this._type!=f&&(this._pointerControl.visible=!1,this._rotateButton.visible=!1),this._resizeButton.visible=!1,this._editButton.visible=!1,this._isTitleGlobe||(this._removeButton.visible=!1)),this._stage.update()},this.getTextViewer=function(){return this._textViewer},this.createShapeGlobe=function(t,i,e,s){switch(this._direction){case l:var h=100,r=80;break;case p:h=10,r=350;break;case d:h=190,r=170;break;case c:h=280,r=260}this._shape=new createjs.Shape,this._shape.name="globe",this._stage.addChild(this._shape),this._shape.graphics.setStrokeStyle(a,"round",null,null,!0),this._shape.graphics.beginStroke(o),this._shape.graphics.beginFill(n),this._mode==m&&this._shape.graphics.setStrokeDash([3]),this._shape.graphics.arc(t,i,this._radio,h/180*Math.PI,r/180*Math.PI),point_pos=this.getPointPosition(!0),this._shape.graphics.lineTo(point_pos[0],point_pos[1]),this._shape.graphics.closePath(),this._shape.graphics.endStroke(),this._shape.setTransform(0,0,e,s)},this.createShapeRectangle=function(){var t=this._x,i=this._y,e=this._width,s=this._height;this._shape=new createjs.Shape,this._shape.name="rect",this._stage.addChild(this._shape),this._shape.graphics.setStrokeStyle(a,"round",null,null,!0),this._shape.graphics.beginStroke(o),this._shape.graphics.beginFill(n),this._shape.graphics.rect(t-e,i-s,2*e,2*s),this._shape.graphics.endStroke()},this.createShapeCloud=function(t,i,e,s){this._shape=new createjs.Shape,this._shape.name="cloud",this._stage.addChild(this._shape),this._shape.graphics.setStrokeStyle(a,"round",null,null,!0),this._shape.graphics.beginStroke(o),this._shape.graphics.beginFill(n);for(var h=this._width/e,r=this._height/s,l=0,c=0;c<36;c++){var g=2*c*(Math.PI/36),d=Math.sin(g),p=Math.cos(g);if(0==l)var u=t+h*p,b=i+r*d;else if(1==l)var m=t+h*p,x=i+r*d;else if(2==l)var v=t+.8*h*p,w=i+.8*r*d;2==l&&this._shape.graphics.bezierCurveTo(u,b,m,x,v,w),3==(l+=1)&&(l=0),0==c&&this._shape.graphics.moveTo(u,b)}u=t+h*p,b=i+r*d,m=t+h,x=i,v=t+h,w=i,this._shape.graphics.bezierCurveTo(u,b,m,x,v,w),this._shape.graphics.closePath(),this._shape.graphics.endStroke(),firstCirclePos=this.getCloudPointPosition(),this._shapeCircles=new createjs.Shape,this._shapeCircles.name="cloud circles",this._stage.addChild(this._shapeCircles),this._shapeCircles.graphics.setStrokeStyle(a,"round"),this._shapeCircles.graphics.beginStroke(o),this._shapeCircles.graphics.beginFill(n),this._shapeCircles.graphics.arc(firstCirclePos[0],firstCirclePos[1],7,0,2*Math.PI),this._shapeCircles.graphics.endStroke(),secondCirclePos=this.getPointPosition(!1),this._shapeCircles.graphics.beginStroke(o),this._shapeCircles.graphics.beginFill(n),this._shapeCircles.graphics.arc(secondCirclePos[0],secondCirclePos[1],5,0,2*Math.PI),this._shapeCircles.graphics.endStroke(),this._shape.setTransform(0,0,e,s)},this.getCloudPointPosition=function(){var t=this._x,i=this._y,e=this._width,s=this._height;switch(this._direction){case l:return[t+this._point[0]/2,i+s+this._point[1]/2];case p:return[t+e+this._point[0]/2,i+this._point[1]/2];case d:return[t-e-this._point[0]/2,i+this._point[1]/2];case c:return[t+this._point[0]/2,i-s-this._point[1]/2]}},this.createShapeExclamation=function(t,i,e,s){this._shape=new createjs.Shape,this._shape.name="exclamation",this._stage.addChild(this._shape),this._shape.graphics.setStrokeStyle(a,"round",null,null,!0),this._shape.graphics.beginStroke(o),this._shape.graphics.beginFill(n);for(var h=this._width/e,r=this._height/s,g=0;g<24;g++){var u=2*g*(Math.PI/24),b=Math.sin(u),m=Math.cos(u);g%2>0?(xi=t+.8*h*m,yi=i+.8*r*b):(xi=t+h*m,yi=i+r*b),(this._direction==l&&6==g||this._direction==p&&0==g||this._direction==d&&12==g||this._direction==c&&18==g)&&(pos=this.getPointPosition(!0),xi=pos[0],yi=pos[1]),0==g?this._shape.graphics.moveTo(xi,yi):this._shape.graphics.lineTo(xi,yi)}this._shape.graphics.closePath(),this._shape.graphics.endStroke(),this._shape.setTransform(0,0,e,s)},this.createControls=function(){var t=this._x,i=this._y,e=this._width,s=this._height;if(null!=this._shapeControls&&this._shapeChanged&&(this._stage.removeChild(this._shapeControls),this._shapeControls=null),null==this._shapeControls?(this._shapeControls=new createjs.Shape,this._shapeControls.name="control_rect",this._shapeControls.graphics.setStrokeStyle(1,"round"),this._shapeControls.graphics.beginStroke(n),this._shapeControls.x=t,this._shapeControls.y=i,this._shapeControls.graphics.rect(-e,-s,2*e,2*s),this._shapeControls.graphics.setStrokeDash([2]),this._shapeControls.graphics.beginFill("rgba(0, 0, 0, 0)"),this._shapeControls.graphics.beginStroke(o),this._shapeControls.graphics.rect(-e,-s,2*e,2*s),this._shapeControls.graphics.endStroke(),this._shapeControls.visible=this.getSelected(),this._stage.addChildAt(this._shapeControls,this._stage.children.length-1)):(this._shapeControls.visible=this.getSelected(),this._shapeControls.x=t,this._shapeControls.y=i),this._stage.addChild(this._shapeControls),this._type!=f)if(this._stage.addChild(this._pointerControl),this._stage.addChild(this._rotateButton),null!=this._pointerControl&&(this._pointerChanged||this._shapeChanged)&&(this._stage.removeChild(this._pointerControl),this._pointerControl=null),null==this._pointerControl){this._pointerControl=new createjs.Shape,this._pointerControl.x=t,this._pointerControl.y=i,point_pos=this.getPointPositionRelative(),this._pointerControl.graphics.beginStroke(o),this._pointerControl.graphics.arc(point_pos[0],point_pos[1],x/2,0,2*Math.PI),this._pointerControl.graphics.endStroke();var h=new createjs.Shape;h.graphics.beginFill("#000").arc(point_pos[0],point_pos[1],x/2,0,2*Math.PI),this._pointerControl.hitArea=h,this._pointerControl.visible=this.getSelected(),this._stage.addChild(this._pointerControl),this._pointerControl.on("pressmove",(function(t){this.setPointPosition(t.stageX,t.stageY),this._box.selectGlobe(this),this._pointerChanged=!0,this.update()}),this)}else this._pointerControl.x=t,this._pointerControl.y=i,this._pointerControl.visible=this.getSelected();this._stage.addChild(this._resizeButton),this._stage.addChild(this._editButton),null==this._resizeButton?createAsyncBitmapButton(this,"./icons/resize.svg",(function(t,i){i.x=t._x-t._width-i.width/2,i.y=t._y-t._height-i.height/2,i.visible=t.getSelected(),t._resizeButton=i,t._stage.addChild(i),t._stage.update(),i.on("pressmove",(function(i){this._width=Math.max(t._x-i.stageX,x/2),this._height=Math.max(t._y-i.stageY,x/2),this._shapeChanged=!0,this.update()}),t)})):(this._resizeButton.x=this._x-this._width-this._resizeButton.width/2,this._resizeButton.y=this._y-this._height-this._resizeButton.height/2,this._resizeButton.visible=this.getSelected()),null==this._editButton?createAsyncBitmapButton(this,"./icons/edit.svg",(function(t,i){i.x=t._x+t._width-i.width/2,i.y=t._y-t._height-i.height/2,i.visible=t.getSelected(),t._editButton=i,t._stage.addChild(i),t._stage.update(),i.on("click",(function(i){t._box.popupTextEditionPalette()}))})):(this._editButton.x=this._x+this._width-this._editButton.width/2,this._editButton.y=this._y-this._height-this._editButton.height/2,this._editButton.visible=this.getSelected()),this._type!=f&&(null==this._rotateButton?createAsyncBitmapButton(this,"./icons/object_rotate_right.svg",(function(t,i){i.x=t._x+t._width-i.width/2,i.y=t._y+t._height-i.height/2,i.visible=t.getSelected(),t._rotateButton=i,t._stage.addChild(i),t._stage.update(),i.on("click",(function(i){t.rotate()}))})):(this._rotateButton.x=this._x+this._width-this._rotateButton.width/2,this._rotateButton.y=this._y+this._height-this._rotateButton.height/2,this._rotateButton.visible=this.getSelected())),this._isTitleGlobe||(this._stage.addChild(this._resizeButton),this._stage.addChild(this._editButton),this._stage.addChild(this._removeButton),null==this._removeButton?createAsyncBitmapButton(this,"./icons/remove.svg",(function(t,i){i.x=t._x-t._width-i.width/2,i.y=t._y+t._height-i.height/2,i.visible=t.getSelected(),t._removeButton=i,t._stage.addChild(i),t._stage.update(),i.on("click",(function(i){t.remove()}))})):(this._removeButton.x=this._x-this._width-this._removeButton.width/2,this._removeButton.y=this._y+this._height-this._removeButton.height/2,this._removeButton.visible=this.getSelected())),this._shapeChanged=!1,this._pointerChanged=!1},this.rotate=function(){switch(this._direction){case l:this._direction=d;break;case p:this._direction=l;break;case d:this._direction=c;break;case c:this._direction=p}var t=this._point[0];this._point[0]=this._point[1],this._point[1]=t,this._pointerChanged=!0,this.update()},this.remove=function(){var i=this._box.globes.indexOf(this);-1!=i&&(this._box.globes.splice(i,1),this._stage.removeChild(this._shape),this._stage.removeChild(this._shapeControls),this._type!=f&&(this._stage.removeChild(this._pointerControl),this._stage.removeChild(this._rotateButton)),this._type==w&&this._stage.removeChild(this._shapeCircles),this._stage.removeChild(this._resizeButton),this._stage.removeChild(this._editButton),this._stage.removeChild(this._removeButton),this._textViewer.remove(),this._stage.update(),t.selectGlobe(null))},this.update=function(){this.createShape(),this._textViewer.update(),this.createControls(),this._stage.update()},this.getPointPosition=function(t){var i=1,e=1;t&&(i=this._width/this._radio,e=this._height/this._radio);var s=this._x/i,h=this._y/e,a=this._width/i,o=this._height/e;switch(this._direction){case l:return[s+this._point[0]/i,h+o+this._point[1]/e];case p:return[s+a+this._point[0]/i,h+this._point[1]/e];case d:return[s-a-this._point[0]/i,h+this._point[1]/e];case c:return[s+this._point[0]/i,h-o-this._point[1]/e]}},this.getPointPositionRelative=function(){var t=this._width,i=this._height;switch(this._direction){case l:return[this._point[0],i+this._point[1]];case p:return[t+this._point[0],this._point[1]];case d:return[-t-this._point[0],this._point[1]];case c:return[this._point[0],-i-this._point[1]]}},this.setPointPosition=function(t,i){switch(this._direction){case l:this._point[0]=t-this._x,this._point[1]=i-this._y-this._height;break;case p:this._point[0]=t-this._x-this._width,this._point[1]=i-this._y;break;case d:this._point[0]=-t+this._x-this._width,this._point[1]=i-this._y;break;case c:this._point[0]=t-this._x,this._point[1]=-i+this._y-this._height}},this.init(),this.update()}function BoxSorter(t,i){this.canvas=t,this._data=i,this._width=t.width-2*a,this._height=t.height-2*a,this._previewWidth=4*this._height/3,this._previewBitmaps=[],this._deltaX=null,this.stage=new createjs.Stage(t),createjs.Touch.enable(this.stage),this.init=function(){this.canvas.style.display="block",this._backContainer=new createjs.Container;var t=new createjs.Shape;t.graphics.setStrokeStyle(a,"round"),t.graphics.beginStroke(o).drawRect(a,a,this._width,this._height),this.stage.addChild(this._backContainer),this._backContainer.addChild(t),this._backContainer.cache(0,0,this.canvas.width,this.canvas.height),this.loadPreviews(),this.stage.update()},this.hide=function(){this.canvas.style.display="none"},this.loadPreviews=function(){for(var t=0;t<this._data.boxs.length;t++){var i=this._data.previews[t];if(null==i){var e=this._data.boxs[t].image_name;""!=e&&null!=e&&(i=this._data.images[e])}null!=i&&this._createPreview(i,t)}},this.getSortOrder=function(){for(var t=[0],i=0;i<this._previewBitmaps.length;i++)t.push(this._previewBitmaps[i]._order);return t},this._createPreview=function(t,i){var e=new Image,s=this;e.addEventListener("load",(function(){bitmap=new createjs.Bitmap(this),bitmap.setBounds(0,0,this.width,this.height),bitmap._order=i;var t=s._previewWidth/this.width,e=s._height/this.height,h=Math.min(t,e);bitmap.x=s._previewWidth*i,bitmap.y=a,bitmap.scaleX=h,bitmap.scaleY=h;var o=new createjs.Shape;o.graphics.beginFill("#000").drawRect(0,0,this.width,this.height),bitmap.hitArea=o,i>0&&(s._previewBitmaps.push(bitmap),bitmap.on("pressmove",(function(t){if(console.log("TOON pressmove"),null==s._deltaX){s._deltaX=t.stageX-t.target.x;var i=t.target;s.stage.sortChildren((function(t,e){return t==i?1:0})),t.target.parent.addChild(t.target)}new_x=t.stageX-s._deltaX,new_x>this._previewWidth/2&&(t.target.x=new_x,s.stage.update())}),s),bitmap.on("pressup",(function(t){console.log("TOON pressup"),s._deltaX=null,s._previewBitmaps.sort((function(t,i){return t.x-i.x}));for(var i=0;i<s._previewBitmaps.length;i++)s._previewBitmaps[i].x=s._previewWidth*(i+1);s.stage.update()}),s)),s.stage.addChildAt(bitmap,0),s.stage.update()})),e.src=t}}return toon={},toon.Model=function Model(t,e,s){this._data=t,this._canvas=e,this._textpalette=s,this.comicBox=null,this._imageCounter=0,this._pageCounterDisplay=null,this._prevButton=null,this._nextButton=null,this._boxSorter=null,this._sortButton=null,this._data.previews=[],this._waitMsg=document.getElementById("wait"),this.comicBox=new ComicBox(this._canvas,this),this.init=function(){this.activeBox=0;var t=this._data.boxs[this.activeBox];if(this._imageCounter=this._data.boxs.length,1==this._data.boxs.length&&0==t.globes.length){console.log("EMPTY TOON");var i={direction:null,text_font_description:"Sans 30",globe_type:"RECTANGLE",height:50,width:200,text_color:[0,0,0],radio:15,text_width:76,y:this._canvas.height/2,x:this._canvas.width/2,text_height:8,title_globe:!0,text_text:_("Title")};t.globes.push(i)}this.comicBox.init(t,this._data.images),this.comicBox.attachTextEditionPalette(this._textpalette),this._updatePageCounter()},this.setData=function(t){this._data=t,this._data.previews=[],this.init()},this.showWait=function(){this._waitMsg.style.display="block"},this.hideWait=function(){this._waitMsg.style.display="none"},this.getTitle=function(){for(var t=this._data.boxs[0],i=0;i<t.globes.length;i++){var e=t.globes[i];if(e.title_globe)return e.text_text}return""},this.initSort=function(t){this._canvas.style.display="none",this._boxSorter=new BoxSorter(t,this._data),this._boxSorter.init(),null!=this._pageCounterDisplay&&(this._pageCounterDisplay.parentNode.style.display="none")},this.finishSort=function(){var t=[],i=this._boxSorter.getSortOrder();this.changeToEditMode();for(var e=0;e<i.length;e++)t.push(this._data.boxs[i[e]]);this._data.boxs=t},this.changeToEditMode=function(){this._boxSorter.hide(),this._canvas.style.display="block",null!=this._pageCounterDisplay&&(this._pageCounterDisplay.parentNode.style.display="block")},this.changeBox=function(t){t>=0&&t<this._data.boxs.length&&(this.updateData(),this.activeBox=t,this.comicBox.init(this._data.boxs[this.activeBox],this._data.images,this.activeBox>0),this._updatePageCounter())},this.removeBox=function(){this._data.boxs.splice(this.activeBox,1),this._data.previews=[],this.activeBox>this._data.boxs.length-1&&this.activeBox--,this.comicBox.init(this._data.boxs[this.activeBox],this._data.images,this.activeBox>0),this._updatePageCounter()},this.updateData=function(){this._data.boxs[this.activeBox]=this.comicBox.getJson()},this.initPreviews=function(){for(var t=0;t<this._data.boxs.length;t++)this.storePreview(t)},this.storePreview=function(t){var i=document.createElement("canvas");i.width=this._canvas.width,i.height=this._canvas.height;var e=new ComicBox(i),s=this;e.init(this._data.boxs[t],this._data.images,!1,{canvas:i,order:t},(function(t){s._data.previews[t.order]=t.canvas.toDataURL("image/png")}))},this._updatePageCounter=function(){null!=this._pageCounterDisplay&&(this._pageCounterDisplay.innerHTML=this.activeBox+1+" "+_("of")+" "+this._data.boxs.length),null!=this._prevButton&&(this._prevButton.disabled=0==this.activeBox),null!=this._nextButton&&(this._nextButton.disabled=this.activeBox==this._data.boxs.length-1),null!=this._sortButton&&(this._sortButton.disabled=this._data.boxs.length<3)},this.addGlobe=function(t){this.comicBox.addGlobe(t)},this.showPreviousBox=function(){var t=this.activeBox-1;this.changeBox(t)},this.showNextBox=function(){var t=this.activeBox+1;this.changeBox(t)},this.addImage=function(t){null==this._data.images&&(this._data.images={}),this._imageCounter=this._imageCounter+1;for(var i="bAcKgRoUnD_"+this._imageCounter;null!=this._data.images[i];)this._imageCounter=this._imageCounter+1,i="bAcKgRoUnD_"+this._imageCounter;var e={image_name:i,globes:[]};this._data.boxs.push(e),this._data.images[i]=t,this.changeBox(this._data.boxs.length-1)},this.getData=function(){return this.updateData(),this._data},this.attachPageCounterViewer=function(t){this._pageCounterDisplay=t.children[0],this._updatePageCounter()},this.attachPrevNextButtons=function(t,i){this._prevButton=t,this._nextButton=i,this._updatePageCounter()},this.attachSortButton=function(t){this._sortButton=t,this._updatePageCounter()},this.saveAsImage=function(t){this.showWait();var e=this._data.boxs.length,s=20;if("0"==t)var a=(this._canvas.width+s)*e+s,o=this._canvas.height+40;else if("1"==t)a=this._canvas.width+40,o=(this._canvas.height+s)*e+s;else if("2"==t)a=2*this._canvas.width+60,o=(this._canvas.height+s)*Math.ceil(e/2)+s;var n=document.createElement("canvas");n.width=a,n.height=o;var r=n.getContext("2d");r.fillStyle="#FFFFFF",r.fillRect(0,0,a,o);for(var l=0,c=0;c<e;c++){var g=this,d=document.createElement("canvas");d.width=this._canvas.width,d.height=this._canvas.height,new ComicBox(d).init(this._data.boxs[c],this._data.images,!1,d,(function(a){var o=new Image;o.src=a.toDataURL("image/png"),o.addEventListener("load",(function(){if("0"==t)var a=s+(g._canvas.width+s)*l,o=s;else if("1"==t)a=s,o=s+(g._canvas.height+s)*l;else if("2"==t)a=s+l%2*(g._canvas.width+s),o=s+Math.floor(l/2)*(g._canvas.height+s);if(r.drawImage(this,a,o),l++>=e-1){var c=n.toDataURL("image/png"),d={mimetype:"image/png",title:"Image FotoToon",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};i.create(d,(function(t){t?(console.log("error saving image in journal"),h.log(_("SavingError"))):(console.log("image saved in journal."),h.log(_("ImageSaved"))),g.hideWait()}),c)}}))}))}}},toon.TYPE_GLOBE=v,toon.TYPE_CLOUD=w,toon.TYPE_EXCLAMATION=C,toon.TYPE_RECTANGLE=f,toon.TYPE_WHISPER=y,toon}));