function Editor(t,s,i,e,o,h,n,a){void 0===a&&(a=!1),this.radius=22.5,this.scale=t.canvas.width/1200,this.cxy=[t.canvas.width/2,t.canvas.height/2],this.xy=[t.canvas.width/2+120*this.scale,t.canvas.height/2-this.radius*this.scale],this.dotsizeplus=3*this.radius*this.scale,this.dmin=0,this.dmax=t.canvas.height-this.dotsizeplus/2.2,this.zones=[],this.dots=[],this.stage=t,this.xo=null,this.width=t.canvas.width,this.height=t.canvas.height,this.env=h,this.ds=n,this.hexToRgb=function(t){var s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return s?{r:parseInt(s[1],16),g:parseInt(s[2],16),b:parseInt(s[3],16)}:null},this.contrast=function(t,s){var i=.3*t.r+.6*t.g+.1*t.b,e=.3*s.r+.6*s.g+.1*s.b;return Math.abs(e-i)},this.hue=function(t){var s=.5*(2*t.r-t.g-t.b),i=.87*(t.g-t.b);return 180*Math.atan2(i,s)/Math.PI},this.deltahue=function(t,s){return h1=this.hue(t),h2=this.hue(s),Math.abs(h2-h1)},this.zone=function(t,s){var i;return i=s<75?0:s>150?1:2,t>48&&(i+=1),i},this.calczones=function(t){for(var i in s.colors)rgb1=this.hexToRgb(s.colors[i].stroke),rgb2=this.hexToRgb(s.colors[i].fill),dv=this.contrast(rgb1,rgb2),dh=this.deltahue(rgb1,rgb2),this.zones.push(this.zone(dv,dh))},this.nextdotposition=function(){var t=this.xy[0]-this.cxy[0],s=this.xy[1]-this.cxy[1],i=Math.sqrt(t*t+s*s),e=2*i*Math.PI,o=Math.atan2(s,t);o+=this.dotsizeplus/e*2*Math.PI,i+=this.dotsizeplus/(e/this.dotsizeplus),this.xy[0]=i*Math.cos(o)+this.cxy[0],this.xy[1]=i*Math.sin(o)+this.cxy[1],(this.xy[1]<this.dmin||this.xy[1]>this.dmax)&&this.nextdotposition()},this.saveColours=function(){var t=this.ds.localStorage.getValue("sugar_settings");if(t.colorvalue.stroke=this.xo.stroke,t.colorvalue.fill=this.xo.fill,t.color=this.xo.colnumber,this.ds.localStorage.setValue("sugar_settings",t),null!=t.networkId&&t.server&&t.token){var s=t.server.url;if(null==s)if("http"==document.location.protocol.substr(0,4)){var i=window.location.href;s=i.substring(0,i.indexOf("/activities"))}else s="http://localhost";s=s+"/api/v1/users/"+t.networkId;var e=new XMLHttpRequest;e.open("PUT",s,!0),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.setRequestHeader("x-key",t.token.x_key),e.setRequestHeader("x-access-token",t.token.access_token),e.send("user="+encodeURI(JSON.stringify({color:{stroke:this.xo.stroke,fill:this.xo.fill}})))}},this.stop=function(){var t=[],s={};for(var i in s.x=this.width,s.y=this.height,t.push(s),this.dots)(s={}).fill=this.dots[i].innercol,s.stroke=this.dots[i].outercol,s.x=this.dots[i].circle.x,s.y=this.dots[i].circle.y,s.num=this.dots[i].number,t.push(s);var e=JSON.stringify(t);o.getDatastoreObject().setDataAsText(e),o.getDatastoreObject().save((function(t){null===t?console.log("write done."):console.log("write failed.")}))},this.init=function(){1==a?this.init_getsettings(!1,[]):o.getDatastoreObject().getMetadata(this.init_canaccessdatastore.bind(this))},this.init_canaccessdatastore=function(t,s){var i=(new Date).getTime();Math.abs(i-s.creation_time)<2e3?this.init_getsettings(!1,[]):o.getDatastoreObject().loadAsText(this.init_getdatastore.bind(this))},this.init_getdatastore=function(t,s,i){null==t&&null!=i?(i=JSON.parse(i),this.init_getsettings(!0,i)):this.init_getsettings(!1,[])},this.init_getsettings=function(t,s){this.ds.localStorage.load(function(){var i=this.ds.localStorage.getValue("sugar_settings");this.init_activity(t,s,i)}.bind(this))},this.init_activity=function(i,o,h){this.dots=[],this.calczones();var n=h,a=new XOMan(e.fill,e.stroke,this,n.color);if(a.init(),this.xo=a,0==i)for(var r=0;r<4;r++)for(var l in s.colors){if(this.zones[l]==r)(d=new ColourCircle(s.colors[l].fill,s.colors[l].stroke,this.xy[0]+15,this.xy[1],t,this.xo,l)).init(),this.dots.push(d),this.nextdotposition()}else{var c=this.width/o[0].x,u=this.height/o[0].y;for(l=1;l<o.length;l++){var d;(d=new ColourCircle(o[l].fill,o[l].stroke,o[l].x*c,o[l].y*u,t,this.xo,o[l].num)).init(),this.dots.push(d)}}}}