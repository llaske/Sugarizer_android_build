define(["sugar-web/activity/activity","sugar-web/datastore","sugar-web/env","webL10n","tutorial"],(function(e,t,n,o,i){requirejs(["domReady!","humane"],(function(d,l){e.setup();var c=(/Android/i.test(navigator.userAgent)||/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent))&&"http"!=document.location.protocol.substr(0,4),s=0,u=[];n.getEnvironment((function(e,t){var n="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,i=t.user?t.user.language:n;o.language.code=i}));var a=document.getElementById("canvas").parentNode.offsetHeight-95;a-=20*a/100;var r=new QRCode("qr-code",{width:a,height:a,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),m=(document.getElementById("canvas").parentNode.offsetWidth-a)/2;document.getElementById("qr-code").style.marginLeft=m+"px",document.getElementById("qr-code").style.marginTop="20px";var generateCode=function(e){r.clear(),r.makeCode(e),function addToHistory(e){u.includes(e)||(u.push(e),function updateHistory(){var e="",t=u.length;for(;t--;)e+='<option value="'+u[t]+'">'+u[t]+"</option>";document.getElementById("qrtextdropdown").innerHTML=e}())}(e),(e=y.value.toLowerCase()).length>0?document.getElementById("erasetext-button").style.visibility="visible":document.getElementById("erasetext-button").style.visibility="hidden",0==e.indexOf("http://")||0==e.indexOf("https://")?document.getElementById("user-text").classList.add("text-url"):document.getElementById("user-text").classList.remove("text-url")},resizeHandler=function(){var e=(document.body.clientHeight-95+("visible"==document.getElementById("unfullscreen-button").style.visibility?55:0))/(120*a/100);document.getElementById("qr-code").style.zoom=e;var t=navigator.userAgent.toLowerCase();-1==t.indexOf("chrome")&&(document.getElementById("qr-code").style.MozTransform="scale("+e+")",document.getElementById("qr-code").style.MozTransformOrigin="0 0"),E&&(document.getElementById("outdiv").style.zoom=e,-1==t.indexOf("chrome")&&(document.getElementById("outdiv").style.MozTransform="scale("+e+")",document.getElementById("outdiv").style.MozTransformOrigin="0 0"))};window.addEventListener("resize",resizeHandler);var y=document.getElementById("user-text");y.addEventListener("keyup",(function(){var e=y.value.toLowerCase();e.length>0?document.getElementById("erasetext-button").style.visibility="visible":document.getElementById("erasetext-button").style.visibility="hidden",0==e.indexOf("http://")||0==e.indexOf("https://")?document.getElementById("user-text").classList.add("text-url"):document.getElementById("user-text").classList.remove("text-url")})),y.addEventListener("click",(function(){var e=y.value.toLowerCase();0!=e.indexOf("http://")&&0!=e.indexOf("https://")||(c?cordova.InAppBrowser.open(y.value,"_system"):window.open(y.value))})),document.getElementById("erasetext-button").addEventListener("click",(function(){y.value="",y.focus(),document.getElementById("erasetext-button").style.visibility="hidden",document.getElementById("user-text").classList.remove("text-url")})),window.addEventListener("localized",(function(){document.getElementById("user-text").placeholder=o.get("Text")})),document.getElementById("user-text").addEventListener("keyup",(function(e){13===e.keyCode&&(e.preventDefault(),generateCode(y.value))})),document.getElementById("generate-button").addEventListener("click",(function(){generateCode(y.value)}));var codeScanned=function(e){document.getElementById("outdiv").style.visibility="hidden",document.getElementById("video-stream").style.visibility="hidden",document.getElementById("qr-code").style.visibility="visible",document.getElementById("loading-spinner").style.visibility="hidden",document.getElementById("photo-button").classList.remove("active"),y.value=e,generateCode(e)},g=document.getElementById("input-box");g.addEventListener("focus",(function myFocusFunction(){document.getElementById("user-text").style.backgroundColor="white",document.getElementById("field").style.backgroundColor="white"}),!0),g.addEventListener("blur",(function myBlurFunction(){document.getElementById("user-text").style.backgroundColor="#e5e5e5",document.getElementById("field").style.backgroundColor="#e5e5e5"}),!0),document.getElementById("png-button").addEventListener("click",(function(){var e=document.getElementById("qr-code").childNodes[1].src,n={mimetype:"image/png",title:"Image QR Code",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};t.create(n,(function(){l.log(o.get("QRCodeSaved")),console.log("export done.")}),e)})),document.getElementById("help-button").addEventListener("click",(function(e){i.start()})),document.getElementById("fullscreen-button").addEventListener("click",(function(){document.getElementById("photo-button").classList.contains("active")||(document.getElementById("main-toolbar").style.opacity=0,document.getElementById("input-box").style.opacity=0,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",resizeHandler())})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("input-box").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",resizeHandler()}));var v=document.getElementById("photo-button"),E=!1,b="";v.addEventListener("click",(function(){if(c)return document.getElementById("main-toolbar").style.opacity=0,document.getElementById("canvas").style.opacity=0,document.getElementById("close-button").style.visibility="visible",document.getElementById("switchcamera-button").style.visibility="visible",void QRScanner.prepare((function(e,t){e?console.log("Error "+e):(console.log(t),QRScanner.scan((function(e,t){e?console.log("Error "+e):(y.value=t,generateCode(t)),QRScanner.cancelScan((function(e){})),document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.opacity=1,document.getElementById("close-button").style.visibility="hidden",document.getElementById("switchcamera-button").style.visibility="hidden"})),QRScanner.show((function(e){})))}));var e=document.getElementById("outdiv"),t=document.getElementById("video-stream");v.classList.contains("active")?(e.style.visibility="hidden",t.style.visibility="hidden",document.getElementById("loading-spinner").style.visibility="hidden",document.getElementById("qr-code").style.visibility="visible",y.value=b,generateCode(y.value)):(document.getElementById("qr-code").style.visibility="hidden",document.getElementById("loading-spinner").style.visibility="visible",b=y.value,y.value="",E?(e.style.visibility="visible",t.style.visibility="visible"):(e.innerHTML='<video id="video-window" autoplay></video>',load(a,m,codeScanned),E=!0)),v.classList.toggle("active")})),document.getElementById("close-button").addEventListener("click",(function(e){c&&QRScanner.cancelScan((function(e){}))})),document.getElementById("switchcamera-button").addEventListener("click",(function(e){c&&(s=(s+1)%2,QRScanner.useCamera(s,(function(e,t){})))})),document.getElementById("qrtextdropdown").addEventListener("change",(function(){document.getElementById("user-text").value=document.getElementById("qrtextdropdown").value,generateCode(document.getElementById("qrtextdropdown").value)})),document.getElementById("stop-button").addEventListener("click",(function(t){console.log("writing...");var n={userText:v.classList.contains("active")?b:y.value,uHistory:u},o=JSON.stringify(n);e.getDatastoreObject().setDataAsText(o),e.getDatastoreObject().save((function(e){null===e?console.log("write done."):console.log("write failed.")}))})),n.getEnvironment((function(t,n){n.objectId?e.getDatastoreObject().loadAsText((function(e,t,n){null==e&&null!=n&&(n=JSON.parse(n),y.value=n.userText,u=n.uHistory,generateCode(n.userText))})):(console.log("New instance"),y.value=n.user.name,generateCode(n.user.name))}))}))}));