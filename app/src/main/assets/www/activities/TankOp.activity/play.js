enyo.kind({name:"TankOp.Play",kind:enyo.Control,classes:"board",published:{level:0},components:[{name:"gamebox",classes:"game-box",ontap:"gameClick",components:[]},{classes:"status-line",components:[{name:"wavetext",classes:"wave-text no-select-content"},{name:"wave",content:"1",classes:"wave-value no-select-content"},{name:"scoretext",classes:"score-text no-select-content"},{name:"score",content:"0000",classes:"score-value no-select-content"}]},{kind:"Image",classes:"home-button no-select-content",src:"images/gohome.png",ontap:"goHome"},{name:"keyboard",classes:"keyboard-set no-select-content",components:[{classes:"display-line",components:[{name:"lcd",kind:"LcdDisplay",classes:"lcd-value",size:3,value:""}]},{classes:"keyboard-line",components:[{kind:"Image",src:"images/key_1.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_2.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_3.svg",classes:"keyboard",ontap:"virtkeyPressed"}]},{classes:"keyboard_line",components:[{kind:"Image",src:"images/key_4.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_5.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_6.svg",classes:"keyboard",ontap:"virtkeyPressed"}]},{classes:"keyboard_line",components:[{kind:"Image",src:"images/key_7.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_8.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_9.svg",classes:"keyboard",ontap:"virtkeyPressed"}]},{classes:"keyboard_line",components:[{kind:"Image",src:"images/key_0.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_fire.svg",classes:"keyboard",ontap:"virtkeyPressed"}]}]},{kind:"Signals",onkeypress:"keyPressed"},{kind:"ImageCache",showing:!1,onCacheLoaded:"cacheLoaded"}],create:function(){this.inherited(arguments),play=this,this.imagesToLoad++,this.endOfGame=!1,this.pausedGame=!0,this.initializedGame=!1,this.waitForClick=!1;var e=document.body.clientWidth/1e3;this.zoom=Math.max(e,.3),this.zoom=Math.min(this.zoom,1),this.$.gamebox.setStyle("max-height: "+this.zoom*constant.areaHeight+"px;"),this.canvas=this.$.gamebox.createComponent({kind:"Canvas",id:"acanvas",name:"canvas",attributes:{width:constant.areaWidth,height:constant.areaHeight}}),this.loopTimer=window.setInterval(enyo.bind(this,"gameLoopTick"),constant.loopInterval)},initGame:function(){var e=this.currentlevel=preferences.levels[this.level],t=e.map,s=e.defense[0],n=e.defense[1],a=e.defense[2],i=e.defense[3],o=e.defense[4];this.initializedGame=!0,this.game=util.createMap(preferences.gameMap(t)),this.targetpos={x:7,y:4},this.$.wavetext.setContent(l10n.get("Wave")),this.$.scoretext.setContent(l10n.get("Score"));constant.boardWidth,constant.boardHeight;var r=enyo.bind(this,"goodEngine");this.units=[];for(var l=constant.boardHeight/(s+1),d=[],h=0;h<s;h++){var c=util.createUnit({type:"hq",color:"blue",x:0,y:Math.floor((h+1)*l),engine:null});this.units.push(c),d.push(c)}var m=[];for(h=0;h<o;h++)m.push({type:"helo",color:"blue",engine:r});for(h=0;h<i;h++)m.push({type:"canon",color:"blue",engine:r});for(h=0;h<a;h++)m.push({type:"tank",color:"blue",engine:r});for(h=0;h<n;h++)m.push({type:"soldier",color:"blue",engine:r});if(m.length>0){var g=0,u=Math.min(m.length,1+2*d.length);for(h=0;h<u;h++){var y={};do{var v=[{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(j=0;j<v.length&&(y={x:d[g].x+v[j].dx,y:d[g].y+v[j].dy},null!=util.lookForUnit(y));j++)y={x:-1,y:-1};g=(g+1)%d.length}while(-1==y.x);m[h].x=y.x,m[h].y=y.y,this.units.push(util.createUnit(m[h]))}}this.score=0,this.wave=1,this.enemyCount=e.attack,this.enemyWaveSize=constant.waveInitSize,this.enemyNextWaveCount=constant.waveInitSize,this.enemyWaveCount=0,this.enemyArrivalTurn=constant.startArrival,this.pausedGame=!1},rendered:function(){this.initializedGame||(this.initGame(),this.canvas.hasNode().style.MozTransform="scale("+this.zoom+")",this.canvas.hasNode().style.MozTransformOrigin="0 0",this.canvas.hasNode().style.zoom=this.zoom)},resize:function(){var e=document.querySelector(".keyboard-set").id,t=document.getElementById(e),s=window.getComputedStyle(t).width;wsize=document.body.clientWidth,s=s.slice(0,-2),s=parseInt(s),wsize-=s,ratio=wsize/1e3,this.zoom=Math.max(ratio,.3),this.zoom=Math.min(this.zoom,1),this.$.gamebox.setStyle("max-height: "+this.zoom*constant.areaHeight+"px;"),this.canvas.hasNode().style.MozTransform="scale("+this.zoom+")",this.canvas.hasNode().style.zoom=this.zoom},cacheLoaded:function(){},draw:function(){var e=this.canvas.hasNode().getContext("2d");e.clearRect(0,0,this.canvas.attributes.width,this.canvas.attributes.height);for(var t=document.getElementById("grass"),s=document.getElementById("trees"),n=document.getElementById("mountain"),a=document.getElementById("water"),i=0;i<constant.boardHeight;i++)for(var o=0;o<constant.boardWidth;o++){e.save(),e.translate(o*constant.tileSize,i*constant.tileSize),e.drawImage(t,0,0);var r=this.game[i][o];r==constant.tileTrees?e.drawImage(s,0,0):r==constant.tileMountain?e.drawImage(n,0,0):r==constant.tileWater&&e.drawImage(a,0,0),e.restore()}if(this.endOfGame){var l=this.win?document.getElementById("endgame_victory"):document.getElementById("endgame_defeat");e.save(),e.translate((constant.areaWidth-constant.endGameWidth)/2,(constant.areaHeight-constant.endGameHeight)/2),e.drawImage(l,0,0),e.restore(),this.waitForClick||(sound.play(this.win?"audio/mission_completed":"audio/mission_failed",!0),this.waitForClick=!0)}else{for(i=0;i<this.units.length;i++)this.units[i].draw(e);var d=document.getElementById("target");e.save(),e.translate(this.targetpos.x*constant.tileSize,this.targetpos.y*constant.tileSize),e.drawImage(d,0,0),e.restore()}},keyPressed:function(e,t){var s=t.charCode;if(!this.endOfGame)if(s>=48&&s<=57){var n=this.$.lcd.getValue();n.length==this.$.lcd.getSize()&&(n=n.substr(1)),n+=String.fromCharCode(s),this.$.lcd.setValue(n)}else if(45==s)this.$.lcd.setValue("-");else if(32==s){var a=util.lookForValue(this.$.lcd.getValue().replace(/ /g,""));if(0!=a.length)for(var i=0;i<a.length;i++)util.processFight(null,a[i],constant.userPower),this.targetpos.x=a[i].x,this.targetpos.y=a[i].y;else sound.play("audio/missed");this.$.lcd.setValue("")}},virtkeyPressed:function(e){var t=e.getSrc().replace(".svg",""),s=t.substr("images/key_".length,t.indexOf("key_"));"fire"==s?this.keyPressed(null,{charCode:32}):this.keyPressed(null,{charCode:48+parseInt(s)})},goHome:function(){this.waitForClick?this.gameClick():(play=null,window.clearInterval(this.loopTimer),app.init(),app.playTheme(),app.renderInto(document.getElementById("board")))},gameClick:function(){this.endOfGame&&(window.clearInterval(this.loopTimer),this.win&&(preferences.levels[this.level].completed=!0,app.nextMission(),app.save()),app.init(),app.renderInto(document.getElementById("board")),sound.pause());var e=document.documentElement.clientWidth,t=document.documentElement.clientHeight,s=Math.floor(e/2),n=Math.floor((t+constant.pubHeight)/2),a=mouse.position.x-s,i=mouse.position.y-n,o=Math.abs(a),r=Math.abs(i);if(o>=0&&o<constant.fireZoneWidth&&r>=0&&r<constant.fireZoneHeight){var l=util.lookForUnit(this.targetpos);null!=l&&util.processFight(null,l)}else{o>r?(dx=a>0?1:-1,dy=0):(dx=0,dy=i>0?1:-1);var d=this.targetpos.x+dx,h=this.targetpos.y+dy;d<0||d==constant.boardWidth||h<0||h==constant.boardHeight||(this.targetpos.x=d,this.targetpos.y=h)}},gameLoopTick:function(){if(!this.pausedGame){for(var e=[],t=[],s=0,n=0,a=0;a<this.units.length;a++){var i=-1!=(o=this.units[a]).getCurrentImage().indexOf("red");o.power>0?(e.push(o),0==util.getUnitType(o)&&(t[s++]=o),i&&n++):i&&(this.enemyNextWaveCount--,this.score+=util.unitPowers[util.getUnitType(o)])}if(this.units=e,this.endOfGame=0==s||0==n&&0==this.enemyCount,this.win=s>0,this.resize(),!this.endOfGame){if(0==this.enemyNextWaveCount)this.wave++,this.enemyWaveSize+=2,this.enemyWaveCount=0,this.enemyNextWaveCount=this.enemyWaveSize,this.enemyArrivalTurn=constant.startArrival;else if(this.enemyWaveCount!=this.enemyWaveSize)if(0==this.enemyArrivalTurn&&this.enemyCount>0){var o,r=enyo.bind(this,"badEngine");(o=util.createUnit({type:util.randomUnit(this.currentlevel.stats),color:"red",heading:0,engine:r,x:constant.boardWidth-1,y:util.random(constant.boardHeight)})).value=this.currentlevel.generator(),this.units.push(o),this.enemyCount=this.enemyCount-1,this.enemyWaveCount++,this.enemyArrivalTurn=constant.startArrival}else this.enemyArrivalTurn=this.enemyArrivalTurn-1;for(a=0;a<this.units.length;a++){var l=this.units[a].engine;null!=l&&l(this.units[a],t)}}this.draw(),enyo.platform.android&&"http"!=document.location.protocol.substr(0,4)&&(document.getElementById("acanvas").style.display="none",document.getElementById("acanvas").offsetHeight,document.getElementById("acanvas").style.display="block"),this.$.wave.setContent(String("0000"+this.wave).slice(-4)),this.$.score.setContent(String("0000"+this.score).slice(-4))}},goodEngine:function(e,t){var s=util.lookForOpponent(e);if(null!=s)return e.heading=s.heading,void util.processFight(e,s.unit)},badEngine:function(e,t){var s=util.lookForOpponent(e);if(null!=s)return e.heading=s.heading,void util.processFight(e,s.unit);var n=util.nearestUnit(e,t);if(null!=n){var a=e.x-n.x,i=e.y-n.y;Math.abs(a)>Math.abs(i)?e.heading=a>0?0:2:e.heading=i>0?1:3}for(var o=util.nextPositionOnHeading(e);!util.isValidPosition(o,e);)e.heading=util.random(4),o=util.nextPositionOnHeading(e);o=util.nextPositionOnHeading(e),e.x=o.x,e.y=o.y}});