define(["sugar-web/activity/activity","sugar-web/env","worldpalette","viewpalette","l10n","tutorial"],(function(t,e,n,o,l,c){requirejs(["domReady!"],(function(i){t.setup();var a,d=document.getElementById("canvas");t.getXOColor((function(t,e){a=e})),d.style.backgroundColor=a.fill;var s=t.getDatastoreObject(),u=document.getElementById("world-button"),g=(new n.ActivityPalette(u,s),document.getElementById("view-button"));new o.ActivityPalette(g,s);$(document).ready((function(){var n=$.virtualsky({id:"starmap",projection:"stereo",keyboard:!1,showposition:!1,showstars:!0,constellations:!0,constellationlabels:!0,showplanets:!0,showplanetlabels:!0,live:!0,clock:new Date});e.getEnvironment((function(e,c){currentenv=c;var i="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18.getUILanguage():navigator.language,s=c.user?c.user.language:i;l.init(s),n.loadLanguage(s),document.getElementById("locale-date").innerHTML=s,window.addEventListener("localized",(function(){!function toLocalize(){document.getElementById("add-button").title=l.get("AddDay"),document.getElementById("minus-button").title=l.get("MinusDay"),document.getElementById("const-button").title=l.get("ToggleConst"),document.getElementById("star-button").title=l.get("ToggleStar"),document.getElementById("location-button").title=l.get("Location"),document.getElementById("world-button").title=l.get("WorldList"),document.getElementById("view-button").title=l.get("View"),document.getElementById("55.3781,-3.4360").innerHTML=l.get("Britain"),document.getElementById("23.6345,-102.5528").innerHTML=l.get("Mexico"),document.getElementById("40.4637,-3.7492").innerHTML=l.get("Spain"),document.getElementById("51.1657,10.4515").innerHTML=l.get("Germany"),document.getElementById("40.3399,127.5101").innerHTML=l.get("NorthKorea"),document.getElementById("23.8859,45.0792").innerHTML=l.get("SaudiArabia"),document.getElementById("35.9078,127.7669").innerHTML=l.get("SouthKorea"),document.getElementById("46.2276,2.2137").innerHTML=l.get("France"),document.getElementById("51.9194,19.1451").innerHTML=l.get("Poland"),document.getElementById("41.8719,12.5674").innerHTML=l.get("Italy"),document.getElementById("20.5937,78.9629").innerHTML=l.get("India"),document.getElementById("9.0820,8.6753").innerHTML=l.get("Nigeria"),document.getElementById("0.7893,113.9213").innerHTML=l.get("Indonesia"),document.getElementById("-14.2350,-51.9253").innerHTML=l.get("Brazil"),document.getElementById("54.5260,-105.2551").innerHTML=l.get("NorthAmerica"),document.getElementById("-8.7832,-55.4915").innerHTML=l.get("SouthAmerica"),document.getElementById("-8.7832,34.5085").innerHTML=l.get("Africa"),document.getElementById("-25.2744,133.7751").innerHTML=l.get("Australia"),document.getElementById("12.8797,121.7740").innerHTML=l.get("Philippines"),document.getElementById("4.2105,101.9758").innerHTML=l.get("Malaysia"),document.getElementById("36.2048,138.2529").innerHTML=l.get("Japan"),document.getElementById("39.9042,116.4074").innerHTML=l.get("China")}()})),c.objectId?t.getDatastoreObject().loadAsText((function(t,e,l){if(null==t&&null!=l){o=JSON.parse(l),a=n.setLatitude(parseFloat(o[2].split(",")[0])),d=n.setLongitude(parseFloat(o[2].split(",")[1])),n.setGeo($(a,d)).setClock(0).draw();try{document.getElementById(o[2]).style.backgroundColor="grey"}catch(t){console.log("User location used")}n.selectProjection(o[3]),document.getElementById(o[3]).style.backgroundColor="grey",0==o[0]?(document.getElementById("const-button").classList.remove("active"),n.toggleConstellationLines(),n.toggleConstellationLabels()):1==o[0]&&document.getElementById("const-button").classList.add("active"),1==o[1]&&(document.getElementById("star-button").classList.add("active"),n.toggleStarLabels())}})):(console.log("New instance"),document.getElementById(o[2]).style.backgroundColor="grey",document.getElementById(o[3]).style.backgroundColor="grey")}));var o=[!0,!1,"55.3781,-3.4360","stereo"],i=document.getElementById("worldConst").innerHTML,a=n.setLatitude(parseFloat(i.split(",")[0])),d=n.setLongitude(parseFloat(i.split(",")[1]));function userPosition(t){$("button#location-button").on("click",(function(){console.log(i);try{document.getElementById(i).style.backgroundColor="black"}catch(t){}i=t.coords.latitude+","+t.coords.longitude,a=n.setLatitude(parseFloat(i.split(",")[0])),d=n.setLongitude(parseFloat(i.split(",")[1])),n.setGeo($(a,d)).setClock(0).draw(),o[2]=i,console.log(o)}))}document.getElementById("const-button").classList.add("active"),function getUserLocation(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(userPosition)}(),$("button#add-button").on("click",(function(){n.clock.setDate(n.clock.getDate()+1),n.updateClock(n.clock),n.draw()})),$("button#minus-button").on("click",(function(){n.clock.setDate(n.clock.getDate()-1),n.updateClock(n.clock),n.draw()})),$("button#const-button").on("click",(function(){n.toggleConstellationLines(),n.toggleConstellationLabels(),1==o[0]?(document.getElementById("const-button").classList.remove("active"),o[0]=!1):(document.getElementById("const-button").classList.add("active"),o[0]=!0),console.log(o[0])})),$("button#star-button").on("click",(function(){n.toggleStarLabels(),1==o[1]?(document.getElementById("star-button").classList.remove("active"),o[1]=!1):(document.getElementById("star-button").classList.add("active"),o[1]=!0),console.log(o[1])})),$("button.country").on("click",(function(){i=document.getElementById("worldConst").innerHTML,a=n.setLatitude(parseFloat(i.split(",")[0])),d=n.setLongitude(parseFloat(i.split(",")[1])),n.setGeo($(a,d)).setClock(0).draw(),o[2]=i,console.log(o)})),$("button.view").on("click",(function(){var t=document.getElementById("projection-view").innerHTML;n.selectProjection(t),o[3]=t,n.draw(),console.log(o)})),document.getElementById("help-button").addEventListener("click",(function(t){c.start()})),document.getElementById("fullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",n.resize()})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",n.resize()})),document.getElementById("stop-button").addEventListener("click",(function(e){console.log("writing...");var n=JSON.stringify(o);t.getDatastoreObject().setDataAsText(n),t.getDatastoreObject().save((function(t){null===t?(console.log("write done."),console.log(n)):console.log("write failed.")}))}))}))}))}));