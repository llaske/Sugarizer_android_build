define(["sugar-web/activity/activity","sugar-web/env","activity/palettes/bgpalette","activity/palettes/volumepalette","activity/palettes/colorpalettefill","activity/palettes/colorpalettetext","activity/palettes/zoompalette","sugar-web/graphics/presencepalette","tutorial","sugar-web/graphics/journalchooser","sugar-web/datastore","l10n"],(function(e,t,n,o,a,r,c,i,l,s,d,u){requirejs(["domReady!"],(function(s){e.setup(),new n.BgPalette(document.getElementById("bg-button"),void 0).setBackgroundChangeCallback((function changeBoardBackgroundHelper(e){V&&V.sendMessage(V.getSharedInfo().id,{user:V.getUserInfo(),action:"changeBg",content:e});changeBoardBackground(e)}));new o.VolumePalette(document.getElementById("volume-button"),void 0),new c.ZoomPalette(document.getElementById("zoom-button"),void 0);document.getElementById("fullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.visibility="hidden",document.getElementById("game-container").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible"})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.visibility="visible",document.getElementById("game-container").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden"}));const g=new CANNON.Vec3(.3,.05,.3);g.normalize();let m,f={showNumbers:!1,presentColor:null,textColor:"#ffffff",toggleTransparent:!1,offset:new CANNON.Vec3(0,0,0),rollingForce:g,friction:.1},h=null,p={lastRoll:"",presentScore:0},b=[],y=[],v=!1;var w;let E,C,I=!1,N=!0,B=!1,getUniqueId=function(){return d.createUUID()};document.getElementById("default-button").classList.toggle("active"),t.getEnvironment((function(t,n){w=n;var o="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,a=n.user?n.user.language:o;u.init(a),window.addEventListener("localized",(function(){u.updateDocument()}),!1),f.presentColor=null!=w.user.colorvalue.fill?w.user.colorvalue.fill:f.presentColor,$.background=new THREE.Color("#ffffff"),f.textColor=null!=w.user.colorvalue.stroke?w.user.colorvalue.stroke:f.textColor,document.getElementById("color-button-fill").style.backgroundColor=f.presentColor,document.getElementById("color-button-text").style.backgroundColor=f.textColor,n.sharedId&&(V=e.getPresenceObject((function(e,t){t.onDataReceived(onNetworkDataReceived)})))}));new a.ColorPalette(document.getElementById("color-button-fill"),void 0,f),new r.ColorPalette(document.getElementById("color-button-text"),void 0,f);var onNetworkDataReceived=function(e){if(V.getUserInfo().networkId!==e.user.networkId){if("init"==e.action){if(B)return;B=!0,changeBoardBackground(e.content[1]),data=e.content[0];for(let e=0;e<data.length;e++){let t=null;switch(data[e][0]){case"cube":t=createCube;break;case"octa":t=createOctahedron;break;case"tetra":t=createTetrahedron;break;case"deca":t=createDecahedron;break;case"dodeca":t=createDodecahedron;break;case"icosa":t=createIcosahedron;break;default:continue}if(t){const n=data[e][3],o=data[e][4];t(n,data[e][5],data[e][6],data[e][1].x,data[e][1].z,!1,null,data[e][1].y,data[e][2],o,f,b,ee,$,ie,data[e][7],data[e][8],data[e][9],data[e][10])}}}if("positions"==e.action&&function copyPositions(e){for(let e=0;e<b.length;e++)$.remove(b[e][0]),ee.removeBody(b[e][1]);for(let t=0;t<b.length;t++)e[t]&&e[t][0]&&e[t][1]&&(b[t][0].position.copy(e[t][0]),b[t][1].position.copy(e[t][0]),b[t][1].quaternion.copy(e[t][1]),b[t][1].quaternion.copy(e[t][1]));for(let e=0;e<b.length;e++)$.add(b[e][0]),ee.addBody(b[e][1]);Ie=!0}(e.content),"changeBg"==e.action&&changeBoardBackground(e.content),"remove"==e.action)for(let t=0;t<b.length;t++){let n=b[t][0];if(n&&n.userData&&n.userData==e.content){remove(n);break}}else{let t=null;switch(e.content.shape){case"cube":t=createCube;break;case"octa":t=createOctahedron;break;case"tetra":t=createTetrahedron;break;case"dodeca":t=createDodecahedron;break;case"deca":t=createDecahedron;break;case"icosa":t=createIcosahedron}t&&t(e.content.color,e.content.ifNumbers,e.content.ifTransparent,e.content.xCoordinateShared,e.content.zCoordinateShared,e.content.ifImage,e.content.sharedImageData,e.content.yCoordinateShared,e.content.quaternionShared,e.content.sharedTextColor,f,b,ee,$,ie,e.content.sharedAngVel1,e.content.sharedAngVel2,e.content.sharedAngVel3,e.content.uniqueId)}}};document.getElementById("stop-button").addEventListener("click",(function(t){y.push(h);for(let e=0;e<b.length;e++)y.push([b[e][2],b[e][1].position,b[e][1].quaternion,b[e][5],b[e][6],b[e][3],b[e][4],b[e][7],b[e][8],b[e][9]]);var n=JSON.stringify(y);e.getDatastoreObject().setDataAsText(n),e.getDatastoreObject().save((function(e){null===e?console.log("write done."):console.log("write failed.")}))})),t.getEnvironment((function(t,n){w=n,n.objectId?e.getDatastoreObject().loadAsText((function(e,t,n){if(null==e&&null!=n){if((n=JSON.parse(n)).length>1)for(let e=1;e<n.length;e++){let t=n[e][3],o=n[e][4];switch(n[e][0]){case"cube":createFunction=createCube;break;case"octa":createFunction=createOctahedron;break;case"tetra":createFunction=createTetrahedron;break;case"deca":createFunction=createDecahedron;break;case"dodeca":createFunction=createDodecahedron;break;case"icosa":createFunction=createIcosahedron}createFunction&&createFunction(t,n[e][5],n[e][6],n[e][1].x,n[e][1].z,!1,null,n[e][1].y,n[e][2],o,f,b,ee,$,ie,n[e][7],n[e][8],n[e][9],getUniqueId())}changeBoardBackground(n[0])}})):console.log("New instance")})),document.getElementById("help-button").addEventListener("click",(function(e){j.adding=!1,l.start(j)}));const k=document.getElementById("red-slider-fill"),S=document.getElementById("green-slider-fill"),A=document.getElementById("blue-slider-fill");let L={r:0,g:0,b:0};function rgbToHex(e,t,n){return"#"+((1<<24)+(e<<16)+(t<<8)+n).toString(16).slice(1).toUpperCase()}function handleSliderChangeFill(){L={r:parseInt(k.value),g:parseInt(S.value),b:parseInt(A.value)},function updateColorDisplayFill(){const e=rgbToHex(L.r,L.g,L.b);f.presentColor=e,document.getElementById("color-button-fill").style.backgroundColor=f.presentColor}()}k.addEventListener("input",handleSliderChangeFill),S.addEventListener("input",handleSliderChangeFill),A.addEventListener("input",handleSliderChangeFill),document.addEventListener("color-selected-fill",(function(e){const t=e.detail.color;f.presentColor=t,document.getElementById("color-button-fill").style.backgroundColor=f.presentColor,function updateSlidersFill(e){const t=e.match(/\d+/g).map((e=>parseInt(e,10)));k.value=t[0],S.value=t[1],A.value=t[2]}(t)}));const T=document.getElementById("red-slider-text"),x=document.getElementById("green-slider-text"),O=document.getElementById("blue-slider-text");let D={r:0,g:0,b:0};function handleSliderChangeText(){D={r:parseInt(T.value),g:parseInt(x.value),b:parseInt(O.value)},function updateColorDisplayText(){const e=rgbToHex(D.r,D.g,D.b);f.textColor=e,document.getElementById("color-button-text").style.backgroundColor=f.textColor}()}T.addEventListener("input",handleSliderChangeText),x.addEventListener("input",handleSliderChangeText),O.addEventListener("input",handleSliderChangeText),document.addEventListener("color-selected-text",(function(e){const t=e.detail.color;f.textColor=t,document.getElementById("color-button-text").style.backgroundColor=f.textColor,function updateSlidersText(e){const t=e.match(/\d+/g).map((e=>parseInt(e,10)));T.value=t[0],x.value=t[1],O.value=t[2]}(t)})),document.querySelector("#throw-button").addEventListener("click",(()=>{!function throwDice(e,t){Ne=!0;for(let e=0;e<b.length;e++)$.remove(b[e][0]),ee.removeBody(b[e][1]);if(b.length>0){p.lastRoll="",p.presentScore=0;for(let e=0;e<b.length;e++)b[e][1].angularVelocity.set(b[e][7],b[e][8],b[e][9]),b[e][1].applyImpulse(f.offset,f.rollingForce),b[e][1].position.set(0,10,0);for(let e=0;e<b.length;e++)$.add(b[e][0]),ee.addBody(b[e][1])}}(),V&&V.sendMessage(V.getSharedInfo().id,{user:V.getUserInfo(),action:"positions",content:[f.offset,f.rollingForce]})})),document.querySelector("#number-button").addEventListener("click",(()=>{var e=document.getElementById("number-button");if(!f.showNumbers){if(e.classList.toggle("active"),document.getElementById("volume-button").style.backgroundImage="url(icons/number_volume.svg)",N)document.getElementById("default-button").classList.toggle("active"),N=!N;if(f.toggleTransparent)document.getElementById("transparent-button").classList.toggle("active"),f.toggleTransparent=!f.toggleTransparent;f.showNumbers=!f.showNumbers}})),document.querySelector("#transparent-button").addEventListener("click",(()=>{if(!f.toggleTransparent){if(document.getElementById("transparent-button").classList.toggle("active"),document.getElementById("volume-button").style.backgroundImage="url(icons/transparent_volume.svg)",N)document.getElementById("default-button").classList.toggle("active"),N=!N;if(f.showNumbers)document.getElementById("number-button").classList.toggle("active"),f.showNumbers=!f.showNumbers;f.toggleTransparent=!f.toggleTransparent}})),document.querySelector("#default-button").addEventListener("click",(e=>{if(!N){if(document.getElementById("default-button").classList.toggle("active"),document.getElementById("volume-button").style.backgroundImage="url(icons/default_volume.svg)",f.toggleTransparent)document.getElementById("transparent-button").classList.toggle("active"),f.toggleTransparent=!f.toggleTransparent;if(f.showNumbers)document.getElementById("number-button").classList.toggle("active"),f.showNumbers=!f.showNumbers;N=!N}}));let P={cube:!0,tetra:!1,octa:!1,dodeca:!1,deca:!1,icosa:!1};document.getElementById("cube-button").classList.toggle("active");const R=["cube","tetra","octa","dodeca","deca","icosa"],q=document.querySelector("#clear-button");q.addEventListener("click",(()=>{q.classList.contains("active")||(R.forEach((e=>{P[e]=!1,document.getElementById(`${e}-button`).classList.remove("active")})),I=!0,q.classList.add("active"))})),R.forEach((e=>{document.getElementById(`${e}-button`).addEventListener("click",(()=>{document.getElementById(`${e}-button`).classList.contains("active")||(e=>{R.forEach((t=>{P[t]=t===e,document.getElementById(`${t}-button`).classList.toggle("active",t===e)})),I=!1,q.classList.remove("active")})(e)}))}));const M=document.getElementById("roll");function updateElements(){M.textContent=p.lastRoll.substring(0,p.lastRoll.length-2)+"= "+p.presentScore}const H=new THREE.WebGLRenderer({antialias:!0,alpha:!0});H.shadowMap.enabled=!0;const F=new THREE.Raycaster,z=new THREE.Vector2;document.querySelector("body").addEventListener("click",(function onRemoveClick(e){if(I){var t=H.domElement.getBoundingClientRect();z.x=(e.clientX-t.left)/t.width*2-1,z.y=-(e.clientY-t.top)/t.height*2+1,F.setFromCamera(z,Q);var n=F.intersectObjects($.children),o=n[0]?.object;if("PlaneGeometry"==o?.geometry.type)return;V&&o&&V.sendMessage(V.getSharedInfo().id,{user:V.getUserInfo(),action:"remove",content:o.userData}),remove(o)}})),document.querySelector("#game-container").addEventListener("click",(function onAddClick(e){if(Ne=!0,!j.adding)return;if(window.isRotating)return void(window.isRotating=!1);if(!I){var t=H.domElement.getBoundingClientRect();z.x=(e.clientX-t.left)/t.width*2-1,z.y=-(e.clientY-t.top)/t.height*2+1,F.setFromCamera(z,Q);var n=F.intersectObjects($.children);for(let e=0;e<n.length;e++){var o=n[e]?.object;if("PlaneGeometry"==o.geometry.type){E=n[e].point.x,C=n[e].point.z;let t=null,o=null;if(P.cube?(t=createCube,o="cube"):P.tetra?(t=createTetrahedron,o="tetra"):P.deca?(t=createDecahedron,o="deca"):P.dodeca?(t=createDodecahedron,o="dodeca"):P.icosa?(t=createIcosahedron,o="icosa"):P.octa&&(t=createOctahedron,o="octa"),t){let e=2.9*Math.random()+.1,n=2.9*Math.random()+.1,a=2.9*Math.random()+.1,r=getUniqueId();t(null,null,null,E,C,null,null,null,null,null,f,b,ee,$,ie,e,n,a,r),V&&V.sendMessage(V.getSharedInfo().id,{user:V.getUserInfo(),content:{shape:o,color:f.presentColor,ifTransparent:f.toggleTransparent,ifNumbers:f.showNumbers,xCoordinateShared:E,zCoordinateShared:C,ifImage:v,sharedImageData:m,yCoordinateShared:null,quaternionShared:null,sharedTextColor:f.textColor,sharedAngVel1:e,sharedAngVel2:n,sharedAngVel3:a,uniqueId:r}})}}}}}));let j={adding:!0};function remove(e,t){let n=0;for(let e=0;e<b.length;e++)b[e][3]&&n++;if(null==e){if(t<b.length&&b[t][3]){let e;switch(b[t][2]){case"cube":e=getCubeScore(p,b[t][0],!0);break;case"icosa":e=getIcosaScore(p,b[t][0],!0);break;case"deca":e=getDecaScore(p,b[t][0],!0);break;case"dodeca":e=getDodecaScore(p,b[t][0],!0);break;case"octa":e=getOctaScore(p,b[t][0],!0);break;case"tetra":e=getTetraScore(p,b[t][0],!0);break;default:console.log(`Unknown type: ${b[t][3]}`)}p.presentScore=p.presentScore-e;let o=p.lastRoll.split(" + "),a=o.indexOf(e.toString());-1!==a&&o.splice(a,1),p.lastRoll=o.join(" + "),updateElements(),n--}0!=b.length&&null!=e&&(ee.removeBody(b[t][1]),$.remove(b[t][0]),b.splice(t,1))}else for(let t=0;t<b.length;t++)if(b[t][0]==e){if(b[t][3]){let e;switch(b[t][2]){case"cube":e=getCubeScore(p,b[t][0],!0);break;case"icosa":e=getIcosaScore(p,b[t][0],!0);break;case"deca":e=getDecaScore(p,b[t][0],!0);break;case"dodeca":e=getDodecaScore(p,b[t][0],!0);break;case"octa":e=getOctaScore(p,b[t][0],!0);break;case"tetra":e=getTetraScore(p,b[t][0],!0);break;default:continue}p.presentScore=p.presentScore-e;let o=p.lastRoll.split(" + "),a=o.indexOf(e.toString());-1!==a&&o.splice(a,1),p.lastRoll=o.join(" + "),updateElements(),n--}ee.removeBody(b[t][1]),$.remove(b[t][0]),b.splice(t,1)}0==n&&(M.textContent="",p.lastRoll="",p.presentScore=0)}var V=null,U=new i.PresencePalette(document.getElementById("network-button"),void 0),W=!1;U.addEventListener("shared",(function(){U.popDown(),V=e.getPresenceObject((function(e,t){e||(t.createSharedActivity("org.sugarlabs.3DVolume",(function(e){W=!0})),t.onDataReceived(onNetworkDataReceived),t.onSharedActivityUserChanged(onNetworkUserChanged))}))}));var onNetworkUserChanged=function(e){if(W){let e=[];for(let t=0;t<b.length;t++)e.push([b[t][2],b[t][1].position,b[t][1].quaternion,b[t][5],b[t][6],b[t][3],b[t][4],b[t][7],b[t][8],b[t][9],b[t][0].userData]);W&&V.sendMessage(V.getSharedInfo().id,{user:V.getUserInfo(),action:"init",content:[e,h]}),setTimeout(sendPositions,4500)}};H.setSize(window.innerWidth,window.innerHeight),document.getElementById("game-container").appendChild(H.domElement);const $=new THREE.Scene;$.background=new THREE.Color("#ffffff");const G=new THREE.DirectionalLight(16777215,.4);G.castShadow=!0;const _=new THREE.DirectionalLight(16777215,.25);_.castShadow=!0;const J=new THREE.DirectionalLight(16777215,.1);J.castShadow=!0;const X=new THREE.DirectionalLight(16777215,.1),Y=new THREE.DirectionalLight(16777215,.1),Z=new THREE.DirectionalLight(16777215,.2);Z.castShadow=!0,_.position.set(-30,20,-30),J.position.set(30,20,-30),X.position.set(0,20,30),G.position.set(0,20,-30),Y.position.set(0,-20,-30),Z.position.set(0,10,0),$.add(X),$.add(J),$.add(_),$.add(G),$.add(Y),$.add(Z);const K=new THREE.AmbientLight(2236962);$.add(K);const Q=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),ee=new CANNON.World({gravity:new CANNON.Vec3(0,-9.81,0)});ee.allowSleep=!0;var te=document.getElementById("sensor-button"),ne=!1;if(/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(navigator.userAgent)){if(window.Accelerometer){ne=!0,te.classList.add("active");var oe=new Accelerometer({frequency:500});oe&&(oe.addEventListener("reading",accelerationChanged),oe.start())}else navigator.accelerometer&&(ne=!0,te.classList.add("active"),watchId=navigator.accelerometer.watchAcceleration(accelerationChanged,null,{frequency:500}));te.addEventListener("click",(function(){if(navigator.accelerometer||window.Accelerometer)if(ne=!ne)if(te.classList.add("active"),window.Accelerometer){var e=new Accelerometer({frequency:500});e&&(e.addEventListener("reading",accelerationChanged),e.start())}else navigator.accelerometer&&(watchId=navigator.accelerometer.watchAcceleration(accelerationChanged,null,{frequency:500}));else te.classList.remove("active"),ee.gravity.set(0,-9.81,0),wakeAll()}))}function accelerationChanged(e){if(ne){var t=window.Accelerometer?e.target:e;window.orientation&&-90==window.orientation?t.y>0?t.y<-2.8?(ee.gravity.set(3,-9.81,0),wakeAll()):(ee.gravity.set(9.81,-9.81,0),wakeAll()):t.z>0?t.y>-1&&t.y<1?t.z>6?(ee.gravity.set(0,-9.81,-9.81),wakeAll()):(ee.gravity.set(0,-9.81,0),wakeAll()):t.y<-2.7?(ee.gravity.set(-3,-9.81,0),wakeAll()):(ee.gravity.set(-9.81,-9.81,0),wakeAll()):(ee.gravity.set(0,-9.81,9.81),wakeAll()):t.y>0?t.y<-2.7?(ee.gravity.set(-3,-9.81,0),wakeAll()):(ee.gravity.set(-9.81,-9.81,0),wakeAll()):t.z>0?t.y>-1&&t.y<1?t.z>6?(ee.gravity.set(0,-9.81,9.81),wakeAll()):(ee.gravity.set(0,-9.81,0),wakeAll()):t.y<-2.8?(ee.gravity.set(3,-9.81,0),wakeAll()):(ee.gravity.set(9.81,-9.81,0),wakeAll()):(ee.gravity.set(0,-9.81,-9.81),wakeAll())}}function wakeAll(){for(let e=0;e<b.length;e++)b[e][1].wakeUp()}const ae=new THREE.PlaneGeometry(30,30),re=new THREE.MeshPhongMaterial({side:THREE.DoubleSide,wireframe:!1});re.needsUpdate=!0;const ce=new THREE.Mesh(ae,re);ce.receiveShadow=!0,ce.material.color.setHex(13224393),$.add(ce);const ie=new CANNON.Material,le=(new CANNON.Box(new CANNON.Vec3(0,5,0)),new CANNON.Body({shape:new CANNON.Box(new CANNON.Vec3(15,15,.1)),type:CANNON.Body.STATIC,material:ie}));le.material.friction=0,le.material.contactEquationStiffness=1e8,le.material.contactEquationRelaxation=3,le.quaternion.setFromEuler(-Math.PI/2,0,0),ee.addBody(le);const se=new CANNON.Body({shape:new CANNON.Box(new CANNON.Vec3(15,15,.1)),type:CANNON.Body.STATIC,material:ie});se.quaternion.setFromEuler(-Math.PI/2,0,0),se.position.set(0,15,0),ee.addBody(se);const de=new CANNON.Body({shape:new CANNON.Box(new CANNON.Vec3(15,100,.1)),type:CANNON.Body.STATIC,material:ie,friction:-10,restitution:10});ee.addBody(de),de.position.set(15,0,0),de.quaternion.setFromEuler(0,-Math.PI/2,0);const ue=new CANNON.Body({shape:new CANNON.Box(new CANNON.Vec3(15,100,.1)),type:CANNON.Body.STATIC,material:ie,friction:-10,restitution:10});ee.addBody(ue),ue.position.set(-15,0,0),ue.quaternion.setFromEuler(0,-Math.PI/2,0);const ge=new CANNON.Body({shape:new CANNON.Box(new CANNON.Vec3(100,15,.1)),type:CANNON.Body.STATIC,material:ie,friction:-10,restitution:10});ee.addBody(ge),ge.position.set(0,0,15),ge.quaternion.setFromEuler(0,0,-Math.PI/2);const me=new CANNON.Body({shape:new CANNON.Box(new CANNON.Vec3(100,15,.1)),type:CANNON.Body.STATIC,material:ie,friction:-10,restitution:10});ee.addBody(me),me.position.set(0,0,-15),me.quaternion.setFromEuler(0,0,-Math.PI/2);const fe=new OrbitControls.OrbitControls(Q,H.domElement);Q.position.set(0,25,-30),fe.enableRotate=!1,fe.enablePan=!1,fe.enableZoom=!1,fe.enableDamping=!1,fe.update();const he=document.querySelector("#right-button"),pe=document.querySelector("#left-button"),be=document.querySelector("#up-button"),ye=document.querySelector("#down-button");he.addEventListener("click",(function(e){fe.rotateRight(),e.stopPropagation()})),pe.addEventListener("click",(function(e){fe.rotateLeft(),e.stopPropagation()})),be.addEventListener("click",(function(e){fe.rotateUp(),e.stopPropagation()})),ye.addEventListener("click",(function(e){fe.rotateDown(),e.stopPropagation()}));new Event("wheel",{bubbles:!0,cancelable:!0});const ve=document.getElementById("zoom-in-button"),we=document.getElementById("zoom-out-button"),Ee=document.getElementById("zoom-equal-button"),Ce=document.getElementById("zoom-to-button"),clickZoom=(e,t)=>e>=10&&"zoomIn"===t?e-5:e<=75&&"zoomOut"===t?e+5:e,getFov=()=>Math.floor(2*Math.atan(Q.getFilmHeight()/2/Q.getFocalLength())*180/Math.PI);function changeBoardBackground(e){h=e;let t=new THREE.TextureLoader;switch(e){case"green-board":t.load("images/grass_background.png",(function(e){ce.material.wireframe=!1,ce.material.map=e,ce.material.needsUpdate=!0,le.material.friction=100})),f.friction=100;break;case"wood":t.load("images/wood.png",(function(e){ce.material.wireframe=!1,ce.material.color.setHex(15779218),ce.material.map=e,ce.material.needsUpdate=!0})),f.friction=0;break;case"default":ce.material.needsUpdate=!0,ce.material.color.setHex(13224393),ce.material.wireframe=!1,ce.material.map=null,le.material.friction=1,f.friction=1}for(let e=0;e<b.length;e++){ee.removeContactMaterial(b[e][10]);let t=new CANNON.ContactMaterial(ie,b[e][1].material,{friction:f.friction});ee.addContactMaterial(t)}}function sendPositions(){let e=[];for(let t=0;t<b.length;t++)e.push([b[t][1].position,b[t][1].quaternion]);V.sendMessage(V.getSharedInfo().id,{user:V.getUserInfo(),action:"positions",content:e})}Q.fov=29,Q.updateProjectionMatrix(),ve.addEventListener("click",(e=>{const t=getFov();Q.fov=clickZoom(t,"zoomIn"),Q.updateProjectionMatrix(),e.stopPropagation()})),we.addEventListener("click",(e=>{const t=getFov();Q.fov=clickZoom(t,"zoomOut"),Q.updateProjectionMatrix(),e.stopPropagation()})),Ee.addEventListener("click",(e=>{getFov();Q.fov=29,Q.updateProjectionMatrix(),e.stopPropagation()})),Ce.addEventListener("click",(e=>{getFov();Q.fov=35,Q.updateProjectionMatrix(),e.stopPropagation()}));new CannonDebugger($,ee,{color:11393254});let Ie=!1,Ne=!1;function animate(e){ce.position.copy(le.position),ce.quaternion.copy(le.quaternion);for(let e=0;e<b.length;e++)b[e][0]?.position?.copy(b[e][1].position),b[e][0]?.quaternion?.copy(b[e][1].quaternion);0==ee.hasActiveBodies&&1==Ie&&(Ie=!1,function getScores(){p.presentScore=0,p.lastRoll="",M.textContent="";for(let e=0;e<b.length;e++)if(b[e][3]){switch(b[e][2]){case"cube":score=getCubeScore(p,b[e][0]);break;case"icosa":score=getIcosaScore(p,b[e][0]);break;case"deca":score=getDecaScore(p,b[e][0]);break;case"dodeca":score=getDodecaScore(p,b[e][0]);break;case"octa":score=getOctaScore(p,b[e][0]);break;case"tetra":score=getTetraScore(p,b[e][0]);break;default:continue}updateElements()}}(),Ne&&(Ne=!1,V&&sendPositions())),1==ee.hasActiveBodies&&(Ie=!0),H.render($,Q)}animate(),H.setAnimationLoop(animate);const Be=1/40,ke=3;setInterval((function updatePhysics(){ee.step(Be,Be*ke)}),1e3*Be),window.addEventListener("resize",(function(){Q.aspect=window.innerWidth/window.innerHeight,Q.updateProjectionMatrix(),H.setSize(window.innerWidth,window.innerHeight)}))}))}));