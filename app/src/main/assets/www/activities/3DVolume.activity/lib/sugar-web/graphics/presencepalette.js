define(["sugar-web/graphics/palette","sugar-web/env","sugar-web/activity/activity"],(function(e,t,n){"use strict";var r={},i="Private",a="Shared";t.getEnvironment((function(e,t){var n={en:"Private",fr:"Privée",es:"Privado",pt:"Particular",de:"Privat"},r={en:"Shared",fr:"Partagée",es:"Compartida",pt:"Compartilhada",de:"Freigegebenes"},s=t.user?t.user.language:navigator.language;window.addEventListener("localized",(function(e){i=n[s]||n.en,a=r[s]||r.en;var t=document.getElementById("private-text");t&&(t.innerHTML==r.en?t.innerHTML=a:t.innerHTML==n.en&&(t.innerHTML=i))}))}));var s='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>',o=!1,l=n.getPresenceObject();function generateItemForUser(e){var t=document.createElement("li");return t.setAttribute("id",e.networkId),t.innerHTML="<img style='height:30px;' src='"+function generateXOLogoWithColor(e){var t=s;return t=(t=t.replace("#010101",e.stroke)).replace("#FFFFFF",e.fill),"data:image/svg+xml;base64,"+btoa(t)}(e.colorvalue)+"'><div style='display:inline;vertical-align:super;margin-left:5px;'>"+e.name+"</div>",t}var d=Object.getPrototypeOf(l).onSharedActivityUserChanged;Object.getPrototypeOf(l).onSharedActivityUserChanged=function(e){d((function(t){var n=document.getElementById("users-list");if(n)if(t.move>0)n.appendChild(generateItemForUser(t.user));else{var r=document.getElementById(t.user.networkId);r&&n.removeChild(r)}e(t)}))},r.PresencePalette=function(n,r,s){e.Palette.call(this,n,r),this.sharedEvent=document.createEvent("CustomEvent"),this.sharedEvent.initCustomEvent("shared",!0,!0,{});var d=document.createElement("div"),c=document.createElement("span"),u=document.createElement("h4");u.setAttribute("id","private-text"),u.setAttribute("style","margin-left:10px"),u.innerHTML=i,u.className="network-text";var h=document.createElement("hr"),g=document.createElement("hr");g.setAttribute("id","hr-users");var p=document.createElement("ul");p.setAttribute("id","users-list"),p.setAttribute("style","list-style:none;padding:0;max-height:150px;margin:-7px");var v=document.createElement("button");v.className="toolbutton",v.setAttribute("id","private-button"),v.onclick=function(){b.setShared(!1)};var m=document.createElement("button");m.className="toolbutton",m.setAttribute("id","shared-button"),m.onclick=function(){b.setShared(!0),o=!0,b.getPalette().dispatchEvent(b.sharedEvent)},this.setSharedUI=function(e){var t=document.getElementById("users-list");if(t.style.margin=e?"8px 2px 8px 2px":"-7px",t.style.overflowY=e?"auto":"unset",e)u.innerHTML=a,v.disabled=!0,m.disabled=!0,n.style.backgroundImage="url(lib/sugar-web/graphics/icons/actions/zoom-neighborhood.svg)",b.getPalette().childNodes[0].style.backgroundImage="url(lib/sugar-web/graphics/icons/actions/zoom-neighborhood.svg)";else for(u.innerHTML=i,v.disabled=!1,m.disabled=!1,n.style.backgroundImage="url(lib/sugar-web/graphics/icons/actions/zoom-home.svg)",b.getPalette().childNodes[0].style.backgroundImage="url(lib/sugar-web/graphics/icons/actions/zoom-home.svg)";t.hasChildNodes();)t.removeChild(t.firstChild)},this.setShared=function(e){b.setSharedUI(e)},c.appendChild(u),d.appendChild(c),d.appendChild(h),d.appendChild(v),d.appendChild(m),d.appendChild(g),d.appendChild(p),this.setContent([d]),this.buttons=d.querySelectorAll("button");var b=this;function popDownOnButtonClick(e){b.popDown()}for(var f=0;f<this.buttons.length;f++)"shared-button"==this.buttons[f].id&&this.buttons[f].addEventListener("shared",popDownOnButtonClick);t.getEnvironment((function(e,t){t.sharedId&&(b.setSharedUI(!0),setTimeout((function(){l.listSharedActivityUsers(t.sharedId,(function(e){for(var n=document.getElementById("users-list"),r=0;r<e.length;r++)e[r].networkId!=t.user.networkId&&n.appendChild(generateItemForUser(e[r]))}))}),1500))}));setInterval((function(){o&&!l.isConnected()&&(b.setShared(!1),v.disabled=!0,m.disabled=!0)}),1500)};return r.PresencePalette.prototype=Object.create(e.Palette.prototype,{addEventListener:{value:function(e,t,n){return this.getPalette().addEventListener(e,t,n)},enumerable:!0,configurable:!0,writable:!0}}),r.PresencePalette.prototype.setShared=function(e){this.setShared(e)},r}));