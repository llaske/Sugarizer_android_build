define(["sugar-web/activity/activity","tutorial","webL10n","sugar-web/env","activity/paint-activity","activity/paint-app","sugar-web/graphics/presencepalette","activity/palettes/color-palette","activity/palettes/stamp-palette","activity/palettes/text-palette","activity/palettes/drawings-palette","activity/palettes/filters-palette","activity/buttons/size-button","activity/buttons/clear-button","activity/buttons/undo-button","activity/buttons/redo-button","activity/modes/modes-pen","activity/modes/modes-eraser","activity/modes/modes-bucket","activity/modes/modes-text","activity/modes/modes-stamp","activity/modes/modes-copy","activity/modes/modes-paste","activity/collaboration","activity/buttons/insertimage-button"],(function(t,e,a,i,n,o,p,s,c,r,d,u,l,m,g,v,P,A,y,b,w,h,f,B,I){window.PaintApp=o,PaintApp.libs.activity=t,PaintApp.palettes.presencePalette=p,PaintApp.palettes.colorPalette=s,PaintApp.palettes.stampPalette=c,PaintApp.palettes.textPalette=r,PaintApp.palettes.drawingsPalette=d,PaintApp.palettes.filtersPalette=u,PaintApp.buttons.sizeButton=l,PaintApp.buttons.clearButton=m,PaintApp.buttons.undoButton=g,PaintApp.buttons.redoButton=v,PaintApp.buttons.insertImageButton=I,PaintApp.modes.Pen=P,PaintApp.modes.Eraser=A,PaintApp.modes.Bucket=y,PaintApp.modes.Text=b,PaintApp.modes.Stamp=w,PaintApp.modes.Copy=h,PaintApp.modes.Paste=f,PaintApp.collaboration=B,requirejs(["domReady!","sugar-web/datastore","paper-core","mustache","lzstring","humane"],(function(n,o,p,s,c,r){var d;PaintApp.libs.mustache=s,PaintApp.libs.humane=r,PaintApp.libs.lzstring=c,t.setup(),initGui(),i.getEnvironment((function(t,e){d=e;var i="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,n=e.user?e.user.language:i;a.language.code=n})),document.getElementById("save-image-button").addEventListener("click",(function(){var t=document.getElementById("paint-canvas").toDataURL("image/png",1),e={mimetype:"image/png",title:a.get("PaintBy",{name:d.user.name}),activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};o.create(e,(function(){r.log(a.get("PaintImageSaved")),console.log("export done.")}),t)})),document.getElementById("stop-button").addEventListener("click",(function(e){var a={width:PaintApp.elements.canvas.width/window.devicePixelRatio,height:PaintApp.elements.canvas.height/window.devicePixelRatio,src:PaintApp.collaboration.compress(PaintApp.elements.canvas.toDataURL())},i=JSON.stringify(a);t.getDatastoreObject().setDataAsText(i),t.getDatastoreObject().save((function(t){}))})),document.getElementById("help-button").addEventListener("click",(function(t){e.start()})),window.top.sugar&&window.top.sugar.environment&&window.top.sugar.environment.sharedId||t.getDatastoreObject().loadAsText((function(t,e,a){if(null!=a){var i=JSON.parse(a);PaintApp.clearCanvas(),img=new Image,img.onload=function(){PaintApp.elements.canvas.getContext("2d").drawImage(img,0,0,i.width,i.height),PaintApp.saveCanvas()},img.src=PaintApp.collaboration.decompress(i.src)}})),window.top&&window.top.sugar&&window.top.sugar.environment&&window.top.sugar.environment.sharedId&&(PaintApp.data.isHost=!1,PaintApp.buttons.undoButton.hideGui(),PaintApp.buttons.redoButton.hideGui(),PaintApp.displayUndoRedoButtons(),PaintApp.collaboration.shareActivity())}))}));