define(["sugar-web/env","webL10n"],(function(e,t){var a,n={};function displayConnectedPeople(e){var t=document.getElementById("presence-users");e&&t&&(n={},PaintApp.data.presence.listSharedActivityUsers(PaintApp.data.presence.getSharedInfo().id,(function(e){n={};for(var t=0;t<e.length;t++){var a=e[t];n[a.networkId]=a}})))}function onSharedActivityUserChanged(e){var a=e.user.name.replace("<","&lt;").replace(">","&gt;"),n="<img style='height:30px;' src='"+function generateXOLogoWithColor(e){var t='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>';return t=(t=t.replace("#010101",e.stroke)).replace("#FFFFFF",e.fill),"data:image/svg+xml;base64,"+btoa(t)}(e.user.colorvalue)+"'>";1===e.move&&PaintApp.libs.humane.log(n+t.get("PlayerJoin",{user:a})),-1===e.move&&PaintApp.libs.humane.log(n+t.get("PlayerLeave",{user:a})),PaintApp.data.presence.listSharedActivities((function(e){for(var t=0;t<e.length;t++)e[t].id===PaintApp.data.presence.getSharedInfo().id&&displayConnectedPeople(e[t].users)}))}function sendMessage(e){var t=window.top.sugar.environment.sharedId;t||(t=PaintApp.data.presence.getSharedInfo().id),PaintApp.data.presence.sendMessage(t,{user:PaintApp.data.presence.getUserInfo(),content:e})}function compress(e){return PaintApp.data.isCompressEnabled?PaintApp.libs.lzstring.compressToUTF16(e):e}function decompress(e){return PaintApp.data.isCompressEnabled?PaintApp.libs.lzstring.decompressFromUTF16(e):e}return window.addEventListener("localized",(function(e){e.language!=a&&setTimeout((function(){t.language.code=a}),50)})),e.getEnvironment((function(e,n){var o="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language;a=n.user?n.user.language:o,t.language.code=a})),{onDataReceived:function onDataReceived(e){if(PaintApp.data.presence.getUserInfo().networkId!==e.user.networkId){PaintApp.tmp=e;e.user.name.replace("<","&lt;").replace(">","&gt;");var t="entranceToDataURLRequest "+PaintApp.data.presence.getUserInfo().networkId;switch(e.content.action){case"path":!function handlePath(e){ctx=PaintApp.elements.canvas.getContext("2d"),ctx.beginPath(),ctx.strokeStyle=e.content.data.strokeStyle,ctx.lineCap=e.content.data.lineCap,ctx.lineWidth=e.content.data.lineWidth,ctx.moveTo(e.content.data.from.x,e.content.data.from.y),ctx.lineTo(e.content.data.to.x,e.content.data.to.y),ctx.stroke()}(e);break;case"text":!function handleText(e){ctx=PaintApp.elements.canvas.getContext("2d"),ctx.font=e.content.data.font,ctx.fillStyle=e.content.data.fillStyle,ctx.textAlign=e.content.data.textAlign,ctx.fillText(e.content.data.text,e.content.data.left,e.content.data.top)}(e);break;case"drawImage":!function handleDrawImage(e){ctx=PaintApp.elements.canvas.getContext("2d");var t=new Image;t.onload=function(){ctx.drawImage(t,e.content.data.left,e.content.data.top,e.content.data.width,e.content.data.height)},t.src=e.content.data.src}(e);break;case"drawStamp":!function handleDrawStamp(e){var t="webkit";"undefined"!=typeof InstallTrigger&&(t="gecko"),ctx=PaintApp.elements.canvas.getContext("2d");var a=e.content.data.stampBase.replace("{platform}",t),n=window.location.href.split("/");n.pop(),n=n.join("/")+"/"+a;var o=new XMLHttpRequest;o.open("GET",n,!0),o.onload=function(t){if(200===o.status||0===o.status){var a=PaintApp.modes.Stamp.changeColors(o.responseText,e.content.data.color.fill,e.content.data.color.stroke),n=new Image;n.onload=function(){ctx.drawImage(n,e.content.data.left,e.content.data.top,e.content.data.width,e.content.data.height)},n.src="data:image/svg+xml;base64,"+btoa(a)}},o.send(null)}(e);break;case t:!function handleEntranceToDataURLRequest(e){try{PaintApp.data.presence.sendMessage(PaintApp.data.presence.getSharedInfo().id,{user:PaintApp.data.presence.getUserInfo(),content:{action:"entranceToDataURL",data:{width:PaintApp.elements.canvas.width/window.devicePixelRatio,height:PaintApp.elements.canvas.height/window.devicePixelRatio,src:compress(PaintApp.elements.canvas.toDataURL())}}})}catch(e){}}();break;case"entranceToDataURL":!function handleEntranceToDataURL(e){PaintApp.data.entranceToDataURL=!0,PaintApp.clearCanvas(),img=new Image,img.onload=function(){PaintApp.elements.canvas.getContext("2d").drawImage(img,0,0,e.content.data.width,e.content.data.height)},img.src=decompress(e.content.data.src)}(e);break;case"toDataURL":!function handleToDataURL(e){PaintApp.clearCanvas(),img=new Image,img.onload=function(){PaintApp.elements.canvas.getContext("2d").drawImage(img,0,0,e.content.data.width,e.content.data.height)},img.src=decompress(e.content.data.src)}(e);break;case"clearCanvas":!function handleClearCanvas(e){PaintApp.clearCanvas()}();break;case"saveCanvas":!function handleSaveCanvas(e){PaintApp.data.isHost&&PaintApp.saveCanvas()}()}}},compress:compress,decompress:decompress,shareActivity:function shareActivity(){var e=PaintApp.libs.activity;PaintApp.data.presence=e.getPresenceObject((function(e,t){if(presencepalette.popDown(),e)console.log("error");else if(PaintApp.data.isShared=!0,userSettings=t.getUserInfo(),console.log("connected"),window.top.sugar.environment.sharedId||t.createSharedActivity("org.olpcfrance.PaintActivity",(function(e){})),t.onConnectionClosed((function(e){console.log(e),console.log("Connection closed")})),t.onSharedActivityUserChanged((function(e){onSharedActivityUserChanged(e)})),t.onDataReceived(PaintApp.collaboration.onDataReceived),!PaintApp.data.isHost)var a=setInterval((function(){PaintApp.data.presence.sharedInfo.users&&(displayConnectedPeople(),PaintApp.data.requestedData||(PaintApp.data.requestedData=!0,sendMessage({action:"entranceToDataURLRequest "+PaintApp.data.presence.sharedInfo.users[0]})),clearInterval(a))}),500)}))},sendMessage:sendMessage,displayConnectedPeople:displayConnectedPeople}}));