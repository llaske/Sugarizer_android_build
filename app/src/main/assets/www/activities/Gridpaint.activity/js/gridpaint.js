var frame,cnv,hitbuffer,clearbtn,shapes=[],colors=[],cnames=["red","yellow","#ff6600","#764300","limegreen","blue","darkmagenta","black","white"],cletters=["r","y","o","n","g","b","v","k","w"],bselected=0,newcolor=cnames[bselected],changed=!1,scale=1.18,fname="sqgridpos";function appInit(){frame=document.getElementById("frame"),clearbtn=document.getElementById("clear-button"),thumbframe=document.getElementById("thumbframe"),(cnv=document.getElementById("gridcnv")).width=1024,cnv.height=748,(hitbuffer=document.getElementById("hitbuffer")).width=1024,hitbuffer.height=748;var e=location.href.split("--");3==e.length&&(fname=e[1]);for(var t=0;t<shapedefs.length;t++)newShape(shapedefs[t]);for(t=0;t<shapes.length;t++)colors.push("red");eventInit(),"edit"==mode?editMode():selectorMode(),loadPos(selected),hittestInit(),thumbsInit(),drawButtons(),clearbtn.addEventListener("click",handleClearButton)}function newShape(e){var t={};t.points=e,shapes.push(t)}function handleStart(e,t){if(e<120)handleButton(t);else{findPiece(e,t);onMove=handleMove,onEnd=handleEnd,handleMove(e,t)}}function handleMove(e,t){changed=!0;var n=findPiece(e,t);n<0||(colors[n]=newcolor,fillPiece(n),strokePiece(n))}function handleEnd(e){onMove=void 0,onUp=void 0,savePos(selected)}function handleButton(e){e>40&e<100&&selectorMode(!0);var t=Math.floor((e-110)/70);t<0||t>=cnames.length||(bselected=t,newcolor=cnames[t],drawButtons())}function hittestInit(){hitbuffer.style.visibility="hidden";var e=hitbuffer.getContext("2d");e.save(),e.translate(140,20),e.scale(scale,scale);for(var t=0;t<shapes.length;t++){var n=hexdigit(15&t),a=hexdigit(t>>4&15),o=hexdigit(t>>8&15);e.fillStyle="#"+o+"F"+a+"F"+n+"F",shapePath(t,e,!0),e.fill()}e.restore()}function findPiece(e,t){var n=hitbuffer.getContext("2d").getImageData(e,t,1,1).data;return 255!=n[3]?-1:(n[0]>>4<<8)+(n[1]>>4<<4)+(n[2]>>4)}function hexdigit(e){return"0123456789ABCDEF".charAt(e)}function fillPiece(e){var t=cnv.getContext("2d");t.save(),t.translate(140,20),t.scale(scale,scale),t.fillStyle=colors[e],shapePath(e,t),t.fill(),t.restore()}function strokePiece(e){var t=cnv.getContext("2d");t.save(),t.translate(140,20),t.scale(scale,scale),t.strokeStyle="#404040",t.lineWidth=1,shapePath(e,t),t.stroke(),t.restore()}function shapePath(e,t,n){var a=shapes[e].points;t.beginPath(),t.moveTo(a[0],a[1]);for(var o=2;o<a.length;o+=2)t.lineTo(a[o],a[o+1]);t.lineTo(a[0],a[1])}function drawButtons(){var e=cnv.getContext("2d");e.fillStyle="#f0f0f0",e.fillRect(0,0,120,700),e.strokeStyle="#505050";for(var t=0;t<cnames.length;t++)drawButton(e,t);drawSaveButton(e)}function drawButton(e,t,n){e.fillStyle=cnames[t],e.lineWidth=t==bselected?4:2,roundRectPath(e,45,110+70*t,30,30),e.fill(),e.stroke()}function roundRectPath(e,t,n,a,o){e.beginPath(),e.moveTo(t+4,n),e.lineTo(t+a-4,n),e.quadraticCurveTo(t+a,n,t+a,n+4),e.lineTo(t+a,n+o-4),e.quadraticCurveTo(t+a,n+o,t+a-4,n+o),e.lineTo(t+4,n+o),e.quadraticCurveTo(t,n+o,t,n+o-4),e.lineTo(t,n+4),e.quadraticCurveTo(t,n,t+4,n)}function drawSaveButton(e){var t=document.getElementById("back"),n=e.createPattern(t,"no-repeat");e.fillStyle=n,e.beginPath(),e.fillRect(0,25,95,55),e.fill(),e.stroke()}function handleClearButton(){for(var e in colors)colors[e]="white",fillPiece(e),strokePiece(e)}