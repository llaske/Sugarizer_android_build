requirejs.config({baseUrl:"lib",paths:{activity:"../js"}});var app=new Vue({el:"#app",components:{"polls-grid":PollsGrid,"poll-stats":PollStats,vote:Vote,history:History,"poll-settings":PollSettings},data:{currentUser:{},networkError:!1,settings:!1,currentView:"",searchText:"",polls:[{id:0,type:"",typeVariable:"YesNo",image:"images/yesno.png",question:"DefaultPollYesNo",results:null},{id:1,type:"",typeVariable:"Rating",image:"images/rating.png",question:"DefaultPollRating",results:null},{id:2,type:"",typeVariable:"MCQ",image:"images/mcq.png",question:"DefaultPollMCQ",options:["DefaultPollMCQOption0","DefaultPollMCQOption1","DefaultPollMCQOption2","DefaultPollMCQOption3","DefaultPollMCQOption4","DefaultPollMCQOption5","DefaultPollMCQOption6"],results:null},{id:3,type:"",typeVariable:"Text",image:"images/text.png",question:"DefaultPollText",results:null},{id:4,type:"",typeVariable:"ImageMCQ",image:"images/image-mcq.png",question:"DefaultPollImageMCQ",options:["images/dog.png","images/cat.png","images/dolphin.png","images/panda.png","images/bear.png","images/rabbit.png"],results:null}],connectedUsers:{},counts:{answersCount:0,usersCount:0},hostContext:null,activePoll:null,activePollStatus:"",autoStop:!1,firstPollCompleted:!1,realTimeResults:!1,history:[],openHistoryIndex:null,exporting:"",SugarPresence:null,l10n:{stringHome:"",stringSearch:"",stringSettings:"",stringAdd:"",stringRealTimeResults:"",stringAutoStop:"",stringHistory:"",stringDeletePoll:"",stringExport:"",stringFullscreen:"",stringUnfullscreen:"",stringTutoSettingsPollCardTitle:"",stringTutoSettingsPollCardContent:"",stringTutoSettingsEditButtonTitle:"",stringTutoSettingsEditButtonContent:"",stringTutoSettingsDeleteButtonTitle:"",stringTutoSettingsDeleteButtonContent:"",stringTutoSettingsPlayButtonTitle:"",stringTutoSettingsPlayButtonContent:"",stringTutoSettingsAddButtonTitle:"",stringTutoSettingsAddButtonContent:"",stringTutoSettingsImageEditButtonTitle:"",stringTutoSettingsImageEditButtonContent:"",stringTutoSettingsQuestionTitle:"",stringTutoSettingsQuestionContent:"",stringTutoSettingsTypeTitle:"",stringTutoSettingsTypeContent:"",stringTutoSettingsAddOptionButtonTitle:"",stringTutoSettingsAddOptionButtonContent:"",stringTutoSettingsOptionTitle:"",stringTutoSettingsOptionContent:"",stringTutoExplainTitle:"",stringTutoExplainContent:"",stringTutoPollCardTitle:"",stringTutoPollCardContent:"",stringTutoPollSearchTitle:"",stringTutoPollSearchContent:"",stringTutoSettingsButtonTitle:"",stringTutoSettingsButtonContent:"",stringTutoHistoryButtonTitle:"",stringTutoHistoryButtonContent:"",stringTutoNetworkButtonTitle:"",stringTutoNetworkButtonContent:"",stringTutoHistoryItemTitle:"",stringTutoHistoryItemContent:"",stringTutoHomeButtonTitle:"",stringTutoHomeButtonContent:"",stringTutoExportButtonTitle:"",stringTutoExportButtonContent:"",stringTutoDeleteButtonTitle:"",stringTutoDeleteButtonContent:"",stringTutoPollStatsTitle:"",stringTutoPollStatsContent:"",stringTutoPollFooterTitle:"",stringTutoPollFooterContent:"",stringTutoStopPollTitle:"",stringTutoStopPollContent:"",stringTutoRealTimeButtonTitle:"",stringTutoRealTimeButtonContent:"",stringTutoAutoStopButtonTitle:"",stringTutoAutoStopButtonContent:""}},computed:{searchQuery(){return this.searchText.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},watch:{currentView:function(t,e){for(var s of document.getElementsByClassName("palette"))s.style.visibility="hidden";this.searchText=""},settings:function(t,e){!t&&this.SugarPresence.isShared()&&this.updateHostContextForConnected()}},mounted(){this.SugarPresence=this.$refs.SugarPresence},methods:{initialized(){let t=this.$refs.SugarActivity.getEnvironment();this.$set(this.currentUser,"colorvalue",t.user.colorvalue),this.$set(this.currentUser,"name",t.user.name),this.$set(this.currentUser,"networkId",t.user.networkId),this.$set(this.currentUser,"handRaised",!1),this.$set(this.currentUser,"answer",null)},localized(){this.$refs.SugarL10n.localize(this.l10n);for(let t of this.polls)if(t.type=this.$refs.SugarL10n.get(t.typeVariable),t.question=this.$refs.SugarL10n.get(t.question),"MCQ"==t.typeVariable)for(let e=0;e<t.options.length;e++)t.options[e]=this.$refs.SugarL10n.get(t.options[e])},startPoll(t){if(!this.SugarPresence.isConnected())return void this.$refs.SugarPopup.log(this.$refs.SugarL10n.get("NetworkError"));let e=this.polls.findIndex((e=>e.id==t));this.activePoll=this.polls[e],this.activePollStatus="running",this.currentView="poll-stats",document.getElementById("shared-button").click(),Object.keys(this.connectedUsers).length>0&&this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"start-poll",data:{activePoll:this.activePoll}}})},stopPoll(){this.activePollStatus="finished",this.firstPollCompleted||(this.firstPollCompleted=!0,this.autoStop=!0),this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"stop-poll"}})},clearPoll(){this.activePoll=null,this.activePollStatus="",this.currentUser.answer=null,this.currentUser.handRaised=!1},onUpdatePolls(t){this.polls=t},onPollAdded(t){this.settings=!1,this.currentView="polls-grid"},switchRealTimeResults(){this.realTimeResults=!this.realTimeResults,this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"switch-real-time",data:{realTimeResults:this.realTimeResults}}})},onHandRaiseSwitched(t){this.$set(this.currentUser,"handRaised",t),this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"hand-raise-switched",data:{value:t}}})},onVoteSubmitted(t){this.$set(this.currentUser,"answer",t),this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"vote-submitted",data:{answer:t}}})},updateCounts(t){this.counts.answersCount=t.answersCount,this.counts.usersCount=t.usersCount},updateResults(t){this.activePoll.results=new Object,this.$set(this.activePoll.results,"answers",t),this.$set(this.activePoll.results,"counts",JSON.parse(JSON.stringify(this.counts))),this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"update-results",data:{results:this.activePoll.results}}})},saveToHistory(){this.history.push({...this.activePoll,endTime:Date.now()}),this.updateHostContextForConnected()},setOpenHistoryIndex(t){this.openHistoryIndex=t},deleteHistoryPoll(){this.history.splice(this.openHistoryIndex,1),this.openHistoryIndex=null},onAddClick(){this.currentView="poll-settings"},editPoll:function(t){let e=this.polls.findIndex((e=>e.id==t));this.activePoll=this.polls[e],this.activePollStatus="editing",this.currentView="poll-settings"},goBackTo(t){if("polls-grid"==t){this.activePoll=null,this.activePollStatus="",this.SugarPresence.isShared()&&(this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"clear-poll"}}),this.removeUsersNotConnected());for(let t in this.connectedUsers)this.$set(this.connectedUsers[t],"answer",null),this.$set(this.connectedUsers[t],"handRaised",!1);this.counts.answersCount=0;for(let t of this.polls)this.$set(t,"results",null)}this.currentView=t},removeUsersNotConnected(){let t={},e=this.SugarPresence.presence.sharedInfo.id,s=this;this.SugarPresence.presence.listSharedActivityUsers(e,(function(e){for(var n=0;n<e.length;n++)t[e[n].networkId]=!0;for(let e in s.connectedUsers)t[e]||s.$delete(s.connectedUsers,e)}))},updateHostContextForConnected(){let t={id:this.currentUser.networkId,polls:this.polls,realTimeResults:this.realTimeResults,autoStop:this.autoStop,history:this.history};this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"update-host-context",data:{hostContext:t}}})},onExportFormatSelected:function(t){this.exporting=t.format},onJournalDataLoaded:function(t,e){this.polls=t.polls,this.realTimeResults=t.realTimeResults,this.history=t.history,this.currentView="polls-grid"},onJournalNewInstance:function(t){this.currentView="polls-grid",this.saveContextToJournal()},onJournalSharedInstance:function(){this.currentView="vote",this.activePollStatus="no-host"},onNetworkDataReceived:function(t){switch(t.content.action){case"init-new":this.activePoll=t.content.data.activePoll,this.activePollStatus=t.content.data.activePollStatus,this.realTimeResults=t.content.data.realTimeResults,this.hostContext=t.content.data.hostContext;break;case"init-existing":null==this.activePoll&&(this.activePoll=t.content.data.activePoll,this.activePollStatus=t.content.data.activePollStatus,this.realTimeResults=t.content.data.realTimeResults,this.counts.answersCount=t.content.data.counts.answersCount,this.counts.usersCount=t.content.data.counts.usersCount,this.currentUser.handRaised=t.content.data.handRaised,t.content.data.answer&&(this.currentUser.answer=t.content.data.answer),this.hostContext=t.content.data.hostContext);break;case"switch-real-time":this.realTimeResults=t.content.data.realTimeResults;break;case"hand-raise-switched":this.SugarPresence.isHost&&(this.connectedUsers[t.user.networkId].handRaised=t.content.data.value);break;case"vote-submitted":this.SugarPresence.isHost&&(this.connectedUsers[t.user.networkId].answer=t.content.data.answer);break;case"update-counts":this.counts.answersCount=t.content.data.counts.answersCount,this.counts.usersCount=t.content.data.counts.usersCount;break;case"update-results":this.activePoll.results=t.content.data.results;break;case"start-poll":this.activePoll=t.content.data.activePoll,this.activePollStatus="running";break;case"stop-poll":this.activePollStatus="finished";break;case"clear-poll":this.clearPoll();break;case"restore-host":if(this.clearPoll(),this.currentUser.networkId==t.content.data.hostContext.id){this.history=t.content.data.hostContext.history,this.polls=t.content.data.hostContext.polls,this.realTimeResults=t.content.data.hostContext.realTimeResults,this.autoStop=t.content.data.hostContext.autoStop;let e=this.SugarPresence.presence.sharedInfo.id;this.SugarPresence.presence.listSharedActivityUsers(e,(t=>{for(var e=0;e<t.length;e++)t[e].networkId!=this.currentUser.networkId&&(this.$set(this.connectedUsers,t[e].networkId,t[e]),this.$set(this.connectedUsers[t[e].networkId],"handRaised",!1),this.$set(this.connectedUsers[t[e].networkId],"answer",null));this.SugarPresence.isHost=!0,this.currentView="polls-grid"}))}break;case"update-host-context":this.SugarPresence.isHost||(this.hostContext=t.content.data.hostContext)}},onNetworkUserChanged:function(t){if(1==t.move){if(this.SugarPresence.isHost){let e={id:this.currentUser.networkId,polls:this.polls,realTimeResults:this.realTimeResults,autoStop:this.autoStop,history:this.history};null!=this.connectedUsers[t.user.networkId]?null!=this.connectedUsers[t.user.networkId].answer?this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"init-existing",data:{activePoll:this.activePoll,activePollStatus:this.activePollStatus,realTimeResults:this.realTimeResults,counts:this.counts,handRaised:this.connectedUsers[t.user.networkId].handRaised,answer:this.connectedUsers[t.user.networkId].answer,hostContext:e}}}):this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"init-existing",data:{activePoll:this.activePoll,activePollStatus:this.activePollStatus,realTimeResults:this.realTimeResults,counts:this.counts,handRaised:this.connectedUsers[t.user.networkId].handRaised,hostContext:e}}}):(this.$set(this.connectedUsers,t.user.networkId,t.user),this.$set(this.connectedUsers[t.user.networkId],"handRaised",!1),this.$set(this.connectedUsers[t.user.networkId],"answer",null),this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"init-new",data:{activePoll:this.activePoll,activePollStatus:this.activePollStatus,realTimeResults:this.realTimeResults,hostContext:e}}}))}else if(!this.SugarPresence.isHost&&this.hostContext.id==t.user.networkId){let t=this.SugarPresence.presence.sharedInfo.id;this.SugarPresence.presence.listSharedActivityUsers(t,(t=>{if(0==t.length)return;let e=t[0].networkId;this.currentUser.networkId==e&&(this.SugarPresence.sendMessage({user:this.SugarPresence.getUserInfo(),content:{action:"restore-host",data:{hostContext:this.hostContext}}}),this.clearPoll())}))}}else this.SugarPresence.isHost&&null==this.connectedUsers[t.user.networkId].answer&&this.$delete(this.connectedUsers,t.user.networkId),this.SugarPresence.isHost||t.user.networkId!=this.hostContext.id||(this.clearPoll(),this.activePollStatus="no-host")},fullscreen:function(){this.$refs.SugarToolbar.hide()},unfullscreen:function(){this.$refs.SugarToolbar.show()},onHelp(){let t=[];if(this.settings)t=t.concat([{element:".poll-card[id='0']",position:"right",title:this.l10n.stringTutoSettingsPollCardTitle,intro:this.l10n.stringTutoSettingsPollCardContent},{element:"#edit-button",position:"right",title:this.l10n.stringTutoSettingsEditButtonTitle,intro:this.l10n.stringTutoSettingsEditButtonContent},{element:"#delete-button",position:"right",title:this.l10n.stringTutoSettingsDeleteButtonTitle,intro:this.l10n.stringTutoSettingsDeleteButtonContent},{element:"#settings-button",position:"bottom",title:this.l10n.stringTutoSettingsPlayButtonTitle,intro:this.l10n.stringTutoSettingsPlayButtonContent},{element:"#add-button",position:"bottom",title:this.l10n.stringTutoSettingsAddButtonTitle,intro:this.l10n.stringTutoSettingsAddButtonContent},{element:"#image-edit-button",position:"bottom",title:this.l10n.stringTutoSettingsImageEditButtonTitle,intro:this.l10n.stringTutoSettingsImageEditButtonContent},{element:"#question",position:"bottom",title:this.l10n.stringTutoSettingsQuestionTitle,intro:this.l10n.stringTutoSettingsQuestionContent},{element:"#type",position:"bottom",title:this.l10n.stringTutoSettingsTypeTitle,intro:this.l10n.stringTutoSettingsTypeContent},{element:".add-option-button",position:"top",title:this.l10n.stringTutoSettingsAddOptionButtonTitle,intro:this.l10n.stringTutoSettingsAddOptionButtonContent},{element:".option[id='0']",position:"top",title:this.l10n.stringTutoSettingsOptionTitle,intro:this.l10n.stringTutoSettingsOptionContent}]);else switch(this.currentView){case"polls-grid":t=t.concat([{orphan:!0,position:"bottom",title:this.l10n.stringTutoExplainTitle,intro:this.l10n.stringTutoExplainContent},{element:".poll-card[id='0']",position:"right",title:this.l10n.stringTutoPollCardTitle,intro:this.l10n.stringTutoPollCardContent},{element:".search-input",position:"bottom",title:this.l10n.stringTutoPollSearchTitle,intro:this.l10n.stringTutoPollSearchContent},{element:"#settings-button",position:"bottom",title:this.l10n.stringTutoSettingsButtonTitle,intro:this.l10n.stringTutoSettingsButtonContent},{element:"#history-button",position:"bottom",title:this.l10n.stringTutoHistoryButtonTitle,intro:this.l10n.stringTutoHistoryButtonContent},{element:"#network-button",position:"bottom",title:this.l10n.stringTutoNetworkButtonTitle,intro:this.l10n.stringTutoNetworkButtonContent}]);break;case"history":t=t.concat([{element:".history-itemx[id='0']",position:"bottom",title:this.l10n.stringTutoHistoryItemTitle,intro:this.l10n.stringTutoHistoryItemContent},{element:"#home-button",position:"bottom",title:this.l10n.stringTutoHomeButtonTitle,intro:this.l10n.stringTutoHomeButtonContent},{element:"#export-button",position:"bottom",title:this.l10n.stringTutoExportButtonTitle,intro:this.l10n.stringTutoExportButtonContent},{element:"#delete-button",position:"bottom",title:this.l10n.stringTutoDeleteButtonTitle,intro:this.l10n.stringTutoDeleteButtonContent}]);break;case"poll-stats":t=t.concat([{element:"#stats",position:"right",title:this.l10n.stringTutoPollStatsTitle,intro:this.l10n.stringTutoPollStatsContent},{element:".poll-footer",position:"top",title:this.l10n.stringTutoPollFooterTitle,intro:this.l10n.stringTutoPollFooterContent},{element:"#stop-poll",position:"bottom",title:this.l10n.stringTutoStopPollTitle,intro:this.l10n.stringTutoStopPollContent},{element:"#real-time-button",position:"bottom",title:this.l10n.stringTutoRealTimeButtonTitle,intro:this.l10n.stringTutoRealTimeButtonContent},{element:"#auto-stop-button",position:"bottom",title:this.l10n.stringTutoAutoStopButtonTitle,intro:this.l10n.stringTutoAutoStopButtonContent}])}this.$refs.SugarTutorial.show(t)},saveContextToJournal(){var t={polls:this.polls,realTimeResults:this.realTimeResults,history:this.history};this.$refs.SugarJournal.saveData(t)},onStop(){this.saveContextToJournal()}}});