define(["picoModal","sugar-web/datastore","sugar-web/graphics/icon","mustache","sugar-web/env","sugar-web/graphics/radiobuttonsgroup"],(function(e,t,a,n,i,o){var r={},s=null,l=[];i.getEnvironment((function(e,t){s=t.user;for(var a=0;s.activities&&a<s.activities.length;a++){var n=s.activities[a];l[n.id]=n}})),r.featureLocalJournal={};var c=r.featureLocalJournal;c.id="journal-button",c.title="$titleJournal",c.placeholder="$holderSearchJournal",c.icon="lib/sugar-web/graphics/icons/actions/activity-journal.svg",c.beforeActivate=function(){c.isFavorite=!1,document.getElementById("favorite-button").style.backgroundImage="url(lib/sugar-web/graphics/icons/emblems/favorite.svg)",journalFill.apply(null,c.filters)},c.beforeUnactivate=function(){},c.onFavorite=function(){var e=document.getElementById("favorite-button");c.isFavorite?e.style.backgroundImage="url(lib/sugar-web/graphics/icons/emblems/favorite.svg)":a.colorize(e,s.colorvalue,(function(){})),c.isFavorite=!c.isFavorite,journalFill.apply(null,c.filters)},c.onScroll=function(){},c.onSearch=function(){journalFill.apply(null,c.filters)},c.onCancelSearch=function(){journalFill.apply(null,c.filters)};var u={id:"abecedarium-button",title:"$titleAbecedarium",placeholder:"$holderSearchAbecedarium",icon:"lib/sugar-web/graphics/icons/actions/activity-abecedarium.svg"};u.beforeActivate=function(){document.getElementById("favorite-button").style.visibility="hidden",function abecedariumInit(e){u.database={},document.getElementById("journal-empty").style.visibility="visible",u.baseURL=document.location.href.substr(0,document.location.href.indexOf("/activities/"))+"/activities/Abecedarium.activity/",u.lang=-1!=["en","es","fr"].indexOf(s.language)?s.language:"en",u.filelocation=u.filelocation.replace("{{lang}}",u.lang);var loadDatabase=function(e,t,a){var n=new XMLHttpRequest,i=u.baseURL+e;n.onload=function(){"ping"==t?u.database[t]=0==this.status||this.status>=200&&this.status<300:(0==this.status||this.status>=200&&this.status<300)&&(u.database[t]=JSON.parse(this.responseText)),a()},n.onerror=function(){"ping"==t&&(u.database[t]=!1,a())},n.open("GET",i),n.send()};loadDatabase("database/db_url.json","url",(function(){loadDatabase("database/db_meta.json","meta",(function(){loadDatabase("database/db_"+u.lang+".json","words",(function(){loadDatabase("images/database/_ping.png?"+(new Date).getTime(),"ping",(function(){for(var t=u.database.meta.length,a=[],n=0;n<t;n++)u.database.meta[n][u.lang]&&a.push({code:u.database.meta[n].code,text:u.database.words[u.database.meta[n].text]});a.sort((function(e,t){return e.text.localeCompare(t.text,"en",{sensitivity:"base"})}));var i=[];for(n=0;n<a.length;n++)a[n].i=i.length,i.push(a[n]);u.database.content=i,delete u.database.meta,delete u.database.words,e()}))}))}))}))}(abecedariumFill)},u.beforeUnactivate=function(){document.getElementById("favorite-button").style.visibility="visible"},u.onFavorite=function(){},u.onScroll=function(){var e=document.getElementById("journal-container");e.scrollTop/(e.scrollHeight-e.clientHeight)>.9&&(u.resultCount+=30,abecedariumDisplay(u.results,u.resultCount))},u.onSearch=function(){abecedariumFill()},u.onCancelSearch=function(){abecedariumFill()},r.featurePhoto={};var d,m,g=r.featurePhoto;function journalFill(e,a,i,o){var r=[];e&&r.push(e),a&&r.push(a),i&&r.push(i),o&&r.push(o);for(var s=t.find(),u=[],g=0;g<s.length;g++){var f=s[g],p=!0;c.isFavorite&&(p=p&&f.metadata.keep);var h=document.getElementById("search-text").value;h&&h.length>0&&(p=p&&f.metadata.title&&-1!=f.metadata.title.indexOf(h)),p&&u.push(f)}var b=r.length,v=u;if(b>0){v=[];for(g=0;g<u.length;g++){f=u[g],p=!1;for(var y=0;y<b;y++)p=p||journalFilterMatch(f,r[y]);p&&v.push(f)}}for(s={entries:v.sort((function(e,t){return parseInt(t.metadata.timestamp)-parseInt(e.metadata.timestamp)}))},g=0;g<s.entries.length;g++){f=s.entries[g];var x=l[f.metadata.activity];f.imageUrl="../../"+x.directory+"/"+x.icon,f.index=g,f.ago=timestampToElapsedString(f.metadata.creation_time)}var E=n.render("\t\t\t{{#entries}}\t\t\t<div id='entry_{{index}}' style='height:60px'>\t\t\t\t<div id='eicon_{{index}}' class='toolbutton' style='background-image:url({{imageUrl}});background-size:40px 40px;width:40px;height:40px;display:inline-block;margin-left:20px;margin-top:5px;'></div>\t\t\t\t<div id='etext_{{index}}' style='color:black;display:inline-block;vertical-align:middle;margin-left:30px;height:60px;margin-top:10px;font-weight:bold;font-size:14px;'>{{metadata.title}}</div>\t\t\t\t<div id='edate_{{index}}' style='color:black;vertical-align:baseline;text-align:right;float:right;height:45px;padding-top:15px;margin-right:10px;clear:right;font-weight:normal;font-size:14px;'>{{ago}}</div>\t\t\t</div>\t\t\t{{/entries}}\t\t",s);document.getElementById("journal-container").innerHTML=E;for(g=0;g<s.entries.length;g++){(f=document.getElementById("entry_"+g)).addEventListener("click",(function(e){var t=e.target.id;t=t.substr(t.indexOf("_")+1),document.getElementById("entry_"+t).style.backgroundColor="#808080",delete(m=s.entries[t]).ago,delete m.index,delete m.imageUrl,window.setTimeout((function(){d.close(m)}),200)}))}document.getElementById("journal-empty").style.visibility=0!=s.entries.length?"hidden":"visible"}function journalEntryMatch(e,t,a){var n=e[t];if(!n)return!1;var i=a[0];return"%"==i?-1!=n.indexOf(a.substr(1)):">"==i?parseInt(n)>parseInt(a.substr(1)):"<"==i?parseInt(n)<parseInt(a.substr(1)):n==a}function journalFilterMatch(e,t){for(var a=e.metadata,n=Object.keys(t),i=!0,o=0;o<n.length;o++){var r=n[o],s=t[r];if(s instanceof Array){for(var l=!1,c=0;c<s.length;c++)l=l||journalEntryMatch(a,r,s[c]);i=i&&l}else i=i&&journalEntryMatch(a,r,s)}return i}function abecedariumFill(){var e=u.database.content,t=document.getElementById("search-text").value.toLowerCase();if(t.length){e=[];for(var a=0;a<u.database.content.length;a++)-1!=u.database.content[a].text.toLowerCase().indexOf(t)&&e.push(u.database.content[a])}u.results=e,u.resultCount=30,abecedariumDisplay(e,u.resultCount)}function abecedariumDisplay(e,t){var a={items:e.slice(0,t)},i=n.render("\t\t\t{{#items}}\t\t\t<div id='entry_{{i}}' style='height:60px'>\t\t\t\t<div id='eicon_{{i}}' class='toolbutton' style='background-image:url(../../activities/MediaViewer.activity/activity/activity-icon.svg);background-size:40px 40px;width:40px;height:40px;display:inline-block;margin-left:20px;margin-top:5px;'></div>\t\t\t\t<div id='etext_{{i}}' style='color:black;display:inline-block;vertical-align:middle;margin-left:30px;height:60px;margin-top:10px;font-weight:bold;font-size:14px;'>{{text}}</div>\t\t\t</div>\t\t\t{{/items}}\t\t",a);document.getElementById("journal-empty").style.visibility=0!=e.length?"hidden":"visible",document.getElementById("journal-container").innerHTML=i;for(var o=Math.min(t,e.length),r=0;r<o;r++){document.getElementById("entry_"+e[r].i).addEventListener("click",(function(e){var t=e.target.id;t=t.substr(t.indexOf("_")+1),document.getElementById("entry_"+t).style.backgroundColor="#808080",abecedariumCreateEntry(u.database.content[t],(function(){d.close(m)}))})),"image/png"==u.mimetype&&(document.getElementById("eicon_"+e[r].i).style.backgroundImage="url("+(u.database.ping?u.baseURL:u.database.url)+"images/database/"+e[r].code+".png)")}}function abecedariumCreateEntry(e,a){var n=u.database.ping?u.baseURL:u.database.url,i=u.mimetype,o=new XMLHttpRequest;o.open("GET",n+u.filelocation+e.code+u.fileformat,!0),o.setRequestHeader("Content-type",i),o.responseType="arraybuffer";o.onload=function(){if(200==o.status||0==o.status){var n=new Uint8Array(this.response),r="data:"+i+";base64,"+function toBase64(e){for(var t,a=(3-e.length%3)%3,n="",i=e.length,o=0,r=0;r<i;r++)t=r%3,o|=e[r]<<(16>>>t&24),2!==t&&e.length-r!=1||(n+=String.fromCharCode(uint6ToB64(o>>>18&63),uint6ToB64(o>>>12&63),uint6ToB64(o>>>6&63),uint6ToB64(63&o)),o=0);return 0===a?n:n.substring(0,n.length-a)+(1===a?"=":"==")}(n),s={mimetype:i,title:e.text+u.fileformat,activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};t.create(s,(function(t,n){console.log("Entry '"+e.text+"' saved in journal."),m={metadata:s,objectId:n},a()}),r)}else console.log("Error loading entry '"+e.code+"'."),a()},o.onerror=function(){console.log("Error loading entry '"+e.code+"'."),a()},o.send()}g.id="photo-button",g.title="$titlePhoto",g.placeholder="",g.icon="lib/sugar-web/graphics/icons/actions/photo.svg",g.beforeActivate=function(){if(window.cordova||window.PhoneGap)navigator.camera.getPicture((function(e){var t="data:image/jpeg;base64,"+e;g.createJournalEntry(t,(function(){d.close()}))}),(function(e){d.close()}),{quality:50,targetWidth:640,targetHeight:480,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA});else try{var e=document.createElement("video");e.id="videocapture",e.style.zIndex="300",e.setAttribute("controls",!1),e.setAttribute("autoplay","true"),e.style.width="100%",e.style.top="0px",e.style.position="absolute";var t=document.getElementById("journal-container");t.appendChild(e),navigator.mediaDevices.getUserMedia({video:!0}).then((function(a){e.srcObject=a,setTimeout((function(){var n=document.createElement("canvas");n.width=320,n.height=240,n.getContext("2d").drawImage(e,0,0,320,240);var i=n.toDataURL("image/png");g.createJournalEntry(i,(function(){d.isVisible()&&d.close(),a.getTracks().forEach((function(e){e.stop()})),t.removeChild(e)}))}),2700)})).catch((function(a){d.close(),t.removeChild(e)}))}catch(e){d.close()}},g.beforeUnactivate=function(){},g.onFavorite=function(){},g.onScroll=function(){},g.onSearch=function(){},g.onCancelSearch=function(){},g.createJournalEntry=function(e,a){var n={mimetype:"image/jpeg",title:doLocalize("$photoName",{name:s.name}),activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};t.create(n,(function(e,t){null==e&&(m={metadata:n,objectId:t}),a&&a()}),e)},r.features=[],r.currentFeature=-1,r.init=function(){r.features=[c],r.currentFeature=0},r.show=function(t,n,i,l,c){m=null,r.init();for(var f=[n,i,l,c],p=0;p<f.length;p++)if(f[p]){if("image/png"==f[p].mimetype){u.fileformat=".png",u.mimetype="image/png",u.filelocation="images/database/",r.features.push(u),r.features.push(g);break}if("audio/mpeg"==f[p].mimetype){u.fileformat=".mp3",u.mimetype="audio/mpeg",u.filelocation="audio/{{lang}}/database/",r.features.push(u);break}}var h="<div id='pictotoolbar' class='toolbar' style='padding: 0'>";for(p=0;p<r.features.length;p++)h+="<button class='toolbutton"+(0==p?" active":"")+"' id='"+r.features[p].id+"' title='"+r.features[p].title+"' style='background-image: url("+r.features[p].icon+")'></button>";h+="<button class='toolbutton pull-right' id='close-button' title='$titleClose' style='background-image: url(lib/sugar-web/graphics/icons/actions/dialog-cancel.svg)'></button>",d=e({content:doLocalize((h+="<div style='position: absolute; display: inline-block; margin-left: 10px; top: 20px; height:55px'>$titleChoose</div></div>")+"\t\t\t\t<div class='toolbar' style='border-top-style: solid; border-color: #c0c0c0; border-width: 1px'>\t\t\t\t\t<span class='icon-input' style='vertical-align:top;'>\t\t\t\t\t<input id='search-text' type='text' style='width: 200px; font-size: 10pt'/>\t\t\t\t\t<button id='cancel-search' class='cancel right'></button>\t\t\t\t\t</span>\t\t\t\t\t<button class='toolbutton' id='favorite-button' title='$titleFavorite' style='background-image: url(lib/sugar-web/graphics/icons/emblems/favorite.svg)'></button>\t\t\t\t</div>\t\t\t\t<div id='journal-empty' style='position:absolute;width:100%;top:50%;left:50%'>\t\t\t\t\t<div style='width:60px;height:60px;background-repeat: no-repeat;background-image: url(lib/sugar-web/graphics/icons/actions/activity-journal.svg)'></div>\t\t\t\t\t<div style='text-align:left!important;margin-left:-30px;color:#808080;text-align:center;font-size:14px;'>$noMatchingEntries</div>\t\t\t\t</div>\t\t\t\t<div id='journal-container' style='width: 100%; overflow:auto'></div>"),closeButton:!1,modalStyles:{backgroundColor:"white",height:"400px",width:"600px",maxWidth:"90%"}}).afterShow((function(e){var t=s.colorvalue;a.colorize(document.getElementById(r.features[r.currentFeature].id),t,(function(){}));for(var u=[],d=0;d<r.features.length;d++){var g=document.getElementById(r.features[d].id);u.push(g),g.addEventListener("click",(function(e){for(var o=-1,s=0;s<r.features.length;s++)if(r.features[s].id==e.srcElement.id){o=s;break}o!=r.currentFeature&&(r.features[r.currentFeature].beforeUnactivate(),document.getElementById(r.features[r.currentFeature].id).style.backgroundImage="url("+r.features[r.currentFeature].icon+")",document.getElementById("journal-container").innerHTML="",document.getElementById("search-text").value="",r.currentFeature=o,r.features[r.currentFeature].filters=[n,i,l,c],r.features[r.currentFeature].beforeActivate(),a.colorize(document.getElementById(r.features[r.currentFeature].id),t,(function(){})),document.getElementById("search-text").placeholder=doLocalize(r.features[r.currentFeature].placeholder))}))}new o.RadioButtonsGroup(u);var f=document.getElementById("pictotoolbar").parentNode.offsetHeight-110;document.getElementById("journal-container").style.height=f+"px",document.getElementById("journal-container").addEventListener("scroll",(function(){r.features[r.currentFeature].onScroll()})),document.getElementById("favorite-button").addEventListener("click",(function(){r.features[r.currentFeature].onFavorite()})),document.getElementById("search-text").addEventListener("keyup",(function(){r.features[r.currentFeature].onSearch()})),document.getElementById("cancel-search").addEventListener("click",(function(){document.getElementById("search-text").value="",r.features[r.currentFeature].onCancelSearch()})),document.getElementById("close-button").addEventListener("click",(function(){m=null,e.close()})),document.getElementById("search-text").placeholder=doLocalize(r.features[r.currentFeature].placeholder),r.features[r.currentFeature].filters=[n,i,l,c],r.features[r.currentFeature].beforeActivate()})).afterClose((function(e){e.destroy(),t&&t(m)})).show()};var f={titleJournal:{en:"Journal",fr:"Journal",es:"Diario",pt:"Diário"},titleAbecedarium:{en:"Abecedarium",fr:"Abecedarium",es:"Abecedarium",pt:"Abecedarium"},titlePhoto:{en:"Photo",fr:"Photo",es:"Photo",pt:"Photo"},titleClose:{en:"Cancel",fr:"Annuler",es:"Cancelar",pt:"Cancelar"},titleChoose:{en:"Choose an object",fr:"Choisir un objet",es:"Elige un objeto",pt:"Escolher um objeto"},photoName:{en:"Photo by {{name}}",fr:"Photo par {{name}}",es:"Photo por {{name}}",pt:"Photo por {{name}}"},holderSearchJournal:{en:"Search in Journal",fr:"Recherche dans le journal",es:"Buscar en el diario",pt:"Pesquisar no diário"},holderSearchAbecedarium:{en:"Search in Abecedarium",fr:"Recherche dans Abecedarium",es:"Buscar en Abecedarium",pt:"Pesquisar no Abecedarium"},noMatchingEntries:{en:"No matching entries",fr:"Aucune entrée correspondante",es:"No hay actividades coincidentes",pt:"Sem atividades correspondentes"},SecondsAgo:{en:"Seconds ago",fr:"A l'instant",es:"Segundos atrás",pt:"Segundos atrás"},Ago:{en:"{{time}} ago",fr:"il y a {{time}}",es:"{{time}} atrás",pt:"{{time}} atrás"},Minutes_one:{en:"minute",fr:"minute",es:"minuto",pt:"minuto"},Minutes_other:{en:"minutes",fr:"minutes",es:"minutos",pt:"minutos"},Hours_one:{en:"hour",fr:"heure",es:"hora",pt:"hora"},Hours_other:{en:"hours",fr:"heures",es:"horas",pt:"horas"},Days_one:{en:"day",fr:"jour",es:"día",pt:"dia"},Days_other:{en:"days",fr:"jours",es:"días",pt:"dias"},Weeks_one:{en:"week",fr:"semaine",es:"semana",pt:"semana"},Weeks_other:{en:"weeks",fr:"semaines",es:"semanas",pt:"semanas"},Months_one:{en:"month",fr:"mois",es:"mes",pt:"mês"},Months_other:{en:"months",fr:"mois",es:"meses",pt:"meses"},Years_one:{en:"year",fr:"année",es:"año",pt:"ano"},Years_other:{en:"years",fr:"années",es:"años",pt:"anos"}};function doLocalize(e,t){var a=-1!=["en","fr","es","pt"].indexOf(s.language)?s.language:"en",n=e,i=n.match(/\$\w+/g);for(var o in i){var r=i[o].match(/\w+/)[0];f[r]&&(n=n.replace(i[o],f[r][a]))}var l=n.match(/{{\s*[\w\.]+\s*}}/g);for(var o in l){var c=l[o].match(/[\w\.]+/)[0];n=n.replace(l[o],t[c])}return n}function timestampToElapsedString(e){for(var t=[{name:"Years",factor:30758400},{name:"Months",factor:2592e3},{name:"Weeks",factor:604800},{name:"Days",factor:86400},{name:"Hours",factor:3600},{name:"Minutes",factor:60}],a=0,n="",i=new Date(e).getTime(),o=((new Date).getTime()-i)/1e3,r=0;r<t.length;r++){var s=t[r].factor,l=Math.floor(o/s);if(l>0&&(a>0&&(n+=","),n+=" "+l+" "+doLocalize(1==l?"$"+t[r].name+"_one":"$"+t[r].name+"_other"),o-=l*s),""!=n&&(a+=1),1==a)break}return 0==a?doLocalize("$SecondsAgo"):doLocalize("$Ago",{time:n})}function uint6ToB64(e){return e<26?e+65:e<52?e+71:e<62?e-4:62===e?43:63===e?47:65}return r.close=function(e){m=e,d.close(m)},r}));