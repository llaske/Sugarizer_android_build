requirejs.config({baseUrl:"lib",paths:{activity:"../js"}});var app=new Vue({el:"#app",components:{toolbar:Toolbar,localization:Localization,chessgame:ChessGame,tutorial:Tutorial},data:function(){return{currentuser:{colorvalue:{stroke:"#000000",fill:"#ffffff"}},opponentuser:null,ishost:!1,presence:null,humane:null,level:0,clock:0,l10n:{stringPlayerJoin:"",stringPlayerLeave:"",stringClockChanged:""}}},created:function(){requirejs(["sugar-web/activity/activity","sugar-web/env"],(function(e,s){e.setup()}))},mounted:function(){var e=this;requirejs(["sugar-web/activity/activity","sugar-web/env","humane","sugar-web/graphics/presencepalette"],(function(s,t,o,a){t.getEnvironment((function(t,o){e.currentuser=o.user,$("#canvas").css("background-color",o.user.colorvalue.fill),$("#player-clock .usrtime").css("background-color",o.user.colorvalue.fill),o.objectId&&s.getDatastoreObject().loadAsText((function(s,t,o){null==s&&null!=o&&((o=JSON.parse(o)).playercolor?(e.$refs.chessgame.board.orientation("black"),e.$refs.chessgame.playercolor=1):(e.$refs.chessgame.board.orientation("white"),e.$refs.chessgame.playercolor=0),e.$refs.chessgame.game_won=o.game_won,e.$refs.chessgame.game_draw=o.game_draw,e.$refs.chessgame.game_lost=o.game_lost,e.$refs.chessgame.game_check=o.game_check,e.$refs.chessgame.level=o.level,document.getElementById("compLevelValue").value=25*(this.level-1),e.$refs.chessgame.state=Object.assign(e.$refs.chessgame.state,o.state),e.$refs.chessgame.board.position(p4_state2fen(e.$refs.chessgame.state,!0)),e.$refs.chessgame.moves=o.moves,e.$refs.chessgame.clock=o.clock,e.$refs.chessgame.clockTime=o.clockTime,e.$refs.chessgame.onClockSelected(o.clock,o.clockTime),e.$refs.chessgame.stopClock=o.stopClock)})),o.sharedId&&(e.presence=s.getPresenceObject((function(s,t){s&&console.log(s),t.onDataReceived(e.onNetworkDataReceived),t.onSharedActivityUserChanged(e.onNetworkUserChanged)})))})),e.humane=o,e.palette=new a.PresencePalette(document.getElementById("network-button"),void 0),e.palette.addEventListener("shared",(function(){e.palette.popDown(),console.log("Want to share"),e.presence=s.getPresenceObject((function(s,t){s?console.log("Sharing error"):(t.createSharedActivity("org.sugarlabs.ChessActivity",(function(s){console.log("Activity shared"),e.ishost=!0})),t.onConnectionClosed((function(e){this.presence=null,document.getElementById("stop-button").click()})),t.onDataReceived(e.onNetworkDataReceived),t.onSharedActivityUserChanged(e.onNetworkUserChanged))}))}))})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){e.unfullscreen()})),document.getElementById("main-toolbar").style.opacity=1,window.dispatchEvent(new Event("resize"))},methods:{localized:function(){this.$refs.localization.localize(this.l10n),this.$refs.toolbar.localized(this.$refs.localization),this.$refs.chessgame.localized(this.$refs.localization),this.$refs.tutorial.localized(this.$refs.localization)},fullscreen:function(){document.getElementById("main-toolbar").style.opacity=0,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",window.dispatchEvent(new Event("resize"))},unfullscreen:function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",window.dispatchEvent(new Event("resize"))},onHelp:function(e){this.$refs.tutorial.show()},onComputerlevelChanged:function(e){this.$refs.chessgame.onComputerlevelChanged(e.level)},onClockSelected:function(e){var s=this,t=s.$refs.chessgame.state,o=s.$refs.chessgame.playercolor;s.$refs.chessgame.game_won||s.$refs.chessgame.game_lost||s.$refs.chessgame.game_draw||(s.opponentuser?0==t.moveno&&s.ishost&&(s.$refs.chessgame.onClockSelected(e.index),s.humane.log(s.l10n.stringClockChanged),s.presence.sendMessage(s.presence.getSharedInfo().id,{user:s.presence.getUserInfo(),content:{action:"init",data:{chessColor:s.$refs.chessgame.playercolor,state:s.$refs.chessgame.state,clock:s.$refs.chessgame.clock}}})):(1==t.moveno&&o||0==t.moveno&&!o)&&s.$refs.chessgame.onClockSelected(e.index))},onSendClock:function(e){var s=this;s.presence&&s.presence.sendMessage(s.presence.getSharedInfo().id,{user:s.presence.getUserInfo(),content:{action:"synchronize-clock",data:e.data}})},onRestartNewGame:function(){var e=this;e.presence&&e.presence.sendMessage(e.presence.getSharedInfo().id,{user:e.presence.getUserInfo(),content:{action:"restart"}})},onSendMove:function(e){var s=this;s.presence&&s.presence.sendMessage(s.presence.getSharedInfo().id,{user:s.presence.getUserInfo(),content:{action:"update",data:e.data}})},onTimeExpired:function(e){var s=this;s.presence&&s.presence.sendMessage(s.presence.getSharedInfo().id,{user:s.presence.getUserInfo(),content:{action:"timeexpired",data:e.data}})},undo:function(){this.$refs.chessgame.undo()},newGame:function(){this.opponentuser&&!this.ishost||this.$refs.chessgame.newGame()},changeColor:function(){var e=this;e.opponentuser?0==e.$refs.chessgame.state.moveno&&e.ishost&&(this.$refs.chessgame.changeColor(!0),e.presence.sendMessage(e.presence.getSharedInfo().id,{user:e.presence.getUserInfo(),content:{action:"init",data:{chessColor:e.$refs.chessgame.playercolor,state:e.$refs.chessgame.state,clock:e.$refs.chessgame.clock}}})):e.$refs.chessgame.changeColor(!1)},onNetworkDataReceived:function(e){var s=this;if(s.presence.getUserInfo().networkId!==e.user.networkId)switch(e.content.action){case"init":s.$refs.chessgame.state=Object.assign(s.$refs.chessgame.state,e.content.data.state),s.opponentuser=e.user,e.content.data.chessColor?(s.$refs.chessgame.board.orientation("white"),s.$refs.chessgame.playercolor=0,$("#player-clock").css("border-style","solid"),$("#opponent-clock").css("border-style","none")):(s.$refs.chessgame.board.orientation("black"),s.$refs.chessgame.playercolor=1,$("#player-clock").css("border-style","none"),$("#opponent-clock").css("border-style","solid")),s.$refs.chessgame.onClockSelected(e.content.data.clock),s.$refs.chessgame.board.position(p4_state2fen(s.$refs.chessgame.state,!0)),s.$refs.chessgame.moves=[],s.$refs.chessgame.updateMoves();break;case"update":s.$refs.chessgame.state=Object.assign(s.$refs.chessgame.state,e.content.data.state),s.$refs.chessgame.board.position(p4_state2fen(s.$refs.chessgame.state,!0)),s.$refs.chessgame.updateMoves();generateXOLogoWithColor(e.user.colorvalue);s.$refs.chessgame.game_won=e.content.data.game_won,s.$refs.chessgame.game_lost=e.content.data.game_lost,s.$refs.chessgame.game_draw=e.content.data.game_draw,s.$refs.chessgame.game_check=e.content.data.game_check,s.$refs.chessgame.stopClock=!1,$("#player-clock").css("border-style","solid"),s.$refs.chessgame.stopOpponentClock=!0,$("#opponent-clock").css("border-style","none");break;case"exit":e.content.data==s.presence.getUserInfo().networkId&&$("#stop-button").click();break;case"synchronize-clock":s.$refs.chessgame.clockTime=e.content.data.opponentClockTime,s.$refs.chessgame.opponentClockTime=e.content.data.clockTime;break;case"restart":s.$refs.chessgame.game_won=!1,s.$refs.chessgame.game_lost=!1,s.$refs.chessgame.game_check=!1,s.$refs.chessgame.timeexpired=!1,s.$refs.chessgame.board.start(),p4_jump_to_moveno(s.$refs.chessgame.state,0),s.$refs.chessgame.moves=[],s.$refs.chessgame.playercolor?($("#player-clock").css("border-style","none"),$("#opponent-clock").css("border-style","solid")):($("#player-clock").css("border-style","solid"),$("#opponent-clock").css("border-style","none"));break;case"timeexpired":console.log(e.content.data.player),0==e.content.data.player?(s.$refs.chessgame.timeexpired=!1,s.$refs.chessgame.game_won=!0):(s.$refs.chessgame.timeexpired=!0,s.$refs.chessgame.game_lost=!0)}},onNetworkUserChanged:function(e){var s=this,t="<img style='height:30px;' src='"+generateXOLogoWithColor(e.user.colorvalue)+"'>";s.humane.log(t+e.user.name+" "+(1==e.move?s.l10n.stringPlayerJoin:s.l10n.stringPlayerLeave)),1==e.move?s.ishost&&(s.opponentuser?s.presence.sendMessage(s.presence.getSharedInfo().id,{user:s.presence.getUserInfo(),content:{action:"exit",data:e.user.networkId}}):(s.opponentuser=e.user,s.$refs.chessgame.newGame(),s.presence.sendMessage(s.presence.getSharedInfo().id,{user:s.presence.getUserInfo(),content:{action:"init",data:{chessColor:s.$refs.chessgame.playercolor,state:s.$refs.chessgame.state,clock:s.$refs.chessgame.clock}}}))):null!=s.opponentuser&&(s.opponentuser=null,s.ishost=!0,(s.$refs.chessgame.state.to_play&&!s.$refs.chessgame.playercolor||!s.$refs.chessgame.state.to_play&&s.$refs.chessgame.playercolor)&&s.$refs.chessgame.makeRandomMove())},onStop:function(){var e=this;requirejs(["sugar-web/activity/activity"],(function(s){if(!e.opponentuser){let o={playercolor:e.$refs.chessgame.playercolor,state:e.$refs.chessgame.state,moves:e.$refs.chessgame.moves,clock:e.$refs.chessgame.clock,stopClock:e.$refs.chessgame.stopClock,clockTime:e.$refs.chessgame.clockTime,game_won:e.$refs.chessgame.game_won,game_lost:e.$refs.chessgame.game_lost,game_draw:e.$refs.chessgame.game_draw,game_check:e.$refs.chessgame.game_check,level:e.$refs.chessgame.level};var t=JSON.stringify(o);s.getDatastoreObject().setDataAsText(t),s.getDatastoreObject().save((function(e){}))}}))}}});