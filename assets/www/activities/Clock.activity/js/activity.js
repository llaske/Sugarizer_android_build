/*! Sugarizer 2020-03-14 */
define(["sugar-web/activity/activity","sugar-web/env","sugar-web/graphics/radiobuttonsgroup","mustache","moment-with-locales.min","webL10n","tutorial"],function(a,b,c,d,e,f,g){requirejs(["domReady!"],function(h){function i(){this.face="simple",this.handAngles={hours:0,minutes:0,seconds:0},this.initialAngles={hours:void 0,minutes:void 0,seconds:void 0},this.colors={black:"#000000",white:"#FFFFFF",hours:"#005FE4",minutes:"#00B20D",seconds:"#E6000A",yellow:"#FFFF00"},this.writeTime=!1,this.writeDate=!1,this.setTime=!1,this.setTimeGame=!1,this.isDrag=!1,this.isSmiley=!1,this.initiateAngles=!1,this.size=void 0,this.margin=void 0,this.radius=void 0,this.centerX=void 0,this.centerY=void 0,this.lineWidthBase=void 0,this.handSizes=void 0,this.lineWidths=void 0,this.selectedHand=void 0,this.canvasX=void 0,this.canvasY=void 0,this.timeToBeDisplayed={hours:void 0,minutes:void 0,seconds:void 0},this.ctr=0,this.ctr1=0,this.textTimeElem=document.getElementById("text-time"),this.textDateElem=document.getElementById("text-date"),this.clockCanvasElem=document.getElementById("clock-canvas"),this.clockContainerElem=this.clockCanvasElem.parentNode,this.bgCanvasElem=document.createElement("canvas"),this.clockContainerElem.insertBefore(this.bgCanvasElem,this.clockCanvasElem);var a=this;window.onresize=function(b){a.updateSizes(),a.drawBackground()},document.getElementById("fullscreen-button").addEventListener("click",function(){document.getElementById("main-toolbar").style.display="none",document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",a.updateSizes(),a.drawBackground()}),document.getElementById("unfullscreen-button").addEventListener("click",function(){document.getElementById("main-toolbar").style.display="block",document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",a.updateSizes(),a.drawBackground()})}function j(){document.getElementById("simple-clock-button").title=l10n_s.get("SimpleClock"),document.getElementById("nice-clock-button").title=l10n_s.get("NiceClock"),document.getElementById("write-time-button").title=l10n_s.get("WriteTime"),document.getElementById("write-date-button").title=l10n_s.get("WriteDate"),document.getElementById("set-time-button").title=l10n_s.get("SetTime"),document.getElementById("set-timeGame-button").title=l10n_s.get("SetTimeGame"),document.getElementById("text-time").innerHTML=l10n_s.get("WhatTime")}function k(a){var b=["hours","minutes","seconds"],c=[.4,.607,.8125];s&&(a=a.touches[0]);for(var d=0;d<3;d++){var e=b[d],f=.08*p.radius,g=p.centerX+p.handSizes[e]*c[d]*Math.sin(p.handAngles[e]),h=p.centerY-p.handSizes[e]*c[d]*Math.cos(p.handAngles[e]);const i=p.clockCanvasElem.getBoundingClientRect(),j=a.clientX-i.left,k=a.clientY-i.top;p.canvasX=j,p.canvasY=k;if(Math.sqrt(Math.pow(g-j,2)+Math.pow(h-k,2))<=f){p.isDrag=!0,p.selectedHand=e,p.initiateAngles=!0;break}}}function l(a){p.isDrag=!1,p.ctr=0,p.ctr1=0;for(var b in this.handAngles)this.initialAngles[b]=this.handAngles[b]}function m(a){s&&(a=a.touches[0]);const b=p.clockCanvasElem.getBoundingClientRect(),c=a.clientX-b.left,d=a.clientY-b.top;if(p.canvasX=c,p.canvasY=d,p.setTimeGame){var e=["hours","minutes","seconds"],f=[];f.push(Math.PI/6*(p.timeToBeDisplayed.hours%12)+Math.PI/360*p.timeToBeDisplayed.minutes),f.push(Math.PI/30*p.timeToBeDisplayed.minutes+Math.PI/1800*p.timeToBeDisplayed.seconds),f.push(Math.PI/30*p.timeToBeDisplayed.seconds);for(var g=0,h=0;h<3;h++){var i=e[h],j=p.handAngles[i]%(2*Math.PI),k=f[h];Math.abs(j-k)<3*Math.PI/180&&g++}p.isSmiley=3==g}p.setTime&&p.writeTimeInSetTime()}a.setup(),j(),b.getEnvironment(function(b,c){currentenv=c;var d="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,e=c.user?c.user.language:d;f.language.code=e,c.objectId?a.getDatastoreObject().loadAsText(function(a,b,c){null==a&&null!=c&&(i.face=c.face,console.log(c),"simple"==c.face?(document.getElementById("simple-clock-button").classList.add("active"),document.getElementById("nice-clock-button").classList.remove("active"),p.changeFace("simple")):(document.getElementById("nice-clock-button").classList.add("active"),document.getElementById("simple-clock-button").classList.remove("active"),p.changeFace("nice")),c.writeDate?(document.getElementById("write-date-button").classList.add("active"),p.changeWriteDate(!0)):document.getElementById("write-date-button").classList.remove("active"),c.isSetTimeGame?(p.setTimeGame=!0,c.isSmiley&&(p.isSmiley=!0),p.handAngles=c.handAngles,p.timeToBeDisplayed=c.timeToBeDisplayed,document.getElementById("set-timeGame-button").classList.add("active"),document.getElementById("write-time-button").classList.add("active"),p.writeTimeInSetTimeGame()):(c.isSetTime&&(p.setTime=!0,p.writeDate=!1,p.handAngles=c.handAngles,p.timeToBeDisplayed=c.timeToBeDisplayed,document.getElementById("set-time-button").classList.add("active"),p.writeTimeInSetTime()),c.writeTime?(document.getElementById("write-time-button").classList.add("active"),p.changeWriteTime(!0)):document.getElementById("write-time-button").classList.remove("active")))}):console.log("New instance")}),document.getElementById("help-button").addEventListener("click",function(a){g.start()});var n=new Image;n.src="./clock.svg";var o=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;i.prototype.start=function(a){this.updateSizes(),this.drawBackground(),this.update(),this.setTime||this.setTimeGame?this.moveHandsInSetTime():this.drawHands(),this.previousTime=Date.now(),this.tick()},i.prototype.tick=function(){var a=Date.now();this.setTime||this.setTimeGame?this.moveHandsInSetTime():a-this.previousTime>1e3&&(this.previousTime=a,this.update(),this.drawHands(),/Android/i.test(navigator.userAgent)&&"http"!=document.location.protocol.substr(0,4)&&(this.clockCanvasElem.style.display="none",this.clockCanvasElem.offsetHeight,this.clockCanvasElem.style.display="block")),o(this.tick.bind(this))},i.prototype.changeFace=function(a){this.face=a,this.drawBackground()},i.prototype.changeWriteTime=function(a){if(this.writeTime=a,this.textTimeElem.style.display=a?"block":"none",this.setTime)this.writeTimeInSetTime();else{this.updateSizes();var b=new Date,c=b.getHours(),d=b.getMinutes(),e=b.getSeconds();this.displayTime(c,d,e),this.drawBackground()}},i.prototype.changeWriteDate=function(a){this.writeDate=a,this.textDateElem.style.display=a?"block":"none",this.updateSizes();var b=new Date;this.displayDate(b),this.drawBackground()},i.prototype.updateSizes=function(){var a=document.getElementById("main-toolbar"),b=document.getElementById("text-container"),c=window.innerHeight-(b.offsetHeight+a.offsetHeight)-1;this.size=Math.min(window.innerWidth,c),this.clockCanvasElem.width=this.size,this.clockCanvasElem.height=this.size,this.bgCanvasElem.width=this.size,this.bgCanvasElem.height=this.size,this.clockContainerElem.style.width=this.size+"px",this.clockContainerElem.style.height=this.size+"px",this.clockCanvasElem.style.width=this.size+4+"px",this.margin=.02*this.size,this.radius=(this.size-2*this.margin)/2,this.centerX=this.radius+this.margin,this.centerY=this.radius+this.margin,this.lineWidthBase=this.radius/150,this.handSizes={hours:.5*this.radius,minutes:.7*this.radius,seconds:.8*this.radius},this.lineWidths={hours:9*this.lineWidthBase,minutes:6*this.lineWidthBase,seconds:4*this.lineWidthBase}},i.prototype.update=function(){var a=new Date,b=a.getHours(),c=a.getMinutes(),d=a.getSeconds();this.displayTime(b,c,d),this.displayDate(a),this.handAngles.hours=Math.PI/6*(b%12)+Math.PI/360*c,this.handAngles.minutes=Math.PI/30*c+Math.PI/1800*d,this.handAngles.seconds=Math.PI/30*d},i.prototype.displayTime=function(a,b,c,e){e||(e="");var f=function(a){return("00"+a).substr(-2)},g='<span style="color: {{ colors.hours }}">{{ hours }}</span>:<span style="color: {{ colors.minutes }}">{{ minutes }}</span>:<span style="color: {{ colors.seconds }}">{{ seconds }}</span><span style="color: {{ colors.yellow }}">'+e+"</span>";if(this.writeTime){var h={colors:this.colors,hours:f(a),minutes:f(b),seconds:f(c)};this.textTimeElem.innerHTML=d.render(g,h)}},i.prototype.displayDate=function(a){if(this.writeDate){var b=e(a);this.textDateElem.innerHTML=b.format("LLLL").replace(b.format("LT"),"")}},i.prototype.drawBackground=function(){"simple"==this.face?(this.drawSimpleBackground(),this.drawNumbers()):this.drawNiceBackground(),this.setTimeGame||this.setTimeGame?this.moveHandsInSetTime():this.drawHands()},i.prototype.drawSimpleBackground=function(){var a=this.bgCanvasElem.getContext("2d");a.clearRect(0,0,this.size,this.size);var b=4*this.lineWidthBase;a.lineCap="round",a.lineWidth=b,a.strokeStyle=this.colors.black,a.fillStyle=this.colors.white,a.beginPath(),a.arc(this.centerX,this.centerY,this.radius-b,0,2*Math.PI),a.fill(),a.stroke();for(var c=0;c<60;c++){var d;c%15==0?(d=.15*this.radius,a.lineWidth=7*this.lineWidthBase):c%5==0?(d=.12*this.radius,a.lineWidth=5*this.lineWidthBase):(d=.08*this.radius,a.lineWidth=4*this.lineWidthBase),a.lineCap="round",a.beginPath();var e=Math.cos(c*Math.PI/30),f=Math.sin(c*Math.PI/30);a.save(),a.translate(this.margin,this.margin),a.moveTo(this.radius+(this.radius-d)*e,this.radius+(this.radius-d)*f),a.lineTo(this.radius+(this.radius-a.lineWidth)*e,this.radius+(this.radius-a.lineWidth)*f),a.stroke(),a.restore()}},i.prototype.drawNiceBackground=function(){var a=this.bgCanvasElem.getContext("2d");a.clearRect(this.margin,this.margin,2*this.radius,2*this.radius),a.drawImage(n,this.margin,this.margin,2*this.radius,2*this.radius)},i.prototype.drawNumbers=function(){var a=this.bgCanvasElem.getContext("2d"),b=30*this.radius/160;a.fillStyle=this.colors.hours,a.textBaseline="middle",a.font="bold "+b+"px sans-serif";for(var c=0;c<12;c++){var d=Math.cos((c-2)*Math.PI/6),e=Math.sin((c-2)*Math.PI/6),f=c+1,g=a.measureText(f).width;a.save(),a.translate(this.centerX-g/2,this.centerY),a.translate(.75*this.radius*d,.75*this.radius*e),a.fillText(f,0,0),a.restore()}},i.prototype.drawHands=function(){var a=this.clockCanvasElem.getContext("2d");a.clearRect(this.margin,this.margin,2*this.radius,2*this.radius);for(var b=["hours","minutes","seconds"],c=0;c<b.length;c++){var d=b[c];a.lineCap="round",a.lineWidth=this.lineWidths[d],a.strokeStyle=this.colors[d],a.beginPath(),a.arc(this.centerX,this.centerY,.6*a.lineWidth,0,2*Math.PI),a.moveTo(this.centerX,this.centerY),a.lineTo(this.centerX+this.handSizes[d]*Math.sin(this.handAngles[d]),this.centerY-this.handSizes[d]*Math.cos(this.handAngles[d])),a.stroke()}},i.prototype.drawHandsInSetTime=function(){var a=this.clockCanvasElem.getContext("2d");a.clearRect(this.margin,this.margin,2*this.radius,2*this.radius),this.drawSmiley();for(var b=["hours","minutes","seconds"],c=[.4,.607,.8125],d=0;d<b.length;d++){var e=b[d];a.lineCap="round",a.lineWidth=this.lineWidths[e],a.strokeStyle=this.colors[e],a.beginPath(),a.arc(this.centerX,this.centerY,.6*a.lineWidth,0,2*Math.PI),a.moveTo(this.centerX,this.centerY);var f=this.handAngles[e],g=.08*this.radius,h=this.centerX+this.handSizes[e]*c[d]*Math.sin(f),i=this.centerY-this.handSizes[e]*c[d]*Math.cos(f);a.lineTo(this.centerX+(this.handSizes[e]*c[d]-g)*Math.sin(f),this.centerY-(this.handSizes[e]*c[d]-g)*Math.cos(f)),a.stroke(),a.beginPath(),a.arc(h,i,g,0,2*Math.PI),a.moveTo(this.centerX+(this.handSizes[e]*c[d]+g)*Math.sin(f),this.centerY-(this.handSizes[e]*c[d]+g)*Math.cos(f)),a.lineTo(this.centerX+this.handSizes[e]*Math.sin(f),this.centerY-this.handSizes[e]*Math.cos(f)),a.stroke()}},i.prototype.moveHandsInSetTime=function(){if(this.isDrag){var a=this.canvasX,b=this.canvasY,c=Math.abs(b-this.centerY),d=Math.abs(a-this.centerX),e=Math.atan2(c,d),f=void 0;if(f=b<=this.centerY?a>=this.centerX?Math.PI/2-e:3*Math.PI/2+e:a>=this.centerX?Math.PI/2+e:3*Math.PI/2-e,this.initiateAngles){for(var g in this.handAngles)this.initialAngles[g]=this.handAngles[g];this.initiateAngles=!1}if("hours"==this.selectedHand)this.handAngles.hours=Math.floor(f/Math.PI*6)*Math.PI/6+Math.floor(this.handAngles.minutes/Math.PI*30)*Math.PI/360;else if("minutes"==this.selectedHand){var h=Math.floor(this.handAngles.minutes/Math.PI*30);this.handAngles.minutes=Math.floor(f/Math.PI*30)*Math.PI/30+Math.floor(this.handAngles.seconds/Math.PI*30)*Math.PI/1800;var i=Math.floor(this.handAngles.minutes/Math.PI*30);45<h&&h<=59&&0<=i&&i<15?this.ctr++:15>h&&h>=0&&59<=i&&i>=45&&this.ctr--;var j=(Math.floor(this.initialAngles.hours/Math.PI*6)+this.ctr)*Math.PI/6+Math.floor(this.handAngles.minutes/Math.PI*30)*Math.PI/360;j<0?(this.handAngles.hours=2*Math.PI+j,this.initialAngles.hours=2*Math.PI+j,this.ctr=0):this.handAngles.hours=j}else{var h=Math.floor(this.handAngles.seconds/Math.PI*30);this.handAngles.seconds=Math.floor(f/Math.PI*30)*Math.PI/30;var i=Math.floor(this.handAngles.seconds/Math.PI*30);45<h&&h<=59&&0<=i&&i<15?this.ctr++:15>h&&h>=0&&59<=i&&i>=45&&this.ctr--,h=Math.floor(this.handAngles.minutes/Math.PI*30);var k=Math.floor(this.handAngles.seconds/Math.PI*30)*Math.PI/1800;0==k&&(k=Math.PI/1800);var j=(Math.floor(this.initialAngles.minutes/Math.PI*30+this.ctr)*Math.PI/30+k)%(2*Math.PI);j<0?(this.handAngles.minutes=2*Math.PI+j,this.initialAngles.minutes=2*Math.PI+j,this.ctr=0):this.handAngles.minutes=j,i=Math.floor(this.handAngles.minutes/Math.PI*30),45<h&&h<=59&&0<=i&&i<15?this.ctr1++:15>h&&h>=0&&59<=i&&i>=45&&this.ctr1--,j=Math.floor(this.initialAngles.hours/Math.PI*6+this.ctr1)*Math.PI/6+Math.floor(this.handAngles.minutes%(2*Math.PI)/Math.PI*30)*Math.PI/360,j<0?(this.handAngles.hours=2*Math.PI+j,this.initialAngles.hours=2*Math.PI+j,this.ctr1=0):this.handAngles.hours=j}}this.drawHandsInSetTime()},i.prototype.writeTimeInSetTime=function(){var a;this.timeToBeDisplayed.seconds=Math.floor(Number.parseFloat(30*this.handAngles.seconds/Math.PI).toFixed(5)),this.timeToBeDisplayed.minutes=Math.floor(Number.parseFloat(this.handAngles.minutes%(2*Math.PI)*30/Math.PI).toFixed(5))%60,a=Math.floor(Number.parseFloat(this.handAngles.hours%(2*Math.PI)*6/Math.PI).toFixed(5)),this.timeToBeDisplayed.hours=0!=a?a:12,this.displayTime(this.timeToBeDisplayed.hours,this.timeToBeDisplayed.minutes,this.timeToBeDisplayed.seconds),this.updateSizes(),this.drawBackground()},i.prototype.writeTimeInSetTimeGame=function(){this.writeTime=!0,this.textTimeElem.style.display="block",void 0==this.timeToBeDisplayed.hours&&(this.timeToBeDisplayed.hours=Math.floor(12*Math.random())+1,this.timeToBeDisplayed.minutes=Math.floor(60*Math.random()),this.timeToBeDisplayed.seconds=Math.floor(60*Math.random())),this.displayTime(this.timeToBeDisplayed.hours,this.timeToBeDisplayed.minutes,this.timeToBeDisplayed.seconds,"??"),this.updateSizes(),this.drawBackground()},i.prototype.drawSmiley=function(){if(this.isSmiley){var a=this.clockCanvasElem.getContext("2d");a.lineCap="round",a.lineWidth=10*this.lineWidthBase,a.strokeStyle=this.colors.yellow,a.beginPath(),a.arc(this.centerX,this.centerY,.5*this.radius,0,Math.PI),a.stroke(),a.beginPath(),a.arc(this.centerX-.3*this.radius,this.centerY-.3*this.radius,25,0,2*Math.PI),a.stroke(),a.beginPath(),a.arc(this.centerX+.3*this.radius,this.centerY-.3*this.radius,25,0,2*Math.PI),a.stroke()}};var p=new i;p.start();var q=document.getElementById("simple-clock-button");q.onclick=function(){p.changeFace("simple")};var r=document.getElementById("nice-clock-button");r.onclick=function(){p.changeFace("nice")};new c.RadioButtonsGroup([q,r]);document.getElementById("write-time-button").onclick=function(){if(!p.setTimeGame){this.classList.toggle("active");var a=this.classList.contains("active");p.changeWriteTime(a)}},document.getElementById("write-date-button").onclick=function(){this.classList.toggle("active");var a=this.classList.contains("active");p.changeWriteDate(a)},document.getElementById("set-time-button").onclick=function(){p.setTime?(p.setTime=!1,p.isSmiley=!1,document.getElementById("set-time-button").classList.remove("active")):(p.setTime=!0,p.isSmiley=!1,p.setTimeGame=!1,document.getElementById("set-timeGame-button").classList.remove("active"),document.getElementById("set-time-button").classList.add("active"),p.writeTimeInSetTime())},document.getElementById("set-timeGame-button").onclick=function(){p.setTimeGame?(p.setTimeGame=!1,p.isSmiley=!1,p.timeToBeDisplayed={hours:void 0,minutes:void 0,seconds:void 0},document.getElementById("set-timeGame-button").classList.remove("active"),document.getElementById("write-time-button").classList.remove("active"),p.changeWriteTime(!1)):(p.setTimeGame=!0,p.writeDate=!1,p.timeToBeDisplayed={hours:void 0,minutes:void 0,seconds:void 0},p.isSmiley=!1,p.setTime=!1,document.getElementById("set-time-button").classList.remove("active"),document.getElementById("set-timeGame-button").classList.add("active"),document.getElementById("write-time-button").classList.add("active"),p.handAngles.seconds=0,p.handAngles.minutes=0,p.handAngles.hours=0,p.writeTimeInSetTimeGame())};var s="ontouchstart"in document.documentElement;s?(p.clockCanvasElem.addEventListener("touchstart",k,!1),p.clockCanvasElem.addEventListener("touchend",l,!1),p.clockCanvasElem.addEventListener("touchmove",m,!1)):(p.clockCanvasElem.onmousedown=k,p.clockCanvasElem.onmouseup=l,p.clockCanvasElem.onmousemove=m),document.getElementById("stop-button").addEventListener("click",function(b){var c={face:p.face,writeTime:p.writeTime,writeDate:p.writeDate,isSetTime:p.setTime,isSetTimeGame:p.setTimeGame,isSmiley:p.isSmiley,handAngles:p.handAngles,timeToBeDisplayed:p.timeToBeDisplayed};a.getDatastoreObject().setDataAsText(c),a.getDatastoreObject().save(function(a){null===a?console.log("write done."):console.log("write failed.")})})})});