define(["sugar-web/activity/activity","sugar-web/env","sugar-web/graphics/radiobuttonsgroup","mustache","moment-with-locales.min","webL10n","tutorial"],(function(t,e,i,s,n,a,o){requirejs(["domReady!"],(function(h){t.setup(),function setTranslatedStrings(){document.getElementById("simple-clock-button").title=l10n_s.get("SimpleClock"),document.getElementById("nice-clock-button").title=l10n_s.get("NiceClock"),document.getElementById("write-time-button").title=l10n_s.get("WriteTime"),document.getElementById("write-date-button").title=l10n_s.get("WriteDate"),document.getElementById("set-time-button").title=l10n_s.get("SetTime"),document.getElementById("set-timeGame-button").title=l10n_s.get("SetTimeGame"),document.getElementById("text-time").innerHTML=l10n_s.get("WhatTime")}(),e.getEnvironment((function(e,i){currentenv=i;var s="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,n=i.user?i.user.language:s;a.language.code=n,i.objectId?t.getDatastoreObject().loadAsText((function(t,e,i){null==t&&null!=i&&(Clock.face=i.face,console.log(i),"simple"==i.face?(document.getElementById("simple-clock-button").classList.add("active"),document.getElementById("nice-clock-button").classList.remove("active"),d.changeFace("simple")):(document.getElementById("nice-clock-button").classList.add("active"),document.getElementById("simple-clock-button").classList.remove("active"),d.changeFace("nice")),i.writeDate?(document.getElementById("write-date-button").classList.add("active"),d.changeWriteDate(!0)):document.getElementById("write-date-button").classList.remove("active"),i.isSetTimeGame?(d.setTimeGame=!0,i.isSmiley&&(d.isSmiley=!0),d.handAngles=i.handAngles,d.timeToBeDisplayed=i.timeToBeDisplayed,document.getElementById("set-timeGame-button").classList.add("active"),document.getElementById("write-time-button").classList.add("active"),d.writeTimeInSetTimeGame()):(i.isSetTime&&(d.setTime=!0,d.writeDate=!1,d.handAngles=i.handAngles,d.timeToBeDisplayed=i.timeToBeDisplayed,document.getElementById("set-time-button").classList.add("active"),d.writeTimeInSetTime()),i.writeTime?(document.getElementById("write-time-button").classList.add("active"),d.changeWriteTime(!0)):document.getElementById("write-time-button").classList.remove("active")))})):console.log("New instance")})),document.getElementById("help-button").addEventListener("click",(function(t){o.start()}));var l=new Image;l.src="./clock.svg";var c=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;function Clock(){this.face="simple",this.handAngles={hours:0,minutes:0,seconds:0},this.initialAngles={hours:void 0,minutes:void 0,seconds:void 0},this.colors={black:"#000000",white:"#FFFFFF",hours:"#005FE4",minutes:"#00B20D",seconds:"#E6000A",yellow:"#FFFF00"},this.writeTime=!1,this.writeDate=!1,this.setTime=!1,this.setTimeGame=!1,this.isDrag=!1,this.isSmiley=!1,this.initiateAngles=!1,this.size=void 0,this.margin=void 0,this.radius=void 0,this.centerX=void 0,this.centerY=void 0,this.lineWidthBase=void 0,this.handSizes=void 0,this.lineWidths=void 0,this.selectedHand=void 0,this.canvasX=void 0,this.canvasY=void 0,this.timeToBeDisplayed={hours:void 0,minutes:void 0,seconds:void 0},this.ctr=0,this.ctr1=0,this.textTimeElem=document.getElementById("text-time"),this.textDateElem=document.getElementById("text-date"),this.clockCanvasElem=document.getElementById("clock-canvas"),this.clockContainerElem=this.clockCanvasElem.parentNode,this.bgCanvasElem=document.createElement("canvas"),this.clockContainerElem.insertBefore(this.bgCanvasElem,this.clockCanvasElem);var t=this;window.onresize=function(e){t.updateSizes(),t.drawBackground()},document.getElementById("fullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.display="none",document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",t.updateSizes(),t.drawBackground()})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.display="block",document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",t.updateSizes(),t.drawBackground()}))}Clock.prototype.start=function(t){this.updateSizes(),this.drawBackground(),this.update(),this.setTime||this.setTimeGame?this.moveHandsInSetTime():this.drawHands(),this.previousTime=Date.now(),this.tick()},Clock.prototype.tick=function(){var t=Date.now();this.setTime||this.setTimeGame?this.moveHandsInSetTime():t-this.previousTime>1e3&&(this.previousTime=t,this.update(),this.drawHands(),/Android/i.test(navigator.userAgent)&&"http"!=document.location.protocol.substr(0,4)&&(this.clockCanvasElem.style.display="none",this.clockCanvasElem.offsetHeight,this.clockCanvasElem.style.display="block")),c(this.tick.bind(this))},Clock.prototype.changeFace=function(t){this.face=t,this.drawBackground()},Clock.prototype.changeWriteTime=function(t){if(this.writeTime=t,this.textTimeElem.style.display=t?"block":"none",this.setTime)this.writeTimeInSetTime();else{this.updateSizes();var e=new Date,i=e.getHours(),s=e.getMinutes(),n=e.getSeconds();this.displayTime(i,s,n),this.drawBackground()}},Clock.prototype.changeWriteDate=function(t){this.writeDate=t,this.textDateElem.style.display=t?"block":"none",this.updateSizes();var e=new Date;this.displayDate(e),this.drawBackground()},Clock.prototype.updateSizes=function(){var t=document.getElementById("main-toolbar"),e=document.getElementById("text-container"),i=window.innerHeight-(e.offsetHeight+t.offsetHeight)-1;this.size=Math.min(window.innerWidth,i),this.clockCanvasElem.width=this.size,this.clockCanvasElem.height=this.size,this.bgCanvasElem.width=this.size,this.bgCanvasElem.height=this.size,this.clockContainerElem.style.width=this.size+"px",this.clockContainerElem.style.height=this.size+"px",this.clockCanvasElem.style.width=this.size+4+"px",this.margin=.02*this.size,this.radius=(this.size-2*this.margin)/2,this.centerX=this.radius+this.margin,this.centerY=this.radius+this.margin,this.lineWidthBase=this.radius/150,this.handSizes={hours:.5*this.radius,minutes:.7*this.radius,seconds:.8*this.radius},this.lineWidths={hours:9*this.lineWidthBase,minutes:6*this.lineWidthBase,seconds:4*this.lineWidthBase}},Clock.prototype.update=function(){var t=new Date,e=t.getHours(),i=t.getMinutes(),s=t.getSeconds();this.displayTime(e,i,s),this.displayDate(t),this.handAngles.hours=Math.PI/6*(e%12)+Math.PI/360*i,this.handAngles.minutes=Math.PI/30*i+Math.PI/1800*s,this.handAngles.seconds=Math.PI/30*s},Clock.prototype.displayTime=function(t,e,i,n){n||(n="");var zeroFill=function(t){return("00"+t).substr(-2)},a='<span style="color: {{ colors.hours }}">{{ hours }}</span>:<span style="color: {{ colors.minutes }}">{{ minutes }}</span>:<span style="color: {{ colors.seconds }}">{{ seconds }}</span><span style="color: {{ colors.yellow }}">'+n+"</span>";if(this.writeTime){var o={colors:this.colors,hours:zeroFill(t),minutes:zeroFill(e),seconds:zeroFill(i)};this.textTimeElem.innerHTML=s.render(a,o)}},Clock.prototype.displayDate=function(t){if(this.writeDate){var e=n(t);this.textDateElem.innerHTML=e.format("LLLL").replace(e.format("LT"),"")}},Clock.prototype.drawBackground=function(){"simple"==this.face?(this.drawSimpleBackground(),this.drawNumbers()):this.drawNiceBackground(),this.setTimeGame||this.setTimeGame?this.moveHandsInSetTime():this.drawHands()},Clock.prototype.drawSimpleBackground=function(){var t=this.bgCanvasElem.getContext("2d");t.clearRect(0,0,this.size,this.size);var e=4*this.lineWidthBase;t.lineCap="round",t.lineWidth=e,t.strokeStyle=this.colors.black,t.fillStyle=this.colors.white,t.beginPath(),t.arc(this.centerX,this.centerY,this.radius-e,0,2*Math.PI),t.fill(),t.stroke();for(var i=0;i<60;i++){var s;i%15==0?(s=.15*this.radius,t.lineWidth=7*this.lineWidthBase):i%5==0?(s=.12*this.radius,t.lineWidth=5*this.lineWidthBase):(s=.08*this.radius,t.lineWidth=4*this.lineWidthBase),t.lineCap="round",t.beginPath();var n=Math.cos(i*Math.PI/30),a=Math.sin(i*Math.PI/30);t.save(),t.translate(this.margin,this.margin),t.moveTo(this.radius+(this.radius-s)*n,this.radius+(this.radius-s)*a),t.lineTo(this.radius+(this.radius-t.lineWidth)*n,this.radius+(this.radius-t.lineWidth)*a),t.stroke(),t.restore()}},Clock.prototype.drawNiceBackground=function(){var t=this.bgCanvasElem.getContext("2d");t.clearRect(this.margin,this.margin,2*this.radius,2*this.radius),t.drawImage(l,this.margin,this.margin,2*this.radius,2*this.radius)},Clock.prototype.drawNumbers=function(){var t=this.bgCanvasElem.getContext("2d"),e=30*this.radius/160;t.fillStyle=this.colors.hours,t.textBaseline="middle",t.font="bold "+e+"px sans-serif";for(var i=0;i<12;i++){var s=Math.cos((i-2)*Math.PI/6),n=Math.sin((i-2)*Math.PI/6),a=i+1,o=t.measureText(a).width;t.save(),t.translate(this.centerX-o/2,this.centerY),t.translate(.75*this.radius*s,.75*this.radius*n),t.fillText(a,0,0),t.restore()}},Clock.prototype.drawHands=function(){var t=this.clockCanvasElem.getContext("2d");t.clearRect(this.margin,this.margin,2*this.radius,2*this.radius);for(var e=["hours","minutes","seconds"],i=0;i<e.length;i++){var s=e[i];t.lineCap="round",t.lineWidth=this.lineWidths[s],t.strokeStyle=this.colors[s],t.beginPath(),t.arc(this.centerX,this.centerY,.6*t.lineWidth,0,2*Math.PI),t.moveTo(this.centerX,this.centerY),t.lineTo(this.centerX+this.handSizes[s]*Math.sin(this.handAngles[s]),this.centerY-this.handSizes[s]*Math.cos(this.handAngles[s])),t.stroke()}},Clock.prototype.drawHandsInSetTime=function(){var t=this.clockCanvasElem.getContext("2d");t.clearRect(this.margin,this.margin,2*this.radius,2*this.radius),this.drawSmiley();for(var e=["hours","minutes","seconds"],i=[.4,.607,.8125],s=0;s<e.length;s++){var n=e[s];t.lineCap="round",t.lineWidth=this.lineWidths[n],t.strokeStyle=this.colors[n],t.beginPath(),t.arc(this.centerX,this.centerY,.6*t.lineWidth,0,2*Math.PI),t.moveTo(this.centerX,this.centerY);var a=this.handAngles[n],o=.08*this.radius,h=this.centerX+this.handSizes[n]*i[s]*Math.sin(a),l=this.centerY-this.handSizes[n]*i[s]*Math.cos(a);t.lineTo(this.centerX+(this.handSizes[n]*i[s]-o)*Math.sin(a),this.centerY-(this.handSizes[n]*i[s]-o)*Math.cos(a)),t.stroke(),t.beginPath(),t.arc(h,l,o,0,2*Math.PI),t.moveTo(this.centerX+(this.handSizes[n]*i[s]+o)*Math.sin(a),this.centerY-(this.handSizes[n]*i[s]+o)*Math.cos(a)),t.lineTo(this.centerX+this.handSizes[n]*Math.sin(a),this.centerY-this.handSizes[n]*Math.cos(a)),t.stroke()}},Clock.prototype.moveHandsInSetTime=function(){if(this.isDrag){var t=this.canvasX,e=this.canvasY,i=Math.abs(e-this.centerY),s=Math.abs(t-this.centerX),n=Math.atan2(i,s),a=void 0;if(a=e<=this.centerY?t>=this.centerX?Math.PI/2-n:3*Math.PI/2+n:t>=this.centerX?Math.PI/2+n:3*Math.PI/2-n,this.initiateAngles){for(var o in this.handAngles)this.initialAngles[o]=this.handAngles[o];this.initiateAngles=!1}if("hours"==this.selectedHand)this.handAngles.hours=Math.floor(a/Math.PI*6)*Math.PI/6+Math.floor(this.handAngles.minutes/Math.PI*30)*Math.PI/360;else if("minutes"==this.selectedHand){var h=Math.floor(this.handAngles.minutes/Math.PI*30);this.handAngles.minutes=Math.floor(a/Math.PI*30)*Math.PI/30+Math.floor(this.handAngles.seconds/Math.PI*30)*Math.PI/1800;var l=Math.floor(this.handAngles.minutes/Math.PI*30);45<h&&h<=59&&0<=l&&l<15?this.ctr++:15>h&&h>=0&&59<=l&&l>=45&&this.ctr--,(c=(Math.floor(this.initialAngles.hours/Math.PI*6)+this.ctr)*Math.PI/6+Math.floor(this.handAngles.minutes/Math.PI*30)*Math.PI/360)<0?(this.handAngles.hours=2*Math.PI+c,this.initialAngles.hours=2*Math.PI+c,this.ctr=0):this.handAngles.hours=c}else{h=Math.floor(this.handAngles.seconds/Math.PI*30);this.handAngles.seconds=Math.floor(a/Math.PI*30)*Math.PI/30;l=Math.floor(this.handAngles.seconds/Math.PI*30);45<h&&h<=59&&0<=l&&l<15?this.ctr++:15>h&&h>=0&&59<=l&&l>=45&&this.ctr--,h=Math.floor(this.handAngles.minutes/Math.PI*30);var c,d=Math.floor(this.handAngles.seconds/Math.PI*30)*Math.PI/1800;0==d&&(d=Math.PI/1800),(c=(Math.floor(this.initialAngles.minutes/Math.PI*30+this.ctr)*Math.PI/30+d)%(2*Math.PI))<0?(this.handAngles.minutes=2*Math.PI+c,this.initialAngles.minutes=2*Math.PI+c,this.ctr=0):this.handAngles.minutes=c,l=Math.floor(this.handAngles.minutes/Math.PI*30),45<h&&h<=59&&0<=l&&l<15?this.ctr1++:15>h&&h>=0&&59<=l&&l>=45&&this.ctr1--,(c=Math.floor(this.initialAngles.hours/Math.PI*6+this.ctr1)*Math.PI/6+Math.floor(this.handAngles.minutes%(2*Math.PI)/Math.PI*30)*Math.PI/360)<0?(this.handAngles.hours=2*Math.PI+c,this.initialAngles.hours=2*Math.PI+c,this.ctr1=0):this.handAngles.hours=c}}this.drawHandsInSetTime()},Clock.prototype.writeTimeInSetTime=function(){var t;this.timeToBeDisplayed.seconds=Math.floor(Number.parseFloat(30*this.handAngles.seconds/Math.PI).toFixed(5)),this.timeToBeDisplayed.minutes=Math.floor(Number.parseFloat(this.handAngles.minutes%(2*Math.PI)*30/Math.PI).toFixed(5))%60,t=Math.floor(Number.parseFloat(this.handAngles.hours%(2*Math.PI)*6/Math.PI).toFixed(5)),this.timeToBeDisplayed.hours=0!=t?t:12,this.displayTime(this.timeToBeDisplayed.hours,this.timeToBeDisplayed.minutes,this.timeToBeDisplayed.seconds),this.updateSizes(),this.drawBackground()},Clock.prototype.writeTimeInSetTimeGame=function(){this.writeTime=!0,this.textTimeElem.style.display="block",null==this.timeToBeDisplayed.hours&&(this.timeToBeDisplayed.hours=Math.floor(12*Math.random())+1,this.timeToBeDisplayed.minutes=Math.floor(60*Math.random()),this.timeToBeDisplayed.seconds=Math.floor(60*Math.random()));this.displayTime(this.timeToBeDisplayed.hours,this.timeToBeDisplayed.minutes,this.timeToBeDisplayed.seconds,"??"),this.updateSizes(),this.drawBackground()},Clock.prototype.drawSmiley=function(){if(this.isSmiley){var t=this.clockCanvasElem.getContext("2d");t.lineCap="round",t.lineWidth=10*this.lineWidthBase,t.strokeStyle=this.colors.yellow,t.beginPath(),t.arc(this.centerX,this.centerY,.5*this.radius,0,Math.PI),t.stroke(),t.beginPath(),t.arc(this.centerX-.3*this.radius,this.centerY-.3*this.radius,25,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(this.centerX+.3*this.radius,this.centerY-.3*this.radius,25,0,2*Math.PI),t.stroke()}};var d=new Clock;d.start();var r=document.getElementById("simple-clock-button");r.onclick=function(){d.changeFace("simple")};var m=document.getElementById("nice-clock-button");m.onclick=function(){d.changeFace("nice")};new i.RadioButtonsGroup([r,m]);document.getElementById("write-time-button").onclick=function(){if(!d.setTimeGame){this.classList.toggle("active");var t=this.classList.contains("active");d.changeWriteTime(t)}},document.getElementById("write-date-button").onclick=function(){this.classList.toggle("active");var t=this.classList.contains("active");d.changeWriteDate(t)},document.getElementById("set-time-button").onclick=function(){d.setTime?(d.setTime=!1,d.isSmiley=!1,document.getElementById("set-time-button").classList.remove("active")):(d.setTime=!0,d.isSmiley=!1,d.setTimeGame=!1,document.getElementById("set-timeGame-button").classList.remove("active"),document.getElementById("set-time-button").classList.add("active"),d.writeTimeInSetTime())},document.getElementById("set-timeGame-button").onclick=function(){d.setTimeGame?(d.setTimeGame=!1,d.isSmiley=!1,d.timeToBeDisplayed={hours:void 0,minutes:void 0,seconds:void 0},document.getElementById("set-timeGame-button").classList.remove("active"),document.getElementById("write-time-button").classList.remove("active"),d.changeWriteTime(!1)):(d.setTimeGame=!0,d.writeDate=!1,d.timeToBeDisplayed={hours:void 0,minutes:void 0,seconds:void 0},d.isSmiley=!1,d.setTime=!1,document.getElementById("set-time-button").classList.remove("active"),document.getElementById("set-timeGame-button").classList.add("active"),document.getElementById("write-time-button").classList.add("active"),d.handAngles.seconds=0,d.handAngles.minutes=0,d.handAngles.hours=0,d.writeTimeInSetTimeGame())};var u="ontouchstart"in document.documentElement;function handleOnMouseDown(t){var e=["hours","minutes","seconds"],i=[.4,.607,.8125];u&&(t=t.touches[0]);for(var s=0;s<3;s++){var n=e[s],a=.08*d.radius,o=d.centerX+d.handSizes[n]*i[s]*Math.sin(d.handAngles[n]),h=d.centerY-d.handSizes[n]*i[s]*Math.cos(d.handAngles[n]);const l=d.clockCanvasElem.getBoundingClientRect(),c=t.clientX-l.left,r=t.clientY-l.top;if(d.canvasX=c,d.canvasY=r,Math.sqrt(Math.pow(o-c,2)+Math.pow(h-r,2))<=a){d.isDrag=!0,d.selectedHand=n,d.initiateAngles=!0;break}}}function handleOnMouseUp(t){for(var e in d.isDrag=!1,d.ctr=0,d.ctr1=0,this.handAngles)this.initialAngles[e]=this.handAngles[e]}function handleOnMouseMove(t){u&&(t=t.touches[0]);const e=d.clockCanvasElem.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top;if(d.canvasX=i,d.canvasY=s,d.setTimeGame){var n=["hours","minutes","seconds"],a=[];a.push(Math.PI/6*(d.timeToBeDisplayed.hours%12)+Math.PI/360*d.timeToBeDisplayed.minutes),a.push(Math.PI/30*d.timeToBeDisplayed.minutes+Math.PI/1800*d.timeToBeDisplayed.seconds),a.push(Math.PI/30*d.timeToBeDisplayed.seconds);for(var o=0,h=0;h<3;h++){var l=n[h],c=d.handAngles[l]%(2*Math.PI),r=a[h];Math.abs(c-r)<3*Math.PI/180&&o++}d.isSmiley=3==o}d.setTime&&d.writeTimeInSetTime()}u?(d.clockCanvasElem.addEventListener("touchstart",handleOnMouseDown,!1),d.clockCanvasElem.addEventListener("touchend",handleOnMouseUp,!1),d.clockCanvasElem.addEventListener("touchmove",handleOnMouseMove,!1)):(d.clockCanvasElem.onmousedown=handleOnMouseDown,d.clockCanvasElem.onmouseup=handleOnMouseUp,d.clockCanvasElem.onmousemove=handleOnMouseMove),document.getElementById("stop-button").addEventListener("click",(function(e){var i={face:d.face,writeTime:d.writeTime,writeDate:d.writeDate,isSetTime:d.setTime,isSetTimeGame:d.setTimeGame,isSmiley:d.isSmiley,handAngles:d.handAngles,timeToBeDisplayed:d.timeToBeDisplayed};t.getDatastoreObject().setDataAsText(i),t.getDatastoreObject().save((function(t){null===t?console.log("write done."):console.log("write failed.")}))}))}))}));