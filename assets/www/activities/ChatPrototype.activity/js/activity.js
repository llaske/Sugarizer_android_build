/*! Sugarizer 2020-03-14 */
define(["sugar-web/activity/activity","webL10n","sugar-web/graphics/palette","sugar-web/graphics/presencepalette","sugar-web/datastore","sugar-web/graphics/journalchooser","tutorial","sugar-web/env"],function(a,b,c,d,e,f,g,h){var a=requirejs("sugar-web/activity/activity");requirejs(["domReady!"],function(c){function i(a){var b;do{b=a,a=a.replace(m,"")}while(a!==b);return a.replace(/</g,"&lt;")}function j(){d.popDown(),s=a.getPresenceObject(function(a,c){if(a)return p.innerHTML=b.get("Error"),void(p.className="error");t=c.getUserInfo(),p.innerHTML=b.get("Connected"),p.className="open",n.readOnly=!1,window.top.sugar.environment.sharedId||c.createSharedActivity("org.sugarlabs.ChatPrototype",function(a){}),c.onConnectionClosed(function(a){console.log(b.get("ConnectionClosed")),p.innerHTML=b.get("DisconnectedFromWebSocket"),p.className="closed"}),c.onSharedActivityUserChanged(function(a){var c=a.user.name.replace("<","&lt;").replace(">","&gt;");o.innerHTML+='<li class="received" style = "color:blue">'+c+" "+(a.move>0?b.get("Join"):b.get("Leave"))+" "+b.get("Chat")+"</li>",r.style.visibility="visible"}),c.onDataReceived(function(a){if("text"==a.type||void 0===a.type){var b=a.content,c=a.user.name.replace("<","&lt;").replace(">","&gt;"),d=a.user.colorvalue,e='<span style = "color:'+d.stroke+';width: auto; padding-right: 10px;">'+c+":</span>";myElem=document.createElement("li"),myElem.class="received",myElem.style.background=d.fill,myElem.innerHTML=e+b,myElem.style.color=d.stroke,o.appendChild(myElem),q.scrollTop=q.scrollHeight}else if("image"==a.type){var f=a.content,c=a.user.name.replace("<","&lt;").replace(">","&gt;"),d=a.user.colorvalue,e='<span style = "color:'+d.stroke+';width: auto; padding-right: 10px;">'+c+":</span>";myElem=document.createElement("li"),myElem.class="received",myElem.style.background=d.fill,myElem.innerHTML=e+"<img src='"+f+"' style='max-height:150px;'>",myElem.style.color=d.stroke,o.appendChild(myElem),q.scrollTop=q.scrollHeight}})})}function k(a,b){var c={user:t,content:a,type:b};s.sendMessage(s.getSharedInfo().id,c)}a.setup(),h.getEnvironment(function(a,c){var d="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,e=c.user?c.user.language:d;b.language.code=e});var l="(?:[^\"'>]|\"[^\"]*\"|'[^']*')*",m=new RegExp("<(?:!--(?:(?:-*[^->])*--+|-?)|script\\b"+l+">[\\s\\S]*?</script\\s*|style\\b"+l+">[\\s\\S]*?</style\\s*|/?[a-z]"+l+")>","gi"),n=(document.getElementById("message-form"),document.getElementById("message")),o=document.getElementById("messages"),p=document.getElementById("status"),q=document.getElementById("content"),r=document.getElementById("image-upload");window.addEventListener("localized",function(){document.getElementById("status").innerHTML=b.get("status"),n.placeholder=b.get("WriteYourMessage")});var s,t=null,u=document.getElementById("network-button");d=new d.PresencePalette(u,void 0),d.addEventListener("shared",j),window.top.sugar.environment.sharedId&&(j(),d.setShared(!0)),n.onkeydown=function(a){if(13===a.keyCode){return k(i(n.value),"text"),n.placeholder=b.get("WriteYourMessage"),n.value="",n.setSelectionRange(0,0),!1}},r.addEventListener("click",function(a){f.show(function(a){if(a){new e.DatastoreObject(a.objectId).loadAsText(function(a,b,c){k(c,"image")})}},{mimetype:"image/png"},{mimetype:"image/jpeg"})});for(var v,w=document.getElementById("smiley-button"),x=[[128513,128515],[128517,128519],[128521,128528]],y=0;y<x.length;y++)for(var z=x[y],A=z[0];A<z[1];A++)v=document.createElement("option"),v.value=A,v.innerHTML="&#"+A+";",w.appendChild(v);for(var B,C=document.getElementById("sad-button"),D=[[128531,128533],[128545,128551],[128555,128558]],y=0;y<D.length;y++)for(var z=D[y],A=z[0];A<z[1];A++)B=document.createElement("option"),B.value=A,B.innerHTML="&#"+A+";",C.appendChild(B);for(var E,F=document.getElementById("others-button"),G=[[128568,128573],[128582,128588]],y=0;y<G.length;y++)for(var z=G[y],A=z[0];A<z[1];A++)E=document.createElement("option"),E.value=A,E.innerHTML="&#"+A+";",F.appendChild(E);document.getElementById("help-button").addEventListener("click",function(a){g.start()})})});