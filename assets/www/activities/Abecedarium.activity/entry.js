/*! Sugarizer 2019-09-21 */
enyo.kind({name:"Abcd.Entry",kind:"Abcd.Item",published:{index:"",imageonly:!1,textonly:!1,soundonly:!1,tojournal:0},classes:"entry",components:[{name:"spinner",kind:"Image",src:"images/spinner-light.gif",classes:"spinner"},{name:"contentBox",showing:!1,components:[{name:"itemImage",classes:"entryImage",kind:"Image",onload:"imageLoaded",onerror:"imageError"},{name:"soundIcon",kind:"Image",classes:"entrySoundIcon"},{name:"itemText",classes:"entryText"}]},{kind:"Signals",onEndOfSound:"endOfSound"}],events:{onEntrySoundEnded:""},create:function(){this.inherited(arguments),this.sound=null,this.imageonlyChanged(),this.textonlyChanged(),this.soundonlyChanged(),this.indexChanged(),this.tojournalChanged()},imageLoaded:function(){""!==this.index&&(this.$.spinner.hide(),this.$.contentBox.show())},imageError:function(){Abcd.goHome()},imageonlyChanged:function(){this.imageonly&&Abcd.changeVisibility(this,{itemImage:!0,soundIcon:!1,itemText:!1})},textonlyChanged:function(){this.textonly&&Abcd.changeVisibility(this,{itemImage:!1,soundIcon:!1,itemText:!0})},soundonlyChanged:function(){this.soundonly&&Abcd.changeVisibility(this,{itemImage:!1,soundIcon:!0,itemText:!1})},tojournalChanged:function(){this.tojournal?this.$.soundIcon.setSrc("icons/journal.svg"):this.$.soundIcon.setSrc("images/sound_off"+(this.soundonly?1:0)+".png"),this.$.soundIcon.render()},setLocale:function(){this.indexChanged(),this.inherited(arguments)},indexChanged:function(){var a=Abcd.entries[this.index],b=Abcd.context.getDatabase()+"images/database/"+a.code+".png",c=__$FC(a.text);1==Abcd.context.casevalue&&(c=c.toUpperCase()),this.soundonly&&this.$.soundIcon.addClass("entrySoundIconOnly"),a[Abcd.context.lang]?(this.sound=Abcd.context.getDatabase()+"audio/"+Abcd.context.lang+"/database/"+a.code,this.$.soundIcon.setSrc("images/sound_off"+(this.soundonly?1:0)+".png")):(this.sound=null,this.$.soundIcon.setSrc("images/sound_none"+(this.soundonly?1:0)+".png")),this.$.itemImage.setAttribute("src",b),this.$.itemText.removeClass("entryText0"),this.$.itemText.removeClass("entryText1"),this.$.itemText.removeClass("entryText2"),this.$.itemText.addClass("entryText"+Abcd.context.casevalue),this.imageonly&&this.$.itemImage.addClass("entryImageOnly"),this.$.itemText.setContent(c),this.textonly&&this.$.itemText.addClass("entryTextOnly")},exportToImage:function(){var a=Abcd.entries[this.index],b=this.$.itemImage.hasNode(),c=document.createElement("canvas"),d=c.getContext("2d");c.width=c.height=210,d.drawImage(b,0,0,c.width,c.height);var e=c.toDataURL("image/png"),f={mimetype:"image/png",title:__$FC(a.text)+".png",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};Abcd.datastore.create(f,function(){console.log("image '"+__$FC(a.text)+"' saved in journal.")},e)},exportToSound:function(){var a="",b="";!Abcd.sound.canPlayType("audio/mpeg")||enyo.platform.android||enyo.platform.androidChrome?Abcd.sound.canPlayType("audio/ogg")&&(a=".ogg",b="audio/ogg"):(a=".mp3",b="audio/mpeg");var c="";0==this.sound.indexOf("http")?c=this.sound+a:(c=window.location.href,c=c.substring(0,c.indexOf("/index.html")),c+="/"+this.sound+a);var d=new XMLHttpRequest;d.open("GET",c,!0),d.setRequestHeader("Content-type",b),d.responseType="arraybuffer";var e=this;d.onload=function(){if(200==d.status||0==d.status){var c=Abcd.entries[e.index],f=new Uint8Array(this.response),g="data:"+b+";base64,"+Abcd.toBase64(f),h={mimetype:b,title:__$FC(c.text)+a,activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};Abcd.datastore.create(h,function(){console.log("sound '"+__$FC(c.text)+"' saved in journal.")},g)}},d.send()},play:function(a){if(this.tojournal)return 1==this.tojournal?this.exportToImage():this.exportToSound(),this.tojournal=0,void this.indexChanged();null!=this.sound&&(this.$.soundIcon.setSrc("images/sound_on"+(this.soundonly?1:0)+".png"),a.play(this.sound))},endOfSound:function(a,b){b.sound==this.sound&&(this.doEntrySoundEnded(),this.$.soundIcon.setSrc("images/sound_off"+(this.soundonly?1:0)+".png"))},abort:function(){void 0!==this.$.soundIcon&&this.$.soundIcon.setSrc("images/sound_off"+(this.soundonly?1:0)+".png")}});