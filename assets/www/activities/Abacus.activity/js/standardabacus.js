/*! Sugarizer 2020-03-14 */
function StandardAbacus(a,b,c,d,e,f,g,h){void 0===h&&(h=b),this.blockScaleYFromX=25/33,this.topBottomBarScale=1.6,this.leftRightBarScale=1.6*this.blockScaleYFromX,this.middleBarScale=1,this.horizontalMargin=1/3,this.verticalMargin=.05,this.extraBeads=2,this.rods=b,this.blockHeight=0,this.blockWidth=0,this.abacusHeight=0,this.abacusWidth=0,this.upperBlockHeight=0,this.lowerBlockHeight=0,this.stage=a,this.topcolumns=[],this.bottomcolumns=[],this.rodtext=[],this.answertext=null,this.trix=null,this.startx=null,this.blockGivenWidth=function(a){return a/(2*this.leftRightBarScale+b+this.horizontalMargin*b)},this.blockGivenHeight=function(a){return a/(2*this.topBottomBarScale+(c+this.extraBeads)+this.verticalMargin*(c+this.extraBeads)+this.middleBarScale+(e+this.extraBeads)+this.verticalMargin*(e+this.extraBeads))},this.heightGivenBlockWidth=function(a){return this.blockScaleYFromX*a*(2*this.topBottomBarScale+(c+this.extraBeads)+this.verticalMargin*(c+this.extraBeads)+this.middleBarScale+(e+this.extraBeads)+this.verticalMargin*(e+this.extraBeads))},this.widthGivenBlockWidth=function(a){return a*(2*this.leftRightBarScale+b+this.horizontalMargin*b)},this.initValues=function(){var b=.85*a.canvas.height,d=.9*a.canvas.width,f=this.blockGivenWidth(d),g=this.blockScaleYFromX*f;this.heightGivenBlockWidth(f)>b&&(g=this.blockGivenHeight(b),f=g/this.blockScaleYFromX,console.log("Using height")),this.blockHeight=g,this.blockWidth=f,this.abacusHeight=this.heightGivenBlockWidth(this.blockWidth),this.abacusWidth=this.widthGivenBlockWidth(this.blockWidth),this.upperBlockHeight=this.blockHeight*(c+this.extraBeads+this.verticalMargin*(c+this.extraBeads)),this.lowerBlockHeight=this.blockHeight*(e+this.extraBeads+this.verticalMargin*(e+this.extraBeads)),console.log(this.blockHeight),console.log(this.blockWidth),console.log(this.abacusHeight),console.log(this.abacusWidth),this.startx=(a.canvas.width-this.abacusWidth)/2+this.leftRightBarScale*this.blockWidth+this.horizontalMargin*this.blockWidth/2+this.blockWidth/2},this.initRectangle=function(){var b=new createjs.Shape;b.graphics.beginStroke("#000000"),b.graphics.setStrokeStyle(this.leftRightBarScale*this.blockWidth),b.graphics.beginFill("#C0C0C0").drawRoundRect(this.leftRightBarScale*this.blockWidth/2,this.leftRightBarScale*this.blockWidth/2,this.abacusWidth-this.leftRightBarScale*this.blockWidth,this.abacusHeight-this.leftRightBarScale*this.blockWidth,2/3*this.blockWidth),b.x=(a.canvas.width-this.abacusWidth)/2,b.y=a.canvas.height/10,a.addChild(b)},this.initDivider=function(){var b=new createjs.Shape;b.graphics.beginFill("#000000").drawRect(0,0,this.abacusWidth-this.leftRightBarScale*this.blockWidth*2,this.middleBarScale*this.blockHeight),b.x=(a.canvas.width-this.abacusWidth)/2+this.leftRightBarScale*this.blockWidth,b.y=a.canvas.height/10+this.leftRightBarScale*this.blockWidth+this.upperBlockHeight,a.addChild(b),console.log(b)},this.initTriangle=function(){this.tri=new createjs.Shape;var c=this.blockWidth/4*3,d=a.canvas.height/10+this.leftRightBarScale*this.blockWidth*2/3,e=(a.canvas.width-this.abacusWidth)/2+this.leftRightBarScale*this.blockWidth+this.horizontalMargin*this.blockWidth/2+this.blockWidth/2,f=this.horizontalMargin*this.blockWidth+this.blockWidth,g=e+f*(b-1);this.tri.graphics.moveTo(0-c/2,0).beginFill("#FC0D1B").lineTo(0+c/2,0).lineTo(0,0+this.leftRightBarScale*this.blockWidth/3).lineTo(0-c/2,0).closePath(),this.tri.x=g-this.blockWidth/2,this.tri.y=d,a.addChild(this.tri),this.trix=this.tri.x-this.startx;var h=this.tri,i=this;this.tri.on("mousedown",function(a){this.offset={x:h.x-a.stageX,y:h.y-a.stageY}}),this.tri.on("pressmove",function(a){a.stageX+this.offset.x<e-i.blockWidth/2?h.x=e-i.blockWidth/2:a.stageX+this.offset.x>g+i.blockWidth/2?h.x=g+i.blockWidth/2:h.x=a.stageX+this.offset.x,i.trix=h.x-i.startx})},this.initColumns=function(){var i,j=(a.canvas.width-this.abacusWidth)/2+this.leftRightBarScale*this.blockWidth+this.horizontalMargin*this.blockWidth/2+this.blockWidth/2,k=this.horizontalMargin*this.blockWidth+this.blockWidth,l=a.canvas.height/10+this.leftRightBarScale*this.blockWidth,m=l+this.upperBlockHeight,n=["#A0A0A0","#6B6B6B"],o=["#000000","#000000"];console.log(g);for(var p,q,r=g.fill,s=g.stroke,t=0;t<b;t++){if(t%2==0?(i=o,p=r):(i=n,p=s),h-t-1<0){var u=new window.Fraction(1);q=new window.Fraction(Math.pow(f,Math.abs(h-t-1))),q=u.div(q).mul(d)}else q=new window.Fraction(Math.pow(f,h-t-1)).mul(d);var v=new StandardAbacusColumn(j,l,m,c,0,c+this.extraBeads,p,i,this,q,!0);v.init(),this.topcolumns.push(v),j+=k}l=m+this.middleBarScale*this.blockHeight,m=l+this.lowerBlockHeight,j=(a.canvas.width-this.abacusWidth)/2+this.leftRightBarScale*this.blockWidth+this.horizontalMargin*this.blockWidth/2+this.blockWidth/2;for(var t=0;t<b;t++){if(t%2==0?(i=o,p=r):(i=n,p=s),h-t-1<0){var u=new window.Fraction(1);q=new window.Fraction(Math.pow(f,Math.abs(h-t-1))),q=u.div(q)}else q=new window.Fraction(Math.pow(f,h-t-1));var v=new StandardAbacusColumn(j,l,m,0,e,e+this.extraBeads,p,i,this,q,!1);v.init(),this.bottomcolumns.push(v),j+=k}},this.initTextItems=function(){for(var c=(a.canvas.width-this.abacusWidth)/2+this.leftRightBarScale*this.blockWidth+this.horizontalMargin*this.blockWidth/2+this.blockWidth/2,d=this.horizontalMargin*this.blockWidth+this.blockWidth,e=0;e<b;e++){var f=new createjs.Text("",(a.canvas.width/70).toString()+"px Arial","#FFF");f.set({textAlign:"center"}),f.x=c,f.y=a.canvas.height/10+this.abacusHeight-this.leftRightBarScale*this.blockWidth/2,a.addChild(f),this.rodtext.push(f),c+=d}var f=new createjs.Text("",this.blockWidth.toString()+"px Arial","#000");f.set({textAlign:"center"}),f.x=a.canvas.width/2,f.y=a.canvas.height/40,a.addChild(f),this.answertext=f},this.updateTextItems=function(){if(this.bottomcolumns.length==b){for(var a=[],c=new window.Fraction(0,1),e=0;e<b;e++){this.topcolumns[e].updateAges(),this.bottomcolumns[e].updateAges();var f=this.topcolumns[e].howManyInUse(),g=this.bottomcolumns[e].howManyInUse(),h=d*f.length;h+=g.length,this.rodtext[e].text=0!=h?h.toString():"";var i=new window.Fraction(0,1),j=this.topcolumns[e].value;j=j.mul(f.length),i=i.add(j),j=this.bottomcolumns[e].value,j=j.mul(g.length),i=i.add(j);var k=new window.Fraction(0);i.equals(k)||(a.push(i.toFraction(!0)),c=c.add(i))}var k=new window.Fraction(0);if(1==a.length){var l=c.toFraction(!0);this.answertext.text=l}else if(c.equals(k))this.answertext.text="";else{for(var l="",e=0;e<a.length-1;e++)l+=a[e]+" + ";l+=a[a.length-1]+" = "+c.toFraction(!0),this.answertext.text=l}this.answertext.text.length>=40?this.answertext.font=parseInt(this.blockWidth/this.answertext.text.length*40)+"px Arial":this.answertext.font=this.blockWidth.toString()+"px Arial"}},this.restore=function(a){for(var b=(a[0],a[1],0);b<a[0].length;b++)this.topcolumns[b].restore(a[0][b]);for(var b=0;b<a[1].length;b++)this.bottomcolumns[b].restore(a[1][b]);for(var b=0;b<a[0].length;b++)this.topcolumns[b].restoreAge(a[0][b]);for(var b=0;b<a[1].length;b++)this.bottomcolumns[b].restoreAge(a[1][b])},this.save=function(){for(var a=[[],[]],b=0;b<this.topcolumns.length;b++)a[0].push(this.topcolumns[b].save());for(var b=0;b<this.bottomcolumns.length;b++)a[1].push(this.bottomcolumns[b].save());return a},this.saveTri=function(){return console.log(this.trix),this.trix/this.abacusWidth},this.restoreTri=function(a){console.log(a),this.tri.x=this.startx+a*this.abacusWidth,this.trix=this.tri.x-this.startx,console.log(this.tri.x)},this.init=function(){this.initValues(),this.initRectangle(),this.initDivider(),this.initColumns(),this.initTextItems(),this.initTriangle()}}