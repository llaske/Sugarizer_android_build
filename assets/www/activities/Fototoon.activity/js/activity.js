/*! Sugarizer 2020-03-14 */
define(["sugar-web/activity/activity","sugar-web/datastore","sugar-web/env","textpalette","sugar-web/graphics/menupalette","sugar-web/graphics/journalchooser","lzstring","webL10n","toon","tutorial","picoModal"],function(a,b,c,d,e,f,g,h,i,j,k){function l(a){return translation=h.get(a),""==translation&&(translation=a),translation}var m,n=75;c.getEnvironment(function(a,b){var c="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language;m=b.user?b.user.language:c,h.language.code=m,console.log("LANG "+m)}),requirejs(["domReady!"],function(o){a.setup();var p={version:"1",boxs:[{globes:[]}]},q=document.getElementById("mainCanvas"),r=document.getElementById("sortCanvas");q.height=window.innerHeight-n-5,q.width=4*q.height/3,q.style.left=(window.innerWidth-q.width)/2+"px";var s=document.getElementById("previous-button");s.title=l("Previous"),s.addEventListener("click",function(a){x.showPreviousBox()});var t=document.getElementById("next-button");t.title=l("Next"),t.addEventListener("click",function(a){x.showNextBox()});var u=document.getElementById("text-button");u.title=l("EditText");var v=new d.TextPalette(u,x,l("SetGlobeText")),w=document.getElementById("page-counter"),x=new i.Model(p,q,v);x.init(),x.attachPageCounterViewer(w),x.attachPrevNextButtons(s,t);var y=!0,z=document.getElementById("add-globe");z.title=l("AddAglobe");for(var A=[{icon:!0,id:i.TYPE_GLOBE,label:l("Globe")},{icon:!0,id:i.TYPE_EXCLAMATION,label:l("Exclamation")},{icon:!0,id:i.TYPE_WHISPER,label:l("Whisper")},{icon:!0,id:i.TYPE_CLOUD,label:l("Think")},{icon:!0,id:i.TYPE_RECTANGLE,label:l("Box")}],B=new e.MenuPalette(z,l("AddAglobe"),A),C=0;C<B.buttons.length;C++)B.buttons[C].addEventListener("click",function(a){x.addGlobe(this.id)});var D=document.getElementById("add-button");D.title=l("Add"),D.addEventListener("click",function(a){f.show(function(a){if(a){new b.DatastoreObject(a.objectId).loadAsText(function(b,c,d){var e=document.createElement("img");"org.olpcfrance.PaintActivity"==a.metadata.activity?e.src=g.decompressFromUTF16(JSON.parse(d).src):e.src=d,e.onload=function(){x.addImage(e.src)}})}},{mimetype:"image/png"},{mimetype:"image/jpeg"},{activity:"org.olpcfrance.PaintActivity"})}),c.getEnvironment(function(b,c){c.objectId&&a.getDatastoreObject().loadAsText(function(a,b,c){if(null==a&&null!=c){var d=JSON.parse(c),e=d.dataWithoutImages,f=d.dataImages;e.images={};for(var g in f){var h=g;e.images[h]=LZString.decompressFromUTF16(f[h])}x.setData(e),y||(x.changeToEditMode(),y=!0)}})}),document.getElementById("stop-button").addEventListener("click",function(b){console.log("writing..."),x.showWait(),y||(x.finishSort(),x.init(),y=!0);var c={};c.version=x.getData().version,c.boxs=x.getData().boxs,dataImages={};for(var d in x.getData().images){var e=d;console.log("saving image "+e),dataImages[e]=LZString.compressToUTF16(x.getData().images[e])}var f={dataWithoutImages:c,dataImages:dataImages};x.hideWait();var g=JSON.stringify(f);a.getDatastoreObject().setDataAsText(g),a.getDatastoreObject().save(function(a){null===a?console.log("write done."):console.log("write failed.")})});var E=document.getElementById("image-save");E.title=l("SaveAsImage");for(var F=[{id:"0",label:l("OneRow")},{id:"1",label:l("OneColumn")},{id:"2",label:l("TwoColumns")}],G=new e.MenuPalette(E,l("SaveAsImage"),F),C=0;C<G.buttons.length;C++)G.buttons[C].addEventListener("click",function(a){x.saveAsImage(this.id)});var H=document.getElementById("sort-button");H.title=l("Sort"),x.attachSortButton(H),H.addEventListener("click",function(a){if(!(x.getData().boxs.length<3)){if(x.showWait(),y){x.initPreviews(),r.width=window.innerWidth-2*n;var b=r.width/x.getData().boxs.length;r.height=3*b/4,r.style.left=(window.innerWidth-r.width)/2+"px",r.style.top=(window.innerHeight-r.height)/2+"px",x.initSort(r)}else x.finishSort(),x.init();x.hideWait(),y=!y}});var I=document.getElementById("clean-all-button");I.title=l("Clean");var J=l("CancelChanges"),K=l("Continue"),L=l("CleanAllMessage"),M=l("Warning");I.addEventListener("click",function(a){y&&k({content:"<div style = 'width:400px;margin-bottom:60px'><div style='width:50px;float:left'><img src='icons/emblem-warning.svg' style='padding:10px;height:40px;'></div><div style='width:300px;float:left;margin-left:20px;'><div style='color:white;margin-top:10px;'><b>"+M+"</b></div><div style='color:white;margin-top:2px;'>"+L+"</div></div></div><div><button class='cancel-changes warningbox-cancel-button'><img  src='icons/dialog-cancel.svg' style='width: 20px; height: 16px;margin-right:5px;'> "+J+"</button> <button class='continue warningbox-refresh-button'><img src='icons/dialog-ok.svg' style='width: 20px; height: 16px;margin-right:5px;'> "+K+"</button></div>",closeButton:!1,modalStyles:{backgroundColor:"#000000",height:"120px",width:"60%",textColor:"white"}}).afterCreate(function(a){a.modalElem().addEventListener("click",function(b){b.target&&b.target.matches(".continue")?(x._data.boxs.splice(1,x._data.boxs.length-1),x._data.boxs[0].globes=[],x._data.previews=[],x.init(),a.close()):b.target&&b.target.matches(".cancel-changes")&&a.close()})}).show()}),document.getElementById("help-button").addEventListener("click",function(a){h.language.code=m;var b=1;window.addEventListener("localized",function(){b&&(b=0,j.start(m))})})})});