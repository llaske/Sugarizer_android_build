define(["sugar-web/activity/activity","sugar-web/env","picoModal","webL10n","tutorial"],(function(e,t,i,n,r){requirejs(["domReady!"],(function(s){e.setup();var a=document.getElementById("canvas"),l=document.getElementById("mainCanvas"),o=new createjs.Stage("mainCanvas");createjs.Touch.enable(o);var c=[[8,6],[12,10],[20,15]],g=15,h=0,d=0,u=c[h].slice(),_=["#E6000A","#00EA11","#FFFA00","#5E008C","#FF8F00"],m={},p=[],y=[],v=[],f=[];o.enableMouseOver(30);var B=!0,b="playing",C="#5959B3";document.getElementById("undo").addEventListener("click",(function(){1==B&&Undo()})),document.getElementById("redo").addEventListener("click",(function(){1==B&&Redo()})),document.getElementById("new-game").addEventListener("click",(function(){new_game(h)})),document.getElementById("replay").addEventListener("click",(function(){1==B&&function replay_game(){if("playing"==b){var e=Object.keys(m);for(var t in e){t=e[parseInt(t)];for(var i=0;i<m[t].length;i++){(n=o.getChildByName(`${t}_${i}`)).graphics._instructions[2].style=_[m[t][i]-1],n.prev_color=_[m[t][i]-1]}}}else o.removeAllChildren(),init();for(t=0;t<v.length;t++){var n,r=v[t].split("_");(n=o.getChildByName(`${parseInt(r[0])}_${parseInt(r[1])}`)).highlighted=!1,n.graphics._stroke.style="#5959B3",n.graphics._strokeStyle.width=border_width(h)}p=[],y=[],v=[],adjust_circle()}()})),document.getElementById("easy").addEventListener("click",(function(){new_game(0)})),document.getElementById("medium").addEventListener("click",(function(){new_game(1)})),document.getElementById("hard").addEventListener("click",(function(){new_game(2)})),document.getElementById("help-button").addEventListener("click",(function(e){r.start()}));var w=!1;function button_highlight(e){0==e?(document.getElementById("easy").style.backgroundColor="grey",document.getElementById("medium").style.backgroundColor="#282828",document.getElementById("hard").style.backgroundColor="#282828"):1==e?(document.getElementById("easy").style.backgroundColor="#282828",document.getElementById("medium").style.backgroundColor="grey",document.getElementById("hard").style.backgroundColor="#282828"):(document.getElementById("easy").style.backgroundColor="#282828",document.getElementById("medium").style.backgroundColor="#282828",document.getElementById("hard").style.backgroundColor="grey")}function SetMaxSize(e){for(var t=Object.keys(e),i=0,n=0;n<t.length;n++)i<e[parseInt(t[n])].length&&(i=e[parseInt(t[n])].length);u[0]=t.length,u[1]=i}function new_game(e){button_highlight(e),o.removeAllChildren(),d=2==(h=e)?2:0,u=c[h].slice();var t=generate_board(d,5,u);t[0].simplify(),SetMaxSize(m=t[0]._data),p=[],y=[],v=[],stage_resize(),init()}function draw_square(e,t,i,n){e.graphics.beginStroke("#5959B3"),e.graphics.setStrokeStyle(border_width(h)),e.graphics.beginFill(n),e.graphics.drawRect(t*g,i*g,g-border_width(h),g-border_width(h)),e.graphics.endFill()}function border_width(e){return Math.floor(g/10)}function init(){b="playing";for(var e=0;e<u[0];e++)for(var t=0,i=u[1]-1;i>=0;i--){draw_square(a=new createjs.Shape,e,t,"#5959B3"),a.name=`${e}_${i}`,a.highlighted=!1,a.marked=!1,a.prev_color="#5959B3",a.addEventListener("mouseover",(function(e){1==B&&"ontouchstart"in document.documentElement==0&&(highlight_mouseover(e.target),o.update())})),a.addEventListener("click",(function(e){1==B&&"ontouchstart"in document.documentElement==1&&HandleTap(e)})),o.addChild(a),t++}var n=Object.keys(m);for(var e in n){e=n[parseInt(e)];for(i=0;i<m[e].length;i++){var r=o.getChildByName(`${e}_${i}`);r.graphics._instructions[2].style=_[m[e][i]-1],r.prev_color=_[m[e][i]-1]}}var s=new createjs.Shape,a=o.getChildByName("0_0");s.graphics.beginFill("white").drawCircle(a.graphics._instructions[1].h/2+a.graphics._instructions[1].x,a.graphics._instructions[1].h/2+a.graphics._instructions[1].y,a.graphics._instructions[1].h/9),s.graphics.endFill(),s.name="white_circle",s.parent_box=a.name,o.addChild(s),highlight_mouseover(a),o.update()}document.getElementById("fullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.display="none",document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",w=!0,"won"==b?winning_smiley(C):stage_resize()})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.display="block",document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",w=!1,"won"==b?winning_smiley(C):stage_resize()})),document.addEventListener("keydown",(function(e){var t=e.which||e.keyCode;null!=keys[t]&&"visible"!=document.getElementById("activity-palette").style.visibility&&e.preventDefault()})),document.addEventListener("keyup",(function(e){e.preventDefault();var t=e.which||e.keyCode,i=o.getChildByName("white_circle");if(1==B&&"visible"!=document.getElementById("activity-palette").style.visibility)switch(keys[t]){case"up":if(null!=i&&"playing"==b){var n=i.parent_box.split("_"),r=o.getChildByName(`${parseInt(n[0])}_${parseInt(n[1])+1}`);null!=r&&1==r.visible&&(highlight_mouseover(r),o.update())}break;case"down":if(null!=i&&"playing"==b){n=i.parent_box.split("_");var s=o.getChildByName(`${parseInt(n[0])}_${parseInt(n[1])-1}`);null!=s&&1==s.visible&&(highlight_mouseover(s),o.update())}break;case"left":if(null!=i&&"playing"==b){n=i.parent_box.split("_");var a=o.getChildByName(`${parseInt(n[0])-1}_${parseInt(n[1])}`);null!=a&&1==a.visible&&(highlight_mouseover(a),o.update())}break;case"right":if(null!=i&&"playing"==b){n=i.parent_box.split("_");var l=o.getChildByName(`${parseInt(n[0])+1}_${parseInt(n[1])}`);null!=l&&1==l.visible&&(highlight_mouseover(l),o.update())}break;case"select":"playing"==b&&move();break;case"new":new_game(h);break;case"easy_level":new_game(0);break;case"medium_level":new_game(1);break;case"hard_level":new_game(2);break;case"undo_move":Undo();break;case"redo_move":Redo()}}));var k=!1;function HandleTap(e){e.preventDefault(),1==e.target.highlighted&&v.length>2?(highlight_mouseover(e.target),move()):(highlight_mouseover(e.target),o.update())}function move(){if(v.length>2&&1==B){B=!1;for(var e=createjs.Ticker.on("tick",o),t=0;t<v.length;t++)createjs.Tween.get(o.getChildByName(v[t])).to({alpha:0},150);setTimeout((function(){createjs.Ticker.off("tick",e);for(var t=0;t<v.length;t++)o.getChildByName(v[t]).alpha=1;!function drop(){y=[];for(var e=0;e<u[0]*u[1];e++){var t=o.getChildAt(e);t.prev_color=t.graphics._instructions[2].style}for(var i=0;i<u[0];i++)for(var n=0;n<u[1];n++)if(o.getChildByName(`${i}_${n}`).highlighted){for(var r=n;r<u[1];r++){var s=o.getChildByName(`${i}_${r}`),a=o.getChildByName(`${i}_${r+1}`);r<u[1]-1?(s.graphics._instructions[2].style=a.graphics._instructions[2].style,s.highlighted=a.highlighted):(s.graphics._instructions[2].style="#5959B3",s.highlighted=!1)}n--}}();for(t=0;t<v.length;t++){var r=v[t].split("_"),s=o.getChildByName(`${parseInt(r[0])}_${parseInt(r[1])}`);s.highlighted=!1,s.graphics._stroke.style="#5959B3",s.graphics._strokeStyle.width=border_width()}o.update(),setTimeout((function(){!function shiftLeft(){for(var e=0;e<u[0];e++)if("#5959B3"==o.getChildByName(e+"_0").graphics._instructions[2].style)for(var t=e;t<u[0];t++){var i=1;if(t+i<u[0])for(;"#5959B3"==o.getChildByName(t+i+"_0").graphics._instructions[2].style&&(i++,t+i!=u[0]););for(var n=0;n<u[1];n++)if(t+i!=u[0]){var r=o.getChildByName(`${t}_${n}`),s=o.getChildByName(`${t+i}_${n}`);r.graphics._instructions[2].style=s.graphics._instructions[2].style,o.getChildByName(`${t+i}_${n}`).graphics._instructions[2].style="#5959B3"}}for(var a={},l=0;l<u[0]*u[1];l++){(g=o.getChildAt(l)).graphics._instructions[2].style!=g.prev_color&&(a[g.name]=g.prev_color)}for(l=0;l<v.length;l++){var c=v[l].split("_"),g=o.getChildByName(`${parseInt(c[0])}_${parseInt(c[1])}`);a[g.name]=g.prev_color}p.push(a),v=[]}(),adjust_circle(),function IsGameOver(){for(var e=0;e<u[0]*u[1];e++){var t=o.getChildAt(e);if(1==t.visible){var r=t.name.split("_");r[0]=parseInt(r[0]),r[1]=parseInt(r[1]),sameColorLeft(r[0],r[1],t.graphics._instructions[2].style);for(var s=f.length,a=0;a<f.length;a++){var l=f[a].split("_");l[0]=parseInt(l[0]),l[1]=parseInt(l[1]),o.getChildByName(`${l[0]}_${l[1]}`).marked=!1}if(f=[],s>2)return}}"#5959B3"==o.getChildByName("0_0").graphics._instructions[2].style?setTimeout((function(){b="won",winning_smiley(C=o.getChildByName("0_0").prev_color)}),5):setTimeout((function(){!function lose(){var e=n.get("Continue"),t=n.get("StuckMessage");i({content:"<div style = 'width:400px;margin-bottom:60px'><div style='width:40vw;float:left;margin-left:20px;'><div style='color:white;margin-top:10px;font-size:18px;'>"+t+"</div></div></div><div><button class='continue warningbox-refresh-button'>"+e+"</button></div>",closeButton:!1,modalStyles:{backgroundColor:"#000000",height:"120px",width:"60%",textColor:"white"}}).afterCreate((function(e){e.modalElem().addEventListener("click",(function(t){(t.target&&t.target.matches(".continue")||t.target&&t.target.matches(".cancel-changes"))&&e.close()}))})).show()}()}),500)}(),B=!0}),150)}),300)}}function adjust_circle(){var e=o.getChildByName("white_circle").parent_box;k=!0,highlight_mouseover(o.getChildByName(e)),k=!1,stage_resize()}function highlight_mouseover(e){var t=o.getChildByName("white_circle"),i=e.name.split("_");if(i[0]=parseInt(i[0]),i[1]=parseInt(i[1]),"#5959B3"!=o.getChildByName(i[0]+"_0").graphics._instructions[2].style){clear_prev_higlight();var n=e.graphics._instructions[1].h/2+e.graphics._instructions[1].x,r=e.graphics._instructions[1].h/2+e.graphics._instructions[1].y;t.graphics._instructions[1].x=n,t.graphics._instructions[1].y=r,t.graphics._instructions[1].radius=e.graphics._instructions[1].h/9,t.parent_box=e.name}else if("#5959B3"==o.getChildByName(i[0]+"_0").graphics._instructions[2].style&&1==k){clear_prev_higlight();for(var s=u[0]-1;s>=0&&"#5959B3"==o.getChildByName(s+"_0").graphics._instructions[2].style;s--);if(-1==s)return;(i=(e=o.getChildByName(`${s}_${i[1]}`)).name.split("_"))[0]=parseInt(i[0]),i[1]=parseInt(i[1]);n=e.graphics._instructions[1].h/2+e.graphics._instructions[1].x,r=e.graphics._instructions[1].h/2+e.graphics._instructions[1].y;t.graphics._instructions[1].x=n,t.graphics._instructions[1].y=r,t.graphics._instructions[1].radius=e.graphics._instructions[1].h/9,t.parent_box=e.name}if("#5959B3"!=e.graphics._instructions[2].style||0==e.highlighted){var a=o.getChildByName(`${i[0]}_${i[1]}`).graphics._instructions[2].style;!function sameColorBlocks(e,t,i){var n=o.getChildByName(`${e}_${t}`),r=n.graphics._instructions[2].style;if("#5959B3"==r||n.highlighted||r!=i)return;n.highlighted=!0,v.push(`${e}_${t}`),t>0&&sameColorBlocks(e,t-1,i);t<u[1]-1&&sameColorBlocks(e,t+1,i);e>0&&sameColorBlocks(e-1,t,i);e<u[0]-1&&sameColorBlocks(e+1,t,i)}(i[0],i[1],a),function highlight_same_color(){if(v.length>2)for(var e=0;e<v.length;e++){var t=v[e].split("_");t[0]=parseInt(t[0]),t[1]=parseInt(t[1]);var i=o.getChildByName(`${t[0]}_${t[1]}`);i.graphics._stroke.style="white",i.graphics._strokeStyle.width=border_width()}}()}}function clear_prev_higlight(){for(var e=0;e<v.length;e++){var t=v[e].split("_");t[0]=parseInt(t[0]),t[1]=parseInt(t[1]);var i=o.getChildByName(`${t[0]}_${t[1]}`);i.highlighted=!1,i.graphics._stroke.style="#5959B3",i.graphics._strokeStyle.width=border_width()}v=[]}function sameColorLeft(e,t,i){var n=o.getChildByName(`${e}_${t}`),r=n.graphics._instructions[2].style;"#5959B3"==r||n.marked||r!=i||(n.marked=!0,f.push(`${e}_${t}`),t>0&&sameColorLeft(e,t-1,i),t<u[1]-1&&sameColorLeft(e,t+1,i),e>0&&sameColorLeft(e-1,t,i),e<u[0]-1&&sameColorLeft(e+1,t,i))}function winning_smiley(e){o.removeAllChildren(),o.removeAllEventListeners(),p=[],y=[],v=[];var t=(window.innerWidth-200)/10;l.height=w?window.innerHeight-45:window.innerHeight-95,t<(g=l.height/9)&&(g=t),l.width=10*g+15,l.height=9*g+8;for(var i=0;i<10;i++)for(var n=0;n<9;n++){var r=new createjs.Shape;r.graphics.beginStroke("#5959B3"),r.graphics.setStrokeStyle(5),r.graphics.beginFill("#5959B3"),r.graphics.drawRect(i*g,n*g,g-5,g-5),r.graphics.endFill(),r.name=`${i}_${n}`,o.addChild(r)}setTimeout((function(){for(var t=2;t<8;t++){o.getChildByName(t+"_0").graphics._instructions[2].style=e,o.getChildByName(t+"_8").graphics._instructions[2].style=e}for(t=2;t<7;t++){o.getChildByName("0_"+t).graphics._instructions[2].style=e,o.getChildByName("9_"+t).graphics._instructions[2].style=e}o.getChildByName("1_1").graphics._instructions[2].style=e,o.getChildByName("8_1").graphics._instructions[2].style=e,o.getChildByName("1_7").graphics._instructions[2].style=e,o.getChildByName("8_7").graphics._instructions[2].style=e,o.update(),setTimeout((function(){o.getChildByName("3_3").graphics._instructions[2].style=e,o.getChildByName("6_3").graphics._instructions[2].style=e,o.getChildByName("2_5").graphics._instructions[2].style=e,o.getChildByName("7_5").graphics._instructions[2].style=e;for(var t=3;t<7;t++){o.getChildByName(t+"_6").graphics._instructions[2].style=e}o.update()}),100)}),100)}function Undo(){if(p.length>0){for(var e={},t=p[p.length-1],i=Object.keys(t),n=0;n<i.length;n++){var r=i[n].split("_"),s=o.getChildByName(`${parseInt(r[0])}_${parseInt(r[1])}`),a=t[i[n]];e[i[n]]=s.graphics._instructions[2].style,s.graphics._instructions[2].style=a}p.pop(),y.push(e),adjust_circle()}}function Redo(){if(y.length>0){for(var e={},t=y[y.length-1],i=Object.keys(t),n=0;n<i.length;n++){var r=i[n].split("_"),s=o.getChildByName(`${parseInt(r[0])}_${parseInt(r[1])}`),a=t[i[n]];e[i[n]]=s.graphics._instructions[2].style,s.graphics._instructions[2].style=a}y.pop(),p.push(e),adjust_circle()}}function stage_resize(){document.getElementById("activity-palette").style.left=window.innerWidth>770?"55px":"8px";var e=!1,t=0,i=0;if(o.children.length>0){for(var n=0;n<u[0]*u[1];n++){(h=o.getChildAt(n)).visible=!0}for(n=u[1]-1;n>=0;n--){for(var r=0;r<u[0];r++)if("#5959B3"!=o.getChildByName(`${r}_${n}`).graphics._instructions[2].style){e=!0;break}if(1==e)break;t++}for(n=u[1]-1;n>=u[1]-t;n--)for(r=0;r<u[0];r++)o.getChildByName(`${r}_${n}`).visible=!1;e=!1;for(n=u[0]-1;n>=0;n--){for(r=0;r<u[1];r++)if("#5959B3"!=o.getChildByName(`${n}_${r}`).graphics._instructions[2].style){e=!0;break}if(1==e)break;i++}for(n=u[0]-1;n>=u[0]-i;n--)for(r=0;r<u[1];r++)o.getChildByName(`${n}_${r}`).visible=!1}var s=g,a=(window.innerWidth-200)/(u[0]-i);if(l.height=w?window.innerHeight-45:window.innerHeight-95,a<(g=l.height/(u[1]-t))&&(g=a),l.width=g*(u[0]-i)+15,l.height=g*(u[1]-t)+8,o.children.length>0&&s!=g){r=0;var c=0;for(n=0;n<u[0]*u[1];n++){var h;(h=o.getChildAt(n)).graphics._instructions[1].h=g-border_width(),h.graphics._instructions[1].w=g-border_width(),h.graphics._instructions[1].x=c*g,h.graphics._instructions[1].y=r*g,h.graphics._instructions[3].width=border_width(),r==u[1]-1?(r=0,c++):r++}}if(o.x=10,o.y=5,o.children.length>0){var d=o.getChildByName("white_circle"),_=o.getChildByName(d.parent_box);if(null!=_){0==_.visible&&(_=o.getChildByName("0_0"),d.parent_box="0_0");var m=_.graphics._instructions[1].h/2+_.graphics._instructions[1].x,p=_.graphics._instructions[1].h/2+_.graphics._instructions[1].y;d.graphics._instructions[1].x=m,d.graphics._instructions[1].y=p,d.graphics._instructions[1].radius=_.graphics._instructions[1].h/9,highlight_mouseover(_)}}u[1]-t-1>=0&&o.children.length>0&&o.setTransform(10,-1*(o.getChildByName("0_"+(u[1]-t-1)).graphics._instructions[1].y-5)),o.update()}a.addEventListener("click",(function(e){"ontouchstart"in document.documentElement==0&&move()})),t.getEnvironment((function(t,i){currentenv=i;var r="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,s=i.user?i.user.language:r;if(n.language.code=s,i.objectId)e.getDatastoreObject().loadAsText((function(e,t,i){if(null==e&&null!=i){var n=JSON.parse(i);if(button_highlight(h=n.level),d=2==h?2:0,u=c[h].slice(),SetMaxSize(m=n.pieces),p=n.undo_stack,y=n.redo_stack,"won"==n.game_status)b="won",C=n.smiley_color,winning_smiley(n.smiley_color);else{init();for(var r=0;r<o.children.length;r++){var s=o.getChildAt(r);"white_circle"!=s.name&&(s.graphics._instructions[2].style=n.blocks_data[s.name][0],s.prev_color=n.blocks_data[s.name][1],s.visible=n.blocks_data[s.name][2])}var a=o.getChildByName("white_circle");a.parent_box=n.circle_parent,highlight_mouseover(o.getChildByName(a.parent_box)),stage_resize()}}}));else{button_highlight(h),d=2==h?2:0;var a=generate_board(d,5,u);a[0].simplify(),SetMaxSize(m=a[0]._data),stage_resize(),init()}})),document.getElementById("stop-button").addEventListener("click",(function(t){if(console.log("writing..."),"won"==b)var i={blocks_data:{},level:h,pieces:m,undo_stack:p,redo_stack:y,circle_parent:"",game_status:b,smiley_color:C};else{for(var n={},r=0;r<u[0]*u[1];r++){var s=[],a=o.getChildAt(r);s.push(a.graphics._instructions[2].style),s.push(a.prev_color),s.push(a.visible),n[a.name]=s}var l=o.getChildByName("white_circle");i={blocks_data:n,level:h,pieces:m,undo_stack:p,redo_stack:y,circle_parent:l.parent_box,game_status:b,smiley_color:C}}var c=JSON.stringify(i);e.getDatastoreObject().setDataAsText(c),e.getDatastoreObject().save((function(e){null===e?console.log("write done."):console.log("write failed.")}))})),window.addEventListener("resize",(function(){"won"==b?winning_smiley(C):stage_resize()})),window.addEventListener("localized",(function(){document.getElementById("new-game").title=n.get("NewGame"),document.getElementById("replay").title=n.get("Replay"),document.getElementById("undo").title=n.get("Undo"),document.getElementById("redo").title=n.get("Redo"),document.getElementById("easy").title=n.get("Easy"),document.getElementById("medium").title=n.get("Medium"),document.getElementById("hard").title=n.get("Hard")}))}))}));