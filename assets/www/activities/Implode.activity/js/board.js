function Board(){this._data={},this.repeat=function(e,t){for(var r=[],n=0;n<t;[n++].push.apply(r,e));return r},this.get_value=function(e,t){var r=this._data[e];if(null!=r)return 0<=t&&t<r.length?r[t]:void 0},this.set_value=function(e,t,r){if(t>=0){var n=this._data[e];if(null==n){if(void 0!==r){var a=this.repeat([void 0],t);a=a.concat([r]),this._data[e]=a}}else t<n.length?(n[t]=r,null==r&&this._trim_column(e)):null==r||(n=(n=n.concat(this.repeat([void 0],t-n.length))).concat([r]),this._data[e]=n)}},this.get_column_height=function(e){return col=this._data[e],null==col?0:col.length},this.width=function(){return this.max_x()-this.min_x()},this.height=function(){return this.max_y()-this.min_y()},this.min_x=function(){if(0==Object.keys(this._data).length)return 0;for(var e=Object.keys(this._data),t=0;t<e.length;t++)e[t]=parseInt(e[t]);return Math.min(0,Math.min(...e))},this.max_x=function(){if(0==Object.keys(this._data).length)return 0;for(var e=Object.keys(this._data),t=0;t<e.length;t++)e[t]=parseInt(e[t]);return Math.max(0,Math.max(...e))+1},this.min_y=function(){return 0},this.max_y=function(){if(0==Object.keys(this._data).length)return 0;for(var e=Object.values(this._data),t=[],r=0;r<e.length;r++)t[r]=e[r].length;return Math.max(0,Math.max(...t))},this.is_empty=function(){return 0==Object.keys(this._data).length},this.get_col_value=function(e){return this._data[e]},this._trim_column=function(e){var t=this._data[e];if(void 0===t[t.length-1]){var r=[...Array(t.length).keys()].reverse();for(var n in r)if(void 0!==t[n=r[n=parseInt(n)]])return void(this._data[e]=t.slice(0,n+1));delete this._data[e]}},this.items=function(){var e=[],t=Object.keys(this._data);for(var r in t)r=parseInt(r),e.push([parseInt(t[r]),this._data[parseInt(t[r])]]);return e},this.insert_columns=function(e,t){if(t>=0){var r={},n=this.items();for(var a in n){var i=n[a=parseInt(a)][0],_=n[a][1];i<e?r[i]=_:r[i+t]=_}this._data=JSON.parse(JSON.stringify(r))}},this.simplify=function(){var e=Object.keys(this._data);for(var t in e){t=e[t=parseInt(t)];for(var r=0;r<this._data[t].length;r++){var n=this._data[t][r];-1!=n&&null!=n&&null!=n||(this._data[t].splice(r,1),r-=1)}0==this._data[t].length&&delete this._data[t]}e=Object.keys(this._data);for(t=0;t<e.length;t++)t==parseInt(e[t])||(this._data[t]=this._data[parseInt(e[t])],delete this._data[parseInt(e[t])])},this.__repr__=function(){var e=this.width(),t=this.height(),r=[];for(var n in[...Array(t).keys()]){var a=[];for(j in[...Array(e).keys()]){n=parseInt(n),j=parseInt(j);var i=this.get_value(j,n);null==i?a.push("."):-1==i?a.push("*"):a.push(i.toString())}r.push(a.join(""))}return r.reverse(),r.join("\n")}}var max_size=[];function generate_board(e=0,t=5,r=[30,20]){max_size=r;var n=_get_piece_sizes(e),a=new Board,i=[];for(var _ in n){_=parseInt(_);var s=_try_add_piece(a,parseInt(n[_]),t,max_size),h=(a=s[0],s[1]);void 0!==h&&i.splice(0,0,h)}return[a,i]}function _try_add_piece(e,t,r,n){var a=new Board;a._data=JSON.parse(JSON.stringify(e._data));var i=_get_starting_change(a,r,n);if(null==i)return[e,void 0];_make_change(a,i);for(var _=1;_<t;){var s=_try_add_cells(a,r,n);if(!(s>0)){if(_>=3)break;return[e,void 0]}_+=s}for(var h=_get_new_piece_coords(a),o=h[0],c=1;c<h.length;c++)h[c][0]<o[0]&&h[c][1]<o[1]&&(o=h[c]);return _color_piece_random(a,r),[a,o]}function arrayRemove(e,t){return e.filter((function(e){return e!=t}))}function choice(e){return e[Math.floor(Math.random()*e.length)]}function _get_starting_change(e,t,r){for(var n=_enumerate_one_cell_changes(e,r);n.length>0;){var a=choice(n);if(n=arrayRemove(n,a),_change_is_colorable(e,a,t))return a}}function _enumerate_one_cell_changes(e,t){var r=t[0],n=t[1],a=[],i=e.width();if(i<r&&n>=1){var _=[...Array(i+1).keys()];for(var s in _){var h=new _InsertColumnChange(_[s=parseInt(s)],1);a.push(h)}}_=[...Array(i).keys()];for(var s in _){s=parseInt(s);var o=e.get_column_height(_[s]);if(o<n){var c=[...Array(o+1).keys()];for(var l in c){l=parseInt(l);h=new _InsertCellChange(_[s],c[l]);a.push(h)}}}return a}function _try_add_cells(e,t,r){for(var n=_get_cell_changes(e,r),a=n[0],i=n[1],_=_get_col_changes(e,r);a.length>0||i.length>0||_.length>0;){var s=_remove_change(a,i,_);if(_change_is_colorable(e,s,t))return _make_change(e,s),s instanceof _InsertCellChange?1:s.height}return 0}function _get_cell_changes(e,t){t[0];var r=t[1],n=[],a=[],i=e.width();for(var _ in[...Array(i).keys()]){_=parseInt(_);var s=e.get_column_height(_);if(s<r)for(var h in[...Array(s+1).keys()])if(h=parseInt(h),-1!=e.get_value(_,h))if(-1==e.get_value(_+1,h)||-1==e.get_value(_-1,h)){var o=new _InsertCellChange(_,h);n.push(o)}else if(-1==e.get_value(_,h-1)||-1==e.get_value(_,h+1)){o=new _InsertCellChange(_,h);a.push(o)}}return[n,a]}function _get_col_changes(e,t){var r=t[0],n=t[1],a=e.width();if(a==r||n<1)return[];var i=[];for(var _ in[...Array(a).keys()]){_=parseInt(_);var s=e.get_column_height(_),h=0;for(var o in[...Array(s).keys()]){o=parseInt(o),-1==e.get_value(_,o)&&(h=o+1)}i.push(h)}var c=[],l=[i.concat([0]),[0].concat(i)].reduce((e,t)=>t.map((t,r)=>(e[r]||[]).concat(t)),[]);for(var _ in l){var u=l[_=parseInt(_)][0],g=l[_][1],f=Math.max(u,g);if(f>0){var v=new _InsertColumnChange(_,f);c.push(v)}}return c}function _remove_change(e,t,r){var n=10*e.length,a=5*t.length,i=1*r.length,_=Math.floor(Math.random()*(n+a+i));return _pick(_<n?e:_<n+a?t:r)}function _pick(e){var t=Math.floor(Math.random()*e.length);return e[t]?e.splice(t,1)[0]:e.pop()}function _change_is_colorable(e,t,r){var n=new Board;return n._data=JSON.parse(JSON.stringify(e._data)),_make_change(n,t),_get_new_piece_colors(n,r).length>0}function _make_change(e,t){if(t instanceof _InsertColumnChange){e.insert_columns(t.col,1),e._data=JSON.parse(JSON.stringify(e._data));var r=[...Array(t.height).keys()];for(var n in r)n=parseInt(n),e.set_value(t.col,r[n],-1)}else if(t instanceof _InsertCellChange){var a=[],i=[],_=e.get_column_height(t.col);if(t.height<=_){for(var n in[...Array(_).keys()]){n=parseInt(n);var s=e.get_value(t.col,n);n==t.height&&i.push(-1),-1==s?a.push(n):i.push(s)}for(index in t.height==_&&i.push(-1),a)index=parseInt(index),i.splice(a[index],0,-1);for(var n in i){s=i[n=parseInt(n)];e.set_value(t.col,n,s)}}}}function _color_piece_random(e,t){_color_piece(e,choice(_get_new_piece_colors(e,t)))}function _color_piece(e,t){var r=_get_new_piece_coords(e);for(var n in r){var a=r[n=parseInt(n)][0],i=r[n][1];e.set_value(a,i,t)}}function _get_new_piece_colors(e,t){for(var r=[],n=1;n<t+1;n++)r[n-1]=n;var a=_get_new_piece_coords(e);for(var i in a){n=a[i=parseInt(i)][0];var _=a[i][1],s=[[-1,0],[1,0],[0,-1],[0,1]];for(var h in s){var o=s[h=parseInt(h)][0],c=s[h][1];r=arrayRemove(r,e.get_value(n+o,_+c))}}return r}function _get_new_piece_coords(e){var t=[],r=[...Array(e.width()).keys()];for(var n in r){n=parseInt(n);var a=e.get_column_height(r[n]),i=[...Array(a).keys()];for(var _ in i)_=parseInt(_),n=r[n],_=i[_],-1==e.get_value(n,_)&&t.push([n,_])}return t}function _get_piece_sizes(e){for(var t=max_size[0]*max_size[1]*.5,r=0,n=[];r<t;){var a=_get_piece_size(t,e);r+=a,n.push(a)}return n}function _get_piece_size(e,t){var r=Math.ceil(Math.sqrt(e));value=Math.random();var n=t;return piece_size=parseInt(Math.max(3,Math.pow(value,n)*r)),piece_size}function _InsertColumnChange(e,t){this.col=e,this.height=t,this.__eq__=function(e){return e instanceof _InsertColumnChange&&this.col==this.col&&this.height==e.height},this.__ne__=function(e){return!this.__eq__(e)},this.__repr__=function(){return`_InsertColumnChange(${this.col}, ${this.height})`}}function _InsertCellChange(e,t){this.col=e,this.height=t,this.__eq__=function(e){return e instanceof _InsertCellChange&&this.col==e.col&&this.height==e.height},this.__ne__=function(e){return!this.__eq__(e)},this.__repr__=function(){return`_InsertCellChange(${this.col}, ${this.height})`}}