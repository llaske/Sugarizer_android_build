(function(){"use strict";var t,n,e,i,r,o,s,a={}.hasOwnProperty,h=[].indexOf||function(t){for(var n=0,e=this.length;n<e;n++)if(n in this&&this[n]===t)return n;return-1};o=window.gearsketch.Point,t=window.gearsketch.ArcSegment,r=window.gearsketch.LineSegment,s=window.gearsketch.Util,window.gearsketch.model={},i=function(){function Gear(t,n,e,i,r,o,a,h,u){this.location=t,this.rotation=n,this.numberOfTeeth=e,this.id=i,this.momentum=null!=r?r:0,this.group=null!=o?o:0,this.level=null!=a?a:0,this.connections=null!=h?h:{},null==this.id&&(this.id=s.createUUID()),this.pitchRadius=s.MODULE*(.5*this.numberOfTeeth),this.innerRadius=s.MODULE*(.5*this.numberOfTeeth-1.25),this.outerRadius=s.MODULE*(.5*this.numberOfTeeth+1),this.hue=null!=u?u:Math.floor(360*Math.random())}return Gear.prototype.getCircumference=function(){return 2*Math.PI*this.pitchRadius},Gear.prototype.distanceToPoint=function(t){return Math.max(0,this.location.distance(t)-this.pitchRadius)},Gear.prototype.edgeDistance=function(t){var n;return n=this.location.distance(t.location),Math.abs(n-this.pitchRadius-t.pitchRadius)},Gear.prototype.restore=function(t){return this.location=t.location,this.rotation=t.rotation,this.momentum=t.momentum,this.group=t.group,this.level=t.level,this.connections=t.connections},Gear.prototype.clone=function(){return new Gear(this.location.clone(),this.rotation,this.numberOfTeeth,this.id,this.momentum,this.group,this.level,s.clone(this.connections),this.hue)},Gear.fromObject=function(t){return new Gear(o.fromObject(t.location),t.rotation,t.numberOfTeeth,t.id,t.momentum,t.group,t.level,t.connections,t.hue)},Gear}(),window.gearsketch.model.Gear=i,e=function(){function Chain(t,n,e,i,r){this.id=n,this.group=null!=e?e:0,this.level=null!=i?i:0,this.connections=null!=r?r:{},null==this.id&&(this.id=s.createUUID()),this.points=s.clone(t),this.rotation=0}return Chain.WIDTH=8,Chain.prototype.points=[],Chain.prototype.segments=[],Chain.prototype.getLength=function(){return this.segments.reduce((function(t,n){return t+n.getLength()}),0)},Chain.prototype.getCircumference=function(){return this.getLength()},Chain.prototype.getStartingPoint=function(){return this.direction===s.Direction.CLOCKWISE?this.rotation/(2*Math.PI)*this.getLength():-this.rotation/(2*Math.PI)*this.getLength()},Chain.prototype.findPointOnChain=function(t){var n,e,i,r,o,a,h;for(e=this.getLength(),n=s.mod(t+this.getStartingPoint(),e),o=0,a=(h=this.segments).length;o<a;o++){if(n<(r=(i=h[o]).getLength()))return i.findPoint(n);n-=r}return null},Chain.prototype.findPointsOnChain=function(t){var n,e,i,r;for(n=this.getLength()/t,r=[],e=i=0;0<=t?i<t:i>t;e=0<=t?++i:--i)r.push(this.findPointOnChain(e*n));return r},Chain.prototype.distanceToPoint=function(t){var n;return Math.min.apply(null,function(){var e,i,r,o;for(o=[],e=0,i=(r=this.segments).length;e<i;e++)n=r[e],o.push(n.distanceToPoint(t));return o}.call(this))},Chain.prototype.distanceToSegment=function(t){var n;return Math.min.apply(null,function(){var e,i,r,o;for(o=[],e=0,i=(r=this.segments).length;e<i;e++)n=r[e],o.push(n.distanceToSegment(t));return o}.call(this))},Chain.prototype.distanceToChain=function(t){var n;return Math.min.apply(null,function(){var e,i,r,o;for(o=[],e=0,i=(r=this.segments).length;e<i;e++)n=r[e],o.push(t.distanceToSegment(n));return o}.call(this))},Chain.prototype.intersectsPath=function(t){var n,e,i,o;for(n=i=0,o=t.length-1;0<=o?i<o:i>o;n=0<=o?++i:--i)if(e=n+1,0===this.distanceToSegment(new r(t[n],t[e])))return!0;return!1},Chain.prototype.crossesNonSupportingGears=function(t){var n,e,i;for(e in i=t.getGears())if(a.call(i,e)&&(n=i[e],!(h.call(this.supportingGearIds,e)>=0||e in this.ignoredGearIds)&&this.distanceToPoint(n.location)<n.pitchRadius+s.EPSILON))return!0;return!1},Chain.prototype.findPointOnSupportingGear=function(t,n){return n?this.points[s.mod(2*t-1,this.points.length)]:this.points[2*t]},Chain.prototype.removeGear=function(t,n){for(var e,i,r,o,a,h,u,c,d,l;-1!==(u=this.supportingGearIds.indexOf(t.id));)c=(h=n.getGearsWithIds(this.supportingGearIds)).length,o=s.mod(u-1,c),r=h[o],i=s.mod(u+1,c),e=n.getAcknowledgedGears(this.ignoredGearIds),d=[this.findPointOnSupportingGear(u,!0),this.findPointOnSupportingGear(u,!1),this.findPointOnSupportingGear(i,!0)],l=this.findSupportingGearsOnPath(e,r,d,0,!1),h.splice.apply(h,[u,1].concat(l)),this.removeRepeatedGears(h),this.supportingGearIds=function(){var t,n,e;for(e=[],t=0,n=h.length;t<n;t++)a=h[t],e.push(a.id);return e}();return this.update(n)},Chain.prototype.findChainTangentSide=function(t){return this.direction===s.Direction.CLOCKWISE==t.id in this.innerGearIds?s.Side.LEFT:s.Side.RIGHT},Chain.prototype.findReverseChainTangentSide=function(t){return this.findChainTangentSide(t)===s.Side.LEFT?s.Side.RIGHT:s.Side.LEFT},Chain.prototype.findFirstSupportingGearOnPath=function(t,n){var e,i,o,a,h;for(10,a=s.getLength(t),h=null,e=t[0],o=0;o<a&&null==h;)o+=10,i=s.findPointOnPath(t,o),h=s.findNearestIntersectingGear(n,new r(e,i));return[h,o]},Chain.prototype.findSupportingGearsOnPath=function(t,n,e,i,o){var a,h,u,c,d,l,p,g,f,G;for(null==i&&(i=0),null==o&&(o=!0),10,l=s.getLength(e,o),p=n,g=[],a=n.location,u=i;u<l;)u+=10,h=s.findPointOnPath(e,u),G=this.findReverseChainTangentSide(p),null!=(f=s.findGearTangentPoints(h,p)[G])&&(a=f),c=new r(a,h),null!=(d=s.findNearestIntersectingGear(t,c,s.makeSet(p.id)))&&(p=d,g.push(p));return g},Chain.prototype.removeRepeatedGears=function(t){var n,e,i,r;for(r=0,n=0;r<(i=t.length);)e=(n+1)%i,t[n]===t[e]?(t.splice(e,1),r=0):(r++,n=(n+1)%i);return t},Chain.prototype.containsSuccessiveOverlappingGears=function(t){var n,e,i,r,o,s;for(o=t.length,i=s=0;0<=o?s<o:s>o;i=0<=o?++s:--s)if(r=(i+1)%o,n=t[i],e=t[r],n.location.distance(e.location)<n.outerRadius+e.outerRadius)return!0;return!1},Chain.prototype.findSupportingGearIds=function(t){var n,e,i,r,o,a,h,u,c,d,l,p,g,f;for(e=(p=this.findFirstSupportingGearOnPath(this.points,t))[0],a=p[1],h=[e],o=this.findSupportingGearsOnPath(t,e,this.points,a),h=h.concat(o),c=this.findChainTangentSide(e),null!=(u=s.findGearTangentPoints(this.points[0],e)[c])&&(n=[this.points[0],u],r=h[h.length-1],o=this.findSupportingGearsOnPath(t,r,n,0,!1),h=h.concat(o)),f=[],d=0,l=(g=this.removeRepeatedGears(h)).length;d<l;d++)i=g[d],f.push(i.id);return f},Chain.prototype.findIgnoredGearIds=function(t){var n,e,i,r,o,h,u,c,d,l,p,g,f,G;for(d in f={},u=t.getGears())a.call(u,d)&&(c=(h=u[d]).group,p=h.level,r=s.pointPathDistance(h.location,this.points)-h.pitchRadius,(null==(null!=(G=f[c])?G[p]:void 0)||r<f[c][p])&&(null==f[c]&&(f[c]={}),f[c][p]=r));for(c in n={},f)if(a.call(f,c))for(p in g=f[c])a.call(g,p)&&(o=g[p],(null==(i=n[c])||o>0&&((e=f[c][i])<0||o<e))&&(n[c]=parseInt(p,10)));for(d in l={},u)a.call(u,d)&&n[(h=u[d]).group]!==h.level&&(l[d]=!0);return l},Chain.prototype.findIgnoredGearIdsInTightenedChain=function(t){var n,e,i,r,o,s,h,u,c,d,l;for(r={},u=0,c=(d=this.supportingGearIds).length;u<c;u++)e=d[u],i=(n=t.getGearWithId(e)).group,s=n.level,null==r[i]&&(r[i]={}),r[i][s]=!0;for(o in h={},l=t.getGears())a.call(l,o)&&(i=(n=l[o]).group,s=n.level,null!=r[i]&&null==r[i][s]&&(h[o]=!0));return this.ignoredGearIds=h},Chain.prototype.toPolygon=function(t){var n,e,i,o;for(null==t&&(t=this.segments),n=[],i=0,o=t.length;i<o;i++)(e=t[i])instanceof r?n.push(e.start):(n.push(e.findPoint(0)),n.push(e.findPoint(.5*e.getLength())));return n},Chain.prototype.update=function(n,e){var i,o,u,c,d,l,p,g,f,G,v,C,m,I,y,T,O,S,A,B,P,L,M,b,N,R,E,w,D,x,H,j,F,k,_,U,W,X,K,V,q,Y,z,J,Q;if(null==e&&(e=n.getGearsWithIds(this.supportingGearIds)),e.length<2)return!1;if(this.containsSuccessiveOverlappingGears(e))return!1;for(_=this.findIgnoredGearIdsInTightenedChain(n),i=n.getAcknowledgedGears(_),C=0;C<(P=e.length);){if(y=(C+1)%P,T=(C+2)%P,p=e[C],g=e[y],f=e[T],S=s.findTangentLine(p,g,this.innerGearIds,this.direction),A=s.findTangentLine(g,f,this.innerGearIds,this.direction),null!=(I=S.findIntersection(A)))return j=this.findReverseChainTangentSide(p),H=s.findGearTangentPoints(I,p)[j],F=this.findChainTangentSide(f),R=[H,I,s.findGearTangentPoints(I,f)[F]],E=this.findSupportingGearsOnPath(i,p,R,0,!1),!(h.call(E,g)>=0)&&(e.splice.apply(e,[y,1].concat(E)),this.removeRepeatedGears(e),this.update(n,e));if(null!=(G=s.findNearestIntersectingGear(i,S,s.makeSet(p.id,g.id)))&&(e.splice(y,0,G),this.containsSuccessiveOverlappingGears(e)))return!1;C++}for(W=[],C=K=0;0<=P?K<P:K>P;C=0<=P?++K:--K)y=(C+1)%P,p=e[C],g=e[y],x=s.findTangentLine(p,g,this.innerGearIds,this.direction),W.push(x.start,x.end);for(X=[],C=V=0;0<=P?V<P:V>P;C=0<=P?++V:--V)M=W[2*C],b=W[2*C+1],N=W[(C+1)%P*2],G=e[(C+1)%P],O=new r(M,b),c=Math.atan2(b.y-G.location.y,b.x-G.location.x),o=Math.atan2(N.y-G.location.y,N.x-G.location.x),l=this.direction===s.Direction.CLOCKWISE==G.id in this.innerGearIds?s.Direction.CLOCKWISE:s.Direction.COUNTER_CLOCKWISE,u=new t(G.location,G.pitchRadius,c,o,l),X.push(O,u);for(C=q=0,z=(L=X.length)-2;0<=z?q<z:q>z;C=0<=z?++q:--q)for(y=Y=J=C+2;J<=L?Y<L:Y>L;y=J<=L?++Y:--Y)if((0!==C||y!==L-1)&&(w=X[C],D=X[y],w.distanceToSegment(D)<Chain.WIDTH)){if(C+2===y&&(B=X[C+1])instanceof t&&B.getLength()<2*Chain.WIDTH)continue;if((y+2)%L===C&&(B=X[(y+1)%L])instanceof t&&B.getLength()<2*Chain.WIDTH)continue;return!1}for(m in _=this.findIgnoredGearIdsInTightenedChain(n),k=n.getAcknowledgedGears(_),d=this.toPolygon(X),U={},k)a.call(k,m)&&(G=k[m],s.isPointInsidePolygon(G.location,d)&&(U[m]=!0));for(v in Q=this.innerGearIds)if(a.call(Q,v)&&!(v in U)&&h.call(this.supportingGearIds,v)>=0)return!1;return this.points=W,this.segments=X,this.ignoredGearIds=_,this.innerGearIds=U,this.supportingGearIds=function(){var t,n,i;for(i=[],n=0,t=e.length;n<t;n++)G=e[n],i.push(G.id);return i}(),!0},Chain.prototype.tighten=function(t){var n,e;return this.ignoredGearIds=this.findIgnoredGearIds(t),n=t.getAcknowledgedGears(this.ignoredGearIds),this.innerGearIds=s.makeSetFromList(function(){var t,i,r,o;for(o=[],t=0,i=(r=s.findGearsInsidePolygon(this.points,n)).length;t<i;t++)e=r[t],o.push(e.id);return o}.call(this)),!(Object.keys(this.innerGearIds).length<2)&&(this.direction=s.findDirection(this.points),this.supportingGearIds=this.findSupportingGearIds(n),this.update(t))},Chain.prototype.clone=function(){var t;return(t=new Chain(this.points,this.id,this.group,this.level,s.clone(this.connections))).segments=s.clone(this.segments),t.ignoredGearIds=s.clone(this.ignoredGearIds),t.innerGearIds=s.clone(this.innerGearIds),t.direction=this.direction,t.supportingGearIds=s.clone(this.supportingGearIds),t},Chain.fromObject=function(n){var e,i,s,a;return i=function(n){return null!=n.center?t.fromObject(n):r.fromObject(n)},(e=new Chain(function(){var t,e,i,r;for(r=[],t=0,e=(i=n.points).length;t<e;t++)s=i[t],r.push(new o(s.x,s.y));return r}(),n.id,n.group,n.level,n.connections)).segments=function(){var t,e,r,o;for(o=[],t=0,e=(r=n.segments).length;t<e;t++)a=r[t],o.push(i(a));return o}(),e.ignoredGearIds=n.ignoredGearIds,e.innerGearIds=n.innerGearIds,e.direction=n.direction,e.supportingGearIds=n.supportingGearIds,e},Chain}(),window.gearsketch.model.Chain=e,n=function(){var t,n,r,u,c;function Board(t,n){this.gears=null!=t?t:{},this.chains=null!=n?n:{}}return s.MODULE,t=s.AXIS_RADIUS,u=s.MIN_STACKED_GEARS_TEETH_DIFFERENCE,c=s.SNAPPING_DISTANCE,r=s.EPSILON,n={ANY:"any",MESHING:"meshing",AXIS:"axis",CHAIN_INSIDE:"chain_inside",CHAIN_OUTSIDE:"chain_outside"},Board.prototype.restore=function(t){var n,e;for(n in e=this.gears)a.call(e,n)&&e[n].restore(t.gears[n]);return this.chains=t.chains},Board.prototype.restoreAfterDemo=function(t){return this.gears=t.gears,this.chains=t.chains},Board.prototype.clear=function(){return this.gears={},this.chains={}},Board.prototype.getNextGroup=function(){var t,n,e,i;for(n in e=0,i=this.gears)a.call(i,n)&&(t=i[n],e=Math.max(e,t.group+1));return e},Board.prototype.getGears=function(){return this.gears},Board.prototype.getGearList=function(){var t,n,e,i;for(n in i=[],e=this.gears)a.call(e,n)&&(t=e[n],i.push(t));return i},Board.prototype.getAcknowledgedGears=function(t){var n,e,i,r;for(i in n={},r=this.gears)a.call(r,i)&&(e=r[i],i in t||(n[i]=e));return n},Board.prototype.getLevelScore=function(t){return 1e3*t.group+t.level},Board.prototype.getGearsSortedByGroupAndLevel=function(t){var n=this;return null==t&&(t=this.getGearList()),t.sort((function(t,e){return n.getLevelScore(t)-n.getLevelScore(e)}))},Board.prototype.removeConnection=function(t,n){return delete t.connections[n.id],delete n.connections[t.id]},Board.prototype.removeAllConnections=function(t){var n,e,i;for(e in i=t.connections)a.call(i,e)&&(n=this.getTurningObjects()[e],this.removeConnection(t,n));return this.updateGroupsAndLevels()},Board.prototype.findNearestAxis=function(t){var n,e,i,o,s,h;for(i in o=null,s=Number.MAX_VALUE,h=this.gears)a.call(h,i)&&(n=h[i])!==t&&(e=t.location.distance(n.location),(!o||e<s-r||e<s+r&&n.numberOfTeeth<o.numberOfTeeth)&&(o=n,s=e));return o},Board.prototype.updateGroupsAndLevelsFrom=function(t,e,i,r,o){var s,u,c,d,l,p,g,f;for(l in g=this.getTurningObjects()[t],r[t]=e,o[t]=i,u=g.connections,p=[n.MESHING,n.CHAIN_INSIDE,n.CHAIN_OUTSIDE],f=[],u)a.call(u,l)&&(s=u[l],l in r?f.push(void 0):h.call(p,s)>=0?f.push(this.updateGroupsAndLevelsFrom(l,e,i,r,o)):(c=this.gears[t],d=this.gears[l],c.numberOfTeeth>d.numberOfTeeth?f.push(this.updateGroupsAndLevelsFrom(l,e,i+1,r,o)):f.push(this.updateGroupsAndLevelsFrom(l,e,i-1,r,o))));return f},Board.prototype.updateGroupsAndLevels=function(){var t,n,e,i,r,o,s;for(n in i={},r={},t=0,o=this.gears)a.call(o,n)&&(n in i||(this.updateGroupsAndLevelsFrom(n,t,0,i,r),t++));for(n in s=this.getTurningObjects())a.call(s,n)&&((e=s[n]).group=i[n],e.level=r[n]);return null},Board.prototype.addConnection=function(t,n,e){return t.connections[n.id]=e,n.connections[t.id]=e,this.updateGroupsAndLevels()},Board.prototype.findMeshingNeighbors=function(t){var n,e,i,o;for(e in i=[],o=this.gears)a.call(o,e)&&(n=o[e])!==t&&t.edgeDistance(n)<r&&(n.group===t.group&&n.level!==t.level||i.push(n));return i},Board.prototype.findRelativeAlignment=function(t,n){var e,i,r,o,a,h,u,c,d,l;return r=t.location,a=t.rotation,o=n.location,h=n.rotation,i=(e=Math.atan2(o.y-r.y,o.x-r.x))+Math.PI,u=s.mod(e-a,2*Math.PI),c=s.mod(i-h,2*Math.PI),((u%(d=2*Math.PI/t.numberOfTeeth)/d+c%(l=2*Math.PI/n.numberOfTeeth)/l)%1-.25)*d},Board.prototype.alignGearTeeth=function(t,n){return t.rotation+=this.findRelativeAlignment(t,n)},Board.prototype.areMeshingGearsAligned=function(t,n){return Math.abs(this.findRelativeAlignment(t,n))<r},Board.prototype.rotateTurningObjectsFrom=function(t,n,e){var i,r,o,h,u,c;for(o in t.id in e||(t.rotation=s.mod(t.rotation+n,2*Math.PI),e[t.id]=!0),c=[],u=t.connections)a.call(u,o)&&(i=u[o],r=this.getTurningObjects()[o],o in e?c.push(void 0):(h=this.calculateRatio(t,r,i),c.push(this.rotateTurningObjectsFrom(r,n*h,e))));return c},Board.prototype.alignMeshingGears=function(t){var e,i,r,o,s,a,h,u;for((s={})[t.id]=!0,u=[],a=0,h=(r=this.findMeshingNeighbors(t)).length;a<h;a++)i=r[a],this.addConnection(t,i,n.MESHING),o=i.rotation,this.alignGearTeeth(i,t),e=i.rotation-o,s[i.id]=!0,u.push(this.rotateTurningObjectsFrom(i,e,s));return u},Board.prototype.connectToAxis=function(t,e){return this.addConnection(t,e,n.AXIS),t.location=e.location.clone(),t.rotation=e.rotation,this.alignMeshingGears(t)},Board.prototype.findNearestNeighbor=function(t,n){var e,i,r,o,s,h;for(o in null==n&&(n={}),i=null,s=Number.MAX_VALUE,h=this.gears)a.call(h,o)&&((r=h[o])===t||o in n||(e=t.edgeDistance(r))<s&&(i=r,s=e));return i},Board.prototype.connectToOneMeshingGear=function(t,e){var i,r;return r=t.location.minus(e.location),i=Math.atan2(r.y,r.x),t.location=e.location.plus(o.polar(i,t.pitchRadius+e.pitchRadius)),this.alignGearTeeth(t,e),this.addConnection(t,e,n.MESHING)},Board.prototype.connectToTwoMeshingGears=function(t,n,e){var i,s,a,h,u,c,d,l,p,g,f,G,v,C;return h=n.location,u=e.location,(v=n.pitchRadius+t.pitchRadius)+(C=e.pitchRadius+t.pitchRadius)<(s=h.distance(u))||h.distance(u)<r?t.edgeDistance(n)<t.edgeDistance(e)?void this.connectToOneMeshingGear(t,n):void this.connectToOneMeshingGear(t,e):(i=(v*v-C*C+s*s)/(2*s),a=Math.sqrt(v*v-i*i),p=(c=h.plus(u.minus(h).times(i/s))).x+a*(u.y-h.y)/s,f=c.y-a*(u.x-h.x)/s,g=c.x-a*(u.y-h.y)/s,G=c.y+a*(u.x-h.x)/s,d=new o(p,f),l=new o(g,G),t.location.distance(d)<t.location.distance(l)?t.location=d:t.location=l,this.alignMeshingGears(t))},Board.prototype.doChainsCrossNonSupportingGears=function(){var t,n;for(t in n=this.chains)if(a.call(n,t)&&n[t].crossesNonSupportingGears(this))return!0;return!1},Board.prototype.doChainsCrossEachOther=function(t,n){return(t.group!==n.group||t.level===n.level)&&t.distanceToChain(n)<e.WIDTH},Board.prototype.doesChainCrossAnyOtherChain=function(t){var n,e,i;for(e in i=this.chains)if(a.call(i,e)&&t!==(n=i[e])&&this.doChainsCrossEachOther(t,n))return!0;return!1},Board.prototype.doAnyChainsCrossEachOther=function(){var t,n,e,i,r,o,s,h,u,c,d,l;if((h=(i=function(){var t,n;for(o in n=[],t=this.chains)a.call(t,o)&&(e=t[o],n.push(e));return n}.call(this)).length)<2)return!1;for(r=u=0,d=h-1;0<=d?u<d:u>d;r=0<=d?++u:--u)for(s=c=l=r+1;l<=h?c<h:c>h;s=l<=h?++c:--c)if(t=i[r],n=i[s],this.doChainsCrossEachOther(t,n))return!0;return!1},Board.prototype.areAllMeshingGearsAligned=function(){var t,e,i,r,o,s,a,h,u,c;if((s=(i=this.getGearList()).length)<2)return!0;for(r=a=0,u=s-1;0<=u?a<u:a>u;r=0<=u?++a:--a)for(o=h=c=r+1;c<=s?h<s:h>s;o=c<=s?++h:--h)if(t=i[r],e=i[o],t.connections[e.id]===n.MESHING&&!this.areMeshingGearsAligned(t,e))return!1;return!0},Board.prototype.calculateRatio=function(t,e,i){return i===n.AXIS?1:i===n.MESHING||i===n.CHAIN_OUTSIDE?-t.getCircumference()/e.getCircumference():t.getCircumference()/e.getCircumference()},Board.prototype.calculatePathRatio=function(t){var n,e,i,r,o,s,a;for(i=1,e=s=0,a=t.length-1;0<=a?s<a:s>a;e=0<=a?++s:--s)r=t[e],o=t[e+1],n=r.connections[o.id],i*=this.calculateRatio(r,o,n);return i},Board.prototype.areConnectionRatiosConsistent=function(){var t,n,e,i,o,a,h;for(o={},a=0,h=(e=s.findAllSimplePathsBetweenNeighbors(this.getTurningObjects())).length;a<h;a++)if(n=(t=e[a])[0].id+"-"+t[t.length-1].id,i=this.calculatePathRatio(t),null==o[n])o[n]=i;else if(Math.abs(o[n]-i)>r)return!1;return!0},Board.prototype.isBoardValid=function(){var n,e,i,o,s,h,u,c,d,l,p,g,f;for(u in g=this.gears)if(a.call(g,u))for(c in s=(i=g[u]).group,d=i.level,f=this.gears)if(a.call(f,c)&&i!==(o=f[c]))if(h=o.group,l=o.level,n=i.location.distance(o.location),p=Math.max(i.outerRadius,o.outerRadius),e=i.outerRadius+o.outerRadius,n<r){if(s!==h||d===l)return!1}else if(s===h&&d===l&&null==i.connections[o.id]){if(n<e)return!1}else if(n<p+t)return!1;return!this.doChainsCrossNonSupportingGears()&&!this.doAnyChainsCrossEachOther()&&this.areAllMeshingGearsAligned()&&this.areConnectionRatiosConsistent()},Board.prototype.placeGear=function(t,n){var e,i,r,o,h,d,l;for(i in d=this.clone(),this.removeAllConnections(t),t.location=n.clone(),(r=this.findNearestAxis(t))&&t.location.distance(r.location)<c&&r.numberOfTeeth-t.numberOfTeeth>u?this.connectToAxis(t,r):(o=this.findNearestNeighbor(t))&&t.edgeDistance(o)<c&&((h=this.findNearestNeighbor(t,s.makeSet(o.id)))&&t.edgeDistance(h)<c?this.connectToTwoMeshingGears(t,o,h):this.connectToOneMeshingGear(t,o)),l=this.chains)if(a.call(l,i)){if(!(e=l[i]).update(this))return this.restore(d),!1;this.updateChainConnections(e)}return!!this.isBoardValid()||(this.restore(d),!1)},Board.prototype.addGearToChains=function(t){var n,e,i,r;for(e in r=[],i=this.chains)a.call(i,e)&&(n=i[e],s.isPointInsidePolygon(t.location,n.toPolygon())?r.push(n.innerGearIds[t.id]=!0):r.push(void 0));return r},Board.prototype.removeGearFromChains=function(t){var n,e,i,r;for(e in r=[],i=this.chains)a.call(i,e)&&(!(n=i[e]).removeGear(t,this)||this.doesChainCrossAnyOtherChain(n)?r.push(this.removeChain(n)):r.push(this.updateChainConnections(n)));return r},Board.prototype.addGear=function(t){var n;return n=this.clone(),t.group=this.getNextGroup(),this.gears[t.id]=t,this.addGearToChains(t),!!this.placeGear(t,t.location)||(this.removeGear(t),this.restore(n),!1)},Board.prototype.removeGear=function(t){return this.removeAllConnections(t),delete this.gears[t.id],this.removeGearFromChains(t)},Board.prototype.getGearAt=function(t,n){var e,i,r;for(r in null==n&&(n=this.gears),i=null,n)a.call(n,r)&&(e=n[r],t.distance(e.location)<e.outerRadius&&(!i||e.numberOfTeeth<i.numberOfTeeth)&&(i=e));return i},Board.prototype.isTopLevelGear=function(t){var e,i;for(e in i=t.connections)if(a.call(i,e)&&i[e]===n.AXIS&&this.gears[e].level>t.level)return!1;return!0},Board.prototype.getTopLevelGears=function(){var t,n,e,i;for(n in e={},i=this.gears)a.call(i,n)&&(t=i[n],this.isTopLevelGear(t)&&(e[n]=t));return e},Board.prototype.getTopLevelGearAt=function(t){return this.getGearAt(t,this.getTopLevelGears())},Board.prototype.getGearWithId=function(t){return this.gears[t]},Board.prototype.getGearsWithIds=function(t){var n,e,i,r;for(r=[],e=0,i=t.length;e<i;e++)n=t[e],r.push(this.gears[n]);return r},Board.prototype.rotateAllTurningObjects=function(t){var n,e,i,r,o;for(i in o=[],r=this.gears)a.call(r,i)&&((e=r[i]).momentum?(n=e.momentum*(t/1e3),o.push(this.rotateTurningObjectsFrom(e,n,{}))):o.push(void 0));return o},Board.prototype.addChainConnections=function(t){var e,i,r,o,s;for(s=[],i=0,r=(o=t.supportingGearIds).length;i<r;i++)(e=o[i])in t.innerGearIds?s.push(this.addConnection(t,this.getGearWithId(e),n.CHAIN_INSIDE)):s.push(this.addConnection(t,this.getGearWithId(e),n.CHAIN_OUTSIDE));return s},Board.prototype.updateChainConnections=function(t){return this.removeAllConnections(t),this.addChainConnections(t)},Board.prototype.addChain=function(t){var n;return n=this.clone(),this.chains[t.id]=t,t.tighten(this)?(this.chains[t.id]=t,this.addChainConnections(t),!!this.isBoardValid()||(this.restore(n),!1)):(this.restore(n),!1)},Board.prototype.removeChain=function(t){return this.removeAllConnections(t),delete this.chains[t.id]},Board.prototype.getChains=function(){return this.chains},Board.prototype.getChainsInGroupOnLevel=function(t,n){var e,i,r,o;for(i in o=[],r=this.chains)a.call(r,i)&&(e=r[i]).group===t&&e.level===n&&o.push(e);return o},Board.prototype.getTurningObjects=function(){var t,n,e,i,r,o;for(e in i={},r=this.gears)a.call(r,e)&&(n=r[e],i[e]=n);for(e in o=this.chains)a.call(o,e)&&(t=o[e],i[e]=t);return i},Board.prototype.clone=function(){return{gears:s.clone(this.gears),chains:s.clone(this.chains)}},Board.fromObject=function(t){var n,r,o,s,a,h;for(s in n=new Board,a=t.gears)o=a[s],n.gears[s]=i.fromObject(o);for(s in h=t.chains)r=h[s],n.chains[s]=e.fromObject(r);return n},Board}(),window.gearsketch.model.Board=n}).call(this);