/*! Sugarizer 2017-09-04 */
FoodChain.buildLevels=[{size:2,time:2},{size:3,time:5},{size:3,time:3},{size:3,time:2},{size:4,time:5},{size:4,time:3},{size:5,time:3}],enyo.kind({name:"FoodChain.BuildGame",kind:enyo.Control,published:{level:1},classes:"board",components:[{name:"cards",components:[{components:[{classes:"level-zone",components:[{name:"textlevel",classes:"title level-value"},{name:"level",content:"0",classes:"title level-value"}]},{classes:"score-zone",components:[{name:"textscore",classes:"title score-text"},{name:"score",content:"0000",classes:"title score-value"},{name:"timercount",content:"0:0,0",classes:"title timer-value"}]}]},{name:"gamebox",classes:"box",ontap:"unselect",ondrop:"drop",ondragover:"dragover",components:[]},{name:"validate",kind:"ShadowButton",img:"validate",classes:"validate",ontap:"controlOrder"},{name:"play",kind:"ShadowButton",img:"play",classes:"play",ontap:"play"},{name:"pause",kind:"ShadowButton",img:"pause",classes:"play",ontap:"pause"},{name:"restart",kind:"ShadowButton",img:"restart",classes:"restart",ontap:"restart"},{name:"forward",kind:"ShadowButton",img:"forward",classes:"restart",ontap:"next"},{name:"home",kind:"ShadowButton",img:"home",classes:"home",ontap:"home"},{kind:"enyo.Signals",onEndOfSound:"endSound"}]}],create:function(){this.inherited(arguments),this.previous=null,this.mixed=null,this.createComponent({name:"timer",kind:"Timer",paused:!0,onTriggered:"updateTimer"},{owner:this}),this.setLocale(),this.$.score.setContent(String("0000"+FoodChain.context.score).slice(-4)),FoodChain.context.game=this.kindName,this.levelChanged()},setLocale:function(){this.$.textlevel.setContent(__$FC("level")),this.$.textscore.setContent(__$FC("score")),enyo.forEach(this.$.gamebox.getControls(),function(a){a.setLocale()})},levelChanged:function(){FoodChain.context.level=this.level;var a=[];enyo.forEach(this.$.gamebox.getControls(),function(b){a.push(b)});for(var b=0;b<a.length;b++)a[b].destroy();if(null==this.mixed){var c;do if(this.chain=FoodChain.randomChain(FoodChain.buildLevels[this.level-1].size),null==this.previous||this.previous.length!=this.chain.length)c=!1;else{c=!0;for(var b=0;c&&b<this.chain.length;b++)this.previous[b]!=this.chain[b]&&(c=!1)}while(c);this.mixed=FoodChain.mix(this.chain)}var d=99/this.mixed.length,e=5-this.mixed.length,f=8;this.cards=[];for(var b=0;b<this.mixed.length;b++){this.cards.push(this.$.gamebox.createComponent({kind:"FoodChain.Card",cardname:this.mixed[b],x:e+"%",y:f,ontap:"taped",ondragstart:"dragstart",ondragfinish:"dragfinish"},{owner:this})),0==b?FoodChain.sound.play(this.cards[b].sound):this.cards[b].hide(),e+=d}this.dragobject=null,this.selectedobject=null,this.zmax=0,this.$.gamebox.removeClass("box-win"),this.$.gamebox.removeClass("box-lost"),FoodChain.saveContext(),this.$.play.hide(),this.$.pause.show(),this.$.validate.show(),this.$.restart.hide(),this.$.forward.hide(),this.$.home.hide(),this.$.level.setContent(" "+this.level),this.timecount={mins:0,secs:0,tenth:0},this.$.timercount.removeClass("timer-overtime"),this.displayTimer(),this.$.timer.pause(),this.render()},endSound:function(a,b){if(null!=this.cards){for(var c=0;c<this.cards.length;c++)if(null!=this.cards[c]&&FoodChain.soundMatch(this.cards[c].sound,b.sound)&&(this.cards[c]=null,c+1<this.cards.length))return this.cards[c+1].show(),void FoodChain.sound.play(this.cards[c+1].sound);this.cards=null,this.$.timer.resume()}},displayTimer:function(){this.$.timercount.setContent(this.timecount.mins+":"+String("00"+this.timecount.secs).slice(-2)+","+this.timecount.tenth)},updateTimer:function(a,b){if(this.timecount.tenth=this.timecount.tenth+1,10==this.timecount.tenth){this.timecount.tenth=0,this.timecount.secs=this.timecount.secs+1;var c=60*this.timecount.mins+this.timecount.secs;c>=FoodChain.buildLevels[this.level-1].time&&this.$.timercount.addClass("timer-overtime"),60==this.timecount.secs&&(this.timecount.secs=0,this.timecount.mins=this.timecount.mins+1)}this.displayTimer()},taped:function(a,b){if(this.$.timer.paused)return!0;if(FoodChain.log(a.cardname+" taped"),null==this.selectedobject)return this.selectedobject=a,a.addClass("card-dragged"),FoodChain.sound.play(a.sound),this.toTop(a),!0;if(a!=this.selectedobject){var c=this.selectedobject.getX(),d=this.selectedobject.getY(),e=a.getX(),f=a.getY();return this.selectedobject.moveTo(e,f),a.moveTo(c,d),this.selectedobject.removeClass("card-dragged"),this.selectedobject=null,!0}},unselect:function(){null!=this.selectedobject&&(this.selectedobject.removeClass("card-dragged"),this.selectedobject=null)},dragstart:function(a,b){return!!this.$.timer.paused||(a.addClass("card-dragged"),this.$.gamebox.addClass("box-dragging"),FoodChain.sound.play(a.sound),this.dragobject=a,this.selectedobject=null,this.dragx=0,this.dragy=b.clientY-a.y,void this.toTop(this.dragobject))},dragfinish:function(a,b){a.removeClass("card-dragged"),this.$.gamebox.removeClass("box-dragging")},dragover:function(a,b){return null==this.dragobject||(b.preventDefault(),!1)},drop:function(a,b){return!(null!=this.dragobject&&!this.$.timer.paused)||(b.preventDefault(),this.dragobject.moveTo(b.clientX/window.innerWidth*100+"%",b.clientY-this.dragy),void(this.dragobject=null))},toTop:function(a){this.zmax=this.zmax+1,a.applyStyle("z-index",this.zmax)},controlOrder:function(){this.$.timer.pause(),this.$.play.hide(),this.$.pause.hide(),this.$.validate.hide();var a=[];enyo.forEach(this.$.gamebox.getControls(),function(b){a.push(b)}),a=a.sort(function(a,b){return a.x.replace("%","")-b.x.replace("%","")});for(var b=!0,c=0;b&&c<this.chain.length;c++)a[c].cardname!=this.chain[c]&&(b=!1);b?(FoodChain.sound.play("audio/applause"),this.$.gamebox.addClass("box-win"),this.computeScore(),this.$.home.show(),this.level!=FoodChain.buildLevels.length&&this.$.forward.show()):(FoodChain.sound.play("audio/disappointed"),this.$.gamebox.addClass("box-lost"),this.$.home.show(),this.$.restart.show())},computeScore:function(){var a=10,b=60*this.timecount.mins+this.timecount.secs;b<FoodChain.buildLevels[this.level-1].time&&(a+=FoodChain.buildLevels[this.level-1].time-b),FoodChain.context.score+=a,this.$.score.setContent(String("0000"+FoodChain.context.score).slice(-4))},play:function(){enyo.forEach(this.$.gamebox.getControls(),function(a){a.show()}),this.$.timer.resume(),this.$.play.hide(),this.$.pause.show(),this.$.home.hide()},pause:function(){enyo.forEach(this.$.gamebox.getControls(),function(a){a.hide()}),this.$.timer.pause(),this.$.pause.hide(),this.$.play.show(),this.$.home.show()},restart:function(){this.levelChanged()},next:function(){this.level=this.level+1,this.previous=this.chain,this.mixed=null,this.levelChanged()},home:function(){this.$.timer.stop(),FoodChain.goHome()}});