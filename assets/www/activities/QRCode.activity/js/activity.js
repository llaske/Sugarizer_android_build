/*! Sugarizer 2020-03-14 */
define(["sugar-web/activity/activity","sugar-web/datastore","sugar-web/env","webL10n","tutorial"],function(a,b,c,d,e){requirejs(["domReady!","humane"],function(f,g){function h(a){l.includes(a)||(l.push(a),i())}function i(){for(var a="",b=l.length;b--;)a+='<option value="'+l[b]+'">'+l[b]+"</option>";document.getElementById("qrtextdropdown").innerHTML=a}a.setup();var j=(/Android/i.test(navigator.userAgent)||/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent))&&"http"!=document.location.protocol.substr(0,4),k=0,l=[];c.getEnvironment(function(a,b){var c="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,e=b.user?b.user.language:c;d.language.code=e});var m=55,n=m+40,o=20,p=document.getElementById("canvas").parentNode.offsetHeight-n;p-=o*p/100;var q=new QRCode("qr-code",{width:p,height:p,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),r=(document.getElementById("canvas").parentNode.offsetWidth-p)/2;document.getElementById("qr-code").style.marginLeft=r+"px",document.getElementById("qr-code").style.marginTop="20px";var s=function(a){q.clear(),q.makeCode(a),h(a);var a=u.value.toLowerCase();a.length>0?document.getElementById("erasetext-button").style.visibility="visible":document.getElementById("erasetext-button").style.visibility="hidden",0==a.indexOf("http://")||0==a.indexOf("https://")?document.getElementById("user-text").classList.add("text-url"):document.getElementById("user-text").classList.remove("text-url")},t=function(){var a=document.body.clientHeight-n+("visible"==document.getElementById("unfullscreen-button").style.visibility?m:0),b=a/(p*(100+o)/100);document.getElementById("qr-code").style.zoom=b;var c=navigator.userAgent.toLowerCase();-1==c.indexOf("chrome")&&(document.getElementById("qr-code").style.MozTransform="scale("+b+")",document.getElementById("qr-code").style.MozTransformOrigin="0 0"),x&&(document.getElementById("outdiv").style.zoom=b,-1==c.indexOf("chrome")&&(document.getElementById("outdiv").style.MozTransform="scale("+b+")",document.getElementById("outdiv").style.MozTransformOrigin="0 0"))};window.addEventListener("resize",t);var u=document.getElementById("user-text");u.addEventListener("keyup",function(){var a=u.value.toLowerCase();a.length>0?document.getElementById("erasetext-button").style.visibility="visible":document.getElementById("erasetext-button").style.visibility="hidden",0==a.indexOf("http://")||0==a.indexOf("https://")?document.getElementById("user-text").classList.add("text-url"):document.getElementById("user-text").classList.remove("text-url")}),u.addEventListener("click",function(){var a=u.value.toLowerCase();0!=a.indexOf("http://")&&0!=a.indexOf("https://")||(j?cordova.InAppBrowser.open(u.value,"_system"):window.open(u.value))}),document.getElementById("erasetext-button").addEventListener("click",function(){u.value="",u.focus(),document.getElementById("erasetext-button").style.visibility="hidden",document.getElementById("user-text").classList.remove("text-url")}),document.getElementById("generate-button").addEventListener("click",function(){s(u.value)});var v=function(a){document.getElementById("outdiv").style.visibility="hidden",document.getElementById("video-stream").style.visibility="hidden",document.getElementById("qr-code").style.visibility="visible",document.getElementById("loading-spinner").style.visibility="hidden",document.getElementById("photo-button").classList.remove("active"),u.value=a,s(a)};document.getElementById("png-button").addEventListener("click",function(){var a="image/png",c=document.getElementById("qr-code").childNodes[1].src,e={mimetype:a,title:"Image QR Code",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};b.create(e,function(){g.log(d.get("QRCodeSaved")),console.log("export done.")},c)}),document.getElementById("help-button").addEventListener("click",function(a){e.start()}),document.getElementById("fullscreen-button").addEventListener("click",function(){document.getElementById("photo-button").classList.contains("active")||(document.getElementById("main-toolbar").style.opacity=0,document.getElementById("input-box").style.opacity=0,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",t())}),document.getElementById("unfullscreen-button").addEventListener("click",function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("input-box").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",t()});var w=document.getElementById("photo-button"),x=!1,y="";w.addEventListener("click",function(){if(j)return document.getElementById("main-toolbar").style.opacity=0,document.getElementById("canvas").style.opacity=0,document.getElementById("close-button").style.visibility="visible",document.getElementById("switchcamera-button").style.visibility="visible",void QRScanner.prepare(function(a,b){a?console.log("Error "+a):(console.log(b),QRScanner.scan(function(a,b){a?console.log("Error "+a):(u.value=b,s(b)),QRScanner.cancelScan(function(a){}),document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.opacity=1,document.getElementById("close-button").style.visibility="hidden",document.getElementById("switchcamera-button").style.visibility="hidden"}),QRScanner.show(function(a){}))});var a=document.getElementById("outdiv"),b=document.getElementById("video-stream");w.classList.contains("active")?(a.style.visibility="hidden",b.style.visibility="hidden",document.getElementById("loading-spinner").style.visibility="hidden",document.getElementById("qr-code").style.visibility="visible",u.value=y,s(u.value)):(document.getElementById("qr-code").style.visibility="hidden",document.getElementById("loading-spinner").style.visibility="visible",y=u.value,u.value="",x?(a.style.visibility="visible",b.style.visibility="visible"):(a.innerHTML='<video id="video-window" autoplay></video>',load(p,r,v),x=!0)),w.classList.toggle("active")}),document.getElementById("close-button").addEventListener("click",function(a){j&&QRScanner.cancelScan(function(a){})}),document.getElementById("switchcamera-button").addEventListener("click",function(a){j&&(k=(k+1)%2,QRScanner.useCamera(k,function(a,b){}))}),document.getElementById("qrtextdropdown").addEventListener("change",function(){document.getElementById("user-text").value=document.getElementById("qrtextdropdown").value,s(document.getElementById("qrtextdropdown").value)}),document.getElementById("stop-button").addEventListener("click",function(b){console.log("writing...");var c={userText:w.classList.contains("active")?y:u.value,uHistory:l},d=JSON.stringify(c);a.getDatastoreObject().setDataAsText(d),a.getDatastoreObject().save(function(a){null===a?console.log("write done."):console.log("write failed.")})}),c.getEnvironment(function(b,c){c.objectId?a.getDatastoreObject().loadAsText(function(a,b,c){null==a&&null!=c&&(c=JSON.parse(c),u.value=c.userText,l=c.uHistory,s(c.userText))}):(console.log("New instance"),u.value=c.user.name,s(c.user.name))})})});