var ImageURL={template:'\n\t\t<img :src="imageURL" v-bind="$attrs">\n\t',props:["path","colors"],data:()=>({imageURL:""}),created(){let t=this;this.colors?this.$root.$refs.SugarIcon.generateIconWithColors("../"+this.path,this.colors).then(e=>{var i=new Image;i.src=e,i.onload=function(){var e=document.createElement("canvas");e.width=i.width,e.height=i.height,e.getContext("2d").drawImage(i,0,0),t.imageURL=e.toDataURL("image/png"),t.$emit("loaded")}}):this.canvasToImage(this.path).then(e=>{t.imageURL=e.dataURL,t.$emit("loaded")})},methods:{canvasToImage:t=>-1!=t.indexOf("data:image/png")?Promise.resolve(t):new Promise((e,i)=>{var a=new Image;a.src=t,a.onload=()=>{var t=document.createElement("canvas");t.width=a.width,t.height=a.height,t.getContext("2d").drawImage(a,0,0),e({dataURL:t.toDataURL("image/png"),width:a.width,height:a.height})}})}},Export={template:'\n\t\t<div class="doc-container">\n\t\t\t<div id="doc">\n\t\t\t\t<br><br><br><br><br><br><br><br><br><br><br><br><br>\n\t\t\t\t<h1 style="text-align: center">{{ templateTitle }}</h1>\n\t\t\t\t<div style="display: inline-block; width: fit-content; text-align: center; margin: auto">\n\t\t\t\t\t<ImageURL\n\t\t\t\t\t\tpath="icons/owner-icon.svg"\n\t\t\t\t\t\t:colors="currentenv.user.colorvalue"\n\t\t\t\t\t\t:style="{ width: \'150px\' }"\n\t\t\t\t\t\t@loaded="loadedImages++"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<h1 style="text-align: center">{{ currentenv.user.name }}</h1>\n\t\t\t\t<br><br><br><br><br><br><br><br><br><br><br><br><br>\n\t\t\t\t<br><br><br><br><br><br><br><br><br><br><br><br><br>\n\n\t\t\t\t<div class="stats-container">\n\t\t\t\t\t<h1>{{ l10n.stringStatistics }}</h1>\n\t\t\t\t\t<table class="stats-table">\n\t\t\t\t\t\t<tr v-for="(level, key) in levels[notationLevel]" :key="key">\n\t\t\t\t\t\t\t<td style="text-align: right; padding: 5px;\twhite-space:nowrap;">{{ levels[notationLevel][levels[notationLevel].length-1-key].text }}:</td>\n\t\t\t\t\t\t\t<td class="bar-container">\n\t\t\t\t\t\t\t\t<p style="margin: 0" :style="{ color: levels[notationLevel].length-1-key == 0 ? \'#838383\' : levels[notationLevel][levels[notationLevel].length-1-key].colors.fill }">\n\t\t\t\t\t\t\t\t\t{{ Math.round(levelWiseAcquired[levels[notationLevel].length-1-key]/totalSkills*100 *100)/100 + \'%\' }}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</table>\n\t\t\t\t\t<br><br><br><br>\n\t\t\t\t\t<h1>{{ l10n.stringRewards }}</h1>\n\t\t\t\t\t<table class="stats-table">\n\t\t\t\t\t\t<tr v-for="(achievement, i) in achievements" :key="i" v-if="user.achievements[achievement.id].timestamp">\n\t\t\t\t\t\t\t<td style="text-align: right; padding: 5px;\twhite-space:nowrap;">{{ achievement.title }}:</td>\n\t\t\t\t\t\t\t<td class="bar-container">\n\t\t\t\t\t\t\t\t<p style="margin: 0" :style="{ color: \'#838383\' }">\n\t\t\t\t\t\t\t\t\t{{ new Date(user.achievements[achievement.id].timestamp).toLocaleDateString() }}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</table>\n\t\t\t\t</div>\n\t\t\t\t<br><br><br><br><br><br><br><br>\n\n\t\t\t\t<div class="doc-categories">\n\t\t\t\t\t<div class="doc-category" v-for="category in categories" :key="category.id">\n\t\t\t\t\t\t<br><br><br><br>\n\t\t\t\t\t\t<h1 :style="{ color: category.color, borderBottom: \'solid 10px \' + category.color }">{{ category.title }}</h1>\n\t\t\t\t\t\t<div class="doc-skills">\n\t\t\t\t\t\t\t<div class="doc-skill" v-for="skill in category.skills" :key="skill.id">\n\t\t\t\t\t\t\t\t<ImageURL\n\t\t\t\t\t\t\t\t\t:path="skill.image"\n\t\t\t\t\t\t\t\t\tstyle="margin: 10px 0;"\n\t\t\t\t\t\t\t\t\t:style="{ width: \'300px\' }"\n\t\t\t\t\t\t\t\t\t@loaded="loadedImages++"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<h3 style="font-size: 1.5em; margin: 5px 0">{{ skill.title }}</h3>\n\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t<span :style="{ color: user.skills[category.id][skill.id].acquired == 0 ? \'#838383\' : levels[notationLevel][user.skills[category.id][skill.id].acquired].colors.fill, fontWeight: 600 }">\n\t\t\t\t\t\t\t\t\t\t{{ levels[notationLevel][user.skills[category.id][skill.id].acquired].text }}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t<span style="color: #838383">\n\t\t\t\t\t\t\t\t\t\t{{ user.skills[category.id][skill.id].timestamp ? \' - \' + new Date(user.skills[category.id][skill.id].timestamp).toLocaleDateString() : \'\' }}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<hr style="border-color: #d3d3d3" />\n\t\t\t\t\t\t\t\t<div class="doc-uploads" style="border: solid 1px #d3d3d3">\n\t\t\t\t\t\t\t\t\t<div class="doc-upload" style="display: inline-block; width: fit-content; text-align: center; margin: 10px" v-for="(upload, i) in getUploads(category.id, skill.id)" :key="i">\n\t\t\t\t\t\t\t\t\t\t<ImageURL\n\t\t\t\t\t\t\t\t\t\t\t:path="getUploadedPath(upload)"\n\t\t\t\t\t\t\t\t\t\t\t:style="{ width: \'150px\' }"\n\t\t\t\t\t\t\t\t\t\t\t@loaded="loadedImages++"\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t<p>{{ new Date(upload.timestamp).toLocaleDateString() }}</p>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<br><br><br><br>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t',components:{ImageURL:ImageURL},props:["categories","user","levels","notationLevel","templateTitle","currentenv","achievements","exporting"],data:()=>({totalImages:0,loadedImages:0,l10n:{stringTitle:"",stringDateOfAcquisition:"",stringMediaUploaded:"",stringBy:"",stringStatistics:"",stringRewards:""}}),computed:{totalSkills:function(){var t=0;return this.categories.forEach((function(e){t+=e.skills.length})),t},levelWiseAcquired:function(){var t={};for(var e in this.levels[this.notationLevel])t[e]=0;for(var i in this.user.skills)for(var a in this.user.skills[i])t[this.user.skills[i][a].acquired]++;return t},imagesLoaded(){return this.totalImages==this.loadedImages}},watch:{imagesLoaded:function(t,e){if(t)switch(this.exporting){case"doc":this.generateDOC();break;case"odt":this.generateODT()}}},created(){for(var t of(this.totalImages++,this.categories))for(var e of(this.totalImages+=t.skills.length,t.skills))for(var i in this.user.skills[t.id][e.id].media)this.totalImages+=this.user.skills[t.id][e.id].media[i].length},mounted:function(){switch(this.$root.$refs.SugarL10n.localize(this.l10n),this.exporting){case"pdf":this.generatePDF();break;case"csv":this.generateCSV()}},methods:{getUploads:function(t,e){var i=[],a=this.user.skills[t][e].media;for(var o in a)a[o].forEach((function(t){t.type=o,i.push(t)}));return i.sort((function(t,e){return e.timestamp-t.timestamp})),i},getUploadedPath:t=>"audio"==t.type?"images/audio-preview.jpg":"video"==t.type?"images/video-preview.jpg":t.data,canvasToImage:t=>new Promise((e,i)=>{var a=new Image;a.src=t,a.onload=()=>{-1!=t.indexOf("data:image/png")&&e({dataURL:t,width:a.width,height:a.height,canvas:null});var i=document.createElement("canvas");i.width=a.width,i.height=a.height,i.getContext("2d").drawImage(a,0,0),e({dataURL:i.toDataURL("image/png"),width:a.width,height:a.height,canvas:i})}}),generateCSV:function(){console.log("Exporting CSV...");var t="";t+=`"${this.l10n.stringTitle}"`;var e=this.levels[this.notationLevel];for(var i of e)t+=`,"${i.text}"`;for(var a of(t+=`,"${this.l10n.stringDateOfAcquisition}"`,t+=`,"${this.l10n.stringMediaUploaded}"`,t+="\n",this.categories)){for(var o in t+=`"${a.title}"`,e)t+=',""';for(var r of(t+="\n",a.skills)){t+=`"${r.title}"`;var n=this.user.skills[a.id][r.id];for(var o in e)o==n.acquired?t+=',"1"':t+=',"-"';n.timestamp?t+=`,"${new Date(n.timestamp).toLocaleDateString()}"`:t+=',"-"';var s=0;for(var l in n.media)s+=n.media[l].length;t+=`,"${s}"`,t+="\n"}}var d={mimetype:"text/plain",title:this.$root.$refs.SugarL10n.get("ExportFileName",{templateTitle:this.templateTitle,userName:this.currentenv.user.name})+".txt",activity:"org.olpcfrance.Curriculum",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0},c=this;this.$root.$refs.SugarJournal.createEntry(t,d).then(()=>{c.$root.$refs.SugarPopup.log(this.$root.$refs.SugarL10n.get("ExportTo",{format:"CSV"})),console.log("Export to CSV complete"),c.$emit("export-completed")})},generateODT(){console.log("Exporting ODT..."),this.constructODT().then(t=>{var e="data:application/vnd.oasis.opendocument.text;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(t))),i={mimetype:"application/vnd.oasis.opendocument.text",title:this.$root.$refs.SugarL10n.get("ExportFileName",{templateTitle:this.templateTitle,userName:this.currentenv.user.name})+".odt",activity:"org.olpcfrance.Curriculum",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0},a=this;this.$root.$refs.SugarJournal.createEntry(e,i).then(()=>{a.$root.$refs.SugarPopup.log(this.$root.$refs.SugarL10n.get("ExportTo",{format:"ODT"})),console.log("Export to ODT complete"),a.$emit("export-completed")})})},loadODT:()=>new Promise((t,e)=>{requirejs(["js/odtHelper.js"],(function(e){t(e)}))}),constructODT(){let t=this;return new Promise((e,i)=>{t.loadODT().then(async i=>{let a=i.xml;t.addCoverToODT(i).then(o=>{a+=o,t.addStatsToODT(i).then(o=>{a+=o,t.addCategoriesToODT(i).then(t=>{a+=t,e(i.header+i.styles+i.getAutomaticStyles()+i.automaticStylesEnd+a+i.footer)})})})})})},addCoverToODT(t){let e=this,i="";return new Promise((a,o)=>{e.$root.$refs.SugarIcon.generateIconWithColors("../icons/owner-icon.svg",e.currentenv.user.colorvalue).then(o=>{e.canvasToImage(o).then(o=>{i+=t.addCover(e.templateTitle,o.dataURL,e.currentenv.user.name),a(i)})})})},addStatsToODT(t){let e=this,i="";return new Promise((a,o)=>{t.addLevelStyles(e.levels[e.notationLevel]);let r=[];for(let t in e.levels[e.notationLevel])r.push({text:e.levels[e.notationLevel][t].text,percent:Math.round(e.levelWiseAcquired[t]/e.totalSkills*100*100)/100});i+=t.addStatsTable(r),e.$root.$refs.SugarIcon.generateIconWithColors("../icons/trophy-large.svg",e.currentenv.user.colorvalue).then(o=>{e.canvasToImage(o).then((async function(o){let r=[];for(var n of e.achievements)if(null!=e.user.achievements[n.id].timestamp){var s=document.createElement("canvas");s.width=o.width,s.height=o.height;var l=s.getContext("2d");l.drawImage(o.canvas,0,0);var d=await e.canvasToImage("icons/"+n.info.icon);l.drawImage(d.canvas,o.width/2-10,o.height/3.5,20,20),l.font="bold 14px Arial",l.fillStyle="white",l.textAlign="center",l.fillText(n.info.text,o.width/2,o.height/4);let t={imageURL:s.toDataURL("image/png"),title:n.title,time:new Date(e.user.achievements[n.id].timestamp).toLocaleDateString()};r.push(t)}i+=t.addRewards(r),a(i)}))})})},addCategoriesToODT(t){let e=this,i="";return new Promise(async(a,o)=>{for(let a of e.categories){let o={id:a.id,title:a.title,color:a.color};i+=t.addCategoryTitle(o);for(let o of a.skills){let l="",d=await e.canvasToImage(o.image),c=6.392,g=c*(d.height/d.width),h=t.addImage(d.dataURL,c,g),m={text:e.levels[e.notationLevel][e.user.skills[a.id][o.id].acquired].text,level:e.user.skills[a.id][o.id].acquired};l=t.addSkillLevel(m)+h,l=t.addSkillTitle(o.title,l),e.user.skills[a.id][o.id].timestamp&&(l+=t.addSkillTimestamp(new Date(e.user.skills[a.id][o.id].timestamp).toLocaleDateString()));var r="",n=e.getUploads(a.id,o.id);for(var s of n){let i=await e.canvasToImage(e.getUploadedPath(s)),a=4.269,o=a*(i.height/i.width),n={imageURL:i.dataURL,time:new Date(s.timestamp).toLocaleDateString(),width:a,height:o};r+=t.addMediaFrame(n)}l+=r=t.addToMediaContainerFrame(r);let v=t.addToSkillFrame(l);i+=v}}a(i)})},generateDOC(){console.log("Exporting DOC...");var t=this;this.$nextTick(()=>{var e=document.getElementById("doc").innerHTML,i="data:application/vnd.ms-word;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent("<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'></head><body>"+e+"</body></html>"))),a={mimetype:"application/msword",title:this.$root.$refs.SugarL10n.get("ExportFileName",{templateTitle:this.templateTitle,userName:this.currentenv.user.name})+".doc",activity:"org.olpcfrance.Curriculum",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};t.$root.$refs.SugarJournal.createEntry(i,a).then(()=>{t.$root.$refs.SugarPopup.log(this.$root.$refs.SugarL10n.get("ExportTo",{format:"DOC"})),console.log("Export to DOC complete"),t.$emit("export-completed")})})},generatePDF(){console.log("Exporting PDF...");var t=new jsPDF;let e=this;this.addCoverToPDF(t).then(()=>{this.addStatsToPDF(t).then(()=>{this.addCategoriesToPDF(t).then(()=>{var i={mimetype:"application/pdf",title:this.$root.$refs.SugarL10n.get("ExportFileName",{templateTitle:this.templateTitle,userName:this.currentenv.user.name})+".pdf",activity:"org.olpcfrance.Curriculum",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};e.$root.$refs.SugarJournal.createEntry(t.output("dataurlstring"),i).then(()=>{e.$root.$refs.SugarPopup.log(this.$root.$refs.SugarL10n.get("ExportTo",{format:"PDF"})),console.log("Export to PDF complete"),e.$emit("export-completed")})})})})},addCoverToPDF(t){let e=this;return new Promise((i,a)=>{t.setFontStyle("bold"),t.setFontSize(20),t.text(105,100,this.parseString(e.templateTitle),{align:"center"}),e.$root.$refs.SugarIcon.generateIconWithColors("../icons/owner-icon.svg",e.currentenv.user.colorvalue).then(a=>{e.canvasToImage(a).then(e=>{t.addImage(e.dataURL,90,110,30,30),i()})}),t.text(105,150,this.parseString(e.currentenv.user.name),{align:"center"}),t.setFontSize(16),t.setFontStyle("normal")})},addStatsToPDF(t){return new Promise((e,i)=>{t.addPage();var a=10,o=15;t.setFontStyle("bold"),t.text(a,o,this.l10n.stringStatistics),t.setFontStyle("normal"),o+=15,t.setFontSize(12);for(var r=this.levels[this.notationLevel].length-1;r>=0;r--){var n=Math.round(this.levelWiseAcquired[r]/this.totalSkills*100*100)/100;t.setTextColor("#000000"),t.text(a+35,o,this.levels[this.notationLevel][r].text,{align:"right"}),t.setDrawColor(this.levels[this.notationLevel][r].colors.stroke),t.rect(a+40,o-4,120,6),t.setFillColor("#FFFFFF"==this.levels[this.notationLevel][r].colors.fill?"#838383":this.levels[this.notationLevel][r].colors.fill),t.setTextColor("#FFFFFF"==this.levels[this.notationLevel][r].colors.fill?"#838383":this.levels[this.notationLevel][r].colors.fill),t.rect(a+40,o-4,120*n/100,6,"FD"),t.text(a+120+45,o,n+"%"),o+=10}o+=10,t.setTextColor("#000000"),t.setFontSize(16),t.setFontStyle("bold"),t.text(a,o,this.l10n.stringRewards),t.setFontStyle("normal"),o+=10,t.setFontSize(12);var s=this;this.$root.$refs.SugarIcon.generateIconWithColors("../icons/trophy-large.svg",this.currentenv.user.colorvalue).then(i=>{s.canvasToImage(i).then((async function(i){var r=i.dataURL;for(var n of s.achievements)if(null!=s.user.achievements[n.id].timestamp){t.addImage(r,a,o,30,30),t.setFontSize(10),t.setTextColor("#ffffff"),t.setFontStyle("bold"),t.text(a+15,o+8,n.info.text,{align:"center"}),t.setFontStyle("normal"),t.setTextColor("#000000"),t.setFontSize(12);var l=await s.canvasToImage("icons/"+n.info.icon);t.addImage(l.dataURL,a+13,o+9,4,4);var d=t.splitTextToSize(n.title,30);t.text(a+15,o+40,d,{align:"center"});var c=t.getTextDimensions(d);t.setFontSize(10),t.setTextColor("#838383"),t.text(a+15,o+42+c.h,new Date(s.user.achievements[n.id].timestamp).toLocaleDateString(),{align:"center"}),t.setFontSize(12),t.setTextColor("#000000"),a+=35}e()}))})})},addCategoriesToPDF(t){let e=this;return new Promise(async(i,a)=>{var o,r=10,n=10;for(var s of e.categories){t.addPage(),n=r=10,t.setFontSize(16),t.setFontStyle("bold"),o=t.splitTextToSize(this.parseString(s.title),180),t.text(n,r,o),t.setFontStyle("normal");var l=t.getTextDimensions(o);for(var d of(t.setFillColor(s.color),t.rect(0,r+l.h,220,3,"F"),r+=l.h+15,t.setFontSize(12),s.skills)){let i=await e.canvasToImage(d.image);var c;r+(c=i.height/i.width*50)>280&&(t.addPage(),r=10),t.addImage(i.dataURL,n,r,50,c),o=t.splitTextToSize(this.parseString(d.title),100),t.text(n+50+10,r,o),l=t.getTextDimensions(o),t.setTextColor(0==e.user.skills[s.id][d.id].acquired?"#838383":e.levels[e.notationLevel][e.user.skills[s.id][d.id].acquired].colors.fill),t.setFontStyle("bold"),t.setFontSize(10),t.text(200,r,e.levels[e.notationLevel][e.user.skills[s.id][d.id].acquired].text,{align:"right"}),t.setTextColor("#000000"),t.setFontStyle("normal"),t.setFontSize(12),e.user.skills[s.id][d.id].timestamp&&(t.setFontSize(10),t.setTextColor("#838383"),t.text(200,r+l.h+5,new Date(e.user.skills[s.id][d.id].timestamp).toLocaleDateString(),{align:"right"}),t.setFontSize(12),t.setTextColor("#000000")),t.line(n+50+10,r+l.h,200,r+l.h);var g=e.getUploads(s.id,d.id),h=0;for(var m of(n=70,g)){var v=20,p=20;let i=await e.canvasToImage(e.getUploadedPath(m));"image"==m.type&&(p=(v=30)*(i.height/i.width)),n+v>200?(n=70,r+=h+10,h=0,r+10>280&&(t.addPage(),r=10)):r+p+10>280&&(t.addPage(),n=70,r=10),h=Math.max(h,p),t.addImage(i.dataURL,n,r+10,v,p),t.setFontSize(10),t.setTextColor("#838383"),t.text(n+v/2,r+p+15,new Date(m.timestamp).toLocaleDateString(),{align:"center"}),t.setFontSize(12),t.setTextColor("#000000"),n+=v+10}n=10,r+=Math.max(Math.max(c,l.h),h)+25}t.setFontSize(16)}i()})},parseString:t=>(t=t.replace("&nbsp;"," "),document.createElement("p").innerHTML=t,t),download:function(t,e,i){var a=new Blob([t],{type:i});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(a,e);else{var o=document.createElement("a"),r=URL.createObjectURL(a);o.href=r,o.download=e,document.body.appendChild(o),o.click(),setTimeout((function(){document.body.removeChild(o),window.URL.revokeObjectURL(r)}),0)}}}};