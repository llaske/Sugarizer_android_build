!function(t){function Translator(e){for(var a in this.q=t.query(),this.id=e&&"string"==typeof e.id?e.id:"form",this.master=e&&"string"==typeof e.master?e.master:"",this.json=e&&"string"==typeof e.json?e.json:"",this.langs=e&&"object"==typeof e.langs?e.langs:{en:"English"},this.setLanguage(),this.lang=this.q.lang,this.lang||(this.lang="en"),this.page=t("#"+this.id),html='<form id="langchoice"><label>Select language (not all are complete):</label><select name="lang">',this.langs)html+='<option name="'+a+'" value="'+a+'"'+(this.lang==a?" selected":"")+">"+this.langs[a]+"</option>";return html+="</select></form>",0==t("#translate_chooser").length&&this.page.prepend('<div id="translate_chooser"></div>'),0==t("#translation").length&&this.page.append('<div id="translation"></div>'),t("#translate_chooser").html(html).find("#langchoice select").bind("change",{me:this},(function(e){e.data.me.setLanguage(t(this).find("option:selected").val())})),this.setLanguage(this.lang),this}function sanitize(t){return t&&(t=(t=(t=t.replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/"/g,"&quot;")),t}jQuery.query=function(){var t={length:0},e=location.search;return e&&"#"!=e&&(e=e.replace(/^\?/,"").replace(/\&$/,""),jQuery.each(e.split("&"),(function(){var e=this.split("=")[0],a=this.split("=")[1];/^[0-9.]+$/.test(a)&&(a=parseFloat(a)),t[e]=a,t.length++}))),t},Translator.prototype.setLanguage=function(e){return e&&(this.lang=e),this.loadLanguage(this.lang,(function(e){if(e.lang?(this.lang=e.lang,this.phrasebook=e.data?e.data:{language:{name:"",code:e.lang}}):this.masterbook=e.data,this.rebuildForm(),e.lang){var a=t("a.langlink").attr("href");t("a.langlink").attr("href",a.substring(0,a.indexOf("?"))+"?lang="+this.lang),t(".langname").html(this.phrasebook.language.name)}})),this},Translator.prototype.loadLanguage=function(e,a,n){var i=e?this.json.replace("%LANG%",e):this.master;"string"==typeof n&&(e=n),e&&(this.lang=e),t.ajax({url:i,method:"GET",dataType:"json",context:this,error:function(){console.log("Couldn't load "+e),"en"!=e&&this.loadLanguage("en",a,e)},success:function(t){t&&t.language&&"string"==typeof t.language.code&&(t.language.code=e),t&&t.language&&"string"==typeof t.language.code&&(t.language.name=this.langs[e]),"function"==typeof a&&a.call(this,{data:t,lang:e})}})},Translator.prototype.rebuildForm=function(){var e='<form id="language">';return e+=this.buildForm(this.masterbook,this.phrasebook,""),e+="</form>",t("#translation").html(e),t("#translation input, #translation textarea, #translation select").attr("dir",this.phrasebook&&this.phrasebook.language&&"right"==this.phrasebook.language.alignment?"rtl":"ltr").unbind().bind("change",{me:this},(function(t){t.data.me.getOutput(),t.data.me.percentComplete()})),t('#translation select[name=".language.alignment"]').on("change",(function(e){t("#translation input, #translation textarea, #translation select").attr("dir","right"==t(this).val()?"rtl":"ltr")})),this.getOutput(),this.percentComplete(),this},Translator.prototype.buildForm=function(t,e,a){var n,i="",s="",r="";for(key in a||(a=""),t)if(n=parseInt(key),s=a+"."+key,"object"==typeof t[key])if(n>=0&&this.previousgroup!=n&&(i+="</div>"),t[key]._text&&t[key]._type){if(r="","textarea"==t[key]._type)r='<textarea name="'+s+'"'+(t[key]._height?' style="height:'+t[key]._height+'"':"")+">"+sanitize(e?e[key]:"")+"</textarea>";else if("noedit"==t[key]._type)r='<input type="hidden" name="'+s+'" value="'+sanitize(e?e[key]:"")+'" />'+sanitize(e?e[key]:"");else if("select"==t[key]._type){r='<select name="'+s+'">';for(var o=0;o<t[key]._options.length;o++){var l=e&&t[key]._options[o].value==e[key]?' selected="selected"':"";r+='<option value="'+t[key]._options[o].value+'"'+l+">"+t[key]._options[o].name+"</option>"}r+="</select>"}else"string"==t[key]._type&&(r='<input type="text" name="'+s+'" value="'+sanitize(e&&e[key]?e[key]:"")+'" />');i+=this.row(t[key]._title?t[key]._title:key,t[key]._text,r)}else t[key]._title&&(i+="<h2>"+t[key]._title+"</h2>"),n>=0&&(i+='<div class="group">'),i+=this.buildForm(t[key],e?e[key]:{},s),this.previousgroup=n;return i},Translator.prototype.percentComplete=function(){var e=100;if("en"!=this.lang){e=Math.floor(NaN)}t("#complete").html(e)},Translator.prototype.row=function(t,e,a){var n=a.indexOf('id="');n=(n=a.substr(n+4)).substr(0,n.indexOf('"'));var i="\t<fieldset>";return i+="\t\t<legend>"+t+"</legend>",i+='\t\t<div class="twocol">',i+="\t\t\t<p>"+e+"</p>",i+="\t\t</div>",i+='\t\t<div class="fourcol">',i+="\t\t\t"+a,i+="\t\t</div>",i+="\t</fieldset>"},Translator.prototype.getOutput=function(){var e=sanitize(t("form#language").formToJSON(this)),a='<textarea onfocus="this.select()"'+(e?' style="height:'+(e.split("\n").length+5)+'em;font-family:monospace;"':"")+' wrap="off">'+e+"</textarea>";0==t("#output").length&&t("#translation").after('<div id="output"></div>'),t("#output").html(a)},t.fn.formToJSON=function(e){if(e.phrasebook){var a=JSON.parse(JSON.stringify(e.phrasebook));this.find("input, textarea, select").each((function(e){"submit"!=t(this).attr("name")&&function setValue(t,e,a){for(var n=e.split("."),i=t,s=0;s<n.length-1;s++){var r=n[s];r in i||(i[r]={}),i=i[r]}i[n[n.length-1]]=a}(a,t(this).attr("name").substr(1),function converter(t){if(!t)return"";for(var e="",a=0;a<t.length;a++)t.charCodeAt(a)>127?e+="&amp;#"+t.charCodeAt(a)+";":e+=t.charAt(a);return e}(t(this).val()))}))}return JSON.stringify(a,null," ")},t.translator=function(e,a){return"object"==typeof a?a.container=e:a="string"==typeof e?{container:e}:e,a.plugins=t.translator.plugins,new Translator(a)},t.translator.plugins=[]}(jQuery);