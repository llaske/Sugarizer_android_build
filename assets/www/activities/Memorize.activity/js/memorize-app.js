/*! Sugarizer 2020-03-14 */
define(["activity/sample-ressources","activity/palettes/template-palette","activity/palettes/size-palette","activity/lz-string","sugar-web/graphics/journalchooser","sugar-web/datastore","tutorial"],function(a,b,c,d,e,f,g){function h(a){for(var b,c,d=a.length;0!==d;)c=Math.floor(Math.random()*d),d-=1,b=a[d],a[d]=a[c],a[c]=b;return a}function i(a){T.presence.isConnected()&&(T.inEditMode=!1,I(),J(),T.game.multiplayer=!0,T.isHost=a,T.me=T.presence.userInfo,T.game.currentPlayer=T.me.networkId,T.ui.gamePlayers.style.display="block")}function j(a){if(T.game.cards=[],T.game.selectedCards=[],T.game.template){T.game.mode=T.game.template.mode;var b={name:T.game.template.name,cards:[]};b.cards=JSON.parse(JSON.stringify(h(T.game.template.cards)));var c=0;if(c=T.game.size%2==0?T.game.size*T.game.size:T.game.size*T.game.size-2,T.game.mode==L){for(var d=[],e=0;e<b.cards.length&&e<c/2;e++){var f=b.cards[e][0],g=b.cards[e][1];f.id=e,g.id=e,d.push(f),d.push(g)}T.game.cards=h(d)}if(T.game.mode==M){for(var i=[],j=[],e=0;e<c/2&&e<b.cards.length;e++){var f=b.cards[e][0],g=b.cards[e][1];f.id=e,g.id=e,i.push(f),j.push(g)}for(var k=h(i),e=0;e<k.length;e++)T.game.cards.push(k[e]);for(var l=h(j),e=0;e<l.length;e++)T.game.cards.push(l[e])}a||r()}}function k(){for(var a=document.getElementsByClassName("textCard"),b=0;b<a.length;b++){for(var c=a[b];c.scrollHeight>c.offsetHeight;)c.style.fontSize=parseInt(c.style.fontSize)-1+"px";for(;c.scrollWidth>c.offsetWidth;)c.style.fontSize=parseInt(c.style.fontSize)-1+"px"}}function l(b,c){if(b.image){0==b.image.indexOf(P)&&(b.image=a[b.image.slice(P.length)]);var d=document.createElement("div");return d.style.background="url('"+b.image+"')",d.style.backgroundRepeat="no-repeat",d.style.backgroundSize="contain",d.style.webkitBackgroundSize="contain",d.style.backgroundPosition="center center",d.style.height=c+"px",d.style.width=c+"px",d}if(b.text){0==b.text.indexOf(P)&&(b.text=a[b.text.slice(P.length)]);var d=document.createElement("div");return d.className="textCard",d.style.textAlign="center",d.style.display="block",d.innerHTML=b.text,d.style.lineHeight=c+"px",d.style.fontSize=c+"px",d.style.color="#000",d.style.width=c+"px",d.style.height=c+"px",d}}function m(){if(!T.context){var a=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;if(a){a=new a,T.context=a;var b=a.createBuffer(1,1,22050),c=a.createBufferSource();T.source=c,c.buffer=b,c.connect(a.destination),c.start(0)}}}function n(a,b,c,d){var e=document.createElement("div");return e.cardPosition=a,e.webkitPerspective="500px",e.perspective="500px",e.style.border="3px solid #fff",e.style.borderRadius="6px",e.style.margin="3px",e.style.webkitTransition="transform 0.5s",e.style.transition="transform 0.5s",T.game.template.mode==M?e.id=a<d?"numberOneTutorial":"numberTwoTutorial":a===d-2?e.id="soundTutorial":a===d+2&&(e.id="soundTutorial2"),e.style.transitionDuration="0.5s",e.style.webkitTransitionDuration="0.5s",e.style.transformStyle="preserve-3d",e.style.webkitTransformStyle="preserve-3d",e.style.position="relative",e.style.float="left",e.style.height=b+"px",e.style.width=b+"px",c.solved?(e.style.webkitTransform="rotateY(180deg)",e.style.transform="rotateY(180deg)"):(e.style.webkitTransform="",e.style.transform=""),0!=T.game.selectedCards.length&&T.game.selectedCards[0].cardPosition==e.cardPosition&&(e.style.webkitTransform="",e.style.transform=""),e}function o(a,b,c){var d=document.createElement("div");return T.game.mode==L&&(d.style.background="#777"),T.game.mode==M&&(d.style.background=a<b?"#777 url(icons/number1.svg)":"#777 url(icons/number2.svg)"),d.zIndex=2,d.style.borderRadius="6px",d.style.webkitBackfaceVisibility="hidden",d.style.backfaceVisibility="hidden",d.style.backgroundPosition="center center",d.style.backgroundRepeat="no-repeat",d.style.height=c+"px",d.style.position="absolute",d.style.top="0px",d.style.left="0px",d.style.width=c+"px",d}function p(a,b,c){var d=document.createElement("div"),e=l(T.game.cards[a],b);return d.appendChild(e),d.style.height=b+"px",d.style.webkitBackfaceVisibility="hidden",d.style.backfaceVisibility="hidden",d.style.mozBackfaceVisibility="hidden",d.style.position="absolute",d.style.webkitTransform="rotateY(180deg)",d.style.transform="rotateY(180deg)",d.style.top="0px",d.style.left="0px",d.style.borderRadius="6px",d.style.width=b+"px",d.style.background="#fff",c.solved&&(d.style.backgroundColor=K),d}function q(b,c,d){var e=T.game.cards.length/2;m();var f=b;if(!f.card.solved&&2!=T.game.selectedCards.length){if(T.game.mode==M&&1==T.game.selectedCards.length){if(f.cardPosition<e&&T.game.selectedCards[0].cardPosition<e)return;if(f.cardPosition>=e&&T.game.selectedCards[0].cardPosition>=e)return}if(f.style.webkitTransform="rotateY(180deg)",f.style.transform="rotateY(180deg)",1!=T.game.selectedCards.length||T.game.selectedCards[0]!=f){if(T.game.selectedCards.push(f),f.card.sound){0==f.card.sound.indexOf(P)&&(f.card.sound=a[f.card.sound.slice(P.length)]);var g=f.card.sound.split("base64,")[1];g=V.decodeArrayBuffer(btoa(atob(g))),T.context&&T.context.decodeAudioData(g,function(a){var b=T.context.createBufferSource();if(T.source)try{T.source.stop(0)}catch(a){}T.source=b,b.buffer=a,b.connect(T.context.destination);try{b.start(0)}catch(a){}},function(a){console.log("err(decodeAudioData): "+a)})}if(1!=T.game.selectedCards.length){if(T.game.selectedCards[0].card.id==f.card.id){T.game.selectedCards[0].card.solved=!0,f.card.solved=!0;for(var h=0;h<T.game.players.length;h++)T.game.players[h].networkId==d.networkId&&(T.game.players[h].score=T.game.players[h].score+1);w();var i=T.game.selectedCards[0].resultDiv,j=f.resultDiv;return setTimeout(function(){i.style.backgroundColor=K,j.style.backgroundColor=K},1e3),T.game.selectedCards=[],void r()}T.game.currentPlayer="",setTimeout(function(){try{f.style.webkitTransform="",f.style.transform="",T.game.selectedCards[0].style.webkitTransform="",T.game.selectedCards[0].style.transform="",T.game.selectedCards=[],setTimeout(function(){if(c)for(var a=0;a<T.game.players.length;a++)if(T.game.players[a].online&&T.game.players[a].networkId!=T.me.networkId){T.game.currentPlayer=T.game.players[a].networkId,v({action:"updateCurrentPlayer",currentPlayer:T.game.currentPlayer}),w();break}},300)}catch(a){}},2e3)}}}}function r(){T.activity.getDatastoreObject().setDataAsText(JSON.stringify({game:T.game})),T.activity.getDatastoreObject().save(function(a,b){})}function s(){if(T.game.multiplayer){if(T.game.currentPlayer!=T.me.networkId)return;v({action:"cardClick",position:this.cardPosition}),0!=T.game.players.length&&1!=T.game.players.length||q(this,!0);for(var a=0;a<T.game.players.length;a++)T.game.players[a].networkId==T.me.networkId&&q(this,!0,T.game.players[a])}else q(this,!0)}function t(){T.editor.pairMode==N?T.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-non-equals.svg)":T.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-equals.svg)",T.game.template.mode==L?T.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game1.svg)":T.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game2.svg)",T.ui.gameSizeButton.style.background="url(icons/"+T.game.size+"x"+T.game.size+".svg)",T.ui.gameTemplatesButton.style.backgroundImage="url(icons/"+T.game.template.icon+")",T.ui.gameGrid.innerHTML="";var a=T.ui.gameGrid,b=document.body.clientWidth,c=document.body.clientHeight,d=T.game.cards.length/2,e=c;b<c&&(e=b),e-=228,e/=T.game.size;for(var f=0;f<T.game.cards.length;f++){var g=T.game.cards[f];if(f%T.game.size==0&&f>0){var h=document.createElement("div");h.style.clear="both",a.appendChild(h)}var i=n(f,e,g,d),j=o(f,d,e),h=p(f,e,g);i.card=g,i.resultDiv=h;var l="click";"ontouchstart"in document.documentElement&&(l="touchend"),i.addEventListener(l,s,!1),i.appendChild(h),i.appendChild(j),a.appendChild(i)}a.style.width=parseInt(e+10)*parseInt(T.game.size+1)+"px",a.style.marginLeft="auto",a.style.marginRight="auto",k()}function u(a){if(a.user.networkId!=T.me.networkId&&(a.content=JSON.parse(d.decompressFromUTF16(a.content)),"updateCurrentPlayer"==a.content.action&&(T.game.currentPlayer=a.content.currentPlayer,w()),"updateGame"==a.content.action&&(T.game=a.content.game,T.ui.gameSizeButton.style.background="url(icons/"+T.game.size+"x"+T.game.size+".svg)",T.ui.gameTemplatesButton.style.backgroundImage="url(icons/"+T.game.template.icon+")",T.drawGame(),w(),r()),"cardClick"==a.content.action)){for(var b=T.ui.gameGrid.childNodes,c=[],e=0;e<b.length;e++)b[e].style.clear&&""!=b[e].style.clear||c.push(b[e]);for(var e=0;e<T.game.players.length;e++)T.game.players[e].networkId==a.user.networkId&&q(c[a.content.position],!1,T.game.players[e])}}function v(a){if(T.game.multiplayer){var b=window.top.sugar.environment.sharedId;b||(b=T.presence.getSharedInfo().id),T.presence.sendMessage(b,{user:T.presence.getUserInfo(),content:d.compressToUTF16(JSON.stringify(a))})}}function w(){if(0!=T.game.players.length){var a=document.createElement("div"),b=!1;T.game.currentPlayer==T.me.networkId&&(b=!0);var c=document.createElement("div");c.style.float="left",c.style.marginTop="10px",c.style.width="30px",c.style.marginRight="3px",c.style.borderRight="1px solid #fff",c.style.height="30px",c.style.backgroundImage=b?"url(icons/play.svg)":"url(icons/sandclock.svg)",c.style.backgroundPosition="center center",c.style.backgroundRepeat="no-repeat",a.appendChild(c);for(var d=0;d<T.game.players.length;d++){var e=T.game.players[d],f=document.createElement("div");f.style.paddingTop="15px";for(var g=y(e.colorvalue),h="",i=0;i<e.score;i++)h+='<img style="height:13px;" src="icons/pair-add.svg">';f.innerHTML='<img style="height:23px; vertical-align:middle; " src="'+g+'"><span style="color:#fff;">'+e.name+"</span> "+h,f.style.float="left",0!=d&&(f.style.marginLeft="10px"),a.appendChild(f)}T.ui.gamePlayers.innerHTML="",T.ui.gamePlayers.appendChild(a)}}function x(a){for(var b=0;b<T.game.players.length;b++)T.game.players[b].online=!1;if(!T.hasLoadedMultiplayer&&a.length>=3)return void document.getElementById("stop-button").click();if(T.hasLoadedMultiplayer=!0,1==a.length)return T.isHost=!0,T.game.currentPlayer=T.me.networkId,T.game.selectedCards=[],t(),void w();for(var b=0;b<a.length;b++){for(var c=!1,d=0;d<T.game.players.length;d++)if(T.game.players[d].networkId==a[b].networkId){T.game.players[d].online=!0,c=!0;break}if(!c){var e=a[b];e.score=0,e.online=!0,T.game.players.push(e)}}T.isHost&&v({action:"updateGame",game:T.game}),w()}function y(a){var b=U;return b=b.replace("#010101",a.stroke),b=b.replace("#FFFFFF",a.fill),"data:image/svg+xml;base64,"+btoa(b)}function z(a){T.ui.gameGrid=document.getElementById("game-grid"),T.ui.gamePlayers=document.getElementById("game-players"),T.ui.gameEditor=document.getElementById("game-editor"),T.ui.gameTemplatesButton=document.getElementById("game-templates-button"),new b.TemplatePalette(T.ui.gameTemplatesButton,void 0,T.templates).addEventListener("template",function(a){for(var b=0;b<T.game.players.length;b++)T.game.players[b].score=0;T.game.template=a.detail.value,T.ui.gameTemplatesButton.style.backgroundImage="url(icons/"+a.detail.value.icon+")",T.computeCards(),T.drawGame(),v({action:"updateGame",game:T.game})}),T.ui.gameSizeButton=document.getElementById("game-size-button"),new c.SizePalette(T.ui.gameSizeButton).addEventListener("size",function(a){for(var b=0;b<T.game.players.length;b++)T.game.players[b].score=0;T.game.size=a.detail.value,T.ui.gameSizeButton.style.background="url(icons/"+a.detail.value+"x"+a.detail.value+".svg)",T.computeCards(),T.drawGame(),v({action:"updateGame",game:T.game})}),T.ui.gameResetButton=document.getElementById("game-reset-button"),T.ui.gameResetButton.addEventListener("click",function(){for(var a=0;a<T.game.players.length;a++)T.game.players[a].score=0;T.game.selectedCards=[],T.game.cards=[],w(),T.computeCards(),T.drawGame(),v({action:"updateGame",game:T.game})}),T.ui.gameEditorButton=document.getElementById("game-editor-button"),T.ui.gameEditorInsertModeButton=document.getElementById("game-editor-insert-mode-button"),T.ui.gameEditorPlayModeButton=document.getElementById("game-editor-play-mode-button"),T.ui.gameEditorPlayModeButton.addEventListener("click",function(){T.game.template.mode==L?(T.game.template.mode=M,T.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game2.svg)"):(T.game.template.mode=L,T.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game1.svg)"),r(),H()}),T.ui.gameEditorClearButton=document.getElementById("game-editor-clear-button"),T.ui.gameEditorInsertModeButton.addEventListener("click",function(){T.editor.pairMode==N?(T.editor.pairMode=O,T.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-non-equals.svg)"):(T.editor.pairMode=N,T.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-equals.svg)"),r(),H()}),T.ui.gameEditorClearButton.addEventListener("click",function(){T.game.template.cards=[],r(),H()}),T.ui.gameEditorButton.addEventListener("click",function(){T.inEditMode?I():A()}),T.ui.tutorialButton=document.getElementById("help-button"),T.ui.tutorialButton.addEventListener("click",function(){var a=(Object.keys(T.game.cards[0]),T.game.template.mode==M?1:2);T.inEditMode?g.startEditorTutorial():g.startMainTutorial(a)}),T.ui.gameEditorInsertModeButton.disabled=!0,T.ui.gameEditorInsertModeButton.style.opacity=.3,T.ui.gameEditorPlayModeButton.disabled=!0,T.ui.gameEditorPlayModeButton.style.opacity=.3,T.ui.gameEditorClearButton.disabled=!0,T.ui.gameEditorClearButton.style.opacity=.3,window.onresize=function(){setTimeout(function(){T.inEditMode?H():T.drawGame()},250)},a&&a()}function A(){T.inEditMode=!0,T.ui.gameGrid.innerHTML="",T.ui.gameGrid.style.display="none",T.ui.gameEditor.style.display="block",T.game.selectedCards=[],T.editor.selectedPair=-1,T.ui.gameTemplatesButton.disabled=!0,T.ui.gameTemplatesButton.style.opacity=.3,T.ui.gameSizeButton.disabled=!0,T.ui.gameSizeButton.style.opacity=.3,T.ui.gameResetButton.disabled=!0,T.ui.gameResetButton.style.opacity=.3,T.ui.gameEditorInsertModeButton.disabled=!1,T.ui.gameEditorInsertModeButton.style.opacity=1,T.ui.gameEditorPlayModeButton.disabled=!1,T.ui.gameEditorPlayModeButton.style.opacity=1,T.ui.gameEditorClearButton.disabled=!1,T.ui.gameEditorClearButton.style.opacity=1,T.ui.gameEditorButton.style.backgroundImage="url(icons/play.svg)",H()}function B(a){var b=document.body.clientWidth;b>document.body.clientHeight&&(b=document.body.clientHeight);var c=document.createElement("div");c.style.width=parseInt(b/3.5)+"px",c.style.marginLeft="25px",c.style.float="left",c.style.marginTop="7px";var d=document.createElement("div");d.style.width=parseInt(b/3.5)-10+"px",d.style.height=parseInt(b/3.5)-10+"px",d.style.background="rgb(119, 119, 119)",d.style.border="4px solid #000",d.style.textAlign="center",d.style.borderRadius="9px",d.style.color="#fff",d.style.fontSize=parseInt(b/3.5)-10+"px",d.style.lineHeight=parseInt(b/3.5)-10+"px",d.className="textCard",d.style.backgroundRepeat="no-repeat",d.style.backgroundSize="100%",d.style.backgroundPosition="center",a&&a.text?d.innerHTML=a.text:a&&a.image&&(d.style.backgroundImage="url('"+a.image+"')");var e=document.createElement("img");e.id="InsertImage",e.style.marginLeft="5px",e.style.marginTop="5px",e.style.textAlign="center",e.setAttribute("src","icons/import_picture.svg"),e.style.width="30px",e.className="insertImage";var f=document.createElement("input");return f.id="InputBox",f.setAttribute("type","text"),f.style.marginRight="auto",f.style.marginLeft="auto",f.style.width=parseInt(b/3.5)-50+"px",f.style.marginTop="5px",f.card=a,a&&a.text&&(f.value=a.text),f.linkedDiv=d,f.onkeyup=function(){this.linkedDiv.innerHTML=this.value,this.linkedDiv.style.fontSize=this.linkedDiv.style.width,this.card.text=this.value,k()},c.appendChild(d),c.appendChild(f),c.appendChild(e),c}function C(){var a=document.createElement("div"),b=document.body.clientWidth;b>document.body.clientHeight&&(b=document.body.clientHeight),a.style.float="right",a.style.height=parseInt(b/3.5)+"px",a.style.marginRight="20px",a.style.marginTop="7px";var c=document.createElement("div"),d=document.createElement("div"),e=document.createElement("div"),f=parseInt(b/3.5/5)+"px";return c.id="EditorAddButton",c.style.padding="5px",c.style.userSelect="none",c.style.webkitUserSelect="none",c.style.mozUserSelect="none",c.innerHTML="<img style='height:"+f+"; width:"+f+";' src='icons/pair-add.svg'><br/>"+T.strings.add,c.onmouseover=function(){this.style.background="#888"},c.onmouseout=function(){this.style.background="transparent"},c.addEventListener("click",function(){var a=[];T.editor.pairMode==N&&(a[0]=T.editor.card1,a[1]=T.editor.card1),T.editor.pairMode==O&&(a[0]=T.editor.card1,a[1]=T.editor.card2),(a[0].text||a[0].image||a[0].sound)&&(a[1].text||a[1].image||a[1].sound)&&(a=JSON.parse(JSON.stringify(a)),T.editor.card1={},T.editor.card2={},T.game.template.cards.push(a),T.editor.selectedPair=-1,r(),H())}),d.id="EditorUpdateButton",d.style.padding="5px",d.style.userSelect="none",d.style.webkitUserSelect="none",d.style.mozUserSelect="none",d.innerHTML="<img style='height:"+f+"; width:"+f+";' src='icons/pair-update.svg'><br/>"+T.strings.update,d.onmouseover=function(){this.style.background="#888"},d.onmouseout=function(){this.style.background="transparent"},d.addEventListener("click",function(){var a=[];T.editor.pairMode==N&&(a[0]=T.editor.card1,a[1]=T.editor.card1),T.editor.pairMode==O&&(a[0]=T.editor.card1,a[1]=T.editor.card2),(a[0].text||a[0].image||a[0].sound)&&(a[1].text||a[1].image||a[1].sound)&&(a=JSON.parse(JSON.stringify(a)),T.editor.selectedPair>-1&&(T.game.template.cards[T.editor.selectedPair]=a),r(),H())}),e.id="EditorDeleteButton",e.style.padding="5px",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.mozUserSelect="none",e.innerHTML="<img style='height:"+f+"; width:"+f+";' src='icons/remove.svg'><br/>"+T.strings.remove,e.onmouseover=function(){this.style.background="#888"},e.onmouseout=function(){this.style.background="transparent"},e.addEventListener("click",function(){T.editor.selectedPair>-1&&T.game.template.cards.splice(T.editor.selectedPair,1),T.editor.selectedPair=-1,T.editor.card1={},T.editor.card2={},r(),H()}),a.appendChild(c),a.appendChild(d),a.appendChild(e),a}function D(b,c,d){c-=10;var e=document.createElement("div");e.style.display="inline-block",e.style.height=c+"px",e.style.marginLeft="5px",d==T.editor.selectedPair&&(e.style.border="3px solid #00f");var f=document.createElement("div");f.style.backgroundRepeat="no-repeat",f.style.backgroundSize="cover",f.style.backgroundPosition="center center",f.innerHTML="&nbsp;",f.style.backgroundColor="#666",f.className="textCard",b[0].text?(0==b[0].text.indexOf(P)&&(b[0].text=a[b[0].image.slice(P.length)]),f.innerHTML=b[0].text):b[0].image&&(0==b[0].image.indexOf(P)&&(b[0].image=a[b[0].image.slice(P.length)]),f.style.backgroundImage="url('"+b[0].image+"')"),f.style.width=parseInt(c/2)+"px",f.style.height=parseInt(c/2)+"px",f.style.lineHeight=f.style.width+"",f.style.borderRadius="6px",f.style.textAlign="center",f.style.fontSize=parseInt(c/8)+"px",f.style.border="1px solid #000",f.style.color="#fff",f.style.marginBottom="5px";var g=document.createElement("div");return g.style.backgroundRepeat="no-repeat",g.style.backgroundPosition="center center",g.style.backgroundSize="cover",g.innerHTML="&nbsp;",g.style.backgroundColor="#666",g.className="textCard",b[1].text?(0==b[1].text.indexOf(P)&&(b[1].text=a[b[1].image.slice(P.length)]),g.innerHTML=b[1].text):b[1].image&&(0==b[1].image.indexOf(P)&&(b[1].image=a[b[1].image.slice(P.length)]),g.style.backgroundImage="url('"+b[1].image+"')"),g.style.width=parseInt(c/2)+"px",g.style.height=parseInt(c/2)+"px",g.style.textAlign="center",g.style.lineHeight=g.style.width+"",g.style.borderRadius="6px",g.style.fontSize=parseInt(c/8)+"px",g.style.border="1px solid #000",g.style.color="#fff",e.appendChild(f),e.appendChild(g),e}function E(){document.getElementsByClassName("insertImage")[0].onclick=function(){e.show(function(a){if(a){new f.DatastoreObject(a.objectId).loadAsText(function(b,c,d){var e=document.createElement("img");"org.olpcfrance.PaintActivity"==a.metadata.activity?e.src=LZString.decompressFromUTF16(JSON.parse(d).src):e.src=d,e.onload=function(){document.getElementsByClassName("textCard")[0].style.backgroundImage="url("+e.src+")",T.editor.pairMode==N?(T.editor.card1.image=e.src,T.editor.card1.text="",T.editor.card2.image=e.src,T.editor.card2.text=""):(T.editor.card1.image=e.src,T.editor.card1.text="");var a=[];T.editor.pairMode==N&&(a[0]=T.editor.card1,a[1]=T.editor.card1),T.editor.pairMode==O&&(a[0]=T.editor.card1,a[1]=T.editor.card2),(a[0].text||a[0].image||a[0].sound)&&(a[1].text||a[1].image||a[1].sound)&&(a=JSON.parse(JSON.stringify(a)),T.editor.selectedPair>-1&&(T.game.template.cards[T.editor.selectedPair]=a),r(),H())}})}},{mimetype:"image/png"},{mimetype:"image/jpeg"},{activity:"org.olpcfrance.PaintActivity"})},document.getElementsByClassName("insertImage")[1]&&(document.getElementsByClassName("insertImage")[1].onclick=function(){e.show(function(a){if(a){new f.DatastoreObject(a.objectId).loadAsText(function(a,b,c){var d=document.createElement("img");d.src=c,d.onload=function(){document.getElementsByClassName("textCard")[1].style.backgroundImage="url("+d.src+")",T.editor.pairMode==N?(T.editor.card1.image=d.src,T.editor.card1.text="",T.editor.card2.image=d.src,T.editor.card2.text=""):(T.editor.card2.image=d.src,T.editor.card2.text="");var a=[];T.editor.pairMode==N&&(a[0]=T.editor.card1,a[1]=T.editor.card1),T.editor.pairMode==O&&(a[0]=T.editor.card1,a[1]=T.editor.card2),(a[0].text||a[0].image||a[0].sound)&&(a[1].text||a[1].image||a[1].sound)&&(a=JSON.parse(JSON.stringify(a)),T.editor.selectedPair>-1&&(T.game.template.cards[T.editor.selectedPair]=a),r(),H())}})}},{mimetype:"image/png"},{mimetype:"image/jpeg"})})}function F(){var a=document.createElement("div"),b=document.body.clientWidth;b>document.body.clientHeight&&(b=document.body.clientHeight),a.style.position="fixed",a.style.bottom=0,a.style.width=document.body.clientWidth+"px",a.style.height=parseInt(b/3)+"px",a.style.padding="10px",a.style.paddingBottom="20px",a.style.marginTop="7px",a.style.background="#eee",a.style.overflowX="auto",a.style.whiteSpace="nowrap",a.style.overflowY="hidden";for(var c=0;c<T.game.template.cards.length;c++){var d=T.game.template.cards[c],e=D(d,parseInt(b/3),c);e.cards=d,e.index=c,e.addEventListener("click",function(){T.editor.selectedPair=this.index,T.editor.pairMode=O,T.editor.card1=this.cards[0],T.editor.card2=this.cards[1],H()}),a.appendChild(e)}var f=document.createElement("div");return f.style.height=parseInt(b/6)+"px",f.style.width="30px",f.style.display="inline-block",a.appendChild(f),a}function G(){var a=document.createElement("div");return a.style.clear="both",a}function H(){T.ui.gameEditor.innerHTML="",T.editor.pairMode==N&&T.ui.gameEditor.appendChild(B(T.editor.card1)),T.editor.pairMode==O&&(T.ui.gameEditor.appendChild(B(T.editor.card1)),T.ui.gameEditor.appendChild(B(T.editor.card2))),E(),T.ui.gameEditor.appendChild(C()),T.ui.gameEditor.appendChild(G()),T.ui.gameEditor.appendChild(F()),k()}function I(){T.editor.card1={},T.editor.card2={},T.inEditMode=!1,T.ui.gameEditor.innerHTML="",T.ui.gameEditor.style.display="none",T.ui.gameGrid.style.display="block",T.ui.gameTemplatesButton.disabled=!1,T.ui.gameTemplatesButton.style.opacity=1,T.ui.gameSizeButton.disabled=!1,T.ui.gameSizeButton.style.opacity=1,T.ui.gameResetButton.disabled=!1,T.ui.gameResetButton.style.opacity=1,T.ui.gameEditorInsertModeButton.disabled=!0,T.ui.gameEditorInsertModeButton.style.opacity=.3,T.ui.gameEditorPlayModeButton.disabled=!0,T.ui.gameEditorPlayModeButton.style.opacity=.3,T.ui.gameEditorClearButton.disabled=!0,T.ui.gameEditorClearButton.style.opacity=.3,T.ui.gameEditorButton.style.backgroundImage="url(icons/cog.svg)",T.drawGame()}function J(){T.ui.gameEditorButton.disabled=!0,T.ui.gameEditorButton.style.opacity=.3,T.ui.gameEditorButton.style.backgroundImage="url(icons/cog.svg)",T.ui.gameEditorInsertModeButton.disabled=!0,T.ui.gameEditorInsertModeButton.style.opacity=.3,T.ui.gameEditorPlayModeButton.disabled=!0,T.ui.gameEditorPlayModeButton.style.opacity=.3,T.ui.gameEditorClearButton.disabled=!0,T.ui.gameEditorClearButton.style.opacity=.3}var K="#84f060",L="classic",M="splitted",N="equal",O="non_equal",P="#inline#",Q={name:"Addition",icon:"addition.svg",cards:[[{text:"3+4"},{text:"7"}],[{text:"5+5"},{text:"10"}],[{text:"5+6"},{text:"11"}],[{text:"4+4"},{text:"8"}],[{text:"4+5"},{text:"9"}],[{text:"3+3"},{text:"6"}],[{text:"2+2"},{text:"4"}],[{text:"1+1"},{text:"2"}],[{text:"1+2"},{text:"3"}],[{text:"9+9"},{text:"18"}],[{text:"10+9"},{text:"19"}],[{text:"8+8"},{text:"16"}],[{text:"8+9"},{text:"17"}],[{text:"7+7"},{text:"14"}],[{text:"7+8"},{text:"15"}],[{text:"6+6"},{text:"12"}]],mode:M},R={name:"Letters",icon:"letters.svg",cards:[[{text:"A"},{text:"a"}],[{text:"B"},{text:"b"}],[{text:"C"},{text:"c"}],[{text:"D"},{text:"d"}],[{text:"E"},{text:"e"}],[{text:"F"},{text:"f"}],[{text:"G"},{text:"g"}],[{text:"H"},{text:"h"}],[{text:"I"},{text:"i"}],[{text:"J"},{text:"j"}],[{text:"K"},{text:"k"}],[{text:"L"},{text:"l"}],[{text:"M"},{text:"m"}],[{text:"N"},{text:"n"}],[{text:"O"},{text:"o"}],[{text:"P"},{text:"p"}],[{text:"Q"},{text:"q"}],[{text:"R"},{text:"r"}],[{text:"S"},{text:"s"}],[{text:"T"},{text:"t"}],[{text:"U"},{text:"u"}],[{text:"V"},{text:"v"}],[{text:"W"},{text:"w"}],[{text:"X"},{text:"x"}],[{text:"Y"},{text:"y"}],[{text:"Z"},{text:"z"}]],mode:M},S={name:"Sounds",icon:"sounds.svg",cards:[[{image:P+"drumkit1_b",sound:P+"beat1_a"},{image:P+"drumkit1_b",sound:P+"beat1_a"}],[{image:P+"drumkit2_b",sound:P+"beat1_b"},{image:P+"drumkit2_b",sound:P+"beat1_b"}],[{image:P+"drumkit3_b",sound:P+"beat1_c"},{image:P+"drumkit3_b",sound:P+"beat1_c"}],[{image:P+"drumkit4_b",sound:P+"beat8"},{image:P+"drumkit4_b",sound:P+"beat8"}],[{image:P+"drumkit5_b",sound:P+"beat10"},{image:P+"drumkit5_b",sound:P+"beat10"}],[{image:P+"drumkit6_b",sound:P+"beat3"},{image:P+"drumkit6_b",sound:P+"beat3"}],[{image:P+"drumkit7_b",sound:P+"beat4"},{image:P+"drumkit7_b",sound:P+"beat4"}],[{image:P+"drumkit8_b",sound:P+"beat14"},{image:P+"drumkit8_b",sound:P+"beat14"}],[{image:P+"drumkit9_b",sound:P+"beat6_2"},{image:P+"drumkit9_b",sound:P+"beat6_2"}],[{image:P+"drumkit10_b",sound:P+"beat2"},{image:P+"drumkit10_b",sound:P+"beat2"}],[{image:P+"drumkit11_b",sound:P+"beat16"},{image:P+"drumkit11_b",sound:P+"beat16"}],[{image:P+"drumkit12_b",sound:P+"beat17"},{image:P+"drumkit12_b",sound:P+"beat17"}],[{image:P+"guitar1_2",sound:P+"bending_a"},{image:P+"guitar1_2",sound:P+"bending_a"}],[{image:P+"guitar2_2",sound:P+"bending_b"},{image:P+"guitar2_2",sound:P+"bending_b"}],[{image:P+"guitar3_2",sound:P+"flashcomp2a"},{image:P+"guitar3_2",sound:P+"flashcomp2a"}],[{image:P+"guitar4_2",sound:P+"flashcomp2b"},{image:P+"guitar4_2",sound:P+"flashcomp2b"}],[{image:P+"guitar5_2",sound:P+"gedaempft"},{image:P+"guitar5_2",sound:P+"gedaempft"}],[{image:P+"guitar6_2",sound:P+"ungedaempft"},{image:P+"guitar6_2",sound:P+"ungedaempft"}],[{image:P+"guitar7_2",sound:P+"jimi4"},{image:P+"guitar7_2",sound:P+"jimi4"}],[{image:P+"guitar8_2",sound:P+"git_hit1"},{image:P+"guitar8_2",sound:P+"git_hit1"}],[{image:P+"guitar9_2",sound:P+"git_hit4"},{image:P+"guitar9_2",sound:P+"git_hit4"}],[{image:P+"guitar10_2",sound:P+"jimi1"},{image:P+"guitar10_2",sound:P+"jimi1"}],[{image:P+"guitar11_2",sound:P+"flasholet4"},{image:P+"guitar11_2",sound:P+"flasholet4"}],[{image:P+"guitar12_2",sound:P+"guitcello"},{image:P+"guitar12_2",sound:P+"guitcello"}]],mode:L},T={strings:{add:"Add",update:"Update",remove:"Remove"},ui:{},templates:[Q,R,S],isHost:!1,editor:{pairMode:N,card1:{},card2:{},selectedPair:-1},game:{template:R,multiplayer:!1,selectedCards:[],mode:void 0,cards:[],currentPlayer:"",players:[],size:4},computeCards:j,inEditMode:!1,shareActivity:i,initUI:z,drawGame:t,onUsersListChanged:x,onDataReceived:u},U='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>',V={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_arrayBufferToBase64:function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;e<d;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)},decodeArrayBuffer:function(a){var b=a.length/4*3,c=new ArrayBuffer(b);return this.decode(a,c),c},removePaddingChars:function(a){return 64==this._keyStr.indexOf(a.charAt(a.length-1))?a.substring(0,a.length-1):a},decode:function(a,b){a=this.removePaddingChars(a),a=this.removePaddingChars(a);var c,d,e,f,g,h,i,j,k=parseInt(a.length/4*3,10),l=0,m=0;for(c=b?new Uint8Array(b):new Uint8Array(k),a=a.replace(/[^A-Za-z0-9\+\/\=]/g,""),l=0;l<k;l+=3)g=this._keyStr.indexOf(a.charAt(m++)),h=this._keyStr.indexOf(a.charAt(m++)),i=this._keyStr.indexOf(a.charAt(m++)),j=this._keyStr.indexOf(a.charAt(m++)),d=g<<2|h>>4,e=(15&h)<<4|i>>2,f=(3&i)<<6|j,c[l]=d,64!=i&&(c[l+1]=e),64!=j&&(c[l+2]=f);return c}};return T});