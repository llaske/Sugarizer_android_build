!function(t,r){"object"==typeof exports?module.exports=r.call(t):"function"==typeof define&&define.amd?define((function(){return r.call(t)})):t.Physics=r.call(t)}("undefined"!=typeof window?window:this,(function(){"use strict";var t=this,r=t.document,s=function f(){return f.world.apply(f,arguments)};s.util={},(s.aabb=function(t,r,s,c){var u={x:0,y:0,hw:0,hh:0};return void 0===t?u:(t&&void 0!==t.x&&(s=r.x,c=r.y,r=t.y,t=t.x),void 0===c&&void 0!==t&&void 0!==r?(u.hw=.5*t,u.hh=.5*r,s&&void 0!==s.x&&(u.x=s.x,u.y=s.y),u):(u.hw=.5*Math.abs(s-t),u.hh=.5*Math.abs(c-r),u.x=.5*(s+t),u.y=.5*(c+r),u))}).contains=function(t,r){return r.x>t.x-t.hw&&r.x<t.x+t.hw&&r.y>t.y-t.hh&&r.y<t.y+t.hh},s.aabb.clone=function(t){return{x:t.x,y:t.y,hw:t.hw,hh:t.hh}},s.aabb.union=function(t,r,s){var c=!0===s?t:{},u=Math.max(t.x+t.hw,r.x+r.hw),p=Math.max(t.y+t.hh,r.y+r.hh),v=Math.min(t.x-t.hw,r.x-r.hw),y=Math.min(t.y-t.hh,r.y-r.hh);return c.hw=.5*Math.abs(u-v),c.hh=.5*Math.abs(p-y),c.x=.5*(u+v),c.y=.5*(p+y),c},s.aabb.overlap=function(t,r){var s=t.x-t.hw,c=r.x-r.hw,u=t.x+t.hw,p=r.x+r.hw;return(u>=c&&p>=u||p>=s&&u>=p)&&(s=t.y-t.hh,c=r.y-r.hh,u=t.y+t.hh,p=r.y+r.hh,u>=c&&p>=u||p>=s&&u>=p)},function(){var d=function(t,r,s){var c=r.normSq()-r.dot(t),u=r.dot(t)-t.normSq();return 0>c?s.clone(r).negate():u>0?s.clone(t).negate():(s.clone(r).vsub(t),s.perp(t.cross(s)>0))};s.gjk=function(t,r,c,u){var p,v,y,_,w=!1,x=!1,P=!1,A=[],C=1,I=s.scratchpad(),T=I.vector().clone(r||s.vector.axis[0]),B=I.vector(),M=I.vector(),S=I.vector(),F=I.vector(),z=0;for(_=t(T),C=A.push(_),B.clone(_.pt),T.negate();++z;){if(B.swap(M),_=t(T),C=A.push(_),B.clone(_.pt),u&&u(A),B.equals(s.vector.zero)){w=!0;break}if(!x&&B.dot(T)<=0){if(c)break;x=!0}if(2===C)T=d(B,M,T);else if(x){if(T.normalize(),_=M.dot(T),Math.abs(_-B.dot(T))<1e-4){P=-_;break}M.normSq()<S.clone(A[0].pt).normSq()?A.shift():A.splice(1,1),T=d(S.clone(A[1].pt),F.clone(A[0].pt),T)}else if(p=p||I.vector(),v=v||I.vector(),p.clone(M).vsub(B),v.clone(A[0].pt).vsub(B),(y=p.cross(v)>0)^B.cross(p)>0)A.shift(),p.perp(!y),T.swap(p);else{if(!(y^v.cross(B)>0)){w=!0;break}A.splice(1,1),v.perp(y),T.swap(p)}if(z>100)return I.done(),{simplex:A,iterations:z,distance:0,maxIterationsReached:!0}}return I.done(),_={overlap:w,simplex:A,iterations:z},!1!==P&&(_.distance=P,_.closest=function(t){var r,c,u=t.length,p=t[u-2],v=t[u-3],y=s.scratchpad(),_=y.vector().clone(p.pt),w=y.vector().clone(v.pt).vsub(_);return w.equals(s.vector.zero)?y.done({a:p.a,b:p.b}):(c=1-(r=-w.dot(_)/w.normSq()),y.done(0>=c?{a:v.a,b:v.b}:0>=r?{a:p.a,b:p.b}:{a:_.clone(p.a).mult(c).vadd(w.clone(v.a).mult(r)).values(),b:_.clone(p.b).mult(c).vadd(w.clone(v.b).mult(r)).values()}))}(A)),_}}(),s.statistics={pushRunningAvg:function(t,r,s,c){var u=t-s;return[s+=u/r,c+=u*(t-s)]},pushRunningVectorAvg:function(t,r,s,c){var u=1/r,p=t.get(0)-s.get(0),v=t.get(1)-s.get(1);s.add(p*u,v*u),c&&(p*=t.get(0)-s.get(0),v*=t.get(1)-s.get(1),c.add(p,v))}},function(){var t=function b(t,r,c){return this instanceof b?(this.v=new s.vector,this.o=new s.vector,t instanceof b?void this.clone(t):(t&&this.setTranslation(t),void this.setRotation(r||0,c))):new b(t,r)};t.prototype.setTranslation=function(t){return this.v.clone(t),this},t.prototype.setRotation=function(t,r){return this.cosA=Math.cos(t),this.sinA=Math.sin(t),r?this.o.clone(r):this.o.zero(),this},t.prototype.clone=function(r){return r?(this.setTranslation(r.v),this.cosA=r.cosA,this.sinA=r.sinA,this.o.clone(r.o),this):new t(this)},s.transform=t}(),function(t){var r=Math.sqrt,c=Math.min,u=Math.max,p=(Math.acos,Math.atan2),v=2*Math.PI,y=!!t.Float64Array,_=function j(t,r){return this instanceof j?(this._=y?new Float64Array(5):[],void(t&&(void 0!==t.x||t._&&t._.length)?this.clone(t):(this.recalc=!0,this.set(t,r)))):new j(t,r)};Object.defineProperties(_.prototype,{x:{get:function(){return+this._[0]},set:function(t){t=+t||0,this.recalc=t===this._[0],this._[0]=t}},y:{get:function(){return+this._[1]},set:function(t){t=+t||0,this.recalc=t===this._[1],this._[1]=t}}}),_.prototype.set=function(t,r){return this.recalc=!0,this._[0]=+t||0,this._[1]=+r||0,this},_.prototype.get=function(t){return this._[t]},_.prototype.vadd=function(t){return this.recalc=!0,this._[0]+=t._[0],this._[1]+=t._[1],this},_.prototype.vsub=function(t){return this.recalc=!0,this._[0]-=t._[0],this._[1]-=t._[1],this},_.prototype.add=function(t,r){return this.recalc=!0,this._[0]+=+t||0,this._[1]+=+r||0,this},_.prototype.sub=function(t,r){return this.recalc=!0,this._[0]-=t,this._[1]-=void 0===r?0:r,this},_.prototype.mult=function(t){return this.recalc||(this._[4]*=t*t,this._[3]*=t),this._[0]*=t,this._[1]*=t,this},_.prototype.dot=function(t){return this._[0]*t._[0]+this._[1]*t._[1]},_.prototype.cross=function(t){return-this._[0]*t._[1]+this._[1]*t._[0]},_.prototype.proj=function(t){return this.dot(t)/t.norm()},_.prototype.vproj=function(t){var r=this.dot(t)/t.normSq();return this.clone(t).mult(r)},_.prototype.angle=function(t){var r;if(this.equals(_.zero))return t?t.angle():NaN;for(r=t&&!t.equals(_.zero)?p(this._[1]*t._[0]-this._[0]*t._[1],this._[0]*t._[0]+this._[1]*t._[1]):p(this._[1],this._[0]);r>Math.PI;)r-=v;for(;r<-Math.PI;)r+=v;return r},_.prototype.angle2=function(t,r){for(var s=t._[0]-this._[0],c=t._[1]-this._[1],u=r._[0]-this._[0],y=r._[1]-this._[1],_=p(c*u-s*y,s*u+c*y);_>Math.PI;)_-=v;for(;_<-Math.PI;)_+=v;return _},_.prototype.norm=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=r(this._[4])),this._[3]},_.prototype.normSq=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=r(this._[4])),this._[4]},_.prototype.dist=function(t){var s,c;return r((s=t._[0]-this._[0])*s+(c=t._[1]-this._[1])*c)},_.prototype.distSq=function(t){var r,s;return(r=t._[0]-this._[0])*r+(s=t._[1]-this._[1])*s},_.prototype.perp=function(t){var r=this._[0];return t?(this._[0]=this._[1],this._[1]=-r):(this._[0]=-this._[1],this._[1]=r),this},_.prototype.normalize=function(){var t=this.norm();return 0===t||(t=1/t,this._[0]*=t,this._[1]*=t,this._[3]=1,this._[4]=1),this},_.prototype.transform=function(t){var r=t.sinA,s=t.cosA,c=t.o._[0],u=t.o._[1];return this._[0]-=c,this._[1]-=u,this.set(this._[0]*s-this._[1]*r+c+t.v._[0],this._[0]*r+this._[1]*s+u+t.v._[1])},_.prototype.transformInv=function(t){var r=t.sinA,s=t.cosA,c=t.o._[0],u=t.o._[1];return this._[0]-=c+t.v._[0],this._[1]-=u+t.v._[1],this.set(this._[0]*s+this._[1]*r+c,-this._[0]*r+this._[1]*s+u)},_.prototype.rotate=function(t,r){var s,c,u=0,p=0;return"number"==typeof t?(s=Math.sin(t),c=Math.cos(t),r&&(u=r.x,p=r.y)):(s=t.sinA,c=t.cosA,u=t.o._[0],p=t.o._[1]),this._[0]-=u,this._[1]-=p,this.set(this._[0]*c-this._[1]*s+u,this._[0]*s+this._[1]*c+p)},_.prototype.rotateInv=function(t){return this.set((this._[0]-t.o._[0])*t.cosA+(this._[1]-t.o._[1])*t.sinA+t.o._[0],-(this._[0]-t.o._[0])*t.sinA+(this._[1]-t.o._[1])*t.cosA+t.o._[1])},_.prototype.translate=function(t){return this.vadd(t.v)},_.prototype.translateInv=function(t){return this.vsub(t.v)},_.prototype.clone=function(t){return t?t._?(this.recalc=t.recalc,t.recalc||(this._[3]=t._[3],this._[4]=t._[4]),this._[0]=t._[0],this._[1]=t._[1],this):this.set(t.x,t.y):new _(this)},_.prototype.swap=function(t){var r=this._;return this._=t._,t._=r,r=this.recalc,this.recalc=t.recalc,t.recalc=r,this},_.prototype.values=function(){return{x:this._[0],y:this._[1]}},_.prototype.zero=function(){return this._[3]=0,this._[4]=0,this._[0]=0,this._[1]=0,this},_.prototype.negate=function(t){return void 0!==t?(this._[t]=-this._[t],this):(this._[0]=-this._[0],this._[1]=-this._[1],this)},_.prototype.clamp=function(t,r){return this._[0]=c(u(this._[0],t.x),r.x),this._[1]=c(u(this._[1],t.y),r.y),this.recalc=!0,this},_.prototype.toString=function(){return"("+this._[0]+", "+this._[1]+")"},_.prototype.equals=function(t){return this._[0]===t._[0]&&this._[1]===t._[1]&&this._[2]===t._[2]},_.axis=[new _(1,0),new _(0,1)],_.zero=new _(0,0),s.vector=_}(this),function(t){var r=t.Physics;s.noConflict=function(){return t.Physics===s&&(t.Physics=r),s}}(this);var c=s.util.decorator=function(t,r){var c={},u={},f=function(t,r){var c,u;for(u in r)(c=Object.getOwnPropertyDescriptor(r,u)).get||c.set?Object.defineProperty(t,u,c):s.util.isFunction(c.value)&&(t[u]=c.value);return t},p=Object.getPrototypeOf;"function"!=typeof p&&(p="object"==typeof"test".__proto__?function(t){return t.__proto__}:function(t){return t.constructor.prototype});var v=Object.create;"function"!=typeof v&&(v=function(t){function b(){}return b.prototype=t,new b});var i=function(r,c){return"object"==typeof r?void((u=f(u,r)).type=t):void("type"!==r&&s.util.isFunction(c)&&(u[r]=c))};i(r);var j=function(r,s,y,_){var w,x=u;if("string"!=typeof s)_=y,y=s;else{if(!(x=c[s]))throw'Error: "'+s+'" '+t+" not defined";x=x.prototype}if("function"==typeof y)(w=c[r])?w.prototype=f(w.prototype,y(p(w.prototype))):((w=c[r]=function(t){this.init&&this.init(t)}).prototype=v(x),w.prototype=f(w.prototype,y(x,w.prototype))),w.prototype.type=t,w.prototype.name=r;else if(_=y||{},!(w=c[r]))throw'Error: "'+r+'" '+t+" not defined";return _?new w(_):void 0};return j.mixin=i,j};s.util.indexOf=function(t,r){for(var s=0,c=t.length;c>s;){if(c--,t[s]===r)return s;if(t[c]===r)return c;s++}return-1},s.util.clearArray=function(t){for(var r=t.length;r--;)t.pop();return t},s.util.throttle=function(t,r,s){var c,u,p=!1,g=function(){clearTimeout(c),p?(p=!1,c=setTimeout(g,r),t.apply(s,u)):c=!1};return s=s||null,function(){p=!0,u=arguments,c||g()}};var e=function(t,r){return s.util.isPlainObject(r)?s.util.extend({},t,r,e):void 0!==r?r:t};return s.util.options=function(t,r){var c,u={},p=[];return(c=function(t,c){s.util.extend(r,t,c?e:null);for(var u=0,v=p.length;v>u;++u)p[u](r);return r}).defaults=function(t,c){return s.util.extend(u,t,c?e:null),s.util.defaults(r,u,c?e:null),u},c.onChange=function(t){p.push(t)},r=r||c,c.defaults(t),c},s.util.pairHash=function(t,r){return(0|(t|=0))==(0|(r|=0))?-1:0|((0|t)>(0|r)?t<<16|65535&r:r<<16|65535&t)},s.util.bind=Function.prototype.bind?function(t,r,s){return s=Array.prototype.slice.call(arguments,1),Function.prototype.bind.apply(t,s)}:function(t,r,s){return s=Array.prototype.slice.call(arguments,2),function(){return t.apply(r,s.concat(Array.prototype.slice.call(arguments)))}},s.util.find=function(t,r){var s,c,u=t.length;for(s=0;u>s;s++)if(r(c=t[s],s,t))return c},s.util.filter=function(t,r){var s,c,u=t.length,p=[];for(s=0;u>s;s++)r(c=t[s],s,t)&&p.push(c);return p},function(){function a(t){s.util.clearArray(t),y.length<w&&y.push(t)}function d(){return _.pop()||{array:null,cache:null,criteria:null,false:!1,index:0,null:!1,number:null,object:null,push:null,string:null,true:!1,undefined:!1,value:null}}function f(t,r){var c=typeof r;if(t=t.cache,"boolean"===c||null==r)return t[r]?0:-1;"number"!==c&&"string"!==c&&(c="object");var u="number"===c?r:x+r;return t=(t=t[c])&&t[u],"object"===c?t&&s.util.indexOf(t,r)>-1?0:-1:t?0:-1}function g(t){var r=this.cache,s=typeof t;if("boolean"===s||null==t)r[t]=!0;else{"number"!==s&&"string"!==s&&(s="object");var c="number"===s?t:x+t,u=r[s]||(r[s]={});"object"===s?(u[c]||(u[c]=[])).push(t):u[c]=!0}}function h(t){var r=-1,s=t.length,c=t[0],u=t[s/2|0],p=t[s-1];if(c&&"object"==typeof c&&u&&"object"==typeof u&&p&&"object"==typeof p)return!1;var v=d();v.false=v.null=v.true=v.undefined=!1;var y=d();for(y.array=t,y.cache=v,y.push=g;++r<s;)y.push(t[r]);return y}function i(t,r){return t+Math.floor(Math.random()*(r-t+1))}function j(t){return"function"==typeof t}function l(t){var s,c;if(!t||u.call(t)!==r||j(s=t.constructor)&&!(s instanceof s))return!1;for(var v in t)c=v;return void 0===c||p.call(t,c)}function m(t,r,c){var u=-1,p=s.util.indexOf,x=t?t.length:0,P=[],A=!r&&x>=v&&p===s.util.indexOf,C=c||A?function e(){return y.pop()||[]}():P;A&&(p=f,C=h(C));for(;++u<x;){var I=t[u],T=c?c(I,u,t):I;(r?!u||C[C.length-1]!==T:p(C,T)<0)&&((c||A)&&C.push(T),P.push(I))}return A?(a(C.array),function b(t){var r=t.cache;r&&b(r),t.array=t.cache=t.criteria=t.object=t.number=t.string=t.value=null,_.length<w&&_.push(t)}(C)):c&&a(C),P}var t={boolean:!1,function:!0,object:!0,number:!1,string:!1,undefined:!1},o=function(t){return t},r="[object Object]",c=Object.keys,u=Object.prototype.toString,p=Object.prototype.hasOwnProperty,v=75,y=[],_=[],w=40,x=+new Date+"",P=c?function(t){return s.util.isObject(t)?c(t):[]}:function(r){var s,c=r,u=[];if(!c)return u;if(!t[typeof r])return u;for(s in c)p.call(c,s)&&u.push(s);return u},A=0;s.util.uniqueId=function(t){return""+(t||"")+ ++A},s.util.shuffle=function(t){var r,s,c,u,p=-1,v=t?t.length:0,y=Array("number"==typeof v?v:0);for(r=0,s=t.length;s>r;r++)c=t[r],u=i(0,++p),y[p]=y[u],y[u]=c;return y},s.util.isObject=function(r){return!(!r||!t[typeof r])},s.util.isFunction=j,s.util.isArray=Array.isArray||function(t){return t&&"object"==typeof t&&"number"==typeof t.length&&"[object Array]"===u.call(t)||!1};var C=RegExp("^"+String(u).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/toString| for [^\]]+/g,".*?")+"$");s.util.isPlainObject=Object.getPrototypeOf?function(t){if(!t||u.call(t)!==r)return!1;var s=t.valueOf,c=function k(t){return"function"==typeof t&&C.test(t)}(s)&&(c=Object.getPrototypeOf(s))&&Object.getPrototypeOf(c);return c?t===c||Object.getPrototypeOf(t)===c:l(t)}:l,s.util.uniq=function(t,r,s){return"boolean"!=typeof r&&null!=r&&(s=r,r=!1),m(t,r,s)};s.util.extend=function(r,s,c){var u,p=r,v=p;if(!p)return v;var y,_=arguments,w=0,x="number"==typeof c?2:_.length;for(x>2&&"function"==typeof _[x-1]&&(y=_[--x]);++w<x;)if((p=_[w])&&t[typeof p])for(var A=-1,C=t[typeof p]&&P(p),I=C?C.length:0;++A<I;)v[u=C[A]]=y?y(v[u],p[u]):p[u];return v},s.util.defaults=function(r,s,c){var u,p=r,v=p;if(!p)return v;for(var y=arguments,_=0,w="number"==typeof c?2:y.length;++_<w;)if((p=y[_])&&t[typeof p])for(var x=-1,A=t[typeof p]&&P(p),C=A?A.length:0;++x<C;)void 0===v[u=A[x]]&&(v[u]=p[u]);return v},s.util.sortedIndex=function(t,r,s){var c=0,u=t?t.length:c;for(r=(s=s||o)(r);u>c;){var p=c+u>>>1;s(t[p])<r?c=p+1:u=p}return c}}(),s.scratchpad=function(){var t,r,c=[],u=0,p=0;return(t=function(){if(this._active=!1,this._indexArr=[],++u>=r.maxScratches)throw"Error: Too many scratchpads created. (Did you forget to call .done()?)"}).prototype={done:function(t){this._active=!1;for(var r=0;p>r;++r)this[r]=0;return c.push(this),t}},(r=function k(r){if(r)return k.fn(r);var s=c.pop()||new t;return s._active=!0,s}).maxScratches=100,r.maxIndex=20,r.fn=function(r){for(var s=[],u=0,p=r.length;p>u;u++)s.push(u);return s="a"+s.join(",a"),new Function("fn, scratches, Scratch","return function("+s+"){ var scratch = scratches.pop() || new Scratch( scratches );scratch._active = true;return scratch.done( fn(scratch, "+s+") );};")(r,c,t)},r.register=function(s,c,u){var v=t.prototype,y=p++,_="_"+s+"Stack",w=u&&u.useFactory;if(s in v)throw"Error: Object is already registered.";t.prototype[s]=function(){var t=this[_]||(this[_]=[]),s=0|this[y];if(this[y]=s+1,!this._active)throw"Error: Scratchpad used after .done() called. (Could it be unintentionally scoped?)";if(s>=r.maxIndex)throw"Error: Scratchpad usage space out of bounds. (Did you forget to call .done()?)";return t[s]||(t[s]=w?c():new c)}},r.register("vector",s.vector),r.register("transform",s.transform),r}(),function(){function a(t){return t._priority_}s.scratchpad.register("event",(function(){return{}}),{useFactory:!0});var t=function e(){return this instanceof e?void 0:new e};t.prototype={on:function(t,r,c,u){var p,v,y;if(this._topics=this._topics||(this._topics={}),s.util.isObject(t)){for(var _ in t)this.on(_,t[_],r,c);return this}return p=this._topics[t]||(this._topics[t]=[]),v=r,s.util.isObject(c)?((r=s.util.bind(r,c))._bindfn_=v,r._one_=v._one_,r._scope_=c):void 0===u&&(u=c),r._priority_=void 0===u?1:u,y=s.util.sortedIndex(p,r,a),p.splice(y,0,r),this},off:function(t,r,c){var u,p;if(!this._topics)return this;if(!0===t)return this._topics={},this;if(s.util.isObject(t)){for(var v in t)this.off(v,t[v]);return this}if(!(u=this._topics[t]))return this;if(!0===r)return this._topics[t]=[],this;for(var y=0,_=u.length;_>y;y++)if(!((p=u[y])._bindfn_!==r&&p!==r||c&&p._scope_!==c)){u.splice(y,1);break}return this},emit:function(t,r){if(!this._topics)return this;var c,u,p=this._topics[t],v=p&&p.length,y=s.scratchpad();if(!v)return y.done(this);for((u=y.event()).topic=t,u.handler=c;v--;)(c=p[v])(r,u),c._one_&&p.splice(v,1);return y.done(this)},one:function(t,r,c){if(s.util.isObject(t)){for(var u in t)this.one(u,t[u],r,c);return this}return r._one_=!0,this.on(t,r,c),this}},s.util.pubsub=t}(),function(t){function b(){return u&&u.now?u.now()+u.timing.navigationStart:Date.now()}var r=!0,c=s.util.pubsub(),u=t.performance;t.requestAnimationFrame?function d(){var s;t.requestAnimationFrame(d),r&&((s=b())&&c.emit("tick",s))}():r=!1,s.util.ticker={now:b,start:function e(){return r=!0,this},stop:function f(){return r=!1,this},on:function g(t){return c.on("tick",t),this},off:function h(t){return c.off("tick",t),this},isActive:function i(){return!!r}}}(this),function(){var a=function(){return!0},t=s.util.indexOf,d=function(t,r){return function(s){return t(s[r])}},e=function(r,c){return function(u){u=c?u[c]:u;var p,v=0;if(s.util.isArray(u)){if(s.util.isArray(r)){if((p=u.length)!==r.length)return!1;for(;p>v;){if(p--,-1===t(r,u[v])||-1===t(r,u[p]))return!1;v++}return!0}return t(u,r)>-1}return u===r}},g=function(r,c){return function(u){u=c?u[c]:u;var p,v=0;if(s.util.isArray(u)){for(p=u.length;p>v;){if(p--,t(r,u[v])>-1||t(r,u[p])>-1)return!0;v++}return!1}return t(r,u)>-1}},j=function(t){return t.next?function(r){for(var s=t;s;){if(!s(r))return!1;s=s.next}return!0}:t},r={$eq:e,$ne:function(t,r){var s=e(t,r);return function(t){return!s(t)}},$in:g,$nin:function(t,r){var s=g(t,r);return function(t){return!s(t)}},$at:function(t){return t=new s.vector(t),function(r){var c=r.aabb();return s.aabb.contains(c,t)}}};s.query=function n(t,c){var u,p,v,y,_,w;if(c){if("$or"===c||"$and"===c){for(u=0,p=t.length;p>u;++u)w=n(t[u]),_=_?_.next=w:y=w;return"$or"===c?function(t){return t.next?function(r){for(var s=t;s;){if(s(r))return!0;s=s.next}return!1}:t}(y):j(y)}if(u=r[c])return u(t);throw"Unknown query operation: "+c}for(u in t)v=t[u],w="$"===u[0]?n(v,u):s.util.isPlainObject(v)?d(n(v),u):e(v,u),_=_?_.next=w:y=w;return j(y||a)}}(),function(){var t={priority:0};s.behavior=c("behavior",{init:function(r){this.options=s.util.options(t),this.options(r)},applyTo:function(t){return this._targets=!0===t?null:s.util.uniq(t),this},getTargets:function(){return this._targets||(this._world?this._world._bodies:[])},setWorld:function(t){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=t,this.connect&&t&&this.connect(t),this},connect:function(t){this.behave&&t.on("integrate:positions",this.behave,this,this.options.priority)},disconnect:function(t){this.behave&&t.off("integrate:positions",this.behave,this)},behave:null})}(),function(){var t={hidden:!1,treatment:"dynamic",mass:1,restitution:1,cof:.8,view:null},r=1;Math.PI,(s.body=c("body",{init:function(c){var u=this,p=s.vector;if(this.options=s.util.options(t,this),this.options.onChange((function(t){u.offset=new p(t.offset)})),this.options(c),this.state={pos:new p(this.x,this.y),vel:new p(this.vx,this.vy),acc:new p,angular:{pos:this.angle||0,vel:this.angularVelocity||0,acc:0},old:{pos:new p,vel:new p,acc:new p,angular:{pos:0,vel:0,acc:0}}},this._sleepAngPosMean=0,this._sleepAngPosVariance=0,this._sleepPosMean=new p,this._sleepPosVariance=new p,this._sleepMeanK=0,delete this.x,delete this.y,delete this.vx,delete this.vy,delete this.angle,delete this.angularVelocity,0===this.mass)throw"Error: Bodies must have non-zero mass";this.uid=r++,this.geometry=s.geometry("point")},sleep:function(t){return!0===t?this.asleep=!0:!1===t?(this.asleep=!1,this._sleepMeanK=0,this._sleepAngPosMean=0,this._sleepAngPosVariance=0,this._sleepPosMean.zero(),this._sleepPosVariance.zero(),this.sleepIdleTime=0):t&&!this.asleep&&this.sleepCheck(t),this.asleep},sleepCheck:function(t){var r=this._world&&this._world.options;if(!(this.sleepDisabled||r&&r.sleepDisabled)){var c,u,p,v,y,_,w=s.scratchpad();if(w.vector(),w.vector(),t=t||0,v=this.geometry.aabb(),p=Math.max(v.hw,v.hh),this.asleep&&(u=this.state.vel.norm()+Math.abs(p*this.state.angular.vel))>=(c=this.sleepSpeedLimit||r&&r.sleepSpeedLimit||0))return this.sleep(!1),w.done();this._sleepMeanK++,y=this._sleepMeanK>1?1/(this._sleepMeanK-1):0,s.statistics.pushRunningVectorAvg(this.state.pos,this._sleepMeanK,this._sleepPosMean,this._sleepPosVariance),_=s.statistics.pushRunningAvg(Math.sin(this.state.angular.pos),this._sleepMeanK,this._sleepAngPosMean,this._sleepAngPosVariance),this._sleepAngPosMean=_[0],this._sleepAngPosVariance=_[1],u=this._sleepPosVariance.norm()+Math.abs(p*Math.asin(_[1])),u*=y,(c=this.sleepVarianceLimit||r&&r.sleepVarianceLimit||0)>=u?(c=this.sleepTimeLimit||r&&r.sleepTimeLimit||0,this.sleepIdleTime=(this.sleepIdleTime||0)+t,this.sleepIdleTime>c&&(this.asleep=!0)):this.sleep(!1),w.done()}},setWorld:function(t){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=t,this.connect&&t&&this.connect(t),this},accelerate:function(t){return"dynamic"===this.treatment&&this.state.acc.vadd(t),this},applyForce:function(t,r){if("dynamic"!==this.treatment)return this;var c=s.scratchpad(),u=c.vector();return r&&this.moi&&(this.state,u.clone(r),this.state.angular.acc-=u.cross(t)/this.moi),this.accelerate(u.clone(t).mult(1/this.mass)),c.done(),this},getGlobalOffset:function(t){return(t=t||new s.vector).clone(this.offset).rotate(this.state.angular.pos),t},aabb:function(){var t=this.state.angular.pos,r=s.scratchpad(),c=r.vector(),u=this.geometry.aabb(t);return this.getGlobalOffset(c),u.x+=this.state.pos._[0]+c._[0],u.y+=this.state.pos._[1]+c._[1],r.done(u)},toBodyCoords:function(t){return t.vsub(this.state.pos).rotate(-this.state.angular.pos)},toWorldCoords:function(t){return t.rotate(this.state.angular.pos).vadd(this.state.pos)},recalc:function(){return this}})).getCOM=function(t,r){var c,u,p,v=t&&t.length,y=0;if(r=r||new s.vector,!v)return r.zero();if(1===v)return r.clone(t[0].state.pos);for(r.zero(),p=0;v>p;p++)u=(c=t[p]).state.pos,r.add(u._[0]*c.mass,u._[1]*c.mass),y+=c.mass;return r.mult(1/y),r}}(),(s.geometry=c("geometry",{init:function(t){this.options=s.util.options(),this.options(t),this._aabb=new s.aabb},aabb:function(){return s.aabb.clone(this._aabb)},getFarthestHullPoint:function(t,r){return(r=r||new s.vector).set(0,0)},getFarthestCorePoint:function(t,r){return(r=r||new s.vector).set(0,0)}})).regularPolygonVertices=function(t,r){var s,c=[],u=2*Math.PI/t,p=0;for(s=0;t>s;s++)c.push({x:r*Math.cos(p),y:r*Math.sin(p)}),p+=u;return c},s.geometry.isPolygonConvex=function(t){var r=s.scratchpad(),c=r.vector(),u=r.vector(),p=r.vector(),v=!0,y=!1,_=t.length;if(!t||!_)return!1;if(3>_)return r.done(),v;c.clone(t[0]).vsub(p.clone(t[_-1]));for(var w=1;_>=w;++w){if(u.clone(t[w%_]).vsub(p.clone(t[(w-1)%_])),!1===y)y=c.cross(u);else if(y>0^c.cross(u)>0){v=!1;break}u.swap(c)}return r.done(),v},s.geometry.getPolygonMOI=function(t){var r,c=s.scratchpad(),u=c.vector(),p=c.vector(),v=0,y=0,_=t.length;if(2>_)return c.done(),0;if(2===_)return r=p.clone(t[1]).distSq(u.clone(t[0])),c.done(),r/12;u.clone(t[0]);for(var w=1;_>w;++w)p.clone(t[w]),v+=(r=Math.abs(p.cross(u)))*(p.normSq()+p.dot(u)+u.normSq()),y+=r,u.swap(p);return c.done(),v/(6*y)},s.geometry.isPointInPolygon=function(t,r){var c=s.scratchpad(),u=c.vector().clone(t),p=c.vector(),v=c.vector(),y=0,_=r.length;if(2>_)return y=u.equals(p.clone(r[0])),c.done(),y;if(2===_)return y=u.angle(p.clone(r[0])),y+=u.angle(p.clone(r[1])),c.done(),Math.abs(y)===Math.PI;p.clone(r[0]).vsub(u);for(var w=1;_>=w;++w)v.clone(r[w%_]).vsub(u),y+=v.angle(p),p.swap(v);return c.done(),Math.abs(y)>1e-6},s.geometry.getPolygonArea=function(t){var r=s.scratchpad(),c=r.vector(),u=r.vector(),p=0,v=t.length;if(3>v)return r.done(),0;c.clone(t[v-1]);for(var y=0;v>y;++y)u.clone(t[y]),p+=c.cross(u),c.swap(u);return r.done(),p/2},s.geometry.getPolygonCentroid=function(t){var r,c=s.scratchpad(),u=c.vector(),p=c.vector(),v=new s.vector,y=t.length;if(2>y)return c.done(),new s.vector(t[0]);if(2===y)return c.done(),new s.vector((t[1].x+t[0].x)/2,(t[1].y+t[0].y)/2);u.clone(t[y-1]);for(var _=0;y>_;++_)p.clone(t[_]),r=u.cross(p),u.vadd(p).mult(r),v.vadd(u),u.swap(p);return r=1/(6*s.geometry.getPolygonArea(t)),c.done(),v.mult(r)},s.geometry.nearestPointOnLine=function(t,r,c){var u,p,v=s.scratchpad(),y=v.vector().clone(t),_=v.vector().clone(r).vsub(y),w=v.vector().clone(c).vsub(y).vsub(_);return w.equals(s.vector.zero)?(v.done(),new s.vector(r)):0>=(p=1-(u=-w.dot(_)/w.normSq()))?(v.done(),new s.vector(c)):0>=u?(v.done(),new s.vector(r)):(y=new s.vector(c).mult(u).vadd(_.clone(r).mult(p)),v.done(),y)},function(){var t={drag:0};s.integrator=c("integrator",{init:function(r){this.options=s.util.options(t),this.options(r)},setWorld:function(t){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=t,this.connect&&t&&this.connect(t),this},integrate:function(t,r){var s=this._world;return this.integrateVelocities(t,r),s&&s.emit("integrate:velocities",{bodies:t,dt:r}),this.integratePositions(t,r),s&&s.emit("integrate:positions",{bodies:t,dt:r}),this},connect:null,disconnect:null,integrateVelocities:function(){throw"The integrator.integrateVelocities() method must be overriden"},integratePositions:function(){throw"The integrator.integratePositions() method must be overriden"}})}(),function(){var u={meta:!1,metaRefresh:200,width:600,height:600,autoResize:!0};s.renderer=c("renderer",{init:function(c){var p=this,v="string"==typeof c.el?r.getElementById(c.el):c.el;this.options=s.util.options(u),this.options(c),this.el=v||r.body,this.container=v&&v.parentNode?v.parentNode:r.body,this.drawMeta=s.util.throttle(s.util.bind(this.drawMeta,this),this.options.metaRefresh),t.addEventListener("resize",s.util.throttle((function(){p.options.autoResize&&p.resize()})),100)},resize:function(t,r){void 0===t&&void 0===r&&(t=this.container.offsetWidth,r=this.container.offsetHeight),this.width=t||0,this.height=r||0},setWorld:function(t){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=t,this.connect&&t&&this.connect(t),this},render:function(t,r){var s,c;this.beforeRender&&this.beforeRender(),this._world.emit("beforeRender",{renderer:this,bodies:t,meta:r}),this.options.meta&&this.drawMeta(r),this._interpolateTime=r.interpolateTime;for(var u=0,p=t.length;p>u;++u)c=(s=t[u]).view||(s.view=this.createView(s.geometry,s.styles)),s.hidden||this.drawBody(s,c);return this},createView:function(){throw"You must override the renderer.createView() method."},drawMeta:function(){throw"You must override the renderer.drawMeta() method."},drawBody:function(){throw"You must override the renderer.drawBody() method."}})}(),function(){var t=function e(t,r,s){for(var c,u,g=function(){return e(t,r,s)};c=t.shift();)if((u=c.apply(r,s))&&u.then)return u.then(g)},r={timestep:6,maxIPF:4,webworker:!1,integrator:"verlet",sleepDisabled:!1,sleepSpeedLimit:.05,sleepVarianceLimit:.02,sleepTimeLimit:500},c=function f(t,r){return this instanceof f?void this.init(t,r):new f(t,r)};c.prototype=s.util.extend({},s.util.pubsub.prototype,{init:function(c,u){var p=this;(s.util.isFunction(c)||s.util.isArray(c))&&(u=c,c={}),this._meta={fps:0,ipf:0},this._bodies=[],this._behaviors=[],this._integrator=null,this._renderer=null,this._paused=!1,this._warp=1,this._time=0,this.options=s.util.options(r),this.options.onChange((function(t){p.timestep(t.timestep)})),this.options(c),this.add(s.integrator(this.options.integrator)),s.util.isFunction(u)?t([u],this,[this,s]):s.util.isArray(u)&&t(u,this,[this,s])},options:null,add:function(t){var r=0,c=t&&t.length||0,u=s.util.isArray(t)?t[0]:t;if(!u)return this;do{switch(u.type){case"behavior":this.addBehavior(u);break;case"integrator":this.integrator(u);break;case"renderer":this.renderer(u);break;case"body":this.addBody(u);break;default:throw'Error: failed to add item of unknown type "'+u.type+'" to world'}}while(++r<c&&(u=t[r]));return this},remove:function(t){var r=0,c=t&&t.length||0,u=s.util.isArray(t)?t[0]:t;if(!u)return this;do{switch(u.type){case"behavior":this.removeBehavior(u);break;case"integrator":u===this._integrator&&this.integrator(null);break;case"renderer":u===this._renderer&&this.renderer(null);break;case"body":this.removeBody(u);break;default:throw'Error: failed to remove item of unknown type "'+u.type+'" from world'}}while(++r<c&&(u=t[r]));return this},has:function(t){var r;if(!t)return!1;switch(t.type){case"behavior":r=this._behaviors;break;case"integrator":return this._integrator===t;case"renderer":return this._renderer===t;case"body":r=this._bodies;break;default:throw'Error: unknown type "'+t.type+'"'}return s.util.indexOf(r,t)>-1},integrator:function(t){return void 0===t?this._integrator:(this._integrator===t||(this._integrator&&(this._integrator.setWorld(null),this.emit("remove:integrator",{integrator:this._integrator})),t&&(this._integrator=t,this._integrator.setWorld(this),this.emit("add:integrator",{integrator:this._integrator}))),this)},renderer:function(t){return void 0===t?this._renderer:(this._renderer===t||(this._renderer&&(this._renderer.setWorld(null),this.emit("remove:renderer",{renderer:this._renderer})),t&&(this._renderer=t,this._renderer.setWorld(this),this.emit("add:renderer",{renderer:this._renderer}))),this)},timestep:function(t){return t?(this._dt=+t.toPrecision(4),this._maxJump=t*this.options.maxIPF,this):this._dt},wakeUpAll:function(){var t=0,r=this._bodies.length;for(t=0;r>t;t++)this._bodies[t].sleep(!1)},addBehavior:function(t){return this.has(t)||(t.setWorld(this),this._behaviors.push(t),this.emit("add:behavior",{behavior:t})),this},getBehaviors:function(){return[].concat(this._behaviors)},removeBehavior:function(t){var r=this._behaviors;if(t)for(var s=0,c=r.length;c>s;++s)if(t===r[s]){r.splice(s,1),t.setWorld(null),this.emit("remove:behavior",{behavior:t});break}return this},addBody:function(t){return this.has(t)||(t.setWorld(this),this._bodies.push(t),this.emit("add:body",{body:t})),this},getBodies:function(){return[].concat(this._bodies)},removeBody:function(t){var r=this._bodies;if(t)for(var s=0,c=r.length;c>s;++s)if(t===r[s]){r.splice(s,1),t.setWorld(null),this.emit("remove:body",{body:t});break}return this},findOne:function(t){var r="function"==typeof t?t:s.query(t);return s.util.find(this._bodies,r)||!1},find:function(t){var r="function"==typeof t?t:s.query(t);return s.util.filter(this._bodies,r)},iterate:function(t){this._integrator.integrate(this._bodies,t)},step:function(t){var r,c,u,p=this._time,v=this._warp,y=1/v,_=this._dt,w=_*y,x=this._maxJump*y,P=this._meta;if(this._paused||void 0===this._animTime)return this._animTime=t||this._animTime||s.util.ticker.now(),this._paused||this.emit("step",P),this;if((r=(t=t||this._animTime+w)-this._animTime)>x&&(this._animTime=t-x,r=x),u=p+(c=r*v)-_,this.emit("beforeStep"),u>=p)for(;u>=p;)p+=_,this._animTime+=w,this._time=p,this.iterate(_);return P.fps=1e3/(t-this._lastTime),P.ipf=(c/_).toFixed(2),P.interpolateTime=_+u-p,this._lastTime=t,this.emit("step",P),this},warp:function(t){return void 0===t?this._warp:(this._warp=t||1,this)},render:function(){if(!this._renderer)throw"No renderer added to world";return this._renderer.render(this._bodies,this._meta),this.emit("render",{bodies:this._bodies,meta:this._meta,renderer:this._renderer}),this},pause:function(){return this._paused=!0,this.emit("pause"),this},unpause:function(){return this._paused=!1,this.emit("unpause"),this},isPaused:function(){return!!this._paused},destroy:function(){var t=this;t.pause(),this.emit("destroy"),t.off(!0),t.remove(t.getBodies()),t.remove(t.getBehaviors()),t.integrator(null),t.renderer(null)}}),s.world=c}(),s.integrator("verlet",(function(t){return s.body.mixin({started:function(t){return void 0!==t&&(this._started=!0),!!this._started}}),{init:function(r){t.init.call(this,r)},integrateVelocities:function(t,r){for(var s,c=r*r,u=1-this.options.drag,p=null,v=.5*(c+r*(this.prevDt||r)),y=0,_=t.length;_>y;++y)s=(p=t[y]).state,"static"===p.treatment||p.sleep(r)?(s.vel.zero(),s.acc.zero(),s.angular.vel=0,s.angular.acc=0):(s.vel.equals(s.old.vel)&&p.started()?s.vel.clone(s.pos).vsub(s.old.pos):(s.old.pos.clone(s.pos).vsub(s.vel),s.vel.mult(r)),u&&s.vel.mult(u),s.vel.vadd(s.acc.mult(v)),s.vel.mult(1/r),s.old.vel.clone(s.vel),s.acc.zero(),s.angular.vel===s.old.angular.vel&&p.started()?s.angular.vel=s.angular.pos-s.old.angular.pos:(s.old.angular.pos=s.angular.pos-s.angular.vel,s.angular.vel*=r),s.angular.vel+=s.angular.acc*v,s.angular.vel/=r,s.old.angular.vel=s.angular.vel,s.angular.acc=0,p.started(!0))},integratePositions:function(t,r){for(var s,c=null,u=r/(this.prevDt||r),p=0,v=t.length;v>p;++p)s=(c=t[p]).state,"static"===c.treatment||c.sleep()||(s.vel.mult(r*u),s.old.pos.clone(s.pos),s.pos.vadd(s.vel),s.vel.mult(1/(r*u)),s.old.vel.clone(s.vel),s.angular.vel*=r*u,s.old.angular.pos=s.angular.pos,s.angular.pos+=s.angular.vel,s.angular.vel/=r*u,s.old.angular.vel=s.angular.vel);this.prevDt=r}}})),s.geometry("point",(function(){})),s.body("point",(function(t){return{init:function(r){t.init.call(this,r),this.moi=0}}})),s.geometry("circle",(function(t){var r={radius:1};return{init:function(c){t.init.call(this,c),this.options.defaults(r),this.options.onChange((function(t){this.radius=t.radius})),this.options(c),this._aabb=s.aabb(),this.radius=this.options.radius},aabb:function(){var t=this.radius;return this._aabb.hw!==t&&(this._aabb=s.aabb(-t,-t,t,t)),s.aabb.clone(this._aabb)},getFarthestHullPoint:function(t,r){return(r=r||new s.vector).clone(t).normalize().mult(this.radius)},getFarthestCorePoint:function(t,r,c){return(r=r||new s.vector).clone(t).normalize().mult(this.radius-c)}}})),s.geometry("compound",(function(t){var r={};return{init:function(s){t.init.call(this,s),this.options.defaults(r),this.options(s),this.children=[]},addChild:function(t,r,c){return this._aabb=null,this.children.push({g:t,pos:new s.vector(r),angle:c}),this},clear:function(){return this._aabb=null,this.children=[],this},aabb:function(t){if(!t&&this._aabb)return s.aabb.clone(this._aabb);var r,c,u,p=s.scratchpad(),v=s.vector();t=t||0;for(var y=0,_=this.children.length;_>y;y++)r=(c=this.children[y]).g.aabb(t+c.angle),v.clone(c.pos),t&&v.rotate(t),r.x+=v._[0],r.y+=v._[1],u=u?s.aabb.union(u,r,!0):r;return t||(this._aabb=s.aabb.clone(u)),p.done(u)},getFarthestHullPoint:function(t,r){var c,u,p=this.children.length,v=s.scratchpad(),y=v.vector(),_=0,w=0;for(r=r||new s.vector,u=0;p>u;u++)(c=this.children[u]).g.getFarthestHullPoint(t.rotate(-c.angle),y),(_=y.rotate(c.angle).vadd(c.pos).proj(t.rotate(c.angle)))>w&&(w=_,r.swap(y));return v.done(r)},getFarthestCorePoint:function(t,r,c){var u,p,v=this.children.length,y=s.scratchpad(),_=y.vector(),w=0,x=0;for(r=r||new s.vector,p=0;v>p;p++)(u=this.children[p]).g.getFarthestCorePoint(t.rotate(-u.angle),_,c),(w=_.rotate(u.angle).vadd(u.pos).proj(t.rotate(u.angle)))>x&&(x=w,r.swap(_));return y.done(r)}}})),s.geometry("convex-polygon",(function(t){var r={};return{init:function(s){var c=this;t.init.call(this,s),this.options.defaults(r),this.options.onChange((function(t){c.setVertices(t.vertices||[])})),this.options(s),c.setVertices(this.options.vertices||[])},setVertices:function(t){var r=s.scratchpad(),c=r.transform(),u=this.vertices=[];if(!s.geometry.isPolygonConvex(t))throw"Error: The vertices specified do not match that of a _convex_ polygon.";c.setRotation(0),c.setTranslation(s.geometry.getPolygonCentroid(t).negate());for(var p=0,v=t.length;v>p;++p)u.push(new s.vector(t[p]).translate(c));return this._area=s.geometry.getPolygonArea(u),this._aabb=!1,r.done(this)},aabb:function(t){if(!t&&this._aabb)return s.aabb.clone(this._aabb);var r,c=s.scratchpad(),u=c.vector(),p=c.transform().setRotation(t||0),v=c.vector().set(1,0).rotateInv(p),y=c.vector().set(0,1).rotateInv(p),_=this.getFarthestHullPoint(v,u).proj(v),w=-this.getFarthestHullPoint(v.negate(),u).proj(v),x=this.getFarthestHullPoint(y,u).proj(y),P=-this.getFarthestHullPoint(y.negate(),u).proj(y);return r=s.aabb(w,P,_,x),t||(this._aabb=s.aabb.clone(r)),c.done(),r},getFarthestHullPoint:function(t,r,c){var u,p,v,y=this.vertices,_=y.length,w=2;if(r=r||new s.vector,2>_)return c&&(c.idx=0),r.clone(y[0]);if(p=y[0].dot(t),u=y[1].dot(t),2===_)return v=u>=p?1:0,c&&(c.idx=v),r.clone(y[v]);if(u>=p){for(;_>w&&u>=p;)p=u,u=y[w].dot(t),w++;return u>=p&&w++,v=w-2,c&&(c.idx=w-2),r.clone(y[v])}for(w=_;w>1&&p>=u;)u=p,p=y[--w].dot(t);return v=(w+1)%_,c&&(c.idx=v),r.clone(y[v])},getFarthestCorePoint:function(t,r,c){var u,p=s.scratchpad(),v=p.vector(),y=p.vector(),_=this.vertices,w=_.length,x=this._area>0,P={};return r=this.getFarthestHullPoint(t,r,P),v.clone(_[(P.idx+1)%w]).vsub(r).normalize().perp(x),y.clone(_[(P.idx-1+w)%w]).vsub(r).normalize().perp(!x),u=c/(1+v.dot(y)),r.vadd(v.vadd(y).mult(u)),p.done(),r}}})),s.geometry("rectangle",(function(t){var r={};return{init:function(s){var c=this;t.init.call(this,s),this.options.defaults(r),this.options.onChange((function(){c.width=c.options.width||1,c.height=c.options.height||1})),this.options(s)},aabb:function(t){if(!t)return s.aabb(this.width,this.height);var r=s.scratchpad(),c=r.vector(),u=r.transform().setRotation(t||0),p=r.vector().set(1,0).rotateInv(u),v=r.vector().set(0,1).rotateInv(u),y=this.getFarthestHullPoint(p,c).proj(p),_=-this.getFarthestHullPoint(p.negate(),c).proj(p),w=this.getFarthestHullPoint(v,c).proj(v),x=-this.getFarthestHullPoint(v.negate(),c).proj(v);return r.done(),s.aabb(_,x,y,w)},getFarthestHullPoint:function(t,r){r=r||new s.vector;var c=t.x,u=t.y;return c=0===c?0:0>c?.5*-this.width:.5*this.width,u=0===u?0:0>u?.5*-this.height:.5*this.height,r.set(c,u)},getFarthestCorePoint:function(t,r,s){var c,u;return c=(r=this.getFarthestHullPoint(t,r)).x,u=r.y,r.x=0===c?0:0>c?c+s:c-s,r.y=0===u?0:0>u?u+s:u-s,r}}})),s.body("circle",(function(t){var r={radius:1};return{init:function(c){t.init.call(this,c),c=s.util.extend({},r,c),this.geometry=s.geometry("circle",{radius:c.radius}),this.recalc()},recalc:function(){t.recalc.call(this),this.moi=this.mass*this.geometry.radius*this.geometry.radius/2}}})),s.body("compound",(function(t){return{init:function(r){t.init.call(this,r),this.mass=0,this.moi=0,this.children=[],this.geometry=s.geometry("compound"),this.addChildren(r.children)},connect:function(){if(this.mass<=0)throw"Can not add empty compound body to world."},addChild:function(t){return this.addChildren([t]),this},addChildren:function(t){var r,c,u,p=this,v=s.scratchpad(),y=v.vector().zero(),_=t&&t.length,w=0;if(!_)return v.done(this);for(u=0;_>u;u++)(r=t[u])._world&&r._world.remove(r),this.children.push(r),this.geometry.addChild(r.geometry,new s.vector(r.offset).rotate(r.state.angular.pos).vadd(r.state.pos),r.state.angular.pos),c=r.state.pos,y.add(c._[0]*r.mass,c._[1]*r.mass),w+=r.mass;return this.mass+=w,y.mult(1/this.mass),this.offset.vsub(y),this._world&&this._world.one("render",(function(){p.view=null})),this.recalc(),v.done(this)},clear:function(){return this._aabb=null,this.moi=0,this.mass=0,this.offset.zero(),this.children=[],this.geometry.clear(),this},refreshGeometry:function(){this.geometry.clear();for(var t,r=0,c=this.children.length;c>r;r++)t=this.children[r],this.geometry.addChild(t.geometry,new s.vector(t.state.pos).vadd(t.offset),t.state.angular.pos);return this},recalc:function(){t.recalc.call(this);for(var r,s=0,c=0,u=this.children.length;u>c;c++)(r=this.children[c]).recalc(),s+=r.moi+r.mass*r.state.pos.normSq();return this.moi=s,this}}})),s.body("convex-polygon",(function(t){var r={};return{init:function(c){t.init.call(this,c),c=s.util.extend({},r,c),this.geometry=s.geometry("convex-polygon",{vertices:c.vertices}),this.recalc()},recalc:function(){t.recalc.call(this),this.moi=s.geometry.getPolygonMOI(this.geometry.vertices)}}})),s.body("rectangle",(function(t){var r={};return{init:function(c){t.init.call(this,c),c=s.util.extend({},r,c),this.geometry=s.geometry("rectangle",{width:c.width,height:c.height}),this.recalc()},recalc:function(){var r=this.geometry.width,s=this.geometry.height;t.recalc.call(this),this.moi=(r*r+s*s)*this.mass/12}}})),s.behavior("attractor",(function(t){var r={pos:null,strength:1,order:2,max:!1,min:!1};return{init:function(c){var u=this;this._pos=new s.vector,t.init.call(this),this.options.defaults(r),this.options.onChange((function(t){u._maxDist=!1===t.max?1/0:t.max,u._minDist=t.min?t.min:10,u.position(t.pos)})),this.options(c)},position:function(t){return t?(this._pos.clone(t),this):this._pos.values()},behave:function(){for(var t,r,c,u=this.getTargets(),p=this.options.order,v=this.options.strength,y=this._minDist,_=this._maxDist,w=s.scratchpad(),x=w.vector(),P=0,A=u.length;A>P;P++)t=u[P],x.clone(this._pos),x.vsub(t.state.pos),(r=x.norm())>y&&_>r&&(c=v/Math.pow(r,p),t.accelerate(x.normalize().mult(c)));w.done()}}})),s.behavior("body-collision-detection",(function(t){var r=[],d=function(t,c){var u=s.util.pairHash(t.uid,c.uid),p=r[u];return p||((p=r[u]=function(r){var s=p.tA,u=p.tB,v=p.tmpv1,y=p.tmpv2;return p.useCore?(v=t.geometry.getFarthestCorePoint(r.rotateInv(s),v,p.marginA),y=c.geometry.getFarthestCorePoint(r.rotate(s).rotateInv(u).negate(),y,p.marginB)):(v=t.geometry.getFarthestHullPoint(r.rotateInv(s),v),y=c.geometry.getFarthestHullPoint(r.rotate(s).rotateInv(u).negate(),y)),v.vadd(t.offset).transform(s),y.vadd(c.offset).transform(u),r.negate().rotate(u),{a:v.values(),b:y.values(),pt:v.vsub(y).values()}}).tA=new s.transform,p.tB=new s.transform,p.tmpv1=new s.vector,p.tmpv2=new s.vector),p.useCore=!1,p.margin=0,p.tA.setRotation(t.state.angular.pos).setTranslation(t.state.pos),p.tB.setRotation(c.state.angular.pos).setTranslation(c.state.pos),p.bodyA=t,p.bodyB=c,p},e=function(t,r){var c,u,p,v,y=s.scratchpad(),_=y.vector(),w=y.vector(),x=y.vector(),P=!1,A=t.aabb(),C=Math.min(A.hw,A.hh),I=r.aabb(),T=Math.min(I.hw,I.hh);if(p=d(t,r),_.clone(t.state.pos).vadd(t.getGlobalOffset(x)).vsub(r.state.pos).vsub(r.getGlobalOffset(x)),(u=s.gjk(p,_,!0)).overlap){for(P={bodyA:t,bodyB:r},v=.01*Math.min(C||1,T||1),p.useCore=!0,p.marginA=0,p.marginB=0;(u.overlap||0===u.distance)&&(p.marginA<C||p.marginB<T);)p.marginA<C&&(p.marginA+=v),p.marginB<T&&(p.marginB+=v),u=s.gjk(p,_);if(u.overlap||u.maxIterationsReached)return y.done(!1);if(0>=(c=p.marginA+p.marginB-u.distance))return y.done(!1);P.overlap=c,P.norm=_.clone(u.closest.b).vsub(w.clone(u.closest.a)).normalize().values(),P.mtv=_.mult(c).values(),P.pos=_.clone(P.norm).mult(p.marginA).vadd(w.clone(u.closest.a)).vsub(t.state.pos).values()}return y.done(P)},c=function i(t,r){if(!("static"!==t.treatment&&"kinematic"!==t.treatment||"static"!==r.treatment&&"kinematic"!==r.treatment))return!1;if("circle"===t.geometry.name&&"circle"===r.geometry.name)return function(t,r){var c,u=s.scratchpad(),p=u.vector(),v=u.vector(),y=!1;return p.clone(r.state.pos).vadd(r.getGlobalOffset(v)).vsub(t.state.pos).vsub(t.getGlobalOffset(v)),c=p.norm()-(t.geometry.radius+r.geometry.radius),p.equals(s.vector.zero)&&p.set(1,0),0>=c&&(y={bodyA:t,bodyB:r,norm:p.normalize().values(),mtv:p.mult(-c).values(),pos:p.mult(-t.geometry.radius/c).vadd(v).values(),overlap:-c}),u.done(y)}(t,r);if("compound"===t.geometry.name||"compound"===r.geometry.name){var c,u,p,v,y="compound"===t.geometry.name,_=y?t:r,w=y?r:t,x=[],P=s.scratchpad(),A=(P.vector(),P.vector()),C=w.aabb();for(p=0,v=_.children.length;v>p;p++){if(u=_.children[p],A.clone(u.state.pos),u.offset.vadd(A.vadd(_.offset).rotate(-u.state.angular.pos)),u.state.pos.clone(_.state.pos),u.state.angular.pos+=_.state.angular.pos,s.aabb.overlap(C,u.aabb()))if((c=i(w,u))instanceof Array)for(var I,T=0,B=c.length;B>T;T++)(I=c[T]).bodyA===u?I.bodyA=_:I.bodyB=_,x.push(I);else c&&(c.bodyA===u?c.bodyA=_:c.bodyB=_,x.push(c));u.state.angular.pos-=_.state.angular.pos,u.offset.vsub(A),u.state.pos.clone(A.rotate(u.state.angular.pos).vsub(_.offset))}return P.done(x)}return e(t,r)},u={check:"collisions:candidates",channel:"collisions:detected"};return{init:function(r){t.init.call(this),this.options.defaults(u),this.options(r)},connect:function(t){!0===this.options.check?t.on("integrate:velocities",this.checkAll,this):t.on(this.options.check,this.check,this)},disconnect:function(t){!0===this.options.check?t.off("integrate:velocities",this.checkAll,this):t.off(this.options.check,this.check,this)},check:function(t){for(var r,u,p,v=t.candidates,y=this.getTargets(),_=[],w=this.prevContacts||{},x={},P=s.util.pairHash,A=0,C=v.length;C>A;++A)if(r=v[A],y===this._world._bodies||s.util.indexOf(y,r.bodyA)>-1&&s.util.indexOf(y,r.bodyB)>-1)if((u=c(r.bodyA,r.bodyB))instanceof Array)for(var I,T=0,B=u.length;B>T;T++)(I=u[T])&&(x[p=P(r.bodyA.uid,r.bodyB.uid)]=!0,I.collidedPreviously=w[p],_.push(I));else u&&(x[p=P(r.bodyA.uid,r.bodyB.uid)]=!0,u.collidedPreviously=w[p],_.push(u));this.prevContacts=x,_.length&&this._world.emit(this.options.channel,{collisions:_})},checkAll:function(t){for(var r,u,p,v,y=this.getTargets(),_=(t.dt,[]),w=this.prevContacts||{},x={},P=s.util.pairHash,A=0,C=y.length;C>A;A++){r=y[A];for(var I=A+1;C>I;I++)if(u=y[I],(p=c(r,u))instanceof Array)for(var T,B=0,M=p.length;M>B;B++)(T=p[B])&&(x[v=P(r.uid,u.uid)]=!0,T.collidedPreviously=w[v],_.push(T));else p&&(x[v=P(r.uid,u.uid)]=!0,p.collidedPreviously=w[v],_.push(p))}this.prevContacts=x,_.length&&this._world.emit(this.options.channel,{collisions:_})}}})),s.behavior("body-impulse-response",(function(t){function b(t){return t.uid}function d(t,r,s){var c,u;return c=(u=r.norm())-t.proj(r),c=Math.max(0,Math.min(u,c)),0===u?s.zero():s.clone(r).mult(c/u),s}var r={check:"collisions:detected",mtvThreshold:1,bodyExtractDropoff:.5,forceWakeupAboveOverlapThreshold:!0};return{init:function(s){t.init.call(this),this.options.defaults(r),this.options(s),this._bodyList=[]},applyTo:!1,connect:function(t){t.on(this.options.check,this.respond,this)},disconnect:function(t){t.off(this.options.check,this.respond,this)},collideBodies:function(t,r,c,u,p,v){var y="static"===t.treatment||"kinematic"===t.treatment,_="static"===r.treatment||"kinematic"===r.treatment,w=s.scratchpad(),x=w.vector().clone(p);if(!y||!_){var P,A,C,I=y?0:1/t.moi,T=_?0:1/r.moi,B=y?0:1/t.mass,M=_?0:1/r.mass,S=t.restitution*r.restitution,F=t.cof*r.cof,z=w.vector().clone(c),L=w.vector().clone(z).perp(),O=w.vector(),q=w.vector().clone(u),E=w.vector().clone(u).vadd(t.state.pos).vsub(r.state.pos),D=t.state.angular.vel,R=r.state.angular.vel,V=w.vector().clone(r.state.vel).vadd(O.clone(E).perp().mult(R)).vsub(t.state.vel).vsub(O.clone(q).perp().mult(D)),H=q.proj(z),W=q.proj(L),X=E.proj(z),N=E.proj(L),G=V.proj(z),$=V.proj(L);return v&&(y?(d(r._mtvTotal,x,O),r._mtvTotal.vadd(O)):_?(d(t._mtvTotal,x.negate(),O),t._mtvTotal.vadd(O),x.negate()):(.5,x.mult(.5),d(r._mtvTotal,x,O),r._mtvTotal.vadd(O),x.clone(p).mult(-.5),d(t._mtvTotal,x,O),t._mtvTotal.vadd(O))),G>=0||(P=-(1+S)*G/(B+M+(I=1/0===I?0:I)*W*W+(T=1/0===T?0:T)*N*N),y?(r.state.vel.vadd(z.mult(P*M)),r.state.angular.vel-=P*T*N):_?(t.state.vel.vsub(z.mult(P*B)),t.state.angular.vel+=P*I*W):(r.state.vel.vadd(z.mult(P*M)),r.state.angular.vel-=P*T*N,t.state.vel.vsub(z.mult(B*r.mass)),t.state.angular.vel+=P*I*W),F&&$&&(C=Math.abs($)/(B+M+I*H*H+T*X*X),A=0>$?-1:1,P=F*Math.abs(P),P=Math.min(P,C),P*=A,y?(r.state.vel.vsub(L.mult(P*M)),r.state.angular.vel-=P*T*X):_?(t.state.vel.vadd(L.mult(P*B)),t.state.angular.vel+=P*I*H):(r.state.vel.vsub(L.mult(P*M)),r.state.angular.vel-=P*T*X,t.state.vel.vadd(L.mult(B*r.mass)),t.state.angular.vel+=P*I*H)),t.sleep()&&t.sleepCheck(),r.sleep()&&r.sleepCheck()),void w.done()}w.done()},_pushUniq:function(t){var r=s.util.sortedIndex(this._bodyList,t,b);this._bodyList[r]!==t&&this._bodyList.splice(r,0,t)},respond:function(t){var r,c,u,p,v=t.collisions;for(c=0,u=v.length;u>c;++c)r=v[c],this._pushUniq(r.bodyA),this._pushUniq(r.bodyB),r.bodyA._mtvTotal=r.bodyA._mtvTotal||new s.vector,r.bodyB._mtvTotal=r.bodyB._mtvTotal||new s.vector,r.bodyA._oldmtvTotal=r.bodyA._oldmtvTotal||new s.vector,r.bodyB._oldmtvTotal=r.bodyB._oldmtvTotal||new s.vector,this.collideBodies(r.bodyA,r.bodyB,r.norm,r.pos,r.mtv,r.collidedPreviously);for(c=0,u=this._bodyList.length;u>c;++c)(p=this._bodyList.pop())._mtvTotal.normSq()<this.options.mtvThreshold?p._mtvTotal.mult(this.options.bodyExtractDropoff):this.options.forceWakeupAboveOverlapThreshold&&p.sleep(!1),p.state.pos.vadd(p._mtvTotal),p.state.old.pos.vadd(p._mtvTotal),p._oldmtvTotal.swap(p._mtvTotal),p._mtvTotal.zero()}}})),s.behavior("constant-acceleration",(function(t){var r={acc:{x:0,y:4e-4}};return{init:function(c){t.init.call(this),this.options.defaults(r),this.options(c),this._acc=new s.vector,this.setAcceleration(this.options.acc),delete this.options.acc},setAcceleration:function(t){return this._acc.clone(t),this},behave:function(){for(var t=this.getTargets(),r=0,s=t.length;s>r;++r)t[r].accelerate(this._acc)}}})),s.behavior("edge-collision-detection",(function(t){var b=function(t,r,c){var u,p=t.aabb(),v=s.scratchpad(),y=t.getGlobalOffset(v.vector()),_=v.transform(),w=v.vector(),x=v.vector(),P=!1,A=[];return(u=p.x+p.hw-r.max.x)>=0&&(w.set(1,0).rotateInv(_.setRotation(t.state.angular.pos)),P={bodyA:t,bodyB:c,overlap:u,norm:{x:1,y:0},mtv:{x:u,y:0},pos:t.geometry.getFarthestHullPoint(w,x).rotate(_).vadd(y).values()},A.push(P)),(u=p.y+p.hh-r.max.y)>=0&&(w.set(0,1).rotateInv(_.setRotation(t.state.angular.pos)),P={bodyA:t,bodyB:c,overlap:u,norm:{x:0,y:1},mtv:{x:0,y:u},pos:t.geometry.getFarthestHullPoint(w,x).rotate(_).vadd(y).values()},A.push(P)),(u=r.min.x-(p.x-p.hw))>=0&&(w.set(-1,0).rotateInv(_.setRotation(t.state.angular.pos)),P={bodyA:t,bodyB:c,overlap:u,norm:{x:-1,y:0},mtv:{x:-u,y:0},pos:t.geometry.getFarthestHullPoint(w,x).rotate(_).vadd(y).values()},A.push(P)),(u=r.min.y-(p.y-p.hh))>=0&&(w.set(0,-1).rotateInv(_.setRotation(t.state.angular.pos)),P={bodyA:t,bodyB:c,overlap:u,norm:{x:0,y:-1},mtv:{x:0,y:-u},pos:t.geometry.getFarthestHullPoint(w,x).rotate(_).vadd(y).values()},A.push(P)),v.done(),A},d=function(t,r,s){return b(t,r,s)},r={aabb:null,restitution:.99,cof:1,channel:"collisions:detected"};return{init:function(c){t.init.call(this),this.options.defaults(r),this.options(c),this.setAABB(this.options.aabb),this.restitution=this.options.restitution,this.body=s.body("point",{treatment:"static",restitution:this.options.restitution,cof:this.options.cof})},setAABB:function(t){if(!t)throw"Error: aabb not set";return this._edges={min:{x:t.x-t.hw,y:t.y-t.hh},max:{x:t.x+t.hw,y:t.y+t.hh}},this},connect:function(t){t.on("integrate:positions",this.checkAll,this,2)},disconnect:function(t){t.off("integrate:positions",this.checkAll,this,2)},checkAll:function(t){for(var r,c,u,p=this.getTargets(),v=(t.dt,[]),y=this._edges,_=this.body,w=this.prevContacts||{},x={},P=s.util.pairHash,A=0,C=p.length;C>A;A++)if("dynamic"===(r=p[A]).treatment&&(c=d(r,y,_))){u=P(r.uid,_.uid);for(var I=0,T=c.length;T>I;I++)x[u]=!0,c[I].collidedPreviously=w[u];v.push.apply(v,c)}this.prevContacts=x,v.length&&this._world.emit(this.options.channel,{collisions:v})}}})),s.behavior("interactive",(function(c){if(!r)return{};var u={el:null,moveThrottle:10,minVel:{x:-5,y:-5},maxVel:{x:5,y:5}},f=function(t){var r=0,s=0;if(t.offsetParent)do{r+=t.offsetLeft,s+=t.offsetTop}while(t=t.offsetParent);return{left:r,top:s}};return{init:function(t){var p=this;if(c.init.call(this),this.options.defaults(u),this.options(t),this.bodyData={},this.bodyDataByUID={},this.el="string"==typeof this.options.el?r.getElementById(this.options.el):this.options.el,!this.el)throw"No DOM element specified";p.grab=function(t){var r,c,u,v,y,_,w,x;if(p._world)for(t.changedTouches||(t.changedTouches=[t]),y=f(t.target),w=0,x=t.changedTouches.length;x>w;w++)r={idx:u=(v=t.changedTouches[w]).identifier||v.pointerId||"mouse",x:v.pageX-y.left,y:v.pageY-y.top},(c=p._world.findOne({$at:new s.vector(r),$in:p.getTargets()}))?(c.state.vel.zero(),c.state.angular.vel=0,c.isGrabbed=!0,(_=p.bodyData[u]||{}).body=c,c.sleep(!1),_.time=s.util.ticker.now(),_.treatment=p.bodyDataByUID[c.uid]?p.bodyDataByUID[c.uid].treatment:c.treatment,c.treatment="kinematic",_.pos=_.pos||new s.vector,_.pos.clone(r),_.offset=_.offset||new s.vector,_.offset.clone(r).vsub(c.state.pos),_.oldPos=_.oldPos||new s.vector,_.oldPos.clone(r),r.body=c,p.bodyData[u]=_,p.bodyDataByUID[c.uid]=_,p._world.emit("interact:grab",r)):p._world.emit("interact:poke",r)},p.move=s.util.throttle((function(t){var r,c,u,v,y,_,w,x;if(p._world)for(t.changedTouches||(t.changedTouches=[t]),y=f(p.el),w=0,x=t.changedTouches.length;x>w;w++)r={idx:u=(v=t.changedTouches[w]).identifier||v.pointerId||"mouse",x:v.pageX-y.left,y:v.pageY-y.top},(_=p.bodyData[u])&&((c=_.body).sleep(!1),_.time=s.util.ticker.now(),_.oldPos.clone(_.pos),_.pos.clone(r),r.body=c),p._world.emit("interact:move",r)}),p.options.moveThrottle),p.release=function(t){var r,c,u,v,y,_,w,x,P;if(p._world)for(t.changedTouches||(t.changedTouches=[t]),x=0,P=t.changedTouches.length;P>x;x++)y=f(p.el),r={idx:u=(v=t.changedTouches[x]).identifier||v.pointerId||"mouse",x:v.pageX-y.left,y:v.pageY-y.top},(_=p.bodyData[u])&&((c=_.body).sleep(!1),_.pos.clone(r),w=Math.max(s.util.ticker.now()-_.time,p.options.moveThrottle),c.treatment=_.treatment,c.state.vel.clone(_.pos).vsub(_.oldPos).mult(1/w),c.state.vel.clamp(p.options.minVel,p.options.maxVel),c.isGrabbed=!1,r.body=c,delete c.isGrabbed),p._world.emit("interact:release",r),delete p.bodyData[u]}},connect:function(r){r.on("integrate:positions",this.behave,this),t.PointerEvent?(this.el.addEventListener("pointerdown",this.grab),t.addEventListener("pointermove",this.move),t.addEventListener("pointerup",this.release)):(this.el.addEventListener("mousedown",this.grab),this.el.addEventListener("touchstart",this.grab),t.addEventListener("mousemove",this.move),t.addEventListener("touchmove",this.move),t.addEventListener("mouseup",this.release),t.addEventListener("touchend",this.release))},disconnect:function(r){r.off("integrate:positions",this.behave,this),t.PointerEvent?(this.el.removeEventListener("pointerdown",this.grab),t.removeEventListener("pointermove",this.move),t.removeEventListener("pointerup",this.release)):(this.el.removeEventListener("mousedown",this.grab),this.el.removeEventListener("touchstart",this.grab),t.removeEventListener("mousemove",this.move),t.removeEventListener("touchmove",this.move),t.removeEventListener("mouseup",this.release),t.removeEventListener("touchend",this.release))},behave:function(t){var r,s,c=this,u=Math.max(t.dt,c.options.moveThrottle);for(var p in c.bodyData)(r=(s=c.bodyData[p]).body.state).vel.clone(s.pos).vsub(s.offset).vsub(r.pos).mult(1/u)}}})),s.behavior("newtonian",(function(t){var r={strength:1,max:!1,min:!1};return{init:function(s){var c=this;t.init.call(this),this.options.defaults(r),this.options.onChange((function(t){c._maxDistSq=!1===t.max?1/0:t.max*t.max,c._minDistSq=t.min?t.min*t.min:100*t.strength})),this.options(s)},calcPotential:function(t,r,c){var u,p,v,y=this.options.strength,_=this._minDistSq,w=this._maxDistSq;return(v=c||new s.vector).clone(r).vsub(t),(u=v.normSq())>_&&w>u?(p=y/u,v.normalize().mult(p)):v.zero()},behave:function(){var t,r,c,u,p,v,y,_,w,x,P,A,C=this.getTargets(),I=s.scratchpad(),T=I.vector(),B=I.vector(),M=I.vector();for(y=0,x=C.length;x>y;y++)for(t=C[y],v=y+1;x>v;v++){if(r=C[v],"compound"===t.name?c=t:"compound"===r.name&&(c=r,r=t),c)if("compound"===r.name)for(_=0,P=c.children.length;P>_;_++)for(u=c.children[_],c.toWorldCoords(B.clone(u.state.pos).vadd(c.offset)),w=0,A=r.children.length;A>w;w++)p=r.children[w],r.toWorldCoords(M.clone(p.state.pos).vadd(r.offset)),this.calcPotential(B,M,T),c.accelerate(T.mult(p.mass)),r.accelerate(T.mult(u.mass/p.mass).negate());else for(_=0,P=c.children.length;P>_;_++)u=c.children[_],c.toWorldCoords(B.clone(u.state.pos).vadd(c.offset)),this.calcPotential(B,r.state.pos,T),c.accelerate(T.mult(r.mass)),r.accelerate(T.mult(u.mass/r.mass).negate());else this.calcPotential(t.state.pos,r.state.pos,T),t.accelerate(T.mult(r.mass)),r.accelerate(T.mult(t.mass/r.mass).negate());c=null}I.done()}}})),s.behavior("sweep-prune",(function(t){var r=1,d=function(){return r++},c={x:0,y:1},u=s.util.pairHash;return{init:function(r){t.init.call(this),this.options.defaults({channel:"collisions:candidates"}),this.options(r),this.encounters=[],this.candidates=[],this.clear()},clear:function(){this.tracked=[],this.pairs=[],this.intervalLists=[];for(var t=0;2>t;++t)this.intervalLists[t]=[]},connect:function(t){t.on("add:body",this.trackBody,this),t.on("remove:body",this.untrackBody,this),t.on("integrate:positions",this.sweep,this,1);for(var r=t.getBodies(),s=0,c=r.length;c>s;++s)this.trackBody({body:r[s]})},disconnect:function(t){t.off("add:body",this.trackBody,this),t.off("remove:body",this.untrackBody,this),t.off("integrate:positions",this.sweep,this,1),this.clear()},broadPhase:function(){return this.updateIntervals(),this.sortIntervalLists(),this._world&&this._world.emit("sweep-prune:intervals",this.intervalLists),this.checkOverlaps()},sortIntervalLists:function(){for(var t,r,s,c,u,p,v,y,_,w=0;2>w;++w)for(s=0,r=(t=this.intervalLists[w]).length,_=w;++s<r;){for(p=(u=t[s]).val.get(_),y=(v=t[(c=s)-1])&&v.val.get(_);c>0&&(y>p||y===p&&v.type&&!u.type);)t[c]=v,y=(v=t[--c-1])&&v.val.get(_);t[c]=u}},getPair:function(t,r,s){var c=u(t.id,r.id);if(!1===c)return null;var p=this.pairs[c];if(!p){if(!s)return null;p=this.pairs[c]={bodyA:t.body,bodyB:r.body,flag:1}}return s&&(p.flag=1),p},checkOverlaps:function(){var t,r,u,p,v,y,_,w,x,P=1<<c.z+1<<c.y+1<<c.x+1,A=this.encounters,C=0,I=this.candidates;s.util.clearArray(A),s.util.clearArray(I);for(var T=0;2>T;++T)for(t=0===T,_=0,y=(v=this.intervalLists[T]).length;y>_;_++)if(r=(p=v[_]).tracker,p.type)for(w=C,w=C-1;w>=0;w--)(u=A[w])===r?(C-1>w?A[w]=A.pop():A.pop(),C--):(x=this.getPair(r,u,t))&&x.flag<P&&(x.flag=x.flag<<T+1,x.flag===P&&I.push(x));else C=A.push(r);return I},updateIntervals:function(){for(var t,r,s,c=this.tracked,u=c.length;--u>=0;)r=(t=c[u]).interval,s=t.body.aabb(),r.min.val.clone(s).sub(s.hw,s.hh),r.max.val.clone(s).add(s.hw,s.hh)},trackBody:function(t){var r=t.body,c={id:d(),body:r},u={min:{type:!1,val:new s.vector,tracker:c},max:{type:!0,val:new s.vector,tracker:c}};c.interval=u,this.tracked.push(c);for(var p=0;2>p;++p)this.intervalLists[p].push(u.min,u.max)},untrackBody:function(t){for(var r,s,c,u,p=t.body,v=this.tracked,y=0,_=v.length;_>y;++y)if((c=v[y]).body===p){v.splice(y,1);for(var w=0;2>w;++w){u=0;for(var x=0,P=(r=this.intervalLists[w]).length;P>x;++x)if((s=r[x])===c.interval.min||s===c.interval.max){if(r.splice(x,1),x--,_--,u>0)break;u++}}break}},sweep:function(){var t;(t=this.broadPhase()).length&&this._world.emit(this.options.channel,{candidates:t})}}})),s.behavior("verlet-constraints",(function(t){var r=2*Math.PI,c={iterations:2};return{init:function(r){t.init.call(this),this.options.defaults(c),this.options(r),this._distanceConstraints=[],this._angleConstraints=[]},connect:function(t){var r=t.integrator();if(r&&r.name.indexOf("verlet")<0)throw'The rigid constraint manager needs a world with a "verlet" compatible integrator.';t.on("integrate:positions",this.resolve,this)},disconnect:function(t){t.off("integrate:positions",this.resolve,this)},drop:function(){return this._distanceConstraints=[],this._angleConstraints=[],this},distanceConstraint:function(t,r,c,u){var p;return!(!t||!r)&&((p={id:s.util.uniqueId("dis-constraint"),type:"dis",bodyA:t,bodyB:r,stiffness:c||.5,targetLength:u||r.state.pos.dist(t.state.pos)}).targetLengthSq=p.targetLength*p.targetLength,this._distanceConstraints.push(p),p)},angleConstraint:function(t,r,c,u,p){var v;return!(!t||!r)&&(v={id:s.util.uniqueId("ang-constraint"),type:"ang",bodyA:t,bodyB:r,bodyC:c,stiffness:u||.5,targetAngle:p||r.state.pos.angle2(t.state.pos,c.state.pos)},this._angleConstraints.push(v),v)},remove:function(t){var r,c,u,p;if(r="ang"===((c=s.util.isObject(t))?t.type:t.substr(0,3))?this._angleConstraints:this._distanceConstraints,c){for(u=0,p=r.length;p>u;++u)if(r[u]===t)return r.splice(u,1),this}else for(u=0,p=r.length;p>u;++u)if(r[u].id===t)return r.splice(u,1),this;return this},resolveAngleConstraints:function(t){for(var c,u,p,v,y=this._angleConstraints,_=s.scratchpad(),w=_.transform(),x=0,P=y.length;P>x;++x)(p=(u=(c=y[x]).bodyB.state.pos.angle2(c.bodyA.state.pos,c.bodyC.state.pos))-c.targetAngle)&&(p<=-Math.PI?p+=r:p>=Math.PI&&(p-=r),w.setTranslation(c.bodyB.state.pos),p*=-t*c.stiffness,"dynamic"===c.bodyA.treatment&&"dynamic"===c.bodyB.treatment&&"dynamic"===c.bodyC.treatment&&(v=1/(c.bodyA.mass+c.bodyB.mass+c.bodyC.mass)),"dynamic"===c.bodyA.treatment&&(u="dynamic"===c.bodyB.treatment&&"dynamic"===c.bodyC.treatment?p*(c.bodyB.mass+c.bodyC.mass)*v:"dynamic"!==c.bodyB.treatment?p*c.bodyC.mass/(c.bodyC.mass+c.bodyA.mass):p*c.bodyB.mass/(c.bodyB.mass+c.bodyA.mass),w.setRotation(u),c.bodyA.state.pos.translateInv(w),c.bodyA.state.pos.rotate(w),c.bodyA.state.pos.translate(w)),"dynamic"===c.bodyC.treatment&&(u="dynamic"===c.bodyA.treatment&&"dynamic"===c.bodyB.treatment?-p*(c.bodyB.mass+c.bodyA.mass)*v:"dynamic"!==c.bodyB.treatment?-p*c.bodyA.mass/(c.bodyC.mass+c.bodyA.mass):-p*c.bodyB.mass/(c.bodyB.mass+c.bodyC.mass),w.setRotation(u),c.bodyC.state.pos.translateInv(w),c.bodyC.state.pos.rotate(w),c.bodyC.state.pos.translate(w)),"dynamic"===c.bodyB.treatment&&(u="dynamic"===c.bodyA.treatment&&"dynamic"===c.bodyC.treatment?p*(c.bodyA.mass+c.bodyC.mass)*v:"dynamic"!==c.bodyA.treatment?p*c.bodyC.mass/(c.bodyC.mass+c.bodyB.mass):p*c.bodyA.mass/(c.bodyA.mass+c.bodyC.mass),w.setRotation(u).setTranslation(c.bodyA.state.pos),c.bodyB.state.pos.translateInv(w),c.bodyB.state.pos.rotate(w),c.bodyB.state.pos.translate(w),w.setTranslation(c.bodyC.state.pos),c.bodyB.state.pos.translateInv(w),c.bodyB.state.pos.rotateInv(w),c.bodyB.state.pos.translate(w)),c.bodyA.sleepCheck(),c.bodyB.sleepCheck(),c.bodyC.sleepCheck());_.done()},resolveDistanceConstraints:function(t){for(var r,c,u,p,v=this._distanceConstraints,y=s.scratchpad(),_=y.vector(),w=0,x=v.length;x>w;++w)r=v[w],_.clone(r.bodyB.state.pos).vsub(r.bodyA.state.pos),c=_.normSq()||1e-4*Math.random(),u=t*r.stiffness*(c-r.targetLengthSq)/c,_.mult(u),p="dynamic"!==r.bodyA.treatment||"dynamic"!==r.bodyB.treatment?1:r.bodyB.mass/(r.bodyA.mass+r.bodyB.mass),"dynamic"===r.bodyA.treatment&&("dynamic"===r.bodyB.treatment&&_.mult(p),r.bodyA.state.pos.vadd(_),"dynamic"===r.bodyB.treatment&&_.mult(1/p)),"dynamic"===r.bodyB.treatment&&("dynamic"===r.bodyA.treatment&&_.mult(1-p),r.bodyB.state.pos.vsub(_)),r.bodyA.sleepCheck(),r.bodyB.sleepCheck();y.done()},shuffleConstraints:function(){this._distanceConstraints=s.util.shuffle(this._distanceConstraints),this._angleConstraints=s.util.shuffle(this._angleConstraints)},resolve:function(){for(var t=this.options.iterations,r=1/t,s=0;t>s;s++)this.resolveDistanceConstraints(r),this.resolveAngleConstraints(r)},getConstraints:function(){return{distanceConstraints:[].concat(this._distanceConstraints),angleConstraints:[].concat(this._angleConstraints)}}}})),s.integrator("improved-euler",(function(t){return{init:function(r){t.init.call(this,r)},integrateVelocities:function(t,r){for(var s,c=1-this.options.drag,u=null,p=0,v=t.length;v>p;++p)s=(u=t[p]).state,"static"===u.treatment||u.sleep(r)?(s.vel.zero(),s.acc.zero(),s.angular.vel=0,s.angular.acc=0):(s.old.vel.clone(s.vel),s.old.acc.clone(s.acc),s.vel.vadd(s.acc.mult(r)),c&&s.vel.mult(c),s.acc.zero(),s.old.angular.vel=s.angular.vel,s.angular.vel+=s.angular.acc*r,s.angular.acc=0)},integratePositions:function(t,r){for(var c,u=.5*r*r,p=null,v=s.scratchpad(),y=v.vector(),_=0,w=t.length;w>_;++_)c=(p=t[_]).state,"static"===p.treatment||p.sleep()||(c.old.pos.clone(c.pos),y.clone(c.old.vel),c.pos.vadd(y.mult(r)).vadd(c.old.acc.mult(u)),c.old.acc.zero(),c.old.angular.pos=c.angular.pos,c.angular.pos+=c.old.angular.vel*r+c.old.angular.acc*u,c.old.angular.acc=0);v.done()}}})),s.integrator("velocity-verlet-alt",(function(t){return s.body.mixin({started:function(t){return void 0!==t&&(this._started=!0),!!this._started}}),{init:function(r){t.init.call(this,r)},integrateVelocities:function(t,r){for(var s,c=1-this.options.drag,u=null,p=0,v=t.length;v>p;++p)s=(u=t[p]).state,"static"!==u.treatment?(u.started()||(s.old.acc.clone(s.acc),s.old.acc.mult(r),s.old.vel.clone(s.vel).vsub(s.old.acc),s.old.acc.mult(1/r)),c&&s.vel.mult(c),s.vel.vadd(s.old.acc.vadd(s.acc).mult(.5*r)),u.started()||(s.old.angular.acc=s.angular.acc,s.old.angular.vel=s.angular.vel-s.old.angular.acc*r),s.angular.vel+=.5*(s.angular.acc+s.old.angular.acc)*r,s.angular.acc=0,u.started(!0)):(s.vel.zero(),s.acc.zero(),s.angular.vel=0,s.angular.acc=0)},integratePositions:function(t,r){for(var s,c=r*r,u=null,p=0,v=t.length;v>p;++p)s=(u=t[p]).state,"static"!==u.treatment&&(s.old.pos.clone(s.pos),s.old.vel.mult(r),s.old.acc.mult(.5*c),s.pos.vadd(s.old.vel).vadd(s.old.acc),s.old.vel.clone(s.vel),s.old.acc.clone(s.acc),s.acc.zero(),s.old.angular.pos=s.angular.pos,s.angular.pos+=s.angular.vel*r+.5*s.old.angular.acc*c,s.old.angular.vel=s.angular.vel,s.old.angular.acc=s.angular.acc,s.angular.acc=0)}}})),s.integrator("velocity-verlet",(function(t){return s.body.mixin({started:function(t){return void 0!==t&&(this._started=!0),!!this._started}}),{init:function(r){t.init.call(this,r)},integrate:function(t,r){var s=this._world;return this.integratePositions(t,r),s&&s.emit("integrate:positions",{bodies:t,dt:r}),this.integrateVelocities(t,r),s&&s.emit("integrate:velocities",{bodies:t,dt:r}),this},integrateVelocities:function(t,r){for(var s,c=1-this.options.drag,u=null,p=0,v=t.length;v>p;++p)s=(u=t[p]).state,"static"===u.treatment||u.sleep()?(s.vel.zero(),s.acc.zero(),s.angular.vel=0,s.angular.acc=0):(c&&s.vel.mult(c),s.old.vel.clone(s.vel),s.vel.vadd(s.old.acc.vadd(s.acc).mult(.5*r)),s.old.acc.clone(s.acc),s.acc.zero(),s.old.angular.vel=s.angular.vel,s.old.angular.acc=s.angular.acc,s.angular.vel+=.5*(s.angular.acc+s.old.angular.acc)*r,s.angular.acc=0,u.started(!0))},integratePositions:function(t,r){for(var s,c=r*r,u=null,p=0,v=t.length;v>p;++p)s=(u=t[p]).state,"static"===u.treatment||u.sleep(r)||(u.started()||(s.old.acc.clone(s.acc),s.old.acc.mult(r),s.old.vel.clone(s.vel).vsub(s.old.acc),s.old.acc.mult(1/r)),s.old.pos.clone(s.pos),s.old.vel.mult(r),s.old.acc.mult(.5*c),s.pos.vadd(s.old.vel).vadd(s.old.acc),s.old.vel.mult(1/r),s.old.acc.mult(2/c),u.started()||(s.old.angular.acc=s.angular.acc,s.old.angular.vel=s.angular.vel-s.old.angular.acc*r),s.old.angular.pos=s.angular.pos,s.angular.pos+=s.angular.vel*r+.5*s.old.angular.acc*c)}}})),s.renderer("canvas",(function(t){if(!r)return{};var c=2*Math.PI,e=function(t,s){var c=r.createElement(t||"div");return s&&(c.innerHTML=s),c},u="#fff",p="#542437",v="#53777A",y={metaEl:null,styles:{point:v,circle:{strokeStyle:v,lineWidth:1,fillStyle:v,angleIndicator:u},rectangle:{strokeStyle:p,lineWidth:1,fillStyle:p,angleIndicator:u},"convex-polygon":{strokeStyle:p,lineWidth:1,fillStyle:p,angleIndicator:u}},offset:{x:0,y:0}};return{init:function(c){var u=this;if(t.init.call(this,c),this.options.defaults(y,!0),this.options.onChange((function(){u.options.offset=new s.vector(u.options.offset)})),this.options(c,!0),this.hiddenCanvas=r.createElement("canvas"),this.hiddenCanvas.width=this.hiddenCanvas.height=100,!this.hiddenCanvas.getContext)throw"Canvas not supported";this.hiddenCtx=this.hiddenCanvas.getContext("2d");var p=this.el;if("CANVAS"!==p.nodeName.toUpperCase()&&(p=r.createElement("canvas"),this.el.appendChild(p),"string"==typeof this.options.el&&this.el===r.body&&(p.id=this.options.el),this.el=p),this.container=this.el.parentNode,this.ctx=p.getContext("2d"),this.els={},this.options.meta){var v=this.options.metaEl||e();v.className="pjs-meta",this.els.fps=e("span"),this.els.ipf=e("span"),v.appendChild(e("span","fps: ")),v.appendChild(this.els.fps),v.appendChild(e("br")),v.appendChild(e("span","ipf: ")),v.appendChild(this.els.ipf),p.parentNode.insertBefore(v,p)}this._layers={},this.addLayer("main",this.el),this.options.autoResize?this.resize():this.resize(this.options.width,this.options.height)},layer:function(t){return t in this._layers?this._layers[t]:null},addLayer:function(t,c,u){var p=this,v=[],y=s.util.extend({},this.options.styles),_={id:t,el:c||r.createElement("canvas"),options:s.util.options({width:this.el.width,height:this.el.height,manual:!1,autoResize:!0,follow:null,offset:null,scale:1,zIndex:1})(u)};if(t in this._layers)throw'Layer "'+t+'" already added.';return this.el.parentNode.insertBefore(_.el,this.el),_.el.style.position="absolute",_.el.style.zIndex=_.options.zIndex,_.el.className+=" pjs-layer-"+_.id,_.ctx=_.el.getContext("2d"),_.ctx.scale(1,1),_.el.width=_.options.width,_.el.height=_.options.height,_.bodies=v,_.reset=function(t){return v=t||[],_},_.addToStack=function(t){return s.util.isArray(t)?v.push.apply(v,t):v.push(t),_},_.removeFromStack=function(t){var r,c;if(s.util.isArray(t))for(r=0,c=t.length;c>r;++r)_.removeFromStack(t[r]);else(r=s.util.indexOf(v,t))>-1&&v.splice(r,1);return _},_.render=function(t){var r,c,u=s.scratchpad(),w=u.vector().set(0,0),x=_.options.scale,P=v.length,A=p._interpolateTime,C=P||"main"!==_.id?v:p._world._bodies;if(_.options.manual)return u.done(),_;for(_.options.offset&&("center"===_.options.offset?w.add(.5*_.el.width,.5*_.el.height).mult(1/x):w.vadd(_.options.offset).mult(1/x)),_.options.follow&&(w.vsub(_.options.follow.state.pos),w.sub(_.options.follow.state.vel.get(0)*A,_.options.follow.state.vel.get(1)*A)),!1!==t&&_.ctx.clearRect(0,0,_.el.width,_.el.height),1!==x&&(_.ctx.save(),_.ctx.scale(x,x)),c=0,P=C.length;P>c;++c)(r=C[c]).hidden||(r.view||(r.view=p.createView(r.geometry,r.styles||y[r.geometry.name])),p.drawBody(r,r.view,_.ctx,w));return 1!==x&&_.ctx.restore(),u.done(),_},this._layers[t]=_,_},removeLayer:function(t){var r=t.id?t.id:t,s=this._layers[r].el;return s!==this.el&&s.parentNode.removeChild(s),delete this._layers[r],this},resize:function(r,s){var c;for(var u in t.resize.call(this,r,s),this._layers)(c=this._layers[u]).options.autoResize&&(c.el.width=this.width,c.el.height=this.height);return this},setStyle:function(t,r){r=r||this.ctx,s.util.isObject(t)?(t.strokeStyle=t.lineWidth?t.strokeStyle:"rgba(0,0,0,0)",s.util.extend(r,t)):(r.fillStyle=r.strokeStyle=t,r.lineWidth=1)},drawCircle:function(t,r,s,u,p){(p=p||this.ctx).beginPath(),this.setStyle(u,p),p.arc(t,r,s,0,c,!1),p.closePath(),p.stroke(),p.fill()},drawPolygon:function(t,r,s){var c=t[0],u=c.x,p=c.y,v=t.length;(s=s||this.ctx).beginPath(),this.setStyle(r,s),s.moveTo(u,p);for(var y=1;v>y;++y)u=(c=t[y]).x,p=c.y,s.lineTo(u,p);v>2&&s.closePath(),s.stroke(),s.fill()},drawRect:function(t,r,s,c,u,p){var v=.5*s,y=.5*c;p=p||this.ctx,this.setStyle(u,p),p.beginPath(),p.rect(t-v,r-y,s,c),p.closePath(),p.stroke(),p.fill()},drawLine:function(t,r,s,c){var u=t.x,p=t.y;(c=c||this.ctx).beginPath(),this.setStyle(s,c),c.moveTo(u,p),u=r.x,p=r.y,c.lineTo(u,p),c.stroke(),c.fill()},draw:function(t,r,s,c){var u=t.name,p=+(c&&c.x),v=+(c&&c.y),y=t.aabb().hw;if(s=s||this.ctx,r=r||this.options.styles[u]||this.options.styles.circle||{},s.save(),s.translate(p,v),"circle"===u)this.drawCircle(0,0,t.radius,r,s);else if("convex-polygon"===u)this.drawPolygon(t.vertices,r,s);else if("rectangle"===u)this.drawRect(0,0,t.width,t.height,r,s);else if("compound"===u)for(var _,w=0,x=t.children.length;x>w;w++)_=t.children[w],s.translate(_.pos.x,_.pos.y),s.rotate(_.angle),this.draw(_.g,r,s),s.rotate(-_.angle),s.translate(-_.pos.x,-_.pos.y);else this.drawCircle(0,0,1,r,s);return"compound"!==u&&r.angleIndicator&&(s.beginPath(),this.setStyle(r.angleIndicator,s),s.moveTo(0,0),s.lineTo(y,0),s.closePath(),s.stroke()),s.restore(),this},createView:function(t,r){var s,c=t.aabb(),u=c.hw+Math.abs(c.x),p=c.hh+Math.abs(c.y),v={x:u+1,y:p+1},y=this.hiddenCtx,_=this.hiddenCanvas;return(r=r||this.options.styles[name]||this.options.styles.circle||{}).src?((s=new Image).src=r.src,r.width&&(s.width=r.width),r.height&&(s.height=r.height),s):(v.x+=0|r.lineWidth,v.y+=0|r.lineWidth,_.width=2*u+2+(2*r.lineWidth|0),_.height=2*p+2+(2*r.lineWidth|0),this.draw(t,r,y,v),(s=new Image(_.width,_.height)).src=_.toDataURL("image/png"),s)},drawMeta:function(t){this.els.fps.innerHTML=t.fps.toFixed(2),this.els.ipf.innerHTML=t.ipf},drawBody:function(t,r,s,c){var u,p,v,y=t.state.pos,_=t.offset,w=t.state.vel,x=this._interpolateTime||0;c=c||this.options.offset,s=s||this.ctx,u=y._[0]+c.x+w._[0]*x,p=y._[1]+c.y+w._[1]*x,v=t.state.angular.pos+t.state.angular.vel*x,s.save(),s.translate(u,p),s.rotate(v),s.translate(_._[0],_._[1]),s.drawImage(r,-r.width/2,-r.height/2,r.width,r.height),s.restore()},render:function(t,r){for(var s in this._world.emit("beforeRender",{renderer:this,meta:r}),this.options.meta&&this.drawMeta(r),this._interpolateTime=r.interpolateTime,this._layers)this._layers[s].render();return this}}})),s.renderer("dom",(function(t){if(!r)return{};var s={},c=r.createElement("div"),e=function(t){return t.replace(/(?:^|\s)\w/g,(function(t){return t.toUpperCase()}))},f=function(t){if(s[t])return s[t];for(var r,u=["Webkit","Moz","Ms","O"],p=0,v=u.length;v>p;++p)if((r=u[p]+e(t))in c.style)return s[t]=r;return r in c.style&&(s[t]=t)},u="pjs-",p="px",v=f("transform"),y=f("borderRadius"),k=function(t,s){var c=r.createElement(t||"div");return s&&(c.innerHTML=s),c};return{init:function(r){t.init.call(this,r);var s=this.el;if(s.style.position="relative",s.style.overflow="hidden",s.style[v]="translateZ(0)",s.style.width=this.options.width+p,s.style.height=this.options.height+p,this.els={},r.meta){var c=k();c.className="pjs-meta",this.els.fps=k("span"),this.els.ipf=k("span"),c.appendChild(k("span","fps: ")),c.appendChild(this.els.fps),c.appendChild(k("br")),c.appendChild(k("span","ipf: ")),c.appendChild(this.els.ipf),s.appendChild(c)}this.options.autoResize?this.resize():this.resize(this.options.width,this.options.height)},resize:function(r,s){t.resize.call(this,r,s),this.el.style.width=this.width+p,this.el.style.height=this.height+p},pointProperties:function(t){t.style.width="2px",t.style.height="2px",t.style.marginLeft="-1px",t.style.marginTop="-1px",t.style[y]="50%"},circleProperties:function(t,r){var s=r.aabb();t.style.width=2*s.hw+p,t.style.height=2*s.hh+p,t.style.marginLeft=-s.hw+p,t.style.marginTop=-s.hh+p,t.style[y]="50%"},rectangleProperties:function(t,r){var s=r.aabb();t.style.width=2*s.hw+p,t.style.height=2*s.hh+p,t.style.marginLeft=-s.hw+p,t.style.marginTop=-s.hh+p},createView:function(t){var r,s=k(),c=t.name+"Properties";if(s.className=u+t.name,s.style.position="absolute",s.style.top="0px",s.style.left="0px","compound"===t.name)for(var p,y=0,_=t.children.length;_>y;y++)p=t.children[y],(r=k()).className=u+t.name+" "+u+"child",r.style.position="absolute",r.style.top="0px",r.style.left="0px",this[p.g.name+"Properties"]&&this[p.g.name+"Properties"](r,p.g),r.style[v]="translate("+p.pos._[0]+"px,"+p.pos._[1]+"px) rotate("+p.angle+"rad)",s.appendChild(r);else this[c]&&this[c](s,t);return this.el.appendChild(s),s},connect:function(t){t.on("add:body",this.attach,this),t.on("remove:body",this.detach,this)},disconnect:function(t){t.off("add:body",this.attach,this),t.off("remove:body",this.detach,this)},detach:function(t){var r=t.nodeType&&t||t.body&&t.body.view,s=r&&r.parentNode;return r&&s&&s.removeChild(r),this},attach:function(t){var r=t.nodeType&&t||t.body&&t.body.view;return r&&this.el.appendChild(r),this},drawMeta:function(t){this.els.fps.innerHTML=t.fps.toFixed(2),this.els.ipf.innerHTML=t.ipf},drawBody:function(t,r){var s,c,u,p=t.state.pos,y=t.state.vel,_=t.offset,w=this._interpolateTime;s=p._[0]+y._[0]*w,c=p._[1]+y._[1]*w,u=t.state.angular.pos+t.state.angular.vel*w,r.style[v]="translate("+s+"px,"+c+"px) rotate("+u+"rad) translate("+_._[0]+"px,"+_._[1]+"px)"}}})),s.renderer("pixi",(function(c){if(!r)return{};var u=(Math.PI,{white:"0xFFFFFF",violet:"0x542437",blue:"0x53777A"}),p={font:"18px monospace",fill:"black",align:"left"},v={metaEl:null,offset:{x:0,y:0},styles:{color:!1,point:u.blue,circle:{strokeStyle:u.blue,lineWidth:1,fillStyle:u.blue,angleIndicator:u.white,fillAlpha:1,strokeAlpha:1,alpha:1},rectangle:{strokeStyle:u.violet,lineWidth:1,fillStyle:u.violet,angleIndicator:u.white,fillAlpha:1,strokeAlpha:1,alpha:1},"convex-polygon":{strokeStyle:u.violet,lineWidth:1,fillStyle:u.violet,angleIndicator:u.white,fillAlpha:1,strokeAlpha:1,alpha:1}}};return{init:function(u){var p,y,_=this;if("undefined"==typeof PIXI)throw"PIXI not present - cannot continue";c.init.call(this,u),this.options.defaults(v,!0),this.options.onChange((function(){_.options.offset=new s.vector(_.options.offset)})),this.options(u,!0),y=!this.options.styles.color||"transparent"===this.options.styles.color,this.stage=new PIXI.Stage(this.options.styles.color),this.meta={},p=this.el&&"CANVAS"===this.el.nodeName?p:null,this.renderer=new PIXI.autoDetectRenderer(this.options.width,this.options.height,{view:p,transparent:y,resolution:t.devicePixelRatio||1}),p||(this.el=this.el||r.body,this.el.appendChild(this.renderer.view)),this.options.autoResize?this.resize():this.resize(this.options.width,this.options.height)},resize:function(t,r){c.resize.call(this,t,r),this.renderer.resize(this.width,this.height)},connect:function(t){t.on("add:body",this.attach,this),t.on("remove:body",this.detach,this)},disconnect:function(t){t.off("add:body",this.attach,this),t.off("remove:body",this.detach,this)},detach:function(t){var r=t instanceof PIXI.Graphics&&t||t.body&&t.body.view;return r&&this.stage.removeChild(r),this},attach:function(t){var r=t instanceof PIXI.Graphics&&t||t.body&&t.body.view;return r&&this.stage.addChild(r),this},loadSpriteSheets:function(t,r){if(!s.util.isArray(t))throw"Spritesheets must be defined in arrays";var c=this,u=new PIXI.AssetLoader(t);return u.load(),u.on("onComplete",(function(){c.assetsLoaded=!0,r()})),c},drawBody:function(t,r){var s,c,u,p=t.state.pos,v=t.state.vel,y=t.offset,_=this._interpolateTime||0;s=p._[0]+v._[0]*_,c=p._[1]+v._[1]*_,u=t.state.angular.pos+t.state.angular.vel*_,r.position.set(s,c),r.pivot.set(-y._[0],-y._[1]),r.rotation=u},render:function(t,r){c.render.call(this,t,r),this.renderer.render(this.stage)},setStyles:function(t,r){return s.util.isObject(r)?(r.fillStyle&&"transparent"!==r.fillStyle?(t.beginFill(r.fillStyle),t.fillAlpha=void 0!==r.fillAlpha?r.fillAlpha:1):(t.beginFill(),t.fillAlpha=0),t.lineStyle(r.lineWidth||0,r.strokeStyle,void 0!==r.strokeAlpha?r.strokeAlpha:1),t.alpha=void 0!==r.alpha?r.alpha:1):(r&&"transparent"!==r?t.beginFill(r):(t.beginFill(),t.fillAlpha=0),t.lineStyle(0)),t},createCircle:function(t,r,s,c){var u=new PIXI.Graphics;return this.setStyles(u,c),u.drawCircle(t,r,s),u.endFill(),u},createRect:function(t,r,s,c,u){var p=new PIXI.Graphics;return this.setStyles(p,u),p.drawRect(t,r,s,c),p.endFill(),p},createPolygon:function(t,r){var s=t[0],c=s.x,u=s.y,p=t.length,v={x:c,y:u},y=new PIXI.Graphics;this.setStyles(y,r),y.moveTo(c,u);for(var _=1;p>_;++_)c=(s=t[_]).x,u=s.y,y.lineTo(c,u);return p>2&&y.lineTo(v.x,v.y),y.endFill(),y},createLine:function(t,r,s){var c=t.x,u=t.y,p=new PIXI.Graphics;return this.setStyles(p,s),p.moveTo(c,u),c=r.x,u=r.y,p.lineTo(c,u),p.endFill(),p},createView:function(t,r,s){var c=null,u=t.aabb(),p=u.hw+Math.abs(u.x),v=(u.hh,Math.abs(u.y),t.name);if(s=s||this.stage,(r=r||this.options.styles[v]||this.options.styles.circle||{}).src)return(c=PIXI.Sprite.fromImage(r.src)).anchor.set(.5,.5),r.anchor&&(c.anchor.x=r.anchor.x,c.anchor.y=r.anchor.y),r.width&&(c.width=r.width),r.height&&(c.height=r.height),s.addChild(c),c;if("circle"===v)c=this.createCircle(0,0,t.radius,r);else if("convex-polygon"===v)c=this.createPolygon(t.vertices,r);else if("rectangle"===v)c=this.createRect(-t.width/2,-t.height/2,t.width,t.height,r);else if("compound"===v){c=new PIXI.Graphics;for(var y,_,w=0,x=t.children.length;x>w;w++)y=t.children[w],(_=this.createView(y.g,r,c)).position.set(y.pos.x,y.pos.y),_.rotation=y.angle}else c=this.createCircle(0,0,1,r);return"compound"!==v&&r.angleIndicator&&"transparent"!==r.angleIndicator&&(c.lineStyle(r.lineWidth,r.angleIndicator),c.moveTo(0,0),c.lineTo(p,0)),"compound"!==v&&(c.cacheAsBitmap=!0),s.addChild(c),c},drawMeta:function(t){this.meta.loaded?(this.meta.fps.setText("FPS: "+t.fps.toFixed(2)),this.meta.ipf.setText("IPF: "+t.ipf)):(this.meta.fps=new PIXI.Text("FPS: "+t.fps.toFixed(2),p),this.meta.fps.position.x=15,this.meta.fps.position.y=5,this.meta.ipf=new PIXI.Text("IPF: "+t.ipf,p),this.meta.ipf.position.x=15,this.meta.ipf.position.y=30,this.stage.addChild(this.meta.fps),this.stage.addChild(this.meta.ipf),this.meta.loaded=!0)},createDisplay:function(t,r){var s=null,c=null;switch(t){case"sprite":return c=PIXI.Texture.fromImage(r.texture),s=new PIXI.Sprite(c),r.anchor&&(s.anchor.x=r.anchor.x,s.anchor.y=r.anchor.y),r.container?r.container.addChild(s):this.stage.addChild(s),s;case"movieclip":if(!this.assetsLoaded)throw"No assets have been loaded. Use loadSpritesheet() first";for(var u=[],p=0;p<r.frames.length;p++)c=PIXI.Texture.fromFrame(r.frames[p]),u.push(c);return s=new PIXI.MovieClip(u),r.anchor&&(s.anchor.x=r.anchor.x,s.anchor.y=r.anchor.y),r.container?r.container.addChild(s):this.stage.addChild(s),s;default:throw"Invalid PIXI.DisplayObject passed"}},centerAnchor:function(t){null!==t&&(t.anchor.x=.5,t.anchor.y=.5)}}})),s}));