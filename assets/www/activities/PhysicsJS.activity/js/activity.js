/*! Sugarizer 2020-03-14 */
define(["sugar-web/activity/activity","tutorial","webL10n","sugar-web/env"],function(a,b,c,d){requirejs(["domReady!"],function(e){a.setup(),d.getEnvironment(function(a,b){currentenv=b;var d="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,e=b.user?b.user.language:d;c.language.code=e});var f=navigator.userAgent.toLowerCase(),g=document.getElementById("sensor-button"),h=document.getElementById("gravity-button"),i=document.getElementById("apple-button"),j=document.getElementById("run-button"),k=!1,l=!0,m=!1,n=null;-1!=f.indexOf("android")||-1!=f.indexOf("iphone")||-1!=f.indexOf("ipad")||-1!=f.indexOf("ipod")||-1!=f.indexOf("mozilla/5.0 (mobile")?(document.addEventListener("deviceready",function(){k=!0},!1),g.disabled=!1,g.classList.add("active")):g.disabled=!0;var o=document.getElementById("body"),p=o.offsetWidth,q=o.offsetHeight,r=55,s=0,t=!1,u=0,v=0,w=!0;Physics({timestep:6},function(c){function d(a){l&&(a.x<-4.5?G(a.y>4.75?3:a.y<-4.75?5:4):a.x<=4.5&&a.x>=-4.5?a.y>4.75?G(2):a.y<-4.75&&G(6):a.x>4.5&&G(a.y>4.75?1:a.y<-4.75?7:0))}function e(){if(1!=window.devicePixelRatio){var a=document.getElementById("viewport").children[0],b=1/window.devicePixelRatio;a.style.zoom=b;-1==navigator.userAgent.toLowerCase().indexOf("chrome")&&(a.style.MozTransform="scale("+b+")",a.style.MozTransformOrigin="0 0"),c.wakeUpAll()}}function f(a,b){return Math.random()*(b-a)+a|0}function x(a){document.getElementById("box-button").classList.remove("active"),document.getElementById("circle-button").classList.remove("active"),document.getElementById("polygon-button").classList.remove("active"),document.getElementById("triangle-button").classList.remove("active"),document.getElementById("clear-button").classList.remove("active"),0==a?document.getElementById("circle-button").classList.add("active"):1==a?document.getElementById("box-button").classList.add("active"):2==a?document.getElementById("triangle-button").classList.add("active"):3==a?document.getElementById("polygon-button").classList.add("active"):-1==a&&document.getElementById("clear-button").classList.add("active")}function y(a,b){var d,e;switch(a){case 0:e=L[f(0,L.length-1)],d=Physics.body("circle",{x:b.x,y:b.y,vx:f(-5,5)/100,radius:40,restitution:.9,styles:{fillStyle:e[0],strokeStyle:e[1],lineWidth:1,angleIndicator:e[1]}});break;case 1:e=L[f(0,L.length-1)];var g=f(0,70);d=Physics.body("rectangle",{width:50+g,height:50+g,x:b.x,y:b.y,vx:f(-5,5)/100,restitution:.9,styles:{fillStyle:e[0],strokeStyle:e[1],lineWidth:1,angleIndicator:e[1]}});break;case 2:case 3:var h=2==a?3:f(5,10);e=L[f(0,L.length-1)],d=Physics.body("convex-polygon",{vertices:Physics.geometry.regularPolygonVertices(h,30),x:b.x,y:b.y,vx:f(-5,5)/100,angle:f(0,2*Math.PI),restitution:.9,styles:{fillStyle:e[0],strokeStyle:e[1],lineWidth:1,angleIndicator:e[1]}})}return d.treatment="static",c.add(d),d}function z(b){for(var d=c.getBodies(),e=[],f=0;f<d.length;f++){var g=A(d[f]);e.push(g)}var h=a.getDatastoreObject(),i=JSON.stringify({world:e});h.setDataAsText(i),h.save(b)}function A(a){var b={};return b.type=a.geometry.name,"circle"==b.type?b.radius=a.radius:"rectangle"==a.geometry.name?(b.width=a.view.width,b.height=a.view.height):"convex-polygon"==a.geometry.name&&(b.vertices=a.vertices),b.restitution=a.restitution,b.styles=a.styles,b.x=a.view.x,b.y=a.view.y,b}function B(b){a.getDatastoreObject().loadAsText(function(a,b,d){var d=JSON.parse(d);if(null!=d)for(var e=d.world,f=0;f<e.length;f++){var g=C(e[f]);c.add(g)}})}function C(a){var b={x:a.x,y:a.y,restitution:a.restitution,styles:a.styles};return a.angle&&(b.angle=a.angle),"circle"==a.type?b.radius=a.radius:"rectangle"==a.type?(b.width=a.width,b.height=a.height):(a.type="convex-polygon")&&(b.vertices=a.vertices),Physics.body(a.type,b)}function D(){c.getBodies().forEach(function(a,b,c){a.treatment="static"})}function E(){c.getBodies().forEach(function(a,b,c){a.treatment="dynamic"})}function F(){w?(document.getElementById("run-button").classList.remove("running"),document.getElementById("run-button").setAttribute("title","Play"),D()):(document.getElementById("run-button").classList.add("running"),document.getElementById("run-button").setAttribute("title","Pause"),Physics.util.ticker.start(),E()),w=!w}function G(a){if(u!=a){var b={};switch(a){case 0:b={x:0,y:4e-4};break;case 1:b={x:4e-4,y:4e-4};break;case 2:b={x:4e-4,y:0};break;case 3:b={x:4e-4,y:-4e-4};break;case 4:b={x:0,y:-4e-4};break;case 5:b={x:-4e-4,y:-4e-4};break;case 6:b={x:-4e-4,y:0};break;case 7:b={x:-4e-4,y:4e-4}}var d=-90==window.orientation?-1:1;b={x:b.x*d,y:b.y*d},document.getElementById("gravity-button").style.backgroundImage="url(icons/gravity"+(-1==d?(a+4)%8:a)+".svg)",O.setAcceleration(b),c.wakeUpAll(),u=a}}var H,I,J=Physics.aabb(0-s,r,p+s,q);requirejs(["pixi"],function(a){window.PIXI=a,I=Physics.renderer("pixi",{el:"viewport"}),c.add(I),c.on("step",function(){c.render(),t||(t=!0,e()),k&&(watchId=navigator.accelerometer.watchAcceleration(d,null,{frequency:500}),k=!1)}),c.add(Physics.behavior("interactive",{el:I.container}))}),H=Physics.behavior("edge-collision-detection",{aabb:J,restitution:.2,cof:.8}),window.addEventListener("resize",function(){n&&clearTimeout(n),resizerTimer=setTimeout(function(){I.resize(o.offsetWidth,o.offsetHeight),J=Physics.aabb(0-s,r,I.width+s,I.height),H.setAABB(J),p=o.offsetWidth,q=o.offsetHeight,e()},500)},!0),document.getElementById("box-button").addEventListener("click",function(a){v=1,x(v)},!0),document.getElementById("circle-button").addEventListener("click",function(a){v=0,x(v)},!0),document.getElementById("triangle-button").addEventListener("click",function(a){v=2,x(v)},!0),document.getElementById("polygon-button").addEventListener("click",function(a){v=3,x(v)},!0),h.addEventListener("click",function(){G((u+1)%8)},!0),j.addEventListener("click",function(){F()},!0),document.getElementById("clear-button").addEventListener("click",function(){v=-1,x(v)},!0),document.getElementById("help-button").addEventListener("click",function(a){b.start()}),document.getElementById("fullscreen-button").addEventListener("click",function(){document.getElementById("main-toolbar").style.opacity=0,document.getElementById("unfullscreen-button").style.visibility="visible",r=0,document.dispatchEvent(new Event("resize")),event.preventDefault()}),document.getElementById("unfullscreen-button").addEventListener("click",function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("unfullscreen-button").style.visibility="hidden",r=55,document.dispatchEvent(new Event("resize")),event.preventDefault()}),g.addEventListener("click",function(){l=!l,l?g.classList.add("active"):g.classList.remove("active")},!0),i.addEventListener("click",function(){m=!m,m?(c.remove(O),c.add(P),i.classList.add("active"),h.disabled=!0):(c.remove(P),c.add(O),i.classList.remove("active"),h.disabled=!1)},!0),B(),document.getElementById("stop-button").addEventListener("click",function(a){console.log("writing..."),z(function(a){null===a?console.log("write done."):console.log("write failed.")})});var K=function(){I?I.resize(o.offsetWidth,o.offsetHeight):setTimeout(K,300)};setTimeout(K,300);var L=[["0x268bd2","0x0d394f"],["0xc93b3b","0x561414"],["0xe25e36","0x79231b"],["0x6c71c4","0x393f6a"],["0x58c73c","0x30641c"],["0xcac34c","0x736a2c"]],M=null,N=null;c.on({"interact:poke":function(a){-1!=v&&a.y>55&&(M=y(v,a),N=a)},"interact:move":function(a){if(null!=M){var b=N.x-a.x,d=N.y-a.y,e=Math.min(Math.sqrt(Math.abs(b*b-d*d)),N.y-r);if(null!=M.view){var f=A(M);"circle"==f.type?f.radius=Math.max(40,e):"rectangle"==f.type?f.width=f.height=Math.max(50,e):(f.type="convex-polygon")&&(f.vertices=Physics.geometry.regularPolygonVertices(f.vertices.length,Math.max(30,e))),c.removeBody(M);var g=new Physics.vector(N.x,0),h=new Physics.vector(a.x-N.x,a.y-N.y);f.angle=-g.angle(h),M=C(f),M.treatment="static",c.add(M)}}},"interact:release":function(a){w&&(null!=M&&(M.treatment="dynamic"),c.wakeUpAll()),M=null},"interact:grab":function(a){-1==v&&c.remove(a.body)}});var O=Physics.behavior("constant-acceleration"),P=Physics.behavior("newtonian",{strength:.5});c.add([O,Physics.behavior("body-impulse-response"),Physics.behavior("body-collision-detection"),Physics.behavior("sweep-prune"),H]),Physics.util.ticker.on(function(a){c.step(a);var b=c.getBodies(),d=s/2;if(d>0)for(var e=0;e<b.length;e++){var f=b[e];(f.state.pos.x<0-d||f.state.pos.x>p+d)&&c.remove(f)}})})})});