define(["sugar-web/activity/activity","tutorial","webL10n","sugar-web/env"],(function(e,t,n,i){requirejs(["domReady!"],(function(o){e.setup(),i.getEnvironment((function(e,t){currentenv=t;var i="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,o=t.user?t.user.language:i;n.language.code=o}));var a=navigator.userAgent.toLowerCase(),c=document.getElementById("sensor-button"),s=document.getElementById("gravity-button"),r=document.getElementById("apple-button"),d=document.getElementById("run-button"),l=!1,u=!0,y=!1;-1!=a.indexOf("android")||-1!=a.indexOf("iphone")||-1!=a.indexOf("ipad")||-1!=a.indexOf("ipod")||-1!=a.indexOf("mozilla/5.0 (mobile")?(document.addEventListener("deviceready",(function(){l=!0}),!1),c.disabled=!1,c.classList.add("active")):c.disabled=!0;var m=document.getElementById("body"),v=m.offsetWidth,g=m.offsetHeight,h=55,f=!1,b=0,x=0,p=!0;Physics({timestep:6},(function(n){var i,o,a=Physics.aabb(0,h,v+0,g);function accelerationChanged(e){u&&(e.x<-4.5?e.y>4.75?setGravity(3):e.y<-4.75?setGravity(5):setGravity(4):e.x<=4.5&&e.x>=-4.5?e.y>4.75?setGravity(2):e.y<-4.75&&setGravity(6):e.x>4.5&&(e.y>4.75?setGravity(1):e.y<-4.75?setGravity(7):setGravity(0)))}requirejs(["pixi"],(function(e){window.PIXI=e,o=Physics.renderer("pixi",{el:"viewport"}),n.add(o),n.on("step",(function(){n.render(),f||(f=!0,zoom()),l&&(watchId=navigator.accelerometer.watchAcceleration(accelerationChanged,null,{frequency:500}),l=!1)})),n.add(Physics.behavior("interactive",{el:o.container}))})),i=Physics.behavior("edge-collision-detection",{aabb:a,restitution:.2,cof:.8}),window.addEventListener("resize",(function(){resizerTimer=setTimeout((function(){o.resize(m.offsetWidth,m.offsetHeight),a=Physics.aabb(0,h,o.width+0,o.height),i.setAABB(a),v=m.offsetWidth,g=m.offsetHeight,zoom()}),500)}),!0),document.getElementById("box-button").addEventListener("click",(function(e){switchToType(x=1)}),!0),document.getElementById("circle-button").addEventListener("click",(function(e){switchToType(x=0)}),!0),document.getElementById("triangle-button").addEventListener("click",(function(e){switchToType(x=2)}),!0),document.getElementById("polygon-button").addEventListener("click",(function(e){switchToType(x=3)}),!0),s.addEventListener("click",(function(){setGravity((b+1)%8)}),!0),d.addEventListener("click",(function(){!function togglePause(){p?(document.getElementById("run-button").classList.remove("running"),document.getElementById("run-button").setAttribute("title","Play"),function setBodiesTreatmentStatic(){n.getBodies().forEach((function(e,t,n){e.treatment="static"}))}()):(document.getElementById("run-button").classList.add("running"),document.getElementById("run-button").setAttribute("title","Pause"),Physics.util.ticker.start(),function setBodiesTreatmentDynamic(){n.getBodies().forEach((function(e,t,n){e.treatment="dynamic"}))}());p=!p}()}),!0),document.getElementById("clear-button").addEventListener("click",(function(){switchToType(x=-1)}),!0),document.getElementById("help-button").addEventListener("click",(function(e){t.start()})),document.getElementById("fullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.opacity=0,document.getElementById("unfullscreen-button").style.visibility="visible",h=0,document.dispatchEvent(new Event("resize")),event.preventDefault()})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("unfullscreen-button").style.visibility="hidden",h=55,document.dispatchEvent(new Event("resize")),event.preventDefault()})),c.addEventListener("click",(function(){(u=!u)?c.classList.add("active"):c.classList.remove("active")}),!0),r.addEventListener("click",(function(){(y=!y)?(n.remove(I),n.add(L),r.classList.add("active"),s.disabled=!0):(n.remove(L),n.add(I),r.classList.remove("active"),s.disabled=!1)}),!0),function loadWorld(t){e.getDatastoreObject().loadAsText((function(e,t,i){if(null!=(i=JSON.parse(i)))for(var o=i.world,a=0;a<o.length;a++){var c=deserializeObject(o[a]);n.add(c)}}))}(),document.getElementById("stop-button").addEventListener("click",(function(t){console.log("writing..."),function saveWorld(t){for(var i=n.getBodies(),o=[],a=0;a<i.length;a++){var c=serializeObject(i[a]);o.push(c)}var s=e.getDatastoreObject(),r=JSON.stringify({world:o});s.setDataAsText(r),s.save(t)}((function(e){null===e?console.log("write done."):console.log("write failed.")}))}));var initialResize=function(){o?o.resize(m.offsetWidth,m.offsetHeight):setTimeout(initialResize,300)};setTimeout(initialResize,300);var E=[["0x268bd2","0x0d394f"],["0xc93b3b","0x561414"],["0xe25e36","0x79231b"],["0x6c71c4","0x393f6a"],["0x58c73c","0x30641c"],["0xcac34c","0x736a2c"]];function zoom(){if(1!=window.devicePixelRatio){var e=document.getElementById("viewport").children[0],t=1/window.devicePixelRatio;e.style.zoom=t,-1==navigator.userAgent.toLowerCase().indexOf("chrome")&&(e.style.MozTransform="scale("+t+")",e.style.MozTransformOrigin="0 0"),n.wakeUpAll()}}function random(e,t){return Math.random()*(t-e)+e|0}function switchToType(e){document.getElementById("box-button").classList.remove("active"),document.getElementById("circle-button").classList.remove("active"),document.getElementById("polygon-button").classList.remove("active"),document.getElementById("triangle-button").classList.remove("active"),document.getElementById("clear-button").classList.remove("active"),0==e?document.getElementById("circle-button").classList.add("active"):1==e?document.getElementById("box-button").classList.add("active"):2==e?document.getElementById("triangle-button").classList.add("active"):3==e?document.getElementById("polygon-button").classList.add("active"):-1==e&&document.getElementById("clear-button").classList.add("active")}function serializeObject(e){var t={};return t.type=e.geometry.name,"circle"==t.type?t.radius=e.radius:"rectangle"==e.geometry.name?(t.width=e.view.width,t.height=e.view.height):"convex-polygon"==e.geometry.name&&(t.vertices=e.vertices),t.restitution=e.restitution,t.styles=e.styles,t.x=e.view.x,t.y=e.view.y,t}function deserializeObject(e){var t={x:e.x,y:e.y,restitution:e.restitution,styles:e.styles};return e.angle&&(t.angle=e.angle),"circle"==e.type?t.radius=e.radius:"rectangle"==e.type?(t.width=e.width,t.height=e.height):(e.type="convex-polygon")&&(t.vertices=e.vertices),Physics.body(e.type,t)}function setGravity(e){if(b!=e){var t={};switch(e){case 0:t={x:0,y:4e-4};break;case 1:t={x:4e-4,y:4e-4};break;case 2:t={x:4e-4,y:0};break;case 3:t={x:4e-4,y:-4e-4};break;case 4:t={x:0,y:-4e-4};break;case 5:t={x:-4e-4,y:-4e-4};break;case 6:t={x:-4e-4,y:0};break;case 7:t={x:-4e-4,y:4e-4}}var i=-90==window.orientation?-1:1;t={x:t.x*i,y:t.y*i},document.getElementById("gravity-button").style.backgroundImage="url(icons/gravity"+(-1==i?(e+4)%8:e)+".svg)",I.setAcceleration(t),n.wakeUpAll(),b=e}}var w=null,B=null;n.on({"interact:poke":function(e){-1!=x&&e.y>55&&(w=function dropInBody(e,t){var i,o;switch(e){case 0:o=E[random(0,E.length-1)],i=Physics.body("circle",{x:t.x,y:t.y,vx:random(-5,5)/100,radius:40,restitution:.9,styles:{fillStyle:o[0],strokeStyle:o[1],lineWidth:1,angleIndicator:o[1]}});break;case 1:o=E[random(0,E.length-1)];var a=random(0,70);i=Physics.body("rectangle",{width:50+a,height:50+a,x:t.x,y:t.y,vx:random(-5,5)/100,restitution:.9,styles:{fillStyle:o[0],strokeStyle:o[1],lineWidth:1,angleIndicator:o[1]}});break;case 2:case 3:var c=2==e?3:random(5,10);o=E[random(0,E.length-1)],i=Physics.body("convex-polygon",{vertices:Physics.geometry.regularPolygonVertices(c,30),x:t.x,y:t.y,vx:random(-5,5)/100,angle:random(0,2*Math.PI),restitution:.9,styles:{fillStyle:o[0],strokeStyle:o[1],lineWidth:1,angleIndicator:o[1]}})}return i.treatment="static",n.add(i),i}(x,e),B=e)},"interact:move":function(e){if(null!=w){var t=B.x-e.x,i=B.y-e.y,o=Math.min(Math.sqrt(Math.abs(t*t-i*i)),B.y-h);if(null!=w.view){var a=serializeObject(w);"circle"==a.type?a.radius=Math.max(40,o):"rectangle"==a.type?a.width=a.height=Math.max(50,o):(a.type="convex-polygon")&&(a.vertices=Physics.geometry.regularPolygonVertices(a.vertices.length,Math.max(30,o))),n.removeBody(w);var c=new Physics.vector(B.x,0),s=new Physics.vector(e.x-B.x,e.y-B.y);a.angle=-c.angle(s),(w=deserializeObject(a)).treatment="static",n.add(w)}}},"interact:release":function(e){p&&(null!=w&&(w.treatment="dynamic"),n.wakeUpAll()),w=null},"interact:grab":function(e){-1==x&&n.remove(e.body)}});var I=Physics.behavior("constant-acceleration"),L=Physics.behavior("newtonian",{strength:.5});n.add([I,Physics.behavior("body-impulse-response"),Physics.behavior("body-collision-detection"),Physics.behavior("sweep-prune"),i]),Physics.util.ticker.on((function(e){n.step(e);n.getBodies()}))}))}))}));