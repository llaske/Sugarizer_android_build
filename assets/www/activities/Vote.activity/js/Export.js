var Export={template:'\n\t\t<div class="export-container">\n\t\t\t<poll-stats \n\t\t\t\tv-for="(poll, i) in history" \n\t\t\t\t:key="i"\n\t\t\t\t:ref="\'export-\' + i"\n\t\t\t\t:id="\'export-\' + i" \n\t\t\t\t:activePoll="poll" \n\t\t\t\t:current-user="currentUser" \n\t\t\t\t:exportingDoc="exporting == \'doc\'"\n\t\t\t\tisResult \n\t\t\t\tisHistory\n\t\t\t\t@animation-complete="loadedStats++"\n\t\t\t></poll-stats>\n\t\t</div>\n\t',components:{ImageURL:ImageURL,"poll-stats":PollStats},props:["history","currentUser","exporting"],data:()=>({totalStats:0,loadedStats:0,l10n:{stringUsers:"",stringVotes:"",stringDate:"",stringYes:"",stringNo:"",stringAvgRating:""}}),computed:{statsLoaded(){return this.totalStats==this.loadedStats}},watch:{statsLoaded:function(t,e){if(t)switch(this.exporting){case"doc":this.generateDOC();break;case"odt":this.generateODT();break;case"pdf":this.generatePDF()}}},created(){this.totalStats=this.history.length},mounted:function(){switch(this.$root.$refs.SugarL10n.localize(this.l10n),this.exporting){case"csv":this.generateCSV()}},methods:{canvasToImage:t=>new Promise((e,o)=>{var r=new Image;r.src=t,r.onload=()=>{if(-1==t.indexOf("data:image/png")){var o=document.createElement("canvas");o.width=r.width,o.height=r.height,o.getContext("2d").drawImage(r,0,0),e({dataURL:o.toDataURL("image/png"),width:r.width,height:r.height,canvas:o})}else e({dataURL:t,width:r.width,height:r.height,canvas:null})}}),generateCSV:function(){console.log("Exporting CSV...");var t="";for(let e=this.history.length-1;e>=0;e--){let o,r=this.history[e],s=new Date(r.endTime).toLocaleString();switch(t+=`"${r.type}"`,t+=`,"${r.question}"`,t+=`,"${this.l10n.stringUsers}"`,t+=`,"${this.l10n.stringDate}"`,t+="\n",r.typeVariable){case"YesNo":o=new Array(2),o.fill(0);for(let t of r.results.answers)o[t?1:0]++;t+=`"${this.l10n.stringNo}","${o[0]}"`,t+=`,"${r.results.counts.usersCount}"`,t+=`,"${s}"`,t+="\n",t+=`"${this.l10n.stringYes}","${o[1]}"`,t+=`,"${r.results.counts.usersCount}"`,t+=`,"${s}"`,t+="\n";break;case"Rating":o=new Array(5),o.fill(0);for(let t of r.results.answers)o[t-1]++;for(let e=1;e<=5;e++)t+=`"${e}","${o[e-1]}"`,t+=`,"${r.results.counts.usersCount}"`,t+=`,"${s}"`,t+="\n";break;case"Text":let e={};for(let t of r.results.answers){let o=t.split(",");for(let t of o){let o=t.trim().toLowerCase();e[o]?e[o]++:e[o]=1}}for(let o in e)t+=`"${o}","${e[o]}"`,t+=`,"${r.results.counts.usersCount}"`,t+=`,"${s}"`,t+="\n";break;case"MCQ":o=new Array(r.options.length),o.fill(0);for(let t of r.results.answers)o[t]++;for(let e in r.options)t+=`"${r.options[e]}","${o[e]}"`,t+=`,"${r.results.counts.usersCount}"`,t+=`,"${s}"`,t+="\n";break;case"ImageMCQ":o=new Array(r.options.length),o.fill(0);for(let t of r.results.answers)o[t]++;for(let e in r.options)t+=`"${parseInt(e)+1}","${o[e]}"`,t+=`,"${r.results.counts.usersCount}"`,t+=`,"${s}"`,t+="\n"}t+="\n"}var e={mimetype:"text/plain",title:this.$root.$refs.SugarL10n.get("ExportFileName",{userName:this.currentUser.name})+".txt",activity:"org.olpcfrance.Vote",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0},o=this;this.$root.$refs.SugarJournal.createEntry(t,e).then(()=>{o.$root.$refs.SugarPopup.log(this.$root.$refs.SugarL10n.get("ExportTo",{format:"CSV"})),console.log("Export to CSV complete"),o.$emit("export-completed")})},generateODT(){console.log("Exporting ODT..."),this.constructODT().then(t=>{var e="data:application/vnd.oasis.opendocument.text;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(t))),o={mimetype:"application/vnd.oasis.opendocument.text",title:this.$root.$refs.SugarL10n.get("ExportFileName",{userName:this.currentUser.name})+".odt",activity:"org.olpcfrance.Vote",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0},r=this;this.$root.$refs.SugarJournal.createEntry(e,o).then(()=>{r.$root.$refs.SugarPopup.log(this.$root.$refs.SugarL10n.get("ExportTo",{format:"ODT"})),console.log("Export to ODT complete"),r.$emit("export-completed")})})},loadODT:()=>new Promise((t,e)=>{requirejs(["js/odtHelper.js"],(function(e){t(e)}))}),constructODT(){let t=this;return new Promise((e,o)=>{t.loadODT().then(async o=>{let r=o.xml;t.addHistoryToODT(o).then(t=>{r+=t,e(o.header+o.styles+o.getAutomaticStyles()+o.automaticStylesEnd+r+o.footer)})})})},addHistoryToODT(t){let e=this,o="";return new Promise(async(r,s)=>{let n={fill:this.currentUser.colorvalue.fill,stroke:this.currentUser.colorvalue.stroke};t.addBuddyStyles(n);for(let r=e.history.length-1;r>=0;r--){let s=e.history[r],n="";n+=t.addQuestion(s.question);let a=document.querySelector(`#export-${r} #stats`).toDataURL("image/png"),i=t.addChartFrame(a),l="",c="";if("Rating"==s.typeVariable){let e=0;for(let t of s.results.answers)e+=t;e=Math.round(e/s.results.answers.length*10)/10,c=t.addAvgRatingFrame(e)}if("ImageMCQ"==s.typeVariable){let o=2.7;for(let n=0;n<s.options.length;n++){let a=await e.canvasToImage(s.options[n]),i=o*(a.height/a.width),c=e.getLegendColor(r,n),g={text:parseInt(n)+1,color:c.hex,imageURL:a.dataURL,width:o,height:i};l+=t.addLegendFrame(g)}}let g=t.addToChartInfoFrame(i+c+l);n+=t.addToMainContainer(g),n=t.addToPageContainer(n);let u={answersCount:s.results.counts.answersCount,usersCount:s.results.counts.usersCount,timestamp:new Date(s.endTime).toLocaleString()};n+=t.addStatsFrame(u),o+=n}r(o)})},generateDOC(){console.log("Exporting DOC...");var t=this;this.$nextTick(()=>{var e="";for(let t=this.history.length-1;t>=0;t--)e+=document.getElementById("export-"+t).innerHTML;var o="data:application/vnd.ms-word;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent("<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'></head><body>"+e+"</body></html>"))),r={mimetype:"application/msword",title:this.$root.$refs.SugarL10n.get("ExportFileName",{userName:this.currentUser.name})+".doc",activity:"org.olpcfrance.Vote",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};t.$root.$refs.SugarJournal.createEntry(o,r).then(()=>{t.$root.$refs.SugarPopup.log(this.$root.$refs.SugarL10n.get("ExportTo",{format:"DOC"})),console.log("Export to DOC complete"),t.$emit("export-completed")})})},generatePDF(){console.log("Exporting PDF...");var t=new jsPDF;let e=this;e.addHistoryToPDF(t).then(()=>{var o={mimetype:"application/pdf",title:this.$root.$refs.SugarL10n.get("ExportFileName",{userName:this.currentUser.name})+".pdf",activity:"org.olpcfrance.Vote",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};e.$root.$refs.SugarJournal.createEntry(t.output("dataurlstring"),o).then(()=>{e.$root.$refs.SugarPopup.log(this.$root.$refs.SugarL10n.get("ExportTo",{format:"PDF"})),console.log("Export to PDF complete"),e.$emit("export-completed")})})},addHistoryToPDF(t){let e=this;return new Promise(async(o,r)=>{let s=!0;var n,a=10,i=10;for(let o=e.history.length-1;o>=0;o--){let r=e.history[o];s?s=!1:t.addPage(),i=a=10,n=t.splitTextToSize(r.question,180);var l=t.getTextDimensions(n);t.setFillColor("#1e1e1e"),t.rect(0,0,220,10+l.h,"F"),t.setFontSize(16),t.setFontStyle("bold"),t.setTextColor(255,255,255),t.text(i,a,n),t.setTextColor(0,0,0),t.setFontStyle("normal"),t.setFontSize(12),a+=l.h+15;let c=document.querySelector(`#export-${o} #stats`).toDataURL("image/png");if(t.addImage(c,i+12,a,168,120),a+=130,"Rating"==r.typeVariable){let o=0;for(let t of r.results.answers)o+=t;o=Math.round(o/r.results.answers.length*10)/10,t.setFontSize(12),t.setFontStyle("normal"),t.setTextColor(this.currentUser.colorvalue.stroke),n=t.splitTextToSize(e.l10n.stringAvgRating,180),l=t.getTextDimensions(n),t.text(i+100,a+15,n,{align:"center"}),t.setFontSize(36),t.setFontStyle("bold"),t.setTextColor(this.currentUser.colorvalue.fill),n=t.splitTextToSize(""+o,180),t.text(i+100,a+5,n,{align:"center"})}if("ImageMCQ"==r.typeVariable){let s=0;for(let n in r.options){let l=20,c=20,g=await e.canvasToImage(r.options[n]);c=l*(g.height/g.width),i+l>200?(i=10,a+=s+10,s=0,a+10>280&&(t.addPage(),a=10)):a+c+10>281&&(t.addPage(),i=10,a=10),s=Math.max(s,c),t.addImage(g.dataURL,i,a+2,l,c),t.setFontSize(10),t.setTextColor("#838383"),t.text(i+l/4,a,""+(parseInt(n)+1),{align:"center"});let u=this.getLegendColor(o,n);t.setFillColor(u.r,u.g,u.b),t.rect(i+l/4+3.5,a-2.5,8,2.5,"F"),t.setFontSize(12),t.setTextColor("#000000"),i+=l+10}}a+40>280?(t.addPage(),a=30):a=250,i=95,t.setFontSize(12),t.setFontStyle("normal"),t.setTextColor(this.currentUser.colorvalue.stroke),n=t.splitTextToSize(e.l10n.stringVotes,180),l=t.getTextDimensions(n),t.text(i,a+10,n,{align:"center"}),t.setFontSize(36),t.setFontStyle("bold"),t.setTextColor(this.currentUser.colorvalue.fill),n=t.splitTextToSize(""+r.results.counts.answersCount,180),t.text(i,a,n,{align:"center"}),i+=l.w+15,t.setFontSize(12),t.setFontStyle("normal"),t.setTextColor(this.currentUser.colorvalue.stroke),n=t.splitTextToSize(e.l10n.stringUsers,180),l=t.getTextDimensions(n),t.text(i,a+10,n,{align:"center"}),t.setFontSize(36),t.setFontStyle("bold"),t.setTextColor(this.currentUser.colorvalue.fill),n=t.splitTextToSize(""+r.results.counts.usersCount,180),t.text(i,a,n,{align:"center"}),t.setFontStyle("normal"),i=108,a+=25,t.setFontSize(16),t.setTextColor("#1e1e1e"),n=t.splitTextToSize(new Date(r.endTime).toLocaleString(),180),t.text(i,a,n,{align:"center"}),t.setFontSize(12)}o()})},rgbToHex:(t,e,o)=>"#"+((1<<24)+(t<<16)+(e<<8)+o).toString(16).slice(1),getLegendColor(t,e){let o=this.$refs["export-"+t][0].statsData.datasets[0].hoverBackgroundColor[e].match(/\d+/g);return{r:parseInt(o[0]),g:parseInt(o[1]),b:parseInt(o[2]),hex:this.rgbToHex(parseInt(o[0]),parseInt(o[1]),parseInt(o[2]))}},download:function(t,e,o){var r=new Blob([t],{type:o});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(r,e);else{var s=document.createElement("a"),n=URL.createObjectURL(r);s.href=n,s.download=e,document.body.appendChild(s),s.click(),setTimeout((function(){document.body.removeChild(s),window.URL.revokeObjectURL(n)}),0)}}}};