/*! Sugarizer 2020-03-14 */
enyo.kind({name:"VideoViewer.Item",kind:enyo.Control,published:{code:"",title:"",category:"",isFavorite:!1,image:"",tojournal:!1},events:{onVideoPlayed:""},classes:"item",components:[{name:"spinner",kind:"Image",src:"images/spinner-dark.gif",classes:"spinner"},{name:"background",classes:"itemImage",kind:"Image",src:"images/notloaded.png"},{name:"itemImage",classes:"itemImage",kind:"Image",showing:!1,onload:"imageLoaded",onerror:"defaultImage",ontap:"showVideo"},{name:"itemPlay",classes:"itemPlay",kind:"Image",showing:!1,src:"icons/play.svg",ontap:"showVideo"},{name:"itemFavorite",classes:"itemFavorite",kind:"Image",src:"icons/notfavorite.svg",showing:!1,ontap:"showVideo"},{name:"itemOverlay",classes:"itemOverlay"},{name:"itemTitle",classes:"itemTitle",content:""}],create:function(){this.inherited(arguments),this.nameChanged(),this.titleChanged(),this.isFavoriteChanged(),this.tojournalChanged()},nameChanged:function(){var a=(this.image&&this.image,this.replaceValues(Util.getImages()));if("undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime){var b=new XMLHttpRequest,c=this;b.open("GET",a,!0),b.responseType="blob",b.onload=function(a){c.$.itemImage.setAttribute("src",window.URL.createObjectURL(this.response))},b.send()}else this.$.itemImage.setAttribute("src",a)},titleChanged:function(){this.$.itemTitle.setContent(this.title)},isFavoriteChanged:function(){this.$.itemFavorite.setShowing(this.isFavorite)},imageLoaded:function(){this.$.itemImage.setShowing(!0),this.$.itemPlay.setShowing(!0),this.$.spinner.setShowing(!1),this.$.background.setShowing(!1)},tojournalChanged:function(){this.tojournal?this.$.itemPlay.setSrc("icons/tojournal.svg"):this.$.itemPlay.setSrc("images/play.svg"),this.$.itemPlay.render()},defaultImage:function(){this.$.itemImage.setAttribute("src","images/notloaded.png"),this.$.itemImage.setShowing(!0),this.$.itemPlay.setShowing(!0),this.$.spinner.setShowing(!1),this.$.background.setShowing(!1)},replaceValues:function(a){var b=a;return b=b.replace(new RegExp("%id%","g"),this.code),b=b.replace(new RegExp("%image%","g"),this.image),b=b.replace(new RegExp("%category%","g"),this.category),b=b.replace(new RegExp("%title%","g"),this.title)},videoURL:function(){return this.replaceValues(Util.getVideos())+"."+constant.videoType},exportToVideo:function(){var a=this.videoURL(),b="mp4"==constant.videoType?"video/mp4":"video/webm",c=new XMLHttpRequest;c.open("GET",a,!0),c.setRequestHeader("Content-type",b),c.responseType="arraybuffer";var d=this;c.onload=function(){if(200==c.status||0==c.status){var a=new Uint8Array(this.response),e="data:"+b+";base64,"+Util.toBase64(a),f={mimetype:b,title:d.title+"."+constant.videoType,activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};app.datastore.create(f,function(){console.log("video '"+d.title+"' saved in journal.")},e)}},c.send()},showVideo:function(){this.tojournal&&this.exportToVideo(),this.doVideoPlayed()}});