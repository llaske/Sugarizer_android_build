/*! Sugarizer 2020-03-14 */
define(["sugar-web/bus","sugar-web/env"],function(a,b){"use strict";function c(){q++}function d(){0==--q&&r&&(r(),r=null)}function e(a){setTimeout(function(){0==q?a&&a():r=a},50)}function f(a){this.objectId=a,this.newMetadata={},this.newDataAsText=null,this.toload=!1,p||b.getEnvironment(function(){p=!0});if(void 0===this.objectId){var c=window.top.sugar.environment.objectId;null!=c&&(this.objectId=c,this.toload=!0)}}function g(a,b,c){var d=m.db.transaction([o],"readwrite"),e=d.objectStore(o),f=e.put({objectId:a,text:b});f.onerror=function(a){c&&c(f.errorCode)},f.onsuccess=function(a){c&&c(null)}}function h(a,b){var c=m.db.transaction([o],"readonly"),d=c.objectStore(o),e=d.get(a);e.onerror=function(a){b&&b(e.errorCode,null)},e.onsuccess=function(a){b&&b(null,e.result?e.result.text:null)}}function i(a){var b=m.db.transaction([o],"readonly"),c=b.objectStore(o),d=c.openCursor(),e=[];d.onerror=function(b){a&&a(d.errorCode,null)},d.onsuccess=function(b){var c=b.target.result;c?(e.push(c.key),c.continue()):a&&a(null,e)}}function j(a,b){var c=m.db.transaction([o],"readwrite"),d=c.objectStore(o),e=d.delete(a);e.onerror=function(a){b&&b(e.errorCode)},e.onsuccess=function(a){b&&b(null)}}var k={},l={},m={},n="sugar_datastore_",o="sugar_filestore",p=!1,q=0,r=null;return k.getUrlParameter=function(a){var b=RegExp("[?&]"+a+"=([^&]*)").exec(window.location.search);return b&&decodeURIComponent(b[1].replace(/\+/g," "))},k.createUUID=function(){for(var a=[],b="0123456789abcdef",c=0;c<36;c++)a[c]=b.substr(Math.floor(16*Math.random()),1);return a[14]="4",a[19]=b.substr(3&a[19]|8,1),a[8]=a[13]=a[18]=a[23]="-",a.join("")},k.callbackChecker=function(a){return void 0!==a&&null!==a||(a=function(){}),a},k.create=function(a,b,c){var d=k.callbackChecker(b),e=k.createUUID();void 0!==c&&(a.textsize=c.length);var f=l.getValue("sugar_settings");f&&(a.buddy_name=f.name,a.buddy_color=f.colorvalue),l.setValue(n+e,{metadata:a,text:void 0===c?null:{link:e}})?void 0!==c?m.setValue(e,c,function(a){a?d(-1,null):d(null,e)}):d(null,e):d(-1,null)},k.find=function(a){var b=[];if(!l.test())return b;for(var c in l.getAll())if(c.substr(0,n.length)==n){var d=l.getValue(c);d.objectId=c.substr(n.length),void 0!==a&&d.metadata.activity!=a||b.push(d)}return b},k.remove=function(a,b){l.removeValue(n+a),m.removeValue(a,b)},k.waitPendingSave=function(a){e(a)},f.prototype.getMetadata=function(a){var b=k.callbackChecker(a),c=l.getValue(n+this.objectId);null!=c&&(this.setMetadata(c.metadata),this.toload=!1,b(null,c.metadata))},f.prototype.loadAsText=function(a){var b=k.callbackChecker(a),c=this,d=l.getValue(n+c.objectId);if(null!=d){c.setMetadata(d.metadata);d.text?m.getValue(c.objectId,function(a,e){a?b(-1,null,null):(c.setDataAsText(e),c.toload=!1,b(null,d.metadata,e))}):(c.toload=!1,b(null,d.metadata,null))}},f.prototype.setMetadata=function(a){for(var b in a)this.newMetadata[b]=a[b]},f.prototype.setDataAsText=function(a){this.newDataAsText=a},f.prototype.save=function(a,b){if(c(),void 0===this.objectId){var e=this;this.newMetadata.timestamp=this.newMetadata.creation_time=(new Date).getTime(),this.newMetadata.file_size=0,k.create(this.newMetadata,function(a,b){null==a&&(e.objectId=b)})}else this.toload&&(this.getMetadata(null),this.toload=!1);var f=k.callbackChecker(a);b||(this.newMetadata.timestamp=(new Date).getTime());var g=l.getValue("sugar_settings");g&&!b&&(this.newMetadata.buddy_name=g.name,this.newMetadata.buddy_color=g.colorvalue),null!=this.newDataAsText&&(b||(this.newMetadata.textsize=this.newDataAsText.length));var e=this;l.setValue(n+this.objectId,{metadata:this.newMetadata,text:void 0===this.newDataAsText?null:{link:this.objectId}})?null!=this.newDataAsText?m.setValue(e.objectId,this.newDataAsText,function(a){a?f(-1,null,null):f(null,e.newMetadata,e.newDataAsText),d()}):(f(null,this.newMetadata,this.newDataAsText),d()):(f(-1,null),d())},k.DatastoreObject=f,k.localStorage=l,k.indexedDB=m,l.load=function(a){a&&a()},l.load(),l.test=function(){return"undefined"!=typeof Storage&&void 0!==window.localStorage},l.setValue=function(a,b){if(this.test())try{return window.localStorage.setItem(a,JSON.stringify(b)),!0}catch(a){return console.log("ERROR: Unable to update local storage"),!1}},l.getValue=function(a){if(this.test())try{return JSON.parse(window.localStorage.getItem(a))}catch(a){return null}return null},l.removeValue=function(a){if(this.test())try{window.localStorage.removeItem(a)}catch(a){}},l.getAll=function(){if(this.test())try{return window.localStorage}catch(a){return null}return null},m.db=null,m.test=function(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB},m.load=function(a){if(null!=m.db)return void a(null);if(!m.test())return void(a&&a(-1));var b=window.indexedDB.open(o,1);b.onerror=function(b){a&&a(-2)},b.onsuccess=function(c){m.db=b.result,a&&a(null)},b.onupgradeneeded=function(a){a.target.result.createObjectStore(o,{keyPath:"objectId"}).createIndex("objectId","objectId",{unique:!0})}},m.setValue=function(a,b,c){null==m.db?m.load(function(d){d?console.log("FATAL ERROR: indexedDB not supported, could be related to use of private mode"):g(a,b,c)}):g(a,b,c)},m.getValue=function(a,b){null==m.db?m.load(function(c){c?console.log("FATAL ERROR: indexedDB not supported, could be related to use of private mode"):h(a,b)}):h(a,b)},m.getAll=function(a){null==m.db?m.load(function(b){b?console.log("FATAL ERROR: indexedDB not supported, could be related to use of private mode"):i(a)}):i(a)},m.removeValue=function(a,b){null==m.db?m.load(function(c){c?console.log("FATAL ERROR: indexedDB not supported, could be related to use of private mode"):j(a,b)}):j(a,b)},k});