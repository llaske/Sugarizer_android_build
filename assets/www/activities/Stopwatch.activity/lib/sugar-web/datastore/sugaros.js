define(["sugar-web/bus","sugar-web/env"],(function(t,e){"use strict";var a={};function DatastoreObject(t){this.objectId=t,this.newMetadata={},this.ensureObjectId=function(t){var a=this;e.getObjectId((function(e){null!==e&&void 0===a.objectId&&(a.objectId=e),t()}))},this.blobToText=function(t,e){var a=new FileReader;a.onload=function(t){e(t.target.result)},a.readAsText(t)},this.blobToArrayBuffer=function(t,e){var a=new FileReader;a.onload=function(t){e(t.target.result)},a.readAsArrayBuffer(t)},this.saveText=function(t,e){var n=this;a.save(this.objectId,t,(function onSaved(t,a){var o=new Blob([n.newDataAsText]);n.blobToArrayBuffer(o,(function(t){a.write(t),a.close(e)}))}))},this.applyChanges=function(t,e){for(var n in this.newMetadata)t[n]=this.newMetadata[n];void 0!==this.newDataAsText?this.saveText(t,e):a.setMetadata(this.objectId,t,e)}}return DatastoreObject.prototype.getMetadata=function(t){var e=this;this.ensureObjectId((function(){a.getMetadata(e.objectId,t)}))},DatastoreObject.prototype.loadAsText=function(t){var e=this,n=null,o=[],s=null;function onRead(a,r){if(0===r.byteLength){var i=new Blob(o);return e.blobToText(i,(function(e){t(null,s,e)})),void n.close()}o.push(r),n.read(8192,onRead)}function onLoad(t,e,a){s=e,(n=a).read(8192,onRead)}this.ensureObjectId((function(){a.load(e.objectId,onLoad)}))},DatastoreObject.prototype.setMetadata=function(t){for(var e in t)this.newMetadata[e]=t[e]},DatastoreObject.prototype.setDataAsText=function(t){this.newDataAsText=t},DatastoreObject.prototype.save=function(t){void 0===t&&(t=function(){});var e=this;function onCreated(a,n){e.objectId=n,e.applyChanges({},t)}function onGotMetadata(a,n){e.applyChanges(n,t)}this.ensureObjectId((function(){void 0===e.objectId?a.create(e.newMetadata,onCreated):a.getMetadata(e.objectId,onGotMetadata)}))},a.DatastoreObject=DatastoreObject,a.setMetadata=function(e,a,n){var o=[e,a];t.sendMessage("datastore.set_metadata",o,(function onResponseReceived(t,e){n&&n(null===t?null:t)}))},a.getMetadata=function(e,a){var n=[e];t.sendMessage("datastore.get_metadata",n,(function onResponseReceived(t,e){null===t?a(null,e[0]):a(t,null)}))},a.load=function(e,a){var n=t.createInputStream();n.open((function(o){var s=[e,n.streamId];t.sendMessage("datastore.load",s,(function onResponseReceived(t,e){null===t?a(null,e[0],n):a(t,null,null)}))}))},a.create=function(e,a){var n=[e];t.sendMessage("datastore.create",n,(function onResponseReceived(t,e){null===t?a(null,e[0]):a(t,null)}))},a.save=function(e,a,n){var o=t.createOutputStream();o.open((function(s){var r=[e,a,o.streamId];t.sendMessage("datastore.save",r,(function onResponseReceived(t,e){null===t?n(null,o):n(t,null)}))}))},a}));