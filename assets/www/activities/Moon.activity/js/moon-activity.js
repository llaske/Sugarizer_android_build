define(["activity/data-model","activity/draw","webL10n","sugar-web/env","sugar-web/datastore","moment-with-locales.min"],(function(e,t,n,i,o,a){"use strict";var l,r,d,s,u=document.querySelector("#toggle-grid-button"),c=document.querySelector("#toggle-hemisphere-button"),m=document.querySelector("canvas"),g=m.getContext("2d"),p=n.get,f=!0;function updateSizes(){var e=document.querySelector("#main-toolbar").clientHeight;document.querySelector("#panel-container").style.height=window.innerHeight-e+"px";var t=document.querySelector("#panel-right").clientHeight,n=document.querySelector("#panel-right").clientWidth;l=.95*Math.min(n,t),.5*l,m.width=l,m.height=l,m.style.top=.5*(t-m.height)+"px",m.style.left=.5*(n-m.width)+"px"}function updateView(){clearTimeout(r),updateInfo(),t.setImageSize(l),t.moon(),s?(g.save(),g.rotate(Math.PI),g.drawImage(m,-l,-l),g.restore(),d&&t.grid(p("SNWE"))):d&&t.grid(p("NSEW")),r=setTimeout(updateView,5e3)}function updateInfo(){e.update_moon_calculations();var t={},n=["moonInfo","phase","julian","age","lunation","visibility","seleno","full","new","lunar","solar"];t[p(n[0])]=[formatDate()],t[p(n[1])]=[p(e.moon_phase_name())],t[p(n[2])]=[e.julian_date.toFixed(2),p("astro")],t[p(n[3])]=[e.days_old,p("days")+",",e.hours_old,p("hours")+",",e.minutes_old,p("minutes")],t[p(n[4])]=[(100*e.phase_of_moon).toFixed(4)+"%",p("thru"),e.lunation],t[p(n[5])]=[(100*e.percent_of_full_moon).toFixed(4)+"%",p("estimated")],t[p(n[6])]=[e.selenographic_deg.toFixed(2)+"Â°",p(e.west_or_east),"("+p(e.rise_or_set)+")"],t[p(n[7])]=[formatDate(e.next_full_moon_date),p("in"),e.days_until_full_moon.toFixed(),p("days")],t[p(n[8])]=[formatDate(e.next_new_moon_date),p("in"),e.days_until_new_moon.toFixed(),p("days")],t[p(n[9])]=[formatDate(e.next_lunar_eclipse_date),p("in"),e.days_until_lunar_eclipse.toFixed(),p("days")],t[p(n[10])]=[formatDate(e.next_solar_eclipse_date),p("in"),e.days_until_solar_eclipse.toFixed(),p("days")];var i=[];for(var o in t){var a="<p>"+o+":<br>"+t[o].join(" ")+"</p>";i.push(a)}i=i.join(""),document.querySelector("#panel-left").innerHTML=i,document.getElementById("toggle-grid-button").title=p("ToggleGrid"),document.getElementById("toggle-hemisphere-button").title=p("ToggleHemisphere"),document.getElementById("save-image-button").title=p("SaveImage")}function toggleGrid(){(d=!d)?u.classList.add("active"):u.classList.remove("active"),updateView()}function toggleHemisphere(){(s=!s)?c.classList.add("active"):c.classList.remove("active"),updateView()}function saveImage(){var e=m.toDataURL("image/jpeg",1),t={mimetype:"image/jpeg",title:"Image Moon",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};o.create(t,(function(){console.log("export done.")}),e)}function formatDate(e){e=e?new Date(1e3*e):new Date;var t=a(e);return t.format("LLLL").replace(t.format("LT"),t.format("LTS"))}return n.ready((function(){f&&(f=!1,i.getEnvironment((function(e,t){var i="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,o=t.user?t.user.language:i;n.language.code=o,a.locale(o);var l=setTimeout((function(){clearTimeout(l),updateView()}),50)})))})),document.getElementById("fullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.display="none",document.getElementById("panel-container").style.top="0px",document.getElementById("panel-container").style.height="100%",document.getElementById("unfullscreen-button").style.visibility="visible",updateSizes(),updateView()})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.display="block",document.getElementById("panel-container").style.top="55px",document.getElementById("panel-container").style.height="100%",document.getElementById("unfullscreen-button").style.visibility="hidden",updateSizes(),updateView()})),{setup:function setup(){!function initEventListeners(){window.addEventListener("resize",(function(){updateSizes(),updateView()})),u.addEventListener("click",toggleGrid),c.addEventListener("click",toggleHemisphere),document.querySelector("#save-image-button").addEventListener("click",saveImage)}(),updateSizes()},initPrefs:function initPrefs(e){(d=e.showGrid)?(d=!0,u.classList.add("active")):(d=!1,u.classList.remove("active")),(s=e.showSouth)?(s=!0,c.classList.add("active")):(s=!1,c.classList.remove("active"))},getPrefs:function getPrefs(){return{showGrid:d,showSouth:s}},updateInfo:updateInfo}}));