/*! Sugarizer 2020-03-14 */
define(["sugar-web/env"],function(a){"use strict";function b(b){this.queue=[],this.socket=null;var c=this;a.getEnvironment(function(a,b){var d=b.apiSocketPort,e=new WebSocket("ws://127.0.0.1:"+d);e.binaryType="arraybuffer",e.onopen=function(){var a=[b.activityId,b.apiSocketKey];for(e.send(JSON.stringify({method:"authenticate",id:"authenticate",params:a}));c.queue.length>0;)e.send(c.queue.shift())},e.onmessage=function(a){c.onMessage(a)},c.socket=e})}function c(){this.streamId=null,this.readCallback=null}function d(){this.streamId=null}var e=0,f={},g={},h=null,i=[];b.prototype.send=function(a){this.socket&&this.socket.readyState==WebSocket.OPEN?this.socket.send(a):this.queue.push(a)},b.prototype.close=function(){this.socket.close()};var j={};return c.prototype.open=function(a){var b=this;j.sendMessage("open_stream",[],function(c,d){b.streamId=d[0],i[b.streamId]=b,a(c)})},c.prototype.read=function(a,b){if(this.readCallback)throw new Error("Read already in progress");this.readCallback=b;var c=new ArrayBuffer(8);new Uint8Array(c,0,1)[0]=this.streamId,new Uint32Array(c,4,1)[0]=a,j.sendBinary(c)},c.prototype.gotData=function(a){var b=this.readCallback;this.readCallback=null,b(null,a)},c.prototype.close=function(a){function b(b,d){a&&a(b),delete i[c.streamId]}var c=this;j.sendMessage("close_stream",[this.streamId],b)},d.prototype.open=function(a){var b=this;j.sendMessage("open_stream",[],function(c,d){b.streamId=d[0],a(c)})},d.prototype.write=function(a){var b=new ArrayBuffer(a.byteLength+1),c=new Uint8Array(b);c[0]=this.streamId,c.set(new Uint8Array(a),1),j.sendBinary(b)},d.prototype.close=function(a){j.sendMessage("close_stream",[this.streamId],a)},j.createInputStream=function(a){return new c},j.createOutputStream=function(a){return new d},j.sendMessage=function(a,b,c){var d={method:a,id:e,params:b,jsonrpc:"2.0"};c&&(f[e]=c),h.send(JSON.stringify(d)),e++},j.onNotification=function(a,b){g[a]=b},j.sendBinary=function(a,b){h.send(a)},j.listen=function(a){h=a||new b,h.onMessage=function(a){if("string"==typeof a.data){var b=JSON.parse(a.data),c=b.id;if(b.method){var d=g[b.method];return void(void 0!==d&&d(b.params))}if(c in f){var e=f[c];null===b.error?e(null,b.result):e(new Error(b.error),null),delete f[c]}}else{var h=new Uint8Array(a.data),j=h[0];if(j in i){i[j].gotData(a.data.slice(1))}}}},j.close=function(){h.close(),h=null},j});