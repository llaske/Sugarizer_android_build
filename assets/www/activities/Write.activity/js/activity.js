define(["sugar-web/activity/activity","activity/palettes/format-text-palette","activity/palettes/list-palette","activity/palettes/paragraph-palette","activity/palettes/font-palette","sugar-web/graphics/colorpalette","sugar-web/datastore","sugar-web/graphics/journalchooser","sugar-web/env","sugar-web/graphics/presencepalette","activity/palettes/export-palette","webL10n","tutorial"],(function(e,t,n,o,i,r,d,l,c,a,s,g,m){requirejs(["domReady!","humane"],(function(u,p){e.setup();var y={modules:{toolbar:"#main-toolbar",history:{maxStack:500},imageResize:{},cursors:{transformOnTextChange:!0},clipboard:!0}};Quill.register("modules/cursors",QuillCursors);var f=document.getElementById("editor"),v=new Quill(f,y);v.focus(),v.format("size","24px");const E=v.getModule("cursors"),I=Quill.import("delta");c.getEnvironment((function(t,n){currentenv=n;var o="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,i=n.user?n.user.language:o;g.language.code=i,window.addEventListener("localized",(function(){document.getElementById("network-button").title=g.get("Network"),document.getElementById("color-button-1").title=g.get("ForegroundColor"),document.getElementById("color-button-2").title=g.get("BackgroundColor"),document.getElementById("format-text").title=g.get("Formattext"),document.getElementById("paragraph").title=g.get("Paragraph"),document.getElementById("list").title=g.get("List"),document.getElementById("resize-inc").title=g.get("Increasefontsize"),document.getElementById("font-button").title=g.get("ChooseFont"),document.getElementById("resize-dec").title=g.get("Decreasefontsize"),document.getElementById("insert-picture").title=g.get("Image"),document.getElementById("edit-undo").title=g.get("Undo"),document.getElementById("edit-redo").title=g.get("Redo"),document.getElementById("edit-copy").title=g.get("Copy"),document.getElementById("edit-paste").title=g.get("Paste"),document.getElementById("export").title=g.get("Export"),document.getElementById("super-script").title=g.get("SuperScript"),document.getElementById("sub-script").title=g.get("SubScript"),document.getElementById(5).title=g.get("Bold"),document.getElementById(6).title=g.get("Italic"),document.getElementById(7).title=g.get("Underline"),document.getElementById(8).title=g.get("Strike"),document.getElementById(9).title=g.get("OrderedList"),document.getElementById(10).title=g.get("UnorderedList"),document.getElementById(11).title=g.get("JustifyLeft"),document.getElementById(12).title=g.get("JustifyRight"),document.getElementById(13).title=g.get("JustifyCenter"),document.getElementById(19).title=g.get("ExportToTxt"),document.getElementById(20).title=g.get("ExportToPdf"),document.getElementById(21).title=g.get("ExportToDoc"),document.getElementById(22).title=g.get("ExportToOdt")})),n.objectId||n.sharedId?e.getDatastoreObject().loadAsText((function(e,t,n){if(null==e&&null!=n){var o=JSON.parse(n);console.log(o),v.setContents(o)}})):setTimeout((function(){v.setContents([{insert:g.get("Welcome",{username:n.user.name})+"\n",attributes:{size:"40px",color:n.user.colorvalue.stroke,bold:!0}}]);var e=v.getLength();v.clipboard.dangerouslyPasteHTML(e,g.get("Write")),e=v.getLength(),v.clipboard.dangerouslyPasteHTML(e,g.get("Writefeatures")),e=v.getLength(),v.clipboard.dangerouslyPasteHTML(e,g.get("Enjoy")),e=v.getLength(),v.clipboard.dangerouslyPasteHTML(e,"<br></br>"),e=v.getLength(),v.updateContents((new I).retain(v.getSelection().index+1).insert({image:window.initialImageDataUrl}))}),200),n.sharedId&&(console.log("Shared instance"),document.getElementById("edit-undo").style.display="none",document.getElementById("edit-redo").style.display="none",document.getElementById("shared-button").click(),j=e.getPresenceObject((function(e,t){t.onDataReceived(onNetworkDataReceived),t.onSharedActivityUserChanged(onNetworkUserChanged)})))})),document.getElementById("stop-button").addEventListener("click",(function(t){var n=v.getContents(),o=JSON.stringify(n);e.getDatastoreObject().setDataAsText(o),e.getDatastoreObject().save((function(e){null===e?console.log("write done."):console.log("write failed.")}))})),document.getElementById("help-button").addEventListener("click",(function(e){m.start()}));var h=!1,B=null;document.getElementById("edit-copy").addEventListener("click",(function(){var e=v.getSelection();B=v.getContents(e.index,e.length),document.execCommand("copy")})),document.getElementById("edit-paste").addEventListener("click",(function(){document.execCommand("paste")||null!=B&&(h=!0,v.updateContents((new I).retain(v.getSelection().index).concat(B)))})),v.keyboard.addBinding({key:"C",shortKey:!0},(function(){document.getElementById("edit-copy").click()})),document.getElementById("edit-undo").addEventListener("click",(function(){v.history.undo()})),document.getElementById("edit-redo").addEventListener("click",(function(){v.history.redo()})),document.getElementById("super-script").addEventListener("click",(function(){document.getElementById("super").click()})),document.getElementById("sub-script").addEventListener("click",(function(){document.getElementById("sub").click()}));var w=document.getElementById("format-text");(t=new t.Formatpalette(w,void 0)).setCategories([{id:5,title:"bold",cmd:"bold"},{id:6,title:"italic",cmd:"italic"},{id:7,title:"underline",cmd:"underline"},{id:8,title:"strike",cmd:"strikeThrough"}]),t.addEventListener("format",(function(){t.popDown(),v.focus()})),document.getElementById(5).addEventListener("click",(function(){document.getElementById("bold").click()})),document.getElementById(6).addEventListener("click",(function(){document.getElementById("italic").click()})),document.getElementById(7).addEventListener("click",(function(){document.getElementById("underline").click()})),document.getElementById(8).addEventListener("click",(function(){document.getElementById("strike").click()}));var x=document.getElementById("list");(n=new n.Listpalette(x,void 0)).setCategories([{id:10,title:"unordered list",cmd:"insertUnorderedList"},{id:9,title:"ordered list",cmd:"insertorderedList"}]),n.addEventListener("list",(function(){n.popDown()})),document.getElementById("9").addEventListener("click",(function(){document.getElementById("list-ordered").click()})),document.getElementById("10").addEventListener("click",(function(){document.getElementById("list-unordered").click()}));var k=document.getElementById("paragraph");(o=new o.Parapalette(k,void 0)).setCategories([{id:11,title:"justify Left",cmd:"justifyLeft"},{id:13,title:"justify Center",cmd:"justifyCenter"},{id:12,title:"justify Right",cmd:"justifyRight"}]),o.addEventListener("para",(function(){o.popDown(),v.focus()})),document.getElementById(11).addEventListener("click",(function(){h=!0,v.format("align","justify")})),document.getElementById(12).addEventListener("click",(function(){h=!0,v.format("align","right")})),document.getElementById(13).addEventListener("click",(function(){h=!0,v.format("align","center")}));var L=document.getElementById("font-button");(i=new i.Fontpalette(L)).addEventListener("fontChange",(function(e){var t=e.detail.family;"Arial"==t&&(t="arial"),"Comic Sans MS"==t&&(t="comic"),"Times New Roman"==t&&(t="Times"),"Courier New"==t&&(t="Courier"),"Lucida Console"==t&&(t="Lucida"),"Impact"==t&&(t="Impact"),"Georgia"==t&&(t="Georgia"),h=!0,v.format("font",t)}));var C=document.getElementById("color-button-1"),b=new r.ColorPalette(C);b.setColor("rgb(0, 0, 0)"),b.addEventListener("colorChange",(function(e){h=!0,v.format("color",e.detail.color)}));var T=document.getElementById("color-button-2"),D=new r.ColorPalette(T);D.setColor("rgb(255,255,255)"),D.addEventListener("colorChange",(function(e){h=!0,v.format("background-color",e.detail.color)}));var S=["16px","24px","32px","40px","48px","56px","64px","72px","80px","100px"];document.getElementById("resize-inc").addEventListener("click",(function(){var e=v.getFormat();if(null==e.size){var t=S.indexOf("24px");v.format("size",S[t+1])}else{t=S.indexOf(e.size);++t<S.length&&v.format("size",S[t])}})),document.getElementById("resize-dec").addEventListener("click",(function(){var e=v.getFormat();if(null==e.size){(t=S.indexOf("24px"))>0&&v.format("size",S[t-1])}else{var t=S.indexOf(e.size);--t>=0&&v.format("size",S[t])}})),document.getElementById("insert-picture").addEventListener("click",(function(e){l.show((function(e){e&&new d.DatastoreObject(e.objectId).loadAsText((function(e,t,n){v.focus(),h=!0,v.updateContents((new I).retain(v.getSelection().index).insert({image:n}))}))}),{mimetype:"image/png"},{mimetype:"image/jpeg"})}));var P=document.getElementById("export");y=[{id:19,title:"export to txt",cmd:"save-as-txt"},{id:20,title:"export to pdf",cmd:"save-as-pdf"},{id:21,title:"export to doc",cmd:"doc"},{id:22,title:"export to odt",cmd:"odt"}];(s=new s.Exportpalette(P,void 0)).setCategories(y),s.addEventListener("export",(function(){s.popDown()})),document.getElementById("19").addEventListener("click",(function(){var e=document.getElementById("title").value,t=document.getElementById("editor").textContent,n={mimetype:"text/plain",title:e+".txt",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};d.create(n,(function(){console.log("export done."),p.log(g.get("Txt"))}),t)})),document.getElementById("20").addEventListener("click",(function(){var e=document.getElementById("title").value;v.scrollingContainer.style.overflowY="visible",console.log(v.scrollingContainer.style.height);var t=v.scrollingContainer.offsetHeight;v.scrollingContainer.style.height="auto",v.scrollingContainer.scrollTop=0,html2canvas(v.scrollingContainer).then((function(n){v.scrollingContainer.style.height=t,v.scrollingContainer.style.overflowY="auto";var o=n.toDataURL("image/png"),i=(o=n.toDataURL("image/png"),210*n.height/n.width),r=i,l=new jsPDF("p","mm","",!0),c=0;for(l.addImage(o,"PNG",0,c,210,i,"","FAST"),r-=295;r>=0;)c=r-i,l.addPage(),l.addImage(o,"PNG",0,c,210,i,"","FAST"),r-=295;var a=l.output("dataurlstring"),s={mimetype:"application/pdf",title:e+".pdf",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};d.create(s,(function(){console.log("export done."),p.log(g.get("Pdf"))}),a)}))})),document.getElementById(21).addEventListener("click",(function(){var e=document.getElementById("title").value,t=document.getElementById("editor").innerHTML,n="data:application/vnd.ms-word;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent("<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'></head><body>"+t+"</body></html>"))),o={mimetype:"application/msword",title:e+".doc",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};d.create(o,(function(){console.log("export done."),p.log(g.get("Doc"))}),n)})),document.getElementById("22").addEventListener("click",(function(){var e=document.getElementsByClassName("ql-editor"),t=traverse(e[0]),n=document.getElementById("title").value,o="data:application/vnd.oasis.opendocument.text;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(t))),i={mimetype:"application/vnd.oasis.opendocument.text",title:n+".odt",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};d.create(i,(function(){console.log("export done."),p.log(g.get("Odt")),resetXML()}),o)})),v.on("text-change",(function(e,t,n){if(("user"==n||1==h)&&null!=j){var o=v.getSelection();j.sendMessage(j.getSharedInfo().id,{user:j.getUserInfo(),content:{action:"typing",data:e,range:o}}),h=!1}})),v.on("selection-change",(function(e,t,n){e&&null!=j&&j.sendMessage(j.getSharedInfo().id,{user:j.getUserInfo(),content:{action:"selection",range:e}})}));var z,F,j=null,O=!1,U=!1,_=new a.PresencePalette(document.getElementById("network-button"),void 0);_.addEventListener("shared",(function(){_.popDown(),console.log("Want to share"),j=e.getPresenceObject((function(e,t){e?console.log("Sharing error"):(t.createSharedActivity("org.sugarlabs.Write",(function(e){console.log("Activity shared"),O=!0})),t.onDataReceived(onNetworkDataReceived),t.onSharedActivityUserChanged(onNetworkUserChanged))}))}));var onNetworkDataReceived=function(e){if(j.getUserInfo().networkId!==e.user.networkId){if("init"==e.content.action&&0==U){v.updateContents(e.content.data);for(var t=e.content.allcursors,n=0;n<t.length;n++)console.log(t[n]),t[n].id!=z&&(E.createCursor(t[n].id,t[n].name,t[n].color),E.moveCursor(t[n].id,t[n].range));E.update(),document.getElementById("list-ordered").click(),document.getElementById("list-ordered").click(),U=!0}"typing"==e.content.action&&v.updateContents(e.content.data),"selection"==e.content.action&&setTimeout((function(){E.moveCursor(e.user.networkId,e.content.range)}),5)}},onNetworkUserChanged=function(e){if(O){var t=v.getContents(),n=v.getSelection();F.range=n;var o=E.cursors();j.sendMessage(j.getSharedInfo().id,{user:j.getUserInfo(),content:{action:"init",data:t,allcursors:o}}),F.range=null}z||(z=e.user.networkId);var i=e.user.name.replace("<","&lt;").replace(">","&gt;"),r="<img style='height:30px;' src='"+generateXOLogoWithColor(e.user.colorvalue)+"'>";for(var d in j.listSharedActivities((function(e){for(var t=0;t<e.length;t++)e[t].id===j.getSharedInfo().id&&getConnectedPeople(e[t].users)})),R)console.log(R[d].name,d,R[d].networkId);if(1==e.move){p.log(r+g.get("PlayerJoin",{user:i}));var l=E.createCursor(e.user.networkId,i,e.user.colorvalue.stroke);z==e.user.networkId&&(F=l)}-1===e.move&&(E.removeCursor(e.user.networkId),p.log(r+g.get("PlayerLeave",{user:i})),e.user.networkId==R[0].networkId&&R[1].networkId==z&&(document.getElementById(3).style.display="inline",document.getElementById(4).style.display="inline",O=!0))};function generateXOLogoWithColor(e){var t='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>';return t=(t=t.replace("#010101",e.stroke)).replace("#FFFFFF",e.fill),"data:image/svg+xml;base64,"+btoa(t)}var R={};function getConnectedPeople(e){var t=document.getElementById("presence-users");e&&t&&(R={},j.listSharedActivityUsers(j.getSharedInfo().id,(function(e){R={};for(var t=0;t<e.length;t++){var n=e[t];R[t]=n}!function displayConnectedPeople(){var e=document.getElementById("presence-users"),t="<hr><ul style='list-style: none; padding:0;'>";for(var n in R)t+="<li><img style='height:30px;' src='"+generateXOLogoWithColor(R[n].colorvalue)+"'>"+R[n].name+"</li>";t+="</ul>",e.innerHTML=t}()})))}}))}));