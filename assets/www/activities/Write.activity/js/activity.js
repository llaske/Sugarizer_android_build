/*! Sugarizer 2020-03-14 */
define(["sugar-web/activity/activity","activity/palettes/format-text-palette","activity/palettes/list-palette","activity/palettes/paragraph-palette","activity/palettes/font-palette","sugar-web/graphics/colorpalette","sugar-web/datastore","sugar-web/graphics/journalchooser","sugar-web/env","sugar-web/graphics/presencepalette","activity/palettes/export-palette","webL10n","tutorial"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){requirejs(["domReady!","humane"],function(n,o){function p(a){var b=U;return b=b.replace("#010101",a.stroke),b=b.replace("#FFFFFF",a.fill),"data:image/svg+xml;base64,"+btoa(b)}function q(){var a=document.getElementById("presence-users"),b="<hr><ul style='list-style: none; padding:0;'>";for(var c in V)b+="<li><img style='height:30px;' src='"+p(V[c].colorvalue)+"'>"+V[c].name+"</li>";b+="</ul>",a.innerHTML=b}function r(a){var b=document.getElementById("presence-users");a&&b&&(V={},O.listSharedActivityUsers(O.getSharedInfo().id,function(a){V={};for(var b=0;b<a.length;b++){var c=a[b];V[b]=c}q()}))}a.setup();var s={modules:{toolbar:"#main-toolbar",history:{maxStack:500},imageResize:{},cursors:{transformOnTextChange:!0},clipboard:!0}};Quill.register("modules/cursors",QuillCursors);var t=document.getElementById("editor"),u=new Quill(t,s);u.focus(),u.format("size","24px");const v=u.getModule("cursors"),w=Quill.import("delta");i.getEnvironment(function(b,c){currentenv=c;var d="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,e=c.user?c.user.language:d;l.language.code=e,window.addEventListener("localized",function(){document.getElementById("network-button").title=l.get("Network"),document.getElementById("color-button-1").title=l.get("ForegroundColor"),document.getElementById("color-button-2").title=l.get("BackgroundColor"),document.getElementById("format-text").title=l.get("Formattext"),document.getElementById("paragraph").title=l.get("Paragraph"),document.getElementById("list").title=l.get("List"),document.getElementById("resize-inc").title=l.get("Increasefontsize"),document.getElementById("font-button").title=l.get("ChooseFont"),document.getElementById("resize-dec").title=l.get("Decreasefontsize"),document.getElementById("insert-picture").title=l.get("Image"),document.getElementById("edit-undo").title=l.get("Undo"),document.getElementById("edit-redo").title=l.get("Redo"),document.getElementById("edit-copy").title=l.get("Copy"),document.getElementById("edit-paste").title=l.get("Paste"),document.getElementById("export").title=l.get("Export"),document.getElementById("super-script").title=l.get("SuperScript"),document.getElementById("sub-script").title=l.get("SubScript"),document.getElementById(5).title=l.get("Bold"),document.getElementById(6).title=l.get("Italic"),document.getElementById(7).title=l.get("Underline"),document.getElementById(8).title=l.get("Strike"),document.getElementById(9).title=l.get("OrderedList"),document.getElementById(10).title=l.get("UnorderedList"),document.getElementById(11).title=l.get("JustifyLeft"),document.getElementById(12).title=l.get("JustifyRight"),document.getElementById(13).title=l.get("JustifyCenter"),document.getElementById(19).title=l.get("ExportToTxt"),document.getElementById(20).title=l.get("ExportToPdf"),document.getElementById(21).title=l.get("ExportToDoc"),document.getElementById(22).title=l.get("ExportToOdt")}),c.objectId||c.sharedId?a.getDatastoreObject().loadAsText(function(a,b,c){if(null==a&&null!=c){var d=JSON.parse(c);console.log(d),u.setContents(d)}}):setTimeout(function(){u.setContents([{insert:l.get("Welcome",{username:c.user.name})+"\n",attributes:{size:"40px",color:c.user.colorvalue.stroke,bold:!0}}]);var a=u.getLength();u.clipboard.dangerouslyPasteHTML(a,l.get("Write")),a=u.getLength(),u.clipboard.dangerouslyPasteHTML(a,l.get("Writefeatures")),a=u.getLength(),u.clipboard.dangerouslyPasteHTML(a,l.get("Enjoy")),a=u.getLength(),u.clipboard.dangerouslyPasteHTML(a,"<br></br>"),a=u.getLength(),u.updateContents((new w).retain(u.getSelection().index+1).insert({image:window.initialImageDataUrl}))},200),c.sharedId&&(console.log("Shared instance"),document.getElementById("edit-undo").style.display="none",document.getElementById("edit-redo").style.display="none",document.getElementById("shared-button").click(),O=a.getPresenceObject(function(a,b){b.onDataReceived(S),b.onSharedActivityUserChanged(T)}))}),document.getElementById("stop-button").addEventListener("click",function(b){var c=u.getContents(),d=JSON.stringify(c);a.getDatastoreObject().setDataAsText(d),a.getDatastoreObject().save(function(a){null===a?console.log("write done."):console.log("write failed.")})}),document.getElementById("help-button").addEventListener("click",function(a){m.start()});var x=!1,y=null;document.getElementById("edit-copy").addEventListener("click",function(){var a=u.getSelection();y=u.getContents(a.index,a.length),document.execCommand("copy")}),document.getElementById("edit-paste").addEventListener("click",function(){document.execCommand("paste")||null!=y&&(x=!0,u.updateContents((new w).retain(u.getSelection().index).concat(y)))}),u.keyboard.addBinding({key:"C",shortKey:!0},function(){document.getElementById("edit-copy").click()}),document.getElementById("edit-undo").addEventListener("click",function(){u.history.undo()}),document.getElementById("edit-redo").addEventListener("click",function(){u.history.redo()}),document.getElementById("super-script").addEventListener("click",function(){document.getElementById("super").click()}),document.getElementById("sub-script").addEventListener("click",function(){document.getElementById("sub").click()});var z=document.getElementById("format-text"),A=[{id:5,title:"bold",cmd:"bold"},{id:6,title:"italic",cmd:"italic"},{id:7,title:"underline",cmd:"underline"},{id:8,title:"strike",cmd:"strikeThrough"}];b=new b.Formatpalette(z,void 0),b.setCategories(A),b.addEventListener("format",function(){b.popDown(),u.focus()}),document.getElementById(5).addEventListener("click",function(){document.getElementById("bold").click()}),document.getElementById(6).addEventListener("click",function(){document.getElementById("italic").click()}),document.getElementById(7).addEventListener("click",function(){document.getElementById("underline").click()}),document.getElementById(8).addEventListener("click",function(){document.getElementById("strike").click()});var B=document.getElementById("list"),C=[{id:10,title:"unordered list",cmd:"insertUnorderedList"},{id:9,title:"ordered list",cmd:"insertorderedList"}];c=new c.Listpalette(B,void 0),c.setCategories(C),c.addEventListener("list",function(){c.popDown()}),document.getElementById("9").addEventListener("click",function(){document.getElementById("list-ordered").click()}),document.getElementById("10").addEventListener("click",function(){document.getElementById("list-unordered").click()});var D=document.getElementById("paragraph"),E=[{id:11,title:"justify Left",cmd:"justifyLeft"},{id:13,title:"justify Center",cmd:"justifyCenter"},{id:12,title:"justify Right",cmd:"justifyRight"}];d=new d.Parapalette(D,void 0),d.setCategories(E),d.addEventListener("para",function(){d.popDown(),u.focus()}),document.getElementById(11).addEventListener("click",function(){x=!0,u.format("align","justify")}),document.getElementById(12).addEventListener("click",function(){x=!0,u.format("align","right")}),document.getElementById(13).addEventListener("click",function(){x=!0,u.format("align","center")});var F=document.getElementById("font-button");e=new e.Fontpalette(F),e.addEventListener("fontChange",function(a){var b=a.detail.family;"Arial"==b&&(b="arial"),"Comic Sans MS"==b&&(b="comic"),"Times New Roman"==b&&(b="Times"),"Courier New"==b&&(b="Courier"),"Lucida Console"==b&&(b="Lucida"),"Impact"==b&&(b="Impact"),"Georgia"==b&&(b="Georgia"),x=!0,u.format("font",b)});var G=document.getElementById("color-button-1"),H=new f.ColorPalette(G);H.setColor("rgb(0, 0, 0)"),H.addEventListener("colorChange",function(a){x=!0,u.format("color",a.detail.color)});var I=document.getElementById("color-button-2"),J=new f.ColorPalette(I);J.setColor("rgb(255,255,255)"),J.addEventListener("colorChange",function(a){x=!0,u.format("background-color",a.detail.color)});var K=["16px","24px","32px","40px","48px","56px","64px","72px","80px","100px"];document.getElementById("resize-inc").addEventListener("click",function(){var a=u.getFormat();if(null==a.size){var b=K.indexOf("24px");u.format("size",K[b+1])}else{var b=K.indexOf(a.size);++b<K.length&&u.format("size",K[b])}}),document.getElementById("resize-dec").addEventListener("click",function(){var a=u.getFormat();if(null==a.size){var b=K.indexOf("24px");b>0&&u.format("size",K[b-1])}else{var b=K.indexOf(a.size);--b>=0&&u.format("size",K[b])}}),document.getElementById("insert-picture").addEventListener("click",function(a){h.show(function(a){a&&new g.DatastoreObject(a.objectId).loadAsText(function(a,b,c){u.focus(),x=!0,u.updateContents((new w).retain(u.getSelection().index).insert({image:c}))})},{mimetype:"image/png"},{mimetype:"image/jpeg"})});var L=document.getElementById("export"),s=[{id:19,title:"export to txt",cmd:"save-as-txt"},{id:20,title:"export to pdf",cmd:"save-as-pdf"},{id:21,title:"export to doc",cmd:"doc"},{id:22,title:"export to odt",cmd:"odt"}];k=new k.Exportpalette(L,void 0),k.setCategories(s),k.addEventListener("export",function(){k.popDown()}),document.getElementById("19").addEventListener("click",function(){var a=document.getElementById("title").value,b="text/plain",c=document.getElementById("editor").textContent,d={mimetype:b,title:a+".txt",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};g.create(d,function(){console.log("export done."),o.log(l.get("Txt"))},c)}),document.getElementById("20").addEventListener("click",function(){var a=document.getElementById("title").value;u.scrollingContainer.style.overflowY="visible",console.log(u.scrollingContainer.style.height);var b=u.scrollingContainer.offsetHeight;u.scrollingContainer.style.height="auto",u.scrollingContainer.scrollTop=0,html2canvas(u.scrollingContainer).then(function(c){u.scrollingContainer.style.height=b,u.scrollingContainer.style.overflowY="auto";var d=c.toDataURL("image/png"),d=c.toDataURL("image/png"),e=210,f=295,h=c.height*e/c.width,i=h,j=new jsPDF("p","mm","",!0),k=0;for(j.addImage(d,"PNG",0,k,e,h,"","FAST"),i-=f;i>=0;)k=i-h,j.addPage(),j.addImage(d,"PNG",0,k,e,h,"","FAST"),i-=f;var m=j.output("dataurlstring"),n="application/pdf",p={mimetype:n,title:a+".pdf",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};g.create(p,function(){console.log("export done."),o.log(l.get("Pdf"))},m)})}),document.getElementById(21).addEventListener("click",function(){var a=document.getElementById("title").value,b=document.getElementById("editor").innerHTML,c="<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'></head><body>",d="</body></html>",e=c+b+d,f="data:application/vnd.ms-word;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(e))),h="application/msword",i={mimetype:h,title:a+".doc",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};g.create(i,function(){console.log("export done."),o.log(l.get("Doc"))},f)}),document.getElementById("22").addEventListener("click",function(){var a=document.getElementsByClassName("ql-editor"),b=traverse(a[0]),c="application/vnd.oasis.opendocument.text",d=document.getElementById("title").value,e="data:application/vnd.oasis.opendocument.text;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(b))),f={mimetype:c,title:d+".odt",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};g.create(f,function(){console.log("export done."),o.log(l.get("Odt")),resetXML()},e)}),u.on("text-change",function(a,b,c){if(("user"==c||1==x)&&null!=O){var d=u.getSelection();O.sendMessage(O.getSharedInfo().id,{user:O.getUserInfo(),content:{action:"typing",data:a,range:d}}),x=!1}}),u.on("selection-change",function(a,b,c){a&&null!=O&&O.sendMessage(O.getSharedInfo().id,{user:O.getUserInfo(),content:{action:"selection",range:a}})});var M,N,O=null,P=!1,Q=!1,R=new j.PresencePalette(document.getElementById("network-button"),void 0);R.addEventListener("shared",function(){R.popDown(),console.log("Want to share"),O=a.getPresenceObject(function(a,b){if(a)return void console.log("Sharing error");b.createSharedActivity("org.sugarlabs.Write",function(a){console.log("Activity shared"),P=!0}),b.onDataReceived(S),b.onSharedActivityUserChanged(T)})});var S=function(a){if(O.getUserInfo().networkId!==a.user.networkId){if("init"==a.content.action&&0==Q){u.updateContents(a.content.data);for(var b=a.content.allcursors,c=0;c<b.length;c++)console.log(b[c]),b[c].id!=M&&(v.createCursor(b[c].id,b[c].name,b[c].color),v.moveCursor(b[c].id,b[c].range));v.update(),document.getElementById("list-ordered").click(),document.getElementById("list-ordered").click(),Q=!0}"typing"==a.content.action&&u.updateContents(a.content.data),"selection"==a.content.action&&setTimeout(function(){v.moveCursor(a.user.networkId,a.content.range)},5)}},T=function(a){if(P){var b=u.getContents(),c=u.getSelection();N.range=c;var d=v.cursors();O.sendMessage(O.getSharedInfo().id,{user:O.getUserInfo(),content:{action:"init",data:b,allcursors:d}}),N.range=null}M||(M=a.user.networkId);var e=a.user.name.replace("<","&lt;").replace(">","&gt;"),f="<img style='height:30px;' src='"+p(a.user.colorvalue)+"'>";O.listSharedActivities(function(a){for(var b=0;b<a.length;b++)a[b].id===O.getSharedInfo().id&&r(a[b].users)});for(var g in V)console.log(V[g].name,g,V[g].networkId);if(1==a.move){o.log(f+l.get("PlayerJoin",{user:e}));var h=v.createCursor(a.user.networkId,e,a.user.colorvalue.stroke);M==a.user.networkId&&(N=h)}-1===a.move&&(v.removeCursor(a.user.networkId),o.log(f+l.get("PlayerLeave",{user:e})),a.user.networkId==V[0].networkId&&V[1].networkId==M&&(document.getElementById(3).style.display="inline",document.getElementById(4).style.display="inline",P=!0))},U='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>',V={}})});