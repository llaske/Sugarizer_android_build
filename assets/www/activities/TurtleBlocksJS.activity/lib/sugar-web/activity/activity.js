/*! Sugarizer 2019-09-21 */
define(["webL10n.sugarizer","sugar-web/activity/shortcut","sugar-web/bus","sugar-web/env","sugar-web/datastore","sugar-web/presence","sugar-web/graphics/icon","sugar-web/graphics/activitypalette"],function(a,b,c,d,e,f,g,h){"use strict";var i=null,j=null,k=null,l={};return l.setup=function(){function m(){var a=document.createEvent("CustomEvent");a.initCustomEvent("activityPause",!1,!1,{cancelable:!0}),window.dispatchEvent(a)}function n(){var a=document.createEvent("CustomEvent");a.initCustomEvent("activityStop",!1,!1,{cancelable:!0}),window.dispatchEvent(a)&&i.save(function(){e.waitPendingSave(function(){l.close()})})}c.listen(),a.start(),c.onNotification("activity.pause",m),c.onNotification("activity.stop",n),i=new e.DatastoreObject;var o=document.getElementById("activity-button"),p=new h.ActivityPalette(o,i);l.getXOColor(function(a,b){g.colorize(o,b);var c=document.querySelector("#activity-palette .palette-invoker");g.colorize(c,b);var d='<?xml version="1.0" encoding="UTF-8" standalone="no"?>                <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" width="16" height="16" version="1.0" >                <g transform="translate(37.943468,-309.4636)">                <g transform="matrix(0.05011994,0,0,0.05012004,-41.76673,299.66011)" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-opacity:1">                <circle transform="matrix(0.969697,0,0,0.969697,-90.879133,125.06999)" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-width:20.62502098;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" cx="331.38321" cy="134.2677" r="51.220825" />                <path d="m 290.55846,302.47333 -58.81513,59.20058 -59.39461,-59.40024 c -25.19828,-24.48771 -62.7038,13.33148 -38.1941,37.98719 l 60.04451,58.9817 -59.73639,59.42563 c -24.83976,24.97559 12.91592,63.26505 37.66786,37.75282 l 59.95799,-59.28294 58.75912,59.21065 c 24.50656,25.09065 62.43116,-13.00322 37.87956,-37.85772 l -59.24184,-59.02842 58.87574,-59.14782 c 25.1689,-25.18348 -13.0489,-62.75154 -37.80271,-37.84143 z" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-width:20.00002098;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" />                </g></g></svg>';document.title=document.title+" - Sugarizer";var e=d.replace(new RegExp("&fill_color;","g"),b.fill).replace(new RegExp("&stroke_color;","g"),b.stroke),f=(new XMLSerializer).serializeToString((new DOMParser).parseFromString(e,"text/xml")),h=document.createElement("canvas");h.width=h.height=16;var i=h.getContext("2d"),j=new Image;j.src="data:image/svg+xml;base64,"+btoa(f),j.onload=function(){i.drawImage(j,0,0);var a=document.querySelector("link[rel*='icon']")||document.createElement("link");a.type="image/x-icon",a.rel="shortcut icon",a.href=h.toDataURL("image/x-icon"),document.getElementsByTagName("head")[0].appendChild(a)}}),document.getElementById("stop-button").addEventListener("click",function(a){n()}),b.add("Ctrl","Q",this.close),d.getEnvironment(function(a,b){var c={en:"{{name}} Activity",fr:"Activité {{name}}",es:"Actividad {{name}}",pt:"{{name}} Atividade",de:"Aktivität {{name}}"};b.objectId||i.setMetadata({title:(c[b.user.language]||c.en).replace("{{name}}",b.activityName),title_set_by_user:"0",activity:b.bundleId,activity_id:b.activityId}),d.isSugarizer()&&f.joinNetwork(function(a,c){b.sharedId&&c.joinSharedActivity(b.sharedId,function(){var a=c.getSharedInfo().colorvalue;g.colorize(o,a),i.setMetadata({buddy_color:a}),i.save(function(){})}),j?j(a,c):k={error:a,presence:c}}),i.save(function(){i.getMetadata(function(a,b){p.setTitleDescription(b)})}),b.standAlone&&(document.getElementById("stop-button").style.visibility="hidden")})},l.getDatastoreObject=function(){return i},l.getPresenceObject=function(a){return null==k?j=a:(a(k.error,k.presence),k=null),f},l.getXOColor=function(a){function b(b,c){null===b?a(null,{stroke:c[0][0],fill:c[0][1]}):a(null,{stroke:"#00A0FF",fill:"#8BFF7A"})}c.sendMessage("activity.get_xo_color",[],b)},l.close=function(a){function b(b,c){null===b?a(null):a(b,null)}c.sendMessage("activity.close",[],b)},l.showObjectChooser=function(a){function b(b,c){null===b?a(null,c[0]):a(b,null)}c.sendMessage("activity.show_object_chooser",[],b)},l});