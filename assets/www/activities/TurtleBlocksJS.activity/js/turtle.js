/*! Sugarizer 2020-03-14 */
function Turtle(a,b,c){this.name=a,this.turtles=b,this.drum=c,c&&console.log("turtle "+a+" is a drum."),this.running=!1,this.trash=!1,this.container=null,this.x=0,this.y=0,this.bitmap=null,this.skinChanged=!1,this.blinkFinished=!0,this.beforeBlinkSize=null,this.startBlock=null,this.decorationBitmap=null,this.queue=[],this.listeners={},this.penstrokes=null,this.imageContainer=null,this.svgOutput="",this.svgPath=!1,this.color=DEFAULTCOLOR,this.value=DEFAULTVALUE,this.chroma=DEFAULTCHROMA,this.stroke=DEFAULTSTROKE,this.canvasColor="rgba(255,0,49,1)",this.canvasAlpha=1,this.orientation=0,this.fillState=!1,this.hollowState=!1,this.penState=!0,this.font=DEFAULTFONT,this.media=[];var d=document.getElementById("overlayCanvas"),e=d.getContext("2d");this._svgArc=function(a,b,c,d,e,f){var g=e;if(null==f)var h=Math.PI/a;else var h=(f-e)/a;for(var i=0;i<a;i++){var j=b+d*Math.cos(g),k=c+d*Math.sin(g);this.svgOutput+=j+","+k+" ",g+=h}},this.doBezier=function(a,b,c,d,f,g){if(this.penState&&this.hollowState){var h=f,i=g,j=this.turtles.turtleX2screenX(this.x),k=this.turtles.turtleY2screenY(this.y),l=this.turtles.turtleX2screenX(f),m=this.turtles.turtleY2screenY(g),n=this.turtles.turtleX2screenX(a),o=this.turtles.turtleY2screenY(b),p=this.turtles.turtleX2screenX(c),q=this.turtles.turtleY2screenY(d);this.closeSVG();var r=this.stroke;if(this.stroke=1,e.lineWidth=this.stroke,e.lineCap="round",r<3)var s=.5;else var s=(r-2)/2;steps=Math.max(Math.floor(r,1));var t=Math.atan2(a-this.x,b-this.y);t=180*t/Math.PI,t<0&&(t+=360);var u=Math.atan2(h-c,i-d);u=180*u/Math.PI,u<0&&(u+=360);var v=(t-90)*Math.PI/180,w=s*Math.sin(v),x=-s*Math.cos(v),y=(u-90)*Math.PI/180,z=s*Math.sin(y),A=-s*Math.cos(y),B=j-w,C=k-x,D=B*this.turtles.scale,E=C*this.turtles.scale,F=l-z,G=m-A,H=(this.turtles.scale,this.turtles.scale,l+z),I=m+A,J=H*this.turtles.scale,K=I*this.turtles.scale,L=j+w,M=k+x,N=(this.turtles.scale,this.turtles.scale,(n+w)*this.turtles.scale),O=(o+x)*this.turtles.scale,P=(p+z)*this.turtles.scale,Q=(q+A)*this.turtles.scale;e.moveTo(B,C),this.svgPath=!0,this.svgOutput+='<path d="M '+D+","+E+" ";var R=(180+t)/180*Math.PI,S=j,T=k,U=R-Math.PI,V=R;e.arc(S,T,s,U,V,!1),this._svgArc(steps,S*this.turtles.scale,T*this.turtles.scale,s*this.turtles.scale,U,V),e.bezierCurveTo(n+w,o+x,p+z,q+A,H,I),this.svgOutput+="C "+N+","+O+" "+P+","+Q+" "+J+","+K+" ",this.svgOutput+="M "+J+","+K+" ";var R=u/180*Math.PI,S=l,T=m,U=R-Math.PI,V=R;e.arc(S,T,s,U,V,!1),this._svgArc(steps,S*this.turtles.scale,T*this.turtles.scale,s*this.turtles.scale,U,V),e.bezierCurveTo(p-z,q-A,n-w,o-x,B,C),this.svgOutput+="C "+P+","+Q+" "+N+","+O+" "+D+","+E+" ",this.closeSVG(),e.stroke(),e.closePath(),this.stroke=r,e.lineWidth=this.stroke,e.lineCap="round",e.moveTo(l,m),this.x=f,this.y=g}else if(this.penState){"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var W=this.canvasColor.substr(0,this.canvasColor.length-2);e.strokeStyle=W+this.canvasAlpha+")",e.fillStyle=W+this.canvasAlpha+")",e.lineWidth=this.stroke,e.lineCap="round",e.beginPath(),e.moveTo(this.container.x,this.container.y);var l=this.turtles.turtleX2screenX(f),m=this.turtles.turtleY2screenY(g),n=this.turtles.turtleX2screenX(a),o=this.turtles.turtleY2screenY(b),p=this.turtles.turtleX2screenX(c),q=this.turtles.turtleY2screenY(d);if(e.bezierCurveTo(n,o,p,q,l,m),!this.svgPath){this.svgPath=!0;var j=this.turtles.turtleX2screenX(this.x),k=this.turtles.turtleY2screenY(this.y),X=j*this.turtles.scale,Y=k*this.turtles.scale;this.svgOutput+='<path d="M '+X+","+Y+" "}var N=n*this.turtles.scale,O=o*this.turtles.scale,P=p*this.turtles.scale,Q=q*this.turtles.scale,Z=l*this.turtles.scale,$=m*this.turtles.scale;this.svgOutput+="C "+N+","+O+" "+P+","+Q+" "+Z+","+$,this.x=f,this.y=g,e.stroke(),this.fillState||e.closePath()}else{this.x=f,this.y=g;var l=this.turtles.turtleX2screenX(f),m=this.turtles.turtleY2screenY(g)}this.container.x=l,this.container.y=m;var _=Math.atan2(h-c,i-d);_=180*_/Math.PI,this.doSetHeading(_)},this.move=function(a,b,c,f,g){if(g?(a=this.turtles.turtleX2screenX(a),b=this.turtles.turtleY2screenY(b),nx=this.turtles.turtleX2screenX(c),ny=this.turtles.turtleY2screenY(f)):(nx=c,ny=f),this.penState&&this.hollowState){this.closeSVG(),this.svgPath=!0;var h=this.stroke;if(this.stroke=1,e.lineWidth=this.stroke,e.lineCap="round",h<3)var i=.5;else var i=(h-2)/2;var j=(this.orientation-90)*Math.PI/180,k=i*Math.sin(j),l=-i*Math.cos(j);e.moveTo(a+k,b+l);var m=(a+k)*this.turtles.scale,n=(b+l)*this.turtles.scale;this.svgOutput+='<path d="M '+m+","+n+" ",e.lineTo(nx+k,ny+l);var o=(nx+k)*this.turtles.scale,p=(ny+l)*this.turtles.scale;this.svgOutput+=o+","+p+" ";var j=(this.orientation+90)*Math.PI/180,k=i*Math.sin(j),l=-i*Math.cos(j),q=this.orientation/180*Math.PI,r=nx,s=ny,t=q-Math.PI,u=q;e.arc(r,s,i,t,u,!1);var o=(nx+k)*this.turtles.scale,p=(ny+l)*this.turtles.scale,v=i*this.turtles.scale;steps=Math.max(Math.floor(h,1)),this._svgArc(steps,r*this.turtles.scale,s*this.turtles.scale,v,t),this.svgOutput+=o+","+p+" ",e.lineTo(a+k,b+l);var o=(a+k)*this.turtles.scale,p=(b+l)*this.turtles.scale;this.svgOutput+=o+","+p+" ";var j=(this.orientation-90)*Math.PI/180,k=i*Math.sin(j),l=-i*Math.cos(j),q=(this.orientation+180)/180*Math.PI,r=a,s=b,t=q-Math.PI,u=q;e.arc(r,s,i,t,u,!1);var o=(a+k)*this.turtles.scale,p=(b+l)*this.turtles.scale,v=i*this.turtles.scale;this._svgArc(steps,r*this.turtles.scale,s*this.turtles.scale,v,t),this.svgOutput+=o+","+p+" ",this.closeSVG(),e.stroke(),e.closePath(),this.stroke=h,e.lineWidth=this.stroke,e.lineCap="round",e.moveTo(nx,ny)}else if(this.penState){if(e.lineTo(nx,ny),!this.svgPath){this.svgPath=!0;var m=a*this.turtles.scale,n=b*this.turtles.scale;this.svgOutput+='<path d="M '+m+","+n+" "}var o=nx*this.turtles.scale,p=ny*this.turtles.scale;this.svgOutput+=o+","+p+" ",e.stroke(),this.fillState||e.closePath()}else e.moveTo(nx,ny);this.penstrokes.image=d,this.container.x=nx,this.container.y=ny,g?(this.x=c,this.y=f):(this.x=this.turtles.screenX2turtleX(c),this.y=this.turtles.screenY2turtleY(f))},this.rename=function(a){this.name=a,null!=this.startBlock&&(this.startBlock.overrideName=this.name,this.name===_("start drum")?this.startBlock.collapseText.text=_("drum"):this.startBlock.collapseText.text=this.name,this.startBlock.regenerateArtwork(!1),this.startBlock.value=this.turtles.turtleList.indexOf(this))},this.arc=function(a,b,c,d,f,g,h,i,j,k,l){if(l?(a=this.turtles.turtleX2screenX(a),b=this.turtles.turtleY2screenY(b),c=this.turtles.turtleX2screenX(c),d=this.turtles.turtleY2screenY(d),nx=this.turtles.turtleX2screenX(f),ny=this.turtles.turtleY2screenY(g)):(nx=f,ny=g),k?(sa=i,ea=j):(sa=i-Math.PI,ea=j-Math.PI),this.penState&&this.hollowState){this.closeSVG(),this.svgPath=!0;var m=this.stroke;if(this.stroke=1,e.lineWidth=this.stroke,e.lineCap="round",m<3)var n=.5;else var n=(m-2)/2;var o=(this.orientation+90)*Math.PI/180,p=n*Math.sin(o),q=-n*Math.cos(o);if(k){e.moveTo(c+p,d+q);var r=(c+p)*this.turtles.scale,s=(d+q)*this.turtles.scale}else{e.moveTo(c-p,d-q);var r=(c-p)*this.turtles.scale,s=(d-q)*this.turtles.scale}this.svgOutput+='<path d="M '+r+","+s+" ",e.arc(a,b,h+n,sa,ea,k),nsteps=Math.max(Math.floor(h*Math.abs(sa-ea)/2),2),steps=Math.max(Math.floor(m,1)),this._svgArc(nsteps,a*this.turtles.scale,b*this.turtles.scale,(h+n)*this.turtles.scale,sa,ea);var o=(this.orientation+90)*Math.PI/180,p=n*Math.sin(o),q=-n*Math.cos(o),t=nx,u=ny,v=ea,w=ea+Math.PI;e.arc(t,u,n,v,w,k),this._svgArc(steps,t*this.turtles.scale,u*this.turtles.scale,n*this.turtles.scale,v,w),e.arc(a,b,h-n,ea,sa,!k),this._svgArc(nsteps,a*this.turtles.scale,b*this.turtles.scale,(h-n)*this.turtles.scale,ea,sa);var x=c,y=d,z=sa-Math.PI,A=sa;e.arc(x,y,n,z,A,k),this._svgArc(steps,x*this.turtles.scale,y*this.turtles.scale,n*this.turtles.scale,z,A),this.closeSVG(),e.stroke(),e.closePath(),this.stroke=m,e.lineWidth=this.stroke,e.lineCap="round",e.moveTo(nx,ny)}else if(this.penState){if(e.arc(a,b,h,sa,ea,k),!this.svgPath){this.svgPath=!0;var r=c*this.turtles.scale,s=d*this.turtles.scale;this.svgOutput+='<path d="M '+r+","+s+" "}if(k)var B=0;else var B=1;var C=nx*this.turtles.scale,D=ny*this.turtles.scale,E=h*this.turtles.scale;this.svgOutput+="A "+E+","+E+" 0 0 "+B+" "+C+","+D+" ",e.stroke(),this.fillState||e.closePath()}else e.moveTo(nx,ny);this.container.x=nx,this.container.y=ny,l?(this.x=f,this.y=g):(this.x=this.screenX2turtles.turtleX(f),this.y=this.screenY2turtles.turtleY(g))},this.doClear=function(a,b){if(this.x=0,this.y=0,this.orientation=0,a){var c=this.turtles.turtleList.indexOf(this)%10;this.color=10*c,this.value=DEFAULTVALUE,this.chroma=DEFAULTCHROMA,this.stroke=DEFAULTSTROKE,this.font=DEFAULTFONT}this.container.x=this.turtles.turtleX2screenX(this.x),this.container.y=this.turtles.turtleY2screenY(this.y),b&&(this.drum?this.name!==_("start drum")&&this.rename(_("start drum")):this.name!==_("start")&&this.rename(_("start")),this.skinChanged&&(this.doTurtleShell(55,TURTLEBASEPATH+"turtle-"+c.toString()+".svg"),this.skinChanged=!1)),this.bitmap.rotation=this.orientation,this.updateCache();for(var c=0;c<this.media.length;c++)this.imageContainer.removeChild(this.media[c]),this.turtles.stage.removeChild(this.media[c]),delete this.media[c];this.media=[],this.penState=!0,this.fillState=!1,this.hollowState=!1,this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1])),this.svgOutput="",this.svgPath=!1,this.penstrokes.image=null,e.beginPath(),e.clearRect(0,0,d.width,d.height),this.penstrokes.image=d,this.turtles.refreshCanvas()},this.clearPenStrokes=function(){this.penState=!0,this.fillState=!1,this.hollowState=!1,this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1])),e.beginPath(),e.clearRect(0,0,d.width,d.height);var a=this.canvasColor.substr(0,this.canvasColor.length-2);e.strokeStyle=a+this.canvasAlpha+")",e.fillStyle=a+this.canvasAlpha+")",e.lineWidth=this.stroke,e.lineCap="round",e.beginPath(),this.penstrokes.image=d,this.svgOutput="",this.svgPath=!1,this.turtles.refreshCanvas()},this.doForward=function(a){if(!this.fillState){"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var b=this.canvasColor.substr(0,this.canvasColor.length-2);e.strokeStyle=b+this.canvasAlpha+")",e.fillStyle=b+this.canvasAlpha+")",e.lineWidth=this.stroke,e.lineCap="round",e.beginPath(),e.moveTo(this.container.x,this.container.y)}var c=this.turtles.screenX2turtleX(this.container.x),d=this.turtles.screenY2turtleY(this.container.y),f=this.orientation*Math.PI/180,g=c+Number(a)*Math.sin(f),h=d+Number(a)*Math.cos(f);this.move(c,d,g,h,!0),this.turtles.refreshCanvas()},this.doSetXY=function(a,b){if(!this.fillState){"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var c=this.canvasColor.substr(0,this.canvasColor.length-2);e.strokeStyle=c+this.canvasAlpha+")",e.fillStyle=c+this.canvasAlpha+")",e.lineWidth=this.stroke,e.lineCap="round",e.beginPath(),e.moveTo(this.container.x,this.container.y)}var d=this.turtles.screenX2turtleX(this.container.x),f=this.turtles.screenY2turtleY(this.container.y),g=Number(a),h=Number(b);this.move(d,f,g,h,!0),this.turtles.refreshCanvas()},this.doArc=function(a,b){b<0&&(b=-b);var c=Number(a);if(c<0){var d=-1;c=-c}else var d=1;for(var e=c%90,f=Math.floor(c/90),g=0;g<f;g++)this._doArcPart(90*d,b);e>0&&this._doArcPart(e*d,b)},this._doArcPart=function(a,b){if(!this.fillState){"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var c=this.canvasColor.substr(0,this.canvasColor.length-2);e.strokeStyle=c+this.canvasAlpha+")",e.fillStyle=c+this.canvasAlpha+")",e.lineWidth=this.stroke,e.lineCap="round",e.beginPath(),e.moveTo(this.container.x,this.container.y)}var d=Number(a),f=d/180*Math.PI,g=this.orientation/180*Math.PI,h=Number(b);if(ox=this.turtles.screenX2turtleX(this.container.x),oy=this.turtles.screenY2turtleY(this.container.y),d<0){var i=!0;d=-d;var j=ox-Math.cos(g)*h,k=oy+Math.sin(g)*h,l=j+Math.cos(g+f)*h,m=k-Math.sin(g+f)*h}else var i=!1,j=ox+Math.cos(g)*h,k=oy-Math.sin(g)*h,l=j-Math.cos(g+f)*h,m=k+Math.sin(g+f)*h;this.arc(j,k,ox,oy,l,m,h,g,g+f,i,!0),i?this.doRight(-d):this.doRight(d),this.turtles.refreshCanvas()},this.doShowImage=function(a,b){if(null!==b){var c=new Image,d=this;c.onload=function(){var b=new createjs.Bitmap(c);d.imageContainer.addChild(b),d.media.push(b),b.scaleX=Number(a)/c.width,b.scaleY=b.scaleX,b.scale=b.scaleX,b.x=d.container.x,b.y=d.container.y,b.regX=c.width/2,b.regY=c.height/2,b.rotation=d.orientation,d.turtles.refreshCanvas()},c.src=b}},this.doShowURL=function(a,b){if(null!==b){var c=new Image;c.src=b;var d=this;c.onload=function(){var b=new createjs.Bitmap(c);d.imageContainer.addChild(b),d.media.push(b),b.scaleX=Number(a)/c.width,b.scaleY=b.scaleX,b.scale=b.scaleX,b.x=d.container.x,b.y=d.container.y,b.regX=c.width/2,b.regY=c.height/2,b.rotation=d.orientation,d.turtles.refreshCanvas()}}},this.doTurtleShell=function(a,b){if(null!==b){var c=new Image;c.src=b;var d=this;c.onload=function(){d.container.removeChild(d.bitmap),d.bitmap=new createjs.Bitmap(c),d.container.addChild(d.bitmap),d.bitmap.scaleX=Number(a)/c.width,d.bitmap.scaleY=d.bitmap.scaleX,d.bitmap.scale=d.bitmap.scaleX,d.bitmap.x=0,d.bitmap.y=0,d.bitmap.regX=c.width/2,d.bitmap.regY=c.height/2,d.bitmap.rotation=d.orientation,d.skinChanged=!0,d.container.uncache();var e=d.container.getBounds();d.container.cache(e.x,e.y,e.width,e.height);var f=new createjs.Shape;if(f.graphics.beginFill("#FFF").drawRect(0,0,e.width,e.height),f.x=-e.width/2,f.y=-e.height/2,d.container.hitArea=f,null!=d.startBlock){d.startBlock.container.removeChild(d.decorationBitmap),d.decorationBitmap=new createjs.Bitmap(b),d.startBlock.container.addChild(d.decorationBitmap),d.decorationBitmap.name="decoration";var e=d.startBlock.container.getBounds();d.decorationBitmap.x=e.width-50*d.startBlock.protoblock.scale/2,d.decorationBitmap.y=20*d.startBlock.protoblock.scale/2,d.decorationBitmap.scaleX=27.5/c.width*d.startBlock.protoblock.scale/2,d.decorationBitmap.scaleY=27.5/c.height*d.startBlock.protoblock.scale/2,d.decorationBitmap.scale=27.5/c.width*d.startBlock.protoblock.scale/2,d.startBlock.updateCache()}d.turtles.refreshCanvas()}}},this.resizeDecoration=function(a,b){this.decorationBitmap.x=b-30*a/2,this.decorationBitmap.y=35*a/2,this.decorationBitmap.scaleX=this.decorationBitmap.scaleY=this.decorationBitmap.scale=.5*a/2},this.doShowText=function(a,b){var c=a.toString()+"px "+this.font,d=new createjs.Text(b.toString(),c,this.canvasColor);d.textAlign="left",d.textBaseline="alphabetic",this.turtles.stage.addChild(d),this.media.push(d),d.x=this.container.x,d.y=this.container.y,d.rotation=this.orientation;var e=d.x*this.turtles.scale,f=d.y*this.turtles.scale,g=a*this.turtles.scale;this.svgOutput+='<text x="'+e+'" y = "'+f+'" fill="'+this.canvasColor+'" font-family = "'+this.font+'" font-size = "'+g+'">'+b+"</text>",this.turtles.refreshCanvas()},this.doRight=function(a){this.orientation+=Number(a),this.orientation%=360,this.bitmap.rotation=this.orientation,this.blinkFinished&&this.updateCache()},this.doSetHeading=function(a){this.orientation=Number(a),this.orientation%=360,this.bitmap.rotation=this.orientation,this.blinkFinished&&this.updateCache()},this.doSetFont=function(a){this.font=a,this.updateCache()},this.doSetColor=function(a){this.closeSVG(),this.color=Number(a);var b=getcolor(this.color);this.canvasValue=b[0],this.canvasChroma=b[1],this.canvasColor=b[2],"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var c=this.canvasColor.substr(0,this.canvasColor.length-2);e.strokeStyle=c+this.canvasAlpha+")",e.fillStyle=c+this.canvasAlpha+")"},this.doSetPenAlpha=function(a){this.canvasAlpha=a},this.doSetHue=function(a){this.closeSVG(),this.color=Number(a),this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var b=this.canvasColor.substr(0,this.canvasColor.length-2);e.strokeStyle=b+this.canvasAlpha+")",e.fillStyle=b+this.canvasAlpha+")"},this.doSetValue=function(a){this.closeSVG(),this.value=Number(a),this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var b=this.canvasColor.substr(0,this.canvasColor.length-2);e.strokeStyle=b+this.canvasAlpha+")",e.fillStyle=b+this.canvasAlpha+")"},this.doSetChroma=function(a){this.closeSVG(),this.chroma=Number(a),this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),"#"===this.canvasColor[0]&&(this.canvasColor=hex2rgb(this.canvasColor.split("#")[1]));var b=this.canvasColor.substr(0,this.canvasColor.length-2);e.strokeStyle=b+this.canvasAlpha+")",e.fillStyle=b+this.canvasAlpha+")"},this.doSetPensize=function(a){this.closeSVG(),this.stroke=a,e.lineWidth=this.stroke},this.doPenUp=function(){this.closeSVG(),this.penState=!1},this.doPenDown=function(){this.penState=!0},this.doStartFill=function(){e.beginPath(),this.fillState=!0},this.doEndFill=function(){e.fill(),e.closePath(),this.closeSVG(),this.fillState=!1},this.doStartHollowLine=function(){this.hollowState=!0},this.doEndHollowLine=function(){this.hollowState=!1},this.closeSVG=function(){if(this.svgPath){var a=this.canvasColor.replace(/rgba/g,"rgb");a=a.substr(0,this.canvasColor.length-4)+");",this.svgOutput+='" style="stroke-linecap:round;fill:',this.fillState?this.svgOutput+=a+"fill-opacity:"+this.canvasAlpha+";":this.svgOutput+="none;",this.svgOutput+="stroke:"+a+"stroke-opacity:"+this.canvasAlpha+";";var b=this.stroke*this.turtles.scale;this.svgOutput+="stroke-width:"+b+'pt;" />',this.svgPath=!1}},this.createCache=function(){var a=this;a.bounds=a.container.getBounds(),null==a.bounds?setTimeout(function(){a.createCache()},200):a.container.cache(a.bounds.x,a.bounds.y,a.bounds.width,a.bounds.height)},this.updateCache=function(){var a=this;null==a.bounds?(console.log("Block container for "+a.name+" not yet ready."),setTimeout(function(){a.updateCache()},300)):(a.container.updateCache(),a.turtles.refreshCanvas())},this.blink=function(a,b){var c,d=this;0==this.blinkFinished?c=this.beforeBlinkSize:(c=d.bitmap.scaleX,this.beforeBlinkSize=c),this.blinkFinished=!1,d.container.uncache();var e=60/55,f=4*(b+200)/1e3;d.bitmap.alpha=.5,d.bitmap.scaleX=c*e*f,d.bitmap.scaleY=d.bitmap.scaleX,d.bitmap.scale=d.bitmap.scaleX;var g=d.skinChanged;d.skinChanged=!0,createjs.Tween.get(d.bitmap).to({alpha:1,scaleX:c,scaleY:c,scale:c},500/a),setTimeout(function(){d.bitmap.scaleX=c,d.bitmap.scaleY=d.bitmap.scaleX,d.bitmap.scale=d.bitmap.scaleX,d.bitmap.rotation=d.orientation,d.skinChanged=g;var a=d.container.getBounds();d.container.cache(a.x,a.y,a.width,a.height),d.blinkFinished=!0},500/a)}}function Turtles(){this.stage=null,this.refreshCanvas=null,this.scale=1,this._canvas=null,this._rotating=!1,this._drum=!1,this.turtleList=[],this.setCanvas=function(a){return this._canvas=a,this},this.setStage=function(a){return this.stage=a,this},this.setRefreshCanvas=function(a){return this.refreshCanvas=a,this},this.setScale=function(a){return this.scale=a,this},this.setBlocks=function(a){return this.blocks=a,this},this.addDrum=function(a,b){this._drum=!0,this.add(a,b)},this.addTurtle=function(a,b){this._drum=!1,this.add(a,b)},this.add=function(a,b){function c(a,b,c,d){if(g.bitmap=c,g.bitmap.regX=27,g.bitmap.regY=27,g.bitmap.cursor="pointer",g.container.addChild(g.bitmap),g.createCache(),g.startBlock=d,null!=d){d.updateCache(),g.decorationBitmap=g.bitmap.clone(),d.container.addChild(g.decorationBitmap),g.decorationBitmap.name="decoration";var e=d.container.getBounds();if(null==d.expandBitmap)var f=75;else var f=40;g.decorationBitmap.x=e.width-f*d.protoblock.scale/2,g.decorationBitmap.y=35*d.protoblock.scale/2,g.decorationBitmap.scaleX=g.decorationBitmap.scaleY=g.decorationBitmap.scale=.5*d.protoblock.scale/2,d.updateCache()}a.refreshCanvas()}null!=a?(console.log("adding a new turtle "+a.name),a.value!==this.turtleList.length&&(a.value=this.turtleList.length,console.log("turtle #"+a.value))):console.log("adding a new turtle startBlock is null");var d=!1;"object"==typeof b&&8===Object.keys(b).length&&(d=!0);var e=this.turtleList.length,f=e.toString(),g=new Turtle(f,this,this._drum);d&&(g.x=b.xcor,g.y=b.ycor),this.turtleList.push(g),g.imageContainer=new createjs.Container,this.stage.addChild(g.imageContainer),g.penstrokes=new createjs.Bitmap,this.stage.addChild(g.penstrokes);new Image;e%=10,g.container=new createjs.Container,this.stage.addChild(g.container),g.container.x=this.turtleX2screenX(g.x),g.container.y=this.turtleY2screenY(g.y);var h=new createjs.Shape;if(h.graphics.beginFill("#FFF").drawEllipse(-27,-27,55,55),h.x=0,h.y=0,g.container.hitArea=h,this._drum)var i=DRUMSVG;else var i=TURTLESVG;sugarizerCompatibility.isInsideSugarizer()?this._makeTurtleBitmap(i.replace(/fill_color/g,sugarizerCompatibility.xoColor.fill).replace(/stroke_color/g,sugarizerCompatibility.xoColor.stroke),"turtle",c,a):this._makeTurtleBitmap(i.replace(/fill_color/g,FILLCOLORS[e]).replace(/stroke_color/g,STROKECOLORS[e]),"turtle",c,a),g.color=10*e,g.canvasColor=getMunsellColor(g.color,DEFAULTVALUE,DEFAULTCHROMA);var j=this;g.container.on("mousedown",function(a){if(!j._rotating){var b={x:g.container.x-a.stageX/j.scale,y:g.container.y-a.stageY/j.scale};g.container.on("pressmove",function(a){g.running||(g.container.x=a.stageX/j.scale+b.x,g.container.y=a.stageY/j.scale+b.y,g.x=j.screenX2turtleX(g.container.x),g.y=j.screenY2turtleY(g.container.y),j.refreshCanvas())})}}),g.container.on("click",function(a){console.log("--\x3e [click"+g.name+"]"),j.stage.dispatchEvent("click"+g.name)}),g.container.on("mouseover",function(a){g.bitmap.scaleX=1.2,g.bitmap.scaleY=1.2,g.bitmap.scale=1.2,j.refreshCanvas()}),g.container.on("mouseout",function(a){g.bitmap.scaleX=1,g.bitmap.scaleY=1,g.bitmap.scale=1,j.refreshCanvas()}),document.getElementById("loader").className="",setTimeout(function(){d&&(g.doSetHeading(b.heading),g.doSetPensize(b.pensize),g.doSetChroma(b.grey),g.doSetValue(b.shade),g.doSetColor(b.color))},1e3),this.refreshCanvas()},this._makeTurtleBitmap=function(a,b,c,d){var e=new Image,f=this;e.onload=function(){complete=!0;var a=new createjs.Bitmap(e);c(f,b,a,d)},e.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(a)))},this.screenX2turtleX=function(a){return a-this._canvas.width/(2*this.scale)},this.screenY2turtleY=function(a){return this.invertY(a)},this.turtleX2screenX=function(a){return this._canvas.width/(2*this.scale)+a},this.turtleY2screenY=function(a){return this.invertY(a)},this.invertY=function(a){return this._canvas.height/(2*this.scale)-a},this.markAsStopped=function(){for(var a in this.turtleList)this.turtleList[a].running=!1},this.running=function(){for(var a in this.turtleList)if(this.turtleList[a].running)return!0;return!1}}function Queue(a,b,c,d){this.blk=a,this.count=b,this.parentBlk=c,this.args=d}function hex2rgb(a){var b=parseInt(a,16);return"rgba("+(b>>16&255)+","+(b>>8&255)+","+(255&b)+",1)"}const DEFAULTCOLOR=0,DEFAULTVALUE=50,DEFAULTCHROMA=100,DEFAULTSTROKE=5,DEFAULTFONT="sans-serif",TURTLEBASEPATH="images/";