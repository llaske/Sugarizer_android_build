/*! Sugarizer 2020-03-14 */
function Blocks(){return sugarizerCompatibility.isInsideSugarizer()?storage=sugarizerCompatibility.data:storage=localStorage,this.canvas=null,this.stage=null,this.refreshCanvas=null,this.trashcan=null,this.updateStage=null,this.getStageScale=null,this.trashStacks=[],this.protoBlockDict={},this.blockList=[],this.mouseDownTime=0,this.longPressTimeout=null,this.selectingStack=!1,this.selectedStack=null,this.selectedBlocksObj=null,this._loopCounter=0,this._sizeCounter=0,this._searchCounter=0,this.palettes=null,this.highlightedBlock=null,this.activeBlock=null,this.visible=!0,this.dragGroup=[],this.stackList=[],this._expandablesList=[],this._loadCounter=0,this._adjustTheseDocks=[],this.blocksToCollapse=[],this._checkTwoArgBlocks=[],this._checkArgClampBlocks=[],this._clampBlocksToCheck=[],this._expandableBlocks=[],this.clampBlocks=[],this.doubleExpandable=[],this.argClampBlocks=[],this.argBlocks=[],this.valueBlocks=[],this.twoArgBlocks=[],this.noRunBlocks=[],this._homeButtonContainers=[],this.blockScale=DEFAULTBLOCKSCALE,this.inLongPress=!1,this.deleteActionTimeout=0,this.setCanvas=function(a){return this.canvas=a,this},this.setStage=function(a){return this.stage=a,this},this.setRefreshCanvas=function(a){return this.refreshCanvas=a,this},this.setTrashcan=function(a){return this.trashcan=a,this},this.setUpdateStage=function(a){return this.updateStage=a,this},this.setGetStageScale=function(a){return this.getStageScale=a,this},this.setBlockScale=function(a){console.log("New block scale is "+a),this.blockScale=a;for(var b=0;b<this.blockList.length;b++)this.blockList[b].resize(a);this.findStacks();for(var c=0;c<this.stackList.length;c++)this.adjustDocks(this.stackList[c],!0);for(var d in this.palettes.dict)for(var b=0;b<this.palettes.dict[d].protoList.length;b++)this.palettes.dict[d].protoList[b].scale=a},this.setMsgText=function(a){this.msgText=a},this.setErrorMsg=function(a){return this.errorMsg=a,this},this.setMacroDictionary=function(a){return this.macroDict=a,this},this.setTurtles=function(a){return this.turtles=a,this},this.setLogo=function(a){return this.logo=a,this},this.setScale=function(a){return this.blockScale=a,this},this.toggleCollapsibles=function(){for(var a in this.blockList){var b=this.blockList[a];-1===COLLAPSABLES.indexOf(b.name)||b.trash||b.collapseToggle()}},this.setHomeContainers=function(a,b){return this._homeButtonContainers=a,this.boundary=b,this},this.makeCopyPasteButtons=function(a,b){var c=this;this.updatePasteButton=b,this.dismissButton=a("cancel-button","",0,0,55,0,this.stage),this.dismissButton.visible=!1,this.saveStackButton=a("save-blocks-button",_("Save stack"),0,0,55,0,this.stage),this.saveStackButton.visible=!1,this.dismissButton.on("click",function(a){c.saveStackButton.visible=!1,c.dismissButton.visible=!1,c.inLongPress=!1,c.refreshCanvas()}),this.saveStackButton.on("click",function(a){var b=c.findTopBlock(c.activeBlock);c.inLongPress=!1,c.selectedStack=b,c.saveStackButton.visible=!1,c.dismissButton.visible=!1,c.saveStack(),c.refreshCanvas()})},this.findBlockTypes=function(){for(var a in this.protoBlockDict)this.protoBlockDict[a].expandable&&this._expandableBlocks.push(this.protoBlockDict[a].name),"clamp"===this.protoBlockDict[a].style&&this.clampBlocks.push(this.protoBlockDict[a].name),"argclamp"===this.protoBlockDict[a].style&&this.argClampBlocks.push(this.protoBlockDict[a].name),"argflowclamp"===this.protoBlockDict[a].style&&this.clampBlocks.push(this.protoBlockDict[a].name),"argclamparg"===this.protoBlockDict[a].style&&(this.argClampBlocks.push(this.protoBlockDict[a].name),this.argBlocks.push(this.protoBlockDict[a].name)),"twoarg"===this.protoBlockDict[a].style&&this.twoArgBlocks.push(this.protoBlockDict[a].name),"arg"===this.protoBlockDict[a].style&&this.argBlocks.push(this.protoBlockDict[a].name),"value"===this.protoBlockDict[a].style&&(this.argBlocks.push(this.protoBlockDict[a].name),this.valueBlocks.push(this.protoBlockDict[a].name)),"doubleclamp"===this.protoBlockDict[a].style&&this.doubleExpandable.push(this.protoBlockDict[a].name)},this._actionBlock=function(a){return-1!==["do","doArg","calc","calcArg"].indexOf(a)},this._namedActionBlock=function(a){return-1!==["nameddo","nameddoArg","namedcalc","namedcalcArg"].indexOf(a)},this._adjustBlockPositions=function(){this.dragGroup.length<2||this.adjustDocks(this.dragGroup[0],!0)},this._adjustExpandableClampBlock=function(){function a(a,b,c,d){if(c.isArgFlowClampBlock())var e=1;else if(0===d)var e=c.connections.length-2;else var e=c.connections.length-3;a._sizeCounter=0;var f=1;e>0&&null!=c.connections[e]&&(f=Math.max(a._getStackSize(c.connections[e]),1));var g=f-c.clampCount[d];0!==g&&(0===f&&1===c.clampCount[d]||c.updateSlots(d,g)),setTimeout(function(){a._clampBlocksToCheck.length>0&&a._adjustExpandableClampBlock()},250)}if(0!==this._clampBlocksToCheck.length){var b=this._clampBlocksToCheck.pop(),c=b[0],d=b[1],e=this.blockList[c];if(e.isArgFlowClampBlock());else{if(e.isArgBlock()||e.isTwoArgBlock())return;if(e.isArgClamp())return void this._adjustArgClampBlock([c])}a(this,c,e,d)}},this._getBlockSize=function(a){return this.blockList[a].size},this._adjustArgClampBlock=function(a){if(0!==a.length){var b=a.pop(),c=this.blockList[b];if(-1!==["doArg","calcArg"].indexOf(c.name))var d=2;else var d=1;for(var e=c.argClampSlots,f=!1,g=0;g<e.length;g++){var h=c.connections[d+g],i=1;null!=h&&(i=Math.max(this._getBlockSize(h),1)),e[g]!==i&&(e[g]=i,f=!0)}f&&c.updateArgSlots(e)}},this._adjustExpandableTwoArgBlock=function(a){if(0!==a.length){var b=a.pop(),c=this.blockList[b],d=c.connections[1],e=1;null!=d&&(e=Math.max(this._getBlockSize(d),1));var f=e-c.clampCount[0];0!==f&&0!==e&&c.updateSlots(0,f)}},this._addRemoveVspaceBlock=function(a){function b(a){var c=a[0],d=a[1],e=a[2],f=a[3],h=a[4],i=g.blockList[e],j=last(c.docks),k=j[0]-i.docks[0][0],l=j[1]-i.docks[0][1];if(i.container.x=c.container.x+k,i.container.y=c.container.y+l,i.connections[0]=g.blockList.indexOf(c),i.connections[1]=d,c.connections[c.connections.length-1]=e,d&&(g.blockList[d].connections[0]=e),f+1<h){var m=g.blockList.length;c=last(g.blockList),d=last(c.connections),g._makeNewBlockWithConnections("vspace",m,[null,null],b,[c,d,m,f+1,h])}}function c(a){var b=last(g.blockList[a].connections);return b&&"vspace"===g.blockList[b].name?1+c(b):0}var d=this.blockList[a],e=d.connections[d.connections.length-2],f=1;if(null!=e)var f=Math.max(this._getBlockSize(e),1);var g=this,h=c(a);if(f<h+1)for(var i=Math.abs(f-h-1),j=0;j<i;j++){var k=d.connections.length-1,l=this.blockList[d.connections[k]],m=l.connections[1];d.connections[k]=m,null!=m&&(this.blockList[m].connections[0]=a),l.connections=[null,null],l.trash=!0,l.hide()}else if(f>h+1){var i=f-h-1,n=last(d.connections),o=d,p=this.blockList.length,g=this;this._makeNewBlockWithConnections("vspace",p,[null,null],b,[o,n,p,0,i])}},this._getStackSize=function(a){var b=0;if(this._sizeCounter+=1,this._sizeCounter>2*this.blockList.length)return console.log("Infinite loop encountered detecting size of expandable block? "+a),b;if(null==a)return b;var c=this.blockList[a];if(null==c&&console.log("Something very broken in _getStackSize."),c.isClampBlock()){var d=c.connections.length-2,e=0;if(d>0){var f=c.connections[d];null!=f&&(e=this._getStackSize(f)),b=0===e?1:e}if(c.isDoubleClampBlock()){var d=c.connections.length-3,e=0;if(d>0){var f=c.connections[d];null!=f&&(e=this._getStackSize(f)),b+=0===e?1:e}}b+=c.size}else b=c.size;if(!c.isValueBlock()){var f=last(c.connections);null!=f&&(b+=this._getStackSize(f))}return b},this.adjustDocks=function(a,b){var c=this.blockList[a];if(null!=b&&(this._loopCounter=0),null==c)return void console.log("Saw a null block: "+a);if(null==c.connections)return void console.log("Saw a block with null connections: "+a);if(0===c.connections.length)return void console.log("Saw a block with [] connections: "+a);if(1!==c.docks.length){if(this._loopCounter+=1,this._loopCounter>2*this.blockList.length)return void console.log("Infinite loop encountered while adjusting docks: "+a+" "+this.blockList);if(c.isTwoArgBooleanBlock())var d=0;else var d=1;for(var e=d;e<c.connections.length;e++){var f=c.docks[e],g=c.connections[e];if(null!=g)if(null!=this.blockList[g]){for(var h=!1,i=0;i<this.blockList[g].connections.length;i++)if(this.blockList[g].connections[i]===a){h=!0;break}if(!h){console.log("Did not find match for "+c.name+" ("+a+") and "+this.blockList[g].name+" ("+g+")"),console.log(c.connections),console.log(this.blockList[g].connections);break}var j=this.blockList[g].docks[i];if(e>0){var k=f[0]-j[0],l=f[1]-j[1];if(null==c.container)console.log("Does this ever happen any more?");else var m=c.container.x+k,n=c.container.y+l;this._moveBlock(g,m,n)}else{var k=j[0]-f[0],l=j[1]-f[1],m=this.blockList[g].container.x+k,n=this.blockList[g].container.y+l;this._moveBlock(a,m,n)}e>0&&this.adjustDocks(g,!0)}else console.log("This is not good: we encountered a null block: "+g)}}},this.addDefaultBlock=function(a,b,c){if(null!=a)if("action"===this.blockList[a].name){var d=this.blockList[a].connections[1];if(null==d){var e=this;postProcess=function(a){var b=a[0],d=a[1],f=e.blockList.length-1;e.blockList[b].connections[1]=f,e.blockList[f].value=e.findUniqueActionName(_("action"));var g=e.blockList[f].value;if(g.length>8&&(g=g.substr(0,7)+"..."),e.blockList[f].text.text=g,e.blockList[f].container.updateCache(),e.blockList[f].value!==e.blockList[d].value){e.newNameddoBlock(e.blockList[f].value,e.actionHasReturn(b),e.actionHasArgs(b));for(var h=e.palettes.dict.action,i=0;i<h.protoList.length;i++){var j=h.protoList[i];if("nameddo"===j.name&&j.defaults[0]===e.blockList[d].value){setTimeout(function(){h.remove(j,e.blockList[d].value),delete e.protoBlockDict["myDo_"+e.blockList[d].value],e.palettes.hide(),e.palettes.updatePalettes("action"),e.palettes.show()},500);break}}e.renameNameddos(e.blockList[d].value,e.blockList[f].value),c?e.renameDos(e.blockList[d].value,e.blockList[f].value,d):e.renameDos(e.blockList[d].value,e.blockList[f].value)}e.adjustDocks(b,!0)},this._makeNewBlockWithConnections("text",0,[a],postProcess,[a,b],!1)}}else if("storein"===this.blockList[a].name){var d=this.blockList[a].connections[1];if(null==d){var e=this;postProcess=function(a){var b=a[0],c=(a[1],e.blockList.length-1);e.blockList[b].connections[1]=c,e.blockList[c].value=_("box");var d=e.blockList[c].value;d.length>8&&(d=d.substr(0,7)+"..."),e.blockList[c].text.text=d,e.blockList[c].container.updateCache(),e.adjustDocks(b,!0)},this._makeNewBlockWithConnections("text",0,[a],postProcess,[a,b],!1)}}else if(-1!==["newnote","osctime"].indexOf(this.blockList[a].name)){var d=this.blockList[a].connections[2];if(null==d){var f="vspace",g=this.makeBlock(f,"__NOARG__");this.blockList[a].connections[2]=g,this.blockList[g].connections[0]=a;var f="rest2",h=this.makeBlock(f,"__NOARG__");this.blockList[h].connections[0]=g,this.blockList[h].connections[1]=null,this.blockList[g].connections[1]=h}else if("vspace"===this.blockList[d].name&&null==this.blockList[d].connections[1]){var f="rest2",h=this.makeBlock(f,"__NOARG__");this.blockList[h].connections[0]=d,this.blockList[h].connections[1]=null,this.blockList[d].connections[1]=h}}},this.deleteNextDefault=function(a){for(var b=this.blockList[a],c=1;c<b.connections.length;c++)if(b.connections[c]&&"rest2"===this.blockList[b.connections[c]].name){var d=b.connections[c],e=this.blockList[d];e.hide(),e.trash=!0,this.blockList[a].connections[c]=e.connections[1];break}},this.deletePreviousDefault=function(a){var b=this.blockList[a];if(b&&this.blockList[b.connections[0]]&&"rest2"===this.blockList[b.connections[0]].name){var c=b.connections[0],d=this.blockList[c];d.hide(),d.trash=!0;for(var e=0;e<this.blockList[d.connections[0]].connections.length;e++)if(this.blockList[d.connections[0]].connections[e]===c){this.blockList[d.connections[0]].connections[e]=a;break}b.connections[0]=d.connections[0]}return b.connections[0]},this.blockMoved=function(a){if(this._clampBlocksToCheck=[],null==a)return void console.log("blockMoved called with null block.");var b=this._insideExpandableBlock(a),c=0,d=null;null!=b&&(d=b);for(var e=!1;null!=b;){if((c+=1)>2*this.blockList.length){console.log("Infinite loop encountered checking for expandables?");break}this._clampBlocksToCheck.push([b,0]),b=this._insideExpandableBlock(b)}this._checkTwoArgBlocks=[];var f=[],g=this.blockList[a];if(null==g)return void console.log("null block found in blockMoved method: "+a);var h=g.connections[0];if(null!=h)var i=this.blockList[h];if(g.isArgBlock()&&null!=h&&(this.blockList[h].isTwoArgBlock()||this.blockList[h].isArgClamp()?i.connections[1]===a&&this._checkTwoArgBlocks.push(h):(this.blockList[h].isArgBlock()&&this.blockList[h].isExpandableBlock()||this.blockList[h].isArgClamp())&&i.connections[1]===a&&this._checkTwoArgBlocks.push(h)),null!=h){for(var j=1;j<i.connections.length;j++)if(i.connections[j]===a){i.connections[j]=null;break}g.connections[0]=null,this.raiseStackToTop(a)}for(var k=g.container.x+g.docks[0][0],l=g.container.y+g.docks[0][1],m=null,n=null,o=MINIMUMDOCKDISTANCE/DEFAULTBLOCKSCALE*this.blockScale,p=g.docks[0][2],q=!0,r=0;r<this.blockList.length;r++)if(r!==a&&!this.blockList[r].collapsed&&!this.blockList[r].trash)for(var j=1;j<this.blockList[r].connections.length&&j!==this.blockList[r].docks.length;j++)if((j!==this.blockList[r].connections.length-1||null==this.blockList[r].connections[j]||!this.blockList[this.blockList[r].connections[j]].isNoHitBlock())&&(-1===["backward","status"].indexOf(this.blockList[r].name)||1!==j||null==this.blockList[r].connections[1]||!this.blockList[this.blockList[r].connections[1]].isNoHitBlock())&&("action"!==this.blockList[r].name||2!==j||null==this.blockList[r].connections[2]||!this.blockList[this.blockList[r].connections[2]].isNoHitBlock())&&this._testConnectionType(p,this.blockList[r].docks[j][2])){var s=this.blockList[r].container.x+this.blockList[r].docks[j][0],t=this.blockList[r].container.y+this.blockList[r].docks[j][1],u=(s-k)*(s-k)+(t-l)*(t-l);u<o&&(m=r,n=j,o=u)}if(null!=m){g.connections[0]=m;var v=this.blockList[m].connections[n];if(null==v){if(this.blockList[m].isArgClamp())if("doArg"!==this.blockList[m].name&&"calcArg"!==this.blockList[m].name||1!==n)if(-1!==["doArg","nameddoArg"].indexOf(this.blockList[m].name)&&n===this.blockList[m].connections.length-1);else{var w=this._getBlockSize(a),x=this.blockList[m].argClampSlots;if(-1!==["doArg","calcArg"].indexOf(this.blockList[m].name))var y=n-2;else var y=n-1;x[y]!==w&&(x[y]=w,this.blockList[m].updateArgSlots(x))}else;}else if(q=!1,this.blockList[m].isArgClamp())if("doArg"!==this.blockList[m].name&&"calcArg"!==this.blockList[m].name||1!==n)if(-1!==["doArg","nameddoArg"].indexOf(this.blockList[m].name)&&n===this.blockList[m].connections.length-1){var z=this.findBottomBlock(a);this.blockList[v].connections[0]=z,this.blockList[z].connections[this.blockList[z].connections.length-1]=v}else{var w=this._getBlockSize(a),x=this.blockList[m].argClampSlots,A=this.blockList[m].connections.indexOf(v);if(-1!==["doArg","calcArg"].indexOf(this.blockList[m].name))var y=A-2;else var y=A-1;for(var B=null,C=null,B=y;B<x.length;B++)if(null==this.blockList[m].connections[A+B-y]){C=A+B-y;break}if(null==C){x.push(1),this._newLocalArgBlock(x.length),C=A+B-y,this.blockList[m].connections.push(null);for(var j=x.length-1;j>y+1;j--)x[j]=x[j-1];for(var j=this.blockList[m].connections.length-1;j>A+1;j--)this.blockList[m].connections[j]=this.blockList[m].connections[j-1]}n+=1,x[y+1]=w,this.blockList[m].updateArgSlots(x)}else{this.blockList[v].connections[0]=null,this.findDragGroup(v);for(var h=0;h<this.dragGroup.length;h++)this.moveBlockRelative(this.dragGroup[h],40,40)}else if(g.isArgBlock()){this.blockList[v].connections[0]=null,this.findDragGroup(v);for(var h=0;h<this.dragGroup.length;h++)this.moveBlockRelative(this.dragGroup[h],40,40);if("action"===this.blockList[m].name){if(e=!0,g.value!==this.blockList[v].value){var h=g.connections[0];g.connections[0]=null;var D=this.findUniqueActionName(g.value);if(g.connections[0]=h,D!==g.value){g.value=D;var E=D;E.length>8&&(E=E.substr(0,7)+"..."),g.text.text=E,g.container.updateCache()}var F=this;setTimeout(function(){var a=F.blockList[v].value;void 0!=F.protoBlockDict["myDo_"+a]&&(delete F.protoBlockDict["myDo_"+a],F.palettes.dict.action.hideMenu(!0)),F.newNameddoBlock(g.value,F.actionHasReturn(m),F.actionHasArgs(m));for(var b=F.palettes.dict.action,c=0;c<b.protoList.length;c++){var d=b.protoList[c];if("nameddo"===d.name&&d.staticLabels[0]===F.blockList[v].value){setTimeout(function(){b.remove(d,F.blockList[v].value),delete F.protoBlockDict["myDo_"+F.blockList[v].value],F.palettes.hide(),F.palettes.updatePalettes("action"),F.palettes.show()},500);break}}F.renameNameddos(F.blockList[v].value,g.value),F.renameDos(F.blockList[v].value,g.value)},750)}}else if("storein"===this.blockList[m].name&&"box"!==g.value){this.newStoreinBlock(g.value),this.newNamedboxBlock(g.value);var F=this;setTimeout(function(){F.palettes.hide(),F.palettes.updatePalettes("boxes"),F.palettes.show()},500)}}else if(!this.blockList[a].isArgFlowClampBlock()){var z=this.findBottomBlock(a);this.blockList[v].connections[0]=z,this.blockList[z].connections[this.blockList[z].connections.length-1]=v}if(this.blockList[m].connections[n]=a,null!=this._insideNoteBlock(a)&&(q?m=this.deletePreviousDefault(a):this.deleteNextDefault(z)),"action"===this.blockList[m].name&&!e)for(var r=0;r<this.blockList.length;r++)if(r!==m&&"action"===this.blockList[r].name&&null!=this.blockList[r].connections[1]&&this.blockList[this.blockList[r].connections[1]].value===this.blockList[a].value){this.blockList[a].value=this.findUniqueActionName(this.blockList[a].value);var E=this.blockList[a].value;E.length>8&&(E=E.substr(0,7)+"..."),this.blockList[a].text.text=E,this.blockList[a].container.updateCache(),this.newNameddoBlock(this.blockList[a].value,this.actionHasReturn(r),this.actionHasArgs(r)),this.setActionProtoVisiblity(!1)}this.adjustDocks(m,!0)}if((g.isArgBlock()||"calcArg"===g.name||"namedcalcArg"===g.name)&&null!=m){this.blockList[m].isTwoArgBlock()?this.blockList[m].connections[1]===a&&-1===this._checkTwoArgBlocks.indexOf(m)&&this._checkTwoArgBlocks.push(m):this.blockList[m].isArgBlock()&&this.blockList[m].isExpandableBlock()&&this.blockList[m].connections[1]===a&&-1===this._checkTwoArgBlocks.indexOf(m)&&this._checkTwoArgBlocks.push(m);var G=this.blockList[m].connections.length;this.blockList[m].connections[G-2]===a&&(this.blockList[m].isArgClamp()||"in"!==this.blockList[m].docks[G-1][2]||f.push(m))}this.addDefaultBlock(d,a,e);var F=this;setTimeout(function(){if(f.length>0)for(var b=0;b<f.length;b++)F._addRemoveVspaceBlock(f[b]);F._checkTwoArgBlocks.length>0&&F._adjustExpandableTwoArgBlock(F._checkTwoArgBlocks);for(var b=0;b<f.length;b++)F.adjustDocks(f[b],!0);for(var c=F._insideExpandableBlock(a),d=0;null!=c;){if((d+=1)>2*F.blockList.length){console.log("Infinite loop checking for expandables?"),console.log(F.blockList);break}"ifthenelse"===F.blockList[c].name?(F._clampBlocksToCheck.push([c,0]),F._clampBlocksToCheck.push([c,1])):F._clampBlocksToCheck.push([c,0]),c=F._insideExpandableBlock(c)}F._adjustExpandableClampBlock(),F.refreshCanvas()},250)},this._testConnectionType=function(a,b){return"in"===a&&"out"===b||("out"===a&&"in"===b||("numberin"===a&&-1!==["numberout","anyout"].indexOf(b)||(-1!==["numberout","anyout"].indexOf(a)&&"numberin"===b||("textin"===a&&-1!==["textout","anyout"].indexOf(b)||(-1!==["textout","anyout"].indexOf(a)&&"textin"===b||("booleanout"===a&&"booleanin"===b||("booleanin"===a&&"booleanout"===b||("mediain"===a&&"mediaout"===b||("mediaout"===a&&"mediain"===b||("mediain"===a&&"textout"===b||("mediain"===b&&"textout"===a||("filein"===a&&"fileout"===b||("fileout"===a&&"filein"===b||("solfegein"===a&&-1!==["anyout","solfegeout","textout","noteout","numberout"].indexOf(b)||("solfegein"===b&&-1!==["anyout","solfegeout","textout","noteout","numberout"].indexOf(a)||("notein"===a&&-1!==["solfegeout","textout","noteout"].indexOf(b)||("notein"===b&&-1!==["solfegeout","textout","noteout"].indexOf(a)||("anyin"===a&&-1!==["textout","mediaout","numberout","anyout","fileout","solfegeout","noteout"].indexOf(b)||"anyin"===b&&-1!==["textout","mediaout","numberout","anyout","fileout","solfegeout","noteout"].indexOf(a)))))))))))))))))))},this.updateBlockPositions=function(){for(var a=0;a<this.blockList.length;a++)this._moveBlock(a,this.blockList[a].container.x,this.blockList[a].container.y)},this.bringToTop=function(){this._adjustTheseStacks=[];for(var a in this.blockList){null==this.blockList[a].connections[0]&&this._adjustTheseStacks.push(a)}for(var a=0;a<this._adjustTheseStacks.length;a++)this.raiseStackToTop(this._adjustTheseStacks[a]);this.refreshCanvas()},this.checkBounds=function(){for(var a=!0,b=0;b<this.blockList.length;b++)if(null==this.blockList[b].connections[0]&&this.blockList[b].offScreen(this.boundary)){this._homeButtonContainers[0].visible=!0,this._homeButtonContainers[1].visible=!1,this.boundary.show(),a=!1;break}a&&(this._homeButtonContainers[0].visible=!1,this._homeButtonContainers[1].visible=!0,this.boundary.hide())},this._moveBlock=function(a,b,c){var d=this.blockList[a];null!=d.container?(d.container.x=b,d.container.y=c,null!=d.collapseContainer&&(d.collapseContainer.x=b+COLLAPSEBUTTONXOFF*(this.blockList[a].protoblock.scale/2),d.collapseContainer.y=c+COLLAPSEBUTTONYOFF*(this.blockList[a].protoblock.scale/2)),this.checkBounds()):console.log("No container yet for block "+d.name)},this.moveBlockRelative=function(a,b,c){this.inLongPress&&(this.saveStackButton.visible=!1,this.dismissButton.visible=!1,this.inLongPress=!1);var d=this.blockList[a];null!=d.container?(d.container.x+=b,d.container.y+=c,null!=d.collapseContainer&&(d.collapseContainer.x+=b,d.collapseContainer.y+=c),this.checkBounds()):console.log("No container yet for block "+d.name)},this.moveStackRelative=function(a,b,c){if(this.findDragGroup(a),this.dragGroup.length>0)for(var d=0;d<this.dragGroup.length;d++)this.moveBlockRelative(this.dragGroup[d],b,c)},this.updateBlockText=function(a){var b=this.blockList[a],c=8;if(null!=b.text){if("loadFile"===b.name){try{var d=b.value[0].toString()}catch(a){var d=_("open file")}c=10}else if("solfege"===b.name){var e=splitSolfege(b.value),d=i18nSolfege(e[0]),f=e[1];"♮"!==f&&(d+=f)}else if("eastindiansolfege"===b.name){var e=splitSolfege(b.value),d=WESTERN2EISOLFEGENAMES[e[0]],f=e[1];"♮"!==f&&(d+=f)}else var d=b.value.toString();d.length>c&&(d=d.substr(0,c-1)+"..."),b.text.text=d;var g=b.container.getNumChildren()-1;b.container.setChildIndex(b.text,g),b.loadComplete?b.container.updateCache():console.log("Load not yet complete for ("+a+") "+b.name)}},this.findTopBlock=function(a){if(null==a)return null;var b=this.blockList[a];if(null==b.connections)return a;if(0===b.connections.length)return a;if(b.connections.length>1&&null!=b.connections[0]&&b.connections[0]===last(b.connections))return console.log("WARNING: CORRUPTED BLOCK DATA. Block "+b.name+" ("+a+") is connected to the same block "+this.blockList[b.connections[0]].name+" ("+b.connections[0]+") twice."),a;for(var c=0;null!=b.connections[0];){if((c+=1)>2*this.blockList.length){console.log("infinite loop finding topBlock?"),console.log(this.blockList.indexOf(b)+" "+b.name);break}a=b.connections[0],b=this.blockList[a]}return a},this.sameGeneration=function(a,b){if(null==a||null==b)return!1;if(a===b)return!0;var c=this.blockList[a];if(null==c.connections)return!1;if(0===c.connections.length)return!1;for(var d=0;null!=last(c.connections);){if((d+=1)>2*this.blockList.length){console.log("infinite loop finding bottomBlock?");break}if(blk=last(c.connections),c=this.blockList[blk],blk===b)return!0}return!1},this.findBottomBlock=function(a){if(null==a)return null;var b=this.blockList[a];if(null==b.connections)return a;if(0===b.connections.length)return a;for(var c=0;null!=last(b.connections);){if((c+=1)>2*this.blockList.length){console.log("infinite loop finding bottomBlock?");break}a=last(b.connections),b=this.blockList[a]}return a},this.findStacks=function(){this.stackList=[];for(var a=0;a<this.blockList.length;a++)null==this.blockList[a].connections[0]&&this.stackList.push(a)},this._findClamps=function(){this._expandablesList=[],this.findStacks();for(var a=0;a<this.stackList.length;a++)this._searchCounter=0,this._searchForExpandables(this.stackList[a]);this._searchForArgFlow()},this._findTwoArgs=function(){this._expandablesList=[];for(var a=0;a<this.blockList.length;a++)this.blockList[a].isArgBlock()&&this.blockList[a].isExpandableBlock()?this._expandablesList.push(a):this.blockList[a].isTwoArgBlock()&&this._expandablesList.push(a)},this._searchForArgFlow=function(){for(var a=0;a<this.blockList.length;a++)this.blockList[a].isArgFlowClampBlock()&&this._expandablesList.push(a)},this._searchForExpandables=function(a){for(;null!=a&&null!=this.blockList[a]&&!this.blockList[a].isValueBlock();){if(this._searchCounter+=1,this._searchCounter>2*this.blockList.length){console.log("infinite loop searching for Expandables? "+this._searchCounter),console.log(a+" "+this.blockList[a].name);break}if(this.blockList[a].isClampBlock()){this._expandablesList.push(a);var b=this.blockList[a].connections.length-2;if(this._searchForExpandables(this.blockList[a].connections[b]),"ifthenelse"===this.blockList[a].name){var b=2;this._searchForExpandables(this.blockList[a].connections[b])}}else this.blockList[a].isArgClamp()&&this._expandablesList.push(a);a=this.blockList[a].connections.length>1?last(this.blockList[a].connections):null}},this._expandTwoArgs=function(){this._findTwoArgs(),this._adjustExpandableTwoArgBlock(this._expandablesList),this.refreshCanvas()},this._expandClamps=function(){this._findClamps(),this._clampBlocksToCheck=[];for(var a=0;a<this._expandablesList.length;a++)"ifthenelse"===this.blockList[this._expandablesList[a]].name?(this._clampBlocksToCheck.push([this._expandablesList[a],0]),this._clampBlocksToCheck.push([this._expandablesList[a],1])):this._clampBlocksToCheck.push([this._expandablesList[a],0]);this._adjustExpandableClampBlock(),this.refreshCanvas()},this.changeDisabledStatus=function(a,b){for(var c in this.blockList){var d=this.blockList[c];d.name===a&&(d.protoblock.disabled=b,d.regenerateArtwork(!1))}},this.unhighlightAll=function(){for(var a in this.blockList)this.unhighlight(a)},this.unhighlight=function(a){if(this.visible){if(null!=a)var b=a;else var b=this.highlightedBlock;null!=b&&this.blockList[b].unhighlight(),(this.highlightedBlock=b)&&(this.highlightedBlock=null)}},this.highlight=function(a,b){this.visible&&null!=a&&(b&&this.unhighlight(null),this.blockList[a].highlight(),this.highlightedBlock=a)},this.hide=function(){for(var a in this.blockList)this.blockList[a].hide();this.visible=!1},this.show=function(){for(var a in this.blockList)this.blockList[a].show();this.visible=!0},this._makeNewBlockWithConnections=function(a,b,c,d,e,f){if(void 0===f&&(f=!1),myBlock=this.makeNewBlock(a,d,e),null==myBlock)return void console.log("could not make block "+a);for(var g=0;g<c.length&&g!==myBlock.docks.length;g++)null==c[g]?myBlock.connections.push(null):myBlock.connections.push(c[g]+b)},this.makeNewBlock=function(a,b,c){if(!a in this.protoBlockDict)return console.log("makeNewBlock: no prototype for "+a),null;if(null==this.protoBlockDict[a])return console.log("makeNewBlock: no prototype for "+a),null;if(-1!==["sine","sawtooth","triangle","square"].indexOf(a)&&_THIS_IS_MUSIC_BLOCKS_&&this.logo.synth.loadSynth(a),-1!==["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(a)?this.blockList.push(new Block(this.protoBlockDict[a],this,c[1])):"namedarg"===a?this.blockList.push(new Block(this.protoBlockDict[a],this,"arg "+c[1])):this.blockList.push(new Block(this.protoBlockDict[a],this)),null==last(this.blockList))return console.log("failed to make protoblock for "+a),null;var d=last(this.blockList);return d.copySize(),d.postProcess=b,d.postProcessArg=c,d.container=new createjs.Container,this.stage.addChild(d.container),d.container.snapToPixelEnabled=!0,d.container.x=0,d.container.y=0,d.imageLoad(),d},this.makeBlock=function(a,b){"text"===a&&console.log("makeBlock "+a+" "+b);var c=null,d=null,e=this,f=this.blockList.length;"start"===a?(c=function(a){e.blockList[a].value=e.turtles.turtleList.length,e.turtles.addTurtle(e.blockList[a])},d=f):"drum"===a?(c=function(a){e.blockList[a].value=e.turtles.turtleList.length,e.turtles.addDrum(e.blockList[a])},d=f):"text"===a?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c,e.blockList[b].text.text=c,e.blockList[b].container.updateCache()},d=[f,_("text")]):"solfege"===a?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c,e.blockList[b].text.text=c,e.blockList[b].container.updateCache()},d=[f,"sol"]):"eastindiansolfege"===a?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c,e.blockList[b].text.text=WESTERN2EISOLFEGENAMES[c],e.blockList[b].container.updateCache()},d=[f,"sol"]):"notename"===a?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c,e.blockList[b].text.text=c,e.blockList[b].container.updateCache()},d=[f,"G"]):"drumname"===a?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c,e.blockList[b].text.text=c,e.blockList[b].container.updateCache()},d=[f,"kick"]):"voicename"===a?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c,e.blockList[b].text.text=c,e.blockList[b].container.updateCache()},d=[f,"sine"]):"modename"===a?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c,e.blockList[b].text.text=c,e.blockList[b].container.updateCache()},d=[f,"Major"]):"number"===a?(c=function(a){var b=a[0],c=Number(a[1]);e.blockList[b].value=c,e.blockList[b].text.text=c.toString(),e.blockList[b].container.updateCache()},d=[f,NUMBERBLOCKDEFAULT]):"media"===a?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c,e.blockList[b].image=null==c?"images/load-media.svg":null},d=[f,null]):"camera"===a?(c=function(a){console.log("post process camera "+a[1]);var b=a[0],c=a[1];e.blockList[b].value=CAMERAVALUE,e.blockList[b].image=null==c?"images/camera.svg":null},d=[f,null]):"video"===a?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=VIDEOVALUE,e.blockList[b].image=null==c?"images/video.svg":null},d=[f,null]):"loadFile"===a?(c=function(a){e.updateBlockText(a[0])},d=[f,null]):-1!==["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg","namedarg"].indexOf(a)&&(c=function(a){e.blockList[f].value=null,e.blockList[f].privateData=a[1]},d=[f,b]);var g=!1;for(var h in e.protoBlockDict)if(e.protoBlockDict[h].name===a){if("__NOARG__"===b){e.makeNewBlock(h,c,d),g=!0;break}if(e.protoBlockDict[h].defaults[0]===b){e.makeNewBlock(h,c,d),g=!0;break}if(-1!==["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg","namedarg"].indexOf(a)&&void 0===e.protoBlockDict[h].defaults[0]){e.makeNewBlock(h,c,d),g=!0;break}}g||console.log(a+" not found!!");for(var i=this.blockList.length-1,j=this.blockList[i],k=0;k<j.docks.length;k++)j.connections.push(null);for(var l=i+1,k=0;k<j.protoblock.defaults.length;k++){var m=j.protoblock.defaults[k];"action"===j.name&&(m=this.findUniqueActionName(_("action")))!==_("action")&&(this.newNameddoBlock(m,!1,!1),this.palettes.hide(),this.palettes.updatePalettes("action"),this.palettes.show());var e=this,f=this.blockList.length;j.docks.length>k&&"anyin"===j.docks[k+1][2]?null==m?console.log("cannot set default value"):"string"==typeof m?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c;var d=c.toString();d.length>8&&(d=d.substr(0,7)+"..."),e.blockList[b].text.text=d,e.blockList[b].container.updateCache()},this.makeNewBlock("text",c,[f,m])):(c=function(a){var b=a[0],c=Number(a[1]);e.blockList[b].value=c,e.blockList[b].text.text=c.toString()},this.makeNewBlock("number",c,[f,m])):"textin"===j.docks[k+1][2]?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c;var d=c.toString();d.length>8&&(d=d.substr(0,7)+"..."),e.blockList[b].text.text=d},this.makeNewBlock("text",c,[f,m])):"solfegein"===j.docks[k+1][2]?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c;var d=c.toString();e.blockList[b].text.text=d},this.makeNewBlock("solfege",c,[f,m])):"notein"===j.docks[k+1][2]?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c;var d=c.toString();e.blockList[b].text.text=d},this.makeNewBlock("notename",c,[f,m])):"mediain"===j.docks[k+1][2]?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c},this.makeNewBlock("media",c,[f,m])):"filein"===j.docks[k+1][2]?(c=function(a){e.updateBlockText(a)},this.makeNewBlock("loadFile",c,f)):(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c,e.blockList[b].text.text=c.toString()},this.makeNewBlock("number",c,[f,m]));var n=this.blockList[l+k];n.connections=[i],n.value=m,j.connections[k+1]=l+k}return this.updateBlockPositions(),this.adjustDocks(i,!0),this.refreshCanvas(),i},this.findDragGroup=function(a){this.dragLoopCounter=0,this.dragGroup=[],this._calculateDragGroup(a)},this._calculateDragGroup=function(a){if(this.dragLoopCounter+=1,this.dragLoopCount>this.blockList.length)return void console.log("maximum loop counter exceeded in calculateDragGroup... this is bad. "+a);if(null==a)return void console.log("null block passed to calculateDragGroup");var b=this.blockList[a];if(null==b)return void console.log("null block encountered... this is bad. "+a);if(null==b.connections)return void(this.dragGroup=[a]);if(0===b.connections.length)return void(this.dragGroup=[a]);this.dragGroup.push(a);for(var c=1;c<b.connections.length;c++){var d=b.connections[c];null!=d&&this._calculateDragGroup(d)}},this.setActionProtoVisiblity=function(a){for(var b=this.palettes.dict.action,c=!1,d=0;d<b.protoList.length;d++){var e=b.protoList[d];"nameddo"===e.name&&0===e.defaults.length&&e.hidden===a&&(e.hidden=!a,c=!0)}c&&(this.palettes.hide(),this.palettes.updatePalettes("action"),this.palettes.show())},this.findUniqueActionName=function(a){a===_("action")&&this.setActionProtoVisiblity(!0);for(var b=[],c=0;c<this.blockList.length;c++)if(("text"===this.blockList[c].name||"string"===this.blockList[c].name)&&!this.blockList[c].trash){var d=this.blockList[c].connections[0];null==d||"action"!==this.blockList[d].name||this.blockList[d].trash||b.push(this.blockList[c].value)}for(var e=1,f=a;-1!==b.indexOf(f);)f=a+e.toString(),e+=1;return f},this._findDrumURLs=function(){for(var a=0;a<this.blockList.length;a++)if("text"===this.blockList[a].name||"string"===this.blockList[a].name){var b=this.blockList[a].connections[0];null!=b&&-1!==["playdrum","setdrum","setvoice"].indexOf(this.blockList[b].name)&&"http"===this.blockList[a].value.slice(0,4)&&_THIS_IS_MUSIC_BLOCKS_&&this.logo.synth.loadSynth(this.blockList[a].value)}},this.renameBoxes=function(a,b){if(a!==b)for(var c=0;c<this.blockList.length;c++)if("text"===this.blockList[c].name){var d=this.blockList[c].connections[0];if(null!=d&&"box"===this.blockList[d].name&&this.blockList[c].value===a){this.blockList[c].value=b,this.blockList[c].text.text=b;try{this.blockList[c].container.updateCache()}catch(a){console.log(a)}}}},this.renameNamedboxes=function(a,b){if(a!==b){for(var c=0;c<this.blockList.length;c++)if("namedbox"===this.blockList[c].name&&this.blockList[c].privateData===a){this.blockList[c].privateData=b,this.blockList[c].overrideName=b,this.blockList[c].regenerateArtwork();try{this.blockList[c].container.updateCache()}catch(a){console.log(a)}}for(var d=this.palettes.dict.boxes,e=!1,f=0;f<d.protoList.length;f++){var g=d.protoList[f];"namedbox"===g.name&&g.defaults[0]!==_("box")&&g.defaults[0]===a&&(g.defaults[0]=b,e=!0)}e&&(this.palettes.hide(),this.palettes.updatePalettes("boxes"),this.palettes.show())}},this.renameDos=function(a,b,c){if(a!==b)for(var d=0;d<this.blockList.length;d++)if(d!==c){var e=this.blockList[d],f=this.blockList[e.connections[0]];if(null!=f&&-1!==["do","calc","doArg","calcArg","action"].indexOf(f.name)){var g=e.value;if(g===a){e.value=b;var h=e.value;h.length>8&&(h=h.substr(0,7)+"..."),e.text.text=h,e.container.updateCache()}}}},this.renameNameddos=function(a,b){if(a!==b){for(var c=0;c<this.blockList.length;c++)if(-1!==["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(this.blockList[c].name)&&this.blockList[c].privateData===a){this.blockList[c].privateData=b;var d=b;d.length>8&&(d=d.substr(0,7)+"..."),this.blockList[c].overrideName=d,this.blockList[c].regenerateArtwork()}for(var e=this.palettes.dict.action,f=!1,g=0;g<e.protoList.length;g++){var h=e.protoList[g];-1!==["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(h.name)&&h.defaults[0]===a&&(h.defaults[0]=b,f=!0)}f&&(this.palettes.hide(),this.palettes.updatePalettes("action"),this.palettes.show())}},this.newStoreinBlock=function(a){if(null==a)return void console.log("null name passed to newStoreinBlock");if(void 0==a)return void console.log("undefined name passed to newStoreinBlock");if(!("myStorein_"+a in this.protoBlockDict)){var b=new ProtoBlock("storein");this.protoBlockDict["myStorein_"+a]=b,b.palette=this.palettes.dict.boxes,b.defaults.push(a),b.defaults.push(NUMBERBLOCKDEFAULT),b.staticLabels.push(_("store in"),_("name"),_("value")),b.adjustWidthToLabel(),b.twoArgBlock(),b.dockTypes[1]="anyin",b.dockTypes[2]="anyin","box"!==a&&b.palette.add(b,!0)}},this.newNamedboxBlock=function(a){if(null==a)return void console.log("null name passed to newNamedboxBlock");if(void 0==a)return void console.log("undefined name passed to newNamedboxBlock");if(!("myBox_"+a in this.protoBlockDict)){var b=new ProtoBlock("namedbox");this.protoBlockDict["myBox_"+a]=b,b.palette=this.palettes.dict.boxes,b.defaults.push(a),b.staticLabels.push(a),b.parameterBlock(),"box"!==a&&b.palette.add(b,!0)}},this._newLocalArgBlock=function(a){var b="arg_"+a;if(!("myArg_"+a in this.protoBlockDict||b in this.protoBlockDict)){var c=new ProtoBlock("namedarg");if(this.protoBlockDict["myArg_"+b]=c,c.palette=this.palettes.dict.action,c.defaults.push(a),c.staticLabels.push("arg "+a),c.parameterBlock(),"arg_1"!==b){c.palette.add(c,!0);var d=this;setTimeout(function(){d.palettes.hide(),d.palettes.updatePalettes("action"),d.palettes.show()},500)}}},this._removeNamedoEntries=function(a){this.protoBlockDict["myDo_"+a]?(this.protoBlockDict["myDo_"+a].hide=!0,delete this.protoBlockDict["myDo_"+a]):this.protoBlockDict["myCalc_"+a]?(this.protoBlockDict["myCalc_"+a].hide=!0,delete this.protoBlockDict["myCalc_"+a]):this.protoBlockDict["myDoArg_"+a]?(this.protoBlockDict["myDoArg_"+a].hide=!0,delete this.protoBlockDict["myDoArg_"+a]):this.protoBlockDict["myCalcArg_"+a]&&(this.protoBlockDict["myCalcArg_"+a].hide=!0,delete this.protoBlockDict["myCalcArg_"+a])},this.newNameddoBlock=function(a,b,c){if(a===_("action"))return!1;if(b&&c)return this.newNamedcalcArgBlock(a),!0;if(!b&&c)return this.newNameddoArgBlock(a),!0;if(b&&!c)return this.newNamedcalcBlock(a),!0;if(void 0===this.protoBlockDict["myDo_"+a]){var d=new ProtoBlock("nameddo");return this.protoBlockDict["myDo_"+a]=d,d.palette=this.palettes.dict.action,d.defaults.push(a),d.staticLabels.push(a),d.zeroArgBlock(),d.palette.add(d,!0),this.palettes.updatePalettes(),!0}return!1},this.newNamedcalcBlock=function(a){if(void 0===this.protoBlockDict["myCalc_"+a]){var b=new ProtoBlock("namedcalc");this.protoBlockDict["myCalc_"+a]=b,b.palette=this.palettes.dict.action,b.defaults.push(a),b.staticLabels.push(a),b.zeroArgBlock(),b.palette.add(b,!0)}},this.newNameddoArgBlock=function(a){if(void 0===this.protoBlockDict["myDoArg_"+a]){var b=new ProtoBlock("nameddoArg");this.protoBlockDict["myDoArg_"+a]=b,b.palette=this.palettes.dict.action,b.defaults.push(a),b.staticLabels.push(a),b.zeroArgBlock(),b.palette.add(b,!0)}},this.newNamedcalcArgBlock=function(a){if(void 0===this.protoBlockDict["myCalcArg_"+a]){var b=new ProtoBlock("namedcalcArg");this.protoBlockDict["myCalcArg_"+a]=b,b.palette=this.palettes.dict.action,b.defaults.push(a),b.staticLabels.push(a),b.zeroArgBlock(),b.palette.add(b,!0)}},this._insideArgClamp=function(a){if(null==this.blockList[a])return console.log("null block in blockList? "+a),null;if(null==this.blockList[a].connections[0])return null;var b=this.blockList[a].connections[0];return this.blockList[b].isArgClamp()?b:null},this._insideExpandableBlock=function(a){if(null==this.blockList[a])return console.log("null block in blockList? "+a),null;if(null==this.blockList[a].connections[0])return null;var b=this.blockList[a].connections[0];return this.blockList[b].isExpandableBlock()?this.blockList[b].isArgFlowClampBlock()?b:a===last(this.blockList[b].connections)?this._insideExpandableBlock(b):b:this._insideExpandableBlock(b)},this._insideNoteBlock=function(a){if(null==this.blockList[a])return console.log("null block in blockList? "+a),null;if(null==this.blockList[a].connections[0])return null;var b=this.blockList[a].connections[0];return this.blockList[b].isExpandableBlock()?a===last(this.blockList[b].connections)?this._insideNoteBlock(b):a===this.blockList[b].connections[1]?null:-1!==["newnote","osctime"].indexOf(this.blockList[b].name)?b:null:this._insideNoteBlock(b)},this.triggerLongPress=function(a){this.timeOut,this.inLongPress=!0;var b=this.stage.getNumChildren()-1,c=this.findTopBlock(this.activeBlock);this.selectedStack=c,this.selectedBlocksObj=JSON.parse(JSON.stringify(this._copyBlocksToObj())),this.updatePasteButton(),"action"===a.name&&(this.dismissButton.visible=!0,this.dismissButton.x=a.container.x-27,this.dismissButton.y=a.container.y-27,this.stage.setChildIndex(this.dismissButton,b-1),this.saveStackButton.visible=!0,this.saveStackButton.x=a.container.x+27,this.saveStackButton.y=a.container.y-27,this.stage.setChildIndex(this.saveStackButton,b-2)),this.refreshCanvas()},this.pasteStack=function(){if(null!=this.selectedStack){for(var a in this.palettes.dict)this.palettes.dict[a].hideMenu(!0);this.loadNewBlocks(this.selectedBlocksObj)}},this.saveStack=function(){if(null!=this.selectedStack){this.palettes.hide();var a=this._copyBlocksToObj(),b=a[0][4][1];if(null==b)console.log("action not named... skipping");else{if(console.log(a[b][1][1]),"string"==typeof a[b][1][1])var c=a[b][1][1];else if("number"==typeof a[b][1][1])var c=a[b][1][1].toString();else var c=a[b][1][1].value;storage.macros=prepareMacroExports(c,a,this.macroDict),sugarizerCompatibility.isInsideSugarizer()?sugarizerCompatibility.saveLocally(function(){this.addToMyPalette(c,a)}):this.addToMyPalette(c,a)}}},this._copyBlocksToObj=function(){var a=[],b={};this.findDragGroup(this.selectedStack);for(var c=0;c<this.dragGroup.length;c++){if(myBlock=this.blockList[this.dragGroup[c]],0===c?(x=75-this.stage.x,y=75-this.stage.y):(x=0,y=0),myBlock.isValueBlock())switch(myBlock.name){case"media":blockItem=[c,[myBlock.name,null],x,y,[]];break;default:blockItem=[c,[myBlock.name,myBlock.value],x,y,[]]}else-1!==["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg","namedarg"].indexOf(myBlock.name)?blockItem=[c,[myBlock.name,{value:myBlock.privateData}],x,y,[]]:blockItem=[c,myBlock.name,x,y,[]];b[this.dragGroup[c]]=c,a.push(blockItem)}for(var c=0;c<this.dragGroup.length;c++){myBlock=this.blockList[this.dragGroup[c]];for(var d=0;d<myBlock.connections.length;d++)null==myBlock.connections[d]?a[c][4].push(null):a[c][4].push(b[myBlock.connections[d]])}return a},this.addToMyPalette=function(a,b){var c=new ProtoBlock("macro_"+a),d="macro_"+a;this.protoBlockDict[d]=c,"myblocks"in this.palettes.dict||this.palettes.add("myblocks"),c.palette=this.palettes.dict.myblocks,c.zeroArgBlock(),c.staticLabels.push(_(a)),this.protoBlockDict[d].palette.add(this.protoBlockDict[d])},this.loadNewBlocks=function(a){for(var b=0;b<a.length;b++){var c=a[b];for(var d in c[4])if(c[4][d]===c[0])return console.log("Circular connection in block data: "+c),console.log("Punting loading of new blocks!"),void console.log(a)}for(var e=[],f=[],b=0;b<this.blockList.length;b++)this.blockList[b].trash||("action"===this.blockList[b].name?null!=this.blockList[b].connections[1]&&(console.log(this.blockList[this.blockList[b].connections[1]].value),e.push(this.blockList[this.blockList[b].connections[1]].value)):"storein"===this.blockList[b].name&&null!=this.blockList[b].connections[1]&&f.push(this.blockList[this.blockList[b].connections[1]].value));this._checkTwoArgBlocks=[],this._checkArgClampBlocks=[];var g={},h={},i={},j={};this.blocksToCollapse=[];for(var b=0;b<a.length;b++){var c=a[b];if("string"==typeof c[1])var k=c[1];else var k=c[1][0];if(!(k in this.protoBlockDict))switch(k){case"hat":k="action";break;case"string":k="text";break;default:console.log("skipping "+k);continue}switch(-1!==["arg","twoarg"].indexOf(this.protoBlockDict[k].style)&&this.protoBlockDict[k].expandable&&this._checkTwoArgBlocks.push(this.blockList.length+b),-1!==["clamp","argclamp","argclamparg","doubleclamp","argflowclamp"].indexOf(this.protoBlockDict[k].style)&&this._checkArgClampBlocks.push(this.blockList.length+b),k){case"text":var l=c[1][1];void 0===g[l]&&(g[l]=[]),g[l].push(b);break;case"action":case"hat":null!=c[4][1]&&(h[b]=c[4][1]);break;case"storein":null!=c[4][1]&&(i[b]=c[4][1]);break;case"nameddo":case"namedcalc":case"nameddoArg":case"namedcalcArg":j[b]=c[1][1].value;break;case"do":case"stack":null!=c[4][1]&&(j[b]=c[4][1])}switch(k){case"action":case"pitchdrummatrix":case"rhythmruler":case"pitchstaircase":case"tempo":case"pitchslider":case"matrix":case"drum":case"status":case"start":"object"==typeof c[1]&&c[1].length>1&&"object"==typeof c[1][1]&&"collapsed"in c[1][1]&&c[1][1].collapsed&&this.blocksToCollapse.push(this.blockList.length+b)}}var m=!1;for(var b in i){var c=a[i[b]];if(-1===f.indexOf(c[1][1])){if("string"==typeof c[1][1])var k=c[1][1];else var k=c[1][1].value;this.newStoreinBlock(k),this.newNamedboxBlock(k),m=!0}}for(var b in h){var c=a[h[b]];if("string"==typeof c[1][1])var k=c[1][1];else var k=c[1][1].value;k===_("action")&&this.setActionProtoVisiblity(!0);for(var o=k,p=1;-1!==e.indexOf(k);)if(k=o+p.toString(),(p+=1)>this.blockList.length){console.log("Could not generate unique action name.");break}o!==k&&(console.log("action "+o+" is being renamed "+k),c[1][1]={value:k});for(var q in j){var r=a[q];if("string"==typeof r[1])var s=r[1];else var s=r[1][0];if(-1!==["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(s))r[1][1].value===o&&(r[1][1]={value:k});else{var t=a[j[q]];"string"==typeof t[1][1]?t[1][1]===o&&(t[1][1]=k):t[1][1].value===o&&(t[1][1]={value:k})}}}m&&(this.palettes.hide(),this.palettes.updatePalettes("action"),this.palettes.show()),blockObjsLength=a.length;for(var u=0,b=0;b<blockObjsLength;b++){if("object"==typeof a[b][1])var k=a[b][1][0];else var k=a[b][1];switch(k){case"articulation":case"augmented":case"backward":case"crescendo":case"diminished":case"dividebeatfactor":case"drift":case"duplicatenotes":case"invert1":case"fill":case"flat":case"hollowline":case"major":case"minor":case"multiplybeatfactor":case"note":case"newnote":case"newslur":case"newstaccato":case"newswing":case"newswing2":case"osctime":case"perfect":case"pluck":case"rhythmicdot":case"setbpm":case"setnotevolume2":case"settransposition":case"setvoice":case"sharp":case"skipnotes":case"slur":case"staccato":case"swing":case"tie":case"tuplet2":case"vibrato":var v=a[b][4].length;if(null==last(a[b][4]))console.log("last connection of "+k+" is null: adding hidden block"),a[b][4][v-1]=blockObjsLength+u,a.push([blockObjsLength+u,"hidden",0,0,[b,null]]),u+=1;else{var w=a[b][4][v-1];if("object"==typeof a[w][1])var x=a[w][1][0];else var x=a[w][1];"hidden"!==x&&(console.log("last connection of "+k+" is "+x+": adding hidden block"),a[b][4][v-1]=blockObjsLength+u,a[w][4][0]=blockObjsLength+u,a.push([blockObjsLength+u,"hidden",0,0,[b,w]]),u+=1)}if(-1!==["note","slur","staccato","swing"].indexOf(k)){console.log("note: "+b);var y=a[b][4][2];a[b][4][2]=blockObjsLength+u,null==y?a.push([blockObjsLength+u,"vspace",0,0,[b,null]]):(a[y][4][0]=blockObjsLength+u,a.push([blockObjsLength+u,"vspace",0,0,[b,y]])),u+=1;var z=a[b][4][1];a[b][4][1]=blockObjsLength+u,null==z?(a.push([blockObjsLength+u,"divide",0,0,[b,blockObjsLength+u+1,blockObjsLength+u+2]]),a.push([blockObjsLength+u+1,["number",{value:1}],0,0,[blockObjsLength+u]]),a.push([blockObjsLength+u+2,["number",{value:1}],0,0,[blockObjsLength+u]]),u+=3):(a[z][4][0]=blockObjsLength+u,a.push([blockObjsLength+u,"divide",0,0,[b,blockObjsLength+u+1,z]]),a.push([blockObjsLength+u+1,["number",{value:1}],0,0,[blockObjsLength+u]]),u+=2),"object"==typeof a[b][1]?a[b][1][0]="new"+k:a[b][1]="new"+k}break;case"action":var v=a[b][4].length;if(null==a[b][4][2])console.log("last connection of "+k+" is null: adding hidden block"),a[b][4][2]=blockObjsLength+u,a.push([blockObjsLength+u,"hidden",0,0,[b,null]]),u+=1;else{var w=a[b][4][2];if("object"==typeof a[w][1])var x=a[w][1][0];else var x=a[w][1];"hidden"!==x&&(console.log("last connection of "+k+" is "+x+": adding hidden block"),a[b][4][2]=blockObjsLength+u,a[w][4][0]=blockObjsLength+u,a.push([blockObjsLength+u,"hidden",0,0,[b,w]]),u+=1)}}}this._adjustTheseStacks=[],this._adjustTheseDocks=[],this._loadCounter=a.length;for(var A=this.blockList.length,B=this.blockList.length,b=0;b<this._loadCounter;b++){var C=A+b,c=a[b];if("object"==typeof c[1])if(1===c[1].length)var D=[c[1][0],{value:null}];else if(-1!==["number","string"].indexOf(typeof c[1][1])){var D=[c[1][0],{value:c[1][1]}];-1!==COLLAPSABLES.indexOf(c[1][0])&&(D[1].collapsed=!1)}else var D=c[1];else{var D=[c[1],{value:null}];-1!==COLLAPSABLES.indexOf(c[1])&&(D[1].collapsed=!1)}var k=D[0],E=!1;if(-1!==COLLAPSABLES.indexOf(k)&&(E=D[1].collapsed),null==D[1])var F=null;else var F=D[1].value;k in NAMEDICT&&(k=NAMEDICT[k]);var G=this;switch(k){case"start":c[4][0]=null,c[4][2]=null,postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].value=G.turtles.turtleList.length,G.turtles.addTurtle(G.blockList[b],c)},this._makeNewBlockWithConnections(k,A,c[4],postProcess,[C,D[1]],E);break;case"drum":c[4][0]=null,c[4][2]=null,postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].value=G.turtles.turtleList.length,G.turtles.addDrum(G.blockList[b],c)},this._makeNewBlockWithConnections(k,A,c[4],postProcess,[C,D[1]],E),_THIS_IS_MUSIC_BLOCKS_&&this.logo.synth.loadSynth("kick");break;case"action":case"hat":c[4][0]=null,c[4][3]=null,this._makeNewBlockWithConnections("action",A,c[4],null,null,E);break;case"namedbox":postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].privateData=c,G.blockList[b].value=null},this._makeNewBlockWithConnections("namedbox",A,c[4],postProcess,[C,F]);break;case"namedarg":postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].privateData=c,G.blockList[b].value=null},this._makeNewBlockWithConnections("namedarg",A,c[4],postProcess,[C,F]);break;case"namedcalc":postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].privateData=c,G.blockList[b].value=null},this._makeNewBlockWithConnections("namedcalc",A,c[4],postProcess,[C,F]);break;case"nameddo":postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].privateData=c,G.blockList[b].value=null},this._makeNewBlockWithConnections("nameddo",A,c[4],postProcess,[C,F]);break;case"doArg":postProcess=function(a){var b=a[0],c=a[1].length-4;if(c>0){for(var d=G.blockList[b].argClampSlots,e=0;e<c;e++)d.push(1),G._newLocalArgBlock(d.length),G.blockList[b].connections.push(null);G.blockList[b].updateArgSlots(d);for(var e=0;e<a[1].length;e++)null!=a[1][e]?G.blockList[b].connections[e]=a[1][e]+B:G.blockList[b].connections[e]=a[1][e]}G._checkArgClampBlocks.push(b)},this._makeNewBlockWithConnections("doArg",A,c[4],postProcess,[C,c[4]]);break;case"nameddoArg":postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].privateData=c,G.blockList[b].value=null;var d=a[2].length-3;if(d>0){for(var e=G.blockList[b].argClampSlots,f=0;f<d;f++)e.push(1),G._newLocalArgBlock(e.length),G.blockList[b].connections.push(null);G.blockList[b].updateArgSlots(e);for(var f=0;f<a[2].length;f++)null!=a[2][f]?G.blockList[b].connections[f]=a[2][f]+B:G.blockList[b].connections[f]=a[2][f]}G._checkArgClampBlocks.push(b)},this._makeNewBlockWithConnections("nameddoArg",A,c[4],postProcess,[C,F,c[4]]);break;case"calcArg":postProcess=function(a){var b=a[0],c=a[1].length-3;if(c>0){for(var d=G.blockList[b].argClampSlots,e=0;e<c;e++)d.push(1),G._newLocalArgBlock(d.length),G.blockList[b].connections.push(null);G.blockList[b].updateArgSlots(d);for(var e=0;e<a[1].length;e++)null!=a[1][e]?G.blockList[b].connections[e]=a[1][e]+B:G.blockList[b].connections[e]=a[1][e]}G._checkArgClampBlocks.push(b)},this._makeNewBlockWithConnections("calcArg",A,c[4],postProcess,[C,c[4]]);break;case"namedcalcArg":postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].privateData=c,G.blockList[b].value=null;var d=a[2].length-2;if(d>0){for(var e=G.blockList[b].argClampSlots,f=0;f<d;f++)e.push(1),G._newLocalArgBlock(e.length),G.blockList[b].connections.push(null);G.blockList[b].updateArgSlots(e);for(var f=0;f<a[2].length;f++)null!=a[2][f]?G.blockList[b].connections[f]=a[2][f]+B:G.blockList[b].connections[f]=a[2][f]}G._checkArgClampBlocks.push(b)},this._makeNewBlockWithConnections("namedcalcArg",A,c[4],postProcess,[C,F,c[4]]);break;case"number":postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].value=Number(c),G.updateBlockText(b)},this._makeNewBlockWithConnections(k,A,c[4],postProcess,[C,F]);break;case"text":case"solfege":case"eastindiansolfege":case"notename":case"modename":postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].value=c,G.updateBlockText(b)},this._makeNewBlockWithConnections(k,A,c[4],postProcess,[C,F]);break;case"drumname":postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].value=c,G.updateBlockText(b)},this._makeNewBlockWithConnections(k,A,c[4],postProcess,[C,F]),_THIS_IS_MUSIC_BLOCKS_&&this.logo.synth.loadSynth(getDrumSynthName(F));break;case"voicename":postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].value=c,G.updateBlockText(b)},this._makeNewBlockWithConnections(k,A,c[4],postProcess,[C,F]),_THIS_IS_MUSIC_BLOCKS_&&this.logo.synth.loadSynth(getVoiceSynthName(F));break;case"media":postProcess=function(a){var b=a[0],c=a[1];G.blockList[b].value=c,null!=c&&G.blockList[b].loadThumbnail(null)},this._makeNewBlockWithConnections(k,A,c[4],postProcess,[C,F]);break;case"camera":postProcess=function(a){var b=a[0];a[1];G.blockList[b].value=CAMERAVALUE},this._makeNewBlockWithConnections(k,A,c[4],postProcess,[C,F]);break;case"video":postProcess=function(a){var b=a[0];a[1];G.blockList[b].value=VIDEOVALUE},this._makeNewBlockWithConnections(k,A,c[4],postProcess,[C,F]);break;case"red":case"black":postProcess=function(a){G.blockList[a].value=0,G.updateBlockText(a)},this._makeNewBlockWithConnections("number",A,c[4],postProcess,C);break;case"white":postProcess=function(a){G.blockList[a].value=100,G.updateBlockText(a)},this._makeNewBlockWithConnections("number",A,c[4],postProcess,C);break;case"orange":postProcess=function(a){G.blockList[a].value=10,G.updateBlockText(a)},this._makeNewBlockWithConnections("number",A,c[4],postProcess,C);break;case"yellow":postProcess=function(a){G.blockList[a].value=20,G.updateBlockText(a)},this._makeNewBlockWithConnections("number",A,c[4],postProcess,C);break;case"green":postProcess=function(a){G.blockList[a].value=40,G.updateBlockText(a)},this._makeNewBlockWithConnections("number",A,c[4],postProcess,C);break;case"blue":postProcess=function(a){G.blockList[a].value=70,G.updateBlockText(a)},this._makeNewBlockWithConnections("number",A,c[4],postProcess,C);break;case"leftpos":postProcess=function(a){G.blockList[a].value=-canvas.width/2,G.updateBlockText(a)},this._makeNewBlockWithConnections("number",A,c[4],postProcess,C);break;case"rightpos":postProcess=function(a){G.blockList[a].value=canvas.width/2,G.updateBlockText(a)},this._makeNewBlockWithConnections("number",A,c[4],postProcess,C);break;case"toppos":postProcess=function(a){G.blockList[a].value=canvas.height/2,G.updateBlockText(a)},this._makeNewBlockWithConnections("number",A,c[4],postProcess,C);break;case"botpos":case"bottompos":postProcess=function(a){G.blockList[a].value=-canvas.height/2,G.updateBlockText(a)},this._makeNewBlockWithConnections("number",A,c[4],postProcess,C);break;case"width":postProcess=function(a){G.blockList[a].value=canvas.width,G.updateBlockText(a)},this._makeNewBlockWithConnections("number",A,c[4],postProcess,C);break;case"height":postProcess=function(a){G.blockList[a].value=canvas.height,G.updateBlockText(a)},this._makeNewBlockWithConnections("number",A,c[4],postProcess,C);break;case"loadFile":postProcess=function(a){G.blockList[a[0]].value=a[1],G.updateBlockText(a[0])},this._makeNewBlockWithConnections(k,A,c[4],postProcess,[C,F]);break;default:if(!k in this.protoBlockDict||null==this.protoBlockDict[k])switch(n=c[4].length,console.log(n+": substituting nop block for "+k),n){case 1:k="nopValueBlock";break;case 2:k="nopZeroArgBlock";break;case 3:k="nopOneArgBlock";break;case 4:k="nopTwoArgBlock";break;case 5:default:k="nopThreeArgBlock"}this._makeNewBlockWithConnections(k,A,c[4],null)}C===this.blockList.length-1&&null==this.blockList[C].connections[0]&&(this.blockList[C].container.x=c[2],this.blockList[C].container.y=c[3],this._adjustTheseDocks.push(C),null==c[4][0]&&this._adjustTheseStacks.push(C),(c[2]<0||c[3]<0||c[2]>canvas.width||c[3]>canvas.height)&&(this._homeButtonContainers[0].visible=!0,this._homeButtonContainers[1].visible=!1))}},this.cleanupAfterLoad=function(a){if(this._loadCounter-=1,!(this._loadCounter>0)){this._findDrumURLs(),this.updateBlockPositions(),this._cleanupStacks();for(var b=0;b<this.blocksToCollapse.length;b++)this.blockList[this.blocksToCollapse[b]].collapseToggle();this.blocksToCollapse=[];for(var c=0;c<this.blockList.length;c++)null!=this.blockList[c].collapseContainer&&(this.blockList[c].collapseContainer.x=this.blockList[c].container.x+COLLAPSEBUTTONXOFF*(this.blockList[c].protoblock.scale/2),this.blockList[c].collapseContainer.y=this.blockList[c].container.y+COLLAPSEBUTTONYOFF*(this.blockList[c].protoblock.scale/2));this.refreshCanvas();for(var d=!1,c=0;c<this.blockList.length;c++)if(!this.blockList[c].trash&&"action"===this.blockList[c].name){var e=this.blockList[c],f=e.connections[1];null!=f&&this.blockList[f].value!==_("action")&&this.newNameddoBlock(this.blockList[f].value,this.actionHasReturn(c),this.actionHasArgs(c))&&(d=!0)}d&&(this.palettes.hide(),this.palettes.updatePalettes("action"),this.palettes.show());for(var d=!1,c=0;c<this.blockList.length;c++)if(!this.blockList[c].trash&&"storein"===this.blockList[c].name){var e=this.blockList[c],f=e.connections[1];if(null!=f&&this.blockList[f].value!==_("box")){var a=this.blockList[f].value;void 0==this.protoBlockDict["myStorein_"+a]&&(console.log("adding new storein block "+a),this.newNamedboxBlock(this.blockList[f].value),this.newStoreinBlock(this.blockList[f].value),d=!0)}}if(d){var g=this;setTimeout(function(){g.palettes.hide(),g.palettes.updatePalettes("boxes"),g.palettes.show()},1500)}console.log("Finished block loading");var h=new Event("finishedLoading");document.dispatchEvent(h)}},this._cleanupStacks=function(){if(this._checkArgClampBlocks.length>0)for(var a=0;a<this._checkArgClampBlocks.length;a++)for(var b=0;b<this._checkArgClampBlocks.length;b++)this._adjustArgClampBlock([this._checkArgClampBlocks[b]]);if(this._checkTwoArgBlocks.length>0)for(var a=0;a<this._checkTwoArgBlocks.length;a++)for(var b=0;b<this._checkTwoArgBlocks.length;b++)this._adjustExpandableTwoArgBlock([this._checkTwoArgBlocks[b]]);for(var c=0;c<this._adjustTheseDocks.length;c++)this.adjustDocks(this._adjustTheseDocks[c],!0),this._expandClamps();for(var c=0;c<this._adjustTheseStacks.length;c++)this.raiseStackToTop(this._adjustTheseStacks[c])},this.actionHasReturn=function(a){if("action"!==this.blockList[a].name)return!1;this.findDragGroup(a);for(var b=0;b<this.dragGroup.length;b++)if("return"===this.blockList[this.dragGroup[b]].name)return!0;return!1},this.actionHasArgs=function(a){if("action"!==this.blockList[a].name)return!1;this.findDragGroup(a);for(var b=0;b<this.dragGroup.length;b++)if("arg"===this.blockList[this.dragGroup[b]].name||"namedarg"===this.blockList[this.dragGroup[b]].name)return!0;return!1},this.raiseStackToTop=function(a){var b=this.findTopBlock(a);this.findDragGroup(b);for(var c=this.stage.getNumChildren()-1,d=0;d<this.dragGroup.length;d++)this.stage.setChildIndex(this.blockList[this.dragGroup[d]].container,c),c-=1;this.refreshCanvas},this.deleteActionBlock=function(a){var b=this.blockList[a.connections[1]];if(b){for(var c=b.value,d=0;d<this.blockList.length;d++){var a=this.blockList[d],e=this.blockList[a.connections[0]];if(null!=e&&-1===["namedcalc","calc","nameddo","do","action"].indexOf(e.name)){var f=a.value;f!==_("action")&&f===c&&(e.hide(),a.hide(),a.trash=!0,e.trash=!0)}}this.deleteActionTimeout+=500;var g=this.deleteActionTimeout,h=this;setTimeout(function(){h.deleteActionTimeout-=500,h.palettes.removeActionPrototype(c)},g)}},this.sendStackToTrash=function(a){for(var b in this.palettes.dict)this.palettes.dict[b].hideMenu(!0);this.refreshCanvas();var c=this.blockList.indexOf(a);this.trashStacks.push(c);var d=a.connections[0];if(null!=d){for(var e in this.blockList[d].connections)if(this.blockList[d].connections[e]===c){this.blockList[d].connections[e]=null;break}a.connections[0]=null,this.addDefaultBlock(d,c)}if("start"===a.name||"drum"===a.name){turtle=a.value;for(var f=0,g=0;g<this.turtles.turtleList.length;g++)this.turtles.turtleList[g].trash||(f+=1);if(!(null!=turtle&&f>1))return this.errorMsg("You must always have at least one start block"),void console.log("null turtle");console.log("putting turtle "+turtle+" in the trash"),this.turtles.turtleList[turtle].trash=!0,this.turtles.turtleList[turtle].container.visible=!1}else"action"===a.name&&(a.trash||this.deleteActionBlock(a));this.findDragGroup(c);for(var h=0;h<this.dragGroup.length;h++){var i=this.dragGroup[h];this.blockList[i].trash=!0,this.blockList[i].hide(),this.refreshCanvas()}if(null!=d){var j=this.findTopBlock(d);this.findDragGroup(j),this._checkTwoArgBlocks=[],this._checkArgClampBlocks=[];for(var h=0;h<this.dragGroup.length;h++){var i=this.dragGroup[h],a=this.blockList[i];a.isTwoArgBlock()?this._checkTwoArgBlocks.push(i):a.isArgBlock()&&a.isExpandableBlock()||a.isArgClamp()?this._checkTwoArgBlocks.push(i):-1!==["clamp","argclamp","argclamparg","doubleclamp","argflowclamp"].indexOf(a.protoblock.style)&&this._checkArgClampBlocks.push(i)}this._cleanupStacks(),this.refreshCanvas()}},this}const MINIMUMDOCKDISTANCE=400,CAMERAVALUE="##__CAMERA__##",VIDEOVALUE="##__VIDEO__##";