/*! Sugarizer 2019-09-21 */
function maxPaletteHeight(a,b){var c=windowHeight()*canvasPixelRatio()/b-2*a;return c-c%STANDARDBLOCKHEIGHT+STANDARDBLOCKHEIGHT/2}function paletteBlockButtonPush(a,b,c){return a.makeBlock(b,c)}function Palettes(){return this.canvas=null,this.blocks=null,this.refreshCanvas=null,this.stage=null,this.cellSize=null,this.scrollDiff=0,this.originalSize=55,this.trashcan=null,this.initial_x=55,this.initial_y=55,this.firstTime=!0,this.background=null,this.upIndicator=null,this.upIndicatorStatus=!1,this.downIndicator=null,this.downIndicatorStatus=!0,this.circles={},this.palette_text=new createjs.Text("","20px Arial","#ff7700"),this.mouseOver=!1,this.activePalette=null,this.visible=!0,this.scale=1,this.mobile=!1,this.current=DEFAULTPALETTE,this.x=null,this.y=null,this.container=null,sugarizerCompatibility.isInsideSugarizer()?storage=sugarizerCompatibility.data:storage=localStorage,this.dict={},this.buttons={},this.init=function(){this.halfCellSize=Math.floor(this.cellSize/2),this.x=0,this.y=this.cellSize,this.container=new createjs.Container,this.container.snapToPixelEnabled=!0,this.stage.addChild(this.container)},this.setCanvas=function(a){return this.canvas=a,this},this.setStage=function(a){return this.stage=a,this},this.setRefreshCanvas=function(a){return this.refreshCanvas=a,this},this.setTrashcan=function(a){return this.trashcan=a,this},this.setSize=function(a){return this.cellSize=a,this},this.setMobile=function(a){return this.mobile=a,a&&this._hideMenus(),this},this.setScale=function(a){this.scale=a,this._updateButtonMasks();for(var b in this.dict)this.dict[b]._resizeEvent();return null!=this.downIndicator&&(this.downIndicator.y=windowHeight()/a-27),this},this.setMacroDictionary=function(a){return this.macroDict=a,this},this.menuScrollEvent=function(a,b){var c=Object.keys(this.buttons),d=a*b;if(this.buttons[c[0]].y+d>this.cellSize&&a>0)return this.upIndicator.visible=!1,this.upIndicatorStatus=this.upIndicator.visible,void this.refreshCanvas();if(this.upIndicatorStatus=this.upIndicator.visible,this.upIndicator.visible=!0,this.buttons[last(c)].y+d<windowHeight()/this.scale-this.cellSize&&a<0)return this.downIndicator.visible=!1,this.downIndicatorStatus=this.downIndicator.visible,void this.refreshCanvas();this.downIndicator.visible=!0,this.downIndicatorStatus=this.downIndicator.visible,this.scrollDiff+=d;for(var e in this.buttons)this.buttons[e].y+=d,this.buttons[e].visible=!0;this._updateButtonMasks(),this.refreshCanvas()},this._updateButtonMasks=function(){for(var a in this.buttons){var b=new createjs.Shape;b.graphics.r(0,0,this.cellSize,windowHeight()/this.scale),b.x=0,b.y=this.cellSize/2,this.buttons[a].mask=b}},this.hidePaletteIconCircles=function(){sugarizerCompatibility.isInsideSugarizer()||hidePaletteNameDisplay(palette_text,this.stage),hideButtonHighlight(this.circles,this.stage)},this.makePalettes=function(a){function b(a,b,c,d){c.scaleX=c.scaleY=c.scale=.4,a.stage.addChild(c),c.x=55,c.y=55,c.visible=!1,a.upIndicator=c,a.upIndicator.on("click",function(b){a.menuScrollEvent(1,40),a.hidePaletteIconCircles()})}function c(a,b,c,d){c.scaleX=c.scaleY=c.scale=.4,a.stage.addChild(c),c.x=55,c.y=windowHeight()/a.scale-27,c.visible=!0,a.downIndicator=c,a.downIndicator.on("click",function(b){a.menuScrollEvent(-1,40),a.hidePaletteIconCircles()})}function d(a,b,c,d){f.buttons[b].addChild(c),f.cellSize!=f.originalSize&&(c.scaleX=f.cellSize/f.originalSize,c.scaleY=f.cellSize/f.originalSize);var e=new createjs.Shape;e.graphics.beginFill("#FFF").drawEllipse(-f.halfCellSize,-f.halfCellSize,f.cellSize,f.cellSize),e.x=f.halfCellSize,e.y=f.halfCellSize,f.buttons[b].hitArea=e,f.buttons[b].visible=!1,f.dict[b].makeMenu(!0),f.dict[b]._moveMenu(f.cellSize,f.cellSize),f.dict[b]._updateMenu(!1),f._loadPaletteButtonHandler(b)}if(this.firstTime){var e=new createjs.Shape;e.graphics.f("#a2c5d8").r(0,0,55,windowHeight()).ef(),e.width=55,e.height=windowHeight(),this.stage.addChild(e),this.background=e}null==this.upIndicator&&this.firstTime&&makePaletteBitmap(this,UPICON.replace("#000000","#FFFFFF"),"up",b,null),null==this.downbIndicator&&this.firstTime&&makePaletteBitmap(this,DOWNICON.replace("#000000","#FFFFFF"),"down",c,null),this.firstTime=!1;var f=this;for(var g in this.dict)g in this.buttons?this.dict[g]._updateMenu(a):(this.buttons[g]=new createjs.Container,this.buttons[g].snapToPixelEnabled=!0,this.stage.addChild(this.buttons[g]),this.buttons[g].x=this.x,this.buttons[g].y=this.y+this.scrollDiff,this.y+=this.cellSize,makePaletteBitmap(this,PALETTEICONS[g],g,d,null))},this.showPalette=function(a){if(!this.mobile)for(var b in this.dict)this.dict[b]===this.dict[a]?(this.dict[a]._resetLayout(),this.dict[a].showMenu(!0),this.dict[a]._showMenuItems(!0)):this.dict[b].visible&&(this.dict[b].hideMenu(!0),this.dict[b]._hideMenuItems(!1))},this._showMenus=function(){if(!this.mobile){for(var a in this.buttons)this.buttons[a].visible=!0;null!=this.background&&(this.background.visible=!0),this.upIndicatorStatus&&(this.upIndicator.visible=!0),this.downIndicatorStatus&&null!=this.downIndicator&&(this.downIndicator.visible=!0),this.refreshCanvas()}},this._hideMenus=function(){for(var a in this.buttons)this.buttons[a].visible=!1;for(var a in this.dict)this.dict[a].hideMenu(!0);null!=this.upIndicator&&(this.upIndicator.visible=!1,this.downIndicator.visible=!1,this.background.visible=!1),this.refreshCanvas()},this.getInfo=function(){for(var a in this.dict)console.log(this.dict[a].getInfo())},this.updatePalettes=function(a){if(null!=a){this.makePalettes(!1);var b=this;setTimeout(function(){b.dict[a]._resetLayout(),b.dict[a].showMenu(),b.dict[a]._showMenuItems(),b.refreshCanvas()},100)}else this.makePalettes(!0),this.refreshCanvas();if(this.mobile){var c=this;setTimeout(function(){c.hide();for(var a in c.dict)c.dict[a].visible&&(c.dict[a].hideMenu(!0),c.dict[a]._hideMenuItems(!0))},500)}},this.hide=function(){this._hideMenus(),this.visible=!1},this.show=function(){this.mobile?(this._hideMenus(),this.visible=!1):(this._showMenus(),this.visible=!0)},this.setBlocks=function(a){return this.blocks=a,this},this.add=function(a){return this.dict[a]=new Palette(this,a),this},this.remove=function(a){if(!(a in this.buttons))return void console.log("Palette.remove: Cannot find palette "+a);this.buttons[a].removeAllChildren();for(var b=Object.keys(this.dict),c=b.indexOf(a)+1;c<b.length;c++)this.buttons[b[c]].y-=this.cellSize;delete this.buttons[a],delete this.dict[a],this.y-=this.cellSize,this.makePalettes(!0)},this.bringToTop=function(){for(var a in this.dict){this.stage.removeChild(this.dict[a].menuContainer),this.stage.addChild(this.dict[a].menuContainer);for(var b in this.dict[a].protoContainers)this.stage.removeChild(this.dict[a].protoContainers[b]),this.stage.addChild(this.dict[a].protoContainers[b])}this.refreshCanvas()},this.findPalette=function(a,b){for(var c in this.dict){var d=this.dict[c].menuContainer.x,e=this.dict[c].menuContainer.y,f=Math.min(maxPaletteHeight(this.cellSize,this.scale),this.dict[c].y);if(this.dict[c].menuContainer.visible&&d<a&&a<d+MENUWIDTH&&e<b&&b<e+f)return this.dict[c]}return null},this._loadPaletteButtonHandler=function(a){var b=this,c=!1,d=!1,e=this;this.buttons[a].on("mousedown",function(c){d=!0;var e=c.stageY;b.buttons[a].on("pressmove",function(a){if(d){var c=a.stageY-e;b.menuScrollEvent(c,10),e=a.stageY}}),b.buttons[a].on("pressup",function(a){d=!1},null,!0)}),this.buttons[a].on("mouseover",function(c){b.mouseOver=!0;var d=b.cellSize/2;e.circles=showButtonHighlight(b.buttons[a].x+d,b.buttons[a].y+d,d,c,b.scale,b.stage),sugarizerCompatibility.isInsideSugarizer()||(palette_text=new createjs.Text(_(a),"20px Arial","black"),palette_text.x=b.buttons[a].x+2.2*d,palette_text.y=b.buttons[a].y+5*d/8,b.stage.addChild(palette_text))}),this.buttons[a].on("pressup",function(a){b.mouseOver=!1,sugarizerCompatibility.isInsideSugarizer()||hidePaletteNameDisplay(palette_text,b.stage),hideButtonHighlight(e.circles,b.stage)}),this.buttons[a].on("mouseout",function(a){b.mouseOver=!1,sugarizerCompatibility.isInsideSugarizer()||hidePaletteNameDisplay(palette_text,b.stage),hideButtonHighlight(e.circles,b.stage)}),this.buttons[a].on("click",function(d){c||(c=!0,setTimeout(function(){c=!1},500),b.dict[a]._moveMenu(b.initial_x,b.initial_y),b.showPalette(a),b.refreshCanvas())})},this.removeActionPrototype=function(a){for(var b=!1,c=0;c<this.dict.action.protoList.length;c++){var d=this.dict.action.protoList[c];if(-1!==["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(d.name)&&d.defaults[0]===a){this.dict.action.remove(d,a),this.blocks.protoBlockDict["myDo_"+a]?delete this.blocks.protoBlockDict["myDo_"+a]:this.blocks.protoBlockDict["myCalc_"+a]?delete this.blocks.protoBlockDict["myCalc_"+a]:this.blocks.protoBlockDict["myDoArg_"+a]?delete this.blocks.protoBlockDict["myDoArg_"+a]:this.blocks.protoBlockDict["myCalcArg_"+a]&&delete this.blocks.protoBlockDict["myCalcArg_"+a],this.dict.action.y=0,b=!0;break}}b&&(this.hide(),this.updatePalettes("action"),this.mobile?this.hide():this.show())},this}function PaletteModel(a,b,c){this.palette=a,this.palettes=b,this.name=c,this.blocks=[],this.update=function(){this.blocks=[];for(var a in this.palette.protoList){var b=this.palette.protoList[a];if(!b.hidden){var c=b.name,d=c;switch(c){case"storein":d="store in "+b.defaults[0];var e=b.defaults[0];break;case"box":d=b.defaults[0];var e=b.defaults[0];break;case"namedbox":if(void 0===b.defaults[0]){d="namedbox";var e=_("box")}else{d=b.defaults[0];var e=b.defaults[0]}break;case"namedarg":if(void 0===b.defaults[0]){d="namedarg";var e="1"}else{d=b.defaults[0];var e=b.defaults[0]}break;case"nameddo":if(void 0===b.defaults[0]){d="nameddo";var e=_("action")}else{d=b.defaults[0];var e=b.defaults[0]}break;case"nameddoArg":if(void 0===b.defaults[0]){d="nameddoArg";var e=_("action")}else{d=b.defaults[0];var e=b.defaults[0]}break;case"namedcalc":if(void 0===b.defaults[0]){d="namedcalc";var e=_("action")}else{d=b.defaults[0];var e=b.defaults[0]}break;case"namedcalcArg":if(void 0===b.defaults[0]){d="namedcalcArg";var e=_("action")}else{d=b.defaults[0];var e=b.defaults[0]}}var f=this.palettes.blocks.protoBlockDict[c];if(null!=f){var g="";switch(f.name){case"text":g=_("text");break;case"solfege":g=i18nSolfege("sol");break;case"eastindiansolfege":g="sargam";break;case"notename":g="G";break;case"number":g=NUMBERBLOCKDEFAULT.toString();break;case"less":case"greater":case"equal":g=f.staticLabels[0];break;case"namedarg":g="arg "+e;break;default:c!=d?g="storein"===c&&b.defaults[0]===_("box")?_("store in"):b.defaults[0]:f.staticLabels.length>0?""===(g=f.staticLabels[0])&&(g="loadFile"===c?_("open file"):c):g=c}switch(-1!=["do","nameddo","namedbox","namedcalc","doArg","calcArg","nameddoArg","namedcalcArg"].indexOf(f.name)&&null!=g&&g.length>8&&(g=g.substr(0,7)+"..."),f.image&&(g=""),f.name){case"namedbox":case"namedarg":var h=new SVG;h.init(),h.setScale(f.scale),h.setExpand(60,0,0,0),h.setOutie(!0);var i=h.basicBox(),j=h.docks;break;case"nameddo":var h=new SVG;h.init(),h.setScale(f.scale),h.setExpand(30,0,0,0);var i=h.basicBlock(),j=h.docks;break;default:var k=f.generator(),i=k[0],j=k[1]}i=f.disabled?i.replace(/fill_color/g,DISABLEDFILLCOLOR).replace(/stroke_color/g,DISABLEDSTROKECOLOR).replace("block_label",g):i.replace(/fill_color/g,PALETTEFILLCOLORS[f.palette.name]).replace(/stroke_color/g,PALETTESTROKECOLORS[f.palette.name]).replace("block_label",g);for(var l=0;l<=f.args;l++)i=i.replace("arg_label_"+l,f.staticLabels[l]||"");this.blocks.push({blk:a,name:c,modname:d,height:STANDARDBLOCKHEIGHT,label:g,artwork:i,artwork64:"data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(i))),docks:j,image:b.image,scale:b.scale,palettename:this.palette.name})}else console.log("Could not find block "+c)}}}}function PopdownPalette(a){this.palettes=a,this.models={};for(var b in this.palettes.dict)this.models[b]=new PaletteModel(this.palettes.dict[b],this.palettes,b);this.update=function(){var a='<div class="back"><h2>'+_("back")+"</h2></div>";for(var b in this.models){a+='<div class="palette">';var c=PALETTEICONS[b].replace(/#f{3,6}/gi,PALETTEFILLCOLORS[b]);a+=format('<h2 data-name="{n}">                                 {i}<span>{n}</span>                                 <img class="hide-button" src="header-icons/hide.svg"                                      alt="{'+_("hide")+'}"                                      title="{'+_("hide")+'}" />                                 <img class="show-button" src="header-icons/show.svg"                                      alt="{'+_("show")+'}"                                      title="{'+_("show")+'}" />                                 <img class="popout-button" src="header-icons/popout.svg"                                      alt="{'+_("popout")+'}"                                      title="{'+_("popout")+'}" />                             </h2>',{i:c,n:toTitleCase(_(b))}),a+="<ul>",this.models[b].update();var d=this.models[b].blocks;BUILTINPALETTES.indexOf(b)>-1&&d.reverse();for(var e in d)a+=format('<li title="{label}"                                     data-blk="{blk}"                                     data-palettename="{palettename}"                                     data-modname="{modname}">                                     <img src="{artwork64}" alt="{label}" />                                 </li>',d[e]);a+="</div>"}document.querySelector("#popdown-palette").innerHTML=a;var f=this;document.querySelector("#popdown-palette .back").addEventListener("click",function(){f.popup()});var g=document.querySelectorAll("#popdown-palette > .palette");Array.prototype.forEach.call(g,function(a){a.querySelector("h2").addEventListener("click",function(){a.classList.contains("show")?a.classList.remove("show"):a.classList.add("show")}),a.querySelector(".popout-button").addEventListener("click",function(){f.popup(),f.palettes.showPalette(a.querySelector("h2").dataset.name)})});var g=document.querySelectorAll("#popdown-palette li");Array.prototype.forEach.call(g,function(a){a.addEventListener("click",function(b){f.popup();var c=f.palettes.dict[a.dataset.palettename];c.protoContainers[a.dataset.modname],c._makeBlockFromPalette(c.protoList[a.dataset.blk],a.dataset.modname,function(a){f.palettes.blocks.findDragGroup(a);for(var c in f.palettes.blocks.dragGroup)f.palettes.blocks.moveBlockRelative(f.palettes.blocks.dragGroup[c],Math.round(b.clientX/f.palettes.scale)-f.palettes.blocks.stage.x,Math.round(b.clientY/f.palettes.scale)-f.palettes.blocks.stage.y);f.palettes.blocks.blockMoved(a)})})})},this.popdown=function(){this.update(),document.querySelector("#popdown-palette").classList.add("show")},this.popup=function(){document.querySelector("#popdown-palette").classList.remove("show")}}function Palette(a,b){return this.palettes=a,this.name=b,this.model=new PaletteModel(this,a,b),this.visible=!1,this.menuContainer=null,this.protoList=[],this.protoContainers={},this.background=null,this.scrollDiff=0,this.y=0,this.size=0,this.columns=0,this.draggingProtoBlock=!1,this.mouseHandled=!1,this.upButton=null,this.downButton=null,this.fadedUpButton=null,this.fadedDownButton=null,this.count=0,this.makeMenu=function(a){function b(a,b,c,d){c.scaleX=c.scaleY=c.scale=.8,a.menuContainer.addChild(c),a.palettes.container.addChild(a.menuContainer)}function c(a,b,c,d){c.scaleX=c.scaleY=c.scale=.7,a.menuContainer.addChild(c),c.x=j-STANDARDBLOCKHEIGHT,c.y=0;var e=new createjs.Shape;e.graphics.beginFill("#FFF").drawEllipse(-j/2,-STANDARDBLOCKHEIGHT/2,j,STANDARDBLOCKHEIGHT),e.x=j/2,e.y=STANDARDBLOCKHEIGHT/2,a.menuContainer.hitArea=e,a.menuContainer.visible=!1,a.mouseHandled||(a._loadPaletteMenuHandler(),a.mouseHandled=!0)}function d(a,b,c,d){c.scaleX=c.scaleY=c.scale=.7,a.palettes.stage.addChild(c),c.x=a.menuContainer.x+j,c.y=a.menuContainer.y+STANDARDBLOCKHEIGHT,h(c);new createjs.Shape;c.visible=!1,a.upButton=c,a.upButton.on("click",function(b){a.scrollEvent(STANDARDBLOCKHEIGHT,10)})}function e(a,b,c,d){c.scaleX=c.scaleY=c.scale=.7,a.palettes.stage.addChild(c),c.x=a.menuContainer.x+j,c.y=a._getDownButtonY()-STANDARDBLOCKHEIGHT,h(c),a.downButton=c,a.downButton.on("click",function(b){a.scrollEvent(-STANDARDBLOCKHEIGHT,10)})}function f(a,b,c,d){c.scaleX=c.scaleY=c.scale=.7,a.palettes.stage.addChild(c),c.x=a.menuContainer.x+j,c.y=a._getDownButtonY(),h(c),a.fadedDownButton=c}function g(a,b,c,d){c.scaleX=c.scaleY=c.scale=.7,a.palettes.stage.addChild(c),c.x=a.menuContainer.x+j,c.y=a.menuContainer.y+STANDARDBLOCKHEIGHT,h(c),a.fadedUpButton=c}function h(a){var b=new createjs.Shape;b.graphics.beginFill("#FFF").drawRect(0,0,STANDARDBLOCKHEIGHT,STANDARDBLOCKHEIGHT),b.x=0,b.y=0,a.hitArea=b,a.visible=!1}function i(a,h,i,j){a.menuContainer.addChild(i),makePaletteBitmap(a,DOWNICON,h,e,null),makePaletteBitmap(a,FADEDDOWNICON,h,f,null),makePaletteBitmap(a,FADEDUPICON,h,g,null),makePaletteBitmap(a,UPICON,h,d,null),makePaletteBitmap(a,CLOSEICON,h,c,null),makePaletteBitmap(a,PALETTEICONS[h],h,b,null)}if(null==this.menuContainer&&(this.menuContainer=new createjs.Container,this.menuContainer.snapToPixelEnabled=!0),a){var j=MENUWIDTH+this._getOverflowWidth();this.menuContainer.removeAllChildren(),makePaletteBitmap(this,PALETTEHEADER.replace("fill_color","#282828").replace("palette_label",toTitleCase(_(this.name))).replace(/header_width/g,j),this.name,i,null)}},this._getDownButtonY=function(){return maxPaletteHeight(this.palettes.cellSize,this.palettes.scale)+STANDARDBLOCKHEIGHT/2},this._resizeEvent=function(){this.hide(),this._updateBackground(),this._updateBlockMasks(),null!==this.downButton&&(this.downButton.y=this._getDownButtonY(),this.fadedDownButton.y=this.downButton.y)},this._updateBlockMasks=function(){var a=Math.min(maxPaletteHeight(this.palettes.cellSize,this.palettes.scale),this.y),b=MENUWIDTH+this._getOverflowWidth();for(var c in this.protoContainers){var d=new createjs.Shape;d.graphics.r(0,0,b,a),d.x=this.background.x,d.y=this.background.y,this.protoContainers[c].mask=d}},this._getOverflowWidth=function(){var a=0;for(var b in this.protoList)a=Math.max(a,this.protoList[b].textWidth);return a>100?a-30:0},this._updateBackground=function(){if(null!=this.menuContainer){null!==this.background?this.background.removeAllChildren():(this.background=new createjs.Container,this.background.snapToPixelEnabled=!0,this.background.visible=!1,this.palettes.stage.addChild(this.background),this._setupBackgroundEvents());var a=maxPaletteHeight(this.palettes.cellSize,this.palettes.scale),b=new createjs.Shape;b.graphics.f("#949494").r(0,0,MENUWIDTH+this._getOverflowWidth(),a).ef(),b.width=MENUWIDTH+this._getOverflowWidth(),b.height=a,this.background.addChild(b),this.background.x=this.menuContainer.x,this.background.y=this.menuContainer.y+STANDARDBLOCKHEIGHT}},this._resetLayout=function(){if(null==this.menuContainer)return void console.log("menuContainer is null");for(var a in this.protoContainers)this.protoContainers[a].y-=this.scrollDiff;this.y=this.menuContainer.y+STANDARDBLOCKHEIGHT;var b=[];for(var a in this.protoContainers)b.push(this.protoContainers[a]);for(var c=b.length,d=0;d<c;d++){var a=b.pop();a.x=this.menuContainer.x,a.y=this.y;var e=a.getBounds();this.y+=null!=e?e.height-.1*STANDARDBLOCKHEIGHT:.9*STANDARDBLOCKHEIGHT}for(var a in this.protoContainers)this.protoContainers[a].y+=this.scrollDiff},this._updateMenu=function(a){function c(a,b,c,d){var e=a.protoContainers[c].getBounds();a.protoContainers[c].cache(e.x,e.y,Math.ceil(e.width),Math.ceil(e.height));var f=new createjs.Shape;f.graphics.beginFill("#FFF").drawRect(0,0,Math.ceil(e.width),Math.ceil(.75*e.height)),a.protoContainers[c].hitArea=f,a._loadPaletteMenuItemHandler(d,c),a.palettes.refreshCanvas()}function d(a,b,d,e){var f=e[0],g=e[1],h=e[2];if(void 0==a.protoContainers[b])return void console.log("no protoContainer for "+b);if(a.protoContainers[b].addChild(d),d.x=PALETTELEFTMARGIN,d.y=0,d.scaleX=PROTOBLOCKSCALE,d.scaleY=PROTOBLOCKSCALE,d.scale=PROTOBLOCKSCALE,f.image){var i=new Image;i.onload=function(){var d=new createjs.Bitmap(i);i.width>i.height?d.scaleX=d.scaleY=d.scale=MEDIASAFEAREA[2]/i.width*(f.scale/2):d.scaleX=d.scaleY=d.scale=MEDIASAFEAREA[3]/i.height*(f.scale/2),a.protoContainers[b].addChild(d),d.x=MEDIASAFEAREA[0]*(f.scale/2),d.y=MEDIASAFEAREA[1]*(f.scale/2),c(a,g,b,h)},i.src=f.image}else c(a,g,b,h)}function e(a,b,c,e){var f=e[0];makePaletteBitmap(a,f.artwork,f.modname,d,e)}null==this.menuContainer?this.makeMenu(!0):a?this.hide():this.palettes.mobile&&this.hide(),this.y=0,this.model.update();var f=this.model.blocks;-1==BUILTINPALETTES.indexOf(b)&&f.reverse();for(var g in f){var h=f[g];this.protoContainers[h.modname]?(this.protoContainers[h.modname].x=this.menuContainer.x,this.protoContainers[h.modname].y=this.menuContainer.y+this.y+this.scrollDiff+STANDARDBLOCKHEIGHT,this.y+=Math.ceil(h.height*PROTOBLOCKSCALE)):(this.protoContainers[h.modname]=new createjs.Container,this.protoContainers[h.modname].snapToPixelEnabled=!0,this.protoContainers[h.modname].x=this.menuContainer.x,this.protoContainers[h.modname].y=this.menuContainer.y+this.y+this.scrollDiff+STANDARDBLOCKHEIGHT,this.palettes.stage.addChild(this.protoContainers[h.modname]),this.protoContainers[h.modname].visible=!1,this.size+=Math.ceil(h.height*PROTOBLOCKSCALE),this.y+=Math.ceil(h.height*PROTOBLOCKSCALE),this._updateBackground(),makePaletteBitmap(this,PALETTEFILLER.replace(/filler_height/g,h.height.toString()),h.modname,e,[h,g,this.protoList[g]]))}this.makeMenu(!1),this.palettes.mobile&&this.hide()},this._moveMenu=function(a,b){if(null!=this.menuContainer){var c=a-this.menuContainer.x,d=b-this.menuContainer.y;this.menuContainer.x=a,this.menuContainer.y=b,this._moveMenuItemsRelative(c,d)}},this._moveMenuRelative=function(a,b){this.menuContainer.x+=a,this.menuContainer.y+=b,this._moveMenuItemsRelative(a,b)},this.hide=function(){this.hideMenu()},this.show=function(){this.palettes.mobile?this.hideMenu():this.showMenu();for(var a in this.protoContainers)this.protoContainers[a].visible=!0;this._updateBlockMasks(),null!==this.background&&(this.background.visible=!0)},this.hideMenu=function(){null!=this.menuContainer&&(this.menuContainer.visible=!1,this._hideMenuItems(!0)),this._moveMenu(this.palettes.cellSize,this.palettes.cellSize)},this.showMenu=function(){this.palettes.mobile?this.menuContainer.visible=!1:this.menuContainer.visible=!0},this._hideMenuItems=function(a){for(var b in this.protoContainers)this.protoContainers[b].visible=!1;null!==this.background&&(this.background.visible=!1),null!=this.fadedDownButton&&(this.upButton.visible=!1,this.downButton.visible=!1,this.fadedUpButton.visible=!1,this.fadedDownButton.visible=!1),this.visible=!1},this._showMenuItems=function(a){0===this.scrollDiff&&(this.count=0);for(var b in this.protoContainers)this.protoContainers[b].visible=!0;this._updateBlockMasks(),null!==this.background&&(this.background.visible=!0),this.scrollEvent(0,10),this.visible=!0},this._moveMenuItems=function(a,b){for(var c in this.protoContainers)this.protoContainers[c].x=a,this.protoContainers[c].y=b;null!==this.background&&(this.background.x=a,this.background.y=b)},this._moveMenuItemsRelative=function(a,b){for(var c in this.protoContainers)this.protoContainers[c].x+=a,this.protoContainers[c].y+=b;null!==this.background&&(this.background.x+=a,this.background.y+=b),null!==this.fadedDownButton&&(this.upButton.x+=a,this.upButton.y+=b,this.downButton.x+=a,this.downButton.y+=b,this.fadedUpButton.x+=a,this.fadedUpButton.y+=b,this.fadedDownButton.x+=a,this.fadedDownButton.y+=b)},this.scrollEvent=function(a,b){var c=a*b,d=Math.min(maxPaletteHeight(this.palettes.cellSize,this.palettes.scale),this.y);if(this.y<maxPaletteHeight(this.palettes.cellSize,this.palettes.scale))return this.upButton.visible=!1,this.downButton.visible=!1,this.fadedUpButton.visible=!1,void(this.fadedDownButton.visible=!1);if(this.scrollDiff+c>0&&a>0){var e=-this.scrollDiff;if(0===e)return this.downButton.visible=!0,this.upButton.visible=!1,this.fadedUpButton.visible=!0,void(this.fadedDownButton.visible=!1);this.scrollDiff+=e,this.fadedDownButton.visible=!1,this.downButton.visible=!0;for(var f in this.protoContainers)this.protoContainers[f].y+=e,this.protoContainers[f].visible=!0,0===this.scrollDiff&&(this.downButton.visible=!0,this.upButton.visible=!1,this.fadedUpButton.visible=!0,this.fadedDownButton.visible=!1)}else if(this.y+this.scrollDiff+c<d&&a<0){var e=-this.y+d-this.scrollDiff;if(0===e)return this.upButton.visible=!0,this.downButton.visible=!1,this.fadedDownButton.visible=!0,void(this.fadedUpButton.visible=!1);this.scrollDiff+=-this.y+d-this.scrollDiff,this.fadedUpButton.visible=!1,this.upButton.visible=!0;for(var f in this.protoContainers)this.protoContainers[f].y+=e,this.protoContainers[f].visible=!0;-this.y+d-this.scrollDiff==0&&(this.upButton.visible=!0,this.downButton.visible=!1,this.fadedDownButton.visible=!0,this.fadedUpButton.visible=!1)}else if(0===this.count)this.fadedUpButton.visible=!0,this.fadedDownButton.visible=!1,this.upButton.visible=!1,this.downButton.visible=!0;else{this.scrollDiff+=c,this.fadedUpButton.visible=!1,this.fadedDownButton.visible=!1,this.upButton.visible=!0,this.downButton.visible=!0;for(var f in this.protoContainers)this.protoContainers[f].y+=c,this.protoContainers[f].visible=!0}this._updateBlockMasks();var g=this.palettes.stage;g.setChildIndex(this.menuContainer,g.getNumChildren()-1),this.palettes.refreshCanvas(),this.count+=1},this.getInfo=function(){var a=this.name+" palette:";for(var b in this.protoList)a+=" "+this.protoList[b].name;return a},this.remove=function(a,b){var c=this.protoList.indexOf(a);-1!==c&&this.protoList.splice(c,1);for(var c=0;c<this.model.blocks.length;c++)if(-1!==["nameddo","nameddoArg","namedcalc","namedcalcArg"].indexOf(this.model.blocks[c].blkname)&&this.model.blocks[c].modname===b){this.model.blocks.splice(c,1);break}this.palettes.stage.removeChild(this.protoContainers[b]),delete this.protoContainers[b]},this.add=function(a,b){return-1===this.protoList.indexOf(a)&&(void 0===b?this.protoList.push(a):this.protoList.splice(0,0,a)),this},this._setupBackgroundEvents=function(){var a=this,b=!1;this.background.on("mouseover",function(b){a.palettes.activePalette=a}),this.background.on("mouseout",function(b){a.palettes.activePalette=null}),this.background.on("mousedown",function(c){b=!0;var d=c.stageY;a.background.on("pressmove",function(c){if(b){var e=c.stageY-d;a.scrollEvent(e,10),d=c.stageY}}),a.background.on("pressup",function(c){a.palettes.activePalette=null,b=!1},null,!0)})},this._loadPaletteMenuHandler=function(){var a=this,b=!1,c=this.palettes.trashcan,d=MENUWIDTH+this._getOverflowWidth();this.menuContainer.on("click",function(c){if(Math.round(c.stageX/a.palettes.scale)>a.menuContainer.x+d-STANDARDBLOCKHEIGHT)return a.hide(),void a.palettes.refreshCanvas();if(!b){b=!0,setTimeout(function(){b=!1},500);for(var e in a.palettes.dict)a.name!=e&&a.palettes.dict[e].visible&&a.palettes.dict[e]._hideMenuItems(!1);a.visible?a._hideMenuItems(!1):a._showMenuItems(!1),a.palettes.refreshCanvas()}}),this.menuContainer.on("mousedown",function(b){c.show();var d={x:a.menuContainer.x-Math.round(b.stageX/a.palettes.scale),y:a.menuContainer.y-Math.round(b.stageY/a.palettes.scale)};a.menuContainer.on("pressup",function(b){c.overTrashcan(b.stageX/a.palettes.scale,b.stageY/a.palettes.scale)&&c.isVisible&&(a.hide(),a.palettes.refreshCanvas(),"myblocks"===a.name?a._promptMacrosDelete():-1===BUILTINPALETTES.indexOf(a.name)&&a._promptPaletteDelete()),c.hide()}),a.menuContainer.on("mouseout",function(b){c.overTrashcan(b.stageX/a.palettes.scale,b.stageY/a.palettes.scale)&&c.isVisible&&(a.hide(),a.palettes.refreshCanvas()),c.hide()}),a.menuContainer.on("pressmove",function(b){var e=a.menuContainer.x,f=a.menuContainer.y;a.menuContainer.x=Math.round(b.stageX/a.palettes.scale)+d.x,a.menuContainer.y=Math.round(b.stageY/a.palettes.scale)+d.y,a.palettes.refreshCanvas();var g=a.menuContainer.x-e,h=a.menuContainer.y-f;a.palettes.initial_x=a.menuContainer.x,a.palettes.initial_y=a.menuContainer.y,c.overTrashcan(b.stageX/a.palettes.scale,b.stageY/a.palettes.scale)?c.startHighlightAnimation():c.stopHighlightAnimation(),a._hideMenuItems(!1),a._moveMenuItemsRelative(g,h)})})},this._loadPaletteMenuItemHandler=function(a,b){var c=this,d=!1,e=!1,f=!1,g=this.protoContainers[b].x,h=this.protoContainers[b].y;this.protoContainers[b].on("mouseover",function(a){c.palettes.activePalette=c}),this.protoContainers[b].on("mousedown",function(a){var d=c.palettes.stage;d.setChildIndex(c.protoContainers[b],d.getNumChildren()-1);var i=Math.min(maxPaletteHeight(c.palettes.cellSize,c.palettes.scale),c.palettes.y);a.stageY,c.palettes.scale,c.menuContainer.y,STANDARDBLOCKHEIGHT;c.protoContainers[b].mask=null,f=!1,e=!0,g=c.protoContainers[b].x,h=c.protoContainers[b].y-c.scrollDiff;var j=a.stageX,k=a.stageY,l=a.stageY;if(!c.draggingProtoBlock){var m=window.hasMouse?MODEDRAG:MODEUNSURE;c.protoContainers[b].on("pressmove",function(a){if(m===MODEDRAG)return f=!0,c.draggingProtoBlock=!0,c.protoContainers[b].x=Math.round(a.stageX/c.palettes.scale)-PALETTELEFTMARGIN,c.protoContainers[b].y=Math.round(a.stageY/c.palettes.scale),void c.palettes.refreshCanvas();if(m===MODESCROLL){var d=a.stageY-l;return c.scrollEvent(d,10),void(l=a.stageY)}var e=Math.abs(a.stageX-j),g=Math.abs(a.stageY-k),d=Math.sqrt(e*e+g*g);m===MODEUNSURE&&d>DECIDEDISTANCE&&(m=g>e?MODESCROLL:MODEDRAG)})}}),this.protoContainers[b].on("mouseout",function(a){c.palettes.activePalette=null,e&&f&&(c._restoreProtoblock(b,g,h+c.scrollDiff),e=!1,f=!1)}),this.protoContainers[b].on("pressup",function(e){c.palettes.activePalette=null,d||(d=!0,setTimeout(function(){d=!1},1e3),c._makeBlockFromProtoblock(a,f,b,e,g,h))})},this._restoreProtoblock=function(a,b,c){this.protoContainers[a].x=b,this.protoContainers[a].y=c,this._resetLayout()},this._promptPaletteDelete=function(){var a='Do you want to remove all "%s" blocks from your project?'.replace("%s",this.name);if(confirm(a)){this.palettes.remove(this.name),delete pluginObjs.PALETTEHIGHLIGHTCOLORS[this.name],delete pluginObjs.PALETTESTROKECOLORS[this.name],delete pluginObjs.PALETTEFILLCOLORS[this.name],delete pluginObjs.PALETTEPLUGINS[this.name],"GLOBALS"in pluginObjs&&delete pluginObjs.GLOBALS[this.name],"IMAGES"in pluginObjs&&delete pluginObjs.IMAGES[this.name],"ONLOAD"in pluginObjs&&delete pluginObjs.ONLOAD[this.name],"ONSTART"in pluginObjs&&delete pluginObjs.ONSTART[this.name],"ONSTOP"in pluginObjs&&delete pluginObjs.ONSTOP[this.name];for(var b=0;b<this.protoList.length;b++){var c=this.protoList[b].name;delete pluginObjs.FLOWPLUGINS[c],delete pluginObjs.ARGPLUGINS[c],delete pluginObjs.BLOCKPLUGINS[c]}storage.plugins=preparePluginExports({}),sugarizerCompatibility.isInsideSugarizer()&&sugarizerCompatibility.saveLocally()}},this._promptMacrosDelete=function(){if(confirm("Do you want to remove all the stacks from your custom palette?")){for(var a=0;a<this.protoList.length;a++){var b=this.protoList[a].name;delete this.protoContainers[b],this.protoList.splice(a,1)}this.palettes.updatePalettes("myblocks"),storage.macros=prepareMacroExports(null,null,{}),sugarizerCompatibility.isInsideSugarizer()&&sugarizerCompatibility.saveLocally()}},this._makeBlockFromPalette=function(a,b,c){if(null==a)return void console.log("null protoblk?");switch(a.name){case"do":b="do "+a.defaults[0];var d=a.name,e=a.defaults[0];break;case"storein":b="store in "+a.defaults[0];var d=a.name,e=a.defaults[0];break;case"box":b=a.defaults[0];var d=a.name,e=a.defaults[0];break;case"namedbox":if(void 0===a.defaults[0]){b="namedbox";var e=_("box")}else{b=a.defaults[0];var e=a.defaults[0]}var d=a.name;break;case"namedarg":if(void 0===a.defaults[0]){b="namedarg";var e="1"}else{b=a.defaults[0];var e=a.defaults[0]}var d=a.name;break;case"nameddo":if(void 0===a.defaults[0]){b="nameddo";var e=_("action")}else{b=a.defaults[0];var e=a.defaults[0]}var d=a.name;break;case"nameddoArg":if(void 0===a.defaults[0]){b="nameddoArg";var e=_("action")}else{b=a.defaults[0];var e=a.defaults[0]}var d=a.name;break;case"namedcalc":if(void 0===a.defaults[0]){b="namedcalc";var e=_("action")}else{b=a.defaults[0];var e=a.defaults[0]}var d=a.name;break;case"namedcalcArg":if(void 0===a.defaults[0]){b="namedcalcArg";var e=_("action")}else{b=a.defaults[0];var e=a.defaults[0]}var d=a.name;break;default:var d=b,e="__NOARG__"}if("namedbox"!==a.name&&blockIsMacro(b))moved=!0,saveX=this.protoContainers[b].x,saveY=this.protoContainers[b].y,this._makeBlockFromProtoblock(a,moved,b,null,saveX,saveY);else{c(paletteBlockButtonPush(this.palettes.blocks,d,e))}},this.cleanup=function(){this._resetLayout(),this._updateBlockMasks(),this.palettes.refreshCanvas()},this._makeBlockFromProtoblock=function(a,b,c,d,e,f){function g(a){h.palettes.blocks.findDragGroup(a);for(var b in h.palettes.blocks.dragGroup)h.palettes.blocks.moveBlockRelative(h.palettes.blocks.dragGroup[b],Math.round(d.stageX/h.palettes.scale)-h.palettes.blocks.stage.x,Math.round(d.stageY/h.palettes.scale)-h.palettes.blocks.stage.y);h.palettes.blocks.blockMoved(a),h.palettes.blocks.checkBounds()}var h=this;if(b){b=!1,this.draggingProtoBlock=!1;var i=getMacroExpansion(c,this.protoContainers[c].x-this.palettes.blocks.stage.x,this.protoContainers[c].y-this.palettes.blocks.stage.y);if(null!=i){this.palettes.blocks.loadNewBlocks(i);var j=this.palettes.blocks.blockList.length-1,k=this.palettes.blocks.findTopBlock(j)}else if("myblocks"===this.name){for(var l=c.replace("macro_",""),m=[],n=0;n<this.palettes.macroDict[l].length;n++){var o=this.palettes.macroDict[l][n][1],p=[];p="string"==typeof o?o:"string"==typeof o[1]?"number"===o[0]?[o[0],Number(o[1])]:[o[0],o[1]]:"number"==typeof o[1]?"number"===o[0]?[o[0],o[1]]:[o[0],o[1].toString()]:"number"===o[0]?[o[0],Number(o[1].value)]:[o[0],{value:o[1].value}];var q=[this.palettes.macroDict[l][n][0],p,this.palettes.macroDict[l][n][2],this.palettes.macroDict[l][n][3],this.palettes.macroDict[l][n][4]];m.push(q)}m[0][2]=this.protoContainers[c].x-this.palettes.blocks.stage.x,m[0][3]=this.protoContainers[c].y-this.palettes.blocks.stage.y,this.palettes.blocks.loadNewBlocks(m);var j=this.palettes.blocks.blockList.length-1,k=this.palettes.blocks.findTopBlock(j);setTimeout(function(){this.palettes.blocks.blockList[k].collapseToggle()},500)}else var q=this._makeBlockFromPalette(a,c,g,q);this.cleanup()}},this}function initPalettes(a){for(var b=0;b<BUILTINPALETTES.length;b++)a.add(BUILTINPALETTES[b]);a.makePalettes(!0),setTimeout(function(){a.show(),a.bringToTop()},6e3)}function makePaletteBitmap(a,b,c,d,e){var f=new Image;f.onload=function(){var b=new createjs.Bitmap(f);d(a,c,b,e)},f.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(b)))}requirejs(["activity/utils"]);const PROTOBLOCKSCALE=1,PALETTELEFTMARGIN=10,MODEUNSURE=0,MODEDRAG=1,MODESCROLL=2,DECIDEDISTANCE=20;