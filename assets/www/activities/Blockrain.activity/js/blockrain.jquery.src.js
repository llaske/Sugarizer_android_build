/*! Sugarizer 2018-05-08 */
!function(a){"use strict";a.widget("aerolab.blockrain",{options:{autoplay:!1,autoplayRestart:!0,showFieldOnStart:!0,theme:null,blockWidth:10,autoBlockWidth:!1,autoBlockSize:24,difficulty:"normal",speed:20,asdwKeys:!0,playButtonText:"Play",gameOverText:"Game Over",restartButtonText:"Play Again",scoreText:"Score",onStart:function(){},onRestart:function(){},onGameOver:function(a){},onPlaced:function(){},onLine:function(a,b,c){}},start:function(){this._doStart(),this.options.onStart.call(this.element)},restart:function(){this._doStart(),this.options.onRestart.call(this.element)},gameover:function(){this.showGameOverMessage(),this._board.gameover=!0,this.options.onGameOver.call(this.element,this._filled.score)},_doStart:function(){this._filled.clearAll(),this._filled._resetScore(),this._board.cur=this._board.nextShape(),this._board.started=!0,this._board.gameover=!1,this._board.dropDelay=5,this._board.render(!0),this._board.animate(),this._$start.fadeOut(150),this._$gameover.fadeOut(150),this._$score.fadeIn(150)},pause:function(){this._board.paused=!0},resume:function(){this._board.paused=!1},autoplay:function(a){"boolean"!=typeof a&&(a=!0),this.options.autoplay=a,a&&!this._board.started&&this._doStart(),this._setupControls(!a),this._setupTouchControls(!a)},controls:function(a){"boolean"!=typeof a&&(a=!0),this._setupControls(a)},touchControls:function(a){"boolean"!=typeof a&&(a=!0),this._setupTouchControls(a)},score:function(a){return"undefined"!=typeof a&&parseInt(a)>=0&&(this._filled.score=parseInt(a),this._$scoreText.text(this._filled_score)),this._filled.score},freesquares:function(){return this._filled.getFreeSpaces()},showStartMessage:function(){this._$start.show()},showGameOverMessage:function(){this._$gameover.show()},updateSizes:function(){this._PIXEL_WIDTH=this.element.innerWidth(),this._PIXEL_HEIGHT=this.element.innerHeight(),this._BLOCK_WIDTH=this.options.blockWidth,this._BLOCK_HEIGHT=Math.floor(this.element.innerHeight()/this.element.innerWidth()*this._BLOCK_WIDTH),this._block_size=Math.floor(this._PIXEL_WIDTH/this._BLOCK_WIDTH),this._border_width=2,this._PIXEL_WIDTH=this._block_size*this._BLOCK_WIDTH,this._PIXEL_HEIGHT=this._block_size*this._BLOCK_HEIGHT,this._$canvas.attr("width",this._PIXEL_WIDTH).attr("height",this._PIXEL_HEIGHT)},theme:function(b){return"undefined"==typeof b?this.options.theme||this._theme:("string"==typeof b?(this.options.theme=b,this._theme=a.extend(!0,{},BlockrainThemes[b])):(this.options.theme=null,this._theme=b),"undefined"!=typeof this._theme&&null!==this._theme||(this._theme=a.extend(!0,{},BlockrainThemes.retro),this.options.theme="retro"),(isNaN(parseInt(this._theme.strokeWidth))||"number"!=typeof parseInt(this._theme.strokeWidth))&&(this._theme.strokeWidth=2),this._preloadThemeAssets(),void(null!==this._board&&("string"==typeof this._theme.background&&this._$canvas.css("background-color",this._theme.background),this._board.render())))},_theme:{},_$game:null,_$canvas:null,_$gameholder:null,_$start:null,_$gameover:null,_$score:null,_$scoreText:null,_canvas:null,_ctx:null,_create:function(){var b=this;this.theme(this.options.theme),this._createHolder(),this._createUI(),this._refreshBlockSizes(),this.updateSizes(),a(window).resize(function(){}),this._SetupShapeFactory(),this._SetupFilled(),this._SetupInfo(),this._SetupBoard(),this._info.init(),this._board.init();var c=function(){requestAnimationFrame(c),b._board.render()};c(),this.options.autoplay?(this.autoplay(!0),this._setupTouchControls(!1)):(this._setupControls(!0),this._setupTouchControls(!1))},_checkCollisions:function(a,b,c,d){for(var e,f,g=0,h=c.length;g<h;g+=2){if(e=a+c[g],f=b+c[g+1],f>=this._BLOCK_HEIGHT||this._filled.check(e,f))return!0;if(!d&&e<0||e>=this._BLOCK_WIDTH)return!0}return!1},_board:null,_info:null,_filled:null,_drawBackground:function(){if("string"==typeof this._theme.background){if(this._theme.backgroundGrid instanceof Image){if(0===this._theme.backgroundGrid.width||0===this._theme.backgroundGrid.height)return;this._ctx.globalAlpha=1;for(var a=0;a<this._BLOCK_WIDTH;a++)for(var b=0;b<this._BLOCK_HEIGHT;b++){var c=a*this._block_size,d=b*this._block_size;this._ctx.drawImage(this._theme.backgroundGrid,0,0,this._theme.backgroundGrid.width,this._theme.backgroundGrid.height,c,d,this._block_size,this._block_size)}}else if("string"==typeof this._theme.backgroundGrid){var e=this._theme.strokeWidth;Math.round(.23*this._block_size),Math.round(.3*this._block_size);this._ctx.globalAlpha=1,this._ctx.fillStyle=this._theme.backgroundGrid;for(var a=0;a<this._BLOCK_WIDTH;a++)for(var b=0;b<this._BLOCK_HEIGHT;b++){var c=a*this._block_size,d=b*this._block_size;this._ctx.fillRect(c+e,d+e,this._block_size-2*e,this._block_size-2*e)}}this._ctx.globalAlpha=1}},_shapeFactory:null,_shapes:{line:[[0,-1,0,-2,0,-3,0,-4],[2,-2,1,-2,0,-2,-1,-2],[0,-4,0,-3,0,-2,0,-1],[-1,-2,0,-2,1,-2,2,-2]],square:[[0,0,1,0,0,-1,1,-1],[1,0,1,-1,0,0,0,-1],[1,-1,0,-1,1,0,0,0],[0,-1,0,0,1,-1,1,0]],arrow:[[0,-1,1,-1,2,-1,1,-2],[1,0,1,-1,1,-2,0,-1],[2,-1,1,-1,0,-1,1,0],[1,-2,1,-1,1,0,2,-1]],rightHook:[[2,0,1,0,1,-1,1,-2],[2,-2,2,-1,1,-1,0,-1],[0,-2,1,-2,1,-1,1,0],[0,0,0,-1,1,-1,2,-1]],leftHook:[[0,0,1,0,1,-1,1,-2],[2,0,2,-1,1,-1,0,-1],[2,-2,1,-2,1,-1,1,0],[0,-2,0,-1,1,-1,2,-1]],leftZag:[[0,0,0,-1,1,-1,1,-2],[2,-1,1,-1,1,-2,0,-2],[1,-2,1,-1,0,-1,0,0],[0,-2,1,-2,1,-1,2,-1]],rightZag:[[1,0,1,-1,0,-1,0,-2],[2,-1,1,-1,1,0,0,0],[0,-2,0,-1,1,-1,1,0],[0,0,1,0,1,-1,2,-1]]},_SetupShapeFactory:function(){function b(b,c,d,e){return a.extend(this,{x:0,y:0,symmetrical:d,init:function(){return a.extend(this,{orientation:0,x:Math.floor(b._BLOCK_WIDTH/2)-1,y:-1}),this},blockType:e,blockVariation:null,blocksLen:c[0].length,orientations:c,orientation:0,rotate:function(a){var c=(this.orientation+("left"===a?1:-1)+4)%4;b._checkCollisions(this.x,this.y,this.getBlocks(c))||(this.orientation=c,b._board.renderChanged=!0)},moveRight:function(){b._checkCollisions(this.x+1,this.y,this.getBlocks())||(this.x++,b._board.renderChanged=!0)},moveLeft:function(){b._checkCollisions(this.x-1,this.y,this.getBlocks())||(this.x--,b._board.renderChanged=!0)},drop:function(){b._checkCollisions(this.x,this.y+1,this.getBlocks())||(this.y++,b._board.dropCount=-1,b._board.animate(),b._board.renderChanged=!0)},getBlocks:function(a){return this.orientations[void 0!==a?a:this.orientation]},draw:function(a,c,d){for(var e=this.getBlocks(d),f=void 0===a?this.x:a,g=void 0===c?this.y:c,h=0,i=0;h<this.blocksLen;h+=2)b._board.drawBlock(f+e[h],g+e[h+1],this.blockType,this.blockVariation,i,this.orientation,!0),i++},getBounds:function(b){for(var c=a.isArray(b)?b:this.getBlocks(b),d=0,e=c.length,f=999,g=-999,h=999,i=-999;d<e;d+=2)c[d]<f&&(f=c[d]),c[d]>g&&(g=c[d]),c[d+1]<h&&(h=c[d+1]),c[d+1]>i&&(i=c[d+1]);return{left:f,right:g,top:h,bottom:i,width:g-f,height:i-h}}}),this.init()}var c=this;null===this._shapeFactory&&(this._shapeFactory={line:function(){return new b(c,c._shapes.line,!1,"line")},square:function(){return new b(c,c._shapes.square,!1,"square")},arrow:function(){return new b(c,c._shapes.arrow,!1,"arrow")},leftHook:function(){return new b(c,c._shapes.leftHook,!1,"leftHook")},rightHook:function(){return new b(c,c._shapes.rightHook,!1,"rightHook")},leftZag:function(){return new b(c,c._shapes.leftZag,!1,"leftZag")},rightZag:function(){return new b(c,c._shapes.rightZag,!1,"rightZag")}})},_SetupFilled:function(){var a=this;null===this._filled&&(this._filled={data:new Array(a._BLOCK_WIDTH*a._BLOCK_HEIGHT),score:0,toClear:{},check:function(a,b){return this.data[this.asIndex(a,b)]},add:function(b,c,d,e,f,g){b>=0&&b<a._BLOCK_WIDTH&&c>=0&&c<a._BLOCK_HEIGHT&&(this.data[this.asIndex(b,c)]={blockType:d,blockVariation:e,blockIndex:f,blockOrientation:g})},getFreeSpaces:function(){for(var a=0,b=0;b<this.data.length;b++)a+=this.data[b]?1:0},asIndex:function(b,c){return b+c*a._BLOCK_WIDTH},asX:function(b){return b%a._BLOCK_WIDTH},asY:function(b){return Math.floor(b/a._BLOCK_WIDTH)},clearAll:function(){delete this.data,this.data=new Array(a._BLOCK_WIDTH*a._BLOCK_HEIGHT)},_popRow:function(b){for(var c=a._BLOCK_WIDTH*(b+1)-1;c>=0;c--)this.data[c]=c>=a._BLOCK_WIDTH?this.data[c-a._BLOCK_WIDTH]:void 0},checkForClears:function(){var b,c,d,e,f=a._board.lines,g=[];for(b=0,c=this.data.length;b<c;b++)e=this.asX(b),0==e&&(d=0),this.data[b]&&"undefined"!=typeof this.data[b]&&"string"==typeof this.data[b].blockType&&(d+=1),e==a._BLOCK_WIDTH-1&&d==a._BLOCK_WIDTH&&g.push(this.asY(b));for(b=0,c=g.length;b<c;b++)this._popRow(g[b]),a._board.lines++,a._board.lines%10==0&&a._board.dropDelay>1&&(a._board.dropDelay*=.9);var h=a._board.lines-f;this._updateScore(h)},_updateScore:function(b){if(!(b<=0)){var c=[0,400,1e3,3e3,12e3];b>=c.length&&(b=c.length-1),this.score+=c[b],a._$scoreText.text(this.score),a.options.onLine.call(a.element,b,c[b],this.score)}},_resetScore:function(){this.score=0,a._$scoreText.text(this.score)},draw:function(){for(var b,c=0,d=this.data.length;c<d;c++)if(void 0!==this.data[c]){b=this.asY(c);var e=this.data[c];a._board.drawBlock(this.asX(c),b,e.blockType,e.blockVariation,e.blockIndex,e.blockOrientation)}}})},_SetupInfo:function(){var a=this;this._info={mode:a.options.difficulty,modes:["normal","nice","evil"],modesY:170,autopilotY:null,init:function(){this.mode=a.options.difficulty},setMode:function(b){this.mode=b,a._board.nextShape(!0)}}},_SetupBoard:function(){var b=this,c=this._info;this._board={animateDelay:1e3/b.options.speed,animateTimeoutId:null,cur:null,lines:0,dropCount:0,dropDelay:5,holding:{left:null,right:null,drop:null},holdingThreshold:200,started:!1,gameover:!1,renderChanged:!0,init:function(){this.cur=this.nextShape(),b.options.showFieldOnStart&&(b._drawBackground(),b._board.createRandomBoard(),b._board.render()),this.showStartMessage()},showStartMessage:function(){b._$start.show()},showGameOverMessage:function(){b._$gameover.show()},nextShape:function(d){var e,f,g,h=this.next;if(e="nice"==c.mode||"evil"==c.mode?b._niceShapes:b._randomShapes(),b.options.no_preview){if(this.next=null,d)return null;if(f=e(b._filled,b._checkCollisions,b._BLOCK_WIDTH,b._BLOCK_HEIGHT,c.mode),!f)throw new Error("No shape returned from shape function!",e);f.init(),g=f}else{if(f=e(b._filled,b._checkCollisions,b._BLOCK_WIDTH,b._BLOCK_HEIGHT,c.mode),!f)throw new Error("No shape returned from shape function!",e);if(f.init(),this.next=f,d)return null;g=h||this.nextShape()}return b.options.autoplay&&(b._niceShapes(b._filled,b._checkCollisions,b._BLOCK_WIDTH,b._BLOCK_HEIGHT,"normal",g),g.orientation=g.best_orientation,g.x=g.best_x),"undefined"!=typeof b._theme.complexBlocks?a.isArray(b._theme.complexBlocks[g.blockType])?g.blockVariation=b._randInt(0,b._theme.complexBlocks[g.blockType].length-1):g.blockVariation=null:"undefined"!=typeof b._theme.blocks&&(a.isArray(b._theme.blocks[g.blockType])?g.blockVariation=b._randInt(0,b._theme.blocks[g.blockType].length-1):g.blockVariation=null),g},animate:function(){var a=!1,c=!1,d=!1,e=Date.now();if(this.animateTimeoutId&&clearTimeout(this.animateTimeoutId),!this.paused&&!this.gameover&&(this.dropCount++,(this.dropCount>=this.dropDelay||b.options.autoplay||this.holding.drop&&e-this.holding.drop>=this.holdingThreshold)&&(a=!0,c=!0,this.dropCount=0),this.holding.left&&e-this.holding.left>=this.holdingThreshold&&(c=!0,this.cur.moveLeft()),this.holding.right&&e-this.holding.right>=this.holdingThreshold&&(c=!0,this.cur.moveRight()),a)){var f=this.cur,g=f.x,h=f.y,i=f.getBlocks();if(b._checkCollisions(g,h+1,i,!0)){a=!1;for(var j=0,k=0;k<f.blocksLen;k+=2)b._filled.add(g+i[k],h+i[k+1],f.blockType,f.blockVariation,j,f.orientation),h+i[k]<0&&(d=!0),j++;b._filled.checkForClears(),this.cur=this.nextShape(),this.renderChanged=!0,this.holding.left=null,this.holding.right=null,this.holding.drop=null,b.options.onPlaced.call(b.element)}}a&&(c=!0,this.cur.y++),(a||c)&&(this.renderChanged=!0),d?(this.gameover=!0,b.gameover(),b.options.autoplay&&b.options.autoplayRestart&&b.restart(),this.renderChanged=!0):(this.animateDelay=1e3/b.options.speed,this.animateTimeoutId=window.setTimeout(function(){b._board.animate()},this.animateDelay))},createRandomBoard:function(){var a,c,d,e,f,g=[];for(g=Object.keys(b._shapeFactory),a=0,c=b._BLOCK_WIDTH;a<c;a++)for(d=0,e=b._randChoice([b._randInt(0,8),b._randInt(5,9)]);d<e;d++)f&&b._randInt(0,3)||(f=b._randChoice(g)),b._filled.add(a,b._BLOCK_HEIGHT-d,f,b._randInt(0,3),null,b._randInt(0,3));b._board.render(!0)},render:function(a){(this.renderChanged||a)&&(this.renderChanged=!1,b._ctx.clearRect(0,0,b._PIXEL_WIDTH,b._PIXEL_HEIGHT),b._drawBackground(),b._filled.draw(),this.cur.draw())},drawBlock:function(a,c,d,e,f,g,h){a*=b._block_size,c*=b._block_size,h="boolean"==typeof h&&h;var i=b._theme.strokeWidth,j=Math.round(.23*b._block_size),k=Math.round(.3*b._block_size),l=this.getBlockColor(d,e,f,h);if(b._ctx.globalAlpha=1,l instanceof Image){if(b._ctx.globalAlpha=1,0===l.width||0===l.height)return;if("undefined"!=typeof b._theme.blocks&&null!==b._theme.blocks)b._ctx.drawImage(l,0,0,l.width,l.height,a,c,b._block_size,b._block_size);else if("undefined"!=typeof b._theme.complexBlocks&&null!==b._theme.complexBlocks){"undefined"!=typeof f&&null!==f||(f=0);var m=function(a,c,d){var e=b._shapes[c][0],f=Math.min(e[0],e[2],e[4],e[6]),g=Math.max(e[0],e[2],e[4],e[6]),h=Math.min(e[1],e[3],e[5],e[7]),i=Math.max(e[1],e[3],e[5],e[7]),j=g-f+1,k=i-h+1,l=a.width/j,m=a.height/k;return{x:l*(e[2*d]-f),y:m*Math.abs(h-e[2*d+1]),w:l,h:m}},n=m(l,d,f);b._ctx.save(),b._ctx.translate(a,c),b._ctx.translate(b._block_size/2,b._block_size/2),b._ctx.rotate(-Math.PI/2*g),b._ctx.drawImage(l,n.x,n.y,n.w,n.h,-b._block_size/2,-b._block_size/2,b._block_size,b._block_size),b._ctx.restore()}else b._ctx.fillStyle="#ff0000",b._ctx.fillRect(a,c,b._block_size,b._block_size)}else"string"==typeof l&&(b._ctx.fillStyle=l,b._ctx.fillRect(a,c,b._block_size,b._block_size),"string"==typeof b._theme.innerShadow&&(b._ctx.globalAlpha=1,b._ctx.strokeStyle=b._theme.innerShadow,b._ctx.lineWidth=1,b._ctx.strokeRect(a+1,c+1,b._block_size-2,b._block_size-2)),"string"==typeof b._theme.stroke&&(b._ctx.globalAlpha=1,b._ctx.fillStyle=b._theme.stroke,b._ctx.strokeStyle=b._theme.stroke,b._ctx.lineWidth=i,b._ctx.strokeRect(a,c,b._block_size,b._block_size)),"string"==typeof b._theme.innerStroke&&(b._ctx.fillStyle=b._theme.innerStroke,b._ctx.fillRect(a+j,c+j,b._block_size-2*j,i),b._ctx.fillRect(a+j,c+j+i,i,b._block_size-2*j-i)),"string"==typeof b._theme.innerSquare&&(b._ctx.fillStyle=b._theme.innerSquare,b._ctx.globalAlpha=.2,b._ctx.fillRect(a+k,c+k,b._block_size-2*k,b._block_size-2*k)));b._ctx.globalAlpha=1},getBlockColor:function(c,d,e,f){var g=function(b,c){return a.isArray(b)?null!==c&&"undefined"!=typeof b[c]?b[c]:b.length>0?b[0]:null:b};return"boolean"!=typeof f&&(f=!0),f?"string"==typeof b._theme.primary&&""!==b._theme.primary?b._theme.primary:"undefined"!=typeof b._theme.blocks&&null!==b._theme.blocks?g(b._theme.blocks[c],d):g(b._theme.complexBlocks[c],d):"string"==typeof b._theme.secondary&&""!==b._theme.secondary?b._theme.secondary:"undefined"!=typeof b._theme.blocks&&null!==b._theme.blocks?g(b._theme.blocks[c],d):g(b._theme.complexBlocks[c],d)}},b._niceShapes=b._getNiceShapes()},_randInt:function(a,b){return a+Math.floor(Math.random()*(1+b-a))},_randSign:function(){return 2*this._randInt(0,1)-1},_randChoice:function(a){return a[this._randInt(0,a.length-1)]},_preloadThemeAssets:function(){var b=this,c=new RegExp("^#[A-F0-9+]{3,6}","i"),d=(new RegExp("^data:image/(png|gif|jpg);base64,","i"),function(){b._board&&b._board.render(!0)}),e=function(a){var b=a;return c.test(b)?a=b:(a=new Image,a.src=b,a.onload=d),a},f=function(b){if(a.isArray(b)&&b.length>0)for(var c=0;c<b.length;c++)b[c]=e(b[c]);else"string"==typeof b&&(b=e(b));return b};if("undefined"!=typeof this._theme.complexBlocks)for(var g=Object.keys(this._theme.complexBlocks),h=0;h<g.length;h++)this._theme.complexBlocks[g[h]]=f(this._theme.complexBlocks[g[h]]);else if("undefined"!=typeof this._theme.blocks)for(var g=Object.keys(this._theme.blocks),h=0;h<g.length;h++)this._theme.blocks[g[h]]=f(this._theme.blocks[g[h]]);if("undefined"!=typeof this._theme.backgroundGrid&&"string"==typeof this._theme.backgroundGrid&&!c.test(this._theme.backgroundGrid)){var i=this._theme.backgroundGrid;this._theme.backgroundGrid=new Image,this._theme.backgroundGrid.src=i,this._theme.backgroundGrid.onload=d}},_createHolder:function(){this._$gameholder=a('<div class="blockrain-game-holder"></div>'),this._$gameholder.css("position","relative").css("width","100%").css("height","100%"),this.element.html("").append(this._$gameholder),this._$canvas=a('<canvas style="display:block; width:100%; height:100%; padding:0; margin:0; border:none;" />'),"string"==typeof this._theme.background&&this._$canvas.css("background-color",this._theme.background),this._$gameholder.append(this._$canvas),this._canvas=this._$canvas.get(0),this._ctx=this._canvas.getContext("2d")},_createUI:function(){var b=this;b._$score=a('<div class="blockrain-score-holder" style="position:absolute;"><div class="blockrain-score"><div class="blockrain-score-msg">'+this.options.scoreText+'</div><div class="blockrain-score-num">0</div></div></div>').hide(),b._$scoreText=b._$score.find(".blockrain-score-num"),b._$gameholder.append(b._$score),b._$start=a('<div class="blockrain-start-holder" style="position:absolute;"><div class="blockrain-start"><a class="blockrain-btn blockrain-start-btn">'+this.options.playButtonText+"</a></div></div>").hide(),b._$gameholder.append(b._$start),b._$start.find(".blockrain-start-btn").click(function(a){a.preventDefault(),b.start()}),b._$gameover=a('<div class="blockrain-game-over-holder" style="position:absolute;"><div class="blockrain-game-over"><div class="blockrain-game-over-msg">'+this.options.gameOverText+'</div><a class="blockrain-btn blockrain-game-over-btn">'+this.options.restartButtonText+"</a></div></div>").hide(),b._$gameover.find(".blockrain-game-over-btn").click(function(a){a.preventDefault(),b.restart()}),b._$gameholder.append(b._$gameover),this._createControls()},_createControls:function(){var b=this;b._$touchLeft=a('<a class="blockrain-touch blockrain-touch-left" />').appendTo(b._$gameholder),b._$touchRight=a('<a class="blockrain-touch blockrain-touch-right" />').appendTo(b._$gameholder),b._$touchRotateRight=a('<a class="blockrain-touch blockrain-touch-rotate-right" />').appendTo(b._$gameholder),b._$touchRotateLeft=a('<a class="blockrain-touch blockrain-touch-rotate-left" />').appendTo(b._$gameholder),b._$touchDrop=a('<a class="blockrain-touch blockrain-touch-drop" />').appendTo(b._$gameholder)},_refreshBlockSizes:function(){this.options.autoBlockWidth&&(this.options.blockWidth=Math.ceil(this.element.width()/this.options.autoBlockSize))},_getNiceShapes:function(){function a(a,b,c,e,f,g,h){var i,j,k,l,m=b.length,n=0,o={};for(i=0;i<m;i+=2)n+=a[d._filled.asIndex(c+b[i],e+b[i+1])]||0;for(i=0;i<m;i+=2)j=b[i],k=b[i+1],(void 0===o[j]||o[j]<k)&&(o[j]=k);l=0;for(j in o)for(j=parseInt(j),k=o[j]+1,i=0;e+k<h;k++,i++)if(!d._filled.check(c+j,e+k)){l+=0==i?2:1;break}return n-=l}function b(){for(var a in e)e[a].x=0,e[a].y=-1}var c,d=this,e={};for(var c in this._shapeFactory)e[c]=this._shapeFactory[c]();var f=function(c,f,g,h,i,j){j||b();var k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=new Array(g*h),A="evil"==i,B=999*(A?1:-1);for(k=0;k<g;k++)for(l=0;l<=h;l++)if(l==h||c.check(k,l)){for(m=l-4;m<l;m++)z[c.asIndex(k,m)]=m;break}var C=void 0===j?e:{cur:j};for(n in C){for(o=C[n],w=-999,p=0;p<(o.symmetrical?2:4);p++)for(q=o.getBlocks(p),r=o.getBounds(q),k=-r.left;k<g-r.width;k++)for(l=-1;l<h-r.bottom;l++)if(d._checkCollisions(k,l+1,q,!0)){s=a(z,q,k,l,c,g,h),s>w&&(w=s,x=p,y=k);break}(A&&w<B||!A&&w>B)&&(t=o,B=w,u=x,v=y)}return t.best_orientation=u,t.best_x=v,t};return f.no_preview=!0,f},_randomShapes:function(){var b=[];return a.each(this._shapeFactory,function(a,c){b.push(c)}),this._randChoice(b)},_setupControls:function(b){function c(a){var b={stopKeys:{37:1,38:1,39:1,40:1}},c=b.stopKeys[a.keyCode]||b.moreStopKeys&&b.moreStopKeys[a.keyCode];return c&&a.preventDefault(),c}function d(a){return"safekeypress."+a.keyCode}function e(b){var c=d(b);return a.data(this,c,(a.data(this,c)||0)-1),k.call(this,b)}function f(b){return a.data(this,d(b),0),l.call(this,b),c(b)}var g=this,h=function(a){return a?void(g._board.holding.left||(g._board.cur.moveLeft(),g._board.holding.left=Date.now(),g._board.holding.right=null)):void(g._board.holding.left=null)},i=function(a){return a?void(g._board.holding.right||(g._board.cur.moveRight(),g._board.holding.right=Date.now(),g._board.holding.left=null)):void(g._board.holding.right=null)},j=function(a){return a?void(g._board.holding.drop||(g._board.cur.drop(),g._board.holding.drop=Date.now())):void(g._board.holding.drop=null)},k=function(a){if(!g._board.cur)return!0;var b=!1;if(b=!0,g.options.asdwKeys)switch(a.keyCode){case 65:h(!0);break;case 68:i(!0);break;case 83:j(!0);break;case 87:g._board.cur.rotate("right")}switch(a.keyCode){case 37:h(!0);break;case 39:i(!0);break;case 40:j(!0);break;case 38:g._board.cur.rotate("right");break;case 88:g._board.cur.rotate("right");break;case 90:g._board.cur.rotate("left");break;default:b=!1}return b&&a.preventDefault(),!b},l=function(a){if(!g._board.cur)return!0;var b=!1;if(b=!0,g.options.asdwKeys)switch(a.keyCode){case 65:h(!1);break;case 68:i(!1);break;case 83:j(!1)}switch(a.keyCode){case 37:h(!1);break;case 39:i(!1);break;case 40:j(!1);break;default:b=!1}return b&&a.preventDefault(),!b};a(document).unbind("keydown.blockrain").unbind("keyup.blockrain"),g.options.autoplay||b&&a(document).bind("keydown.blockrain",e).bind("keyup.blockrain",f)},_setupTouchControls:function(b){var c=this,d=function(a){a.preventDefault(),c._board.cur.moveLeft(),c._board.holding.left=Date.now(),c._board.holding.right=null,c._board.holding.drop=null},e=function(a){a.preventDefault(),c._board.cur.moveRight(),c._board.holding.right=Date.now(),c._board.holding.left=null,c._board.holding.drop=null},f=function(a){a.preventDefault(),c._board.cur.drop(),c._board.holding.drop=Date.now()},g=function(a){a.preventDefault(),c._board.holding.left=null},h=function(a){a.preventDefault(),c._board.holding.right=null},i=function(a){a.preventDefault(),c._board.holding.drop=null},j=function(a){a.preventDefault(),c._board.cur.rotate("left")},k=function(a){a.preventDefault(),c._board.cur.rotate("right")};c._$touchLeft.unbind("touchstart touchend click"),c._$touchRight.unbind("touchstart touchend click"),c._$touchRotateLeft.unbind("touchstart touchend click"),c._$touchRotateRight.unbind("touchstart touchend click"),c._$touchDrop.unbind("touchstart touchend click"),!c.options.autoplay&&b?(c._$touchLeft.show().bind("touchstart click",d).bind("touchend",g),c._$touchRight.show().bind("touchstart click",e).bind("touchend",h),c._$touchDrop.show().bind("touchstart click",f).bind("touchend",i),c._$touchRotateLeft.show().bind("touchstart click",j),c._$touchRotateRight.show().bind("touchstart click",k)):(c._$touchLeft.hide(),c._$touchRight.hide(),c._$touchRotateLeft.hide(),c._$touchRotateRight.hide(),c._$touchDrop.hide()),a("#left-arrow").bind("touchstart click",function(a){d(a),g(a)}),a("#right-arrow").bind("touchstart click",function(a){e(a),h(a)}),a("#up-arrow").bind("touchstart click",k),a("#down-arrow").bind("touchstart click",function(a){f(a),i(a)})}})}(jQuery);