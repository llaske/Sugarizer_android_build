/*! Sugarizer 2019-09-21 */
define(["activity/ol","util","print","l10n/l10n"],function(a,b,c,d){var e={};e.popup=document.createElement("div"),e.popup.id="popup",e.test=function(){return"ColorMyWorld"},e.currents=[],e.collective_bbox=[],e.current_feature=null,e.last_timeout=null,e.mode=COLORING,e.DELAY=1500,e.RUNNING=!1,e.saveStateCB=function(){c("saveStateCB");var a={};return a.currents=e.currents,a.lang=document.webL10n.getLanguage(),a.mode=e.mode,a.cmw_bg=e.background_color,a.features=e.loopOverAllFeatures("get",{}),JSON.stringify(a)},e.loopOverAllFeatures=function(b,d){c("loopOverAllFeatures:"+b),c("loopOverAllFeatures:"+d);for(var f=e.CATEGORIES.keys,g=0;g<f.length;g++)for(var h=f[g],i=e.CATEGORIES[h].keys,j=0;j<i.length;j++){var k=i[j];c("loopOverAllFeatures.layer_names: "+k);var l=e.CATEGORIES[h][k].source.getFeatures();c("features: "+l),c("features.length: "+l.length);for(var m=0;m<l.length;m++){var n=null;if(n=l[m].get("Name"),n||(n=l[m].get("NAME")),n||(n=l[m].get("name")),c("loopOverAllFeatures.features: "+n),"get"==b){c("GET "+n);var o=e.CATEGORIES[h][k].features[n];INSTALLED[h].polygon_sources[0].fill;d[n]={candidate:o.candidate,stroke_color:INSTALLED[h].polygon_sources[0].color,stroke_width:INSTALLED[h].polygon_sources[0].width,fill_color:INSTALLED[h].polygon_sources[0].fill},o.feature.getStyle()&&(c(n+" stroke_color="+o.feature.getStyle().getStroke().getColor()),c(n+" stroke_width="+o.feature.getStyle().getStroke().getWidth()),c(n+" fill_color="+o.feature.getStyle().getFill().getColor()),d[n].stroke_color=o.feature.getStyle().getStroke().getColor(),d[n].stroke_width=o.feature.getStyle().getStroke().getWidth(),d[n].fill_color=o.feature.getStyle().getFill().getColor())}else if("set"==b){c("SET "+n);var o=d[n];e.CATEGORIES[h][k].features[n].candidate=o.candidate;var p=new a.style.Style({fill:new a.style.Fill({color:o.fill_color}),stroke:new a.style.Stroke({color:o.stroke_color,width:o.stroke_width})});e.CATEGORIES[h][k].features[n].feature.setStyle(p)}}}return d},e.sleep=function(a){return new Promise(function(b){setTimeout(b,a)})},e.loadStateCB=function(a){c("loadStateCB");var b=null;if(null!=a&&(b=JSON.parse(a)),b){c("Loading: "+b),e.currents=b.currents;for(var d=0;d<b.currents.length;d++)e.change_areaCB(1,b.currents[d]);var f=e.getRegion();document.getElementById("regionlabel").src=REGION_ICONS[f],e.mode=b.mode;var h=e.getMode();document.getElementById("modelabel").innerHTML=MODE_NAMES[h],document.webL10n.setLanguage(b.lang);var i=LANGUAGE_NAMES.keys.indexOf(b.lang);document.getElementById("languagelabel").innerHTML=-1!=i?LANGUAGE_NAMES[LANGUAGE_NAMES.keys[i]]:"English",e.set_background(b.cmw_bg),c("sleeping 2000"),e.sleep(2e3).then(function(){c("continuing"),g=e.loopOverAllFeatures("set",b.features),e.updateTitle()})}},e.mkBrightRGBA=function(){var a=parseInt(255*Math.random()),b=parseInt(255*Math.random()),c=parseInt(255*Math.random());if(a+b+c<300){var d=parseInt(3*Math.random());0==d?c=255:1==d?a=255:2==d&&(b=255)}return"RGBA("+a+","+b+","+c+",255)"},e.updateTitle=function(){var a=document.webL10n.get("appname"),c=a.split(""),d=document.getElementById("persistent_title_div");html="";for(var f=0;f<c.length;f++){var g=e.mkBrightRGBA();html+="<span style='text-shadow:none;font-family:Mickey;color:"+g+";'>"+c[f]+"</span>"}d.innerHTML=html,b.resize()},e.setMode=function(a){e.mode=a},e.getMode=function(){return e.mode},e.getRegion=function(){return REGION_NAMES.indexOf(e.currents[0])},e.background_color="rgb(0,120,255)",e.rgbColorString="rgb(255,255,255)",e.setRGBColorString=function(a){e.rgbColorString=a},e.getRGBColorString=function(){return e.rgbColorString},e.set_background=function(a){e.background_color=a||e.getRGBColorString(),document.getElementById("cmw_bg").style.backgroundColor=e.background_color},e.getRunning=function(){return e.RUNNING},e.BASE_SOURCES={OpenStreetMap2:new a.source.OSM},e.CATEGORIES={keys:[],"Base Layers":{keys:["OpenStreetMap2"],OpenStreetMap2:{type:"tile",api:"ol.layer.Tile",layer:new a.layer.Tile({preload:14,opacity:1,title:"OpenStreetMap2",source:e.BASE_SOURCES.OpenStreetMap2}),source:e.BASE_SOURCES.OpenStreetMap2,feature_names:[],style:null,colors:{},toggle:!1}}},e.resize=function(){c("resize");var a=window.innerWidth,d=window.innerHeight,f=b.computeResolution(e.collective_bbox,!1,a,d);window.map.getView().setResolution(f)},e.get_enabled_candidates=function(){c("get_enabled_candidates");for(var a="",b="",d=e.CATEGORIES.keys,g=0;g<d.length;g++){var a=d[g];c("checking "+a);var h=e.CATEGORIES[a].keys;c("layer_names="+h+" "+typeof h);for(var i=0;i<h.length;i++){var b=h[i];c("checking "+a+"."+b)}}for(var j=[],k=0;k<e.CATEGORIES[a][b].feature_names.length;k++)e.CATEGORIES[a][b].features[e.CATEGORIES[a][b].feature_names[k]].candidate&&j.push(e.CATEGORIES[a][b].feature_names[k]);if(j.length>0){var k=parseInt(Math.random()*j.length);return f=e.CATEGORIES[a][b].features[j[k]],[{category:a,layer_key:b,feature_name:j[k]}]}return[]},e.reinit_candidates=function(){c("reinit_candidates");for(var a=e.CATEGORIES.keys,b=0;b<a.length;b++)for(var d=a[b],f=e.CATEGORIES[d].keys,g=0;g<f.length;g++){var h=f[g];if(e.CATEGORIES[d][h].toggle)for(var i=e.CATEGORIES[d][h].feature_names,j=0;j<i.length;j++){var k=i[j];e.CATEGORIES[d][h].features[k].candidate=!0}}},e.change_areaCB=function(b,d){if(c("change_areaCB"),"OpenStreetMap2"==d&&1==b)return void window.map.getLayers().insertAt(0,e.CATEGORIES["Base Layers"].OpenStreetMap2.layer);if("OpenStreetMap2"==d&&0==b)return void window.map.removeLayer(e.CATEGORIES["Base Layers"].OpenStreetMap2.layer);1==e.RUNNING&&e.toggleRunning(),e.currents=[d],c("me.currents="+e.currents);for(var f=0;f<e.CATEGORIES.keys.length;f++){k=e.CATEGORIES.keys[f];for(var g=0;g<e.CATEGORIES[k].keys.length;g++){var h=e.CATEGORIES[k].keys[g];c("removing layer: "+h),window.map.removeLayer(e.CATEGORIES[k][h].layer),delete e.CATEGORIES[k][h],c("removing "+k+" BOUNDARY"),window.map.removeLayer(e.CATEGORIES[k].BOUNDARY.layer),delete e.CATEGORIES[k].BOUNDARY.layer}delete e.CATEGORIES[k]}e.CATEGORIES.keys=[];try{for(var f=0;f<e.currents.length;f++)c("Removing layer: BOUNDARY"),window.map.removeLayer(e.CATEGORIES[e.currents[f]].BOUNDARY.layer),delete e.CATEGORIES[e.currents[f]].BOUNDARY}catch(a){}e.prepare_layers();c("Adding BOUNDARY layers");for(var f=0;f<e.currents.length;f++)window.map.addLayer(e.CATEGORIES[e.currents[f]].BOUNDARY.layer);for(var i=e.CATEGORIES.keys,j=0;j<i.length;j++){var k=i[j];c("Adding "+e.CATEGORIES[k].keys.length);for(var l=e.CATEGORIES[k].keys,g=0;g<l.length;g++){var h=l[g];c("Adding layer: "+h),window.map.addLayer(e.CATEGORIES[k][h].layer)}}for(var m=200,n=200,o=-200,p=-200,f=0;f<e.currents.length;f++){var q=INSTALLED[e.currents[f]].bbox;q[0]<m&&(m=q[0]),q[1]<n&&(n=q[1]),q[2]>o&&(o=q[2]),q[3]>p&&(p=q[3])}var r=[(m+o)/2,(n+p)/2];e.collective_bbox=[m,n,o,p],window.map.getView().setCenter(a.proj.transform(r,"EPSG:4326","EPSG:3857")),e.resize(),e.currents[0],c("setting timeout to 2000"),window.setTimeout(e.fill_all_features,2e3,!1)},e.fill_all_features=function(){c("fill_all_features");for(var a=e.CATEGORIES.keys,b=0;b<a.length;b++)for(var d=a[b],f=e.CATEGORIES[d].keys,g=0;g<f.length;g++){var h=f[g],i=e.CATEGORIES[d][h].source.getFeatures();if(c("features.length="+i.length),0==i.length)return c("calling self recursively by timeout"),void window.setTimeout(e.fill_all_features,2e3,!1);for(var j=0;j<i.length;j++){var k=null;k=i[j].get("Name"),k||(k=i[j].get("NAME")),k||(k=i[j].get("name")),c(k),e.CATEGORIES[d][h].features[k]={feature:i[j],candidate:!0,color:"rgb(0,0,0)"},e.CATEGORIES[d][h].feature_names.push(k)}}},e.prepare_layers=function(){c("me.prepare_layers: "+e.currents),e.LAYERS={keys:[]};for(var b=0;b<e.currents.length;b++)for(var d=0;d<INSTALLED[e.currents[b]].polygon_sources.length;d++){var f=INSTALLED[e.currents[b]].path+INSTALLED[e.currents[b]].polygon_sources[d].filename,g=new a.source.Vector({url:f,format:new a.format.GeoJSON}),h=new a.layer.Vector({updateWhileAnimating:!0,source:g,style:new a.style.Style({stroke:new a.style.Stroke({color:INSTALLED[e.currents[b]].polygon_sources[d].color,width:INSTALLED[e.currents[b]].polygon_sources[d].width}),fill:new a.style.Fill({color:INSTALLED[e.currents[b]].polygon_sources[d].fill})})});h.set("type","Polygon");var i=INSTALLED[e.currents[b]].polygon_sources[d].category,j=INSTALLED[e.currents[b]].polygon_sources[d].layer_name;h.set("layer_name",j),e.CATEGORIES.keys.indexOf(i)<0&&(c("new category: "+i),e.CATEGORIES.keys.push(i),e.CATEGORIES[i]={keys:[]}),e.CATEGORIES[i].keys.push(j),e.CATEGORIES[i][j]={layer:h,source:g,feature_names:[],features_off:[],features:g.getFeatures(),style:null,colors:{},toggle:!0,type:"Polygon"}}for(var b=0;b<e.currents.length;b++){var k=new a.source.Vector({url:INSTALLED[e.currents[b]].path+"boundary.geojson",format:new a.format.GeoJSON}),l=new a.layer.Vector({source:k,style:new a.style.Style({stroke:new a.style.Stroke({color:INSTALLED[e.currents[b]].color,width:INSTALLED[e.currents[b]].width}),fill:new a.style.Fill({color:INSTALLED[e.currents[b]].fill})})});e.CATEGORIES[e.currents[b]].BOUNDARY={api:"ol.layer.Vector",layer:l,source:k,feature_names:[],features_off:[],features:{},style:null,colors:{},toggle:!0,type:"Polygon"}}return c("prepare_layers done"),1},e.setRunning=function(a){e.RUNNING=a},e.toggleRunning=function(){e.mode==COLORING&&(e.setMode(TOUR),document.getElementById("modelabel").innerHTML=document.webL10n.get(MODE_NAMES[e.mode])),1==e.RUNNING?(c("stopMove"),e.setRunning(!1),$("#run-button").toggleClass("running"),$("#run-button").title="Play"):(c("startMove"),e.setRunning(!0),e.startMove(),$("#run-button").toggleClass("running"),$("#run-button").title="Pause")},e.startMove=function(a){if(0!=e.RUNNING){c("startMove");try{window.clearTimeout(e.last_timeout)}catch(a){c(a)}if(a)c("me.startMove with feature passed");else{var d=e.get_enabled_candidates();if(0==d.length)return c("returning me.end_game()"),e.end_game();c("me.startMove no feature passed so selecting");var f=parseInt(Math.random()*d.length);c("cycling ridx="+f.toString()+"/"+d.length);for(var g=[],h=0;h<d.length;h++)g.push(d[h].feature_name);c("candidates="+g);for(var i=0;i<f;i++)d.push(d.shift());c("shifting me.current_feature"),e.current_feature=d.shift()}var j=null;j=e.current_feature.feature_name;var k=document.webL10n.get(e.current_feature.layer_key),l="<center><h3>Next:</h3><h1>"+document.webL10n.get(j.replace(/ /g,"_")).replace(/_/g," ")+"</h1><h3>"+k+"</h3></center>";e.mode==TOUR?l="<center><h3>"+b.descore(document.webL10n.get(b.enscore("Next")))+":</h3><h1>"+b.descore(document.webL10n.get(b.enscore(j)))+"</h1><h3>"+k+"</h3></center>":e.mode==INTERACTIVE&&(l="<center><h3>"+b.descore(document.webL10n.get(b.enscore("Find")))+":</h3><h1>"+b.descore(document.webL10n.get(b.enscore(j)))+"</h1><h3>"+k+"</h3></center>"),c("me.startMove:"+j+" "+k),e.showPopup(l)}},e.showPopup=function(a){for(;e.popup.childNodes.length>0;)try{e.popup.removeChild(e.popup.childNodes[0])}catch(a){c(a)}e.popup.innerHTML="";var b=document.createElement("div");if(b.classname="info_div",b.innerHTML=a,e.popup.appendChild(b),e.current_feature){target_name=e.current_feature.feature_name,c("ADD IMAGE HERE:"+target_name);var d=new Image;d.src="country_img/"+target_name+".png",d.onload=function(){var a=d.width,b=d.height;c("iW="+a),c("iH="+b),a>b?(c("iW>iH"),d.style.width="270px",d.style.height=parseInt(270*b/a)+"px"):(c("iW<iH"),d.style.height="270px",d.style.width=parseInt(270*a/b)+"px"),e.popup.appendChild(d),e.popup.style.left=window.innerWidth/2-150+"px",e.popup.style.top=window.innerHeight/2-200+"px",e.popup.style.width="300px",e.popup.style.opacity=0,document.body.appendChild(e.popup),$("#popup").animate({opacity:1},e.DELAY,function(){e.last_timeout=window.setTimeout(e.popdown,1*e.DELAY)})}}else e.popup.style.left=window.innerWidth/2-150+"px",e.popup.style.top=window.innerHeight/2-200+"px",e.popup.style.width="300px",e.popup.style.opacity=0,document.body.appendChild(e.popup),$("#popup").animate({opacity:1},e.DELAY,function(){e.last_timeout=window.setTimeout(e.popdown,1*e.DELAY)})},e.popdown=function(a){c("popdown");try{window.clearTimeout(e.last_timeout)}catch(a){}$("#popup").animate({opacity:0},e.DELAY,function(){try{document.body.removeChild(e.popup)}catch(a){}if(e.mode==TOUR&&null!=e.current_feature){var a=e.current_feature,b=a.category,c=a.layer_key,d=a.feature_name,f=e.CATEGORIES[b][c].features[d].feature.getGeometry().getExtent(),g=[(f[0]+f[2])/2,(f[1]+f[3])/2];e.pan_zoom(g)}e.mode==TOUR&&null==e.current_feature&&e.toggleRunning()})},e.end_game=function(){try{document.body.removeChild(e.popup)}catch(a){c("me.end_game")}var a="<center><h1>Congratulations!<br>You Finished!</h1></center>";"en-us"!=document.webL10n.getLanguage()&&(a="<center><h1>"+b.descore(document.webL10n.get("Congratulations"))+"!<br>",a+=b.descore(document.webL10n.get("You_Finished"))+"!</h1></center>"),c(a),e.toggleRunning(),e.setMode(COLORING),e.reinit_candidates(),document.getElementById("modelabel").innerHTML=document.webL10n.get(MODE_NAMES[e.mode]),e.showPopup(a)},e.random_styles=[];for(var g=0;g<NUM_COLORS;g++){var h=new a.style.Style({fill:new a.style.Fill({color:e.mkBrightRGBA()}),stroke:new a.style.Stroke({color:DEFAULT_STROKE,width:1})});e.random_styles.push(h)}return e.check_feature=function(a){if(!e.current_feature)return void c("check_feature: No Current Feature ... returning");c("check_feature:"+e.current_feature.feature_name),c("me.check_feature clearing last_timeout"),window.clearTimeout(e.last_timeout);var d,f=[],h=!1;if(a||e.mode!=TOUR)g=window.map.forEachFeatureAtPixel(a,function(a,b){var d=null;d=a.get("NAME"),d||(d=a.get("Name")),d||(d=a.get("name")),c("returning: "+d),f.push(a)});else{var i=e.current_feature.category,j=e.current_feature.layer_key,k=e.current_feature.feature_name;f.push(e.CATEGORIES[i][j].features[k].feature)}if(c("features.length="+f.length),f.length>0&&!h){for(var l=0;l<f.length;l++){d=f[l];var i=e.current_feature.category,m=null;if(m=e.current_feature.feature_name,target_layer=e.current_feature.layer_key,c(l.toString()+" "+target_layer+"."+m),target_feature=e.CATEGORIES[i][target_layer].features[m].feature,d==target_feature){if(c("***** Correct! *****"),"Point"==e.CATEGORIES[i][target_layer].type)d.setStyle(b.point_correct_style);else{var n=parseInt(Math.random()*e.random_styles.length);d.setStyle(e.random_styles[n])}return h=!0,e.CATEGORIES[i][e.current_feature.layer_key].features[m].candidate=!1,e.current_feature=null,void(e.mode==TOUR?(c("check_feature setting timeout for pan_zoom_home"),e.last_timeout=window.setTimeout(e.pan_zoom_home,2*e.DELAY)):window.setTimeout(e.startMove,2*e.DELAY))}var k=null;k=d.get("NAME"),k||(k=d.get("Name")),k||(k=d.get("name")),c(k+" != "+target_feature.toString())}c("starting move passing feature: "+m),e.startMove(d)}else c("game over")},e.flyTo=function(a,b,c){function d(a){--i,j||0!==i&&a||(j=!0,c(a))}var f=window.map.getView(),g=e.DELAY,h=(f.getZoom(),f.getResolution()),i=2,j=!1;f.animate({center:a,duration:g},d),h>b?f.animate({resolution:1.05*h,duration:.25*g},{resolution:b,duration:.75*g},d):f.animate({resolution:1.05*b,duration:.75*g},{resolution:b,duration:.25*g},d)},e.pan_zoom=function(a){c("pan_zoom: "+a);var d=2*e.DELAY,f=e.current_feature,g=f.category,h=f.layer_key,i=f.feature_name,j=e.CATEGORIES[g][h].features[i].feature.getGeometry().getExtent(),k=b.computeResolution(j,!0,window.innerWidth,window.innerHeight);if(k*=1.2,0==k&&(k=100),e.flyTo(a,k,function(){}),null!=e.current_feature){try{window.clearTimeout(e.last_timeout)}catch(a){c(a)}c("pan_zoom setting timeout for check_feature"),e.last_timeout=window.setTimeout(e.check_feature,d)}else{try{window.clearTimeout(e.last_timeout)}catch(a){c(a)}c("pan_zoom calling start_move directly"),e.start_move(null)}},e.pan_zoom_home=function(){c("bounce_home");var d=(e.DELAY,window.innerWidth),f=window.innerHeight,g=e.collective_bbox,h=b.computeResolution(g,!1,d,f),i=a.proj.transform([(g[0]+g[2])/2,(g[1]+g[3])/2],"EPSG:4326","EPSG:3857");e.flyTo(i,h,function(){});try{window.clearTimeout(e.last_timeout)}catch(a){c(a)}c("pan_zoom_home setting timeout for start_move"),e.last_timeout=window.setTimeout(e.startMove,e.delay)},window.colormyworld=e,e});