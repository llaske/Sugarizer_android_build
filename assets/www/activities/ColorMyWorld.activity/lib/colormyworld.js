define(["activity/ol","util","print","l10n/l10n"],(function(e,t,r,n){var o={};o.popup=document.createElement("div"),o.popup.id="popup",o.test=function(){return"ColorMyWorld"},o.currents=[],o.collective_bbox=[],o.current_feature=null,o.last_timeout=null,o.mode=COLORING,o.DELAY=1500,o.RUNNING=!1,o.saveStateCB=function(){r("saveStateCB");var e={};return e.currents=o.currents,e.lang=document.webL10n.getLanguage(),e.mode=o.mode,e.cmw_bg=o.background_color,e.features=o.loopOverAllFeatures("get",{}),JSON.stringify(e)},o.loopOverAllFeatures=function(t,n){r("loopOverAllFeatures:"+t),r("loopOverAllFeatures:"+n);for(var a=o.CATEGORIES.keys,l=0;l<a.length;l++)for(var u=a[l],i=o.CATEGORIES[u].keys,s=0;s<i.length;s++){var c=i[s];r("loopOverAllFeatures.layer_names: "+c);var g=o.CATEGORIES[u][c].source.getFeatures();r("features: "+g),r("features.length: "+g.length);for(var d=0;d<g.length;d++){var p=null;if((p=g[d].get("Name"))||(p=g[d].get("NAME")),p||(p=g[d].get("name")),r("loopOverAllFeatures.features: "+p),"get"==t){r("GET "+p);var f=o.CATEGORIES[u][c].features[p];INSTALLED[u].polygon_sources[0].fill;n[p]={candidate:f.candidate,stroke_color:INSTALLED[u].polygon_sources[0].color,stroke_width:INSTALLED[u].polygon_sources[0].width,fill_color:INSTALLED[u].polygon_sources[0].fill},f.feature.getStyle()&&(r(p+" stroke_color="+f.feature.getStyle().getStroke().getColor()),r(p+" stroke_width="+f.feature.getStyle().getStroke().getWidth()),r(p+" fill_color="+f.feature.getStyle().getFill().getColor()),n[p].stroke_color=f.feature.getStyle().getStroke().getColor(),n[p].stroke_width=f.feature.getStyle().getStroke().getWidth(),n[p].fill_color=f.feature.getStyle().getFill().getColor())}else if("set"==t){r("SET "+p);f=n[p];o.CATEGORIES[u][c].features[p].candidate=f.candidate;var m=new e.style.Style({fill:new e.style.Fill({color:f.fill_color}),stroke:new e.style.Stroke({color:f.stroke_color,width:f.stroke_width})});o.CATEGORIES[u][c].features[p].feature.setStyle(m)}}}return n},o.sleep=function(e){return new Promise((function(t){setTimeout(t,e)}))},o.loadStateCB=function(e){r("loadStateCB");var t=null;if(null!=e&&(t=JSON.parse(e)),t){r("Loading: "+t),o.currents=t.currents;for(var n=0;n<t.currents.length;n++)o.change_areaCB(1,t.currents[n]);var l=o.getRegion();document.getElementById("regionlabel").src=REGION_ICONS[l],o.mode=t.mode;var u=o.getMode();document.getElementById("modelabel").innerHTML=MODE_NAMES[u],o.set_background(t.cmw_bg),r("sleeping 2000"),o.sleep(2e3).then((function(){r("continuing"),a=o.loopOverAllFeatures("set",t.features),o.updateTitle()}))}},o.mkBrightRGBA=function(){var e=parseInt(255*Math.random()),t=parseInt(255*Math.random()),r=parseInt(255*Math.random());if(e+t+r<300){var n=parseInt(3*Math.random());0==n?r=255:1==n?e=255:2==n&&(t=255)}return"RGBA("+e+","+t+","+r+",255)"},o.updateTitle=function(){var e=document.webL10n.get("appname").split(""),r=document.getElementById("persistent_title_div");html="";for(var n=0;n<e.length;n++){var a=o.mkBrightRGBA();html+="<span style='text-shadow:none;font-family:Mickey;color:"+a+";'>"+e[n]+"</span>"}r.innerHTML=html,t.resize()},o.setMode=function(e){o.mode=e},o.getMode=function(){return o.mode},o.getRegion=function(){return REGION_NAMES.indexOf(o.currents[0])},o.background_color="rgb(0,120,255)",o.rgbColorString="rgb(255,255,255)",o.setRGBColorString=function(e){o.rgbColorString=e},o.getRGBColorString=function(){return o.rgbColorString},o.set_background=function(e){o.background_color=e||o.getRGBColorString(),document.getElementById("cmw_bg").style.backgroundColor=o.background_color},o.getRunning=function(){return o.RUNNING},o.BASE_SOURCES={OpenStreetMap2:new e.source.OSM},o.CATEGORIES={keys:[],"Base Layers":{keys:["OpenStreetMap2"],OpenStreetMap2:{type:"tile",api:"ol.layer.Tile",layer:new e.layer.Tile({preload:14,opacity:1,title:"OpenStreetMap2",source:o.BASE_SOURCES.OpenStreetMap2}),source:o.BASE_SOURCES.OpenStreetMap2,feature_names:[],style:null,colors:{},toggle:!1}}},o.resize=function(){r("resize");var e=window.innerWidth,n=window.innerHeight,a=t.computeResolution(o.collective_bbox,!1,e,n);window.map.getView().setResolution(a)},o.get_enabled_candidates=function(){r("get_enabled_candidates");for(var e="",t="",n=o.CATEGORIES.keys,a=0;a<n.length;a++){e=n[a];r("checking "+e);var l=o.CATEGORIES[e].keys;r("layer_names="+l+" "+typeof l);for(var u=0;u<l.length;u++){t=l[u];r("checking "+e+"."+t)}}for(var i=[],s=0;s<o.CATEGORIES[e][t].feature_names.length;s++)o.CATEGORIES[e][t].features[o.CATEGORIES[e][t].feature_names[s]].candidate&&i.push(o.CATEGORIES[e][t].feature_names[s]);if(i.length>0){s=parseInt(Math.random()*i.length);return f=o.CATEGORIES[e][t].features[i[s]],[{category:e,layer_key:t,feature_name:i[s]}]}return[]},o.reinit_candidates=function(){r("reinit_candidates");for(var e=o.CATEGORIES.keys,t=0;t<e.length;t++)for(var n=e[t],a=o.CATEGORIES[n].keys,l=0;l<a.length;l++){var u=a[l];if(o.CATEGORIES[n][u].toggle)for(var i=o.CATEGORIES[n][u].feature_names,s=0;s<i.length;s++){var c=i[s];o.CATEGORIES[n][u].features[c].candidate=!0}}},o.change_areaCB=function(t,n){if(r("change_areaCB"),"OpenStreetMap2"!=n||1!=t)if("OpenStreetMap2"!=n||0!=t){1==o.RUNNING&&o.toggleRunning(),o.currents=[n],r("me.currents="+o.currents);for(var a=0;a<o.CATEGORIES.keys.length;a++){c=o.CATEGORIES.keys[a];for(var l=0;l<o.CATEGORIES[c].keys.length;l++){var u=o.CATEGORIES[c].keys[l];r("removing layer: "+u),window.map.removeLayer(o.CATEGORIES[c][u].layer),delete o.CATEGORIES[c][u],r("removing "+c+" BOUNDARY"),window.map.removeLayer(o.CATEGORIES[c].BOUNDARY.layer),delete o.CATEGORIES[c].BOUNDARY.layer}delete o.CATEGORIES[c]}o.CATEGORIES.keys=[];try{for(a=0;a<o.currents.length;a++)r("Removing layer: BOUNDARY"),window.map.removeLayer(o.CATEGORIES[o.currents[a]].BOUNDARY.layer),delete o.CATEGORIES[o.currents[a]].BOUNDARY}catch(e){}o.prepare_layers();r("Adding BOUNDARY layers");for(a=0;a<o.currents.length;a++)window.map.addLayer(o.CATEGORIES[o.currents[a]].BOUNDARY.layer);for(var i=o.CATEGORIES.keys,s=0;s<i.length;s++){var c=i[s];r("Adding "+o.CATEGORIES[c].keys.length);var g=o.CATEGORIES[c].keys;for(l=0;l<g.length;l++){u=g[l];r("Adding layer: "+u),window.map.addLayer(o.CATEGORIES[c][u].layer)}}var d=200,p=200,f=-200,m=-200;for(a=0;a<o.currents.length;a++){var y=INSTALLED[o.currents[a]].bbox;y[0]<d&&(d=y[0]),y[1]<p&&(p=y[1]),y[2]>f&&(f=y[2]),y[3]>m&&(m=y[3])}var _=[(d+f)/2,(p+m)/2];o.collective_bbox=[d,p,f,m],window.map.getView().setCenter(e.proj.transform(_,"EPSG:4326","EPSG:3857")),o.resize(),o.currents[0],r("setting timeout to 2000"),window.setTimeout(o.fill_all_features,2e3,!1)}else window.map.removeLayer(o.CATEGORIES["Base Layers"].OpenStreetMap2.layer);else window.map.getLayers().insertAt(0,o.CATEGORIES["Base Layers"].OpenStreetMap2.layer)},o.fill_all_features=function(){r("fill_all_features");for(var e=o.CATEGORIES.keys,t=0;t<e.length;t++)for(var n=e[t],a=o.CATEGORIES[n].keys,l=0;l<a.length;l++){var u=a[l],i=o.CATEGORIES[n][u].source.getFeatures();if(r("features.length="+i.length),0==i.length)return r("calling self recursively by timeout"),void window.setTimeout(o.fill_all_features,2e3,!1);for(var s=0;s<i.length;s++){var c=null;(c=i[s].get("Name"))||(c=i[s].get("NAME")),c||(c=i[s].get("name")),r(c),o.CATEGORIES[n][u].features[c]={feature:i[s],candidate:!0,color:"rgb(0,0,0)"},o.CATEGORIES[n][u].feature_names.push(c)}}},o.prepare_layers=function(){r("me.prepare_layers: "+o.currents),o.LAYERS={keys:[]};for(var t=0;t<o.currents.length;t++)for(var n=0;n<INSTALLED[o.currents[t]].polygon_sources.length;n++){var a=INSTALLED[o.currents[t]].path+INSTALLED[o.currents[t]].polygon_sources[n].filename,l=new e.source.Vector({url:a,format:new e.format.GeoJSON}),u=new e.layer.Vector({updateWhileAnimating:!0,source:l,style:new e.style.Style({stroke:new e.style.Stroke({color:INSTALLED[o.currents[t]].polygon_sources[n].color,width:INSTALLED[o.currents[t]].polygon_sources[n].width}),fill:new e.style.Fill({color:INSTALLED[o.currents[t]].polygon_sources[n].fill})})});u.set("type","Polygon");var i=INSTALLED[o.currents[t]].polygon_sources[n].category,s=INSTALLED[o.currents[t]].polygon_sources[n].layer_name;u.set("layer_name",s),o.CATEGORIES.keys.indexOf(i)<0&&(r("new category: "+i),o.CATEGORIES.keys.push(i),o.CATEGORIES[i]={keys:[]}),o.CATEGORIES[i].keys.push(s),o.CATEGORIES[i][s]={layer:u,source:l,feature_names:[],features_off:[],features:l.getFeatures(),style:null,colors:{},toggle:!0,type:"Polygon"}}for(t=0;t<o.currents.length;t++){var c=new e.source.Vector({url:INSTALLED[o.currents[t]].path+"boundary.geojson",format:new e.format.GeoJSON}),g=new e.layer.Vector({source:c,style:new e.style.Style({stroke:new e.style.Stroke({color:INSTALLED[o.currents[t]].color,width:INSTALLED[o.currents[t]].width}),fill:new e.style.Fill({color:INSTALLED[o.currents[t]].fill})})});o.CATEGORIES[o.currents[t]].BOUNDARY={api:"ol.layer.Vector",layer:g,source:c,feature_names:[],features_off:[],features:{},style:null,colors:{},toggle:!0,type:"Polygon"}}return r("prepare_layers done"),1},o.setRunning=function(e){o.RUNNING=e},o.toggleRunning=function(){o.mode==COLORING&&(o.setMode(TOUR),document.getElementById("modelabel").innerHTML=document.webL10n.get(MODE_NAMES[o.mode])),1==o.RUNNING?(r("stopMove"),o.setRunning(!1),$("#run-button").toggleClass("running"),$("#run-button").title="Play"):(r("startMove"),o.setRunning(!0),o.startMove(),$("#run-button").toggleClass("running"),$("#run-button").title="Pause")},o.startMove=function(e){if(0!=o.RUNNING){r("startMove");try{window.clearTimeout(o.last_timeout)}catch(e){r(e)}if(e)r("me.startMove with feature passed");else{var n=o.get_enabled_candidates();if(0==n.length)return r("returning me.end_game()"),o.end_game();r("me.startMove no feature passed so selecting");var a=parseInt(Math.random()*n.length);r("cycling ridx="+a.toString()+"/"+n.length);for(var l=[],u=0;u<n.length;u++)l.push(n[u].feature_name);r("candidates="+l);for(var i=0;i<a;i++)n.push(n.shift());r("shifting me.current_feature"),o.current_feature=n.shift()}var s=null;s=o.current_feature.feature_name;var c=document.webL10n.get(o.current_feature.layer_key),g="<center><h3>Next:</h3><h1>"+document.webL10n.get(s.replace(/ /g,"_")).replace(/_/g," ")+"</h1><h3>"+c+"</h3></center>";o.mode==TOUR?g="<center><h3>"+t.descore(document.webL10n.get(t.enscore("Next")))+":</h3><h1>"+t.descore(document.webL10n.get(t.enscore(s)))+"</h1><h3>"+c+"</h3></center>":o.mode==INTERACTIVE&&(g="<center><h3>"+t.descore(document.webL10n.get(t.enscore("Find")))+":</h3><h1>"+t.descore(document.webL10n.get(t.enscore(s)))+"</h1><h3>"+c+"</h3></center>"),r("me.startMove:"+s+" "+c),o.showPopup(g)}},o.showPopup=function(e){for(;o.popup.childNodes.length>0;)try{o.popup.removeChild(o.popup.childNodes[0])}catch(e){r(e)}o.popup.innerHTML="";var t=document.createElement("div");if(t.classname="info_div",t.innerHTML=e,o.popup.appendChild(t),o.current_feature){target_name=o.current_feature.feature_name,r("ADD IMAGE HERE:"+target_name);var n=new Image;n.src="country_img/"+target_name+".png",n.onload=function(){var e=n.width,t=n.height;r("iW="+e),r("iH="+t),e>t?(r("iW>iH"),n.style.width="270px",n.style.height=parseInt(270*t/e)+"px"):(r("iW<iH"),n.style.height="270px",n.style.width=parseInt(270*e/t)+"px"),o.popup.appendChild(n),o.popup.style.left=window.innerWidth/2-150+"px",o.popup.style.top=window.innerHeight/2-200+"px",o.popup.style.width="300px",o.popup.style.opacity=0,document.body.appendChild(o.popup),$("#popup").animate({opacity:1},o.DELAY,(function(){o.last_timeout=window.setTimeout(o.popdown,1*o.DELAY)}))}}else o.popup.style.left=window.innerWidth/2-150+"px",o.popup.style.top=window.innerHeight/2-200+"px",o.popup.style.width="300px",o.popup.style.opacity=0,document.body.appendChild(o.popup),$("#popup").animate({opacity:1},o.DELAY,(function(){o.last_timeout=window.setTimeout(o.popdown,1*o.DELAY)}))},o.popdown=function(e){r("popdown");try{window.clearTimeout(o.last_timeout)}catch(e){}$("#popup").animate({opacity:0},o.DELAY,(function(){try{document.body.removeChild(o.popup)}catch(e){}if(o.mode==TOUR&&null!=o.current_feature){var e=o.current_feature,t=e.category,r=e.layer_key,n=e.feature_name,a=o.CATEGORIES[t][r].features[n].feature.getGeometry().getExtent(),l=[(a[0]+a[2])/2,(a[1]+a[3])/2];o.pan_zoom(l)}o.mode==TOUR&&null==o.current_feature&&o.toggleRunning()}))},o.end_game=function(){try{document.body.removeChild(o.popup)}catch(e){r("me.end_game")}var e="<center><h1>Congratulations!<br>You Finished!</h1></center>";"en-us"!=document.webL10n.getLanguage()&&(e="<center><h1>"+t.descore(document.webL10n.get("Congratulations"))+"!<br>",e+=t.descore(document.webL10n.get("You_Finished"))+"!</h1></center>"),r(e),o.toggleRunning(),o.setMode(COLORING),o.reinit_candidates(),document.getElementById("modelabel").innerHTML=document.webL10n.get(MODE_NAMES[o.mode]),o.showPopup(e)},o.random_styles=[];for(var a=0;a<NUM_COLORS;a++){var l=new e.style.Style({fill:new e.style.Fill({color:o.mkBrightRGBA()}),stroke:new e.style.Stroke({color:DEFAULT_STROKE,width:1})});o.random_styles.push(l)}return o.check_feature=function(e){if(o.current_feature){var n;r("check_feature:"+o.current_feature.feature_name),r("me.check_feature clearing last_timeout"),window.clearTimeout(o.last_timeout);var l=[],u=!1;if(e||o.mode!=TOUR)a=window.map.forEachFeatureAtPixel(e,(function(e,t){var n=null;(n=e.get("NAME"))||(n=e.get("Name")),n||(n=e.get("name")),r("returning: "+n),l.push(e)}));else{var i=o.current_feature.category,s=o.current_feature.layer_key,c=o.current_feature.feature_name;l.push(o.CATEGORIES[i][s].features[c].feature)}if(r("features.length="+l.length),l.length>0&&!u){for(var g=0;g<l.length;g++){n=l[g];i=o.current_feature.category;var d=null;if(d=o.current_feature.feature_name,target_layer=o.current_feature.layer_key,r(g.toString()+" "+target_layer+"."+d),target_feature=o.CATEGORIES[i][target_layer].features[d].feature,n==target_feature){if(r("***** Correct! *****"),"Point"==o.CATEGORIES[i][target_layer].type)n.setStyle(t.point_correct_style);else{var p=parseInt(Math.random()*o.random_styles.length);n.setStyle(o.random_styles[p])}return u=!0,o.CATEGORIES[i][o.current_feature.layer_key].features[d].candidate=!1,o.current_feature=null,void(o.mode==TOUR?(r("check_feature setting timeout for pan_zoom_home"),o.last_timeout=window.setTimeout(o.pan_zoom_home,2*o.DELAY)):window.setTimeout(o.startMove,2*o.DELAY))}c=null;(c=n.get("NAME"))||(c=n.get("Name")),c||(c=n.get("name")),r(c+" != "+target_feature.toString())}r("starting move passing feature: "+d),o.startMove(n)}else r("game over")}else r("check_feature: No Current Feature ... returning")},o.flyTo=function(e,t,r){var n=window.map.getView(),a=o.DELAY,l=(n.getZoom(),n.getResolution()),u=2,i=!1;function callback(e){--u,i||0!==u&&e||(i=!0,r(e))}n.animate({center:e,duration:a},callback),l>t?n.animate({resolution:1.05*l,duration:.25*a},{resolution:t,duration:.75*a},callback):n.animate({resolution:1.05*t,duration:.75*a},{resolution:t,duration:.25*a},callback)},o.pan_zoom=function(e){r("pan_zoom: "+e);var n=2*o.DELAY,a=o.current_feature,l=a.category,u=a.layer_key,i=a.feature_name,s=o.CATEGORIES[l][u].features[i].feature.getGeometry().getExtent(),c=t.computeResolution(s,!0,window.innerWidth,window.innerHeight);if(0==(c*=1.2)&&(c=100),o.flyTo(e,c,(function(){})),null!=o.current_feature){try{window.clearTimeout(o.last_timeout)}catch(e){r(e)}r("pan_zoom setting timeout for check_feature"),o.last_timeout=window.setTimeout(o.check_feature,n)}else{try{window.clearTimeout(o.last_timeout)}catch(e){r(e)}r("pan_zoom calling start_move directly"),o.start_move(null)}},o.pan_zoom_home=function(){r("bounce_home");o.DELAY;var n=window.innerWidth,a=window.innerHeight,l=o.collective_bbox,u=t.computeResolution(l,!1,n,a),i=e.proj.transform([(l[0]+l[2])/2,(l[1]+l[3])/2],"EPSG:4326","EPSG:3857");o.flyTo(i,u,(function(){}));try{window.clearTimeout(o.last_timeout)}catch(e){r(e)}r("pan_zoom_home setting timeout for start_move"),o.last_timeout=window.setTimeout(o.startMove,o.delay)},window.colormyworld=o,o}));