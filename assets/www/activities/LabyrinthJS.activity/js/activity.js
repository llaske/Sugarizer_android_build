/*! Sugarizer 2019-09-21 */
define(["sugar-web/activity/activity","webL10n","sugar-web/datastore","sugar-web/graphics/colorpalette","zoompalette","sugar-web/graphics/presencepalette","humane","fontpalette","tutorial","sugar-web/env"],function(a,b,c,d,e,f,g,h,i,j){var k=!1,l=!1,m=null,n={};requirejs(["domReady!"],function(o){a.setup();var p=0,q=document.getElementById("nodetext-button"),r=document.getElementById("link-button"),s=document.getElementById("delete-button"),t=function(a){p=a,q.classList.remove("active"),r.classList.remove("active"),s.classList.remove("active"),0==a?q.classList.add("active"):1==a?r.classList.add("active"):2==a&&s.classList.add("active"),J(),null!=O&&(V(),O=null)};q.addEventListener("click",function(){t(0)},!0),r.addEventListener("click",function(){t(1),O=null},!0),s.addEventListener("click",function(){t(2)},!0);var u=document.getElementById("zoom-button");zoomPalette=new e.zoomPalette(u),zoomPalette.addEventListener("pop",function(a){J()}),zoomPalette.addEventListener("zoom",function(a){var b=a.detail.zoom,c=cy.zoom(),d=.25;0==b?c!=cy.minZoom()&&c-d>cy.minZoom()&&cy.zoom(c-d):1==b?c!=cy.maxZoom()&&cy.zoom(c+d):2==b?cy.fit():3==b&&cy.center()});var v=document.getElementById("png-button");v.addEventListener("click",function(a){var b=cy.png(),d=b.split(";")[0].split(":")[1],e=d.split("/")[0],f={mimetype:d,title:e.charAt(0).toUpperCase()+e.slice(1)+" LabyrinthJS",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};c.create(f,function(){console.log("export done.")},b)});var w=document.getElementById("sub-toolbar"),x=document.getElementById("textvalue"),y=document.getElementById("erasetext-button"),z=document.getElementById("bold-button"),A=document.getElementById("italics-button"),B=document.getElementById("foreground-button");foregroundPalette=new d.ColorPalette(B),foregroundPalette.setColor("rgb(0, 0, 0)");var C=!1,D=document.getElementById("background-button");backgroundPalette=new d.ColorPalette(D),backgroundPalette.setColor("rgb(255, 255, 255)");var E=!1,F=document.getElementById("fontminus-button"),G=document.getElementById("fontplus-button"),H=document.getElementById("font-button");fontPalette=new h.TextPalette(H),document.getElementById("help-button").addEventListener("click",function(a){if(i.setElement("activity",document.getElementById("activity-button")),i.setElement("stop",document.getElementById("stop-button")),i.setElement("undo",document.getElementById("undo-button")),i.setElement("redo",document.getElementById("redo-button")),i.setElement("node",q),i.setElement("link",r),i.setElement("remove",s),i.setElement("png",v),i.setElement("zoom",u),i.setElement("textvalue",x),i.setElement("bold",z),i.setElement("italic",A),i.setElement("foreground",B),i.setElement("background",D),i.setElement("font",H),i.setElement("fontminus",F),i.setElement("fontplus",G),i.setElement("board",document.getElementById("canvas")),cy){var b=O;if(!b){var c=cy.elements("node");c.length>0&&(b=c[0],O=b,T(b))}b&&I(b)}i.start()}),foregroundPalette.addEventListener("colorChange",function(a){C||(O.style("color",a.detail.color),O.data("color",a.detail.color),la()),C=!1}),backgroundPalette.addEventListener("colorChange",function(a){E||(O.style("background-color",a.detail.color),O.data("background-color",a.detail.color),la()),E=!1}),fontPalette.addEventListener("fontChange",function(a){var b=a.detail.family;O.data("font-family",b),O.removeClass("arial-text comic-text verdana-text"),R(O),"Arial"==b?O.addClass("arial-text"):"Comic Sans MS"==b?O.addClass("comic-text"):"Verdana"==b&&O.addClass("verdana-text"),la()}),x.addEventListener("input",function(){x.value.length>0?$("#erasetext-button").show():$("#erasetext-button").hide(),R(O,x.value),la()}),y.addEventListener("click",function(){x.value="",x.focus(),R(O,x.value),$("#erasetext-button").hide(),la()}),z.addEventListener("click",function(){O.toggleClass("bold-text"),O.hasClass("bold-text")?z.classList.add("active"):z.classList.remove("active"),R(O),la()}),A.addEventListener("click",function(){O.toggleClass("italic-text"),O.hasClass("italic-text")?A.classList.add("active"):A.classList.remove("active"),R(O),la()}),F.addEventListener("click",function(){O.data("font-size",Math.max(6,O.data("font-size")-2)),R(O),la()}),G.addEventListener("click",function(){O.data("font-size",Math.min(100,O.data("font-size")+2)),R(O),la()});var I=function(a){zoomPalette.popDown(),w.style.visibility="visible",x.value=a.style().content,a.hasClass("bold-text")?z.classList.add("active"):z.classList.remove("active"),a.hasClass("italic-text")?A.classList.add("active"):A.classList.remove("active"),C=!0,foregroundPalette.setColor(a.style().color),E=!0,backgroundPalette.setColor(a.style()["background-color"]),fontPalette.setFont(a.data("font-family"))},J=function(){w.style.visibility="hidden",backgroundPalette.popDown(),foregroundPalette.popDown(),fontPalette.popDown()};document.getElementById("stop-button").addEventListener("click",function(a){console.log("writing..."),ba(function(a){null===a?console.log("write done."):console.log("write failed.")})}),window.addEventListener("localized",function(){j.getEnvironment(function(a,c){var d="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,e=c.user?c.user.language:d;b.language.code!=e&&(b.language.code=e);var f=P;if(P=b.get("YourNewIdea"),q.title=b.get("nodetextTitle"),r.title=b.get("linkButtonTitle"),s.title=b.get("removeButtonTitle"),ia.title=b.get("undoButtonTitle"),ja.title=b.get("redoButtonTitle"),u.title=b.get("zoomButtonTitle"),B.title=b.get("foregroundButtonTitle"),D.title=b.get("backgroundButtonTitle"),x.placeholder=b.get("typeText"),z.title=b.get("boldButtonTitle"),A.title=b.get("italicButtonTitle"),F.title=b.get("fontMinusButtonTitle"),G.title=b.get("fontPlusButtonTitle"),H.title=b.get("fontButtonTitle"),v.title=b.get("pngButtonTitle"),cy)for(var g=cy.elements("node"),h=0;h<g.length;h++){var i=g[h];i.data("content")==f&&(i.data("content",P),i.style({content:P}))}})},!1),cy=cytoscape({container:document.getElementById("cy"),ready:function(){var a=Q(P,_());a.select(),T(a),O=a,I(a),la(),aa()},style:[{selector:".standard-node",css:{"text-valign":"center","text-halign":"center","border-color":"darkgray","border-width":"1px",shape:"roundrectangle"}},{selector:".bold-text",css:{"font-weight":"bold"}},{selector:".italic-text",css:{"font-style":"italic"}},{selector:".arial-text",css:{"font-family":"Arial"}},{selector:".comic-text",css:{"font-family":"Comic Sans MS"}},{selector:".verdana-text",css:{"font-family":"Verdana"}}]}),cy.on("tap","node",function(){return 2==p?(W(this),la(),void(O==this&&(O=null))):1==p?(null!=O&&O!=this&&(X(O,this),la()),void(O=this)):(S(this)?(U(this),J()):(T(this),I(this),x.value==P?x.setSelectionRange(0,x.value.length):x.setSelectionRange(x.value.length,x.value.length)),void(O=this))}),cy.on("unselect","node",function(){U(this)}),cy.on("select","edge",function(){if(2==p)return Y(this),void la();J()}),cy.on("tap",function(a){if(a.cyTarget===cy&&0==p){var b=Q(P,a.cyPosition);null!=O&&(X(O,b),U(O)),la(),b.select(),T(b),O=b,I(b)}}),cy.on("free","node",function(a){la()});var K=0,L=0,M="Arial",N=16,O=null,P="<Your new idea>",Q=function(a,b){var c=Z(a,M,N,!1,!1);cy.add({group:"nodes",nodes:[{data:{id:"n"+ ++K,"font-family":M,"font-size":N,"font-weight":"normal",content:a,color:"rgb(0, 0, 0)","background-color":"rgb(255, 255, 255)"},position:{x:b.x,y:b.y}}]});var d=cy.getElementById("n"+K);return d.style({content:a,width:c.width,height:c.height,color:"rgb(0, 0, 0)","font-family":"Arial","font-size":N+"px","background-color":"rgb(255, 255, 255)"}),d.addClass("standard-node"),d},R=function(a,b){void 0===b?b=a.style().content:a.data("content",b);var c=a.data("font-size"),d=a.data("font-family"),e=Z(b,d,c,a.hasClass("bold-text"),a.hasClass("italic-text"));a.style({content:b,"font-size":c+"px","font-family":d,width:e.width,height:e.height})},S=function(a){return"dashed"==a.style()["border-style"]},T=function(a){a.style({"border-color":"black","border-style":"dashed","border-width":"4px"})},U=function(a){a.style({"border-color":"darkgray","border-style":"solid","border-width":"1px"})},V=function(){for(var a=cy.collection("node"),b=0;b<a.length;b++)U(a[b])},W=function(a){cy.remove(a)},X=function(a,b){cy.add({group:"nodes",edges:[{data:{id:"e"+ ++L,source:a.id(),target:b.id()}}]})},Y=function(a){cy.remove(a)},Z=function(a,b,c,d,e){var f=document.getElementById("fontsizecomputer");return f.innerHTML=a.replace("<","&lt;").replace(">","&gt;"),f.style.fontFamily=b,f.style.fontSize=c+"px",f.style.fontWeight=d?"bold":"normal",f.style.fontStyle=e?"italic":"normal",{width:f.clientWidth+c+"px",height:f.clientHeight+c+"px"}},_=function(){var a=document.getElementById("canvas");return{x:a.clientWidth/2,y:a.clientHeight/2}},aa=function(){a.getDatastoreObject().loadAsText(function(a,b,c){null!=c&&(ea(JSON.parse(c)),ka(),la())})},ba=function(b){var c=a.getDatastoreObject(),d=da();c.setDataAsText(JSON.stringify(d)),c.save(b)},ca=function(a){var b,c=a;if(a&&"object"==typeof a){c="[object Array]"===Object.prototype.toString.call(a)?[]:{};for(b in a)c[b]=ca(a[b])}return c},da=function(){return ca(cy.json())},ea=function(a){cy.remove("node"),cy.remove("edge"),J(),O=null,cy.add({group:"nodes",nodes:a.elements.nodes});for(var b=cy.collection("node"),c=0,d=0;d<b.length;d++){var e=b[d];R(e,e.data("content")),e.style("color",e.data("color")),e.style("background-color",e.data("background-color"));var f=e.data("id").substr(1);f>c&&(c=f)}if(K=c+1,c=0,a.elements.edges){cy.add({group:"edges",edges:a.elements.edges});for(var g=cy.collection("edge"),d=0;d<g.length;d++){var f=g[d].data("id").substr(1);f>c&&(c=f)}}L=c+1},fa=[],ga=0,ha=30,ia=document.getElementById("undo-button");ia.addEventListener("click",function(){ma()},!0);var ja=document.getElementById("redo-button");ja.addEventListener("click",function(){na()},!0);var ka=function(){fa=[],ga=0},la=function(a){if(ga<fa.length-1){for(var b=[],c=0;c<ga+1;c++)b.push(fa[c]);fa=b}var d=fa.length-1,e=da();if(d<ha)fa.push(e);else{for(var c=0;c<d-1;c++)fa[c]=fa[c+1];fa[d-1]=e}ga=fa.length-1,k&&!a&&va({action:"updateBoard",data:da()}),oa()},ma=function(a){fa.length<1||fa.length>=1&&0==ga||(ea(fa[--ga]),k&&!a&&va({action:"undoBoard"}),oa())},na=function(a){ga+1>=fa.length||(ea(fa[++ga]),k&&!a&&va({action:"redoBoard"}),oa())},oa=function(){var a=fa.length;ia.disabled=fa.length<1||fa.length>=1&&0==ga,ja.disabled=ga+1>=a},pa=function(a){var b='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>';return b=b.replace("#010101",a.stroke),b=b.replace("#FFFFFF",a.fill),"data:image/svg+xml;base64,"+btoa(b)},qa=function(){var a=document.getElementById("presence-users"),b="<hr><ul style='list-style: none; padding:0;'>";for(var c in n)b+="<li><img style='height:30px;' src='"+pa(n[c].colorvalue)+"'>"+n[c].name+"</li>";b+="</ul>",a.innerHTML=b},ra=function(a){var b=document.getElementById("presence-users");a&&b&&m.listSharedActivityUsers(m.getSharedInfo().id,function(a){n={};for(var b=0;b<a.length;b++){var c=a[b];n[c.networkId]=c}qa()})},sa=document.getElementById("network-button"),ta=new f.PresencePalette(sa,void 0);sa.addEventListener("click",function(a){J()});var ua=function(){m=a.getPresenceObject(function(a,b){if(a)return void console.log("error");k=!0,userSettings=b.getUserInfo(),console.log("connected"),window.top.sugar.environment.sharedId||(l=!0,b.createSharedActivity("org.olpc-france.labyrinthjs",function(a){})),b.onConnectionClosed(function(a){console.log(a),console.log("Connection closed")}),b.onSharedActivityUserChanged(function(a){xa(a)}),b.onDataReceived(wa)})},va=function(a){try{m.sendMessage(m.getSharedInfo().id,{user:m.getUserInfo(),content:a})}catch(a){}},wa=function(a){if(m.getUserInfo().networkId!==a.user.networkId)switch(a.content.action){case"initialBoard":ea(a.content.data);break;case"updateBoard":ea(a.content.data),la(!0);break;case"undoBoard":ma(!0);break;case"redoBoard":na(!0)}},xa=function(a){var c=a.user.name.replace("<","&lt;").replace(">","&gt;"),d="<img style='height:30px;' src='"+pa(a.user.colorvalue)+"'>";1===a.move?(g.log(d+b.get("PlayerJoin",{user:c})),l&&va({action:"initialBoard",data:da()})):-1===a.move&&g.log(d+b.get("PlayerLeave",{user:c})),m.listSharedActivities(function(a){for(var b=0;b<a.length;b++)a[b].id===m.getSharedInfo().id&&ra(a[b].users)})};ta.addEventListener("shared",function(){ta.popDown(),ua()}),window.top&&window.top.sugar&&window.top.sugar.environment&&window.top.sugar.environment.sharedId&&(console.log("ehy00"),ua(),ta.setShared(!0))})});