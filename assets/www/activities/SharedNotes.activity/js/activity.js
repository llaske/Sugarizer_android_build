define(["sugar-web/activity/activity","sugar-web/datastore","notepalette","zoompalette","sugar-web/graphics/presencepalette","humane","tutorial","sugar-web/env"],(function(t,e,o,n,i,l,a,c){var r="#FFF29F",d=!1,s=!1,u=null,g={};requirejs(["domReady!"],(function(y){t.setup();var v=0,m=document.getElementById("nodetext-button"),p=document.getElementById("delete-button"),switchMode=function(t){v=t,m.classList.remove("active"),p.classList.remove("active"),saveAndFinishEdit(),0==t?m.classList.add("active"):1==t&&p.classList.add("active"),null!=k&&(unselectAllNode(),k=null)};m.addEventListener("click",(function(){switchMode(0)}),!0),p.addEventListener("click",(function(){switchMode(1)}),!0);var f=document.getElementById("color-button");colorPalette=new o.NotePalette(f),colorPalette.setColor("rgb(255, 242, 159)"),colorPalette.addEventListener("colorChange",(function(t){isSelectedNode(k)&&(pushState({redo:{action:"update",id:k.id(),color:t.detail.color},undo:{action:"update",id:k.id(),color:k.data("background-color")}}),k.style("background-color",t.detail.color),k.data("background-color",t.detail.color)),I.style.backgroundColor=t.detail.color,r=t.detail.color}));var h=document.getElementById("zoom-button");zoomPalette=new n.zoomPalette(h),zoomPalette.addEventListener("pop",(function(t){})),zoomPalette.addEventListener("zoom",(function(t){var e=t.detail.zoom,o=cy.zoom();0==e?o!=cy.minZoom()&&o-.25>cy.minZoom()&&cy.zoom(o-.25):1==e?o!=cy.maxZoom()&&cy.zoom(o+.25):2==e?cy.fit():3==e&&cy.center()}));var x=document.getElementById("png-button");x.addEventListener("click",(function(t){var o=cy.png(),n=o.split(";")[0].split(":")[1],i=n.split("/")[0],l={mimetype:n,title:i.charAt(0).toUpperCase()+i.slice(1)+" Shared Notes",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};e.create(l,(function(){console.log("export done.")}),o)}));var w=document.getElementById("network-button"),b=new i.PresencePalette(w,void 0),E=document.getElementById("stop-button");E.addEventListener("click",(function(t){console.log("writing..."),saveGraph((function(t){null===t?console.log("write done."):console.log("write failed.")}))}));var k=null,B="<Your content>",I=document.getElementById("textvalue"),L=null;I.addEventListener("click",(function(t){saveAndFinishEdit()}));var createNode=function(t,e,o,n){cy.add({group:"nodes",nodes:[{data:{id:t,content:e,color:"rgb(0, 0, 0)","background-color":n},position:{x:o.x,y:o.y}}]});var i=cy.getElementById(t);return i.style({content:e,"background-color":n}),i.addClass("standard-node"),i},updateNodeText=function(t,e){if(null!=t){var o=t.data("content");void 0===e?e=t.style().content:t.data("content",e),t.style({content:e}),o!=e&&pushState({redo:{action:"update",id:t.id(),text:e},undo:{action:"update",id:t.id(),text:o}})}},isSelectedNode=function(t){return null!=t&&"dashed"==t.style()["border-style"]},selectNode=function(t){null!=t&&t.style({"border-color":"black","border-style":"dashed","border-width":"4px"})},unselectNode=function(t){null!=t&&t.style({"border-color":"darkgray","border-style":"solid","border-width":"1px"})},unselectAllNode=function(){for(var t=cy.collection("node"),e=0;e<t.length;e++)unselectNode(t[e])},showEditField=function(t){var e=t.renderedPosition(),o=cy.zoom();I.value=t.data("content"),I.style.visibility="visible",I.style.backgroundColor=t.style().backgroundColor;var n=100*o-200*o;I.style.left=e.x+n+"px",I.style.top=55+e.y+n+"px",I.style.width=190*o+"px",I.style.height=190*o+"px",I.style.resize="none",I.value==B?I.setSelectionRange(0,I.value.length):I.setSelectionRange(I.value.length,I.value.length),I.focus()},hideEditField=function(){textvalue.style.visibility="hidden"},saveAndFinishEdit=function(){null!=k&&isSelectedNode(k)&&(updateNodeText(k,I.value),hideEditField(),unselectNode(k))},newId=function(){for(var t=[],e=0;e<36;e++)t[e]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]="0123456789abcdef".substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")},doAction=function(t){if(void 0!==t.action)if("create"==t.action)createNode(t.id,t.text,t.position,t.color);else if("delete"==t.action){if(null==(e=cy.getElementById(t.id)))return;cy.remove(e)}else if("update"==t.action){var e;if(null==(e=cy.getElementById(t.id)))return;void 0!==t.text&&(e.data("content",t.text),e.style({content:t.text})),void 0!==t.color&&(e.data("background-color",t.color),e.style({"background-color":t.color})),void 0!==t.position&&e.position({x:t.position.x,y:t.position.y})}},initGraph=function(t){if(null!=t){cy.remove("node"),k=null;for(var e=0;e<t.length;e++)doAction(t[e]);hideEditField(),reinitState()}},getGraph=function(){for(var t=[],e=cy.elements("node"),o=0;o<e.length;o++){var n=e[o];t.push({action:"create",id:n.id(),text:n.data("content"),position:{x:n.position().x,y:n.position().y},color:n.data("background-color")})}return t},saveGraph=function(e){var o=t.getDatastoreObject(),n=getGraph();o.setDataAsText(n),o.save(e)},_=[],T=0,z=document.getElementById("undo-button");z.addEventListener("click",(function(){saveAndFinishEdit(),undoState()}),!0);var P=document.getElementById("redo-button");P.addEventListener("click",(function(){saveAndFinishEdit(),redoState()}),!0);var reinitState=function(){_=[],T=0},pushState=function(t,e){if(T<_.length-1){for(var o=[],n=0;n<T+1;n++)o.push(_[n]);_=o}var i=_.length-1,l=t;if(i<30)_.push(l);else{for(n=0;n<i;n++)_[n]=_[n+1];_[_.length-1]=l}T=_.length-1,d&&!e&&sendMessage({action:"updateBoard",data:t}),updateStateButtons()},undoState=function(t){if(!(_.length<1||T<0)){var e=_[T--].undo;doAction(e),d&&!t&&sendMessage({action:"undoBoard"}),updateStateButtons()}},redoState=function(t){if(!(T+1>=_.length)){var e=_[++T].redo;doAction(e),d&&!t&&sendMessage({action:"redoBoard"}),updateStateButtons()}},updateStateButtons=function(){var t=_.length;z.disabled=_.length<1||T<0,P.disabled=T+1>=t},generateXOLogoWithColor=function(t){var e='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>';return e=(e=e.replace("#010101",t.stroke)).replace("#FFFFFF",t.fill),"data:image/svg+xml;base64,"+btoa(e)},displayConnectedPeople=function(t){var e=document.getElementById("presence-users");t&&e&&u.listSharedActivityUsers(u.getSharedInfo().id,(function(t){g={};for(var e=0;e<t.length;e++){var o=t[e];g[o.networkId]=o}!function(){var t=document.getElementById("presence-users"),e="<hr><ul style='list-style: none; padding:0;'>";for(var o in g)e+="<li><img style='height:30px;' src='"+generateXOLogoWithColor(g[o].colorvalue)+"'>"+g[o].name+"</li>";e+="</ul>",t.innerHTML=e}()}))},shareActivity=function(){u=t.getPresenceObject((function(t,e){t?console.log("error"):(d=!0,userSettings=e.getUserInfo(),console.log("connected"),window.top.sugar.environment.sharedId||(s=!0,e.createSharedActivity("org.olpcfrance.sharednotes",(function(t){}))),e.onConnectionClosed((function(t){console.log(t),console.log("Connection closed")})),e.onSharedActivityUserChanged((function(t){onNetworkUserChanged(t)})),e.onDataReceived(onNetworkDataReceived))}))},sendMessage=function(t){try{u.sendMessage(u.getSharedInfo().id,{user:u.getUserInfo(),content:t})}catch(t){}},onNetworkDataReceived=function(t){if(u.getUserInfo().networkId!==t.user.networkId)switch(t.content.action){case"initialBoard":initGraph(t.content.data);break;case"updateBoard":doAction(t.content.data.redo),pushState(t.content.data,!0);break;case"undoBoard":undoState(!0);break;case"redoBoard":redoState(!0)}},onNetworkUserChanged=function(t){var e=t.user.name.replace("<","&lt;").replace(">","&gt;"),o="<img style='height:30px;' src='"+generateXOLogoWithColor(t.user.colorvalue)+"'>";1===t.move?(l.log(o+l10n_s.get("PlayerJoin",{user:e})),s&&sendMessage({action:"initialBoard",data:getGraph()})):-1===t.move&&l.log(o+l10n_s.get("PlayerLeave",{user:e})),u.listSharedActivities((function(t){for(var e=0;e<t.length;e++)t[e].id===u.getSharedInfo().id&&displayConnectedPeople(t[e].users)}))};b.addEventListener("shared",(function(){b.popDown(),shareActivity()})),window.top&&window.top.sugar&&window.top.sugar.environment&&window.top.sugar.environment.sharedId&&(shareActivity(),b.setShared(!0));var F=document.getElementById("help-button");a.setElement("activity",document.getElementById("activity-button")),a.setElement("title",document.getElementById("title")),a.setElement("network",w),a.setElement("help",F),a.setElement("shared",document.getElementById("shared-button")),a.setElement("png",x),a.setElement("zoom",h),a.setElement("color",f),a.setElement("add",m),a.setElement("remove",p),a.setElement("undo",document.getElementById("undo-button")),a.setElement("redo",document.getElementById("redo-button")),a.setElement("stop",E),a.setElement("node",document.getElementById("canvas")),F.addEventListener("click",(function(t){a.start()})),c.getEnvironment((function(t,e){e.help&&setTimeout((function(){a.start(a.tourInit)}),500)})),window.addEventListener("localized",(function(){c.getEnvironment((function(t,e){var o="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,n=e.user?e.user.language:o;l10n_s.language.code!=n&&(l10n_s.language.code=n);var i=B;if(B=l10n_s.get("YourNewIdea"),m.title=l10n_s.get("nodetextTitle"),p.title=l10n_s.get("removeButtonTitle"),z.title=l10n_s.get("undoButtonTitle"),P.title=l10n_s.get("redoButtonTitle"),h.title=l10n_s.get("zoomButtonTitle"),x.title=l10n_s.get("pngButtonTitle"),w.title=l10n_s.get("networkButtonTitle"),F.title=l10n_s.get("helpButtonTitle"),cy){for(var l=cy.elements("node"),a=0;a<l.length;a++){var c=l[a];c.data("content")==i&&(c.data("content",B),c.style({content:B}))}I&&I.value==i&&(I.value=B,k&&showEditField(k))}}))}),!1),cy=cytoscape({container:document.getElementById("cy"),ready:function(){cy=this;var e,o=createNode(newId(),B,{x:(e=document.getElementById("canvas")).clientWidth/2,y:e.clientHeight/2},r);pushState({redo:{action:"create",id:o.id(),text:o.data("content"),position:{x:o.position().x,y:o.position().y},color:r},undo:{action:"delete",id:o.id()}}),o.select(),selectNode(o),showEditField(o),k=o,t.getDatastoreObject().loadAsText((function(t,e,o){initGraph(o)}))},style:[{selector:".standard-node",css:{width:"200px",height:"200px","text-valign":"center","text-halign":"center","border-color":"darkgray","border-width":"1px","background-color":r,"text-wrap":"wrap","text-max-width":"200px","text-overflow-wrap":"anywhere","shadow-color":"black","shadow-offset-x":"4px","shadow-offset-y":"4px","shadow-opacity":"0.5",shape:"rectangle"}}]}),cy.on("tap","node",(function(){if(1==v)return pushState({redo:{action:"delete",id:this.id()},undo:{action:"create",id:this.id(),text:this.data("content"),position:{x:this.position().x,y:this.position().y},color:r}}),null!=(t=this)&&cy.remove(t),void(k==this&&(k=null));var t;isSelectedNode(this)||(null!=k&&(updateNodeText(k,I.value),unselectNode(k)),selectNode(this),showEditField(this)),k=this})),cy.on("unselect","node",(function(){saveAndFinishEdit(),unselectNode(this)})),cy.on("tap",(function(t){if(t.cyTarget===cy&&0==v){saveAndFinishEdit();var e=createNode(newId(),B,t.cyPosition,r);pushState({redo:{action:"create",id:e.id(),text:e.data("content"),position:{x:e.position().x,y:e.position().y},color:r},undo:{action:"delete",id:e.id()}}),e.select(),selectNode(e),showEditField(e),k=e}})),cy.on("drag","node",(function(t){saveAndFinishEdit(),null==L&&(L={x:this.position().x,y:this.position().y})})),cy.on("free","node",(function(t){null==L||this.position().x==L.x&&this.position().y==L.y||pushState({redo:{action:"update",id:this.id(),position:{x:this.position().x,y:this.position().y}},undo:{action:"update",id:this.id(),position:{x:L.x,y:L.y}}}),L=null})),cy.on("zoom",(function(){saveAndFinishEdit()})),cy.on("pan",(function(){saveAndFinishEdit()}))}))}));