/*! Sugarizer 2020-03-14 */
define(["sugar-web/activity/activity","tween","rAF","activity/directions","sugar-web/graphics/presencepalette","sugar-web/env","sugar-web/graphics/icon","webL10n","sugar-web/graphics/palette","rot","humane","tutorial"],function(a,b,c,d,e,f,g,h,i,j,k,l){requirejs(["domReady!"],function(c){a.setup();var g={},i=!1,m=0,n=0;g.width=void 0,g.height=void 0,g.startPoint={},g.goalPoint={},g.walls=[],g.visited=[],g.directions=[],g.forks=[];var o='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>';f.getEnvironment(function(b,c){var d="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,e=c.user?c.user.language:d;h.language.code=e,c.sharedId&&(console.log("Shared instance"),ua=a.getPresenceObject(function(a,b){b.onDataReceived(z),b.onSharedActivityUserChanged(A)})),c.objectId?a.getDatastoreObject().loadAsText(function(a,b,c){null==a&&null!=c&&(c=JSON.parse(c),g=c.maze,M=c.gameSize,Q(),S(),ba())}):pa()}),document.getElementById("fullscreen-button").addEventListener("click",function(){document.getElementById("main-toolbar").style.opacity=0,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",R()}),document.getElementById("unfullscreen-button").addEventListener("click",function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",R()});var p,q,r,s,t,u,v,w,x,y=function(a){var b=o;return b=b.replace("#010101",a.stroke),b=b.replace("#FFFFFF",a.fill),"data:image/svg+xml;base64,"+btoa(b)},z=function(a){if(ua.getUserInfo().networkId!==a.user.networkId)switch(a.action){case"start":i=!1,m=0,g=a.content,M=a.SizeOfGame,n=a.oponentCount,Q(),S(),ba();break;case"ended":m++;var b=a.user.name.replace("<","&lt;").replace(">","&gt;"),c="<img style='height:30px;' src='"+y(a.user.colorvalue)+"'>";k.log(c+h.get("PlayerEndLevel",{user:b}))}},A=function(a){var b=a.user.name.replace("<","&lt;").replace(">","&gt;"),c="<img style='height:30px;' src='"+y(a.user.colorvalue)+"'>";1===a.move?(n++,k.log(c+h.get("PlayerJoin",{user:b}))):-1===a.move&&(n--,k.log(c+h.get("PlayerLeave",{user:b}))),va&&ua.sendMessage(ua.getSharedInfo().id,{user:ua.getUserInfo(),action:"start",SizeOfGame:M,oponentCount:n,content:g}),console.log("User "+a.user.name+" "+(1==a.move?"join":"leave"))},B=".mp3",C="#101010",D="#ffffff",E="hsl(0, 0%, 80%)",F="hsl(0, 90%, 50%)",G=[],H={arrows:[38,39,40,37],wasd:[87,68,83,65],ijkl:[73,76,75,74],mouse:[-1,-1,-1,-1]},I=["arrows","wasd","ijkl","mouse"],J={},K={},L={},M=60,N=!1,O=document.getElementById("maze"),P=document.createElement("canvas"),Q=function(){var a=document.getElementById("main-toolbar");p=window.innerWidth,q="visible"==document.getElementById("unfullscreen-button").style.visibility?window.innerHeight-3:window.innerHeight-a.offsetHeight-3,s=Math.floor(p/g.width),t=Math.floor(q/g.height),O.width=p,O.height=q,P.width=2*s,P.height=t*I.length},R=function(){Q(),S(),$()};window.addEventListener("resize",R);var S=function(){for(control in H)control in J&&T(control)},T=function(a){var b=I.indexOf(a);return ctx=P.getContext("2d"),X(ctx,0,b,J[a].normal),X(ctx,1,b,J[a].blocked),{normal:{image:P,x:0,y:b},blocked:{image:P,x:1,y:b}}},U=function(a,b,c,d){a.fillStyle=d,a.fillRect(s*b,t*c,s,t)},V=function(a,b,c,d){var e;e=1==d?C:D,U(a,b,c,e)},W=function(a,b,c,d,e){var f=s*(b+.5),g=t*(c+.5),h=e*Math.min(s,t)/2;a.beginPath(),a.arc(f,g,h,0,2*Math.PI,!1),a.fillStyle=d,a.fill()},X=function(a,b,c,d){W(a,b,c,d,.9);var e=s*(b+.3),f=t*(c+.45),g=.28*Math.min(s,t)/2;a.beginPath(),a.arc(e,f,g,0,2*Math.PI,!1);var h=s*(b+.7),i=t*(c+.45);a.arc(h,i,g,0,2*Math.PI,!1),a.fillStyle="#ffffff",a.fill(),a.beginPath(),a.arc(e,f,g/2,0,2*Math.PI,!1),a.arc(h,i,g/2,0,2*Math.PI,!1),a.fillStyle="#000000",a.fill(),a.beginPath(),a.moveTo(s*(b+.25),t*(c+.65)),a.quadraticCurveTo(s*(b+.5),t*(c+.75),s*(b+.75),t*(c+.65)),a.quadraticCurveTo(s*(b+.5),t*(c+.75),s*(b+.75),t*(c+.65)),a.quadraticCurveTo(s*(b+.5),t*(c+1),s*(b+.25),t*(c+.65)),a.quadraticCurveTo(s*(b+.5),t*(c+1),s*(b+.25),t*(c+.65)),a.fillStyle="#ffffff",a.fill()},Y=function(a,b,c,d){a.drawImage(d.image,s*d.x,t*d.y,s,t,s*b,t*c,s,t)},Z=function(a,b,c){void 0===c&&(c=O.getContext("2d")),V(c,a,b,g.walls[a][b]),void 0!==g.visited[a][b]&&W(c,a,b,g.visited[a][b],.5),N&&1==g.forks[a][b]&&W(c,a,b,"#faa",.5),a==g.startPoint.x&&b==g.startPoint.y&&W(c,g.startPoint.x,g.startPoint.y,E,.9),a==g.goalPoint.x&&b==g.goalPoint.y&&U(c,g.goalPoint.x,g.goalPoint.y,r);for(control in L){var d=L[control];a==d.x&&b==d.y&&Y(c,a,b,d.sprite)}},$=function(a){void 0===a&&(a=O.getContext("2d"));for(var b=0;b<g.width;b++)for(var c=0;c<g.height;c++)V(a,b,c,g.walls[b][c]),void 0!==g.visited[b][c]&&W(a,b,c,g.visited[b][c],.5),N&&1==g.forks[b][c]&&W(a,b,c,"#faa",.5);W(a,g.startPoint.x,g.startPoint.y,E,.9),X(a,g.startPoint.x,g.startPoint.y,F),U(a,g.goalPoint.x,g.goalPoint.y,r);for(control in L){var d=L[control];Y(a,b,c,d.sprite)}},_=function(a){void 0===a&&(a=O.getContext("2d"));var b=s*(u.x+.5),c=t*(u.y+.5),d=w;a.beginPath(),a.arc(b,c,d,0,2*Math.PI,!1),a.fillStyle=u.color,a.fill()},aa=function(a){void 0===a&&(a=O.getContext("2d")),a.fillStyle=r;var b,c,d=s*x,e=t*x;b=1==g.goalPoint.x?s:(g.goalPoint.x+1)*s-d,c=1==g.goalPoint.y?t:(g.goalPoint.y+1)*t-e,a.fillRect(b,c,d,e),W(a,g.startPoint.x,g.startPoint.y,E,.9*x)},ba=function(){v="starting",tween=new b.Tween({t:0}),tween.to({t:1},900),tween.easing(b.Easing.Quadratic.InOut),tween.onUpdate(function(){x=this.t}),tween.onComplete(function(){x=void 0,v="playing",$()}),tween.start()},ca=function(a,b){ja(a,b),g.walls=ka(g.width,g.height),g.visited=ka(g.width,g.height),g.directions=ka(g.width,g.height),g.forks=ka(g.width,g.height),new j.Map.IceyMaze(g.width,g.height,1).create(la),ma(),oa()},da=function(a){u=a,v="transition",i=!0,ua&&ua.sendMessage(ua.getSharedInfo().id,{user:ua.getUserInfo(),action:"ended"}),new Audio("sounds/win"+B).play();for(control in L)L[control].stop();var c=Math.sqrt(Math.pow(window.innerWidth,2)+Math.pow(window.innerHeight,2));if(tween=new b.Tween({radius:0}),tween.to({radius:c},1200),tween.easing(b.Easing.Circular.Out),tween.onUpdate(function(){w=this.radius}),g.startPoint={},L={},ua)if(m+1==n)tween.onComplete(function(){ea()});else{var d=n-m-1;k.log(h.get(d>1?"PlayersWaitMany":"PlayersWaitOne",{count:d}))}else tween.onComplete(function(){ea()});tween.start()},ea=function(){M*=1.2,pa()},fa=function(a){if(this.control=a,this.x=g.startPoint.x,this.y=g.startPoint.y,!(a in J)){var b=Math.floor(360*Math.random());J[a]={normal:"hsl("+b+", 90%, 50%)",blocked:"hsl("+b+", 90%, 80%)",visited:"hsl("+b+", 30%, 80%)"},K[a]=T(a)}this.color=J[a].normal,this.sprite=K[a].normal,this.visitedColor=J[a].visited,this.path=void 0,this.animation=void 0,this.blockTween=void 0,G.push({x:this.x,y:this.y})},ga=function(a,b){return g.directions[a][b].reduce(function(a,b){return a+b})},ha=function(a,b){return 1==ga(a,b)},ia=function(a,b){return ga(a,b)>2},ja=function(a,b){g.height=Math.sqrt(b/a),g.width=g.height*a,g.height=Math.floor(g.height),g.width=Math.floor(g.width);var c,d;c=g.width%2?g.width-2:g.width-3,d=g.height%2?g.height-2:g.height-3;var e,f;Math.random()<.5?(e=1,i=c):(e=c,i=1);var h,i;Math.random()<.5?(h=1,f=d):(h=d,f=1),g.startPoint={x:e,y:h},g.goalPoint={x:i,y:f}},ka=function(a,b){for(var c=[],d=0;d<a;d++)c[d]=new Array(b);return c},la=function(a,b,c){g.walls[a][b]=c},ma=function(){for(var a=0;a<g.width;a++)for(var b=0;b<g.height;b++)g.directions[a][b]=na(a,b)},na=function(a,b){var c=[0,0,0,0];return 1==g.walls[a][b]?c:(0==g.walls[a-1][b]&&(c[d.west]=1),0==g.walls[a+1][b]&&(c[d.east]=1),0==g.walls[a][b-1]&&(c[d.north]=1),0==g.walls[a][b+1]&&(c[d.south]=1),c)},oa=function(){for(var a=0;a<g.width;a++)for(var b=0;b<g.height;b++)(ha(a,b)||ia(a,b))&&(g.forks[a][b]=1)},pa=function(){ca(window.innerWidth/window.innerHeight,M),Q(),S(),ua&&ua.sendMessage(ua.getSharedInfo().id,{user:ua.getUserInfo(),action:"start",SizeOfGame:M,content:g,oponentCount:n}),i=!1,m=0,L={},u=void 0,ba()};pa(),document.getElementById("restart-button").addEventListener("click",function(a){M=60,pa()}),document.getElementById("help-button").addEventListener("click",function(a){l.start()}),fa.prototype.isMoving=function(){return void 0!==this.animation},fa.prototype.canGo=function(a){return 1==g.directions[this.x][this.y][d[a]]},fa.prototype.findPath=function(a){var b=function(a,c,e,f){if(!f&&(ha(a,c)||ia(a,c)))return[];var h=function(a,b,c){var e,f=a,h=b;"north"==c&&(h-=1),"east"==c&&(f+=1),"south"==c&&(h+=1),"west"==c&&(f-=1);var i=g.directions[f][h],j=i.slice(0);return j[d[d.getOpposite(c)]]=0,e=d.orders[j.indexOf(1)],{x:f,y:h,direction:e}},i=h(a,c,e),j=b(i.x,i.y,i.direction,!1);return j.unshift(e),j};return b(this.x,this.y,a,!0)},fa.prototype.stop=function(){clearInterval(this.animation),this.animation=void 0},fa.prototype.showBlocked=function(){function a(){c.color=J[c.control].normal,c.sprite=K[c.control].normal,G.push({x:c.x,y:c.y})}var c=this;void 0!==this.blockTween&&(this.blockTween.stop(),a()),this.blockTween=new b.Tween({}).to({},300),this.color=J[this.control].blocked,this.sprite=K[this.control].blocked,G.push({x:this.x,y:this.y}),this.blockTween.onComplete(function(){a()}),this.blockTween.start(),new Audio("sounds/tick"+B).play()},fa.prototype.move=function(a){if(!this.isMoving()){if(!this.canGo(a))return void this.showBlocked();var b=this,c=function(){var a=b.path.shift();void 0==a&&b.stop(),g.visited[b.x][b.y]=b.visitedColor,G.push({x:b.x,y:b.y}),"north"==a&&(b.y-=1),"east"==a&&(b.x+=1),"south"==a&&(b.y+=1),"west"==a&&(b.x-=1),G.push({x:b.x,y:b.y}),b.x==g.goalPoint.x&&b.y==g.goalPoint.y&&da(b)};this.path=this.findPath(a),this.animation=setInterval(c,40)}};var qa=function(a){if("transition"!=v){var b="mouse";b in L||(L[b]=new fa(b));var c=L[b],d=s*(c.x+.5),e=t*(c.y+.5),f=a.clientX,g=a.clientY,h=document.getElementById("maze");f-=h.offsetLeft,g-=h.offsetTop;var i=180*Math.atan2(g-e,f-d)/Math.PI;45<i&&i<135?c.move("south"):-45>i&&i>-135?c.move("north"):-45<i&&i<45?c.move("east"):c.move("west")}};O.addEventListener?O.addEventListener("mousedown",qa):O.attachEvent("onclick",qa);var ra=function(a){if("transition"!=v){var b,c;for(control in H)-1!=H[control].indexOf(a.keyCode)&&(b=control,c=d.orders[H[control].indexOf(a.keyCode)]);if(void 0!==b){b in L||(L[b]=new fa(b));L[b].move(c)}}};document.addEventListener("keydown",ra);var sa=function(a){var b=Math.floor(120*(1+Math.cos(a/3e3))),c=Math.floor(50+10*(1+Math.cos(a/300)));r="hsl("+b+", 90%, "+c+"%)",G.push({x:g.goalPoint.x,y:g.goalPoint.y})},ta=function(a){switch(b.update(a),v){case"transition":_();break;case"starting":sa(a),aa();break;case"playing":sa(a),G.forEach(function(a){Z(a.x,a.y)}),G=[]}requestAnimationFrame(ta),/Android/i.test(navigator.userAgent)&&"http"!=document.location.protocol.substr(0,4)&&(O.style.display="none",O.offsetHeight,O.style.display="block")};ta();var ua=null,va=!1,wa=new e.PresencePalette(document.getElementById("network-button"),void 0);wa.addEventListener("shared",function(){wa.popDown(),console.log("Want to share"),ua=a.getPresenceObject(function(a,b){if(a)return void console.log("Sharing error");b.createSharedActivity("org.sugarlabs.MazeWebActivity",function(a){console.log("Activity shared"),va=!0,ua.sendMessage(ua.getSharedInfo().id,{user:ua.getUserInfo(),action:"connect"})}),b.onDataReceived(z),b.onSharedActivityUserChanged(A)})}),document.getElementById("stop-button").addEventListener("click",function(b){g.visited=ka(g.width,g.height);var c={maze:g,gameSize:M},d=JSON.stringify(c);a.getDatastoreObject().setDataAsText(d),a.getDatastoreObject().save()})})});