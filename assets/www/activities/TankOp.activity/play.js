/*! Sugarizer 2020-03-14 */
enyo.kind({name:"TankOp.Play",kind:enyo.Control,classes:"board",published:{level:0},components:[{name:"gamebox",classes:"game-box",ontap:"gameClick",components:[]},{classes:"status-line",components:[{name:"wavetext",classes:"wave-text no-select-content"},{name:"wave",content:"1",classes:"wave-value no-select-content"},{name:"scoretext",classes:"score-text no-select-content"},{name:"score",content:"0000",classes:"score-value no-select-content"}]},{kind:"Image",classes:"home-button no-select-content",src:"images/gohome.png",ontap:"goHome"},{name:"keyboard",classes:"keyboard-set no-select-content",components:[{classes:"display-line",components:[{name:"lcd",kind:"LcdDisplay",classes:"lcd-value",size:3,value:""}]},{classes:"keyboard-line",components:[{kind:"Image",src:"images/key_1.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_2.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_3.svg",classes:"keyboard",ontap:"virtkeyPressed"}]},{classes:"keyboard_line",components:[{kind:"Image",src:"images/key_4.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_5.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_6.svg",classes:"keyboard",ontap:"virtkeyPressed"}]},{classes:"keyboard_line",components:[{kind:"Image",src:"images/key_7.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_8.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_9.svg",classes:"keyboard",ontap:"virtkeyPressed"}]},{classes:"keyboard_line",components:[{kind:"Image",src:"images/key_0.svg",classes:"keyboard",ontap:"virtkeyPressed"},{kind:"Image",src:"images/key_fire.svg",classes:"keyboard",ontap:"virtkeyPressed"}]}]},{kind:"Signals",onkeypress:"keyPressed"},{kind:"ImageCache",showing:!1,onCacheLoaded:"cacheLoaded"}],create:function(){this.inherited(arguments),play=this,this.imagesToLoad++,this.endOfGame=!1,this.pausedGame=!0,this.initializedGame=!1,this.waitForClick=!1;var a=document.body.clientWidth,b=a/1e3;this.zoom=Math.max(b,.3),this.zoom=Math.min(this.zoom,1),this.$.gamebox.setStyle("max-height: "+this.zoom*constant.areaHeight+"px;"),this.canvas=this.$.gamebox.createComponent({kind:"Canvas",id:"acanvas",name:"canvas",attributes:{width:constant.areaWidth,height:constant.areaHeight}}),this.loopTimer=window.setInterval(enyo.bind(this,"gameLoopTick"),constant.loopInterval)},initGame:function(){var a=this.currentlevel=preferences.levels[this.level],b=a.map,c=a.defense[0],d=a.defense[1],e=a.defense[2],f=a.defense[3],g=a.defense[4];this.initializedGame=!0,this.game=util.createMap(preferences.gameMap(b)),this.targetpos={x:7,y:4},this.$.wavetext.setContent(l10n.get("Wave")),this.$.scoretext.setContent(l10n.get("Score"));var h=(constant.boardWidth,constant.boardHeight,enyo.bind(this,"goodEngine"));this.units=[];for(var i=constant.boardHeight/(c+1),k=[],l=0;l<c;l++){var m=util.createUnit({type:"hq",color:"blue",x:0,y:Math.floor((l+1)*i),engine:null});this.units.push(m),k.push(m)}for(var n=[],l=0;l<g;l++)n.push({type:"helo",color:"blue",engine:h});for(var l=0;l<f;l++)n.push({type:"canon",color:"blue",engine:h});for(var l=0;l<e;l++)n.push({type:"tank",color:"blue",engine:h});for(var l=0;l<d;l++)n.push({type:"soldier",color:"blue",engine:h});if(n.length>0)for(var o=0,p=Math.min(n.length,1+2*k.length),l=0;l<p;l++){var q={};do{var r=[{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(j=0;j<r.length&&(q={x:k[o].x+r[j].dx,y:k[o].y+r[j].dy},null!=util.lookForUnit(q));j++)q={x:-1,y:-1};o=(o+1)%k.length}while(-1==q.x);n[l].x=q.x,n[l].y=q.y,this.units.push(util.createUnit(n[l]))}this.score=0,this.wave=1,this.enemyCount=a.attack,this.enemyWaveSize=constant.waveInitSize,this.enemyNextWaveCount=constant.waveInitSize,this.enemyWaveCount=0,this.enemyArrivalTurn=constant.startArrival,this.pausedGame=!1},rendered:function(){this.initializedGame||(this.initGame(),this.canvas.hasNode().style.MozTransform="scale("+this.zoom+")",this.canvas.hasNode().style.MozTransformOrigin="0 0",this.canvas.hasNode().style.zoom=this.zoom)},resize:function(){var a=document.querySelector(".keyboard-set").id,b=document.getElementById(a),c=window.getComputedStyle(b),d=c.width;wsize=document.body.clientWidth,d=d.slice(0,-2),d=parseInt(d),wsize-=d,ratio=wsize/1e3,this.zoom=Math.max(ratio,.3),this.zoom=Math.min(this.zoom,1),this.$.gamebox.setStyle("max-height: "+this.zoom*constant.areaHeight+"px;"),this.canvas.hasNode().style.MozTransform="scale("+this.zoom+")",this.canvas.hasNode().style.zoom=this.zoom},cacheLoaded:function(){},draw:function(){var a=this.canvas.hasNode().getContext("2d");a.clearRect(0,0,this.canvas.attributes.width,this.canvas.attributes.height);for(var b=document.getElementById("grass"),c=document.getElementById("trees"),d=document.getElementById("mountain"),e=document.getElementById("water"),f=0;f<constant.boardHeight;f++)for(var g=0;g<constant.boardWidth;g++){a.save(),a.translate(g*constant.tileSize,f*constant.tileSize),a.drawImage(b,0,0);var h=this.game[f][g];h==constant.tileTrees?a.drawImage(c,0,0):h==constant.tileMountain?a.drawImage(d,0,0):h==constant.tileWater&&a.drawImage(e,0,0),a.restore()}if(this.endOfGame){var i=this.win?document.getElementById("endgame_victory"):document.getElementById("endgame_defeat");a.save(),a.translate((constant.areaWidth-constant.endGameWidth)/2,(constant.areaHeight-constant.endGameHeight)/2),a.drawImage(i,0,0),a.restore(),this.waitForClick||(sound.play(this.win?"audio/mission_completed":"audio/mission_failed",!0),this.waitForClick=!0)}else{for(var f=0;f<this.units.length;f++)this.units[f].draw(a);var j=document.getElementById("target");a.save(),a.translate(this.targetpos.x*constant.tileSize,this.targetpos.y*constant.tileSize),a.drawImage(j,0,0),a.restore()}},keyPressed:function(a,b){var c=b.charCode;if(!this.endOfGame)if(c>=48&&c<=57){var d=this.$.lcd.getValue();d.length==this.$.lcd.getSize()&&(d=d.substr(1)),d+=String.fromCharCode(c),this.$.lcd.setValue(d)}else if(45==c)this.$.lcd.setValue("-");else if(32==c){var e=util.lookForValue(this.$.lcd.getValue().replace(/ /g,""));if(0!=e.length)for(var f=0;f<e.length;f++)util.processFight(null,e[f],constant.userPower),this.targetpos.x=e[f].x,this.targetpos.y=e[f].y;else sound.play("audio/missed");this.$.lcd.setValue("")}},virtkeyPressed:function(a){var b=a.getSrc().replace(".svg",""),c=b.substr("images/key_".length,b.indexOf("key_"));"fire"==c?this.keyPressed(null,{charCode:32}):this.keyPressed(null,{charCode:48+parseInt(c)})},goHome:function(){if(this.waitForClick)return void this.gameClick();play=null,window.clearInterval(this.loopTimer),app.init(),app.playTheme(),app.renderInto(document.getElementById("board"))},gameClick:function(){this.endOfGame&&(window.clearInterval(this.loopTimer),this.win&&(preferences.levels[this.level].completed=!0,app.nextMission(),app.save()),app.init(),app.renderInto(document.getElementById("board")));var a=document.documentElement.clientWidth,b=document.documentElement.clientHeight,c=Math.floor(a/2),d=Math.floor((b+constant.pubHeight)/2),e=mouse.position.x-c,f=mouse.position.y-d,g=Math.abs(e),h=Math.abs(f);if(g>=0&&g<constant.fireZoneWidth&&h>=0&&h<constant.fireZoneHeight){var i=util.lookForUnit(this.targetpos);return void(null!=i&&util.processFight(null,i))}g>h?(dx=e>0?1:-1,dy=0):(dx=0,dy=f>0?1:-1);var j=this.targetpos.x+dx,k=this.targetpos.y+dy;j<0||j==constant.boardWidth||k<0||k==constant.boardHeight||(this.targetpos.x=j,this.targetpos.y=k)},gameLoopTick:function(){if(!this.pausedGame){for(var a=[],b=[],c=0,d=0,e=0;e<this.units.length;e++){var f=this.units[e],g=-1!=f.getCurrentImage().indexOf("red");f.power>0?(a.push(f),0==util.getUnitType(f)&&(b[c++]=f),g&&d++):g&&(this.enemyNextWaveCount--,this.score+=util.unitPowers[util.getUnitType(f)])}if(this.units=a,this.endOfGame=0==c||0==d&&0==this.enemyCount,this.win=c>0,this.resize(),!this.endOfGame){if(0==this.enemyNextWaveCount)this.wave++,this.enemyWaveSize+=2,this.enemyWaveCount=0,this.enemyNextWaveCount=this.enemyWaveSize,this.enemyArrivalTurn=constant.startArrival;else if(this.enemyWaveCount!=this.enemyWaveSize)if(0==this.enemyArrivalTurn&&this.enemyCount>0){var h=enyo.bind(this,"badEngine"),f=util.createUnit({type:util.randomUnit(this.currentlevel.stats),color:"red",heading:0,engine:h,x:constant.boardWidth-1,y:util.random(constant.boardHeight)});f.value=this.currentlevel.generator(),this.units.push(f),this.enemyCount=this.enemyCount-1,this.enemyWaveCount++,this.enemyArrivalTurn=constant.startArrival}else this.enemyArrivalTurn=this.enemyArrivalTurn-1;for(var e=0;e<this.units.length;e++){var i=this.units[e].engine;null!=i&&i(this.units[e],b)}}this.draw(),enyo.platform.android&&"http"!=document.location.protocol.substr(0,4)&&(document.getElementById("acanvas").style.display="none",document.getElementById("acanvas").offsetHeight,document.getElementById("acanvas").style.display="block"),this.$.wave.setContent(String("0000"+this.wave).slice(-4)),this.$.score.setContent(String("0000"+this.score).slice(-4))}},goodEngine:function(a,b){var c=util.lookForOpponent(a);if(null!=c)return a.heading=c.heading,void util.processFight(a,c.unit)},badEngine:function(a,b){var c=util.lookForOpponent(a);if(null!=c)return a.heading=c.heading,void util.processFight(a,c.unit);var d=util.nearestUnit(a,b);if(null!=d){var e=a.x-d.x,f=a.y-d.y;Math.abs(e)>Math.abs(f)?a.heading=e>0?0:2:a.heading=f>0?1:3}for(var g=util.nextPositionOnHeading(a);!util.isValidPosition(g,a);)a.heading=util.random(4),g=util.nextPositionOnHeading(a);g=util.nextPositionOnHeading(a),a.x=g.x,a.y=g.y}});