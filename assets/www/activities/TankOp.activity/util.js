var util={moves:[{dx:-1,dy:0},{dx:0,dy:-1},{dx:1,dy:0},{dx:0,dy:1}],unitTypes:["hq","soldier","tank","canon","helo"]};util.unitPowers=[constant.powerHq,constant.powerSoldier,constant.powerTank,constant.powerCanon,constant.powerHelo],util.unitStats=[constant.statHq,constant.statSoldier,constant.statTank,constant.statCanon,constant.statHelo],util.explosionsImages=["explosion_1","explosion_2","explosion_3","explosion_4","explosion_5","explosion_6","explosion_7"],util.createMap=function(t){for(var n=[],e=0,o=0;o<constant.boardHeight;o++){for(var i=[],r=0;r<constant.boardWidth;r++){var l=constant.tileEmpty,a=t[e];"O"==a?l=constant.tileWater:"H"==a?l=constant.tileTrees:"^"==a&&(l=constant.tileMountain),i.push(l),e++}n.push(i)}return n},util.createUnit=function(t){for(var n="blue"==t.color?2:0,e=0,o=0;o<util.unitTypes.length;o++)util.unitTypes[o]==t.type&&(e=util.unitPowers[o]);for(var i=t.type+"_"+t.color;null!=util.lookForUnit(t);)t.x=t.x+1;return new Sprite({x:t.x,y:t.y,heading:n,power:e,engine:t.engine,images:"hq"==t.type?[i]:[i+"_0",i+"_1",i+"_2",i+"_3"]})},util.createUnits=function(t){for(var n=[],e=0;e<t.length;e++)n.push(util.createUnit(t[e]));return n},util.isValidPosition=function(t,n){if(t.x<0||t.x==constant.boardWidth||t.y<0||t.y==constant.boardHeight)return!1;var e=play.game[t.y][t.x],o=util.getUnitType(n);if(4==o)return!0;if(e==constant.tileEmpty)return!0;if(0==o)return e==constant.tileEmpty;if(e==constant.tileTrees)return 1==o;if(e==constant.tileWater)return 1==o;var i=util.lookForUnit(t);return null!=i&&i==n},util.nextPositionOnHeading=function(t){return{x:t.x+util.moves[t.heading].dx,y:t.y+util.moves[t.heading].dy}},util.lookForUnit=function(t){for(var n=0;n<play.units.length;n++)if(play.units[n].x==t.x&&play.units[n].y==t.y)return play.units[n];return null},util.lookForValue=function(t){for(var n=[],e=0;e<play.units.length;e++)void 0!==play.units[e].value&&play.units[e].value.result==t&&n.push(play.units[e]);return n},util.lookForOpponent=function(t){for(var n=-1!=t.getCurrentImage().indexOf("red")?"blue":"red",e=0;e<util.moves.length;e++){var o={x:t.x+util.moves[e].dx,y:t.y+util.moves[e].dy},i=util.lookForUnit(o);if(null!=i&&-1!=i.getCurrentImage().indexOf(n))return{heading:e,unit:i}}return null},util.getUnitType=function(t){for(var n=t.getCurrentImage(),e=0;e<util.unitTypes.length;e++)if(-1!=n.indexOf(util.unitTypes[e]))return e;return-1},util.couldBeat=function(t,n){var e=util.getUnitType(t),o=util.getUnitType(n);return 1==e&&o==util.unitTypes.length-1||e>=o},util.processFight=function(t,n,e){(null==t||util.couldBeat(t,n))&&(n.power=n.power-(void 0!==e?e:1),util.doExplosion(n))},util.doExplosion=function(t){var n=0;sound.play("audio/explosion");var e=window.setInterval((function(){if(n==util.explosionsImages.length||app.endOfGame)window.clearInterval(e);else{var o=play.canvas.hasNode().getContext("2d"),i=document.getElementById(util.explosionsImages[n]);enyo.platform.android&&"http"!=document.location.protocol.substr(0,4)||(o.save(),o.translate(t.x*constant.tileSize,t.y*constant.tileSize),o.drawImage(i,0,0),o.restore()),n++}}),constant.explosionInterval)},util.getUrlParameter=function(t){var n=RegExp("[?&]"+t+"=([^&]*)").exec(window.location.search);return n&&decodeURIComponent(n[1].replace(/\+/g," "))},util.random=function(t){return Math.floor(Math.random()*t)},util.randomUnit=function(t){for(var n=util.random(10),e=util.unitStats.length-1;e>0;e--)if(n>=t[e])return util.unitTypes[e]},util.nearestUnit=function(t,n){for(var e=-1,o=constant.boardWidth*constant.boardHeight,i=0;i<n.length;i++){var r=Math.abs(n[i].x-t.x)+Math.abs(n[i].y-t.y);r<o&&(e=i,o=r)}return-1!=e?n[e]:null};