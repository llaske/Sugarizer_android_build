var currentview="ListView";define(["sugar-web/activity/activity","sugar-web/env","sugar-web/datastore","webL10n","tutorial"],(function(e,t,n,a,i){requirejs(["domReady!"],(function(o){e.setup();var l=new THREE.Scene,d=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),r=new THREE.WebGLRenderer({preserveDrawingBuffer:!0}),s=new THREE.TrackballControls(d,r.domElement);s.target.set(0,0,0);var c,u=["Name","Type","Year","Mass","Temperature","Moons","Radius","SunDistance"],m=planets,p=document.getElementById("planets-list"),E=document.getElementById("planet-container"),y=document.getElementById("planet-display"),g=document.getElementById("planet-info"),v=document.getElementById("planet-pos"),b=document.getElementById("canvas"),h=-96,w=!1,f=document.createElement("div");f.id="back-button",f.title="Back to Planet List",E.appendChild(f),E.style.display="none",document.getElementById("rotation-button").style.display="none",document.getElementById("info-button").style.display="none",document.getElementById("image-button").style.display="none",document.getElementById("list-button").style.display="none";var B=[!1,null,!0,!0];function initPlanet(e,t,i,o,c,m,h,T){var I,H,L=!0,R=!0,M="images/"+e.toLowerCase()+"map.jpg",P=(new THREE.TextureLoader).load(M),S=new THREE.SphereGeometry(2,32,32),k=new THREE.MeshPhongMaterial({map:P,shininess:5}),D=new THREE.DirectionalLight(16777215),x=new THREE.Group,C=new THREE.Mesh(S,k);if("Earth"===e){var j="images/"+e.toLowerCase()+"spec.png",z="images/"+e.toLowerCase()+"cloudmap.jpg",V=(new THREE.TextureLoader).load(z),N=new THREE.SphereGeometry(2.03,32,32),W=new THREE.MeshPhongMaterial({map:V,side:THREE.DoubleSide,opacity:.5,transparent:!0,depthWrite:!1}),G=new THREE.Mesh(N,W);k.specularMap=(new THREE.TextureLoader).load(j),k.specular=new THREE.Color("grey"),C.add(G)}if("Saturn"===e||"Uranus"===e){var O="images/"+e.toLowerCase()+"ringcolor.jpg",A=(new THREE.TextureLoader).load(O);if("Saturn"===e){var U=(q=new THREE.RingBufferGeometry(2.5,5,40)).attributes.position,Y=new THREE.Vector3;for(let e=0;e<U.count;e++)Y.fromBufferAttribute(U,e),q.attributes.uv.setXY(e,Y.length()<4?0:1,1)}else var q=new THREE.RingBufferGeometry(3.8,4,40);var F=new THREE.MeshPhongMaterial({map:A,side:THREE.DoubleSide,opacity:.6,transparent:!0,depthWrite:!0}),J=new THREE.Mesh(q,F)}if("Terrestrial"===t){var X="images/"+e.toLowerCase()+"bump.png";k.bumpMap=(new THREE.TextureLoader).load(X),k.bumpScale=.1}document.getElementById("rotation-button").classList.add("active"),document.getElementById("info-button").classList.add("active"),createPlanet=function(){for(R=!0,I=!0,b.style.backgroundColor="#c0c0c0",E.style.display="block",p.style.display="none",document.getElementById("planet-info").style.display="block",y.style.width="60%",document.getElementById("position-button").style.display="none",document.getElementById("list-button").style.display="none",document.getElementById("rotation-button").style.display="inline",document.getElementById("info-button").style.display="inline",document.getElementById("image-button").style.display="inline",currentview="ExploreView",B[0]=!1,B[1]=e;l.children.length>0;)l.remove(l.children[0]);r.setSize(y.clientWidth,window.innerHeight),y.appendChild(r.domElement),D.position.set(1,1,5),x.add(D),l.add(x),l.add(C),l.add(d),"Saturn"!==e&&"Uranus"!==e||(J.rotation.x="Saturn"===e?33:0,l.add(J)),d.position.z=5;for(var v=0;v<8;v++){var w=document.createElement("div");w.id=u[v],w.className="info",g.appendChild(w)}document.getElementById("Name").innerHTML="<p>"+a.get("PlanetName")+"</br>"+a.get(e)+"</p>",document.getElementById("Type").innerHTML="<p>"+a.get("PlanetType")+"</br>"+t+"</p>",document.getElementById("Year").innerHTML="<p>"+a.get("YearLength")+"</br>"+a.get("EarthDays",{year:i})+"</p>",document.getElementById("Mass").innerHTML="<p>"+a.get("Mass")+"</br>"+o+"</p>",document.getElementById("Temperature").innerHTML="<p>"+a.get("SurfaceTemperature")+"</br>"+c+"</p>",document.getElementById("Moons").innerHTML="<p>"+a.get("NumberOfMoons")+"</br>"+m+"</p>",document.getElementById("Radius").innerHTML="<p>"+a.get("PlanetRadius")+"</br>"+h+"</p>",document.getElementById("SunDistance").innerHTML="<p>"+a.get("SunDistance")+"</br>"+T+"</p>",saveImage=function(){var t=r.domElement.toDataURL(),a={mimetype:"image/jpeg",title:"Image "+e,activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};H&&n.create(a,(function(){console.log("export done."),H=!1}),t)},animatePlanet=function(){resizePlanet(r)&&(d.aspect=y.clientWidth/y.clientHeight,d.updateProjectionMatrix(),s.handleResize()),!0===I?requestAnimationFrame(animatePlanet):cancelAnimationFrame(animatePlanet),!0===R&&(C.rotation.y+=.1*Math.PI/180),s.update(),x.quaternion.copy(d.quaternion),r.render(l,d)},resizePlanet=function(e){var t=y.clientWidth,n=y.clientHeight,a=y.width!==t||y.height!==n;return a&&e.setSize(t,n),a},document.getElementById("image-button").addEventListener("click",(function(){H=!0,saveImage()})),animatePlanet()},!1!==w?createPlanet():document.getElementById("planet-"+e).addEventListener("click",createPlanet),document.getElementById("rotation-button").addEventListener("click",(function(){R?(R=!1,document.getElementById("rotation-button").classList.remove("active")):(R=!0,document.getElementById("rotation-button").classList.add("active")),B[2]=R})),document.getElementById("info-button").addEventListener("click",(function(){L?(document.getElementById("planet-info").style.display="none",y.style.width="100%",r.setSize(window.innerWidth,window.innerHeight),resizePlanet(r),L=!1,document.getElementById("info-button").classList.remove("active")):(document.getElementById("planet-info").style.display="block",y.style.width="60%",r.setSize(y.clientWidth,window.innerHeight),resizePlanet(r),L=!0,document.getElementById("info-button").classList.add("active")),B[3]=L,y.appendChild(r.domElement)})),f.addEventListener("click",(function(){if(B=[!1,null,!0,!0],R=!1,I=!1,R=!0,L=!0,E.style.display="none",b.style.backgroundColor="black",document.getElementById("rotation-button").classList.add("active"),document.getElementById("info-button").classList.add("active"),document.getElementById("rotation-button").style.display="none",document.getElementById("info-button").style.display="none",document.getElementById("image-button").style.display="none",w&&"ExploreView"===currentview){for(;l.children.length>0;)l.remove(l.children[0]);document.getElementById("position-button").style.display="none",p.style.display="none",v.style.display="block",document.getElementById("position-button").click(),w=!1}else if("PositionView"!=currentview){for(;l.children.length>0;)l.remove(l.children[0]);currentview="ListView",document.getElementById("position-button").style.display="inline",p.style.display="block"}}))}function initPosition(e,t,n,i,o,d,s,u){var m,E,y="images/"+e.toLowerCase()+"map.jpg";"Sun"===e?m=45:"Mercury"===e?m=.5:"Venus"===e||"Earth"===e?m=2:"Mars"===e?m=1:"Jupiter"===e||"Saturn"===e?m=10:"Uranus"!==e&&"Neptune"!=e||(m=5);var g=(new THREE.TextureLoader).load(y),b=new THREE.SphereGeometry(m,32,32),f=new THREE.MeshBasicMaterial({map:g,side:THREE.DoubleSide}),T=new THREE.DirectionalLight(16777215),I=new THREE.Group,H=new THREE.Mesh(b,f);if("Earth"===e){var L="images/"+e.toLowerCase()+"spec.png",R="images/"+e.toLowerCase()+"cloudmap.jpg",M=(new THREE.TextureLoader).load(R),P=new THREE.SphereGeometry(m,32,32),S=new THREE.MeshPhongMaterial({map:M,side:THREE.DoubleSide,opacity:.2,transparent:!0,depthWrite:!1}),k=new THREE.Mesh(P,S);f.specularMap=(new THREE.TextureLoader).load(L),f.specular=new THREE.Color("grey"),H.add(k)}if("Saturn"===e||"Uranus"===e){var D="images/"+e.toLowerCase()+"ringcolor.jpg",x=(new THREE.TextureLoader).load(D);if("Saturn"===e){var C=(z=new THREE.RingBufferGeometry(12,23,64)).attributes.position,j=new THREE.Vector3;for(let e=0;e<C.count;e++)j.fromBufferAttribute(C,e),z.attributes.uv.setXY(e,j.length()<14?0:1,1)}else var z=new THREE.RingBufferGeometry(9,10,64);var V=new THREE.MeshPhongMaterial({map:x,side:THREE.DoubleSide,opacity:.4,transparent:!0}),N=new THREE.Mesh(z,V)}if("Terrestrial"===t){var W="images/"+e.toLowerCase()+"bump.png";f.bumpMap=(new THREE.TextureLoader).load(W),f.bumpScale=.1;var G=document.createElement("div");G.id="div-"+e,G.className="planet-div",v.appendChild(G),document.getElementById("div-"+e).style.padding="2%",document.getElementById("div-"+e).style.marginLeft=c-1+"%"}if("Sun"!==e){var O=document.createElement("div");O.id="new-name-"+e,O.className="planet-new-name",O.innerHTML=a.get(e),v.appendChild(O),document.getElementById("new-name-"+e).style.marginLeft=c+"%"}"Sun"===e?h+=-27:"Mercury"===e?(h+=52,c+=7.7):"Venus"===e||"Earth"===e||"Mars"===e?(h+=15,c+=8.3):"Uranus"===e?(h+=35,c+=11):"Neptune"===e?(h+=20,c+=15):"Jupiter"===e?(h+=17,c+=18.5):(h+=36,c+=18),H.position.x=h,H.name=e,H.userData.typeOfPlanet=t,H.userData.year=n,H.userData.mass=i,H.userData.temperature=o,H.userData.moons=d,H.userData.radius=s,H.userData.sunDistance=u,document.getElementById("position-button").addEventListener("click",(function(a){var c=v.clientHeight/v.clientWidth,m=new THREE.OrthographicCamera(-.25,.25,5*c/20,5*c/-20,-500,2e3),y=new THREE.Raycaster,g=new THREE.Vector2;document.getElementById("position-button").style.display="none",p.style.display="none",v.style.display="block",document.getElementById("list-button").style.display="inline",currentview="PositionView",B[0]=!0,E=!0,l.add(H),r.setSize(v.clientWidth,v.clientHeight),v.appendChild(r.domElement),T.position.set(1,-.5,5),I.add(T),l.add(I),l.add(H),l.add(m),"Saturn"!==e&&"Uranus"!==e||("Saturn"===e?(N.rotation.x=30,N.position.x=27):(N.rotation.x=0,N.position.x=62),l.add(N)),m.zoom=.0026,m.updateProjectionMatrix(),clickMesh=function(e){e.preventDefault(),canvasBounds=v.getBoundingClientRect(),"ontouchend"in r.domElement?(g.x=(e.changedTouches[0].clientX-canvasBounds.left)/(canvasBounds.right-canvasBounds.left)*2-1,g.y=-(e.changedTouches[0].clientY-canvasBounds.top)/(canvasBounds.bottom-canvasBounds.top)*2+1):(g.x=(e.clientX-canvasBounds.left)/(canvasBounds.right-canvasBounds.left)*2-1,g.y=-(e.clientY-canvasBounds.top)/(canvasBounds.bottom-canvasBounds.top)*2+1),y.setFromCamera(g,m);for(var t=y.intersectObjects(l.children),n=0;n<t.length;n++)"Sun"!==t[n].object.name&&(v.style.display="none",w=!0,initPlanet(t[n].object.name,t[n].object.userData.typeOfPlanet,t[n].object.userData.year,t[n].object.userData.mass,t[n].object.userData.temperature,t[n].object.userData.moons,t[n].object.userData.radius,t[n].object.userData.sunDistance))},animatePlanet=function(){if(resizePlanet(r)){var e=v.clientHeight/v.clientWidth;m.left=-.25,m.right=.25,m.top=5*e/20,m.bottom=-5*e/20,m.updateProjectionMatrix()}m.updateProjectionMatrix(),!0===E&&"ExploreView"!==currentview&&requestAnimationFrame(animatePlanet),r.render(l,m)},resizePlanet=function(e){var t=v.clientWidth,n=v.clientHeight,a=v.width!==t||v.height!==n;return a&&e.setSize(v.clientWidth,v.clientHeight),a},"ontouchend"in r.domElement?r.domElement.addEventListener("touchend",clickMesh,!1):r.domElement.addEventListener("click",clickMesh,!1),null!==document.getElementById("div-"+e)&&document.getElementById("div-"+e).addEventListener("click",(function(){v.style.display="none",currentview="ExploreView",w=!0,E&&initPlanet(e,t,n,i,o,d,s,u),E=!1})),animatePlanet()})),document.getElementById("list-button").addEventListener("click",(function(){currentview="ListView",B[1]=null,B[0]=!1,E=!1}))}v.style.display="none",t.getEnvironment((function(t,n){n;var i="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18.getUILanguage():navigator.language,o=n.user?n.user.language:i;a.language.code=o,initPosition("Sun","Star",null),window.addEventListener("localized",(function(){p.innerHTML="",v.innerHTML="",c=11.5;for(var e=0;e<m.length;e++){var t=document.createElement("div");t.id="planet-"+m[e].name,t.className="planets",p.appendChild(t);var n=document.createElement("img");n.className=m[e].name,n.src="images/"+m[e].name.toLowerCase()+".jpg",n.width=240,document.getElementById("planet-"+m[e].name).appendChild(n);var i=document.createElement("span");i.className="name",i.innerHTML="<p>"+a.get(m[e].name)+"</p>",document.getElementById("planet-"+m[e].name).appendChild(i),initPlanet(m[e].name,m[e].type,m[e].year,m[e].mass,m[e].temperature,m[e].moons,m[e].radius,m[e].distancefromsun),initPosition(m[e].name,m[e].type,m[e].year,m[e].mass,m[e].temperature,m[e].moons,m[e].radius,m[e].distancefromsun),document.getElementById("fullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.opacity=0,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible",document.getElementById("back-button").style.bottom="740px"})),document.getElementById("unfullscreen-button").addEventListener("click",(function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden",document.getElementById("back-button").style.bottom="685px"})),document.getElementById("list-button").addEventListener("click",(function(){p.style.display="block",v.style.display="none",w=!1,h=-80,requestAnim=!1,c=3.5,document.getElementById("position-button").style.display="inline",document.getElementById("list-button").style.display="none"}))}})),n.objectId?(console.log("Existing instance"),e.getDatastoreObject().loadAsText((function(e,t,n){null==e&&null!=n&&(B=JSON.parse(n),console.log(B[1]),!0===B[0]&&"ExploreView"!==currentview?document.getElementById("position-button").click():null!==B[1]&&(document.getElementById("planet-"+B[1]).click(),!1===B[2]&&document.getElementById("rotation-button").click(),!1===B[3]&&document.getElementById("info-button").click()))}))):console.log("New instance")})),document.getElementById("help-button").addEventListener("click",(function(e){i.start()})),document.getElementById("stop-button").addEventListener("click",(function(t){console.log("writing...");var n=JSON.stringify(B);e.getDatastoreObject().setDataAsText(n),e.getDatastoreObject().save((function(e){null===e?console.log("writing done"):console.log("writing failed")}))}))}))}));