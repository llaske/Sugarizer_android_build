define(["settings","sugar-web/datastore"],(function(t,e){var n={};return n.isActive=function(){if(!t.getOptions("stats"))return!1;if(!t.isConnected())return!1;var e=t.getServer();return!!(e&&e.options&&e.options.statistics)},n.trace=function(a,s,o,r){if(n.isActive()){console.log("Sugarizer: "+s+"("+a+", "+o+", "+r+")");var i=function computeStat(e,n,a,s){var o={};return o.user_id=t.getNetworkId(),o.user_agent=navigator.userAgent,o.timestamp=(new Date).getTime(),o.client_type=util.getClientName(),o.event_source="Sugarizer",o.event_object=e,o.event_action=n,o.event_label=a,o.event_value=s,o}(a,s,o,r),u=e.localStorage.getValue("sugar_stats");u||(u=[]),u.push(i),e.localStorage.setValue("sugar_stats",u),u.length>=constant.statPackageSize&&(console.log("Sugarizer: Send stat to server"),function sendStats(t,e,n){myserver.postStats(t,(function(){e&&e()}),(function(t,e){20!=t.code&&console.log("Error sending log"),n&&n()}))}(u,(function(){e.localStorage.setValue("sugar_stats",[])}),(function(){u.length>constant.statMaxLocalSize&&(u.shift(),e.localStorage.setValue("sugar_stats",u))})))}},n}));