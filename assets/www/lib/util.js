/*! Sugarizer 2020-03-14 */
define(["webL10n","sugar-web/datastore","FileSaver"],function(a,b,c){function d(a){var b=a+1;return b==xoPalette.colors.length&&(b=0),b}function e(a){var b=a-1;return b<0&&(b=xoPalette.colors.length-1),b}function f(){QRScanner.cancelScan(function(a){}),o&&o(),document.getElementById("toolbar").style.opacity=1,document.getElementById("canvas").style.opacity=1,document.getElementById("qrclosebutton").style.visibility="hidden",document.getElementById("qrswitchbutton").style.visibility="hidden";var a=document.getElementById("qrbackground");a.parentNode.removeChild(a)}function g(){n=(n+1)%2,QRScanner.useCamera(n,function(a,b){})}function h(a){return a>64&&a<91?a-65:a>96&&a<123?a-71:a>47&&a<58?a+4:43===a?62:47===a?63:0}function i(a,b){for(var c,d,e=a.replace(/[^A-Za-z0-9\+\/]/g,""),f=e.length,g=b?Math.ceil((3*f+1>>2)/b)*b:3*f+1>>2,i=new Uint8Array(g),j=0,k=0,l=0;l<f;l++)if(d=3&l,j|=h(e.charCodeAt(l))<<6*(3-d),3===d||f-l==1){for(c=0;c<3&&k<g;c++,k++)i[k]=j>>>(16>>>c&24)&255;j=0}return i}function j(a,b,c){if("application/json"==a.type){var d=null;try{if(d=JSON.parse(b),!d.metadata)return void c(a.name,-1)}catch(b){return void c(a.name,-1)}c(a.name,0,d.metadata,d.text)}else{var e="";"text/plain"!=a.type&&"application/pdf"!=a.type&&"application/msword"!=a.type&&"application/vnd.oasis.opendocument.text"!=a.type&&(e="org.olpcfrance.MediaViewerActivity");var f={title:a.name,mimetype:a.type,activity:e};c(a.name,0,f,b)}}function k(a,b){for(var c=a,d=atob(b.substr(b.indexOf(";base64,")+8)),e=[],f=0;f<d.length;f+=1024){for(var g=d.slice(f,f+1024),h=new Array(g.length),i=0;i<g.length;i++)h[i]=g.charCodeAt(i);var j=new Uint8Array(h);e.push(j)}return new Blob(e,{type:c})}var l={},m=[{name:"Years",factor:30758400},{name:"Months",factor:2592e3},{name:"Weeks",factor:604800},{name:"Days",factor:86400},{name:"Hours",factor:3600},{name:"Minutes",factor:60}];l.timestampToElapsedString=function(b,c,d){for(var e=d?"_short":"",f=0,g="",h=((new Date).getTime()-b)/1e3,i=0;i<m.length;i++){var j=m[i].factor,k=Math.floor(h/j);if(k>0&&(f>0&&(g+=","),g+=" "+k+" "+(1==k?a.get(m[i].name+"_one"+e):a.get(m[i].name+"_other"+e)),h-=k*j),""!=g&&(f+=1),f==c)break}return 0==f?a.get("SecondsAgo"+e):a.get("Ago"+e,{time:g})},l.getDateRange=function(a){if(void 0===a)return null;var b=new Date,c=new Date(b.getFullYear(),b.getMonth(),b.getDate()).getTime();b=b.getTime();var d=null;switch(a){case 1:d={min:c,max:b};break;case 2:d={min:c-864e5,max:b};break;case 3:d={min:c-6048e5,max:b};break;case 4:d={min:c-2592e6,max:b};break;case 5:d={min:c-307584e5,max:b}}return d},l.getNextStrokeColor=function(a){var b=l.getColorIndex(a);if(-1==b)return a;for(var c=d(b);xoPalette.colors[c].stroke!=xoPalette.colors[b].stroke;)c=d(c);return xoPalette.colors[c]},l.getPreviousStrokeColor=function(a){var b=l.getColorIndex(a);if(-1==b)return a;for(var c=e(b);xoPalette.colors[c].stroke!=xoPalette.colors[b].stroke;)c=e(c);return xoPalette.colors[c]},l.getNextFillColor=function(a){var b=l.getColorIndex(a);if(-1==b)return a;for(var c=d(b);xoPalette.colors[c].fill!=xoPalette.colors[b].fill;)c=d(c);return xoPalette.colors[c]},l.getPreviousFillColor=function(a){var b=l.getColorIndex(a);if(-1==b)return a;for(var c=e(b);xoPalette.colors[c].fill!=xoPalette.colors[b].fill;)c=e(c);return xoPalette.colors[c]},l.getColorIndex=function(a){for(var b=0;b<xoPalette.colors.length;b++)if(a.stroke==xoPalette.colors[b].stroke&&a.fill==xoPalette.colors[b].fill)return b;return-1},l.getCanvasCenter=function(){var a=document.getElementById("canvas")||document.getElementById("body"),b=a.offsetHeight,c=a.offsetWidth,d=parseFloat(b)/2;return{x:parseFloat(c)/2,y:d,dx:c,dy:b}},l.computeMargin=function(a,b){var c=document.getElementById("canvas"),d=c.offsetHeight,e=c.offsetWidth,f=a.width<=e?a.width:b.width*e,g=a.height<=d?a.height:b.height*d;return{left:parseFloat(e-f)/2,top:parseFloat(d-g)/2,width:f,height:g}},l.cursorIsInside=function(a){var b=document.getElementById(a.getAttribute("id"));if(null==b)return!1;var c={};for(c.x=b.offsetLeft,c.y=b.offsetTop,c.dx=b.clientWidth,c.dy=b.clientHeight;b.offsetParent&&(c.x=c.x+b.offsetParent.offsetLeft,c.y=c.y+b.offsetParent.offsetTop-b.scrollTop,b!=document.getElementsByTagName("body")[0]);)b=b.offsetParent;return mouse.position.x>=c.x&&mouse.position.x<=c.x+c.dx&&mouse.position.y>=c.y&&mouse.position.y<=c.y+c.dy},l.setToolbar=function(a){toolbar!=a&&(toolbar=a,a.renderInto(document.getElementById("toolbar")))},l.getBrowserName=function(){return enyo.platform.android?"Android":enyo.platform.androidChrome?"Chrome Android":enyo.platform.androidFirefox?"Firefox Android":enyo.platform.ie?"IE":enyo.platform.ios?"iOS":enyo.platform.webos?"webOS":enyo.platform.blackberry?"BlackBerry":enyo.platform.safari?"Safari":enyo.platform.chrome?"Chrome":enyo.platform.firefox?"Firefox":"Unknown"},l.getBrowserVersion=function(){return enyo.platform.android?enyo.platform.android:enyo.platform.androidChrome?enyo.platform.androidChrome:enyo.platform.androidFirefox?enyo.platform.androidFirefox:enyo.platform.ie?enyo.platform.ie:enyo.platform.ios?enyo.platform.ios:enyo.platform.webos?enyo.platform.webos:enyo.platform.blackberry?enyo.platform.blackberry:enyo.platform.safari?enyo.platform.safari:enyo.platform.chrome?enyo.platform.chrome:enyo.platform.firefox?enyo.platform.firefox:"?"},l.getClientType=function(){return"http"!=document.location.protocol.substr(0,4)||constant.noServerMode?constant.appType:constant.webAppType},l.getClientName=function(){return this.getClientType()==constant.webAppType?"Web App":"App"},l.getCurrentServerUrl=function(){var a=window.location.href;return a.substring(0,a.lastIndexOf("/"))},l.getMinPasswordSize=function(){var a=constant.minPasswordSize,b=preferences.getServer();return b&&b.options&&b.options["min-password-size"]&&(a=b.options["min-password-size"]),a},l.restartApp=function(){location.reload()},l.vibrate=function(){(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios)&&l.getClientType()==constant.appType&&navigator.vibrate&&navigator.vibrate(30)},l.hideNativeToolbar=function(){!enyo.platform.android&&!enyo.platform.androidChrome||l.getClientType()!=constant.appType||constant.noServerMode||AndroidFullScreen.immersiveMode(function(){},function(){})},l.handleVolumeButtons=function(){if((enyo.platform.android||enyo.platform.androidChrome)&&l.getClientType()==constant.appType&&!constant.noServerMode){var a=function(){};document.addEventListener("volumeupbutton",function(){cordova.plugins.VolumeControl.getVolume(function(b){var c=parseInt(b);c<100&&cordova.plugins.VolumeControl.setVolume(c+10,a,a)},a)},!1),document.addEventListener("volumedownbutton",function(){cordova.plugins.VolumeControl.getVolume(function(b){var c=parseInt(b);c>0&&cordova.plugins.VolumeControl.setVolume(c-1,a,a)},a)},!1)}},l.updateFavicon=function(){var a=preferences.getColor(),b=preferences.getName();a||(a={stroke:"#005FE4",fill:"#FF2B34"}),document.title=(b&&"<No name>"!=b?b+" - ":"")+"Sugarizer";var c='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\t\t<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" width="16" height="16" version="1.0" >\t\t<g transform="translate(37.943468,-309.4636)">\t\t<g transform="matrix(0.05011994,0,0,0.05012004,-41.76673,299.66011)" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-opacity:1">\t\t<circle transform="matrix(0.969697,0,0,0.969697,-90.879133,125.06999)" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-width:20.62502098;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" cx="331.38321" cy="134.2677" r="51.220825" />\t\t<path d="m 290.55846,302.47333 -58.81513,59.20058 -59.39461,-59.40024 c -25.19828,-24.48771 -62.7038,13.33148 -38.1941,37.98719 l 60.04451,58.9817 -59.73639,59.42563 c -24.83976,24.97559 12.91592,63.26505 37.66786,37.75282 l 59.95799,-59.28294 58.75912,59.21065 c 24.50656,25.09065 62.43116,-13.00322 37.87956,-37.85772 l -59.24184,-59.02842 58.87574,-59.14782 c 25.1689,-25.18348 -13.0489,-62.75154 -37.80271,-37.84143 z" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-width:20.00002098;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" />\t\t</g></g></svg>'.replace(new RegExp("&fill_color;","g"),a.fill).replace(new RegExp("&stroke_color;","g"),a.stroke),d=(new XMLSerializer).serializeToString((new DOMParser).parseFromString(c,"text/xml")),e=document.createElement("canvas");e.width=16,e.height=16;var f=e.getContext("2d"),g=new Image;g.src="data:image/svg+xml;base64,"+btoa(d),g.onload=function(){f.drawImage(g,0,0);var a=document.querySelector("link[rel*='icon']")||document.createElement("link");a.type="image/x-icon",a.rel="shortcut icon",a.href=e.toDataURL("image/x-icon"),document.getElementsByTagName("head")[0].appendChild(a)}};var n=0,o=null;return l.scanQRCode=function(a,b){n=0,o=b;var c=document.createElement("div");c.className="first-qrbackground",c.id="qrbackground",document.getElementById("canvas").appendChild(c),document.getElementById("qrclosebutton").addEventListener("click",f),document.getElementById("qrswitchbutton").addEventListener("click",g),QRScanner.prepare(function(b,c){document.getElementById("toolbar").style.opacity=0,document.getElementById("canvas").style.opacity=0,document.getElementById("qrclosebutton").style.visibility="visible",document.getElementById("qrswitchbutton").style.visibility="visible",b?console.log("Error "+b):(QRScanner.scan(function(b,c){b?console.log("Error "+b):a&&a(c),l.cancelScan(),document.getElementById("toolbar").style.opacity=1,document.getElementById("canvas").style.opacity=1,document.getElementById("qrclosebutton").style.visibility="hidden",document.getElementById("qrswitchbutton").style.visibility="hidden"}),QRScanner.show(function(a){}))})},l.cancelScan=function(){QRScanner.cancelScan(function(a){}),o=null,document.getElementById("qrclosebutton").removeEventListener("click",f),document.getElementById("qrswitchbutton").removeEventListener("click",g);var a=document.getElementById("qrbackground");a&&a.parentNode.removeChild(a)},l.writeFile=function(a,b,d,e){var f=null,g=null,h="json",j=b.title,k="application/json";b&&b.mimetype?(k=b.mimetype,"image/jpeg"==k?h="jpg":"image/png"==k?h="png":"audio/wav"==k?h="wav":"video/webm"==k?h="webm":"audio/mp3"==k||"audio/mpeg"==k?h="mp3":"video/mp4"==k?h="mp4":"text/plain"==k?(h="txt",g=d):h="application/pdf"==k?"pdf":"application/msword"==k?"doc":"application/vnd.oasis.opendocument.text"==k?"odt":"bin",f=i(d.substr(d.indexOf("base64,")+7)).buffer):g=JSON.stringify({metadata:b,text:d});var m=j;if(-1==m.indexOf("."+h)&&(m+="."+h),l.getClientType()==constant.appType&&(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios||enyo.platform.electron)&&!constant.noServerMode)if(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios){var n=cordova.file.externalRootDirectory;enyo.platform.ios&&(n=cordova.file.documentsDirectory),window.resolveLocalFileSystemURL(n,function(a){a.getFile(m,{create:!0},function(a){a&&a.createWriter(function(b){if(b.seek(b.length),g){var c=new Blob([g],{type:k});b.write(c)}else b.write(f);e(null,a.fullPath)},function(a){e(error.code,null)})})})}else{var o=require("electron"),p=o.ipcRenderer;p.removeAllListeners("save-file-reply"),p.send("save-file-dialog",{directory:a,filename:m,mimetype:k,extension:h,text:g,binary:d}),p.on("save-file-reply",function(a,b){e(b.err,b.filename)})}else{var q=new Blob(g?[g]:[f],{type:k});c.saveAs(q,m),e(null,m)}},l.loadFile=function(a,b){if(l.getClientType()==constant.webAppType||constant.noServerMode||l.getClientType()==constant.appType&&!enyo.platform.android&&!enyo.platform.androidChrome&&!enyo.platform.ios&&!enyo.platform.electron){if(-1==["application/json","image/jpeg","image/png","audio/wav","video/webm","audio/mp3","audio/mpeg","video/mp4","text/plain","application/pdf","application/msword","application/vnd.oasis.opendocument.text"].indexOf(a.type))return void b(a.name,-1);var c=new FileReader;c.onload=function(){j(a,c.result,b)},"application/json"==a.type||"text/plain"==a.type?c.readAsText(a):c.readAsDataURL(a)}},l.askDirectory=function(a){if(!(l.getClientType()!=constant.appType||enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios)){var b=require("electron"),c=b.ipcRenderer;c.removeAllListeners("choose-directory-reply"),c.send("choose-directory-dialog"),c.on("choose-directory-reply",function(b,c){a(c)})}},l.askFiles=function(b){if(l.getClientType()==constant.appType)if(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios){if(!window.cordova&&!window.PhoneGap)return;var c={type:"image/jpeg",name:a.get("ImageFromDevice")},d=function(a){j(c,"data:image/jpeg;base64,"+a,b)},e=function(a){};navigator.camera.getPicture(d,e,{quality:50,targetWidth:640,targetHeight:480,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY})}else{var f=require("electron"),g=f.ipcRenderer;g.removeAllListeners("choose-files-reply"),g.send("choose-files-dialog"),g.on("choose-files-reply",function(a,c,d,e){d?b(c.name,-1):j(c,e,b)})}},l.openAsDocument=function(b,c){if(l.getClientType()!=constant.webAppType&&(l.getClientType()!=constant.appType||enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios||enyo.platform.electron)&&!constant.noServerMode)if(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios){var d=cordova.file.externalCacheDirectory;enyo.platform.ios&&(d=cordova.file.documentsDirectory),window.resolveLocalFileSystemURL(d,function(e){e.getFile("sugarizertemp",{create:!0,exclusive:!1},function(e){e&&e.createWriter(function(e){e.seek(e.length);var f=k(b.mimetype,c);if(e.write(f),enyo.platform.ios){var g=new FileTransfer,h="cdvfile://localhost/temporary/sugarizer/sugarizertemp";g.download(d+"sugarizertemp",h,function(b){cordova.InAppBrowser.open(h,"_blank","location=no,closebuttoncaption="+a.get("Ok"))},function(a){console.log("download error code "+a.code)},!0)}else{var i=d+"sugarizertemp";cordova.InAppBrowser.open(i,"_system")}},function(a){})})})}else{var e=require("electron"),f=e.shell,g=e.ipcRenderer;g.removeAllListeners("create-tempfile-reply"),g.send("create-tempfile",{metadata:b,text:c}),g.on("create-tempfile-reply",function(a,b){f.openExternal("file://"+b)})}else{var h=k(b.mimetype,c),i=URL.createObjectURL(h);window.open(i,"_blank")}},l.openAsUrl=function(b){if(l.getClientType()!=constant.webAppType&&(l.getClientType()!=constant.appType||enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios||enyo.platform.electron)&&!constant.noServerMode)if(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios)enyo.platform.ios?cordova.InAppBrowser.open(b,"_blank","location=no,closebuttoncaption="+a.get("Ok")):cordova.InAppBrowser.open(b,"_system");else{var c=require("electron"),d=c.shell;d.openExternal(b)}else window.open(b,"_blank")},l.cleanDatastore=function(a,c){var d=b.find(),e=0,f=function(a){++e<d.length?b.remove(d[e].objectId,f):c&&c()};preferences.reset(a),d.length?b.remove(d[e].objectId,f):c&&c()},l.computeDatastoreSize=function(a){var c=0;for(var d in localStorage){var e=2*localStorage[d].length;isNaN(e)||(c+=e)}for(var f=b.find(),g=0;g<f.length;g++){var h=f[g],i=h.metadata.textsize;i&&(c+=i)}a&&a({bytes:c,formatted:l.formatSize(c)})},l.formatSize=function(b){return formated=b>1048576?(b/1024/1024).toFixed()+" "+a.get("ShortForMegabytes"):b>1024?(b/1024).toFixed()+" "+a.get("ShortForKilobytes"):0==b?"-":b+" "+a.get("ShortForBytes"),formated},l.quitApp=function(){new Sugar.EE({mode:2}).renderInto(document.getElementById("body")),window.setTimeout(function(){"undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime&&window.top.postMessage("","*"),window.close(),/Edge/.test(navigator.userAgent)||(window.open("","_self",""),window.close()),navigator&&(navigator.app?navigator.app.exitApp():navigator.device&&navigator.device.exitApp())},constant.timerBeforeClose)},l});