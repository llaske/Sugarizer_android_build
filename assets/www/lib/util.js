define(["webL10n","sugar-web/datastore","FileSaver"],(function(e,o,t){var n={},r=[{name:"Years",factor:30758400},{name:"Months",factor:2592e3},{name:"Weeks",factor:604800},{name:"Days",factor:86400},{name:"Hours",factor:3600},{name:"Minutes",factor:60}];function nextIndex(e){var o=e+1;return o==xoPalette.colors.length&&(o=0),o}function previousIndex(e){var o=e-1;return o<0&&(o=xoPalette.colors.length-1),o}n.timestampToElapsedString=function(o,t,n){for(var a=n?"_short":"",i=0,l="",c=((new Date).getTime()-o)/1e3,s=0;s<r.length;s++){var d=r[s].factor,p=Math.floor(c/d);if(p>0&&(i>0&&(l+=","),l+=" "+p+" "+(1==p?e.get(r[s].name+"_one"+a):e.get(r[s].name+"_other"+a)),c-=p*d),""!=l&&(i+=1),i==t)break}return 0==i?e.get("SecondsAgo"+a):e.get("Ago"+a,{time:l})},n.getDateRange=function(e){if(void 0===e)return null;var o=new Date,t=new Date(o.getFullYear(),o.getMonth(),o.getDate()).getTime();o=o.getTime();var n=null;switch(e){case 1:n={min:t,max:o};break;case 2:n={min:t-864e5,max:o};break;case 3:n={min:t-6048e5,max:o};break;case 4:n={min:t-2592e6,max:o};break;case 5:n={min:t-307584e5,max:o}}return n},n.getNextStrokeColor=function(e){var o=n.getColorIndex(e);if(-1==o)return e;for(var t=nextIndex(o);xoPalette.colors[t].stroke!=xoPalette.colors[o].stroke;)t=nextIndex(t);return xoPalette.colors[t]},n.getPreviousStrokeColor=function(e){var o=n.getColorIndex(e);if(-1==o)return e;for(var t=previousIndex(o);xoPalette.colors[t].stroke!=xoPalette.colors[o].stroke;)t=previousIndex(t);return xoPalette.colors[t]},n.getNextFillColor=function(e){var o=n.getColorIndex(e);if(-1==o)return e;for(var t=nextIndex(o);xoPalette.colors[t].fill!=xoPalette.colors[o].fill;)t=nextIndex(t);return xoPalette.colors[t]},n.getPreviousFillColor=function(e){var o=n.getColorIndex(e);if(-1==o)return e;for(var t=previousIndex(o);xoPalette.colors[t].fill!=xoPalette.colors[o].fill;)t=previousIndex(t);return xoPalette.colors[t]},n.getColorIndex=function(e){for(var o=0;o<xoPalette.colors.length;o++)if(e.stroke==xoPalette.colors[o].stroke&&e.fill==xoPalette.colors[o].fill)return o;return-1},n.getCanvasCenter=function(){var e=document.getElementById("canvas")||document.getElementById("body"),o=e.offsetHeight,t=e.offsetWidth,n=parseFloat(o)/2;return{x:parseFloat(t)/2,y:n,dx:t,dy:o}},n.computeMargin=function(e,o){var t=document.getElementById("canvas"),n=t.offsetHeight,r=t.offsetWidth,a=e.width<=r?e.width:o.width*r,i=e.height<=n?e.height:o.height*n;return{left:parseFloat(r-a)/2,top:parseFloat(n-i)/2,width:a,height:i}},n.cursorIsInside=function(e){var o=document.getElementById(e.getAttribute("id"));if(null==o)return!1;var t={};for(t.x=o.offsetLeft,t.y=o.offsetTop,t.dx=o.clientWidth,t.dy=o.clientHeight;o.offsetParent&&(t.x=t.x+o.offsetParent.offsetLeft,t.y=t.y+o.offsetParent.offsetTop-o.scrollTop,o!=document.getElementsByTagName("body")[0]);)o=o.offsetParent;return mouse.position.x>=t.x&&mouse.position.x<=t.x+t.dx&&mouse.position.y>=t.y&&mouse.position.y<=t.y+t.dy},n.setToolbar=function(e){toolbar!=e&&(toolbar=e,e.renderInto(document.getElementById("toolbar")))},n.getBrowserName=function(){return enyo.platform.android?"Android":enyo.platform.androidChrome?"Chrome Android":enyo.platform.androidFirefox?"Firefox Android":enyo.platform.ie?"IE":enyo.platform.ios?"iOS":enyo.platform.webos?"webOS":enyo.platform.blackberry?"BlackBerry":enyo.platform.safari?"Safari":enyo.platform.chrome?"Chrome":enyo.platform.firefox?"Firefox":"Unknown"},n.getBrowserVersion=function(){return enyo.platform.android?enyo.platform.android:enyo.platform.androidChrome?enyo.platform.androidChrome:enyo.platform.androidFirefox?enyo.platform.androidFirefox:enyo.platform.ie?enyo.platform.ie:enyo.platform.ios?enyo.platform.ios:enyo.platform.webos?enyo.platform.webos:enyo.platform.blackberry?enyo.platform.blackberry:enyo.platform.safari?enyo.platform.safari:enyo.platform.chrome?enyo.platform.chrome:enyo.platform.firefox?enyo.platform.firefox:"?"},n.getClientType=function(){return"http"!=document.location.protocol.substr(0,4)||constant.noServerMode?constant.appType:constant.webAppType},n.getClientName=function(){return this.getClientType()==constant.webAppType?"Web App":"App"},n.getCurrentServerUrl=function(){var e=window.location.href;return e.substring(0,e.lastIndexOf("/"))},n.getMinPasswordSize=function(){var e=constant.minPasswordSize,o=preferences.getServer();return o&&o.options&&o.options["min-password-size"]&&(e=o.options["min-password-size"]),e},n.restartApp=function(){location.assign(location.href.replace(/\?rst=?./g,"?rst=0"))},n.vibrate=function(){(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios)&&n.getClientType()==constant.appType&&navigator.vibrate&&navigator.vibrate(30)},n.hideNativeToolbar=function(){!enyo.platform.android&&!enyo.platform.androidChrome||n.getClientType()!=constant.appType||constant.noServerMode||AndroidFullScreen.immersiveMode((function(){}),(function(){}))},n.handleVolumeButtons=function(){if((enyo.platform.android||enyo.platform.androidChrome)&&n.getClientType()==constant.appType&&!constant.noServerMode){var emptyf=function(){};document.addEventListener("volumeupbutton",(function(){cordova.plugins.VolumeControl.getVolume((function(e){var o=parseInt(e);o<100&&cordova.plugins.VolumeControl.setVolume(o+10,emptyf,emptyf)}),emptyf)}),!1),document.addEventListener("volumedownbutton",(function(){cordova.plugins.VolumeControl.getVolume((function(e){var o=parseInt(e);o>0&&cordova.plugins.VolumeControl.setVolume(o-1,emptyf,emptyf)}),emptyf)}),!1)}};n.updateFavicon=function(){var e=preferences.getColor(),o=preferences.getName();e||(e={stroke:"#005FE4",fill:"#FF2B34"}),document.title=(o&&"<No name>"!=o?o+" - ":"")+"Sugarizer";var t='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\t\t<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" width="16" height="16" version="1.0" >\t\t<g transform="translate(37.943468,-309.4636)">\t\t<g transform="matrix(0.05011994,0,0,0.05012004,-41.76673,299.66011)" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-opacity:1">\t\t<circle transform="matrix(0.969697,0,0,0.969697,-90.879133,125.06999)" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-width:20.62502098;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" cx="331.38321" cy="134.2677" r="51.220825" />\t\t<path d="m 290.55846,302.47333 -58.81513,59.20058 -59.39461,-59.40024 c -25.19828,-24.48771 -62.7038,13.33148 -38.1941,37.98719 l 60.04451,58.9817 -59.73639,59.42563 c -24.83976,24.97559 12.91592,63.26505 37.66786,37.75282 l 59.95799,-59.28294 58.75912,59.21065 c 24.50656,25.09065 62.43116,-13.00322 37.87956,-37.85772 l -59.24184,-59.02842 58.87574,-59.14782 c 25.1689,-25.18348 -13.0489,-62.75154 -37.80271,-37.84143 z" style="fill:&fill_color;;fill-opacity:1;stroke:&stroke_color;;stroke-width:20.00002098;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" />\t\t</g></g></svg>'.replace(new RegExp("&fill_color;","g"),e.fill).replace(new RegExp("&stroke_color;","g"),e.stroke),n=(new XMLSerializer).serializeToString((new DOMParser).parseFromString(t,"text/xml")),r=document.createElement("canvas");r.width=16,r.height=16;var a=r.getContext("2d"),i=new Image;i.src="data:image/svg+xml;base64,"+btoa(n),i.onload=function(){a.drawImage(i,0,0);var e=document.querySelector("link[rel*='icon']")||document.createElement("link");e.type="image/x-icon",e.rel="shortcut icon",e.href=r.toDataURL("image/x-icon"),document.getElementsByTagName("head")[0].appendChild(e)}};var a=0,i=null;function closeQR(){QRScanner.cancelScan((function(e){})),i&&i(),document.getElementById("toolbar").style.opacity=1,document.getElementById("canvas").style.opacity=1,document.getElementById("qrclosebutton").style.visibility="hidden",document.getElementById("qrswitchbutton").style.visibility="hidden";var e=document.getElementById("qrbackground");e.parentNode.removeChild(e)}function switchCameraQR(){a=(a+1)%2,QRScanner.useCamera(a,(function(e,o){}))}function writeFileToStore(e,o,t){if("application/json"==e.type){var n=null;try{if(!(n=JSON.parse(o)).metadata)return void t(e.name,-1)}catch(o){return void t(e.name,-1)}t(e.name,0,n.metadata,n.text)}else{var r="";"text/plain"!=e.type&&"application/pdf"!=e.type&&"application/msword"!=e.type&&"application/vnd.oasis.opendocument.text"!=e.type&&(r="org.olpcfrance.MediaViewerActivity");var a={title:e.name,mimetype:e.type,activity:r};t(e.name,0,a,o)}}function base64toBlob(e,o){for(var t=e,n=atob(o.substr(o.indexOf(";base64,")+8)),r=[],a=0;a<n.length;a+=1024){for(var i=n.slice(a,a+1024),l=new Array(i.length),c=0;c<i.length;c++)l[c]=i.charCodeAt(c);var s=new Uint8Array(l);r.push(s)}return new Blob(r,{type:t})}return n.scanQRCode=function(e,o){a=0,i=o;var t=document.createElement("div");t.className="first-qrbackground",t.id="qrbackground",document.getElementById("canvas").appendChild(t),document.getElementById("qrclosebutton").addEventListener("click",closeQR),document.getElementById("qrswitchbutton").addEventListener("click",switchCameraQR),QRScanner.prepare((function(o,t){document.getElementById("toolbar").style.opacity=0,document.getElementById("canvas").style.opacity=0,document.getElementById("qrclosebutton").style.visibility="visible",document.getElementById("qrswitchbutton").style.visibility="visible",o?console.log("Error "+o):(QRScanner.scan((function(o,t){o?console.log("Error "+o):e&&e(t),n.cancelScan(),document.getElementById("toolbar").style.opacity=1,document.getElementById("canvas").style.opacity=1,document.getElementById("qrclosebutton").style.visibility="hidden",document.getElementById("qrswitchbutton").style.visibility="hidden"})),QRScanner.show((function(e){})))}))},n.cancelScan=function(){QRScanner.cancelScan((function(e){})),i=null,document.getElementById("qrclosebutton").removeEventListener("click",closeQR),document.getElementById("qrswitchbutton").removeEventListener("click",switchCameraQR);var e=document.getElementById("qrbackground");e&&e.parentNode.removeChild(e)},n.writeFile=function(e,o,r,a){var i=null,l=null,c="json",s=o.title,d="application/json";o&&o.mimetype?("image/jpeg"==(d=o.mimetype)?c="jpg":"image/png"==d?c="png":"audio/wav"==d?c="wav":"video/webm"==d?c="webm":"audio/mp3"==d||"audio/mpeg"==d?c="mp3":"video/mp4"==d?c="mp4":"text/plain"==d?(c="txt",l=r):c="application/pdf"==d?"pdf":"application/msword"==d?"doc":"application/vnd.oasis.opendocument.text"==d?"odt":"bin",i=function base64DecToArr(e,o){for(var t,n,r,a=e.replace(/[^A-Za-z0-9\+\/]/g,""),i=a.length,l=o?Math.ceil((3*i+1>>2)/o)*o:3*i+1>>2,c=new Uint8Array(l),s=0,d=0,p=0;p<i;p++)if(n=3&p,s|=((r=a.charCodeAt(p))>64&&r<91?r-65:r>96&&r<123?r-71:r>47&&r<58?r+4:43===r?62:47===r?63:0)<<6*(3-n),3===n||i-p==1){for(t=0;t<3&&d<l;t++,d++)c[d]=s>>>(16>>>t&24)&255;s=0}return c}(r.substr(r.indexOf("base64,")+7)).buffer):l=JSON.stringify({metadata:o,text:r});var p=s;if(-1==p.indexOf("."+c)&&(p+="."+c),n.getClientType()==constant.appType&&(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios||enyo.platform.electron)&&!constant.noServerMode)if(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios){var m=cordova.file.externalRootDirectory;enyo.platform.ios&&(m=cordova.file.documentsDirectory),window.resolveLocalFileSystemURL(m,(function(e){e.getFile(p,{create:!0},(function(e){e&&e.createWriter((function(o){if(o.seek(o.length),l){var t=new Blob([l],{type:d});o.write(t)}else o.write(i);a(null,e.fullPath)}),(function(e){a(error.code,null)}))}))}))}else{var f=require("electron").ipcRenderer;f.removeAllListeners("save-file-reply"),f.send("save-file-dialog",{directory:e,filename:p,mimetype:d,extension:c,text:l,binary:r}),f.on("save-file-reply",(function(e,o){a(o.err,o.filename)}))}else{var u=new Blob(l?[l]:[i],{type:d});t.saveAs(u,p),a(null,p)}},n.loadFile=function(e,o){if(n.getClientType()==constant.webAppType||constant.noServerMode||n.getClientType()==constant.appType&&!enyo.platform.android&&!enyo.platform.androidChrome&&!enyo.platform.ios&&!enyo.platform.electron){if(-1==["application/json","image/jpeg","image/png","audio/wav","video/webm","audio/mp3","audio/mpeg","video/mp4","text/plain","application/pdf","application/msword","application/vnd.oasis.opendocument.text"].indexOf(e.type))return void o(e.name,-1);var t=new FileReader;t.onload=function(){writeFileToStore(e,t.result,o)},"application/json"==e.type||"text/plain"==e.type?t.readAsText(e):t.readAsDataURL(e)}},n.askDirectory=function(e){if(!(n.getClientType()!=constant.appType||enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios)){var o=require("electron").ipcRenderer;o.removeAllListeners("choose-directory-reply"),o.send("choose-directory-dialog"),o.on("choose-directory-reply",(function(o,t){e(t)}))}},n.askFiles=function(o){if(n.getClientType()==constant.appType)if(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios){if(!window.cordova&&!window.PhoneGap)return;var t={type:"image/jpeg",name:e.get("ImageFromDevice")};navigator.camera.getPicture((function(e){writeFileToStore(t,"data:image/jpeg;base64,"+e,o)}),(function(e){}),{quality:50,targetWidth:640,targetHeight:480,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY})}else{var r=require("electron").ipcRenderer;r.removeAllListeners("choose-files-reply"),r.send("choose-files-dialog"),r.on("choose-files-reply",(function(e,t,n,r){n?o(t.name,-1):writeFileToStore(t,r,o)}))}},n.openAsDocument=function(o,t){if(n.getClientType()!=constant.webAppType&&(n.getClientType()!=constant.appType||enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios||enyo.platform.electron)&&!constant.noServerMode)if(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios){var r=cordova.file.externalCacheDirectory;enyo.platform.ios&&(r=cordova.file.documentsDirectory),window.resolveLocalFileSystemURL(r,(function(n){n.getFile("sugarizertemp",{create:!0,exclusive:!1},(function(n){n&&n.createWriter((function(n){n.seek(n.length);var a=base64toBlob(o.mimetype,t);if(n.write(a),enyo.platform.ios){var i=new FileTransfer,l="cdvfile://localhost/temporary/sugarizer/sugarizertemp";i.download(r+"sugarizertemp",l,(function(o){cordova.InAppBrowser.open(l,"_blank","location=no,closebuttoncaption="+e.get("Ok"))}),(function(e){console.log("download error code "+e.code)}),!0)}else{var c=r+"sugarizertemp";cordova.InAppBrowser.open(c,"_system")}}),(function(e){}))}))}))}else{var a=require("electron"),i=a.shell,l=a.ipcRenderer;l.removeAllListeners("create-tempfile-reply"),l.send("create-tempfile",{metadata:o,text:t}),l.on("create-tempfile-reply",(function(e,o){i.openExternal("file://"+o)}))}else{var c=base64toBlob(o.mimetype,t),s=URL.createObjectURL(c);window.open(s,"_blank")}},n.openAsUrl=function(o){if(n.getClientType()!=constant.webAppType&&(n.getClientType()!=constant.appType||enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios||enyo.platform.electron)&&!constant.noServerMode)if(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios)enyo.platform.ios?cordova.InAppBrowser.open(o,"_blank","location=no,closebuttoncaption="+e.get("Ok")):cordova.InAppBrowser.open(o,"_system");else{require("electron").shell.openExternal(o)}else window.open(o,"_blank")},n.cleanDatastore=function(e,t){var n=o.find(),r=0,removeOneEntry=function(e){++r<n.length?o.remove(n[r].objectId,removeOneEntry):t&&t()};preferences.reset(e),n.length?o.remove(n[r].objectId,removeOneEntry):t&&t()},n.computeDatastoreSize=function(e){var t=0;for(var r in localStorage){var a=2*localStorage[r].length;isNaN(a)||(t+=a)}for(var i=o.find(),l=0;l<i.length;l++){var c=i[l].metadata.textsize;c&&(t+=c)}e&&e({bytes:t,formatted:n.formatSize(t)})},n.formatSize=function(o){return formated=o>1048576?(o/1024/1024).toFixed()+" "+e.get("ShortForMegabytes"):o>1024?(o/1024).toFixed()+" "+e.get("ShortForKilobytes"):0==o?"-":o+" "+e.get("ShortForBytes"),formated},n.quitApp=function(){new Sugar.EE({mode:2}).renderInto(document.getElementById("body")),window.setTimeout((function(){"undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime&&window.top.postMessage("","*"),window.close(),/Edge/.test(navigator.userAgent)||(window.open("","_self",""),window.close()),navigator&&(navigator.app?navigator.app.exitApp():navigator.device&&navigator.device.exitApp())}),constant.timerBeforeClose)},n}));