var iconLib,xoPalette,radioButtonsGroup,datastore,presence,l10n,preferences,util,myserver,humane,tutorial,stats,autosync,app=null,toolbar=null,mouse={position:{x:-1,y:-1}},isFirstLaunch=!1;enyo.kind({name:"Sugar.Desktop",kind:enyo.Control,components:[{name:"owner",kind:"Sugar.Icon",size:constant.sizeOwner,colorized:!0,classes:"owner-icon",showing:!1},{name:"journal",kind:"Sugar.Icon",size:constant.sizeJournal,ontap:"showJournal",classes:"journal-icon",showing:!1},{name:"desktop",showing:!0,onresize:"resize",components:[]},{name:"otherview",showing:!0,components:[]},{name:"activityPopup",kind:"Sugar.Popup",showing:!1},{name:"activities",kind:"enyo.WebService",onResponse:"queryActivitiesResponse",onError:"queryActivitiesFail"}],create:function(){app=this,this.inherited(arguments),this.timer=null,this.otherview=null,this.toolbar=null,util.setToolbar(this.getToolbar()),this.$.owner.setIcon({directory:"icons",icon:"owner-icon.svg"}),this.$.owner.setPopupShow(enyo.bind(this,"showBuddyPopup")),this.$.owner.setPopupHide(enyo.bind(this,"hideBuddyPopup")),this.$.journal.setIcon({directory:"icons",icon:"activity-journal.svg"}),this.restrictedModeInfo={start:0},util.hideNativeToolbar(),this.tutorialActivity=null,this.loadJournal(),this.isJournalFull=!1,this.testJournalSize(),util.getClientType()==constant.webAppType?(this.$.activities.setUrl(myserver.getActivitiesUrl()),myserver.getActivities(enyo.bind(this,"queryActivitiesResponse"),enyo.bind(this,"queryActivitiesFail"))):(this.$.activities.setUrl(constant.staticInitActivitiesURL),this.$.activities.send());var t=preferences.isConnected();if(this.getToolbar().showServerWarning(!t),t){var e=this;this.connectToServer((function(t){e.getToolbar()&&e.getToolbar().showServerWarning&&e.getToolbar().showServerWarning(!t)}))}else util.updateFavicon();e=this;window.setTimeout((function(){isFirstLaunch&&e.getToolbar().startTutorial()}),constant.timerBeforeTutorial)},loadJournal:function(){this.journal=datastore.find(),this.journal=this.journal.sort((function(t,e){return parseInt(e.metadata.timestamp)-parseInt(t.metadata.timestamp)}))},testJournalSize:function(){this.isJournalFull=!1;var t=this;util.computeDatastoreSize((function(e){e.remain/e.total*100<constant.minStorageSizePercent&&(console.log("WARNING: Journal almost full"),t.isJournalFull=!0)}))},queryActivitiesResponse:function(t,e){var i=preferences.getActivities();if(null==i||0==i.length?(preferences.setActivities(e.data),preferences.save()):preferences.updateActivities(e.data)&&preferences.save(),preferences.updateEntries(),window.sugarizerOS){var n=this;sugarizerOS.isAppCacheReady((function(t){t.ready||humane.create({timeout:5e3,baseCls:"humane-libnotify"}).log(l10n.get("Loading"))})),sugarizerOS.initActivitiesPreferences((function(){n.init()})),sugarizerOS.isWifiEnabled((function(t){0!=t&&sugarizerOS.scanWifi()})),sugarizerOS.popupTimer=0,2!=sugarizerOS.launches||sugarizerOS.launcherPackageName==sugarizerOS.packageName||sugarizerOS.isSetup||(this.doResetLauncher(),sugarizerOS.putInt("IS_SETUP",1))}else this.init()},queryActivitiesFail:function(t,e){-1!=this.$.activities.getUrl().indexOf(constant.dynamicInitActivitiesURL)?(console.log("WARNING: Backoffice not responding, use static list"),this.$.activities.setUrl(constant.staticInitActivitiesURL),this.$.activities.send()):console.log("Error loading init activities")},connectToServer:function(t){var e=preferences.getNetworkId(),i=this;myserver.getUser(e,(function(e,n){var o=preferences.merge(n);util.updateFavicon(),o?(preferences.save(),util.restartApp()):i.currentView==constant.journalView&&i.otherview.updateNetworkBar(),presence.joinNetwork((function(t,e){t&&console.log("WARNING: Can't connect to presence server"),presence.onConnectionClosed((function(t){console.log("Disconnected");var e=l10n.get(4999==t.code?"YouveGotDisconnectedAutomatically":"YouveGotDisconnected");e&&humane.log(e)}))})),t(!0),autosync.synchronizeJournal((function(t){if(t){setTimeout((function(){var t=l10n.get("RetrievingJournal");t&&humane.log(t)}),100);var e=i.getToolbar();e.showSync&&e.showSync(!0)}}),(function(t,e,n){var o=i.getToolbar();o.showSync&&o.showSync(!1),t&&!n&&(i.loadJournal(),i.testJournalSize(),preferences.updateEntries(),i.draw(),i.render())}))}),(function(){console.log("WARNING: Can't read network user settings"),t(!1)}))},getToolbar:function(){return null==this.toolbar&&(this.toolbar=new Sugar.DesktopToolbar),this.currentView!=constant.listView&&null!=this.otherview?this.otherview.getToolbar():this.toolbar},getPopup:function(){return this.$.activityPopup},init:function(){this.currentView=constant.radialView,preferences.getView()&&this.showView(preferences.getView()),this.draw()},localize:function(){this.otherview&&this.otherview.localize&&this.otherview.localize()},draw:function(){var t=[];enyo.forEach(this.$.desktop.getControls(),(function(e){t.push(e)}));for(var e=0;e<t.length;e++)t[e].destroy();this.tutorialActivity=null;var i=util.getCanvasCenter(),n=constant.iconSizeStandard,o=n*constant.iconSpacingFactor,s=n/2,r=i.dy<480?-12:0;this.$.owner.applyStyle("margin-left",i.x-constant.sizeOwner/2+"px"),this.$.owner.applyStyle("margin-top",i.y-constant.sizeOwner/2+"px"),this.$.journal.setColorized(this.journal.length>0),this.$.journal.applyStyle("margin-left",i.x-constant.sizeJournal/2+"px"),this.$.journal.applyStyle("margin-top",i.y+constant.sizeOwner-constant.sizeJournal+r+"px"),this.$.owner.setShowing(this.currentView==constant.radialView),this.$.journal.setShowing(this.currentView==constant.radialView);var a,c,l,u,h,d=preferences.getFavoritesActivities(),p=d.length,g=2*Math.PI,w=g*(a=c=Math.max(constant.ringMinRadiusSize,Math.min(i.x-n,i.y-n))),v=[];w/d.length>=constant.iconSpacingFactor*o?(u=h=!1,l=g/parseFloat(d.length)):this.hasRoomForSpiral(i,n,v)?(u=!0,h=!1,a=c=o*constant.ringInitSpaceFactor,l=g/(p=parseInt(g*a/o))):(h=!0,u=!1,p=parseInt(w/o)-1,this.restrictedModeInfo.count=p,this.restrictedModeInfo.length=d.length,l=g/parseFloat(p+1));var f=-Math.PI/2-l;for(e=0;e<d.length;e++){var m,y,b=d[e],S=f;if(u?(m=v[e].x,y=v[e].y):(f+=l,m=i.x+Math.cos(f)*a-s,y=i.y+Math.sin(f)*c-s),h){if(e<this.restrictedModeInfo.start){f=S;continue}if(e>0&&e==this.restrictedModeInfo.start){this.$.desktop.createComponent({kind:"Sugar.Icon",icon:{directory:"icons",icon:"activity-etc.svg",name:l10n.get("ListView")},size:n,x:m,y:y,ontap:"showPreviousRestrictedList"},{owner:this}).render();continue}if(e>=this.restrictedModeInfo.start+p-1&&this.restrictedModeInfo.start+p<d.length){this.$.desktop.createComponent({kind:"Sugar.Icon",icon:{directory:"icons",icon:"activity-etc.svg",name:l10n.get("ListView")},size:n,x:m,y:y,ontap:"showNextRestrictedList"},{owner:this}).render();break}}null!=b.type&&"native"==b.type&&(b.isNative=!0);var A=this.$.desktop.createComponent({kind:"Sugar.Icon",icon:b,size:n,x:m,y:y,colorized:void 0!==b.instances&&b.instances.length>0,colorizedColor:void 0!==b.instances&&b.instances.length>0&&b.instances[0].metadata.buddy_color?b.instances[0].metadata.buddy_color:null,ontap:"runMatchingActivity",popupShow:enyo.bind(this,"showActivityPopup"),popupHide:enyo.bind(this,"hideActivityPopup")},{owner:this});A.render(),this.tutorialActivity||(this.tutorialActivity=A)}},redraw:function(){this.draw(),this.currentView!=constant.radialView&&this.currentView!=constant.listView||this.filterActivities(),this.render()},resize:function(){this.noresize||this.redraw()},hasRoomForSpiral:function(t,e,i){for(var o=preferences.getFavoritesActivities().length,s=e*constant.iconSpacingFactor*constant.ringInitSpaceFactor,r=Math.sqrt(2*Math.pow(e,2))*constant.spiralInitSpaceFactor,a=Math.PI,c=2*Math.PI,l=e/2,u=r*constant.spiralSpaceFactor,h=0,d=0,p=t.dx,g=t.dy;o-- >0;){n=c*s/r,s+=u/n;var w=t.x-l+Math.sin(a)*s,v=t.y+Math.cos(a)*s-l;i.push({x:w,y:v}),h=Math.max(h,w+e),d=Math.max(d,v+e),p=Math.min(p,w),g=Math.min(g,v),a-=c/n}return h<=t.dx&&d<=t.dy-5&&p>=0&&g>=0},showPreviousRestrictedList:function(){this.getPopup().hidePopup();var t=this.restrictedModeInfo.start-this.restrictedModeInfo.count;t<0&&(t=0),this.restrictedModeInfo.start=t,this.draw()},showNextRestrictedList:function(){this.getPopup().hidePopup();var t=this.restrictedModeInfo.start+this.restrictedModeInfo.count-2;t>this.restrictedModeInfo.length-1||(t+this.restrictedModeInfo.count>this.restrictedModeInfo.length&&(t=this.restrictedModeInfo.length-this.restrictedModeInfo.count),this.restrictedModeInfo.start=t,this.draw())},showView:function(t){if(this.currentView!=t){var e=this.currentView;if(this.currentView=t,stats.trace(constant.viewNames[e],"change_view",constant.viewNames[t]),t==constant.radialView)return this.otherview=null,util.setToolbar(this.getToolbar()),toolbar.setActiveView(constant.radialView),this.$.otherview.hide(),this.$.desktop.show(),this.$.owner.show(),this.$.journal.show(),void this.clearView();if(this.$.owner.hide(),this.$.journal.hide(),this.$.desktop.hide(),this.clearView(),t==constant.listView){util.setToolbar(this.getToolbar());var i=toolbar.getSearchText().toLowerCase();toolbar.setActiveView(constant.listView),this.otherview=this.$.otherview.createComponent({kind:"Sugar.DesktopListView",activities:preferences.getActivitiesByName(i)})}else t==constant.journalView?(null!=this.timer&&(this.getPopup().hidePopup(),window.clearInterval(this.timer)),this.otherview=this.$.otherview.createComponent({kind:"Sugar.Journal",journal:this.journal}),util.setToolbar(this.otherview.getToolbar())):t==constant.neighborhoodView&&(this.otherview=this.$.otherview.createComponent({kind:"Sugar.NeighborhoodView"}),toolbar.setActiveView(constant.neighborhoodView),util.setToolbar(this.otherview.getToolbar()));this.$.otherview.show(),this.$.otherview.render()}},getView:function(){return this.currentView},clearView:function(){for(var t,e=this.$.otherview.getControls(),i=0;t=e[i];i++)t.destroy()},showListView:function(){this.showView(constant.listView)},rendered:function(){this.inherited(arguments),this.$.owner.colorize(preferences.getColor()),this.journal.length>0&&this.$.journal.colorize(preferences.getColor()),this.isJournalFull&&l10n.get("JournalAlmostFull")&&(humane.log(l10n.get("JournalAlmostFull")),this.isJournalFull=!1)},beforeHelp:function(){tutorial.setElement("owner",app.$.owner.getAttribute("id")),tutorial.setElement("journal",app.$.journal.getAttribute("id")),this.tutorialActivity&&tutorial.setElement("activity",this.tutorialActivity.getAttribute("id"))},runMatchingActivity:function(t){t.getDisabled()||this.getPopup().showing||(this.hideActivityPopup(t),util.vibrate(),this.runActivity(t.icon))},runActivity:function(t){util.vibrate();var e=tutorial.isLaunched()&&t.id==tutorial.activityId;preferences.runActivity(t,void 0,null,null,e),this.postRunActivity(t.isNative)},runOldActivity:function(t,e){this.getPopup().hidePopup(),util.vibrate();var i=tutorial.isLaunched()&&t.id==tutorial.activityId;preferences.runActivity(t,e.objectId,e.metadata.title,null,i)},runNewActivity:function(t){this.getPopup().hidePopup(),util.vibrate();var e=tutorial.isLaunched()&&t.id==tutorial.activityId;preferences.runActivity(t,null,null,null,e),this.postRunActivity(t.isNative)},postRunActivity:function(t){window.sugarizerOS&&t&&(sugarizerOS.popupTimer=new Date,this.loadJournal(),preferences.updateEntries(),this.draw())},showJournal:function(){this.showView(constant.journalView)},showActivityPopup:function(t){if(window.sugarizerOS){var e=new Date;if(sugarizerOS.popupTimer&&e.getTime()-sugarizerOS.popupTimer.getTime()<3e3)return;sugarizerOS.popupTimer=e}var i,n=t.icon;i=void 0!==n.instances&&n.instances.length>0&&void 0!==n.instances[0].metadata.title?n.instances[0].metadata.title:l10n.get("NameActivity",{name:n.name}),this.getPopup().setHeader({icon:n,colorized:void 0!==n.instances&&n.instances.length>0,colorizedColor:void 0!==n.instances&&n.instances.length>0&&n.instances[0].metadata.buddy_color?n.instances[0].metadata.buddy_color:null,name:n.name,title:i,action:enyo.bind(this,"runActivity"),data:[n,null]});var o=[];if(n.instances)for(var s=0;s<n.instances.length&&s<constant.maxPopupHistory;s++)o.push({icon:n,colorized:!0,colorizedColor:n.instances[s].metadata.buddy_color?n.instances[s].metadata.buddy_color:null,name:n.instances[s].metadata.title,action:enyo.bind(this,"runOldActivity"),data:[n,n.instances[s]]});this.getPopup().setItems(o),this.getPopup().setFooter([{icon:n,colorized:!1,name:l10n.get("StartNew"),action:enyo.bind(this,"runNewActivity"),data:[n,null]}]),this.getPopup().showPopup()},hideActivityPopup:function(t){return!this.getPopup().cursorIsInside()&&!t.cursorIsInside()&&(this.getPopup().hidePopup(),!0)},showBuddyPopup:function(t){this.getPopup().setHeader({icon:t.icon,colorized:!0,name:preferences.getName(),title:null,action:enyo.bind(this,"doSettings")}),this.getPopup().setItems(null);var e=[];e.push({icon:{directory:"icons",icon:"preferences-system.svg"},colorized:!1,name:l10n.get("MySettings"),action:enyo.bind(this,"doSettings"),data:null}),e.push({icon:{directory:"icons",icon:"system-shutdown.svg"},colorized:!1,name:l10n.get("Logoff"),action:enyo.bind(this,"doLogoff"),data:null}),enyo.platform.electron&&e.push({icon:{directory:"lib/sugar-web/graphics/icons/actions",icon:"activity-stop.svg"},colorized:!1,name:l10n.get("Quit"),action:enyo.bind(this,"doQuit"),data:null}),this.getPopup().setFooter(e),this.getPopup().showPopup()},hideBuddyPopup:function(t){return!this.getPopup().cursorIsInside()&&!t.cursorIsInside()&&(this.getPopup().hidePopup(),!0)},doLogoff:function(){stats.trace(constant.viewNames[this.getView()],"click","logoff"),this.getPopup().hidePopup(),!preferences.isConnected()||preferences.isConnected()&&!preferences.getOptions("sync")?(this.otherview=this.$.otherview.createComponent({kind:"Sugar.DialogWarningMessage"},{owner:this}),this.otherview.show()):util.cleanDatastore(null,(function(){util.restartApp()}))},doQuit:function(){stats.trace(constant.viewNames[this.getView()],"click","quit"),util.quitApp()},doSettings:function(){stats.trace(constant.viewNames[this.getView()],"click","my_settings"),this.getPopup().hidePopup(),this.otherview=this.$.otherview.createComponent({kind:"Sugar.DialogSettings"},{owner:this}),this.otherview.show()},doResetLauncher:function(){this.otherview=this.$.otherview.createComponent({kind:"Sugar.DialogSetLauncher"},{owner:this}),this.otherview.show()},filterActivities:function(){var t=toolbar.getSearchText().toLowerCase();enyo.forEach(this.$.desktop.getControls(),(function(e){e.setDisabled(-1==e.icon.name.toLowerCase().indexOf(t)&&0!=t.length)})),this.currentView==constant.listView&&this.otherview.setActivities(preferences.getActivitiesByName(t))}}),enyo.kind({name:"Sugar.DesktopToolbar",kind:enyo.Control,components:[{name:"searchtext",kind:"Sugar.SearchField",classes:"homeview-filter-text",onTextChanged:"filterActivities"},{name:"helpbutton",kind:"Button",classes:"toolbutton help-button",title:"Help",ontap:"startTutorial"},{name:"syncbutton",classes:"sync-button sync-home sync-gear sync-gear-home",showing:!1},{name:"offlinebutton",kind:"Button",classes:"toolbutton offline-button",title:"Not connected",ontap:"doServerSettings",showing:!1},{name:"radialbutton",kind:"Button",classes:"toolbutton view-radial-button active",title:"Home",ontap:"showRadialView"},{name:"neighborbutton",kind:"Button",classes:"toolbutton view-neighbor-button",title:"Home",ontap:"showNeighborView"},{name:"listbutton",kind:"Button",classes:"toolbutton view-list-button",title:"List",ontap:"showListView"}],create:function(){this.inherited(arguments),this.needRedraw=!1},rendered:function(){this.inherited(arguments),this.localize()},localize:function(){this.$.searchtext.setPlaceholder(l10n.get("SearchHome")),this.$.radialbutton.setNodeProperty("title",l10n.get("FavoritesView")),this.$.listbutton.setNodeProperty("title",l10n.get("ListView")),this.$.neighborbutton.setNodeProperty("title",l10n.get("NeighborhoodView")),this.$.helpbutton.setNodeProperty("title",l10n.get("Tutorial")),this.$.offlinebutton.setNodeProperty("title",l10n.get("NotConnected")),app.localize&&app.localize()},askRedraw:function(){this.needRedraw=!0},getSearchText:function(){return this.$.searchtext.getText()},setSearchText:function(t){this.$.searchtext.setText(t)},setActiveView:function(t){t==constant.radialView?(this.$.radialbutton.addRemoveClass("active",!0),this.$.neighborbutton.addRemoveClass("active",!1),this.$.listbutton.addRemoveClass("active",!1)):t==constant.listView?(this.$.radialbutton.addRemoveClass("active",!1),this.$.neighborbutton.addRemoveClass("active",!1),this.$.listbutton.addRemoveClass("active",!0)):t==constant.neighborhoodView&&(this.$.radialbutton.addRemoveClass("active",!1),this.$.neighborbutton.addRemoveClass("active",!0),this.$.listbutton.addRemoveClass("active",!1))},filterActivities:function(){stats.trace(constant.viewNames[app.getView()],"search","q="+this.getSearchText(),null),app.filterActivities()},showRadialView:function(){util.vibrate(),app.showView(constant.radialView),this.needRedraw&&(this.needRedraw=!1,app.redraw())},showListView:function(){util.vibrate(),app.showView(constant.listView),this.needRedraw&&(this.needRedraw=!1,app.redraw())},showNeighborView:function(){util.vibrate(),app.showView(constant.neighborhoodView),this.needRedraw&&(this.needRedraw=!1,app.redraw())},showSync:function(t){this.$.syncbutton.setShowing(t)},showServerWarning:function(t){this.$.offlinebutton.setShowing(t)},doServerSettings:function(){if(preferences.isConnected()){var t=preferences.getToken();if(t&&!t.expired){var e=app;return void app.connectToServer((function(t){e.getToolbar()&&e.getToolbar().showServerWarning&&e.getToolbar().showServerWarning(!t)}))}}app.$.otherview.createComponent({kind:"Sugar.DialogServer"},{owner:this}).show()},startTutorial:function(){tutorial.setElement("radialbutton",this.$.radialbutton.getAttribute("id")),tutorial.setElement("listbutton",this.$.listbutton.getAttribute("id")),tutorial.setElement("neighborbutton",this.$.neighborbutton.getAttribute("id")),tutorial.setElement("searchtext",this.$.searchtext.getAttribute("id")),tutorial.setElement("offlinebutton",this.$.offlinebutton.getAttribute("id")),app.otherview&&app.otherview.beforeHelp?app.otherview.beforeHelp():app.beforeHelp(),stats.trace(constant.viewNames[app.getView()],"tutorial","start",null),tutorial.start()}});