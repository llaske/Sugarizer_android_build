/*! Sugarizer 2020-03-14 */
var networkItemsCache=[],wifiItemsCache=[],lastWifiUpdate=0;enyo.kind({name:"Sugar.NeighborhoodView",kind:enyo.Control,components:[{name:"owner",kind:"Sugar.Icon",size:constant.sizeNeighbor,colorized:!0,classes:"owner-icon",showing:!1},{name:"server",kind:"Sugar.Icon",size:constant.sizeNeighbor,colorized:!0,classes:"server-icon",showing:!1},{name:"network",showing:!0,onresize:"draw",components:[]},{name:"otherview",showing:!0,components:[]},{name:"networkPopup",kind:"Sugar.Popup",showing:!1},{name:"empty",classes:"cloud-empty",showing:!1},{name:"message",classes:"cloud-message",showing:!1},{name:"settings",classes:"cloud-line",showing:!1,components:[{name:"gotosettings",kind:"Sugar.IconButton",icon:{directory:"icons",icon:"preferences-system.svg"},classes:"listview-button cloud-gotosettings",ontap:"doSettings"}]},{name:"refresh",classes:"cloud-line",showing:!1,components:[{name:"refreshstate",kind:"Sugar.IconButton",icon:{directory:"icons",icon:"system-restart.svg"},classes:"listview-button cloud-gotosettings",ontap:"doRefresh"}]}],create:function(){this.inherited(arguments),this.$.owner.setIcon({directory:"icons",icon:"owner-icon.svg"}),this.$.owner.setPopupShow(enyo.bind(this,"showBuddyPopup")),this.$.owner.setPopupHide(enyo.bind(this,"hideBuddyPopup")),window.sugarizerOS?this.$.server.setIcon({directory:"icons",icon:"cloud-one.svg"}):this.$.server.setIcon({directory:"icons",icon:"network-wireless-connected-100.svg"}),this.$.server.setPopupShow(enyo.bind(this,"showServerPopup")),this.$.server.setPopupHide(enyo.bind(this,"hideServerPopup"));var a=this.findInCache({icon:this.$.server}),b=Math.floor(Math.random()*xoPalette.colors.length);this.$.server.setColorizedColor(a?a.colorvalue:xoPalette.colors[b]),this.users=[],this.activities=[],this.eeMode=!1,this.timer=window.setInterval(enyo.bind(this,"updateNetworkState"),constant.timerUpdateNetwork),(presence.isConnected()||window.sugarizerOS)&&this.updateNetworkState(),"rtl"==l10n.language.direction&&this.$.message.addClass("rtl-10"),this.draw()},getToolbar:function(){return null==this.toolbar&&(this.toolbar=new Sugar.NeighborhoodToolbar),this.toolbar},getPopup:function(){return this.$.networkPopup},createWifiIcons:function(a){if(window.sugarizerOS)for(var b=[],c=sugarizerOS.networks,d=!1,e=0;e<c.length;e++){var f=c[e],g=sugarizerOS.getEncryptionString(f.capabilities),h="",i="",j=-1*f.RSSI%10;if(f.isConnected?h="-connected":"OPEN"!=g&&(i="-locked"),j>0){j%2!=0&&(j+=1),j*=10,cacheIcon=sugarizerOS.getNetworkIconFromCache(f.BSSID),cacheIcon?f=cacheIcon:(f.networkId=f.BSSID,f.shared=!1,f.shared.id=f.BSSID,f.color=xoPalette.colors[Math.floor(Math.random()*xoPalette.colors.length)]),iconString="network-wireless"+h+i+"-0"+j+".svg",100==j&&(iconString="network-wireless"+h+i+"-"+j+".svg");var k=this.$.network.createComponent({kind:"Sugar.Icon",icon:{directory:"icons",icon:iconString},size:constant.sizeNeighbor,colorized:!0,colorizedColor:f.color,popupShow:enyo.bind(this,"showWifiPopup"),popupHide:enyo.bind(this,"hideWifiPopup"),data:f},{owner:this});k.render(),d||(tutorial.setElement("wifi",k.getAttribute("id")),d=!0),b.push(k),sugarizerOS.addNetworkIconToCache(f);var l={icon:k,size:k.getSize(),locked:!1,child:[]};a.push(l)}}},updateNetworkState:function(){var a=preferences.getColor();if(presence.isConnected()&&"#005FE4"==a.stroke&&"#FF2B34"==a.fill&&this.toolbar&&"Sugarizer contributors"==this.toolbar.getSearchText()){if(!this.eeMode){for(var b=new Sugar.EE({mode:3}).contributors(),c=0;c<b.length;c++)this.users.push(b[c]);this.eeMode=!0,this.draw(),this.filterNetwork()}}else presence.isConnected()?(this.$.owner.setShowing(!0),this.$.server.setShowing(!0),this.$.empty.setShowing(!1),this.$.message.setShowing(!1),this.$.settings.setShowing(!1),this.$.refresh.setShowing(!1),app.toolbar&&app.toolbar.showServerWarning&&app.toolbar.showServerWarning(!1),presence.listUsers(enyo.bind(this,"userListReceived")),presence.listSharedActivities(enyo.bind(this,"sharedListReceived")),this.eeMode=!1):window.sugarizerOS?(now=(new Date).getTime(),this.$.owner.setShowing(!0),presence.isConnected()&&this.$.server.setShowing(!0),this.$.empty.setShowing(!1),this.$.message.setShowing(!1),this.$.settings.setShowing(!1),this.$.refresh.setShowing(!1),sugarizerOS.isWifiEnabled(function(a){0!=a?sugarizerOS.scanWifi():sugarizerOS.networks=[]}),wifiItemsCache!=sugarizerOS.networks&&now-lastWifiUpdate>constant.wifiUpdateTime&&(this.draw(),wifiItemsCache=sugarizerOS.networks,lastWifiUpdate=now),presence.listUsers(enyo.bind(this,"userListReceived")),presence.listSharedActivities(enyo.bind(this,"sharedListReceived")),this.eeMode=!1):(this.$.owner.setShowing(!1),this.$.server.setShowing(!1),this.$.empty.setShowing(!0),this.$.message.setShowing(!0),app.toolbar&&app.toolbar.showServerWarning&&app.toolbar.showServerWarning(!0),preferences.isConnected()?(this.$.message.setContent(l10n.get("UnableToConnect")),this.$.refresh.setShowing(!0)):(this.$.message.setContent(l10n.get("ServerNotSet")),this.$.settings.setShowing(!0)),this.eeMode=!1)},showBuddyPopup:function(a){this.getPopup().setHeader({icon:a.icon,colorized:!0,colorizedColor:null,name:preferences.getName(),title:null,action:enyo.bind(this,"doSettings")}),this.getPopup().setItems(null);var b=[];b.push({icon:{directory:"icons",icon:"preferences-system.svg"},colorized:!1,name:l10n.get("MySettings"),action:enyo.bind(this,"doSettings"),data:null}),b.push({icon:{directory:"icons",icon:"system-shutdown.svg"},colorized:!1,name:l10n.get("Logoff"),action:enyo.bind(this,"doLogoff"),data:null}),enyo.platform.electron&&b.push({icon:{directory:"lib/sugar-web/graphics/icons/actions",icon:"activity-stop.svg"},colorized:!1,name:l10n.get("Quit"),action:enyo.bind(this,"doQuit"),data:null}),this.getPopup().setFooter(b),this.getPopup().showPopup()},hideBuddyPopup:function(a){return!(!(this&&this.getPopup&&a&&this.getPopup())||this.getPopup().cursorIsInside()||a.cursorIsInside())&&(this.getPopup().hidePopup(),!0)},doLogoff:function(){stats.trace(constant.viewNames[app.getView()],"click","logoff"),this.getPopup().hidePopup(),!preferences.isConnected()||preferences.isConnected()&&!preferences.getOptions("sync")?(this.otherview=this.$.otherview.createComponent({kind:"Sugar.DialogWarningMessage"},{owner:this}),this.otherview.show()):(preferences.addUserInHistory(),util.cleanDatastore(null,function(){util.restartApp()}))},doQuit:function(){stats.trace(constant.viewNames[app.getView()],"click","quit"),util.quitApp()},doSettings:function(){stats.trace(constant.viewNames[app.getView()],"click","my_settings"),this.getPopup().hidePopup(),this.otherview=this.$.otherview.createComponent({kind:"Sugar.DialogServer"},{owner:this}),this.otherview.show()},doRefresh:function(){if(presence.isConnected())this.updateNetworkState();else{var a=this;presence.joinNetwork(function(b,c){b?console.log("WARNING: Can't connect to presence server"):a.updateNetworkState()})}},showServerPopup:function(a){var b=myserver.getServer(),c=preferences.getServer();c&&c.name&&(b=c.name),this.getPopup().setHeader({icon:a.icon,colorized:!0,colorizedColor:a.colorizedColor,name:b,title:l10n.get("Connected"),action:null}),this.getPopup().setItems(null),this.getPopup().setFooter(null),this.getPopup().showPopup()},hideServerPopup:function(a){return!(!(this&&this.getPopup&&a&&this.getPopup())||this.getPopup().cursorIsInside()||a.cursorIsInside())&&(this.getPopup().hidePopup(),!0)},disconnect:function(){sugarizerOS.disconnectWifi(),this.getPopup().hidePopup()},forgetPassword:function(a){sugarizerOS.forgetNetwork(a.SSID),this.getPopup().hidePopup()},joinNetwork:function(a){var b=this;sugarizerOS.isKnownNetwork(a.SSID,function(c){0==c?sugarizerOS.setKey(a.SSID,"",!0):sugarizerOS.joinNetwork(a.SSID),b.getPopup().hidePopup()})},enterKey:function(a){this.getPopup().hidePopup();var b=this;sugarizerOS.isKnownNetwork(a.SSID,function(c){0==c?(sugarizerOS.NetworkBuffer=a,b.otherview=b.$.otherview.createComponent({kind:"Sugar.DialogNetworkKey"}),b.otherview.show()):sugarizerOS.joinNetwork(a.SSID)})},showWifiPopup:function(a){var b=a.getData(),c=b.SSID+" ("+b.RSSI+")["+sugarizerOS.getEncryptionString(b.capabilities)+"]";b.RSSI;this.getPopup().setHeader({icon:a.icon,colorized:!0,colorizedColor:a.colorizedColor,name:c,title:b.BSSID,action:null});var d=[],e=this;sugarizerOS.getWifiSSID(function(c){null==c||c!==b.SSID?(item={icon:{directory:"icons",icon:"activity-start.svg"},colorized:!1,name:l10n.get("JoinNetwork"),action:enyo.bind(e,"joinNetwork"),data:[a.getData(),null]},"OPEN"!=sugarizerOS.getEncryptionString(b.capabilities)&&(item.action=enyo.bind(e,"enterKey"))):item={icon:{directory:"icons",icon:"activity-start.svg"},colorized:!1,name:l10n.get("Disconnect"),action:enyo.bind(e,"disconnect"),data:[a.getData(),null]},d.push(item),sugarizerOS.isKnownNetwork(b.SSID,function(c){1==c&&(item={icon:{directory:"icons",icon:"activity-start.svg"},colorized:!1,name:l10n.get("ForgetPassword"),action:enyo.bind(e,"forgetPassword"),data:[a.getData(),null]},"OPEN"!=sugarizerOS.getEncryptionString(b.capabilities)&&d.push(item)),e.getPopup().setItems(d),e.getPopup().setFooter(null),e.getPopup().showPopup()})})},hideWifiPopup:function(a){return!(!(this&&this.getPopup&&a&&this.getPopup())||this.getPopup()&&this.getPopup().cursorIsInside()||a.cursorIsInside())&&(this.getPopup().hidePopup(),!0)},showUserPopup:function(a){this.getPopup().setHeader({icon:a.icon,colorized:!0,colorizedColor:a.colorizedColor,name:a.getData().name,title:null,action:null}),this.getPopup().setItems(null),this.getPopup().setFooter(null),this.getPopup().showPopup()},hideUserPopup:function(a){return!(!(this&&this.getPopup&&a&&this.getPopup())||this.getPopup().cursorIsInside()||a.cursorIsInside())&&(this.getPopup().hidePopup(),!0)},showActivityPopup:function(a){this.getPopup().setHeader({icon:a.icon,colorized:!0,colorizedColor:a.colorizedColor,name:a.getData().activity.name,title:null,action:null});var b=[];b.push({icon:{directory:"icons",icon:"activity-start.svg"},colorized:!1,name:l10n.get("JoinActivity"),action:enyo.bind(this,"joinActivity"),data:[a.getData(),null]}),this.getPopup().setItems(b),this.getPopup().setFooter(null),this.getPopup().showPopup()},hideActivityPopup:function(a){return!(!(this&&this.getPopup&&a&&this.getPopup())||this.getPopup().cursorIsInside()||a.cursorIsInside())&&(this.getPopup().hidePopup(),!0)},joinActivity:function(a){preferences.runActivity(a.activity,null,a.activity.name,a.shared.id)},userListReceived:function(a){if(this.users.length==a.length){for(var b=this.users.length,c=0,d=0;d<b;d++)for(var e=0;e<b;e++)if(a[d].networkId==this.users[e].networkId){c++;break}if(c==b)return}this.users=a;for(var f=0,d=0;d<f;d++)this.users.push({networkId:"nxx"+d,name:"dummy "+d,colorvalue:xoPalette.colors[Math.floor(Math.random()*xoPalette.colors.length)]});this.draw()},sharedListReceived:function(a){if(this.activities.length==a.length){for(var b=this.activities.length,c=0,d=0;d<b;d++)for(var e=0;e<b;e++)if(a[d].activityId==this.activities[e].activityId&&a[d].users.length==this.activities[e].users.length){c++;break}if(c==b)return}this.activities=a,this.draw()},draw:function(){var a=util.getCanvasCenter();this.$.empty.applyStyle("margin-left",a.x-constant.sizeEmpty/4-10+"px");var b=a.y-constant.sizeEmpty/4-80;this.$.empty.applyStyle("margin-top",b+"px"),this.$.message.applyStyle("margin-top",b+70+"px"),this.$.gotosettings.applyStyle("margin-top",b+90+"px"),this.$.gotosettings.setText(l10n.get("MySettings")),this.$.refreshstate.applyStyle("margin-top",b+90+"px"),this.$.refreshstate.setText(l10n.get("Refresh")),tutorial.setElement("owner",this.$.owner.getAttribute("id")),tutorial.setElement("server",this.$.server.getAttribute("id"));var c=[];enyo.forEach(this.$.network.getControls(),function(a){c.push(a)});for(var d=0;d<c.length;d++)c[d].destroy();var a=util.getCanvasCenter();c=[],c.push({icon:this.$.owner,x:a.x-constant.sizeNeighbor/2,y:a.y-constant.sizeNeighbor/2,size:this.$.owner.getSize(),locked:!0,child:[]}),this.$.server.getShowing()&&c.push({icon:this.$.server,size:this.$.server.getSize(),locked:!1,child:[]}),this.createNetworkIcons(c),this.createWifiIcons(c);for(var e=c.length,d=0;d<e;d++){var f=c[d];if(!f.locked){var g=f.child.length>0?1:0,h=this.findInCache(f),i=a.dx-f.size-2*g*f.size;f.x=h&&h.x<i?h.x:f.size*g+Math.floor(Math.random()*i);var j=a.dy-f.size-2*g*f.size;f.y=h&&h.y<j?h.y:f.size*g+Math.floor(Math.random()*j),h||this.addToCache(f);for(var k=f.child.length,l=0;l<k;l++){var m=f.child[l],n=2*Math.PI/k*l;m.x=f.x+f.size*Math.sin(n),m.y=f.y-f.size*Math.cos(n)}}}var o=this.detectCollisions(c);o.length>0&&this.solveCollisions(o,c);for(var d=0;d<e;d++){var f=c[d];f.icon.applyStyle("margin-left",f.x+"px"),f.icon.applyStyle("margin-top",f.y+"px");for(var k=f.child.length,l=0;l<k;l++){var m=f.child[l];m.applyStyle("margin-left",m.x+"px"),m.applyStyle("margin-top",m.y+"px")}}this.filterNetwork()},createNetworkIcons:function(a){for(var b=this.users.length,c=[],d=!1,e=0;e<b;e++){var f=this.users[e];if(f.networkId!=preferences.getNetworkId()){var g=this.$.network.createComponent({kind:"Sugar.Icon",icon:{directory:"icons",icon:"owner-icon.svg"},size:constant.sizeNeighbor,colorized:!0,colorizedColor:f.colorvalue,popupShow:enyo.bind(this,"showUserPopup"),popupHide:enyo.bind(this,"hideUserPopup"),data:f},{owner:this});g.render(),d||(tutorial.setElement("other",g.getAttribute("id")),d=!0),c.push(g)}}b=this.activities.length;for(var h=[],i=!1,e=0;e<b;e++){var j=this.activities[e],k=preferences.getActivity(j.activityId);if(k!=preferences.genericActivity){var g=this.$.network.createComponent({kind:"Sugar.Icon",icon:{directory:k.directory,icon:k.icon},size:constant.sizeNeighbor,colorized:!0,colorizedColor:j.colorvalue,popupShow:enyo.bind(this,"showActivityPopup"),popupHide:enyo.bind(this,"hideActivityPopup"),data:{shared:j,activity:k}},{owner:this});g.render(),i||(tutorial.setElement("activity",g.getAttribute("id")),i=!0);for(var l=[],m=j.users.length,n=0;n<m;n++)for(var o=c.length,p=0;p<o;p++){var q=c[p];j.users[n]==q.getData().networkId&&(l.push(q),h.push(q))}a.push({icon:g,size:g.getSize(),locked:!1,child:l})}}for(var o=c.length,m=h.length,e=0;e<o;e++){for(var r=!1,g=c[e],n=0;n<m&&!r;n++)g.getData().networkId==h[n].getData().networkId&&(r=!0);r||a.push({icon:g,size:g.getSize(),locked:!1,child:[]})}},detectCollisions:function(a){for(var b=[],c=a.length,d=0;d<c;d++)for(var e=d+1;e<c;e++){var f=a[d],g=a[e],h=f.size,i=g.size,j=f.x,k=f.x+h,l=f.y,m=f.y+h,n=g.x,o=g.x+i,p=g.y,q=g.y+i;f.child.length>0&&(j-=h,k+=h,l-=h,m+=h),g.child.length>0&&(n-=i,o+=i,p-=i,q+=i),k<n||j>o||l>q||m<p||(f.locked?b.push(g):b.push(f))}return b},solveCollisions:function(a,b){for(var c=!0,d=util.getCanvasCenter(),e=0;c&&e<constant.maxCollisionTry;e++){for(var f=0;f<a.length;f++){var g=a[f],h=g.child.length>0?1:0;g.x=g.size*h+Math.floor(Math.random()*(d.dx-g.size-2*h*g.size)),g.y=g.size*h+Math.floor(Math.random()*(d.dy-g.size-2*h*g.size));for(var i=g.child.length,j=0;j<i;j++){var k=g.child[j],l=2*Math.PI/i*j;k.x=g.x+g.size*Math.sin(l),k.y=g.y-g.size*Math.cos(l)}}a=this.detectCollisions(b),c=a.length>0}},filterNetwork:function(){var a=this.toolbar&&!this.eeMode?this.toolbar.getSearchText().toLowerCase():"";enyo.forEach(this.$.network.getControls(),function(b){b.setDisabled(0!=a.length&&b.data&&b.data.name&&-1==b.data.name.toLowerCase().indexOf(a))}),this.$.server.setDisabled(0!=a.length&&-1==myserver.getServer().toLowerCase().indexOf(a))},addToCache:function(a){var b,c=a.icon.getData();c?c.networkId?b=c.networkId:c.shared&&c.shared.id&&(b=c.shared.id):b="server";for(var d=networkItemsCache,e=!1,f=0;f<d;f++){var g=networkItemsCache[f];g.name==b&&(g.x=x,g.y=y,e=!0)}e||networkItemsCache.push({name:b,x:a.x,y:a.y,colorvalue:a.icon.getColorizedColor()})},findInCache:function(a){var b,c=a.icon.getData();c?c.networkId?b=c.networkId:c.shared&&c.shared.id&&(b=c.shared.id):b="server";for(var d=networkItemsCache.length,e=0;e<d;e++){var f=networkItemsCache[e];if(f.name==b)return f}return null},destroy:function(){this.inherited(arguments),clearTimeout(this.timer)}}),enyo.kind({name:"Sugar.NeighborhoodToolbar",kind:enyo.Control,components:[{name:"neighborsearch",kind:"Sugar.SearchField",onTextChanged:"filterNetwork",classes:"neighbor-filter-text"},{name:"helpbutton",kind:"Button",classes:"toolbutton help-button",title:"Help",ontap:"startTutorial"},{name:"radialbutton",kind:"Button",classes:"toolbutton view-desktop-button",title:"Home",title:"Home",ontap:"gotoDesktop"}],create:function(){this.inherited(arguments),this.localize()},rendered:function(){this.inherited(arguments),this.localize()},localize:function(){this.$.neighborsearch.setPlaceholder(l10n.get("SearchNeighbor")),this.$.radialbutton.setNodeProperty("title",l10n.get("Home")),this.$.helpbutton.setNodeProperty("title",l10n.get("Tutorial"))},getSearchText:function(){return this.$.neighborsearch.getText()},gotoDesktop:function(){window.clearInterval(app.otherview.timer),util.vibrate(),app.showView(constant.radialView)},filterNetwork:function(){app.otherview.filterNetwork()},startTutorial:function(){tutorial.setElement("radialbutton",this.$.radialbutton.getAttribute("id")),tutorial.setElement("neighborsearch",this.$.neighborsearch.getAttribute("id")),stats.trace(constant.viewNames[app.getView()],"tutorial","start",null),tutorial.start()}});