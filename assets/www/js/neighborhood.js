var networkItemsCache=[],wifiItemsCache=[],lastWifiUpdate=0;enyo.kind({name:"Sugar.NeighborhoodView",kind:enyo.Control,components:[{name:"owner",kind:"Sugar.Icon",size:constant.sizeNeighbor,colorized:!0,classes:"owner-icon",showing:!1},{name:"server",kind:"Sugar.Icon",size:constant.sizeNeighbor,colorized:!0,classes:"server-icon",showing:!1},{name:"network",showing:!0,onresize:"draw",components:[]},{name:"otherview",showing:!0,components:[]},{name:"networkPopup",kind:"Sugar.Popup",showing:!1},{name:"empty",classes:"cloud-empty",showing:!1},{name:"message",classes:"cloud-message",showing:!1},{name:"settings",classes:"cloud-line",showing:!1,components:[{name:"gotosettings",kind:"Sugar.IconButton",icon:{directory:"icons",icon:"preferences-system.svg"},classes:"listview-button cloud-gotosettings",ontap:"doSettings"}]},{name:"refresh",classes:"cloud-line",showing:!1,components:[{name:"refreshstate",kind:"Sugar.IconButton",icon:{directory:"icons",icon:"system-restart.svg"},classes:"listview-button cloud-gotosettings",ontap:"doRefresh"}]}],create:function(){this.inherited(arguments),this.$.owner.setIcon({directory:"icons",icon:"owner-icon.svg"}),this.$.owner.setPopupShow(enyo.bind(this,"showBuddyPopup")),this.$.owner.setPopupHide(enyo.bind(this,"hideBuddyPopup")),window.sugarizerOS?this.$.server.setIcon({directory:"icons",icon:"cloud-one.svg"}):this.$.server.setIcon({directory:"icons",icon:"network-wireless-connected-100.svg"}),this.$.server.setPopupShow(enyo.bind(this,"showServerPopup")),this.$.server.setPopupHide(enyo.bind(this,"hideServerPopup"));var e=this.findInCache({icon:this.$.server}),t=Math.floor(Math.random()*xoPalette.colors.length);this.$.server.setColorizedColor(e?e.colorvalue:xoPalette.colors[t]),this.users=[],this.activities=[],this.eeMode=!1,this.timer=window.setInterval(enyo.bind(this,"updateNetworkState"),constant.timerUpdateNetwork),(presence.isConnected()||window.sugarizerOS)&&this.updateNetworkState(),"rtl"==l10n.language.direction&&this.$.message.addClass("rtl-10"),this.draw()},getToolbar:function(){return null==this.toolbar&&(this.toolbar=new Sugar.NeighborhoodToolbar),this.toolbar},getPopup:function(){return this.$.networkPopup},createWifiIcons:function(e){if(window.sugarizerOS)for(var t=[],i=sugarizerOS.networks,o=!1,s=0;s<i.length;s++){var n=i[s],r=sugarizerOS.getEncryptionString(n.capabilities),a="",h="",c=-1*n.RSSI%10;if(n.isConnected?a="-connected":"OPEN"!=r&&(h="-locked"),c>0){c%2!=0&&(c+=1),c*=10,cacheIcon=sugarizerOS.getNetworkIconFromCache(n.BSSID),cacheIcon?n=cacheIcon:(n.networkId=n.BSSID,n.shared=!1,n.shared.id=n.BSSID,n.color=xoPalette.colors[Math.floor(Math.random()*xoPalette.colors.length)]),iconString="network-wireless"+a+h+"-0"+c+".svg",100==c&&(iconString="network-wireless"+a+h+"-"+c+".svg");var l=this.$.network.createComponent({kind:"Sugar.Icon",icon:{directory:"icons",icon:iconString},size:constant.sizeNeighbor,colorized:!0,colorizedColor:n.color,popupShow:enyo.bind(this,"showWifiPopup"),popupHide:enyo.bind(this,"hideWifiPopup"),data:n},{owner:this});l.render(),o||(tutorial.setElement("wifi",l.getAttribute("id")),o=!0),t.push(l),sugarizerOS.addNetworkIconToCache(n);var p={icon:l,size:l.getSize(),locked:!1,child:[]};e.push(p)}}},updateNetworkState:function(){var e=preferences.getColor();if(presence.isConnected()&&"#005FE4"==e.stroke&&"#FF2B34"==e.fill&&this.toolbar&&"Sugarizer contributors"==this.toolbar.getSearchText()){if(!this.eeMode){for(var t=new Sugar.EE({mode:3}).contributors(),i=0;i<t.length;i++)this.users.push(t[i]);this.eeMode=!0,this.draw(),this.filterNetwork()}}else presence.isConnected()?(this.$.owner.setShowing(!0),this.$.server.setShowing(!0),this.$.empty.setShowing(!1),this.$.message.setShowing(!1),this.$.settings.setShowing(!1),this.$.refresh.setShowing(!1),app.toolbar&&app.toolbar.showServerWarning&&app.toolbar.showServerWarning(!1),presence.listUsers(enyo.bind(this,"userListReceived")),presence.listSharedActivities(enyo.bind(this,"sharedListReceived")),this.eeMode=!1):window.sugarizerOS?(now=(new Date).getTime(),this.$.owner.setShowing(!0),presence.isConnected()&&this.$.server.setShowing(!0),this.$.empty.setShowing(!1),this.$.message.setShowing(!1),this.$.settings.setShowing(!1),this.$.refresh.setShowing(!1),sugarizerOS.isWifiEnabled((function(e){0!=e?sugarizerOS.scanWifi():sugarizerOS.networks=[]})),wifiItemsCache!=sugarizerOS.networks&&now-lastWifiUpdate>constant.wifiUpdateTime&&(this.draw(),wifiItemsCache=sugarizerOS.networks,lastWifiUpdate=now),presence.listUsers(enyo.bind(this,"userListReceived")),presence.listSharedActivities(enyo.bind(this,"sharedListReceived")),this.eeMode=!1):(this.$.owner.setShowing(!1),this.$.server.setShowing(!1),this.$.empty.setShowing(!0),this.$.message.setShowing(!0),app.toolbar&&app.toolbar.showServerWarning&&app.toolbar.showServerWarning(!0),preferences.isConnected()?(this.$.message.setContent(l10n.get("UnableToConnect")),this.$.refresh.setShowing(!0)):(this.$.message.setContent(l10n.get("ServerNotSet")),this.$.settings.setShowing(!0)),this.eeMode=!1)},showBuddyPopup:function(e){this.getPopup().setHeader({icon:e.icon,colorized:!0,colorizedColor:null,name:preferences.getName(),title:null,action:enyo.bind(this,"doSettings")}),this.getPopup().setItems(null);var t=[];t.push({icon:{directory:"icons",icon:"preferences-system.svg"},colorized:!1,name:l10n.get("MySettings"),action:enyo.bind(this,"doSettings"),data:null}),t.push({icon:{directory:"icons",icon:"system-shutdown.svg"},colorized:!1,name:l10n.get("Logoff"),action:enyo.bind(this,"doLogoff"),data:null}),enyo.platform.electron&&t.push({icon:{directory:"lib/sugar-web/graphics/icons/actions",icon:"activity-stop.svg"},colorized:!1,name:l10n.get("Quit"),action:enyo.bind(this,"doQuit"),data:null}),this.getPopup().setFooter(t),this.getPopup().showPopup()},hideBuddyPopup:function(e){return!(!(this&&this.getPopup&&e&&this.getPopup())||this.getPopup().cursorIsInside()||e.cursorIsInside())&&(this.getPopup().hidePopup(),!0)},doLogoff:function(){stats.trace(constant.viewNames[app.getView()],"click","logoff"),this.getPopup().hidePopup(),!preferences.isConnected()||preferences.isConnected()&&!preferences.getOptions("sync")?(this.otherview=this.$.otherview.createComponent({kind:"Sugar.DialogWarningMessage"},{owner:this}),this.otherview.show()):util.cleanDatastore(null,(function(){util.restartApp()}))},doQuit:function(){stats.trace(constant.viewNames[app.getView()],"click","quit"),util.quitApp()},doSettings:function(){stats.trace(constant.viewNames[app.getView()],"click","my_settings"),this.getPopup().hidePopup(),this.otherview=this.$.otherview.createComponent({kind:"Sugar.DialogServer"},{owner:this}),this.otherview.show()},doRefresh:function(){if(presence.isConnected())this.updateNetworkState();else{var e=this;presence.joinNetwork((function(t,i){t?console.log("WARNING: Can't connect to presence server"):e.updateNetworkState()}))}},showServerPopup:function(e){var t=myserver.getServer(),i=preferences.getServer();i&&i.name&&(t=i.name),this.getPopup().setHeader({icon:e.icon,colorized:!0,colorizedColor:e.colorizedColor,name:t,title:l10n.get("Connected"),action:null}),this.getPopup().setItems(null),this.getPopup().setFooter(null),this.getPopup().showPopup()},hideServerPopup:function(e){return!(!(this&&this.getPopup&&e&&this.getPopup())||this.getPopup().cursorIsInside()||e.cursorIsInside())&&(this.getPopup().hidePopup(),!0)},disconnect:function(){sugarizerOS.disconnectWifi(),this.getPopup().hidePopup()},forgetPassword:function(e){sugarizerOS.forgetNetwork(e.SSID),this.getPopup().hidePopup()},joinNetwork:function(e){var t=this;sugarizerOS.isKnownNetwork(e.SSID,(function(i){0==i?sugarizerOS.setKey(e.SSID,"",!0):sugarizerOS.joinNetwork(e.SSID),t.getPopup().hidePopup()}))},enterKey:function(e){this.getPopup().hidePopup();var t=this;sugarizerOS.isKnownNetwork(e.SSID,(function(i){0==i?(sugarizerOS.NetworkBuffer=e,t.otherview=t.$.otherview.createComponent({kind:"Sugar.DialogNetworkKey"}),t.otherview.show()):sugarizerOS.joinNetwork(e.SSID)}))},showWifiPopup:function(e){var t=e.getData(),i=t.SSID+" ("+t.RSSI+")["+sugarizerOS.getEncryptionString(t.capabilities)+"]";t.RSSI;this.getPopup().setHeader({icon:e.icon,colorized:!0,colorizedColor:e.colorizedColor,name:i,title:t.BSSID,action:null});var o=[],s=this;sugarizerOS.getWifiSSID((function(i){null==i||i!==t.SSID?(item={icon:{directory:"icons",icon:"activity-start.svg"},colorized:!1,name:l10n.get("JoinNetwork"),action:enyo.bind(s,"joinNetwork"),data:[e.getData(),null]},"OPEN"!=sugarizerOS.getEncryptionString(t.capabilities)&&(item.action=enyo.bind(s,"enterKey"))):item={icon:{directory:"icons",icon:"activity-start.svg"},colorized:!1,name:l10n.get("Disconnect"),action:enyo.bind(s,"disconnect"),data:[e.getData(),null]},o.push(item),sugarizerOS.isKnownNetwork(t.SSID,(function(i){1==i&&(item={icon:{directory:"icons",icon:"activity-start.svg"},colorized:!1,name:l10n.get("ForgetPassword"),action:enyo.bind(s,"forgetPassword"),data:[e.getData(),null]},"OPEN"!=sugarizerOS.getEncryptionString(t.capabilities)&&o.push(item)),s.getPopup().setItems(o),s.getPopup().setFooter(null),s.getPopup().showPopup()}))}))},hideWifiPopup:function(e){return!(!(this&&this.getPopup&&e&&this.getPopup())||this.getPopup()&&this.getPopup().cursorIsInside()||e.cursorIsInside())&&(this.getPopup().hidePopup(),!0)},showUserPopup:function(e){this.getPopup().setHeader({icon:e.icon,colorized:!0,colorizedColor:e.colorizedColor,name:e.getData().name,title:null,action:null}),this.getPopup().setItems(null),this.getPopup().setFooter(null),this.getPopup().showPopup()},hideUserPopup:function(e){return!(!(this&&this.getPopup&&e&&this.getPopup())||this.getPopup().cursorIsInside()||e.cursorIsInside())&&(this.getPopup().hidePopup(),!0)},showActivityPopup:function(e){this.getPopup().setHeader({icon:e.icon,colorized:!0,colorizedColor:e.colorizedColor,name:e.getData().activity.name,title:null,action:enyo.bind(this,"joinActivity"),data:[e.getData(),null]});var t=[];t.push({icon:{directory:"icons",icon:"activity-start.svg"},colorized:!1,name:l10n.get("JoinActivity"),action:enyo.bind(this,"joinActivity"),data:[e.getData(),null]}),this.getPopup().setItems(t),this.getPopup().setFooter(null),this.getPopup().showPopup()},hideActivityPopup:function(e){return!(!(this&&this.getPopup&&e&&this.getPopup())||this.getPopup().cursorIsInside()||e.cursorIsInside())&&(this.getPopup().hidePopup(),!0)},joinSharedActivity:function(e){this.joinActivity(e.data)},joinActivity:function(e){preferences.runActivity(e.activity,null,e.activity.name,e.shared.id)},userListReceived:function(e){if(this.users.length==e.length){for(var t=this.users.length,i=0,o=0;o<t;o++)for(var s=0;s<t;s++)if(e[o].networkId==this.users[s].networkId){i++;break}if(i==t)return}this.users=e;for(o=0;o<0;o++)this.users.push({networkId:"nxx"+o,name:"dummy "+o,colorvalue:xoPalette.colors[Math.floor(Math.random()*xoPalette.colors.length)]});this.draw()},sharedListReceived:function(e){if(this.activities.length==e.length){for(var t=this.activities.length,i=0,o=0;o<t;o++)for(var s=0;s<t;s++)if(e[o].activityId==this.activities[s].activityId&&e[o].users.length==this.activities[s].users.length){i++;break}if(i==t)return}this.activities=e,this.draw()},draw:function(){var e=util.getCanvasCenter();this.$.empty.applyStyle("margin-left",e.x-constant.sizeEmpty/4-10+"px");var t=e.y-constant.sizeEmpty/4-80;this.$.empty.applyStyle("margin-top",t+"px"),this.$.message.applyStyle("margin-top",t+70+"px"),this.$.gotosettings.applyStyle("margin-top",t+90+"px"),this.$.gotosettings.setText(l10n.get("MySettings")),this.$.refreshstate.applyStyle("margin-top",t+90+"px"),this.$.refreshstate.setText(l10n.get("Refresh")),tutorial.setElement("owner",this.$.owner.getAttribute("id")),tutorial.setElement("server",this.$.server.getAttribute("id"));var i=[];enyo.forEach(this.$.network.getControls(),(function(e){i.push(e)}));for(var o=0;o<i.length;o++)i[o].destroy();e=util.getCanvasCenter();(i=[]).push({icon:this.$.owner,x:e.x-constant.sizeNeighbor/2,y:e.y-constant.sizeNeighbor/2,size:this.$.owner.getSize(),locked:!0,child:[]}),this.$.server.getShowing()&&i.push({icon:this.$.server,size:this.$.server.getSize(),locked:!1,child:[]}),this.createNetworkIcons(i),this.createWifiIcons(i);var s=i.length;for(o=0;o<s;o++){if(!(g=i[o]).locked){var n=g.child.length>0?1:0,r=this.findInCache(g),a=e.dx-g.size-2*n*g.size;g.x=r&&r.x<a?r.x:g.size*n+Math.floor(Math.random()*a);var h=e.dy-g.size-2*n*g.size;g.y=r&&r.y<h?r.y:g.size*n+Math.floor(Math.random()*h),r||this.addToCache(g);for(var c=g.child.length,l=0;l<c;l++){var p=g.child[l],u=2*Math.PI/c*l;p.x=g.x+g.size*Math.sin(u),p.y=g.y-g.size*Math.cos(u)}}}var d=this.detectCollisions(i);d.length>0&&this.solveCollisions(d,i);for(o=0;o<s;o++){var g;(g=i[o]).icon.applyStyle("margin-left",g.x+"px"),g.icon.applyStyle("margin-top",g.y+"px");for(c=g.child.length,l=0;l<c;l++){(p=g.child[l]).applyStyle("margin-left",p.x+"px"),p.applyStyle("margin-top",p.y+"px")}}this.filterNetwork()},createNetworkIcons:function(e){for(var t=this.users.length,i=[],o=!1,s=0;s<t;s++){var n=this.users[s];if(n.networkId!=preferences.getNetworkId())(f=this.$.network.createComponent({kind:"Sugar.Icon",icon:{directory:"icons",icon:"owner-icon.svg"},size:constant.sizeNeighbor,colorized:!0,colorizedColor:n.colorvalue,popupShow:enyo.bind(this,"showUserPopup"),popupHide:enyo.bind(this,"hideUserPopup"),data:n},{owner:this})).render(),o||(tutorial.setElement("other",f.getAttribute("id")),o=!0),i.push(f)}t=this.activities.length;var r=[],a=!1;for(s=0;s<t;s++){var h=this.activities[s],c=preferences.getActivity(h.activityId);if(c!=preferences.genericActivity){(f=this.$.network.createComponent({kind:"Sugar.Icon",icon:{directory:c.directory,icon:c.icon},size:constant.sizeNeighbor,colorized:!0,colorizedColor:h.colorvalue,ontap:"joinSharedActivity",popupShow:enyo.bind(this,"showActivityPopup"),popupHide:enyo.bind(this,"hideActivityPopup"),data:{shared:h,activity:c}},{owner:this})).render(),a||(tutorial.setElement("activity",f.getAttribute("id")),a=!0);for(var l=[],p=h.users.length,u=0;u<p;u++)for(var d=i.length,g=0;g<d;g++){var w=i[g];h.users[u]==w.getData().networkId&&(l.push(w),r.push(w))}e.push({icon:f,size:f.getSize(),locked:!1,child:l})}}for(d=i.length,p=r.length,s=0;s<d;s++){var v=!1,f=i[s];for(u=0;u<p&&!v;u++)f.getData().networkId==r[u].getData().networkId&&(v=!0);v||e.push({icon:f,size:f.getSize(),locked:!1,child:[]})}},detectCollisions:function(e){for(var t=[],i=e.length,o=0;o<i;o++)for(var s=o+1;s<i;s++){var n=e[o],r=e[s],a=n.size,h=r.size,c=n.x,l=n.x+a,p=n.y,u=n.y+a,d=r.x,g=r.x+h,w=r.y,v=r.y+h;n.child.length>0&&(c-=a,l+=a,p-=a,u+=a),r.child.length>0&&(d-=h,g+=h,w-=h,v+=h),l<d||c>g||p>v||u<w||(n.locked?t.push(r):t.push(n))}return t},solveCollisions:function(e,t){for(var i=!0,o=util.getCanvasCenter(),s=0;i&&s<constant.maxCollisionTry;s++){for(var n=0;n<e.length;n++){var r=e[n],a=r.child.length>0?1:0;r.x=r.size*a+Math.floor(Math.random()*(o.dx-r.size-2*a*r.size)),r.y=r.size*a+Math.floor(Math.random()*(o.dy-r.size-2*a*r.size));for(var h=r.child.length,c=0;c<h;c++){var l=r.child[c],p=2*Math.PI/h*c;l.x=r.x+r.size*Math.sin(p),l.y=r.y-r.size*Math.cos(p)}}i=(e=this.detectCollisions(t)).length>0}},filterNetwork:function(){var e=this.toolbar&&!this.eeMode?this.toolbar.getSearchText().toLowerCase():"";enyo.forEach(this.$.network.getControls(),(function(t){t.setDisabled(0!=e.length&&t.data&&t.data.name&&-1==t.data.name.toLowerCase().indexOf(e))})),this.$.server.setDisabled(0!=e.length&&-1==myserver.getServer().toLowerCase().indexOf(e))},addToCache:function(e){var t,i=e.icon.getData();i?i.networkId?t=i.networkId:i.shared&&i.shared.id&&(t=i.shared.id):t="server";for(var o=networkItemsCache,s=!1,n=0;n<o;n++){var r=networkItemsCache[n];r.name==t&&(r.x=x,r.y=y,s=!0)}s||networkItemsCache.push({name:t,x:e.x,y:e.y,colorvalue:e.icon.getColorizedColor()})},findInCache:function(e){var t,i=e.icon.getData();i?i.networkId?t=i.networkId:i.shared&&i.shared.id&&(t=i.shared.id):t="server";for(var o=networkItemsCache.length,s=0;s<o;s++){var n=networkItemsCache[s];if(n.name==t)return n}return null},destroy:function(){this.inherited(arguments),clearTimeout(this.timer)}}),enyo.kind({name:"Sugar.NeighborhoodToolbar",kind:enyo.Control,components:[{name:"neighborsearch",kind:"Sugar.SearchField",onTextChanged:"filterNetwork",classes:"neighbor-filter-text"},{name:"helpbutton",kind:"Button",classes:"toolbutton help-button",title:"Help",ontap:"startTutorial"},{name:"radialbutton",kind:"Button",classes:"toolbutton view-desktop-button",title:"Home",title:"Home",ontap:"gotoDesktop"}],create:function(){this.inherited(arguments),this.localize()},rendered:function(){this.inherited(arguments),this.localize()},localize:function(){this.$.neighborsearch.setPlaceholder(l10n.get("SearchNeighbor")),this.$.radialbutton.setNodeProperty("title",l10n.get("Home")),this.$.helpbutton.setNodeProperty("title",l10n.get("Tutorial"))},getSearchText:function(){return this.$.neighborsearch.getText()},gotoDesktop:function(){window.clearInterval(app.otherview.timer),util.vibrate(),app.showView(constant.radialView)},filterNetwork:function(){app.otherview.filterNetwork()},startTutorial:function(){tutorial.setElement("radialbutton",this.$.radialbutton.getAttribute("id")),tutorial.setElement("neighborsearch",this.$.neighborsearch.getAttribute("id")),stats.trace(constant.viewNames[app.getView()],"tutorial","start",null),tutorial.start()}});