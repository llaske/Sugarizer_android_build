enyo.kind({name:"Sugar.Journal",published:{journal:null},kind:"FittableRows",components:[{name:"warningbox",kind:"Sugar.GenericDialogBox",showing:!1,classes:"journal-dialogbox",onCancel:"dialogSelectedCancel",onOk:"dialogSelectedOk"},{name:"content",kind:"Scroller",fit:!0,classes:"journal-content",onresize:"draw",onScroll:"onscroll",components:[{name:"empty",classes:"journal-empty",showing:!0},{name:"message",classes:"journal-message",showing:!0},{name:"nofilter",kind:"Sugar.IconButton",icon:{directory:"icons",icon:"dialog-cancel.svg"},classes:"listview-button",ontap:"nofilter",showing:!1},{name:"journalList",classes:"journal-list",kind:"Repeater",onSetupItem:"setupItem",components:[{name:"item",classes:"journal-list-item",components:[{name:"check",kind:"Input",type:"checkbox",classes:"toggle journal-check",onchange:"switchCheck"},{name:"favorite",kind:"Sugar.Icon",x:40,y:4,size:constant.iconSizeLargeFavorite,ontap:"switchFavorite"},{name:"activity",kind:"Sugar.Icon",x:100,y:5,size:constant.iconSizeList,colorized:!0,ontap:"runActivity"},{name:"title",showing:!0,classes:"journal-title",ontap:"titleEditStart"},{name:"titleEdit",showing:!1,kind:"enyo.Input",classes:"journal-title-edit",onblur:"titleEditEnd"},{name:"time",classes:"journal-time"},{name:"goright",kind:"Sugar.Icon",classes:"journal-goright",size:constant.iconSizeFavorite,ontap:"runActivity"}]}]},{name:"activityPopup",kind:"Sugar.Popup",showing:!1}]},{name:"footer",classes:"journal-footer toolbar",showing:!1,components:[{name:"journalbutton",kind:"Button",classes:"toolbutton view-localjournal-button active",title:"Journal",ontap:"showLocalJournal"},{name:"cloudonebutton",kind:"Button",classes:"toolbutton view-cloudone-button",title:"Private",ontap:"showPrivateCloud"},{name:"cloudallbutton",kind:"Button",classes:"toolbutton view-cloudall-button",title:"Shared",ontap:"showSharedCloud"},{name:"syncgear",classes:"sync-button sync-gear sync-gear-journal",showing:!1},{name:"syncbutton",kind:"Button",classes:"toolbutton sync-button sync-journal",title:"Sync",ontap:"syncJournal"},{name:"pageup",kind:"Button",classes:"toolbutton page-up",showing:!1,title:"Previous",ontap:"pagePrevious"},{name:"pagecount",content:"99/99",classes:"page-count",showing:!1},{name:"pagedown",kind:"Button",classes:"toolbutton page-down",showing:!1,title:"Next",ontap:"pageNext"}]}],create:function(){this.inherited(arguments),this.toolbar=null,this.empty=0==this.journal.length,this.realLength=0,this.loadResult={},this.loadingError=!1,this.journalType=constant.journalLocal,this.smallTime=!1,this.dialogAction=-1,this.journalChanged(),this.$.footer.setShowing(null!=preferences.getNetworkId()&&null!=preferences.getPrivateJournal()&&null!=preferences.getSharedJournal()),"rtl"==l10n.language.direction&&this.$.message.addClass("rtl-10"),this.draw()},rendered:function(){this.inherited(arguments),iconLib.colorize(this.$.journalbutton.hasNode(),preferences.getColor(),(function(){})),iconLib.colorize(this.$.cloudonebutton.hasNode(),preferences.getColor(),(function(){})),iconLib.colorize(this.$.cloudallbutton.hasNode(),preferences.getColor(),(function(){})),this.$.syncbutton.setNodeProperty("title",l10n.get("Synchronize")),this.$.pageup.setNodeProperty("title",l10n.get("Back")),this.$.pagedown.setNodeProperty("title",l10n.get("Next")),this.journalChanged()},onscroll:function(t,e){var o=e.scrollBounds,n=o.maxTop-o.top<constant.journalScrollLimit,i=this.$.journalList.get("count");if(this.journalType==constant.journalLocal&&!this.getToolbar().hasFilter()&&n&&this.realLength>i){var a=this.getSelection(),s=Math.min(i+constant.journalStepCount,this.journal.length);humane.log(l10n.get("Loading")),this.$.journalList.set("count",s,!0),this.setSelection(a),this.updateSelectionCount()}},pageNext:function(){var t=this.loadResult;if(t.offset+t.limit<t.total){this.getToolbar().setMultiselectToolbarVisibility(!1),this.$.warningbox.setShowing(!1);var e=this.journalType==constant.journalRemotePrivate?preferences.getPrivateJournal():preferences.getSharedJournal(),o=t.offset+t.limit;t.total-o<t.limit&&(o=t.total-t.limit),humane.log(l10n.get("Loading")),this.getToolbar().hasFilter()?this.filterEntries(this.request.name,this.request.favorite,this.request.typeactivity,this.request.stime,o):this.loadRemoteJournal(e,o)}},pagePrevious:function(){var t=this.loadResult;if(t.offset>0){this.getToolbar().setMultiselectToolbarVisibility(!1),this.$.warningbox.setShowing(!1);var e=this.journalType==constant.journalRemotePrivate?preferences.getPrivateJournal():preferences.getSharedJournal(),o=t.offset-t.limit;o<t.limit&&(o=0),humane.log(l10n.get("Loading")),this.getToolbar().hasFilter()?this.filterEntries(this.request.name,this.request.favorite,this.request.typeactivity,this.request.stime,o):this.loadRemoteJournal(e,o)}},showPageButton:function(){var t=this.loadResult;if(this.journalType==constant.journalLocal||!t)return this.$.pagedown.setShowing(!1),this.$.pageup.setShowing(!1),void this.$.pagecount.setShowing(!1);var e=t.offset>0;this.$.pageup.setShowing(e);var o=t.offset+t.limit<t.total;this.$.pagedown.setShowing(o);var n=(t.total?1:0)+Math.ceil(t.offset/t.limit),i=Math.ceil(t.total/t.limit);this.$.pagecount.setContent(n+"/"+i),this.$.pagecount.setShowing(o||e)},getToolbar:function(){return null==this.toolbar&&(this.toolbar=new Sugar.JournalToolbar),this.toolbar},draw:function(){var t=util.getCanvasCenter(),e=this.$.footer.getShowing()?55:0;this.smallTime=t.dx<660;var o=enyo.platform.android?3:0;this.$.content.applyStyle("height",t.dy-e-o+"px"),this.$.empty.applyStyle("margin-left",t.x-constant.sizeEmpty/4+"px");var n=t.y-constant.sizeEmpty/4-80;this.$.empty.applyStyle("margin-top",n+"px"),this.$.message.setContent(l10n.get("JournalEmpty")),null!=preferences.getNetworkId()&&null!=preferences.getPrivateJournal()&&null!=preferences.getSharedJournal()&&(tutorial.setElement("journalbutton",this.$.journalbutton.getAttribute("id")),tutorial.setElement("cloudonebutton",this.$.cloudonebutton.getAttribute("id")),tutorial.setElement("cloudallbutton",this.$.cloudallbutton.getAttribute("id")))},updateNetworkBar:function(){this.$.footer.setShowing(null!=preferences.getNetworkId()&&null!=preferences.getPrivateJournal()&&null!=preferences.getSharedJournal()),this.draw()},journalChanged:function(){if(this.$.empty){this.$.empty.show(),this.$.message.show(),this.$.nofilter.show();var t=!this.getToolbar().hasFilter(),e=this.journalType==constant.journalLocal;if(this.empty=t&&!this.loadingError&&0==this.journal.length,null!=this.journal&&this.journal.length>0){var o=e&&t&&this.journal.length>constant.journalInitCount?constant.journalInitCount:this.journal.length;this.realLength=this.journal.length,this.$.journalList.set("count",o,!0),this.$.empty.hide(),this.$.message.hide(),this.$.nofilter.hide()}else this.$.journalList.set("count",0,!0),this.empty?(this.$.message.setContent(l10n.get("JournalEmpty")),this.$.nofilter.hide()):this.loadingError?(this.$.message.setContent(l10n.get("ErrorLoadingRemote")),this.$.nofilter.setText(l10n.get("Retry")),this.$.nofilter.setIcon({directory:"icons",icon:"system-restart.svg"})):(this.$.message.setContent(l10n.get("NoMatchingEntries")),this.$.nofilter.setText(l10n.get("ClearSearch")),this.$.nofilter.setIcon({directory:"icons",icon:"dialog-cancel.svg"}));this.showPageButton()}},setupItem:function(t,e){var o=this.journal[e.index];o.metadata.buddy_color&&e.item.$.activity.setColorizedColor(o.metadata.buddy_color);var n=preferences.getActivity(o.metadata.activity);n==preferences.genericActivity&&("text/plain"==o.metadata.mimetype?n={directory:"icons",icon:"application-x-txt.svg"}:"application/pdf"==o.metadata.mimetype?n={directory:"icons",icon:"application-x-pdf.svg"}:"application/msword"==o.metadata.mimetype?n={directory:"icons",icon:"application-x-doc.svg"}:"application/vnd.oasis.opendocument.text"==o.metadata.mimetype&&(n={directory:"icons",icon:"application-x-odt.svg"})),e.item.$.activity.setIcon(n),e.item.$.favorite.setIcon({directory:"icons",icon:"emblem-favorite-large.svg"});var i=o.metadata.keep;e.item.$.favorite.setColorized(void 0!==i&&1==i),e.item.$.title.setContent(o.metadata.title);var a=this.getToolbar().getSortType();1==a?e.item.$.time.setContent(util.timestampToElapsedString(o.metadata.creation_time,2,this.smallTime)):2==a?e.item.$.time.setContent(util.formatSize(o.metadata.textsize||0)):e.item.$.time.setContent(util.timestampToElapsedString(o.metadata.timestamp,2,this.smallTime)),e.item.$.goright.setIcon({directory:"icons",icon:"go-right.svg"}),e.item.$.activity.setPopupShow(enyo.bind(this,"showActivityPopup")),e.item.$.activity.setPopupHide(enyo.bind(this,"hideActivityPopup")),e.item.$.activity.setData(o),"rtl"==l10n.language.direction&&(e.item.$.title.addClass("rtl-14"),e.item.$.titleEdit.addClass("rtl-14"),e.item.$.time.addClass("rtl-14")),0==e.index&&(tutorial.setElement("checkitem",e.item.$.check.getAttribute("id")),tutorial.setElement("activityitem",e.item.$.activity.getAttribute("id")),tutorial.setElement("titleitem",e.item.$.title.getAttribute("id")),tutorial.setElement("timeitem",e.item.$.time.getAttribute("id")),tutorial.setElement("favoriteitem",e.item.$.favorite.getAttribute("id")))},switchFavorite:function(t,e){var o=this.journal[e.index].objectId,n=this.journal[e.index].metadata.keep;this.journal[e.index].metadata.keep=void 0===n?1:(n+1)%2,stats.trace(constant.viewNames[app.getView()],"switch_favorite",o,null);var i=new datastore.DatastoreObject(o);i.setMetadata(this.journal[e.index].metadata),i.save(),e.dispatchTarget.container.setColorized(1==this.journal[e.index].metadata.keep),e.dispatchTarget.container.render()},switchCheck:function(t,e){this.$.warningbox.setShowing(!1),this.getToolbar().setMultiselectToolbarVisibility(this.updateSelectionCount()>0)},updateSelectionCount:function(){var t=this.getSelection();return this.getToolbar().setSelectedCount(t.length,this.$.journalList.get("count")),t.length},getSelection:function(){for(var t=[],e=this.$.journalList.get("count"),o=0;o<e;o++)this.$.journalList.children[o].$.check.getNodeProperty("checked")&&t.push(o);return t},setSelection:function(t){for(var e=t.length,o=0;o<e;o++){var n=t[o];this.$.journalList.children[n].$.check.setNodeProperty("checked",!0)}},selectAll:function(){for(var t=this.$.journalList.get("count"),e=0;e<t;e++)this.$.journalList.children[e].$.check.setNodeProperty("checked",!0);this.getToolbar().setSelectedCount(t,t)},unselectAll:function(){for(var t=this.$.journalList.get("count"),e=0;e<t;e++)this.$.journalList.children[e].$.check.setNodeProperty("checked",!1);this.getToolbar().setMultiselectToolbarVisibility(!1)},removeSelected:function(){this.dialogAction=constant.journalRemove,this.$.warningbox.setTitle(l10n.get("Erase"));var t=this.getSelection().length;this.$.warningbox.setMessage(1==t?l10n.get("Erase_one",{count:t}):l10n.get("Erase_other",{count:t})),this.$.warningbox.setOkText(l10n.get("Ok")),this.$.warningbox.setCancelText(l10n.get("Cancel")),this.$.warningbox.setShowing(!0)},duplicateSelected:function(){this.dialogAction=constant.journalDuplicate,this.$.warningbox.setTitle(l10n.get("Duplicate"));var t=this.getSelection().length;this.$.warningbox.setMessage(1==t?l10n.get("Duplicate_one",{count:t}):l10n.get("Duplicate_other",{count:t})),this.$.warningbox.setOkText(l10n.get("Ok")),this.$.warningbox.setCancelText(l10n.get("Cancel")),this.$.warningbox.setShowing(!0)},copySelected:function(t){this.dialogAction=t;var e=["CopyToLocal","CopyToPrivate","CopyToShared","","CopyToDevice"];this.$.warningbox.setTitle(l10n.get(e[t]));var o=this.getSelection().length;this.$.warningbox.setMessage(1==o?l10n.get(e[t]+"_one",{count:o}):l10n.get(e[t]+"_other",{count:o})),this.$.warningbox.setOkText(l10n.get("Ok")),this.$.warningbox.setCancelText(l10n.get("Cancel")),this.$.warningbox.setShowing(!0)},dialogSelectedOk:function(){this.$.warningbox.setShowing(!1),this.getToolbar().setMultiselectToolbarVisibility(!1);for(var t=this.getSelection(),e=[],o=0;o<t.length;o++)e.push(this.journal[t[o]]);var n=this,i=this.dialogAction==constant.journalDevice&&util.getClientType()==constant.appType&&enyo.platform.electron;i||humane.log(l10n.get(this.dialogAction==constant.journalRemove?"Erasing":"Copying")),window.setTimeout((function(){if(i)n.copyMultipleToDevice(e);else for(var t=0;t<e.length;t++)n.dialogAction==constant.journalDevice?n.copyToDevice(e[t]):n.dialogAction==constant.journalRemove?n.removeEntry(e[t],{isLast:t==e.length-1}):n.dialogAction==constant.journalDuplicate?n.duplicateEntry(e[t],{isLast:t==e.length-1}):n.dialogAction==constant.journalLocal?n.copyToLocal(e[t]):n.copyToRemote(e[t],n.dialogAction==constant.journalRemotePrivate?preferences.getPrivateJournal():preferences.getSharedJournal());n.unselectAll()}),100)},dialogSelectedCancel:function(){this.$.warningbox.setShowing(!1),this.getToolbar().setMultiselectToolbarVisibility(!0)},runActivity:function(t,e){this.runCurrentActivity(this.journal[e.index])},runCurrentActivity:function(t){var e=preferences.getActivity(t.metadata.activity);if(e!=preferences.genericActivity){o=this;this.loadEntry(t,(function(n,i,a){if(o.journalType!=constant.journalLocal){var s=new datastore.DatastoreObject(t.objectId);return s.setMetadata(i),s.setDataAsText(a),void s.save((function(){preferences.runActivity(e,t.objectId,i.title)}))}preferences.runActivity(e,t.objectId,i.title)}))}else if("application/pdf"==t.metadata.mimetype){var o=this;this.loadEntry(t,(function(t,e,n){o.$.activityPopup.hidePopup(),util.openAsDocument(e,n)}))}},filterEntries:function(t,e,o,n,i){var a=this.getToolbar().getSortType();if(this.journalType==constant.journalLocal){this.journal=datastore.find(o),this.loadingError=!1,this.journal=this.journal.filter((function(o){return(void 0===e||o.metadata.keep)&&(0==t.length||-1!=o.metadata.title.toLowerCase().indexOf(t.toLowerCase()))&&(void 0===n||o.metadata.timestamp>=n)}));l=this;this.journal=this.journal.sort((function(t,e){return 1==a?parseInt(e.metadata.creation_time)-parseInt(t.metadata.creation_time):2==a?parseInt(e.metadata.textsize||0)-parseInt(t.metadata.textsize||0):parseInt(e.metadata.timestamp)-parseInt(t.metadata.timestamp)})),this.journalChanged()}else{var s=this.journalType==constant.journalRemotePrivate?preferences.getPrivateJournal():preferences.getSharedJournal(),l=this,r="-timestamp";1==a?r="-creation_time":2==a&&(r="-textsize");var c={typeactivity:o,title:void 0!==t?t:void 0,stime:void 0!==n?n:void 0,favorite:e,field:constant.fieldMetadata,limit:constant.pageJournalSize,sort:r,offset:void 0!==i?i:0};myserver.getJournal(s,c,(function(t,e){l.loadResult={offset:e.offset,total:e.total,limit:e.limit},l.request=c,l.journal=e.entries,l.empty=!l.getToolbar().hasFilter()&&!this.loadingError&&0==l.journal.length,l.loadingError=!1,l.journalChanged()}),(function(){console.log("WARNING: Error filtering journal "+s),l.loadResult={},l.request={},l.journal=[],l.loadingError=!0,l.journalChanged()}))}},nofilter:function(){this.toolbar.removeFilter(),this.filterEntries("",void 0,void 0,void 0,void 0)},showActivityPopup:function(t){if(t.owner){t.icon;var e=t.getData(),o=null;this.journalType!=constant.sharedJournal?e.metadata.textsize&&e.metadata.textsize>constant.minimumSizeDisplay&&(o=util.formatSize(e.metadata.textsize)):e.metadata.buddy_name&&(o=l10n.get("ByUser",{user:e.metadata.buddy_name})),this.$.activityPopup.setHeader({icon:t.icon,colorized:!0,colorizedColor:e.metadata.buddy_color?e.metadata.buddy_color:null,name:e.metadata.title,title:o,action:enyo.bind(this,"runCurrentActivity"),data:[e,null]}),this.$.activityPopup.setItems(null);var n=[];n.push({icon:{directory:"icons",icon:"activity-start.svg"},colorized:!1,name:l10n.get("RestartActivity"),action:enyo.bind(this,"runCurrentActivity"),disable:preferences.getActivity(e.metadata.activity)==preferences.genericActivity&&"application/pdf"!=e.metadata.mimetype,data:[e,null]}),n.push({icon:{directory:"icons",icon:"copy-journal.svg"},colorized:!1,name:l10n.get("CopyToLocal"),action:enyo.bind(this,"copyToLocal"),data:[e,null],disable:this.journalType==constant.journalLocal}),n.push({icon:{directory:"icons",icon:"copy-cloud-one.svg"},colorized:!1,name:l10n.get("CopyToPrivate"),action:enyo.bind(this,"copyToRemote"),data:[e,preferences.getPrivateJournal()],disable:!preferences.isConnected()||this.journalType==constant.journalRemotePrivate}),n.push({icon:{directory:"icons",icon:"copy-cloud-all.svg"},colorized:!1,name:l10n.get("CopyToShared"),action:enyo.bind(this,"copyToRemote"),data:[e,preferences.getSharedJournal()],disable:!preferences.isConnected()||this.journalType==constant.journalRemoteShared}),n.push({icon:{directory:"icons",icon:"copy-to-device.svg"},colorized:!1,name:l10n.get("CopyToDevice"),action:enyo.bind(this,"copyToDevice"),data:[e,null]}),n.push({icon:{directory:"icons",icon:"duplicate.svg"},colorized:!1,name:l10n.get("Duplicate"),action:enyo.bind(this,"duplicateEntry"),data:[e,null],disable:this.journalType!=constant.journalLocal}),n.push({icon:{directory:"icons",icon:"list-remove.svg"},colorized:!1,name:l10n.get("Erase"),action:enyo.bind(this,"removeEntry"),data:[e,null]}),this.$.activityPopup.setFooter(n),this.$.activityPopup.setMargin({left:0,top:60*t.owner.index+20-mouse.position.y}),this.$.activityPopup.showPopup()}},hideActivityPopup:function(t){return!this.$.activityPopup||!this.$.activityPopup.cursorIsInside()&&!t.cursorIsInside()&&(this.$.activityPopup.hidePopup(),!0)},copyToLocal:function(t){var e=this;stats.trace(constant.viewNames[app.getView()],"copy_to_local",t.objectId,null),this.loadEntry(t,(function(o,n,i){var a=new datastore.DatastoreObject(t.objectId);a.setMetadata(n),a.setDataAsText(i),a.save(),e.$.activityPopup.hidePopup()}))},copyToDevice:function(t,e){this.$.activityPopup.hidePopup(),this.loadEntry(t,(function(t,o,n){util.writeFile(e,o,n,(function(t,e){t?humane.log(l10n.get("ErrorWritingFile")):humane.log(l10n.get("FileWroteTo",{file:e}))}))}))},copyMultipleToDevice:function(t){var e=this;util.askDirectory((function(o){for(var n=0;n<t.length;n++)e.copyToDevice(t[n],o)}))},copyToRemote:function(t,e){stats.trace(constant.viewNames[app.getView()],"copy_to_remote",t.objectId,e),this.loadEntry(t,(function(o,n,i){var a={metadata:n,text:i,objectId:t.objectId};myserver.putJournalEntry(e,t.objectId,a,(function(){}),(function(){console.log("WARNING: Error writing journal "+e)}))})),this.$.activityPopup.hidePopup()},duplicateEntry:function(t,e){var o=this;stats.trace(constant.viewNames[app.getView()],"duplicate",t.objectId,null),this.loadEntry(t,(function(t,n,i){var a=new datastore.DatastoreObject;a.setMetadata(n),a.setDataAsText(i),a.save(),o.$.activityPopup.hidePopup(),(!e||e.isLast)&&(o.toolbar.removeFilter(),o.loadLocalJournal())}))},loadLocalJournal:function(){this.journal=datastore.find(),this.journal=this.journal.sort((function(t,e){return parseInt(e.metadata.timestamp)-parseInt(t.metadata.timestamp)})),this.journalChanged()},loadRemoteJournal:function(t,e){var o=this,n={field:constant.fieldMetadata,limit:constant.pageJournalSize,offset:void 0!==e?e:0,sort:"-timestamp"},i=this.getToolbar().getSortType();1==i?n.sort="-creation_time":2==i&&(n.sort="-textsize"),myserver.getJournal(t,n,(function(t,e){o.loadResult={offset:e.offset,total:e.total,limit:e.limit},o.journal=e.entries,o.empty=!o.getToolbar().hasFilter()&&!this.loadingError&&0==o.journal.length,o.loadingError=!1,o.journalChanged()}),(function(){console.log("WARNING: Error reading journal "+t),o.loadResult={},o.journal=[],o.loadingError=!0,o.journalChanged()}))},loadEntry:function(t,e){var o;this.journalType==constant.journalLocal?new datastore.DatastoreObject(t.objectId).loadAsText((function(t,o,n){e(t,o,n)})):(this.journalType==constant.journalRemotePrivate?o=preferences.getPrivateJournal():this.journalType==constant.journalRemoteShared&&(o=preferences.getSharedJournal()),myserver.getJournalEntry(o,t.objectId,(function(t,o){e(null,o.entries[0].metadata,o.entries[0].text)}),(function(){console.log("WARNING: Error loading entry "+objectId+" in journal "+o)})))},removeEntry:function(t,e){if(this.journalType!=constant.journalLocal){n=this.journalType==constant.journalRemotePrivate?preferences.getPrivateJournal():preferences.getSharedJournal(),i=t.objectId;var o=this;return this.toolbar.removeFilter(),stats.trace(constant.viewNames[app.getView()],"remove_entry",i,n),void myserver.deleteJournalEntry(n,i,(function(t,e){o.loadRemoteJournal(n),o.$.activityPopup.hidePopup()}),(function(){console.log("WARNING: Error removing entry "+i+" in journal "+n),o.loadRemoteJournal(n),o.$.activityPopup.hidePopup()}))}if(stats.trace(constant.viewNames[app.getView()],"remove_entry",t.objectId,null),datastore.remove(t.objectId),preferences.isConnected()&&preferences.getOptions("sync")){var n=preferences.getPrivateJournal(),i=t.objectId;myserver.deleteJournalEntry(n,i,(function(t,e){}),(function(){console.log("WARNING: Error removing entry "+i+" in journal "+n)}))}(!e||e.isLast)&&(this.toolbar.removeFilter(),this.loadLocalJournal(),preferences.updateEntries(),app.journal=this.journal,app.redraw()),this.$.activityPopup.hidePopup()},titleEditStart:function(t,e){var o=e.dispatchTarget.owner.$;o.title.setShowing(!1),o.titleEdit.setValue(o.title.getContent()),o.titleEdit.setShowing(!0),o.titleEdit.focus()},titleEditEnd:function(t,e){var o=e.dispatchTarget.owner.$;o.title.setShowing(!0),o.titleEdit.setShowing(!1);var n=o.titleEdit.getValue();if(n!=o.title.getContent()){var i=this.journal[e.index].objectId,a=this;this.loadEntry(this.journal[e.index],(function(t,e,o){if(a.journalType==constant.journalLocal){e.title=n,stats.trace(constant.viewNames[app.getView()],"rename_entry",i,"local");var s=new datastore.DatastoreObject(i);s.setMetadata(e),s.setDataAsText(o),s.save(),a.loadLocalJournal(),preferences.updateEntries(),app.journal=a.journal,app.redraw()}else{e.title=n;var l=a.journalType==constant.journalRemotePrivate?preferences.getPrivateJournal():preferences.getSharedJournal(),r={metadata:e,text:o,objectId:i};stats.trace(constant.viewNames[app.getView()],"rename_entry",i,l),myserver.putJournalEntry(l,i,r,(function(){a.loadRemoteJournal(l)}),(function(){console.log("WARNING: Error updating journal "+l),a.loadRemoteJournal(l)}))}}))}},showLocalJournal:function(){this.changeJournalType(constant.journalLocal),stats.trace(constant.viewNames[app.getView()],"show_journal","local",null),this.loadLocalJournal()},showPrivateCloud:function(){stats.trace(constant.viewNames[app.getView()],"show_journal","private",null),this.changeJournalType(constant.journalRemotePrivate),this.loadRemoteJournal(preferences.getPrivateJournal())},showSharedCloud:function(){stats.trace(constant.viewNames[app.getView()],"show_journal","shared",null),this.changeJournalType(constant.journalRemoteShared),this.loadRemoteJournal(preferences.getSharedJournal())},syncJournal:function(){var t=this;autosync.synchronizeJournal((function(e){e&&(humane.log(l10n.get("RetrievingJournal")),t.$.syncbutton.setShowing(!1),t.$.syncgear.setShowing(!0))}),(function(e,o,n){t.$.syncbutton&&(t.$.syncbutton.setShowing(!0),t.$.syncgear.setShowing(!1),e&&t.journalType==constant.journalLocal&&(t.loadLocalJournal(),app.journal=t.journal,preferences.updateEntries(),app.draw()),o&&t.journalType==constant.journalRemotePrivate&&t.loadRemoteJournal(preferences.getPrivateJournal()))}))},changeJournalType:function(t){this.journalType=t,this.$.journalbutton.addRemoveClass("active",t==constant.journalLocal),this.$.cloudonebutton.addRemoveClass("active",t==constant.journalRemotePrivate),this.$.cloudallbutton.addRemoveClass("active",t==constant.journalRemoteShared),this.getToolbar().removeFilter(),this.getToolbar().setMultiselectToolbarVisibility(!1),this.$.warningbox.setShowing(!1)},getJournalType:function(){return this.journalType}}),enyo.kind({name:"Sugar.JournalToolbar",kind:enyo.Control,components:[{name:"unselallbutton",showing:!1,kind:"Sugar.Icon",classes:"journal-unselectall",x:0,y:0,icon:{directory:"icons",icon:"select-none.svg"},size:constant.iconSizeList,disabledBackground:"#282828",ontap:"unselectAll"},{name:"selallbutton",showing:!1,kind:"Sugar.Icon",classes:"journal-selectall",x:0,y:0,icon:{directory:"icons",icon:"select-all.svg"},size:constant.iconSizeList,disabledBackground:"#282828",ontap:"selectAll"},{name:"split1",showing:!1,classes:"splitbar"},{name:"copyjournalbutton",showing:!1,kind:"Sugar.Icon",classes:"journal-copy",x:0,y:0,icon:{directory:"icons",icon:"copy-journal.svg"},size:constant.iconSizeList,disabledBackground:"#282828",ontap:"copySelected"},{name:"copycloudonebutton",showing:!1,kind:"Sugar.Icon",classes:"journal-copy",x:0,y:0,icon:{directory:"icons",icon:"copy-cloud-one.svg"},size:constant.iconSizeList,disabledBackground:"#282828",ontap:"copySelected"},{name:"copycloudallbutton",showing:!1,kind:"Sugar.Icon",classes:"journal-copy",x:0,y:0,icon:{directory:"icons",icon:"copy-cloud-all.svg"},size:constant.iconSizeList,disabledBackground:"#282828",ontap:"copySelected"},{name:"copydevicebutton",showing:!1,kind:"Sugar.Icon",classes:"journal-copy",x:0,y:0,icon:{directory:"icons",icon:"copy-to-device.svg"},size:constant.iconSizeList,disabledBackground:"#282828",ontap:"copySelected"},{name:"duplicatebutton",showing:!1,kind:"Sugar.Icon",classes:"journal-copy",x:0,y:0,icon:{directory:"icons",icon:"duplicate.svg"},size:constant.iconSizeList,disabledBackground:"#282828",ontap:"duplicateSelected"},{name:"removebutton",showing:!1,kind:"Sugar.Icon",classes:"journal-remove",x:0,y:0,icon:{directory:"icons",icon:"list-remove.svg"},size:constant.iconSizeList,disabledBackground:"#282828",ontap:"removeSelected"},{name:"split2",showing:!1,classes:"splitbar"},{name:"selectcount",showing:!1,classes:"journal-selectcount"},{name:"favoritebutton",kind:"Sugar.Icon",classes:"journal-filter-favorite",x:0,y:4,icon:{directory:"icons",icon:"emblem-favorite.svg"},size:constant.iconSizeList,ontap:"filterFavorite"},{name:"journalsearch",kind:"Sugar.SearchField",onTextChanged:"filterEntries",classes:"journal-filter-text"},{name:"radialbutton",kind:"Button",classes:"toolbutton view-desktop-button",title:"Home",ontap:"gotoDesktop"},{name:"typepalette",kind:"Sugar.Palette",ontap:"showTypePalette",icon:{directory:"icons",icon:"view-type.svg"},size:constant.iconSizeList,classes:"journal-filtertype-palette",contentsClasses:"journal-filtertype-content",contents:[]},{name:"datepalette",kind:"Sugar.Palette",ontap:"showDatePalette",icon:{directory:"icons",icon:"view-created.svg"},size:constant.iconSizeList,classes:"journal-filterdate-palette",contentsClasses:"journal-filterdate-content",contents:[]},{name:"sortpalette",kind:"Sugar.Palette",ontap:"showSortPalette",icon:{directory:"icons",icon:"view-lastedit.svg"},size:constant.iconSizeList,classes:"journal-sort-palette",contentsClasses:"journal-sort-content",contents:[]},{name:"split3",classes:"splitbar journal-split split3"},{name:"fromdevicebutton",kind:"Sugar.Icon",x:0,y:0,icon:{directory:"icons",icon:"copy-from-device.svg"},classes:"journal-fromdevice",size:constant.iconSizeList,ontap:"fromDeviceSelected"},{name:"split4",classes:"splitbar journal-split split4"},{name:"helpbutton",kind:"Button",classes:"toolbutton help-button-journal",title:"Help",ontap:"startTutorial"}],create:function(){this.inherited(arguments),this.localize(),this.typeselected=0,this.dateselected=0,this.sortfield=0,util.getClientType()!=constant.webAppType&&(util.getClientType()!=constant.appType||enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios||enyo.platform.electron)||this.createComponent({name:"file",kind:"Input",type:"file",showing:!1,onchange:"fileSelected"},{owner:this})},rendered:function(){this.inherited(arguments),this.localize()},localize:function(){this.$.favoritebutton.setNodeProperty("title",l10n.get("FilterFavorites")),this.$.radialbutton.setNodeProperty("title",l10n.get("Home")),this.$.helpbutton.setNodeProperty("title",l10n.get("Tutorial")),this.$.unselallbutton.setNodeProperty("title",l10n.get("UnselectAll")),this.$.selallbutton.setNodeProperty("title",l10n.get("SelectAll")),this.$.removebutton.setNodeProperty("title",l10n.get("Erase")),this.$.copyjournalbutton.setNodeProperty("title",l10n.get("CopyToLocal")),this.$.copycloudonebutton.setNodeProperty("title",l10n.get("CopyToPrivate")),this.$.copycloudallbutton.setNodeProperty("title",l10n.get("CopyToShared")),this.$.copydevicebutton.setNodeProperty("title",l10n.get("CopyToDevice")),this.$.duplicatebutton.setNodeProperty("title",l10n.get("Duplicate")),this.$.journalsearch.setPlaceholder(l10n.get("SearchJournal")),this.$.typepalette.setText(l10n.get("AllType")),this.$.datepalette.setText(l10n.get("Anytime")),this.dates=[l10n.get("Anytime"),l10n.get("Today"),l10n.get("SinceYesterday"),l10n.get("PastWeek"),l10n.get("PastMonth")];var t=[];this.$.datepalette.setHeader(l10n.get("SelectFilter"));for(var e=0;e<this.dates.length;e++)t.push({id:""+(e+1),classes:"journal-filterdate-line",components:[{classes:"journal-filterdate-item",content:this.dates[e]}],ontap:"tapDate"});this.$.datepalette.setItems(t),t=[],this.$.typepalette.setHeader(l10n.get("SelectFilter")),t.push({id:"0",classes:"journal-filtertype-line",components:[{kind:"Sugar.Icon",icon:{directory:"icons",icon:"application-x-generic.svg"},x:5,y:3,size:constant.iconSizeFavorite},{classes:"item-name",content:l10n.get("AllType")}],ontap:"tapLine"});var o=preferences.getActivities(),n=[];for(e=0;e<o.length;e++)n.push({id:""+(e+1),classes:"journal-filtertype-line",components:[{kind:"Sugar.Icon",icon:o[e],x:5,y:3,size:constant.iconSizeFavorite},{classes:"item-name",content:o[e].name}],ontap:"tapLine"});n.sort((function(t,e){var o=t.components[1].content,n=e.components[1].content;return o>n?1:o<n?-1:0}));for(e=0;e<n.length;e++)t.push(n[e]);this.$.typepalette.setItems(t),this.sorts=[{text:l10n.get("SortByUpdated"),icon:"view-lastedit.svg"},{text:l10n.get("SortByCreated"),icon:"view-created.svg"},{text:l10n.get("SortBySize"),icon:"view-size.svg"}];t=[];this.$.sortpalette.setHeader(l10n.get("SortDisplay"));for(e=0;e<this.sorts.length;e++)t.push({id:""+(e+1),classes:"journal-sort-line",components:[{kind:"Sugar.Icon",icon:{directory:"icons",icon:this.sorts[e].icon},x:5,y:3,size:constant.iconSizeFavorite},{classes:"journal-sort-item",content:this.sorts[e].text}],ontap:"tapSort"});this.$.sortpalette.setItems(t)},gotoDesktop:function(){util.vibrate(),app.showView(constant.radialView)},filterFavorite:function(){this.$.favoritebutton.setColorized(!this.$.favoritebutton.getColorized()),this.$.favoritebutton.render(),this.filterEntries()},showTypePalette:function(){this.$.typepalette.switchPalette(app.otherview)},tapLine:function(t,e){var o=preferences.getActivities();this.typeselected=t.getId(),this.$.typepalette.setIcon(0==this.typeselected?{directory:"icons",icon:"application-x-generic.svg"}:o[this.typeselected-1]),this.$.typepalette.setText(0==this.typeselected?l10n.get("AllType"):o[this.typeselected-1].name),this.filterEntries(),this.$.typepalette.switchPalette(app.otherview)},showDatePalette:function(){this.$.datepalette.switchPalette(app.otherview)},tapDate:function(t,e){this.dateselected=t.getId()-1,this.$.datepalette.setText(this.dates[this.dateselected]),this.filterEntries(),this.$.datepalette.switchPalette(app.otherview)},showSortPalette:function(){this.$.sortpalette.switchPalette(app.otherview)},tapSort:function(t,e){this.sortfield=t.getId()-1,this.$.sortpalette.setIcon({directory:"icons",icon:this.sorts[this.sortfield].icon}),this.filterEntries(),this.$.sortpalette.switchPalette(app.otherview)},selectAll:function(){this.$.selallbutton.getDisabled()||app.otherview.selectAll()},unselectAll:function(){this.$.unselallbutton.getDisabled()||app.otherview.unselectAll()},setSelectedCount:function(t,e){t<=1?this.$.selectcount.setContent(l10n.get("Selected_one",{count:t,total:e})):this.$.selectcount.setContent(l10n.get("Selected_other",{count:t,total:e}))},removeSelected:function(){this.$.removebutton.getDisabled()||(this.disableMultiselectToolbarVisibility(),app.otherview.removeSelected())},duplicateSelected:function(){this.$.duplicatebutton.getDisabled()||(this.disableMultiselectToolbarVisibility(),app.otherview.duplicateSelected())},copySelected:function(t,e){var o;t.getDisabled()||(this.disableMultiselectToolbarVisibility(),o="copydevicebutton"==t.name?constant.journalDevice:"copycloudonebutton"==t.name?constant.journalRemotePrivate:"copycloudallbutton"==t.name?constant.journalRemoteShared:constant.journalLocal,app.otherview.copySelected(o))},fromDeviceSelected:function(){util.getClientType()!=constant.webAppType&&(util.getClientType()!=constant.appType||enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios||enyo.platform.electron)?util.askFiles((function(t,e,o,n){e?humane.log(l10n.get("ErrorLoadingFile",{file:t})):(o.timestamp=(new Date).getTime(),o.creation_time=(new Date).getTime(),datastore.create(o,(function(e){e?humane.log(l10n.get("ErrorLoadingFile",{file:t})):(app.otherview.loadLocalJournal(),preferences.isConnected()&&app.otherview.syncJournal())}),n))})):(this.$.file.setNodeProperty("accept",".png,.jpg,.wav,.webm,.json,.mp3,.mp4,.pdf,.txt,.doc,.odt"),this.$.file.setNodeProperty("multiple","true"),this.$.file.hasNode().click())},fileSelected:function(){for(var t=this.$.file.getNodeProperty("files"),e=0;e<t.length;e++)util.loadFile(t[e],(function(t,e,o,n){e?humane.log(l10n.get("ErrorLoadingFile",{file:t})):(o.timestamp=(new Date).getTime(),o.creation_time=(new Date).getTime(),datastore.create(o,(function(){app.otherview.loadLocalJournal(),preferences.isConnected()&&app.otherview.syncJournal()}),n))}))},hasFilter:function(){return""!=this.$.journalsearch.getText()||this.$.favoritebutton.getColorized()||this.typeselected>0||this.dateselected>0},getSortType:function(){return this.sortfield},filterEntries:function(){var t=this.$.journalsearch.getText(),e=!!this.$.favoritebutton.getColorized()||void 0,o=this.typeselected,n=o<=0?void 0:preferences.getActivities()[o-1].id,i=(o=this.dateselected)<=0?void 0:util.getDateRange(o).min,a="q="+t;e&&(a+="&favorite=true"),n&&(a+="&type="+n),i&&(a+="&time="+i),stats.trace(constant.viewNames[app.getView()],"search",a,null),app.otherview.filterEntries(t,e,n,i,void 0,this.sortfield)},removeFilter:function(){this.typeselected=0,this.$.typepalette.setIcon({directory:"icons",icon:"application-x-generic.svg"}),this.dateselected=0,this.sortfield=0,this.$.sortpalette.setIcon({directory:"icons",icon:"view-lastedit.svg"}),this.$.favoritebutton.setColorized(!1),this.$.journalsearch.setText(""),this.render()},setMultiselectToolbarVisibility:function(t){this.$.typepalette.isOpen()&&this.$.typepalette.switchPalette(app.otherview),this.$.datepalette.isOpen()&&this.$.datepalette.switchPalette(app.otherview),this.$.sortpalette.isOpen()&&this.$.sortpalette.switchPalette(app.otherview);var e=app.otherview.getJournalType();this.$.favoritebutton.setShowing(!t),this.$.journalsearch.setShowing(!t),this.$.radialbutton.setShowing(!t),this.$.typepalette.setShowing(!t),this.$.datepalette.setShowing(!t),this.$.sortpalette.setShowing(!t),this.$.split3.setShowing(!t&&e==constant.journalLocal),this.$.fromdevicebutton.setShowing(!t&&e==constant.journalLocal),this.$.split4.setShowing(!t),this.$.helpbutton.setShowing(!t),this.$.unselallbutton.setShowing(t),this.$.selallbutton.setShowing(t),this.$.split1.setShowing(t),this.$.removebutton.setShowing(t),this.$.copyjournalbutton.setShowing(t&&e!=constant.journalLocal),this.$.duplicatebutton.setShowing(t&&e==constant.journalLocal),this.$.copycloudonebutton.setShowing(t&&e!=constant.journalRemotePrivate&&preferences.isConnected()),this.$.copycloudallbutton.setShowing(t&&e!=constant.journalRemoteShared&&preferences.isConnected()),this.$.copydevicebutton.setShowing(t),this.$.split2.setShowing(t),this.$.selectcount.setShowing(t),this.$.unselallbutton.setDisabled(!t),this.$.selallbutton.setDisabled(!t),this.$.removebutton.setDisabled(!t),this.$.copyjournalbutton.setDisabled(!t),this.$.copycloudonebutton.setDisabled(!t),this.$.copycloudallbutton.setDisabled(!t),this.$.copydevicebutton.setDisabled(!t),this.$.duplicatebutton.setDisabled(!t),this.$.selectcount.addRemoveClass("journal-selectcount-disabled",!t)},disableMultiselectToolbarVisibility:function(){this.$.unselallbutton.setDisabled(!0),this.$.selallbutton.setDisabled(!0),this.$.removebutton.setDisabled(!0),this.$.copyjournalbutton.setDisabled(!0),this.$.copycloudonebutton.setDisabled(!0),this.$.copycloudallbutton.setDisabled(!0),this.$.copydevicebutton.setDisabled(!0),this.$.duplicatebutton.setDisabled(!0),this.$.selectcount.addRemoveClass("journal-selectcount-disabled",!0)},startTutorial:function(){tutorial.setElement("favoritebutton",this.$.favoritebutton.getAttribute("id")),tutorial.setElement("searchtext",this.$.journalsearch.getAttribute("id")),tutorial.setElement("typeselect",this.$.typepalette.getAttribute("id")),tutorial.setElement("timeselect",this.$.datepalette.getAttribute("id")),tutorial.setElement("sortselect",this.$.sortpalette.getAttribute("id")),tutorial.setElement("fromdevicebutton",this.$.fromdevicebutton.getAttribute("id")),tutorial.setElement("radialbutton",this.$.radialbutton.getAttribute("id")),stats.trace(constant.viewNames[app.getView()],"tutorial","start",null),tutorial.start()}});